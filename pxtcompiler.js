var pxt,pxt,ts,ts,ts,ts,ts,ts,ts,ts,ts,ts,ts,pxt,pxt,ts,ts,ts,ts,ts,ts,ts,ts,ts,ts,ts;!function(i){let a,n=!1;class t{constructor(e){this.db=e}loadAsync(t,r,e,n){if(!/^v\d+\.\d+\.\d+$/.test(r))return n(t,r);const s=`gh-${e}-${t}#`+r;return a.cacheGet(s).then(e=>{if(e){const a=i.Util.jsonTryParse(e);if(a)return i.debug("cache hit "+s),Promise.resolve(a)}return n(t,r).then(e=>e&&(i.debug("cached "+s),a.cacheSet(s,JSON.stringify(e)).then(()=>e)))})}loadConfigAsync(e,t){return this.loadAsync(e,t,"pxt",(e,t)=>this.db.loadConfigAsync(e,t))}loadPackageAsync(e,t){return this.loadAsync(e,t,"pkg",(e,t)=>this.db.loadPackageAsync(e,t))}}class s{constructor(e){this.packageFiles=e}resolve(e,t){return""}readFile(e,t){var r="this"==e.id?t:"pxt_modules/"+e.id+"/"+t;return void 0!==this.packageFiles[r]?this.packageFiles[r]:i.appTarget.bundledpkgs[e.id]?i.appTarget.bundledpkgs[e.id][t]:null}writeFile(e,t,r){e="this"==e.id?"":"pxt_modules/"+e.id+"/";i.debug("write file "+e+t),this.packageFiles[e+t]=r}getHexInfoAsync(e){return Promise.resolve({hex:["SKIP"]})}cacheStoreAsync(e,t){return null!=a&&a.cacheSet?a.cacheSet(e,t):Promise.resolve()}cacheGetAsync(e){return null!=a&&a.cacheGet?a.cacheGet(e):Promise.resolve("")}downloadPackageAsync(r){return n?(t=r,((e=null==a?void 0:a.pkgOverrideAsync)?e(t.id):Promise.resolve(void 0)).then(e=>e||t.commonDownloadAsync()).then(e=>{e&&i.U.iterMap(e,(e,t)=>{this.writeFile(r,e,t)})})):Promise.resolve();var t,e}resolveVersionAsync(e){return Promise.resolve("*")}}function o(e){if(e.target.preferredEditor==i.PYTHON_PROJECT_NAME){var t,r=i.U.clone(e);r.ast=!0,r.target.preferredEditor=i.JAVASCRIPT_PROJECT_NAME;for(t of r.sourceFiles)i.U.endsWith(t,".py")&&(r.fileSystem[t.slice(0,-3)+".ts"]=" ");var n=pxtc.compile(r);e.apisInfo=pxtc.getApiInfo(n.ast,r.jres)}}function r(e,t){const r=new s(e),n=new i.MainPackage(r);return n.loadAsync().then(()=>{var e=n.getTargetOptions();return e.hasHex&&(e.isNative=t.native),n.getCompileOptionsAsync(e)}).then(e=>(l(n.targetVersion(),e),o(e),e))}function l(e,t){if(e){i.debug("applying TS patches relative to "+e);for(var r of Object.keys(t.fileSystem)){var n;-1==r.indexOf("/")&&i.U.endsWith(r,".ts")&&(n=t.fileSystem[r])!=(n=i.patching.patchJavaScript(e,n))&&(i.debug("applying TS patch to "+r),t.fileSystem[r]=n)}}}i.SimpleHost=s,i.prepPythonOptions=o,i.simpleInstallPackagesAsync=function(e){e=new s(e);return new i.MainPackage(e).loadAsync(!0)},i.simpleGetCompileOptionsAsync=r,i.simpleCompileAsync=function(e,t){return r(e,"boolean"==typeof t?{native:t}:t||{}).then(e=>pxtc.compile(e)).then(e=>(e.success||(e.errors=e.diagnostics.map(ts.pxtc.getDiagnosticString).join("")||"Unknown error."),e))},i.patchTS=l,i.setupSimpleCompile=function(e){"undefined"==typeof global||global.btoa||(global.btoa=function(e){return Buffer.from(e,"binary").toString("base64")},global.atob=function(e){return Buffer.from(e,"base64").toString("binary")}),"undefined"!=typeof pxtTargetBundle&&(i.debug("setup app bundle"),i.setAppTarget(pxtTargetBundle)),e&&(a=e,n=!0,e.httpRequestAsync&&(i.Util.httpRequestCoreAsync=e.httpRequestAsync),i.github.forceProxy=!0,i.github.db=new t(new i.github.MemoryGithubDb)),i.debug("simple setup done")}}(pxt=pxt||{}),function(S){S.simshim=function(e,t){let r,h=ts.SyntaxKind,g=e.getTypeChecker(),b=S.cpp.nsWriter("declare namespace"),x="";for(var n of e.getSourceFiles()){if(t){var s=t(n.fileName);if(S.debug("SimShim[1]: "+s.dir),!S.U.endsWith(s.dir,"/sim")&&!S.U.startsWith(n.fileName,"sim/"))continue}else if(!S.U.startsWith(n.fileName,"sim/"))continue;S.debug("SimShim[2]: "+n.fileName);for(var i of n.statements){var a=i;i.kind==h.ModuleDeclaration&&"pxsim"==a.name.text&&p((r=a).body)}}e={};return e[S.appTarget.corepkg]=b.finish(),e;function y(e){let t;return t=(t=ts.isExpression(e)?g.getContextualType(e):t)||g.getTypeAtLocation(e)}function k(e){let t=g.typeToString(e,r,ts.TypeFormatFlags.UseFullyQualifiedType);switch(t=t.replace(/^pxsim\./,"")){case"RefAction":return"() => void";case"RefBuffer":return"Buffer";default:return t}}function c(e){e=pxtc.getComments(e);return/^\s*\/\/%/m.test(e)?e:null}function u(p,d=!1){var f,m=c(p);if(m){let e=p.name.getText(),t=p.kind==h.MethodDeclaration||p.kind==h.GetAccessor||p.kind==h.SetAccessor,r="//% shim="+(t?"."+e:x+"::"+e),n=g.getSignatureFromDeclaration(p),s=g.getReturnTypeOfSignature(n),i=/Async$/.test(e),a=(f=s,pxtc.isObjectType(f)&&f.objectFlags&ts.ObjectFlags.Reference&&"Promise"==f.symbol.name?f.typeArguments[0]:null);a?(r+=" promise",s=a,i||S.U.userError(x+`::${e} should be called ${e}Async`)):i&&S.U.userError(x+`::${e} doesn't return a promise`),S.debug("emitFun: "+e);let o=p.parameters.map(e=>`${e.name.getText()}${e.questionToken?"?":""}: `+k(y(e))),l=e.replace(/Async$/,""),c=t?"public":"function",u=`(${o.join(", ")})`;p.kind==h.GetAccessor&&(c=d?"public":"readonly",u="",r+=" property"),t||b.setNs(x),b.write(m),b.write(r),b.write(`${c} ${l}${u}: ${k(s)};`),b.write("")}}function p(e){switch(e.kind){case h.ModuleDeclaration:return a=e,(t=x)&&(x+="."),x+=a.name.text,p(a.body),void(x=t);case h.ModuleBlock:return e.statements.forEach(p);case h.FunctionDeclaration:return u(e);case h.ClassDeclaration:var r=e;if(a=c(r)){b.setNs(x),b.write(a);var n,s,i,a=x;x&&(x+="."),x+=r.name.text;let e=a?"":"declare",t="";if(r.heritageClauses)for(var o of r.heritageClauses)o.token==h.ExtendsKeyword&&(t=" extends "+k(y(o.types[0])));b.write(e+` class ${r.name.text}${t} {`),b.incrIndent();for(let t of r.members)switch(t.kind){case h.MethodDeclaration:u(t);break;case h.PropertyDeclaration:n=t,i=s=l=void 0,(i=c(n))&&(s="//% shim=."+(l=n.name.getText()),n=g.getTypeAtLocation(n),b.write(i),b.write(s),b.write(`public ${l}: ${k(n)};`),b.write(""));break;case h.Constructor:i=t,s=void 0,(s=c(i))&&(g.getTypeAtLocation(i),i=i.parameters.map(e=>e.name.getText()+": "+k(y(e))),b.write(s),b.write(`//% shim="new ${x}"`),b.write(`constructor(${i.join(", ")});`),b.write(""));break;case h.GetAccessor:var l=r.members.some(e=>e.kind==h.SetAccessor&&e.name.getText()==t.name.getText());u(t,l)}x=a,b.decrIndent(),b.write("}")}return}var a,t}}}(pxt=pxt||{}),function(p){var d;(d=p.pxtc||(p.pxtc={})).annotate=function(e,t,r){var n=d.target;d.target=r;let s=e.getSourceFiles().filter(e=>e.fileName===t)[0],o=e.getTypeChecker();function l(t,r,e=!1,n=null){var e=e||!(u(t).flags&p.TypeFlags.Void),s=n||c(t);if(t.expression&&s){let e=!1;switch(s.kind){case d.SK.PropertySignature:case d.SK.PropertyAssignment:case d.SK.PropertyDeclaration:d.isStatic(s)||(e=!0);break;case d.SK.Parameter:d.isCtorField(s)&&(e=!0);break;case d.SK.GetAccessor:case d.SK.SetAccessor:case d.SK.MethodDeclaration:case d.SK.MethodSignature:e=!0}if(e){const p=t.expression;p.kind===d.SK.PropertyAccessExpression?r.unshift(p.expression):r.unshift(t.expression)}}n={decl:s,qName:s?d.getNodeFullName(o,s):"?",args:r,isExpression:e};d.pxtInfo(t).callInfo=n}function c(e){if(!e)return null;let t,r=o.getSymbolAtLocation(e);var n;if(!(t=r&&!(t=r.valueDeclaration)&&r.declarations&&(n=r.declarations[0])&&n.kind==p.SyntaxKind.ImportEqualsDeclaration&&(r=o.getSymbolAtLocation(n.moduleReference))?r.valueDeclaration:t)&&e.kind==d.SK.PropertyAccessExpression){const p=e;t={kind:d.SK.PropertySignature,symbol:{isBogusSymbol:!0,name:p.name.getText()},name:p.name},d.pxtInfo(t).flags|=2}return t}function u(e){let t;var r=d.pxtInfo(e);return r.typeCache||(t=(t=p.isExpression(e)?o.getContextualType(e):t)||o.getTypeAtLocation(e))&&(p.isStringLiteral(e)?t:d.checkType(t))}!function a(e){p.forEachChild(e,e=>{switch(e.kind){case p.SyntaxKind.CallExpression:l(e,e.arguments.slice(0),null,c(e.expression));break;case p.SyntaxKind.PropertyAccessExpression:l(e,[]);break;case p.SyntaxKind.TaggedTemplateExpression:l(e,[e.template],!0,c(e.tag));break;case p.SyntaxKind.BinaryExpression:var t=e,r=t.left,n=t.right,s=u(t.left),i=u(t.right);switch(t.operatorToken.kind!=d.SK.PlusToken&&t.operatorToken.kind!=d.SK.PlusEqualsToken||(d.isStringType(s)||d.isStringType(i)&&t.operatorToken.kind==d.SK.PlusToken)&&(d.pxtInfo(t).exprInfo={leftType:o.typeToString(s),rightType:o.typeToString(i)}),t.operatorToken.kind){case p.SyntaxKind.EqualsToken:case p.SyntaxKind.PlusEqualsToken:case p.SyntaxKind.MinusEqualsToken:if(r.kind==d.SK.PropertyAccessExpression){let e=c(r);e&&e.kind==d.SK.GetAccessor?l(r,[n],!1,e=p.getDeclarationOfKind(e.symbol,d.SK.SetAccessor)):e&&(e.kind==d.SK.PropertySignature||e.kind==d.SK.PropertyAssignment||d.target&&d.target.switches.slowFields)&&l(r,[n])}}break;case p.SyntaxKind.Identifier:const a=c(e);if(a&&a.getSourceFile().fileName!==pxt.MAIN_TS&&a.kind==p.SyntaxKind.VariableDeclaration){const p=d.pxtInfo(e);p.flags|=4,p.commentAttrs||(p.commentAttrs=d.parseComments(a))}}a(e)})}(s),d.target=n}}(ts=ts||{}),function(e){function a(t){let r='"';for(let e=0;e<t.length;++e){var n=255&t.charCodeAt(e),s=String.fromCharCode(n);r+="\\"==s||'"'==s?"\\"+s:"\n"==s?"\\n":n<=15?"\\x0"+n.toString(16):n<32||127<n?"\\x"+n.toString(16):s}return r+'"'}function r(n){let e="pxt::string_inline_ascii_vt",s=y.target.utf8?y.U.toUTF8(n,!0):n,i="";if(s!==n)if(16<n.length){e="pxt::string_skiplist16_packed_vt";let t=[],r=0;for(let e=0;e+16<=n.length;e+=16)r+=y.U.toUTF8(n.slice(e,e+16),!0).length,t.push(r);i=`
    .short ${s.length}, ${n.length}
    .short ${t.map(e=>e.toString()).join(", ")}
    .string ${a(s)}
`}else e="pxt::string_inline_utf8_vt";return i=i||`
    .short ${s.length}
    .string ${a(s)}
`,{vt:e,asm:i}}function n(e,t=""){return`
                .word ${e.length>>1}${t}
                .hex ${e}${e.length%4==0?"":"00"}
        `}var y;(y=e.pxtc||(e.pxtc={})).asmStringLiteral=a,y.AssemblerSnippets=class{nop(){return"TBD(nop)"}reg_gets_imm(e,t){return"TBD(reg_gets_imm)"}proc_setup(e,t){return"TBD(proc_setup)"}push_fixed(e){return"TBD(push_fixed)"}push_local(e){return"TBD(push_local)"}push_locals(e){return"TBD(push_locals)"}pop_fixed(e){return"TBD(pop_fixed)"}pop_locals(e){return"TBD(pop_locals)"}proc_return(){return"TBD(proc_return)"}debugger_stmt(e){return""}debugger_bkpt(e){return""}debugger_proc(e){return""}unconditional_branch(e){return"TBD(unconditional_branch)"}beq(e){return"TBD(beq)"}bne(e){return"TBD(bne)"}cmp(e,t){return"TBD(cmp)"}cmp_zero(e){return"TBD(cmp_zero)"}arithmetic(){return""}load_reg_src_off(e,t,r,n,s,i){return"TBD(load_reg_src_off)"}rt_call(e,t,r){return"TBD(rt_call)"}call_lbl(e,t){return"TBD(call_lbl)"}call_reg(e){return"TBD(call_reg)"}helper_prologue(){return"TBD(lambda_prologue)"}helper_epilogue(){return"TBD(lambda_epilogue)"}pop_clean(e){return"TBD"}load_ptr_full(e,t){return"TBD(load_ptr_full)"}emit_int(e,t){return"TBD(emit_int)"}obj_header(e){return".word "+e}string_literal(e,t){t=r(t);return`
            .balign 4
            ${e}: ${this.obj_header(t.vt)}
            ${t.asm}
`}hex_literal(e,t){return`
.balign ${/f{16}/i.test(t)?8:4}
${e}: ${this.obj_header("pxt::buffer_vt")}
${n(t)}
`}},y.utf8AsmStringLiteral=r,y.hexLiteralAsm=n,y.numBytes=function(t){let r=0;for(let e=t;0<e;e>>>=8)r++;return r||1},y.ProctoAssembler=class{constructor(e,t,r){this.resText="",this.exprStack=[],this.calls=[],this.proc=null,this.baseStackSize=0,this.labelledHelpers={},this.write=e=>{this.resText+=y.asmline(e)},this.t=e,this.bin=t,this.proc=r,this.proc&&this.work()}emitHelpers(){this.emitLambdaTrampoline(),this.emitArrayMethods(),this.emitFieldMethods(),this.emitBindHelper()}redirectOutput(e){let t=this.write,r="";this.write=e=>r+=y.asmline(e);try{e()}finally{this.write=t}return r}stackSize(){return this.baseStackSize+this.exprStack.length}stackAlignmentNeeded(e=0){return!y.target.stackAlign||(e=y.target.stackAlign-(this.stackSize()+e&y.target.stackAlign-1))==y.target.stackAlign?0:e}getAssembly(){return this.resText}work(){this.write(`
;
; Function ${this.proc.getFullName()}
;
`);let e=this.proc.label(),i=e+"_pre",a=e+"_bkpt",o=e+"_locals",l=e+"_end";this.write(i+":"),this.emitLambdaWrapper(this.proc.isRoot),this.write(".section code"),this.write(e+":"),this.proc.classInfo&&this.proc.info.thisParameter&&!y.target.switches.skipClassCheck&&!y.target.switches.noThisCheckOpt&&(this.write("mov r7, lr"),this.write("ldr r0, [sp, #0]"),this.emitInstanceOf(this.proc.classInfo,"validate"),this.write("mov lr, r7")),this.write(`
${e}_nochk:
    @stackmark func
    @stackmark args
`),this.proc.fillDebugInfo=t=>{var e,r=t.getLabels();this.proc.debugInfo={locals:(1==this.proc.seqNo?this.bin.globals:this.proc.locals).map(e=>e.getDebugInfo()),args:this.proc.args.map(e=>e.getDebugInfo()),name:this.proc.getName(),codeStartLoc:y.U.lookup(r,o),codeEndLoc:y.U.lookup(r,l),bkptLoc:y.U.lookup(r,a),localsMark:y.U.lookup(t.stackAtLabel,o),idx:this.proc.seqNo,calls:this.calls,size:y.U.lookup(r,l)+2-y.U.lookup(r,i)};for(e of this.calls)e.addr=y.U.lookup(r,e.callLabel),e.stack=y.U.lookup(t.stackAtLabel,e.callLabel),e.callLabel=void 0;for(let e=0;e<this.proc.body.length;++e){var n,s=this.proc.body[e].breakpointInfo;s&&(n=y.U.lookup(t.stackAtLabel,"__brkp_"+s.id))!==this.proc.debugInfo.localsMark&&(console.log(s),console.log(t.stackAtLabel),y.U.oops(`offset doesn't match: ${n} != `+this.proc.debugInfo.localsMark))}},this.bin.options.breakpoints&&this.write(this.t.debugger_proc(a)),this.baseStackSize=1;var t=this.proc.locals.length;this.write("push {lr}"),this.write(".locals:\n"),this.proc.perfCounterNo&&(this.write(this.t.emit_int(this.proc.perfCounterNo,"r0")),this.write("bl pxt::startPerfCounter")),this.write(this.t.proc_setup(t)),this.baseStackSize+=t,this.write("@stackmark locals"),this.write(o+":");for(let e=0;e<this.proc.body.length;++e){var r,n=this.proc.body[e];switch(n.stmtKind){case y.ir.SK.Expr:this.emitExpr(n.expr);break;case y.ir.SK.StackEmpty:if(0<this.exprStack.length){for(var s of this.proc.body.slice(e-4,e+1))console.log("PREVSTMT "+s.toString().trim());for(var c of this.exprStack)console.log(`EXPRSTACK ${c.currUses}/${c.totalUses} E: `+c.toString());y.oops("stack should be empty")}this.write("@stackempty locals");break;case y.ir.SK.Jmp:this.emitJmp(n);break;case y.ir.SK.Label:this.write(n.lblName+":"),this.validateJmpStack(n);break;case y.ir.SK.Comment:this.write("; "+n.expr.data);break;case y.ir.SK.Breakpoint:this.bin.options.breakpoints&&(r="__brkp_"+n.breakpointInfo.id,n.breakpointInfo.isDebuggerStmt?this.write(this.t.debugger_stmt(r)):this.write(this.t.debugger_bkpt(r)));break;default:y.oops()}}y.assert(0<=t&&t<127),0<t&&this.write(this.t.pop_locals(t)),this.proc.perfCounterNo&&(this.write("mov r4, r0"),this.write(this.t.emit_int(this.proc.perfCounterNo,"r0")),this.write("bl pxt::stopPerfCounter"),this.write("mov r0, r4")),this.write(l+":"),this.write(this.t.proc_return()),this.write("@stackempty func"),this.write("@stackempty args"),this.write("; endfun")}mkLbl(e){let t=e+this.bin.lblNo++;return t="_"!=t[0]?"."+t:t}dumpStack(){let e="[";for(var t of this.exprStack)e+=t.sharingInfo()+": "+t.toString()+"; ";return e+="]"}terminate(e){y.assert(e.exprKind==y.ir.EK.SharedRef);e=e.args[0];y.U.assert(e.currUses!=e.totalUses),y.U.assert(this.exprStack[0]===e,"term at top");let t=1;for(;t<this.exprStack.length;){var r=this.exprStack[t];if(r.currUses!=r.totalUses)break;t++}return this.write("@dummystack "+t),this.write(this.t.pop_locals(t)),t}validateJmpStack(e,t=0){t=this.exprStack.length-t;null==e.lblStackSize?e.lblStackSize=t:e.lblStackSize!=t&&(console.log(e.lblStackSize,t),console.log(this.dumpStack()),y.U.oops("stack misaligned at: "+e.lblName))}emitJmp(e){let t=0;var r;e.jmpMode==y.ir.JmpMode.Always?(e.expr&&this.emitExpr(e.expr),e.terminateExpr&&(t=this.terminate(e.terminateExpr)),this.write(this.t.unconditional_branch(e.lblName)+" ; with expression")):(r=this.mkLbl("jmpz"),this.emitExpr(e.expr),e.expr.exprKind==y.ir.EK.RuntimeCall&&("thumb::subs"===e.expr.data||y.U.startsWith(e.expr.data,"_cmp_"))||this.write(this.t.cmp_zero("r0")),e.jmpMode==y.ir.JmpMode.IfNotZero?this.write(this.t.beq(r)):this.write(this.t.bne(r)),e.terminateExpr&&(t=this.terminate(e.terminateExpr)),this.write(this.t.unconditional_branch(e.lblName)),this.write(r+":")),this.validateJmpStack(e.lbl,t)}clearStack(e=!1){let t=0;for(;0<this.exprStack.length&&this.exprStack[0].currUses==this.exprStack[0].totalUses;)t++,this.exprStack.shift();if(t&&this.write(this.t.pop_locals(t)),!e){e=this.exprStack.filter(e=>e.currUses==e.totalUses&&-1!=e.irCurrUses);if(0<e.length){this.write(this.t.reg_gets_imm("r7",0));for(var r of e)r.irCurrUses=-1,this.write(this.loadFromExprStack("r7",r,0,!0))}}}emitExprInto(e,r){switch(e.exprKind){case y.ir.EK.NumberLiteral:"number"==typeof e.data?this.write(this.t.emit_int(e.data,r)):y.oops();break;case y.ir.EK.PointerLiteral:this.write(this.t.load_ptr_full(e.data,r));break;case y.ir.EK.SharedRef:var n=e.args[0],t=(y.U.assert(!!n.currUses),y.U.assert(n.currUses<n.totalUses),n.currUses++,this.exprStack.indexOf(n));y.U.assert(0<=t),0==t&&n.totalUses==n.currUses?(this.write(this.t.pop_fixed([r])+(" ; tmpref @"+this.exprStack.length)),this.exprStack.shift(),this.clearStack()):(n=t.toString()+":"+this.exprStack.length,this.write(this.t.load_reg_src_off(r,"sp",n,!0)+" ; tmpref @"+(this.exprStack.length-t)));break;case y.ir.EK.CellRef:n=e.data;if(n.isGlobal()){let e=this.bitSizeInfo(n.bitSize),t="#"+n.index;(e.needsSignExt||n.index>=e.immLimit)&&(this.write(this.t.emit_int(n.index,r)),t=r),this.write(this.t.load_reg_src_off("r7","r6","#0")),this.write(this.t.load_reg_src_off(r,"r7",t,!1,!1,e))}else{var[t,n,s]=this.cellref(n);this.write(this.t.load_reg_src_off(r,t,n,s))}break;default:y.oops()}}bitSizeInfo(e){var t={size:y.sizeOfBitSize(e),immLimit:128};return 1==t.size?t.immLimit=32:2==t.size&&(t.immLimit=64),1!=e&&3!=e||(t.needsSignExt=!0),t}emitExpr(e){switch(e.exprKind){case y.ir.EK.JmpValue:this.write("; jmp value (already in r0)");break;case y.ir.EK.Nop:this.write(this.t.nop());break;case y.ir.EK.FieldAccess:return this.emitExpr(e.args[0]),this.emitFieldAccess(e);case y.ir.EK.Store:return this.emitStore(e.args[0],e.args[1]);case y.ir.EK.RuntimeCall:return this.emitRtCall(e);case y.ir.EK.ProcCall:return this.emitProcCall(e);case y.ir.EK.SharedDef:return this.emitSharedDef(e);case y.ir.EK.Sequence:return e.args.forEach(e=>this.emitExpr(e)),this.clearStack();case y.ir.EK.InstanceOf:return this.emitExpr(e.args[0]),this.emitInstanceOf(e.data,e.jsInfo);default:return this.emitExprInto(e,"r0")}}emitFieldAccess(e,t=!1){e=e.data;e.classInfo.id,e.name;e.needsCheck&&!y.target.switches.skipClassCheck&&this.emitInstanceOf(e.classInfo,"validate");let r=4*e.idx+4,n="#"+r;124<r&&(this.write(this.t.emit_int(r,"r3")),n="r3"),t?this.write(`str r1, [r0, ${n}]`):this.write(`ldr r0, [r0, ${n}]`)}writeFailBranch(){this.write(".fail:"),this.write("mov r1, lr"),this.write(this.t.callCPP("pxt::failedCast"))}emitClassCall(e){var t=e.virtualIndex+y.firstMethodOffset();this.write(this.t.emit_int(4*t,"r1"));let r=e.classInfo,n="";e.isThis&&(n+="_this"),this.emitLabelledHelper("classCall_"+r.id+n,()=>{this.write("ldr r0, [sp, #0] ; ld-this"),this.loadVTable(),y.target.switches.skipClassCheck||e.isThis||this.checkSubtype(r),this.write("ldr r1, [r3, r1] ; ld-method"),this.write("bx r1 ; keep lr from caller"),this.writeFailBranch()})}emitBindHelper(){this.write(`
                .section code
                _pxt_bind_helper:
                    push {r0, r2}
                    movs r0, #2
                    ldlit r1, _pxt_bind_lit
                    ${this.t.callCPP("pxt::mkAction")}
                    pop {r1, r2}
                    str r1, [r0, #12]
                    str r2, [r0, #16]
                    bx r4 ; return

                _pxt_bind_lit:
                    ${this.t.obj_header("pxt::RefAction_vtable")}
                    .short 0, 0 ; no captured vars
                    .word .bindCode@fn
                .bindCode:
                    ; r0-bind object, r4-#args
                    cmp r4, #12
                    bge .fail
                    lsls r3, r4, #2
                    ldlit r2, _pxt_copy_list
                    ldr r1, [r2, r3]

                    ldr r3, [r0, #12]
                    ldr r2, [r0, #16]
                    adds r4, r4, #1
                    bx r1
            `),this.writeFailBranch(),this.write("_pxt_copy_list:"),this.write(y.U.range(12).map(e=>`.word _pxt_bind_${e}@fn`).join("\n"));for(let t=0;t<12;t++){this.write(`
                _pxt_bind_${t}:
                    sub sp, #4
                `);for(let e=0;e<t;++e)this.write(`ldr r1, [sp, #4*${e+1}]`),this.write(`str r1, [sp, #4*${e}]`);this.write(`
                    push {r3} ; this-ptr
                    mov r1, lr
                    str r1, [sp, #4*${t+1}] ; store LR
                    blx r2
                    ldr r1, [sp, #4*${t+1}]
                    add sp, #8
                    bx r1
                `)}}ifaceCallCore(t,e,r=!1){this.write("\n                ldr r2, [r3, #12] ; load mult\n                movs r7, r2\n                beq .objlit ; built-in types have mult=0\n                muls r7, r1\n                lsrs r7, r2\n                lsls r7, r7, #1 ; r7 - hash offset\n                ldr r3, [r3, #4] ; iface table\n                adds r3, r3, r7\n                ; r0-this, r1-method idx, r2-free, r3-hash entry, r4-num args, r7-free\n                ");for(let e=0;e<y.vtLookups;++e)0<e&&this.write("    adds r3, #2"),this.write("\n                ldrh r2, [r3, #0] ; r2-offset of descriptor\n                ldrh r7, [r2, r3] ; r7-method idx\n                cmp r7, r1\n                beq .hit\n                ");"get"==e?(this.write("movs r0, #0 ; undefined"),this.write("bx lr")):this.write("b .fail2"),this.write("\n            .hit:\n                adds r3, r3, r2 ; r3-descriptor\n                ldr r2, [r3, #4]\n                lsls r7, r2, #31\n                beq .field\n            ");var n=this.t.emit_int(t,"r4")+"\n     bx r2";if("set"==e?this.write(`
                    ; check for next descriptor
                    ldrh r7, [r3, #8]
                    cmp r7, r1
                    bne .fail2 ; no setter!
                    ldr r2, [r3, #12]
                    ${n}
                `):(this.write("\n                    ; check if it's getter\n                    ldrh r7, [r3, #2]\n                    cmp r7, #1\n                "),"get"==e?this.write(`
                        bne .bind
                        ${n}
                    .bind:
                        mov r4, lr
                        bl _pxt_bind_helper
                    `):this.write(`
                        beq .doublecall
                        ${n}
                    .doublecall:
                        ; call getter
                        movs r4, #1
                        push {r0, lr}
                        blx r2
                        pop {r1, r2}
                        mov lr, r2
                        b .moveArgs
                    `)),r||(this.write(`
                .objlit:
                    ldrh r2, [r3, #8]
                    cmp r2, #${pxt.BuiltInType.RefMap}
                    bne .fail
                    mov r4, lr
                `),"set"==e&&this.write("ldr r2, [sp, #4] ; ld-val"),this.write(this.t.callCPP("set"==e?"pxtrt::mapSet":"pxtrt::mapGet")),e?this.write("bx r4"):(this.write("mov lr, r4"),this.write("b .moveArgs"))),this.write(".field:"),"set"==e?this.write("\n                        ldr r3, [sp, #4] ; ld-val\n                        str r3, [r0, r2] ; store field\n                        bx lr\n                    "):"get"==e?this.write("\n                        ldr r0, [r0, r2] ; load field\n                        bx lr\n                    "):this.write("\n                        ldr r0, [r0, r2] ; load field\n                    "),!e){this.write(".moveArgs:");for(let e=0;e<t;++e)e==t-1?this.write("movs r1, r0"):this.write(`ldr r1, [sp, #4*${e+1}]`),this.write(`str r1, [sp, #4*${e}]`);this.lambdaCall(t-1)}r&&this.write(".objlit:"),this.writeFailBranch(),this.write(`
            .fail2:
                ${this.t.callCPP("pxt::missingProperty")}
            `)}emitIfaceCall(e,t,r=""){y.U.assert(0<e.ifaceIndex),this.write(this.t.emit_int(e.ifaceIndex,"r1")),this.emitLabelledHelper("ifacecall"+t+"_"+r,()=>{this.write("ldr r0, [sp, #0] ; ld-this"),this.loadVTable(),this.ifaceCallCore(t,r)})}checkSubtype(e,t=".fail",r="r2"){e.classNo?(this.write(`ldrh ${r}, [r3, #8]`),this.write(`cmp ${r}, #`+e.classNo),e.classNo==e.lastSubtypeNo?this.write("bne "+t):(this.write("blt "+t),this.write(`cmp ${r}, #`+e.lastSubtypeNo),this.write("bgt "+t))):this.write(`b ${t} ; always fails; class never instantiated`)}loadVTable(e="r2",t=".fail",r=".fail"){this.write(`lsls ${e}, r0, #30`),this.write("bne "+t),this.write("cmp r0, #0"),this.write("beq "+r),this.write("ldr r3, [r0, #0]"),this.write("; vtable in R3")}emitInstanceOf(e,t){var r="inst_"+e.id+"_"+t;this.emitLabelledHelper(r,()=>{"validateNullable"==t?this.loadVTable("r2",".tagged",".undefined"):this.loadVTable("r2",".fail",".fail"),this.checkSubtype(e),"bool"==t?(this.write("movs r0, #"+y.taggedTrue),this.write("bx lr"),this.write(".fail:"),this.write("movs r0, #"+y.taggedFalse),this.write("bx lr")):"validate"==t?(this.write("bx lr"),this.writeFailBranch()):"validateNullable"==t?(this.write(".undefined:"),this.write("bx lr"),this.write(".tagged:"),this.write(`cmp r0, #${y.taggedNull} ; check for null`),this.write("bne .fail"),this.write("movs r0, #0"),this.write("bx lr"),this.writeFailBranch()):y.U.oops()})}emitSharedDef(e){e=e.args[0];if(y.U.assert(1<=e.totalUses),y.U.assert(0===e.currUses),(e.currUses=1)==e.totalUses)return this.emitExpr(e);this.emitExpr(e),this.exprStack.unshift(e),this.write(this.t.push_local("r0")+"; tmpstore @"+this.exprStack.length)}clearArgs(e,t){e.length,t.length;var r,n=e.concat(t);for(r of n)0==r.currUses&&1==r.totalUses||(console.log(r.toString()),console.log(n.map(e=>e.toString())),y.U.oops(`wrong uses: ${r.currUses} `+r.totalUses)),r.currUses=1;this.clearStack()}builtInClassNo(e){return{id:"builtin"+e,classNo:e,lastSubtypeNo:e}}emitBeginTry(e){this.emitExprInto(e.args[0],"r0"),this.write("bl _pxt_save_exception_state")}emitRtCall(e,t=null){var r,n,s,i=e.data;if("pxt::beginTry"==i)return this.emitBeginTry(e);let a=e.mask||{refMask:0},o=a.conversions||[],l=e.args.map((e,t)=>({idx:t,expr:e,isSimple:e.isLiteral(),isRef:0!=(a.refMask&1<<t),conv:o.find(e=>e.argIdx==t)})),c=(y.U.assert(l.length<=4),!1);for(r of y.U.reversed(l))r.expr.isPure()?r.isSimple||r.isRef||c&&!r.expr.isStateless()||(r.isSimple=!0):c=!0;for(n of l)n.conv&&(n.isSimple=!1);let u=l.filter(e=>!e.isSimple);if(u.every(e=>e.expr.isPure()&&!e.isRef&&!e.conv)){for(var p of u)p.isSimple=!0;u=[]}let d=u[0],f=!0;if(1!=u.length||d.conv||d.isRef){for(var m of u)this.pushArg(m.expr);this.alignExprStack(0);let i=u.filter(e=>!!e.conv);if(i.length){const t=this.redirectOutput(()=>{let e=0;y.target.switches.inlineConversions||(this.t.stackAligned()?e+=2:e+=1);for(var t of i){var r;y.isThumb()&&"pxt::toInt"==t.conv.method?(this.write(this.loadFromExprStack("r0",t.expr,e)),this.write("asrs r0, r0, #1"),r=y.target.switches.inlineConversions?t.expr.getId():e,this.write("bcs .isint"+r),this.write("lsls r0, r0, #1"),this.alignedCall(t.conv.method,"",e),this.write(".isint"+r+":")):(this.write(this.loadFromExprStack("r0",t.expr,e)),t.conv.refTag?y.target.switches.skipClassCheck||this.emitInstanceOf(this.builtInClassNo(t.conv.refTag),t.conv.refTagNullable?"validateNullable":"validate"):(this.alignedCall(t.conv.method,"",e),t.conv.returnsRef&&this.write(this.loadFromExprStack("r0",t.expr,e,!0)))),this.write(this.t.push_fixed(["r0"])),e++}for(var n of y.U.reversed(i))e--,this.write(this.t.pop_fixed(["r"+n.idx]));for(var s of u)s.conv||this.write(this.loadFromExprStack("r"+s.idx,s.expr,e))});y.target.switches.inlineConversions?this.write(t):this.emitHelper(this.t.helper_prologue()+t+this.t.helper_epilogue(),"conv")}else for(var h of u)this.write(this.loadFromExprStack("r"+h.idx,h.expr))}else this.emitExpr(d.expr),0!=d.idx&&this.write(this.t.mov("r"+d.idx,"r0")),f=!1;for(s of l)s.isSimple&&this.emitExprInto(s.expr,"r"+s.idx);t?t():"langsupp::ignore"!=i&&this.alignedCall(i,"",0,!0),f&&this.clearArgs(u.filter(e=>!e.isRef).map(e=>e.expr),u.filter(e=>e.isRef).map(e=>e.expr))}alignedCall(e,t="",r=0,n=!1){(y.U.startsWith(e,"_cmp_")||y.U.startsWith(e,"_pxt_"))&&(n=!1),this.write(this.t.call_lbl(e,n,this.stackAlignmentNeeded(r))+t)}emitLabelledHelper(e,t){this.labelledHelpers[e]?this.write(this.t.call_lbl(this.labelledHelpers[e])):(t=this.redirectOutput(t),this.emitHelper(t,e),this.labelledHelpers[e]=this.bin.codeHelpers[t])}emitHelper(e,t="hlp"){var r;this.bin.codeHelpers[e]||(r=Object.keys(this.bin.codeHelpers).length,this.bin.codeHelpers[e]=`_${t}_`+r),this.write(this.t.call_lbl(this.bin.codeHelpers[e]))}pushToExprStack(e){e.totalUses=1,e.currUses=0,this.exprStack.unshift(e)}pushArg(e){this.clearStack(!0),this.exprStack.length,this.emitExpr(e),this.clearStack(!0),this.write(this.t.push_local("r0")+" ; proc-arg"),this.pushToExprStack(e)}loadFromExprStack(e,t,r=0,n=!1){t=this.exprStack.indexOf(t);return y.assert(0<=t),this.t.load_reg_src_off(e,"sp",(t+r).toString(),!0,n)+" ; estack\n"}pushDummy(){var e=y.ir.numlit(0);e.totalUses=1,e.currUses=1,this.exprStack.unshift(e)}alignExprStack(e){var t=this.stackAlignmentNeeded(e);if(t)for(let e=0;e<t;++e)this.write("push {r5} ; align"),this.pushDummy()}emitFieldMethods(){for(var r of["get","set"]){this.write(`
                .section code
                _pxt_map_${r}:
                `),this.loadVTable("r4"),this.checkSubtype(this.builtInClassNo(pxt.BuiltInType.RefMap),".notmap","r4"),this.write(this.t.callCPPPush("set"==r?"pxtrt::mapSetByString":"pxtrt::mapGetByString")),this.write(".notmap:");let e="set"==r?2:1,t=!1;this.write("mov r4, r3 ; save VT"),"set"==r?(y.target.stackAlign&&(t=!0,this.write("push {lr} ; align")),this.write("\n                            push {r0, r2, lr}\n                            mov r0, r1\n                        ")):this.write("\n                            push {r0, lr}\n                            mov r0, r1\n                        "),this.write("\n                    bl pxtrt::lookupMapKey\n                    mov r1, r0 ; put key index in r1\n                    ldr r0, [sp, #0] ; restore obj pointer\n                    mov r3, r4 ; restore vt\n                    bl .dowork\n                "),this.write(this.t.pop_locals(e+(t?1:0))),this.write("pop {pc}"),this.write(".dowork:"),this.ifaceCallCore(e,r,!0)}}emitArrayMethod(e,t){this.write(`
            .section code
            _pxt_${t?"buffer":"array"}_${e}:
            `),this.loadVTable("r4");var r=this.builtInClassNo(t?pxt.BuiltInType.BoxedBuffer:pxt.BuiltInType.RefCollection),r=(y.target.switches.skipClassCheck||this.checkSubtype(r,".fail","r4"),y.isStackMachine()||y.target.runtimeIsARM||t?"ldr":"ldrh");this.write(`
                asrs r1, r1, #1
                bcc .notint
                ${r} r4, [r0, #${t?4:8}]
                cmp r1, r4
                bhs .oob
            `);let n="r1";t?(n="#8",this.write("\n                    adds r4, r0, r1\n                ")):this.write("\n                    lsls r1, r1, #2\n                    ldr r4, [r0, #4]\n                ");var r=t?"b":"",s=t&&"get"==e?"lsls r0, r0, #1\nadds r0, #1":"";"set"==e?this.write(`
                        str${r} r2, [r4, ${n}]
                        bx lr
                    `):this.write(`
                        ldr${r} r0, [r4, ${n}]
                        ${s}
                        bx lr
                    `),this.write(`
            .notint:
                lsls r1, r1, #1
                ${this.t.pushLR()}
                push {r0, r2}
                mov r0, r1
                ${this.t.callCPP("pxt::toInt")}
                mov r1, r0
                pop {r0, r2}
            .doop:
                ${this.t.callCPP(`Array_::${e}At`)}
                ${s}
                ${this.t.popPC()}
            `),this.writeFailBranch(),"get"==e?this.write(`
                    .oob:
                        movs r0, #${t?1:0} ; 0 or undefined
                        bx lr
                `):this.write(`
                    .oob:
                        ${this.t.pushLR()}
                        b .doop
                `)}emitArrayMethods(){for(var e of["get","set"])this.emitArrayMethod(e,!0),this.emitArrayMethod(e,!1)}emitLambdaTrampoline(){var e=y.target.stackAlign?"r3,":"";this.write(`
            .section code
            _pxt_lambda_trampoline:
                push {${e} r4, r5, r6, r7, lr}
                mov r4, r8
                mov r5, r9
                mov r6, r10
                mov r7, r11
                push {r4, r5, r6, r7} ; save high registers
                mov r4, r1
                mov r5, r2
                mov r6, r3
                mov r7, r0
                `),this.emitInstanceOf(this.builtInClassNo(pxt.BuiltInType.RefAction),"validate"),this.write(`
                mov r0, sp
                push {r4, r5, r6, r7} ; push args and the lambda
                mov r1, sp
                bl pxt::pushThreadContext
                mov r6, r0          ; save ctx or globals
                mov r5, r7          ; save lambda for closure
                mov r0, r5          ; also save lambda pointer in r0 - needed by pxt::bindMethod
                ldr r1, [r5, #8]    ; ld fnptr
                movs r4, #3         ; 3 args
                blx r1              ; execute the actual lambda
                mov r7, r0          ; save result
                @dummystack 4
                add sp, #4*4        ; remove arguments and lambda
                mov r0, r6   ; or pop the thread context
                bl pxt::popThreadContext
                mov r0, r7 ; restore result
                pop {r4, r5, r6, r7} ; restore high registers
                mov r8, r4
                mov r9, r5
                mov r10, r6
                mov r11, r7
                pop {${e} r4, r5, r6, r7, pc}`),this.write(`
            .section code
            ; r0 - try frame
            ; r1 - handler PC
            _pxt_save_exception_state:
                push {r0, lr}
                ${this.t.callCPP("pxt::beginTry")}
                pop {r1, r4}
                str r1, [r0, #1*4] ; PC
                mov r1, sp
                str r1, [r0, #2*4] ; SP
                str r5, [r0, #3*4] ; lambda ptr
                bx r4
                `),this.write("\n            .section code\n            ; r0 - try frame\n            ; r1 - thread context\n            _pxt_restore_exception_state:\n                mov r6, r1\n                ldr r1, [r0, #2*4] ; SP\n                mov sp, r1\n                ldr r5, [r0, #3*4] ; lambda ptr\n                ldr r1, [r0, #1*4] ; PC\n                movs r0, #1\n                orrs r1, r0\n                bx r1\n                "),this.write("\n            .section code\n            _pxt_stringConv:\n            "),this.loadVTable(),this.checkSubtype(this.builtInClassNo(pxt.BuiltInType.BoxedString),".notstring"),this.write(`
                bx lr

            .notstring: ; no string, but vtable in r3
                ldr r7, [r3, #4*${y.firstMethodOffset()-1}]
                cmp r7, #0
                beq .fail
                push {r0, lr}
                movs r4, #1
                blx r7
                str r0, [sp, #0]
                b .numops

            .fail: ; not an object or no toString
                push {r0, lr}
            .numops:
                ${this.t.callCPP("numops::toString")}
                pop {r1}
                pop {pc}
            `)}emitProcCall(t){let r=[],e=null,n="",s=t.data;if(s.proc&&s.proc.inlineBody)return this.emitExpr(s.proc.inlineSelf(t.args));let i=-1==s.virtualIndex,a=!1;for(var o of y.U.reversed(t.args)){if(o.isPure()){if(!a||o.isStateless())continue}else a=!0;r.push(o)}if(r.reverse(),r.length<=1){var l=r[0];l&&(e=l,this.clearStack(!0),this.emitExpr(l),l==t.args[t.args.length-1]?n="r0":(n="r3",this.write(this.t.mov("r3","r0")))),r=[]}else for(var c of r)this.pushArg(c);this.alignExprStack(t.args.length);let u=["r1","r2","r3","r4"],p=[];if(r.length){let t=-1;for(var d of r)t=Math.max(this.exprStack.indexOf(d),t);if(++t<=u.length){u=u.slice(0,t),this.write(this.t.pop_fixed(u)),p=this.exprStack.splice(0,t);var f=[];for(let e=t-1;0<=e;--e)r.indexOf(p[e])<0&&(f.push(u[e]),this.exprStack.unshift(p[e]));f.length&&this.write(this.t.push_fixed(f))}else u=null,this.write(this.t.reg_gets_imm("r7",0))}var m,h,g,l=y.U.reversed(t.args);i&&l.unshift(l.pop());for(m of l)0<=r.indexOf(m)?(u?this.write(this.t.push_fixed([u[p.indexOf(m)]])):(this.write(this.loadFromExprStack("r0",m)),this.write(this.t.push_local("r0")+" ; re-push"),this.write(this.loadFromExprStack("r7",m,1,!0)),h=this.exprStack.indexOf(m),(g=y.ir.numlit(0)).currUses=1,g.totalUses=1,this.exprStack[h]=g),this.exprStack.unshift(m)):m===e?(this.write(this.t.push_local(n)+" ; the one arg"),this.pushToExprStack(m)):this.pushArg(m);let b=this.mkLbl("_proccall"),x=-1;if(i){let e=t.args.length-1;this.write(this.loadFromExprStack("r0",t.args[0])),this.emitLabelledHelper("lambda_call"+e,()=>{this.lambdaCall(e),this.writeFailBranch()})}else null!=s.virtualIndex||null!=s.ifaceIndex?null!=s.ifaceIndex?s.isSet?(y.assert(2==t.args.length),this.emitIfaceCall(s,t.args.length,"set")):this.emitIfaceCall(s,t.args.length,s.noArgs?"get":""):this.emitClassCall(s):(l=s.proc,x=l.seqNo,this.write(this.t.call_lbl(l.label()+(s.isThis?"_nochk":"")))),this.write(b+":");this.calls.push({procIndex:x,stack:0,addr:0,callLabel:b}),i&&t.args[0].isStateless()?this.clearArgs([t.args[0]],t.args.slice(1)):this.clearArgs([],t.args)}lambdaCall(t){this.write("; lambda call"),this.loadVTable(),y.target.switches.skipClassCheck||this.checkSubtype(this.builtInClassNo(pxt.BuiltInType.RefAction)),this.write(`
                movs r4, #${t}
                ldrh r1, [r0, #4]
                cmp r1, #0
                bne .pushR5
                ldr r1, [r0, #8]
                bx r1 ; keep lr from the caller
            .pushR5:
                sub sp, #8
            `);for(let e=0;e<t;++e)this.write(`ldr r1, [sp, #4*${e+2}]`),this.write(`str r1, [sp, #4*${e}]`);this.write(`
                str r5, [sp, #4*${t}]
                mov r1, lr
                str r1, [sp, #4*${t+1}]
                mov r5, r0
                ldr r7, [r5, #8]
                blx r7 ; exec actual lambda
                ldr r4, [sp, #4*${t+1}] ; restore what was in LR
                ldr r5, [sp, #4*${t}] ; restore lambda ctx
            `);for(let e=0;e<t;++e)this.write(`ldr r1, [sp, #4*${e}]`),this.write(`str r1, [sp, #4*${e+2}]`);this.write("\n                add sp, #8\n                bx r4\n            "),this.write("; end lambda call")}emitStore(e,t){switch(e.exprKind){case y.ir.EK.CellRef:var r=e.data;if(this.emitExpr(t),r.isGlobal()){let e=this.bitSizeInfo(r.bitSize),t="#"+r.index;r.index>=e.immLimit&&(this.write(this.t.emit_int(r.index,"r1")),t="r1"),this.write(this.t.load_reg_src_off("r7","r6","#0")),this.write(this.t.load_reg_src_off("r0","r7",t,!1,!0,e))}else{var[r,n,s]=this.cellref(r);this.write(this.t.load_reg_src_off("r0",r,n,s,!0))}break;case y.ir.EK.FieldAccess:this.emitRtCall(y.ir.rtcall("dummy",[e.args[0],t]),()=>this.emitFieldAccess(e,!0));break;default:y.oops()}}cellref(e){if(e.isGlobal())throw y.oops();var t;return e.iscap?(t=e.index+3,y.assert(0<=t&&t<32),["r5",t.toString(),!0]):e.isarg?["sp","args@"+e.index.toString()+":"+this.baseStackSize,!1]:["sp","locals@"+e.index,!1]}emitLambdaWrapper(n){if(this.write(""),this.write(".section code"),this.write(".balign 4"),n&&(this.proc.info.usedAsValue=!0),this.proc.info.usedAsValue||this.proc.info.usedAsIface){this.proc.info.usedAsValue&&(this.write(this.proc.label()+"_Lit:"),this.write(this.t.obj_header("pxt::RefAction_vtable")),this.write(".short 0, 0 ; no captured vars"),this.write(`.word ${this.proc.label()}_args@fn`)),this.write(this.proc.label()+"_args:");let r=this.proc.args.length;if(0!=r){this.write("cmp r4, #"+r),this.write(`bge ${this.proc.label()}_nochk`);let e=this.stackAlignmentNeeded(r+1),t=e?r+2:r+1;this.write("push {lr}"),this.emitLabelledHelper("expand_args_"+r,()=>{this.write("movs r0, #0"),this.write("movs r1, #0"),e&&this.write("push {r0}");for(let e=r;0<e;e--)e!=r&&(this.write("cmp r4, #"+e),this.write("blt .zero"+e),this.write(`ldr r0, [sp, #${t-1}*4]`),this.write(`str r1, [sp, #${t-1}*4] ; clear existing`),this.write(`.zero${e}:`)),this.write("push {r0}");this.write("bx lr")}),this.write(`bl ${this.proc.label()}_nochk`);n=r+(e?1:0);this.write("@dummystack "+n),this.write("add sp, #4*"+n),this.write("pop {pc}")}}}emitCallRaw(e){var t=y.hexfile.lookupFunc(e);y.assert(!!t,"unimplemented raw function: "+e),this.alignedCall(e)}}}(ts=ts||{}),function(e){{var $=e.pxtc||(e.pxtc={});const U={"numops::adds":"+","numops::subs":"-","numops::div":"/","numops::mod":"%","numops::muls":"*","numops::ands":"&","numops::orrs":"|","numops::eors":"^","numops::bnot":"~","numops::lsls":"<<","numops::asrs":">>","numops::lsrs":">>>","numops::le":"<=","numops::lt":"<","numops::lt_bool":"<","numops::ge":">=","numops::gt":">","numops::eq":"==","pxt::eq_bool":"==","pxt::eqq_bool":"===","numops::eqq":"===","numops::neqq":"!==","numops::neq":"!="},f={"pxsim.Boolean_":"","pxsim.pxtcore":"","pxsim.String_":"","pxsim.ImageMethods":"","pxsim.Array_":"","pxsim.pxtrt":"","pxsim.numops":""},m={"pxsim.Array_.getAt":"","pxsim.Array_.length":"","pxsim.Array_.mk":"","pxsim.Array_.push":"","pxsim.Boolean_.bang":"","pxsim.String_.concat":"","pxsim.String_.stringConv":"","pxsim.numops.toBool":"","pxsim.numops.toBoolDecr":"","pxsim.pxtcore.mkAction":"","pxsim.pxtcore.mkClassInstance":"","pxsim.pxtrt.ldlocRef":"","pxsim.pxtrt.mapGetByString":"","pxsim.pxtrt.stclo":"","pxsim.pxtrt.stlocRef":""};function d(e){let t="";for(var r of Object.keys(e)){var n=r.replace(/\./g,"_");e[r]=n,t+=`const ${n} = ${r};
`}return t}function C(e){var t="pxsim."+(e="pxt."==(e=e.replace(/::/g,".")).slice(0,4)?"pxtcore."+e.slice(4):e);if(m.hasOwnProperty(t))return m[t];var r=t.lastIndexOf(".");if(0<r){const e=t.slice(0,r);if(f.hasOwnProperty(e))return f[e]+t.slice(r)}return t}$.isBuiltinSimOp=function(e){return!!$.U.lookup(U,e.replace(/\./g,"::"))},$.shimToJs=C;const h=["runtime","oops","doNothing","pxsim","globals","maybeYield","setupDebugger","isBreakFrame","breakpoint","trace","checkStack","leave","checkResumeConsumed","setupResume","setupLambda","checkSubtype","failedCast","buildResume","mkVTable","bind","leaveAccessor"];$.jsEmit=function(r){let n="(function (ectx) {\n'use strict';\n";for(var e of h)n+=`const ${e} = ectx.${e};
`;n=(n=(n+="const __this = runtime;\nconst pxtrt = pxsim.pxtrt;\n")+"let yieldSteps = 1;\nectx.setupYield(function() { yieldSteps = 100; })\n")+"pxsim.setTitle("+JSON.stringify(r.getTitle())+");\n";var t,s={},i={};for(t of r.res.configData||[])s[t.key+""]=t.value,i[t.name]=t.key;n=(n+="pxsim.setConfigData("+JSON.stringify(s,null,1)+", "+JSON.stringify(i,null,1)+");\n")+"pxtrt.mapKeyNames = "+JSON.stringify(r.ifaceMembers,null,1)+";\n";var a=r.setPerfCounters(["SysScreen"]);n=(n=(n+="__this.setupPerfCounters("+JSON.stringify(a,null,1)+");\n")+d(m))+d(f);let o=0,l=0;r.procs.forEach(e=>{let t;e.cachedJS?(t=e.cachedJS,o+=t.length):(t=function(b,x){if(x.cachedJS)return x.cachedJS;let t="",y=e=>{t+=e+"\n"},k=e=>{t+="    "+e+"\n"},S=$.ir.EK,v=[],r=0,n={},s="",T=(y(`
function ${x.label()}(s) {
let r0 = s.r0, step = s.pc;
s.pc = -1;
`),x.perfCounterNo&&y(`if (step == 0) __this.startPerfCounter(${x.perfCounterNo});
`),y("\nwhile (true) {\nif (yieldSteps-- < 0 && maybeYield(s, step, r0) || runtime !== pxsim.runtime) return null;\nswitch (step) {\n  case 0:\n"),x.locals.forEach(e=>{k(E(e)+" = undefined;")}),x.args.length&&(k("if (s.lambdaArgs) {"),x.args.forEach((e,t)=>{k(`  ${E(e)} = (s.lambdaArgs[${t}]);`)}),k("  s.lambdaArgs = null;"),k("}")),x.classInfo&&x.info.thisParameter&&(k("r0 = s.arg0;"),K(x.classInfo,"validate")),0),I=[];for(var e of x.body)e.stmtKind==$.ir.SK.Label&&0<e.lblNumUses&&(e.lblId=++T);let i=0;for(var a of x.body){switch(a.stmtKind){case $.ir.SK.Expr:_(a.expr);break;case $.ir.SK.StackEmpty:p();break;case $.ir.SK.Jmp:let t=!1;for(let e=i+1;e<x.body.length&&x.body[e].stmtKind==$.ir.SK.Label;++e)if(a.lbl==x.body[e]){t=!0;break}o=a,l=t,o.lbl.lblNumUses==$.ir.lblNumUsesJmpNext||l?($.assert(o.jmpMode==$.ir.JmpMode.Always),o.expr&&_(o.expr)):($.assert(0<o.lbl.lblNumUses),l=`{ step = ${o.lbl.lblId}; continue; }`,o.jmpMode==$.ir.JmpMode.Always?(o.expr&&_(o.expr),k(l)):(_(o.expr),o.jmpMode==$.ir.JmpMode.IfNotZero?k("if (r0) "+l):k("if (!r0) "+l)));break;case $.ir.SK.Label:0<a.lblNumUses&&y(`  case ${a.lblId}:`);break;case $.ir.SK.Comment:y("// "+a.expr.data);break;case $.ir.SK.Breakpoint:!function(e){let t,r=e.breakpointInfo.id;if(k(`s.lastBrkId = ${r};`),b.options.breakpoints){var n=`return breakpoint(s, ${t=++T}, ${r}, r0);`;e.breakpointInfo.isDebuggerStmt?k(n):(k(`if ((breakpoints[0] && isBreakFrame(s)) || breakpoints[${r}]) `+n),b.options.trace&&k(`else return trace(${r}, s, ${t}, ${x.label()}.info);`))}else{if(!b.options.trace)return;t=++T,k(`return trace(${r}, s, ${t}, ${x.label()}.info);`)}y(`  case ${t}:`)}(a);break;default:$.oops()}i++}p(),x.perfCounterNo&&y(`__this.stopPerfCounter(${x.perfCounterNo});
`),x.isGetter()?k("return leaveAccessor(s, r0)"):k("return leave(s, r0)"),y("  default: oops()"),y("} } }");var o,l,c=$.nodeLocationInfo(x.action);return c.functionName=x.getName(),c.argumentNames=x.args&&x.args.map(e=>e.getName()),y(x.label()+".info = "+JSON.stringify(c)),x.isGetter()&&y(x.label()+".isGetter = true;"),x.isRoot&&y(`${x.label()}.continuations = [ ${I.join(",")} ]`),y(w(x.label()+"_mk",x.label(),r,Object.keys(n))),y(s),x.cachedJS=t;function w(e,t,r,n){let s="";s+=`
function ${e}(s) {
    checkStack(s.depth);
    return {
        parent: s, fn: ${t}, depth: s.depth + 1,
        pc: 0, retval: undefined, r0: undefined, overwrittenPC: false, lambdaArgs: null,
`;for(let e=0;e<r;++e)s+=`  tmp_${e}: undefined,
`;for(var i of n)s+=`  ${i}: undefined,
`;return s+="} }\n"}function E(e){return e.isGlobal()?"globals."+e.uniqueName():e.iscap?`s.caps[${e.index}]`:(e=e.uniqueName(),n[e]=!0,"s."+e)}function N(e){return function(e){switch(e.exprKind){case S.NumberLiteral:case S.PointerLiteral:case S.SharedRef:case S.CellRef:return 1;default:return}}(e)?A(e):(_(e),"r0")}function A(e){switch(e.exprKind){case S.NumberLiteral:if(!0===e.data)return"true";if(!1===e.data)return"false";if(null===e.data)return"null";if(void 0===e.data)return"undefined";if("number"==typeof e.data)return e.data+"";throw $.oops("invalid data: "+typeof e.data);case S.PointerLiteral:if(e.ptrlabel())return e.ptrlabel().lblId+"";if(null!=e.hexlit())return s+=`const ${e.data} = pxsim.BufferMethods.createBufferFromHex("${e.hexlit()}")
`,e.data;if("string"==typeof e.jsInfo)return e.jsInfo;$.U.oops();case S.SharedRef:var t=e.args[0],t=($.U.assert(!!t.currUses),$.U.assert(t.currUses<t.totalUses),t.currUses++,v.indexOf(t));return $.U.assert(0<=t),"s.tmp_"+t;case S.CellRef:return E(e.data);default:throw $.oops()}}function _(t){switch(t.exprKind){case S.JmpValue:k("// jmp value (already in r0)");break;case S.Nop:k("// nop");break;case S.FieldAccess:var e=t.data,r=e.shimName,n=N(t.args[0]);return r?void k(`r0 = ${n}${r};`):void k(`r0 = ${n}.fields["${e.name}"];`);case S.Store:var s=t.args[0],i=t.args[1];switch(s.exprKind){case S.CellRef:var a=s.data,o=N(i);k(`${E(a)} = ${function(e){switch(e){case 0:return"";case 1:return"pxtrt.toInt8";case 3:return"pxtrt.toInt16";case 5:return"pxtrt.toInt32";case 2:return"pxtrt.toUInt8";case 4:return"pxtrt.toUInt16";case 6:return"pxtrt.toUInt32";default:throw $.oops()}}(a.bitSize)}(${o});`);break;case S.FieldAccess:let e=s.data,t=e.shimName;t=t||`.fields["${e.name}"]`,_($.ir.rtcall("="+t,[s.args[0],i]));break;default:$.oops()}return;case S.RuntimeCall:return r=t,(n=$.ir.flattenArgs(r.args)).precomp.forEach(_),e=r.data,n=n.flattened.map(A),void("langsupp::ignore"!=e&&(u="",u="."==e[0]?""+n[0]+e+`(${n.slice(1).join(", ")})`:"="==e[0]?`(${n[0]})${e.slice(1)} = (${n[1]})`:$.U.startsWith(e,"new ")?`new ${C(e.slice(4))}(${n.join(", ")})`:$.U.lookup(U,e)?2==n.length?`(${n[0]} ${$.U.lookup(U,e)} ${n[1]})`:`(${$.U.lookup(U,e)} ${n[0]})`:`${C(e)}(${n.join(", ")})`,0==r.callingConvention?k(`r0 = ${u};`):(p=++T,I.push(p),"String_::stringConv"==e&&k(`if ((${n[0]}) && (${n[0]}).vtable) {`),2==r.callingConvention?k(`(function(cb) { ${u}.then(cb) })(buildResume(s, ${p}));`):(k(`setupResume(s, ${p});`),k(u+";")),k("checkResumeConsumed();"),k("return;"),"String_::stringConv"==e&&k(`} else { s.retval = (${n[0]}) + ""; }`),y(`  case ${p}:`),k("r0 = s.retval;"))));case S.ProcCall:{var l=t;u=l.data,p=u.proc;if(p&&p.inlineBody)return _(p.inlineSelf(l.args));const d=$.ir.rtcall("<frame>",[]),f=(d.totalUses=1,d.currUses=0,v.length),m=(v.push(d),"s.tmp_"+f),h=++T,g=-1==u.virtualIndex;if(p)k(m+` = ${p.label()}_mk(s);`);else{let t="generic";null!=u.ifaceIndex?t="if_"+b.ifaceMembers[u.ifaceIndex]:g?t="lambda":null!=u.virtualIndex?t=u.classInfo.id+"_v"+u.virtualIndex:$.U.oops();const y=l.args.length;t+="_"+y+"_mk",b.recordHelper(x.usingCtx,t,()=>{var e=$.U.range(y).map(e=>"arg"+e);return w(t,"null",5,e)}),k(m+` = ${t}(s);`)}l.args.forEach((e,t)=>{let r="arg"+t;g&&(r=0==t?"argL":"arg"+(t-1)),k(m+`.${r} = ${N(e)};`)});let e=`s.pc = ${h}; return ${m};`;if(null!=u.callLocationIndex&&(e=`s.callLocIdx = ${u.callLocationIndex}; `+e),null!=u.ifaceIndex){$.U.assert(null==p);const x=b.ifaceMembers[u.ifaceIndex];$.U.assert(!!x,"no name for "+u.ifaceIndex),k(`if (!${m}.arg0.vtable.iface) {`);var c=l.args.map((e,t)=>m+".arg"+t);c.splice(1,0,JSON.stringify(x));const d=`pxsim_pxtrt.map${u.isSet?"Set":"Get"}ByString`;u.noArgs?k(`  s.retval = ${d}(${c.join(", ")});`):($.U.assert(!u.isSet),k(`  setupLambda(${m}, ${d}(${c.slice(0,2).join(", ")}), ${l.args.length});`),k("  "+e)),k("} else {"),k(`  ${m}.fn = ${m}.arg0.vtable.iface["${u.isSet?"set/":""}${x}"];`);c=m+`.arg0.fields["${x}"]`;u.isSet?(k(`  if (${m}.fn === null) { ${c} = ${m}.arg1; }`),k(`  else if (${m}.fn === undefined) { failedCast(${m}.arg0) } `)):u.noArgs?(k(`  if (${m}.fn == null) { s.retval = ${c}; }`),k(`  else if (!${m}.fn.isGetter) { s.retval = bind(${m}); }`)):(k(`  if (${m}.fn == null) { setupLambda(${m}, ${c}, ${l.args.length}); ${e} }`),k(`  else if (${m}.fn.isGetter) { ${m}.stage2Call = true; ${e}; }`)),k(` else { ${e} }`),k("}"),e=""}else if(-1==u.virtualIndex)$.U.assert(null==p),k(`setupLambda(${m}, ${m}.argL);`);else if(null!=u.virtualIndex){$.U.assert(null==p),$.assert(0<=u.virtualIndex),K(u.classInfo,"validate",m+".arg0");const l=u.classInfo.vtable[u.virtualIndex];k(m+`.fn = ${m}.arg0.vtable.methods.${l.getName()};`)}else $.U.assert(null!=p);e&&k(e),y(`  case ${h}:`),k("r0 = s.retval;"),d.currUses=1;return}case S.SharedDef:c=t;if(c=c.args[0],$.U.assert(1<=c.totalUses),$.U.assert(0===c.currUses),(c.currUses=1)==c.totalUses)return _(c);{const $=v.length;v.push(c);let e=N(c);"r0"!=e&&(e="r0 = "+e),k(`s.tmp_${$} = ${e};`)}return;case S.Sequence:return t.args.forEach(_);case S.InstanceOf:return _(t.args[0]),void K(t.data,t.jsInfo);default:k(`r0 = ${A(t)};`)}var u,p}function u(e,t="r0"){return`checkSubtype(${t}, ${e.id+"_VT"})`}function K(e,t,r="r0"){"bool"==t?k(`r0 = ${u(e)};`):"validate"==t?k(`if (!${u(e,r)}) failedCast(${r});`):$.U.oops()}function p(){for(var e of v)e.totalUses!==e.currUses&&$.oops();r=Math.max(v.length,r),v=[]}}(r,e),l+=t.length),n+="\n"+t+"\n"}),n+=$.U.values(r.codeHelpers).join("\n")+"\n",r.usedClassInfos.forEach(e=>{n+=function(e){$.U.assert(void 0!==e.classNo),$.U.assert(void 0!==e.lastSubtypeNo);let t=parseInt(e.attrs.maxBgInstances),r=(t=t||null,`const ${e.id}_VT = mkVTable({
  name: ${JSON.stringify($.getName(e.decl))},
  numFields: ${e.allfields.length},
  classNo: ${e.classNo},
  lastSubtypeNo: ${e.lastSubtypeNo},
  maxBgInstances: ${t},
  methods: {
`);for(var n of e.vtable)r+=`    "${n.getName()}": ${n.label()},
`;r+="  },\n  iface: {\n";for(var s of e.itable)r+=`    "${s.name}": ${s.proc?s.proc.label():"null"},
`,s.setProc?r+=`    "set/${s.name}": ${s.setProc.label()},
`:s.proc||(r+=`    "set/${s.name}": null,
`);return r+="  },\n",e.toStringMethod&&(r+="  toStringMethod: "+e.toStringMethod.label()+",\n"),r+="});\n"}(e)}),r.res.breakpoints&&(n+=`
const breakpoints = setupDebugger(${r.res.breakpoints.length}, [${r.globals.filter(e=>e.isUserVariable).map(e=>`"${e.uniqueName()}"`).join(",")}])
`);const c=(n+=`
return ${r.procs[0]?r.procs[0].label():"null"}
})
`).length,u=e=>(100*e/c).toFixed(2)+"%",p=`// total=${n.length} new=${u(l)} cached=${u(o)} other=${u(c-l-o)}
`;r.writeFile($.BINARY_JS,p+n)}}}(ts=ts||{}),function(e){{var c=e.pxtc||(e.pxtc={});c.thumbCmpMap={"numops::lt":"_cmp_lt","numops::gt":"_cmp_gt","numops::le":"_cmp_le","numops::ge":"_cmp_ge","numops::eq":"_cmp_eq","numops::eqq":"_cmp_eqq","numops::neq":"_cmp_neq","numops::neqq":"_cmp_neqq"};const s={"numops::adds":"_numops_adds","numops::subs":"_numops_subs","numops::orrs":"_numops_orrs","numops::eors":"_numops_eors","numops::ands":"_numops_ands","numops::lsls":"_numops_lsls","numops::asrs":"_numops_asrs","numops::lsrs":"_numops_lsrs","pxt::toInt":"_numops_toInt","pxt::fromInt":"_numops_fromInt"};class t extends c.AssemblerSnippets{stackAligned(){return c.target.stackAlign&&1<c.target.stackAlign}pushLR(){return this.stackAligned()?"push {lr, r5}  ; r5 for align":"push {lr}"}popPC(){return this.stackAligned()?"pop {pc, r5}  ; r5 for align":"pop {pc}"}nop(){return"nop"}mov(e,t){return`mov ${e}, `+t}helper_ret(){return"bx r4"}reg_gets_imm(e,t){return`movs ${e}, #`+t}push_fixed(e){return"push {"+e.join(", ")+"}"}pop_fixed(e){return"pop {"+e.join(", ")+"}"}proc_setup(t,e){let r="";if(0<t){r+="    movs r0, #0\n";for(let e=0;e<t;++e)r+="    push {r0} ;loc\n"}return r}proc_return(){return"pop {pc}"}debugger_stmt(e){return c.oops(),`
    @stackempty locals
    ldr r0, [r6, #0] ; debugger
    subs r0, r0, #4  ; debugger
${e}:
    ldr r0, [r0, #0] ; debugger
`}debugger_bkpt(e){return c.oops(),`
    @stackempty locals
    ldr r0, [r6, #0] ; brk
${e}:
    ldr r0, [r0, #0] ; brk
`}debugger_proc(e){return c.oops(),`
    ldr r0, [r6, #0]  ; brk-entry
    ldr r0, [r0, #4]  ; brk-entry
${e}:`}push_local(e){return`push {${e}}`}push_locals(e){return`sub sp, #4*${e} ; push locals ${e} (align)`}pop_locals(e){return`add sp, #4*${e} ; pop locals `+e}unconditional_branch(e){return"bb "+e}beq(e){return"beq "+e}bne(e){return"bne "+e}cmp(e,t){return"cmp "+e+", "+t}cmp_zero(e){return"cmp "+e+", #0"}load_reg_src_off(e,t,r,n,s,i){r=r.replace(/:\d+$/,""),n&&(r="#4*"+r);let a="str",o="ldr";return i&&(32==i.immLimit?a="strb":64==i.immLimit&&(a="strh"),o=i.needsSignExt?a.replace("str","ldrs"):a.replace("str","ldr")),s?a+` ${e}, [${t}, ${r}]`:o+` ${e}, [${t}, ${r}]`}rt_call(e,t,r){return e+" "+t+", "+r}alignedCall(e,t){return t?this.push_locals(t)+`
bl ${e}
`+this.pop_locals(t):"bl "+e}call_lbl(e,t,r){var n=c.U.lookup(s,e);return n&&(e=n,t=!1),(t=!t&&0<e.indexOf("::")?!0:t)?this.callCPP(e,r):this.alignedCall(e,r)}call_reg(e){return"blx "+e}helper_prologue(){return`
    @stackmark args
    ${this.pushLR()}
`}helper_epilogue(){return`
    ${this.popPC()}
    @stackempty args
`}load_ptr_full(e,t){return c.assert(!!e),`
    ldlit ${t}, ${e}
`}load_vtable(e,t){return`ldr ${e}, [${t}, #0]`}lambda_init(){return"\n    mov r5, r0\n    mov r4, lr\n    bl pxtrt::getGlobalsPtr\n    mov r6, r0\n    bx r4\n"}saveThreadStack(){return"mov r7, sp\n    str r7, [r6, #4]\n"}restoreThreadStack(){return c.target.switches.gcDebug?"movs r7, #0\n    str r7, [r6, #4]\n":""}callCPPPush(e){return this.pushLR()+"\n"+this.callCPP(e)+"\n"+this.popPC()+"\n"}callCPP(e,t){return this.saveThreadStack()+this.alignedCall(e,t)+"\n"+this.restoreThreadStack()}inline_decr(e){return`
    lsls r1, r0, #30
    bne .tag${e}
    bl _pxt_decr
.tag${e}:
`}arithmetic(){let t="";const r=e=>{var t=".boxed:\n";return t+=`
                    ${this.pushLR()}
                    push {r0, r1}
                    ${this.saveThreadStack()}
                    ${e}
                    ${this.restoreThreadStack()}
                    add sp, #8
                    ${this.popPC()}
                `},e=e=>{t+=`
_numops_${e}:
    @scope _numops_${e}
    lsls r2, r0, #31
    beq .boxed
    lsls r2, r1, #31
    beq .boxed
`},n=e=>{t=(t+="    blx lr\n")+r("bl numops::"+e)};for(var s of["adds","subs"])e(s),t+=`
    subs r2, r1, #1
    ${s} r2, r0, r2
    bvs .boxed
    movs r0, r2
`,n(s);for(var i of["ands","orrs","eors"])e(i),t+=`    ${i} r0, r1
`,"eors"==i&&(t+="    adds r0, r0, #1\n"),n(i);for(var a of["lsls","lsrs","asrs"])e(a),t+="\n    ; r3 := (r1 >> 1) & 0x1f\n    lsls r3, r1, #26\n    lsrs r3, r3, #27\n","asrs"==a?t+="\n    asrs r0, r3\n    movs r2, #1\n    orrs r0, r2\n":(t+="lsrs"==a?"\n    asrs r2, r0, #1\n    lsrs r2, r3\n    lsrs r3, r2, #30\n    bne .boxed\n":"\n    asrs r2, r0, #1\n    lsls r2, r3\n    lsrs r3, r2, #30\n    beq .ok\n    cmp r3, #3\n    bne .boxed\n.ok:\n",t+="\n    lsls r0, r2, #1\n    adds r0, r0, #1\n"),n(a);t+=`
@scope _numops_toInt
_numops_toInt:
    asrs r0, r0, #1
    bcc .over
    blx lr
.over:
    lsls r0, r0, #1
    ${this.callCPPPush("pxt::toInt")}

_numops_fromInt:
    lsls r2, r0, #1
    asrs r1, r2, #1
    cmp r0, r1
    bne .over2
    adds r0, r2, #1
    blx lr
.over2:
    ${this.callCPPPush("pxt::fromInt")}
`;for(var o of Object.keys(c.thumbCmpMap))o=o.replace(/.*::/,""),t+=`
.section code
_cmp_${o}:
    lsls r2, r0, #31
    beq .boxed
    lsls r2, r1, #31
    beq .boxed
    subs r0, r1
    b${o.replace("qq","q").replace("neq","ne")} .true
.false:
    movs r0, #0
    bx lr
.true:
    movs r0, #1
    bx lr
`,t+=r(`
                        bl numops::${o}
                        bl numops::toBoolDecr
                        cmp r0, #0`);return t}emit_int(e,r){let n=!1;function t(e){c.assert(0<=e&&e<=255);let t="";return n?e&&(t=`adds ${r}, #${e}
`):t=`movs ${r}, #${e}
`,n=!0,t}function s(e=8){return`lsls ${r}, ${r}, #${e}
`}c.assert(null!=e);let i=Math.floor(e),a=!1,o=(i<0&&(a=!0,i=-i),0);if(255<i){let e=i;for(;0==(1&e);)e>>>=1,o++;c.numBytes(e)<c.numBytes(i)?i=e:o=0}let l="";switch(c.numBytes(i)){case 4:l=(l+=t(i>>>24&255))+s();case 3:l=(l+=t(i>>>16&255))+s();case 2:l=(l+=t(i>>>8&255))+s();case 1:l+=t(255&i);break;default:c.oops()}return o&&(l+=s(o)),a&&(l+=`negs ${r}, ${r}
`),4<l.split("\n").length?`ldlit ${r}, ${Math.floor(e)}
`:l}}c.ThumbSnippets=t}}(ts=ts||{}),function(x){{var I=x.pxtc||(x.pxtc={}),e;const A={"pxtrt::mapSetGeneric":"mapset","pxtrt::mapGetGeneric":"mapget"},_={};function y(e,t,r){for(var n,s=I.computeHashMultiplier(e.itable.map(e=>e.idx)),i=I.U.toArray(s.mapping);3&i.length;)i.push(0);let a=`
${w(e)}_start:
        .short ${8*e.allfields.length+8}  ; size in bytes
        .byte ${pxt.ValTypeObject}, ${pxt.VTABLE_MAGIC} ; magic
        .short ${i.length} ; entries in iface hashmap
        .short ${e.lastSubtypeNo||e.classNo} ; last sub class-id
        .short ${e.classNo} ; class-id
        .short 0 ; reserved
        .word ${s.mult} ; hash-mult
`;E()?a+="\n            .word pxt::RefRecord_destroy\n            .word pxt::RefRecord_print\n            .word pxt::RefRecord_scan\n            .word pxt::RefRecord_gcsize\n            .word 0,0,0,0 ; keep in sync with VM_NUM_CPP_METHODS\n":a+="\n            .word 0,0, 0,0, 0,0, 0,0 ; space for 4 (VM_NUM_CPP_METHODS) native methods\n",a+=`
        .balign 4
${e.id}_IfaceVT:
`;const o=i.length>>2;let l="",c=o,u={};for(n of e.itable){u[n.idx+""]=c;const e=n.proc?n.proc.isGetter()?1:2:0;l=(l+=`  .short ${n.idx}, ${e} ; ${n.name}
`)+`  .word ${n.proc?n.proc.vtLabel()+"@fn":n.info}
`,c+=1,n.setProc&&(l=(l+=`  .short ${n.idx}, 2 ; set ${n.name}
`)+`  .word ${n.setProc.vtLabel()}@fn
`,c+=1)}l+="  .word 0, 0, 0, 0 ; the end\n",c+=1;for(let e=0;e<i.length;++e)r.itEntries++,i[e]&&r.itFullEntries++;return a=(a+="  .short "+I.U.toArray(i).map((e,t)=>u[e+""]||o).join(", ")+"\n")+l+"\n"}let g;function k(e){e=e.getTime()/1e3;return`${e>>>0}, `+(e/4294967296|0)}(e=g=g||{})[e.Invalid=0]="Invalid",e[e.InfoHeader=1]="InfoHeader",e[e.OpCodeMap=2]="OpCodeMap",e[e.NumberLiterals=3]="NumberLiterals",e[e.ConfigData=4]="ConfigData",e[e.IfaceMemberNames=5]="IfaceMemberNames",e[e.NumberBoxes=6]="NumberBoxes",e[e.Function=32]="Function",e[e.Literal=33]="Literal",e[e.VTable=34]="VTable";let b={};function w(e){return e.classNo||(b[e.id]=e),e.id+"_VT"}function E(){return I.target.useESP}function N(e){return E()?"0xffffffff, "+e:"0xffffffff, 0xffffffff ; -> "+e}I.vmEmit=function(o,t){let a=`; VM start
_img_start:
${I.hexfile.hexPrelude()}
`;b={};const c={dblText:[],dblBoxText:[],dbls:{},opcodeMap:{},opcodes:I.vm.opcodes.map(e=>"pxt::op_"+e.replace(/ .*/,""))};for(c.opcodes.unshift(null);c.opcodes.length<128;)c.opcodes.push(null);let l=0;function s(e,t,r,n,s=0){if(a+=`
; --- ${e}
.section code
    .set ${e} = ${l}
`,n)for(var i of n)a+=`    .set ${i} = ${l}
`;a=(a+=`
_start_${e}:
    .byte ${t}, 0x00
    .short ${s}
    .word _end_${e}-_start_${e}
`)+r()+`
.balign 8
_end_${e}:
`,l++}const e=new Date;let r=I.U.toUTF8(t.name,!0),n=(r=100<r.length?r.slice(0,100):r).length+1;1&n&&n++;const i=128-n;s("_info",g.InfoHeader,()=>`
                ; magic - \\0 added by assembler
                .string "\\nPXT64\\n"
                .hex 5471fe2b5e213768 ; magic
                .hex ${I.hexfile.hexTemplateHash()} ; hex template hash
                .hex 0000000000000000 ; @SRCHASH@
                .word ${o.globalsWords}   ; num. globals
                .word ${o.nonPtrGlobals} ; non-ptr globals
                .word 0, 0 ; last usage time
                .word ${k(e)} ; installation time
                .word ${k(e)} ; publication time - TODO
                .word _img_end-_img_start ; total image size
                .space 60 ; reserved
                .string ${JSON.stringify(r)}
                .space ${i} ; pad to 128 bytes
`),o.procs.forEach(n=>{s(n.label(),g.Function,()=>{{var h=c,g=o,i=n,e;let t="";const a=e=>{t+=e+"\n"},v=e=>{t+="    "+e+"\n"},T=I.ir.EK;let p=[],d=[],f=!1,s=0,m=0;const l=8388607;pxt.options.debug&&console.log("EMIT",i.toString()),r(),t="";for(e of p)e.reset();return f=!0,I.U.assert(0==m),r(),t;function r(){a(`;
; Proc: ${i.getFullName()}
;`),v(".section code"),g.procs[0]==i&&a("; main"),v(".word "+N("pxt::RefAction_vtable")),v(`.short 0, ${i.args.length} ; #args`),v(`.short ${i.captured.length}, 0 ; #cap`),v(".word .fnstart-_img_start, 0  ; func+possible padding"),s=i.locals.length+d.length,v(".fnstart:"),v(`pushmany ${s} ; incl. ${d.length} tmps`);for(var e of i.body)switch(e.stmtKind){case I.ir.SK.Expr:y(e.expr);break;case I.ir.SK.StackEmpty:S();for(var t of d)t&&I.oops(`uses: ${t.currUses}/${t.totalUses} `+t.toString());break;case I.ir.SK.Jmp:r=e,n=void 0,n=r.lbl.lblName,r.jmpMode==I.ir.JmpMode.Always?(r.expr&&y(r.expr),v("jmp "+n)):(y(r.expr),r.jmpMode==I.ir.JmpMode.IfNotZero?v("jmpnz "+n):r.jmpMode==I.ir.JmpMode.IfZero?v("jmpz "+n):I.oops());break;case I.ir.SK.Label:a(e.lblName+":");break;case I.ir.SK.Comment:a("; "+e.expr.data);break;case I.ir.SK.Breakpoint:break;default:I.oops()}var r,n;v(`ret ${i.args.length}, `+s)}function b(e){var t;return e.isGlobal()?(I.U.assert(0==(3&e.index)),"glb "+(e.index>>2)+" ; "+e.getName()):e.iscap?"cap "+e.index+" ; "+e.getName():e.isarg?(t=i.args.length-e.index-1,I.assert(0<=t,"arg#"+t),`loc ${m+s+2+t} ; `+e.getName()):(t=e.index+d.length,I.assert(!f||t<s,"cell#"+t),I.assert(0<=t,"cell#"+t),"loc "+(m+t))}function x(i){switch(i.exprKind){case T.NumberLiteral:var a=I.taggedSpecial(i.data);if(null!=a)v(`ldspecial ${a} ; `+i.data);else{let e=i.data,t=0,r=0;a=e<<1>>1!=e;if((0|e)==e){if(Math.abs(e)<=l)return void v(e<0?"ldintneg "+-e:"ldint "+e);t=(e<<1|1)>>>0,r=e<0?1:0}else{var o=new Float64Array(1),o=(o[0]=e,new Uint32Array(o.buffer));o[1]+=65536,t=o[0],r=o[1]}let n=t+","+r,s=I.U.lookup(h.dbls,n);if(null==s){if(s=h.dblText.length,h.dblText.push(`.word ${t}, ${r}  ; ${s}: `+i.data),a){const I="pxt::number_vt";h.dblBoxText.push(`.word ${E()?I:"0xffffffff ; "+I}
`);o=new Float64Array(1),a=(o[0]=e,new Uint32Array(o.buffer));h.dblBoxText.push(`.word ${a[0]}, ${a[1]} ; ${e}
`)}h.dbls[n]=s}v(`ldnumber ${s} ; `+i.data)}return;case T.PointerLiteral:return void v("ldlit "+i.data);case T.SharedRef:o=i.args[0],a=((!o.currUses||o.currUses>=o.totalUses)&&(console.log(o.sharingInfo()),I.U.assert(!1)),o.currUses++,d.indexOf(o));return a<0&&(console.log(d,o),I.assert(!1)),v("ldloc "+(a+m)+(o.currUses==o.totalUses?" ; LAST":"")),void S();case T.CellRef:return void v("ld"+b(i.data));case T.InstanceOf:y(i.args[0]),a=i.data,"bool"==i.jsInfo?v("checkinst "+w(a)):I.U.oops();break;default:throw I.oops("kind: "+i.exprKind)}}function y(t){switch(t.exprKind){case T.JmpValue:v("; jmp value (already in r0)");break;case T.Nop:v("; nop");break;case T.FieldAccess:var n=t.data;y(t.args[0]),v(`ldfld ${n.idx}, `+w(n.classInfo));break;case T.Store:var e=t.args[0],r=t.args[1];switch(e.exprKind){case T.CellRef:y(r);var s=e.data,i="st"+b(s);if(s.isGlobal()&&0!=s.bitSize){const e=I.sizeOfBitSize(s.bitSize)|(I.isBitSizeSigned(s.bitSize)?16:0);v("bitconv "+e)}v(i);break;case T.FieldAccess:s=e.data;y(e.args[0]),k(),y(r),v(`stfld ${s.idx}, `+w(s.classInfo)),m--;break;default:I.oops()}return;case T.RuntimeCall:var n=t,a=n.data;if("pxt::beginTry"==a)v("try "+n.args[0].data);else{a=I.U.lookup(_,a)||a,S();let e=I.U.lookup(A,a),t=n.args,r=0;if("pxt::mkClassInstance"!=a){for(let e=0;e<t.length;++e)y(t[e]),e<t.length-1&&(k(),r++);"langsupp::ignore"==a?r&&v(`popmany ${r} ; ignore`):e?v(e):function(e){var t=I.hexfile.lookupFunc(e),r=(t||I.U.oops("missing function: "+e),h.opcodeMap[t.name]);null==r&&(r=h.opcodes.length,h.opcodes.push(t.name),h.opcodeMap[t.name]=r,t.value=r),v("callrt "+e)}(a),m-=r}else v("newobj "+t[0].data)}return;case T.ProcCall:{a=t;var o=a.data,l=o.proc;if(l&&l.inlineBody){const I=l.inlineSelf(a.args);return pxt.options.debug&&console.log("INLINE",a.toString(),"->",I.toString()),y(I)}let e=0;var a=a.args.slice(),c=-1==o.virtualIndex?a.shift():null;for(var u of a)y(u),k(),e++;a=a.length;c?(y(c),v("callind "+a)):null!=o.ifaceIndex?(c=o.ifaceIndex+" ; ."+g.ifaceMembers[o.ifaceIndex],o.isSet?(v("callset "+c),I.U.assert(2==a)):o.noArgs?(v("callget "+c),I.U.assert(1==a)):v(`calliface ${a}, `+c)):null!=o.virtualIndex?I.U.oops():v("callproc "+l.label());m-=e;return}case T.SharedDef:c=t;if(c=c.args[0],I.U.assert(1<=c.totalUses),I.U.assert(0===c.currUses),c.currUses=1,p.push(c),1==c.totalUses)return y(c);{y(c);let t=-1;for(let e=0;e<d.length;++e)if(null==d[e]){t=e;break}t<0?(f&&(console.log(c,d),I.assert(!1,"missed tmp")),t=d.length,d.push(c)):d[t]=c,v("stloc "+(t+m))}return;case T.Sequence:return t.args.forEach(y);default:return x(t)}}function k(){v("push"),m++}function S(){for(let e=0;e<d.length;++e){var t=d[e];t&&t.currUses==t.totalUses&&(f||p.push(t),d[e]=null)}}}},[n.label()+"_Lit"])}),a+="_code_end:\n\n_helpers_end:\n\n",o.usedClassInfos.forEach(e=>{s(w(e),g.VTable,()=>y(e,0,o))}),I.U.values(b).forEach(e=>{e.itable=[],e.classNo=65520,s(w(e),g.VTable,()=>y(e,0,o))}),b={};let u=0;s("ifaceMemberNames",g.IfaceMemberNames,()=>`    .word ${o.ifaceMembers.length} ; num. entries
`+o.ifaceMembers.map(e=>`    .word ${o.emitString(e)}  ; ${u++} .`+e).join("\n")),a+="_vtables_end:\n\n",I.U.iterMap(o.hexlits,(e,t)=>{s(t,g.Literal,()=>`.word ${N("pxt::buffer_vt")}
`+I.hexLiteralAsm(e),[],pxt.BuiltInType.BoxedBuffer)}),I.U.unique(o.ifaceMembers.concat(Object.keys(o.strings)),e=>e).forEach(e=>{var t=I.utf8AsmStringLiteral(e);let r=pxt.BuiltInType.BoxedString;"pxt::string_inline_ascii_vt"==t.vt?r=pxt.BuiltInType.BoxedString_ASCII:"pxt::string_skiplist16_packed_vt"==t.vt?r=pxt.BuiltInType.BoxedString_SkipList:"pxt::string_inline_utf8_vt"==t.vt?r=pxt.BuiltInType.BoxedString:I.oops("invalid vt");const n=`.word ${N(t.vt)}
`+t.asm;s(o.strings[e],g.Literal,()=>n,[],r)}),s("numberBoxes",g.NumberBoxes,()=>c.dblBoxText.join("\n")+"\n.word 0, 0, 0 ; dummy entry to make sure not empty"),s("numberLiterals",g.NumberLiterals,()=>c.dblText.join("\n")+"\n.word 0, 0 ; dummy entry to make sure not empty");const p=o.res.configData||[];s("configData",g.ConfigData,()=>p.map(e=>`    .word ${e.key}, ${e.value}  ; ${e.name}=`+e.value).join("\n")+"\n    .word 0, 0");let d=c.opcodes.map(e=>null==e?"":e).join("\0")+"\0",f="";for(;d;){let e=d.slice(0,64);d=d.slice(64),1&e.length&&(e+="\0"),f+=".hex "+I.U.toHex(I.U.stringToUint8Array(e))+"\n"}s("opcodeMap",g.OpCodeMap,()=>f),a=(a+="_literals_end:\n")+"_img_end:\n\n; The end.\n",o.writeFile(I.BINARY_ASM,a);t=I.assemble(t.target,o,a);if(t.src&&o.writeFile(I.BINARY_ASM,t.src),pxt.options.debug){let r=t.thumbFile.peepCounts,e=Object.keys(r);e.sort((e,t)=>r[t]-r[e]);for(var m of e.slice(0,50))console.log(m+"  "+r[m])}if(t.buf){let e="";for(var h of t.buf)e+=String.fromCharCode(255&h,h>>8);if(e=x.pxtc.encodeBase64(e),E()){o.writeFile(I.BINARY_PXT64,e);const _=I.hexfile.patchHex(o,t.buf,!1,!!I.target.useUF2)[0];o.writeFile(pxt.outputName(I.target),x.pxtc.encodeBase64(_))}else o.writeFile(pxt.outputName(I.target),e)}}}}(ts=ts||{}),function(de){var fe=de.pxtc||(de.pxtc={});{var e,me=fe.decompiler||(fe.decompiler={});let ce,ue;(e=ce=me.DecompileParamKeys||(me.DecompileParamKeys={})).DecompileLiterals="decompileLiterals",e.TaggedTemplate="taggedTemplate",e.DecompileIndirectFixedInstances="decompileIndirectFixedInstances",e.DecompileArgumentAsString="decompileArgumentAsString",(e=ue=me.CommentKind||(me.CommentKind={}))[e.SingleLine=0]="SingleLine",e[e.MultiLine=1]="MultiLine",me.FILE_TOO_LARGE_CODE=9266,me.DECOMPILER_ERROR=9267;const Pe=de.SyntaxKind,c=/^[^\f\n\r\t\v\u00a0\u1680\u180e\u2000-\u200a\u2028\u2029\u202f\u205f\u3000\ufeff]*$/,_=/^(?:Array<(.+)>)|(?:(.+)\[\])$/,Le="math_number",Fe="math_number_minmax",Me="math_integer",De="math_whole_number",Oe="text",Be="logic_boolean",Re={"+":{type:"math_arithmetic",op:"ADD"},"-":{type:"math_arithmetic",op:"MINUS"},"/":{type:"math_arithmetic",op:"DIVIDE"},"*":{type:"math_arithmetic",op:"MULTIPLY"},"**":{type:"math_arithmetic",op:"POWER"},"%":{type:"math_modulo",leftName:"DIVIDEND",rightName:"DIVISOR"},"<":{type:"logic_compare",op:"LT"},"<=":{type:"logic_compare",op:"LTE"},">":{type:"logic_compare",op:"GT"},">=":{type:"logic_compare",op:"GTE"},"==":{type:"logic_compare",op:"EQ"},"===":{type:"logic_compare",op:"EQ"},"!=":{type:"logic_compare",op:"NEQ"},"!==":{type:"logic_compare",op:"NEQ"},"&&":{type:"logic_operation",op:"AND"},"||":{type:"logic_operation",op:"OR"}},u=/^\s*\/\/\s*(.*)$/,p=/^\s*(?:(?:(?:\/\*\*?)|(?:\*))(?!\/))?\s*(.*?)(?:\*?\*\/)?$/;class t{constructor(e){this.renames=e,this.renames.sort((e,t)=>e.span.start-t.span.start)}getRenamesInSpan(e,t){var r=[];for(const n of this.renames){if(n.span.start>t)break;n.span.start>=e&&r.push(n)}return r}getRenameForPosition(e){for(const t of this.renames){if(t.span.start>e)return;if(t.span.start===e)return t}}}function o(t,r,n=!0){if(1===t.length&&"x"!==t&&"y"!==t&&"z"!==t){var e=t.charCodeAt(0);if(97<=e&&e<=122){const t=e-97;for(let e=1;e<26;e++){var s=String.fromCharCode(97+(t+e)%26);if("x"!==s&&"y"!==s&&"z"!==s&&!r[s])return n&&(r[s]=!0),s}}}for(let e=2;;e++){var i=t+e;if(!r[i])return n&&(r[i]=!0),i}}let pe;function he(r,n,t=!1,s=!1){switch(r.kind){case Pe.WhileStatement:case Pe.IfStatement:case Pe.Block:return;case Pe.ExpressionStatement:return he(r.expression,n,t,s);case Pe.VariableStatement:var i=r,e=n;for(const T of i.declarationList.declarations){const i=v(T,e);if(i)return i}return;case Pe.CallExpression:{var[i,a,o=!1,l=!1]=[r,n,t,s];const I=fe.pxtInfo(i).callInfo;if(!I)return fe.Util.lf("Function call not supported in the blocks");const w=a.attrs(I);let e;if(de.isIdentifier(i.expression)&&(e=a.declaredFunctions[i.expression.text]),!o&&I.isExpression&&!e){if(!a.aliasBlocks[I.qName])return fe.Util.lf("No output expressions as statements");I.decompilerBlockAlias=a.aliasBlocks[I.qName]}if(!("Math.pow"==I.qName||pxt.Util.startsWith(I.qName,"Math.")&&_e(I.qName.substring(5)))){if(w.blockId===fe.PAUSE_UNTIL_TYPE){const de=i.arguments[0];return 1===i.arguments.length&&function(e){if(e.kind===Pe.FunctionExpression||e.kind===Pe.ArrowFunction){if(function(e){switch(e.kind){case Pe.BinaryExpression:var t=e.operatorToken.kind;return t!=Pe.PlusEqualsToken&&t!=Pe.MinusEqualsToken&&t!=Pe.EqualsToken;case Pe.PrefixUnaryExpression:t=e.operator;return t!=Pe.PlusPlusToken&&t!=Pe.MinusMinusToken;case Pe.PostfixUnaryExpression:t=e.operator;return t!=Pe.PlusPlusToken&&t!=Pe.MinusMinusToken;case Pe.CallExpression:t=fe.pxtInfo(e).callInfo;return fe.assert(!!t),t.isExpression;case Pe.ParenthesizedExpression:case Pe.NumericLiteral:case Pe.StringLiteral:case Pe.NoSubstitutionTemplateLiteral:case Pe.TrueKeyword:case Pe.FalseKeyword:case Pe.NullKeyword:case Pe.TaggedTemplateExpression:return 1;default:return}}(e.body))return 1;e=e.body;if(1===e.statements.length&&ve(e.statements[0]).kind===Pe.ReturnStatement)return 1}return}(de)?void 0:fe.Util.lf("Predicates must be inline expressions that return a value")}o=we(I,w);if(o&&!w.handlerStatement&&!l)return fe.Util.lf("Events must be top level");if(!w.blockId||!w.block){const de=pxt.blocks.builtinFunctionInfo[I.qName];if(!de)return e?e.parameters.length!==I.args.length?fe.Util.lf("Function calls in blocks must have the same number of arguments as the function definition"):void 0:fe.Util.lf("Call statements must have a valid declared function");w.blockId=de.blockId}var l=Ne(I,a.blocks),c=a.blocks.apis.byQName[I.qName],u=pxt.blocks.compileInfo(c),p=u.parameters.length+(u.thisParameter?1:0);if(w.imageLiteral){if(1<I.args.length-p)return fe.Util.lf("Function call has more arguments than are supported by its block");i=i.arguments[0];if(i.kind!=Pe.StringLiteral&&i.kind!=Pe.NoSubstitutionTemplateLiteral)return fe.Util.lf("Only string literals supported for image literals");const ce=(i.text||"").replace(/\s+/g,""),a=w.imageLiteralRows||5,o=(w.imageLiteralColumns||5)*w.imageLiteral,l=o*a;return o*a!=ce.length?fe.Util.lf("Invalid image pattern ({0} expected vs {1} actual)",l,ce.length):void 0}const E=I.args.length-p;if(0<E&&!function(){if(w.mutatePropertyEnum&&2===E&&2<=I.args.length){var e=I.args[I.args.length-2],t=I.args[I.args.length-1];if(e.kind===Pe.ArrayLiteralExpression&&N(t)){const r=[];if(!e.elements.some(e=>e.kind!==Pe.PropertyAccessExpression||e.expression.kind!==Pe.Identifier||(r.push(e.name.text),e.expression.text!==w.mutatePropertyEnum))){e=ye(t);if(e){const n=e[0];return n.length===r.length&&!r.some(e=>-1===n.indexOf(e))}}}}return}()){let e=E;if(o&&e--,w.defaultInstance&&e--,0<e)return fe.Util.lf("Function call has more arguments than are supported by its block")}if(u.parameters.length||o){let r;const fe=w.defaultInstance||!!u.thisParameter;if(l.forEach((e,t)=>{r||fe&&0===t||(fe&&t--,r=d(e))}),r)return r}if(c){const de=a.blocks.apis.byQName[c.namespace];if(de&&de.attributes.fixedInstances&&!de.attributes.decompileIndirectFixedInstances&&I.args.length){const de=fe.pxtInfo(I.args[0]).callInfo;if(!de||!a.attrs(de).fixedInstance)return fe.Util.lf("Fixed instance APIs can only be called directly from the fixed instance")}}function d(e){const t=ve(e.value),n=e.info,r=e.param;if(n.isEnum){if(s(t))return;if(t.kind===Pe.CallExpression){const e=fe.pxtInfo(t).callInfo,ce=a.attrs(e);if(e&&"TD_ID"===ce.shim&&e.args&&1===e.args.length&&s(ve(e.args[0])))return}else if(t.kind===Pe.Identifier){const e=fe.pxtInfo(t).commentAttrs;if(e&&e.enumIdentity)return}return fe.Util.lf("Enum arguments may only be literal property access expressions")}if(Ee(t)&&(r.fieldEditor||r.shadowBlockId)){let e=!(!r.fieldOptions||!r.fieldOptions[ce.DecompileLiterals]);if(!e&&r.shadowBlockId){const fe=a.blocks.blocksById[r.shadowBlockId];if(fe&&fe.parameters&&fe.parameters.length){const t=fe.parameters[0].name;e=!fe.attributes.paramFieldEditorOptions||!fe.attributes.paramFieldEditorOptions[t]||!!fe.attributes.paramFieldEditorOptions[t][ce.DecompileLiterals]}else e=!0}if(!e)return fe.Util.lf("Field editor does not support literal arguments")}else if(t.kind===Pe.TaggedTemplateExpression&&r.fieldEditor){e=r.fieldOptions&&r.fieldOptions[ce.TaggedTemplate];if(!e)return fe.Util.lf("Tagged templates only supported in custom fields with param.fieldOptions.taggedTemplate set");const a=ve(t.tag);if(a.kind!==Pe.Identifier)return fe.Util.lf("Tagged template literals must use an identifier as the tag");if(a.getText().trim()!=e.trim())return fe.Util.lf("Function only supports template literals with tag '{0}'",e);if(t.template.kind!==Pe.NoSubstitutionTemplateLiteral)return fe.Util.lf("Tagged template literals cannot have substitutions")}else if(t.kind===Pe.ArrowFunction){const e=t;if(e.parameters.length)if("objectdestructuring"===w.mutate){const t=ve(e.parameters[0]);if(t.kind===Pe.Parameter&&t.name.kind!==Pe.ObjectBindingPattern)return fe.Util.lf("Object destructuring mutation callbacks can only have destructuring patters as arguments")}else for(const t of e.parameters)if(t.name.kind!==Pe.Identifier)return fe.Util.lf("Only identifiers allowed as function arguments")}else if(a.blocks.apis.byQName[n.type]&&a.blocks.apis.byQName[n.type].attributes.fixedInstances){if(A(r))return;if(r.shadowBlockId){const e=a.blocks.blocksById[r.shadowBlockId];if(e){const fe=pxt.blocks.compileInfo(e);if(fe.parameters&&A(fe.parameters[0]))return}}const e=fe.pxtInfo(t).callInfo;return e&&a.attrs(e).fixedInstance?void 0:fe.Util.lf("Arguments of a fixed instance type must be a reference to a fixed instance declaration")}function s(e){for(var t=n.type.split("."),r=[];e.kind===Pe.PropertyAccessExpression;)r.unshift(e.name.text),e=e.expression;if(e.kind===Pe.Identifier){r.unshift(e.text);for(let e=0;e<t.length;e++)if(t[e]!==r[e])return;return 1}}}}return}case Pe.VariableDeclaration:return v(r,n);case Pe.PostfixUnaryExpression:case Pe.PrefixUnaryExpression:return(p=r).operand.kind!=Pe.Identifier?fe.Util.lf("-- and ++ may only be used on an identifier"):p.operator!==Pe.PlusPlusToken&&p.operator!==Pe.MinusMinusToken?fe.Util.lf("Only ++ and -- supported as prefix or postfix unary operators in a statement"):void 0;case Pe.FunctionExpression:case Pe.ArrowFunction:{o=r;u=n;let e=!1;if(o.parameters.length&&(l=Se(o)[0])&&fe.pxtInfo(l).callInfo&&(l=fe.pxtInfo(l).callInfo,e="objectdestructuring"===u.attrs(l).mutate?o.parameters[0].name.kind!==Pe.ObjectBindingPattern:o.parameters.some(e=>e.name.kind!==Pe.Identifier)),e)return fe.Util.lf("Unsupported parameters in error function");return}case Pe.BinaryExpression:var f=r,m=n;if(f.left.kind===Pe.ElementAccessExpression){if(f.operatorToken.kind!==Pe.EqualsToken)return fe.Util.lf("Element access expressions may only be assigned to using the equals operator")}else{if(f.left.kind===Pe.PropertyAccessExpression)return f.operatorToken.kind!==Pe.EqualsToken&&f.operatorToken.kind!==Pe.PlusEqualsToken?fe.Util.lf("Property access expressions may only be assigned to using the = and += operators"):ke(f.left,m);if(f.left.kind!==Pe.Identifier)return fe.Util.lf("This expression cannot be assigned to");switch(f.operatorToken.kind){case Pe.EqualsToken:return ke(f.right,m);case Pe.PlusEqualsToken:case Pe.MinusEqualsToken:return;default:return fe.Util.lf("Unsupported operator token in statement {0}",Pe[f.operatorToken.kind])}}return;case Pe.ForStatement:return(k=r).initializer&&k.incrementor&&k.condition?k.initializer.kind!==Pe.VariableDeclarationList?fe.Util.lf("only variable declarations are permitted in for loop initializers"):(c=k.initializer).declarations?1!=c.declarations.length?fe.Util.lf("for loop with multiple variables not supported"):(c=c.declarations[0]).initializer.kind!==Pe.NumericLiteral||"0"!==c.initializer.text?fe.Util.lf("for loop initializers must be initialized to 0"):function(e){if(k.incrementor.kind===Pe.PostfixUnaryExpression||k.incrementor.kind===Pe.PrefixUnaryExpression){var t=k.incrementor;if(t.operator===Pe.PlusPlusToken&&t.operand.kind===Pe.Identifier)return t.operand.text===e}return}(c=c.name.text)?k.condition.kind!==Pe.BinaryExpression?fe.Util.lf("for loop conditionals must be binary comparison operations"):(S=k.condition).left.kind!==Pe.Identifier||S.left.text!==c?fe.Util.lf("left side of for loop conditional must be the variable declared in the initializer"):S.operatorToken.kind!==Pe.LessThanToken&&S.operatorToken.kind!==Pe.LessThanEqualsToken?fe.Util.lf("for loop conditional operator must be either < or <="):void 0:fe.Util.lf("for loop incrementors may only increment the variable declared in the initializer"):fe.Util.lf("for loop with out-of-scope variables not supported"):fe.Util.lf("for loops must have an initializer, incrementor, and condition");case Pe.ForOfStatement:return r.initializer.kind!==Pe.VariableDeclarationList?fe.Util.lf("only variable declarations are permitted in for of loop initializers"):void 0;case Pe.FunctionDeclaration:var h,g,b=r,x=s;if(!x)return fe.Util.lf("Function declarations must be top level");if(0<b.parameters.length&&n.opts.allowedArgumentTypes)for(const x of b.parameters){if(x.initializer||x.questionToken)return fe.Util.lf("Function parameters cannot be optional");const b=x.type?x.type.getText():void 0;if(!b)return fe.Util.lf("Function parameters must declare a type");if(-1===n.opts.allowedArgumentTypes.indexOf((h=b,g=void 0,(g=_.exec(h))?`${g[1]||g[2]}[]`:h)))return fe.Util.lf("Only types that can be added in blocks can be used for function arguments")}return;case Pe.EnumDeclaration:{S=r;if(!s)return fe.Util.lf("Enum declarations must be top level");x=S.name.text;if(!n.blocks.enumsByName[x])return fe.Util.lf("Enum declarations in user code must have a block");let t=!1;return S.members.forEach(e=>{if(!(t=e.name.kind!==Pe.Identifier?!0:t)&&e.initializer&&e.initializer.kind!==Pe.NumericLiteral){if(e.initializer.kind===Pe.BinaryExpression){e=e.initializer;if(e.operatorToken.kind===Pe.LessThanLessThanToken&&e.left.kind===Pe.NumericLiteral&&e.right.kind===Pe.NumericLiteral&&"1"==e.left.text)return}t=!0}}),t?fe.Util.lf("Invalid initializer for enum member"):void 0;return}case Pe.ModuleDeclaration:return(y=ge(b=r,n))&&be(b)?y:void 0;case Pe.ReturnStatement:return function e(t){const r=de.getEnclosingBlockScopeContainer(t);if(r)switch(r.kind){case Pe.SourceFile:case Pe.ArrowFunction:case Pe.FunctionExpression:return!1;case Pe.FunctionDeclaration:return r.parent&&r.parent.kind===Pe.SourceFile&&!he(r,n,!1,!0);default:return e(r)}return!1}(r)?void 0:fe.Util.lf("Return statements can only be used within top-level function declarations");case Pe.BreakStatement:case Pe.ContinueStatement:case Pe.DebuggerStatement:case Pe.EmptyStatement:return}var y,k,S;return fe.Util.lf("Unsupported statement in block: {0}",Pe[r.kind]);function v(e,t){let r;return e.name.kind!==Pe.Identifier?r=fe.Util.lf("Variable declarations may not use binding patterns"):e.initializer?xe(e)||(r=ke(e.initializer,t)):r=fe.Util.lf("Variable declarations must have an initializer"),r}}function ge(e,t){if(!de.isModuleBlock(e.body))return fe.Util.lf("Namespaces cannot be nested.");var r=t.blocks.kindsByName[e.name.text];if(!r)return fe.Util.lf("Only namespaces with 'kind' blocks can be decompiled");var n=fe.Util.lf("Namespaces may only contain valid 'kind' exports");for(const fe of e.body.statements){if(function(e){e=de.getLeadingCommentRangesOfNode(e,e.getSourceFile());return e&&e.length}(fe))return n;if(!de.isVariableStatement(fe)||!fe.declarationList.declarations)return n;{const e=1===fe.declarationList.declarations.length,t=fe.modifiers&&1===fe.modifiers.length&&fe.modifiers[0].kind===Pe.ExportKeyword,s=fe.declarationList.flags&de.NodeFlags.Const;if(!(e&&t&&s))return n;{const e=fe.declarationList.declarations[0];if(!e.initializer||!de.isCallExpression(e.initializer)||!de.isIdentifier(e.name))return n;const t=e.initializer;if(t.arguments.length)return n;if(de.isPropertyAccessExpression(t.expression)&&de.isIdentifier(t.expression.expression)){if(t.expression.expression.text!==r.name||t.expression.name.text!==r.createFunctionName)return n}else{if(!de.isIdentifier(t.expression))return n;if(t.expression.text!==r.createFunctionName)return n}}}}}function be(e){if(!de.isModuleBlock(e.body))return fe.Util.lf("Namespaces cannot be nested.");if(e.name.text!==pxt.sprite.TILE_NAMESPACE)return fe.Util.lf("Tileset namespace must be named myTiles");const t=fe.Util.lf("The myTiles namespace can only export tile variables with image literal initializers and no duplicate ids"),r=fe.Util.lf("Tileset members must have a blockIdentity comment and no other annotations"),n=new RegExp(pxt.sprite.TILE_PREFIX+"(\\d+)"),s=[],i=/^\s*\/\/%\s*blockIdentity=[^\s]+\s*$/;for(const fe of e.body.statements){const e=de.getLeadingCommentRangesOfNode(fe,fe.getSourceFile());if(!e||!e.length)return r;{const de=e.map(e=>fe.getSourceFile().text.substr(e.pos,e.end-e.pos)).filter(e=>!!e);if(1!==de.length||!i.test(de[0]))return r}if(!de.isVariableStatement(fe)||!fe.declarationList.declarations)return t;{const e=1===fe.declarationList.declarations.length,r=fe.modifiers&&1===fe.modifiers.length&&fe.modifiers[0].kind===Pe.ExportKeyword,i=fe.declarationList.flags&de.NodeFlags.Const;if(!(e&&r&&i))return t;{const e=fe.declarationList.declarations[0];if(!e.initializer||!de.isTaggedTemplateExpression(e.initializer)||!de.isIdentifier(e.name))return t;const r=e.initializer;if(!de.isIdentifier(r.tag)||"img"!==r.tag.text)return t;const Pe=n.exec(e.name.text);if(!Pe||-1!==s.indexOf(Pe[1]))return t;s.push(Pe[1])}}}}function xe(e){if(e.initializer){if(e.initializer.kind===de.SyntaxKind.NullKeyword||e.initializer.kind===de.SyntaxKind.FalseKeyword||(t=e.initializer).kind===Pe.ArrayLiteralExpression&&0===t.elements.length)return 1;if(de.isStringOrNumericLiteral(e.initializer)){const de=e.initializer.getText();return"0"===de||Te(de)}{const de=fe.pxtInfo(e.initializer).callInfo;if(de&&de.isAutoCreate)return 1}}var t}function ye(e){if(1===e.parameters.length&&e.parameters[0].name.kind===Pe.ObjectBindingPattern){const r=e.parameters[0].name.elements,n={};return[r.map(e=>{if(t(e.propertyName)&&t(e.name)){const t=e.name.text;return e.propertyName?(e=e.propertyName.text,n[e]=t,e):t}return""}),n]}function t(e){return!e||e.kind===Pe.Identifier}}function ke(e,t){switch(e.kind){case Pe.NumericLiteral:case Pe.TrueKeyword:case Pe.FalseKeyword:case Pe.ExpressionStatement:case Pe.ArrayLiteralExpression:case Pe.ElementAccessExpression:return;case Pe.ParenthesizedExpression:return ke(e.expression,t);case Pe.StringLiteral:case Pe.FirstTemplateToken:case Pe.NoSubstitutionTemplateLiteral:return i=e.text,c.test(i)?void 0:fe.Util.lf("Only whitespace character allowed in string literals is space");case Pe.Identifier:i=fe.pxtInfo(e);return(a=e)&&a.kind===Pe.Identifier&&"undefined"===a.text?fe.Util.lf("Undefined is not supported in blocks"):!Ie(e)||i.commentAttrs&&i.commentAttrs.blockIdentity&&i.commentAttrs.enumIdentity?void 0:fe.Util.lf("Variable is declared in another file");case Pe.BinaryExpression:a=e.operatorToken.getText();return Re[a]?void 0:fe.Util.lf("Could not find operator {0}",a);case Pe.PrefixUnaryExpression:a=e.operator;return a===Pe.MinusToken||a===Pe.PlusToken||a===Pe.ExclamationToken?void 0:fe.Util.lf("Unsupported prefix unary operator{0}",a);case Pe.PropertyAccessExpression:{var n=e;a=t;const o=fe.pxtInfo(n).callInfo;if(o){var r=a.attrs(o),s=a.compInfo(o);if(r.blockIdentity||"lists_length"===r.blockId||"text_length"===r.blockId)return;if(o.decl.kind===Pe.EnumMember){if(n.expression.kind===Pe.Identifier){const de=n.expression.text;if(a.declaredEnums[de])return}const[de,o]=Se(n);let r=!0;if(de){const n=fe.pxtInfo(de).callInfo;if(n&&n.args){const de=a.blocks.apis.byQName[n.qName],fe=1==de.kind||2==de.kind;de&&n.args.forEach((e,t)=>{e===o&&de.parameters[fe?t-1:t].isEnum&&(r=!1)})}}return r?fe.Util.lf("Enum value without a corresponding block"):void 0}if(r.fixedInstance&&n.parent){if(n.parent.parent&&n.parent.kind===Pe.PropertyAccessExpression&&n.parent.parent.kind===Pe.CallExpression){if(n.parent.parent.expression===n.parent)return}else if(n.parent.kind===Pe.CallExpression&&n.parent.expression!==n)return}else{if(r.blockCombine||r.blockId&&s&&s.thisParameter)return ke(n.expression,a);if(de.isIdentifier(n.expression)&&a.declaredKinds[n.expression.text]){const de=n.name.text,fe=a.declaredKinds[n.expression.text];if(fe&&(-1!==fe.kindInfo.initialMembers.indexOf(de)||-1!==fe.declaredNames.indexOf(de)))return}}}return fe.Util.lf("No call info found");return}case Pe.CallExpression:return he(e,t,!0,void 0);case Pe.TaggedTemplateExpression:return r=t,(s=fe.pxtInfo(e).callInfo)?(s=r.attrs(s)).blockIdentity?(r=r.blocks.apis.byQName[s.blockIdentity])?1!==pxt.blocks.compileInfo(r).parameters.length?fe.Util.lf("Tagged template functions must have 1 argument"):void 0:fe.Util.lf("Could not find blockIdentity for tagged template"):fe.Util.lf("Tagged template does not have blockIdentity set"):fe.Util.lf("Invalid tagged template")}var i,a;return fe.Util.lf("Unsupported syntax kind for output expression block: {0}",Pe[e.kind])}function Se(e){return e.parent?e.parent.kind===Pe.ParenthesizedExpression?Se(e.parent):[e.parent,e]:[void 0,e]}function ve(e){for(;e.kind===Pe.ParenthesizedExpression;)e=e.expression;return e}function Te(e){return'""'===e||"''"===e||"``"===e}function Ie(e){return 4&fe.pxtInfo(e).flags}function we(e,t){return t.blockId!==fe.PAUSE_UNTIL_TYPE&&(e.decl.parameters,e.args.some((e,t)=>e&&N(e)))}function Ee(e){if(!e)return!1;switch(e.kind){case Pe.ParenthesizedExpression:return Ee(e.expression);case Pe.ArrayLiteralExpression:var t=e;for(const e of t.elements)if(!Ee(e)&&e.kind!==Pe.TaggedTemplateExpression)return!1;return!0;case Pe.NumericLiteral:case Pe.StringLiteral:case Pe.NoSubstitutionTemplateLiteral:case Pe.TrueKeyword:case Pe.FalseKeyword:return!0;case Pe.PrefixUnaryExpression:t=e;return(t.operator===Pe.PlusToken||t.operator===Pe.MinusToken)&&Ee(t.operand);default:return!1}}function N(e){return e.kind===Pe.ArrowFunction||e.kind===Pe.FunctionExpression}function Ne(r,e){var n=[],s=e.apis.byQName[r.qName];if(s){var e=e.apis.byQName[r.qName].attributes,i=pxt.blocks.compileInfo(s);pxt.blocks.builtinFunctionInfo[r.qName];let t=e.imageLiteral?1:0;i.thisParameter?n.push({value:ve(r.args[0]),info:null,param:i.thisParameter}):e.defaultInstance&&n.push({value:ve(r.args[0]),info:s.parameters[0],param:{definitionName:"__instance__",actualName:"this"}});var a=!(!i.thisParameter&&!e.defaultInstance);a&&t++;for(let e=t;e<r.args.length;e++)n.push({value:ve(r.args[e]),info:s.parameters[a?e-1:e],param:i.parameters[e-t]})}return n}function Ae(e){return e.body.statements.map(e=>{e=e.declarationList.declarations[0];return{name:e.name.text,initializer:e.initializer.getText()}})}function A(e){return e&&e.fieldOptions&&e.fieldOptions[ce.DecompileIndirectFixedInstances]}function _e(e){return Ke(e)||$e(e)||Ce(e)||-1!==pxt.blocks.MATH_FUNCTIONS.binary.indexOf(e)}function Ke(e){return-1!==pxt.blocks.MATH_FUNCTIONS.unary.indexOf(e)}function $e(e){return-1!==pxt.blocks.MATH_FUNCTIONS.infix.indexOf(e)}function Ce(e){return-1!==pxt.blocks.ROUNDING_FUNCTIONS.indexOf(e)}function l(t,r,n=!1){var s=[],i=t.getFullText();if(r&&r.length)for(const a of r){const r=de.getLineOfLocalPosition(t,a.end),o=de.getStartPositionOfLine(r+1,t)||i.length,l=de.getStartPositionOfLine(r+2,t)||i.length,c=!n&&!i.substr(o,l-o).trim();let e=i.substr(a.pos,a.end-a.pos);if(e=e&&e.replace(/\r\n/g,"\n"),a.kind===de.SyntaxKind.SingleLineCommentTrivia){const de=u.exec(e);de?s.push({kind:ue.SingleLine,text:de[1],start:a.pos,end:a.end,hasTrailingNewline:!!a.hasTrailingNewLine,followedByEmptyLine:c,isTrailingComment:n}):s.push({kind:ue.SingleLine,text:"",start:a.pos,end:a.end,hasTrailingNewline:!!a.hasTrailingNewLine,followedByEmptyLine:c,isTrailingComment:n})}else{const de=e.split("\n").map(e=>{e=p.exec(e);return e?e[1]:""});s.push({kind:ue.MultiLine,lines:de,start:a.pos,end:a.end,hasTrailingNewline:!!a.hasTrailingNewLine,followedByEmptyLine:c,isTrailingComment:n})}}return s}function qe(e){let t="";for(const r of e)if(r.kind===ue.SingleLine){if(r.text===fe.ON_START_COMMENT||r.text===fe.HANDLER_COMMENT)continue;t+=r.text.trim()+"\n"}else for(const e of r.lines)t+=e.trim()+"\n";return t.trim()}function je(e){var t=e.getFullText(),r=de.createScanner(e.languageVersion,!1,e.languageVariant,t,void 0,e.getFullStart());let n,s,i=[];for(;r.getTextPos()<e.end;){var a=r.scan();if(a===Pe.SingleLineCommentTrivia||a===Pe.MultiLineCommentTrivia){n=de.getLeadingCommentRanges(t,r.getTokenPos())||[],s=(s=de.getTrailingCommentRanges(t,r.getTokenPos())||[]).filter(t=>!n.some(e=>e.pos===t.pos)),i.push(...l(e,n,!1)),i.push(...l(e,s,!0));for(const de of i)de.end>r.getTextPos()&&r.setTextPos(de.end)}}return i.sort((e,t)=>e.start-t.start),i}function Ue(t,r){var n;for(let e=0;e<r.length;e++)!(n=r[e]).owner&&n.start>=t.pos&&n.end<=t.end&&(n.owner=t)}me.RenameMap=t,me.buildRenameMap=function(e,r,{declarations:n,takenNames:s}={declarations:"variables",takenNames:{}}){let i=de.createLanguageService(new fe.LSHost(e));const a=[];(function t(e){de.forEachChild(e,e=>{if(de.isDeclarationName(e)&&("all"===n||de.isVariableDeclaration(e.parent))){const de=e.getText();if(s[de]){const t=o(de,s),n=i.findRenameLocations(r.fileName,e.pos+1,!1,!1);n&&n.forEach(e=>{a.push({name:t,diff:t.length-de.length,span:e.textSpan})})}else s[de]=!0}t(e)})})(r);e=s;return[new t(a),e]},me.getNewName=o,(e=pe=pe||{})[e.None=0]="None",e[e.InBlocksOnly=1]="InBlocksOnly",e[e.InTextBlocks=2]="InTextBlocks",me.decompileToBlocks=function(S,g,a,r){let d=0,e=g.statements;const n={blocksInfo:S,outfiles:{},diagnostics:[],success:!0,times:{}},v=(a.generateSourceMap&&(n.blockSourceMap=[]),{blocks:S,declaredFunctions:{},declaredEnums:{},declaredKinds:{},functionParamIds:{},attrs:I,compInfo:function(e){e=S.apis.byQName[e.qName];if(e)return pxt.blocks.compileInfo(e)},localReporters:[],tileset:[],opts:a||{},aliasBlocks:{}});g.getFullText();let m="";const s=[],o={},b=[],O=[],B=(()=>{let e=0;return()=>""+e++})(),t=S.apis.byQName,x=(Object.keys(t).forEach(e=>{e=t[e];e.attributes.blockAliasFor&&t[e.attributes.blockAliasFor]&&(v.aliasBlocks[e.attributes.blockAliasFor]=e.qName)}),je(g)),h=e=>{if(e.kind!==Pe.FunctionDeclaration||he(e,v,!1,!0))if(e.kind!==Pe.EnumDeclaration||he(e,v,!1,!0))if(de.isModuleDeclaration(e))if(ge(e,v))be(e)||(v.tileset=Ae(e).map(({name:e,initializer:t})=>({projectId:parseInt(e.substr(pxt.sprite.TILE_PREFIX.length)),data:pxt.sprite.imageLiteralToBitmap(t).data()})));else{const de=e.name.text,fe=Ae(e);v.declaredKinds[de]&&v.declaredKinds[de].declaredNames.push(...fe.map(({name:e})=>e))}else e.kind===Pe.Block&&de.forEachChild(e,h);else{const de=e.name.text;v.declaredEnums[de]=!0,function(){const n=[];return e.members.forEach(e=>{fe.U.assert(e.name.kind===Pe.Identifier);var t=e.name.text;let r;if(e.initializer)if(e.initializer.kind===Pe.NumericLiteral)r=parseInt(e.initializer.text);else{const n=e.initializer;fe.U.assert(n.left.kind===Pe.NumericLiteral),fe.U.assert("1"===n.left.text),fe.U.assert(n.operatorToken.kind===Pe.LessThanLessThanToken),fe.U.assert(n.right.kind===Pe.NumericLiteral),r=1<<parseInt(n.right.text)}else r=0===n.length?0:n[n.length-1][1]+1;n.push([t,r])}),n}().forEach(([e,t])=>{s.push({name:t+e,type:de})})}else v.declaredFunctions[D(e.name)]=e},R=(Object.keys(S.kindsByName).forEach(e=>{var t=S.kindsByName[e];v.declaredKinds[e]={kindInfo:t,declaredNames:[]}}),de.forEachChild(g,h),()=>(Math.PI*Math.random()).toString(36).slice(2));let i;Object.keys(v.declaredFunctions).forEach(t=>{v.functionParamIds[t]={},v.declaredFunctions[t].parameters.forEach(e=>{v.functionParamIds[t][e.name.getText()]=R()+R()})}),Object.keys(v.declaredKinds).forEach(e=>{const t="KIND_"+e;v.declaredKinds[e].declaredNames.forEach(e=>s.push({name:e,type:t}))}),(s.length||v.tileset.length)&&(l("<variables>"),s.forEach(e=>{l(`<variable type="${fe.U.htmlEscape(e.type)}">${fe.U.htmlEscape(e.name)}</variable>`)}),v.tileset.forEach(e=>{l(`<variable type="${pxt.sprite.BLOCKLY_TILESET_TYPE}">${pxt.sprite.legacy.tileToBlocklyVariable(e)}</variable>`)}),l("</variables>"));try{i=ae(e,void 0,!0,void 0,!a.snippetMode);for(const de of x)de.owner||b.push({refId:B(),comment:[de]})}catch(e){if(!e.programTooLarge)return pxt.reportException(e),n.success=!1,n.diagnostics=fe.patchUpDiagnostics([{file:g,start:g.getFullStart(),length:g.getFullWidth(),messageText:e.message,category:de.DiagnosticCategory.Error,code:me.DECOMPILER_ERROR}]),n;n.success=!1,n.diagnostics=fe.patchUpDiagnostics([{file:g,start:g.getFullStart(),length:g.getFullWidth(),messageText:e.message,category:de.DiagnosticCategory.Error,code:me.FILE_TOO_LARGE_CODE}])}return i?c(i):a.snippetMode||e.length||(u(de.pxtc.ON_START_TYPE,w(de.pxtc.ON_START_TYPE,e[0])),p()),b.forEach(e=>{{let t=0;var r,n,s=qe(e.comment);s.trim()&&((r=s.split("\n")).forEach(e=>t=Math.max(t,e.length)),n=Math.max(Math.min(10*t,480),160),l(`<comment h="${Math.max(Math.min(40*r.length,360),120)}" w="${n}" data="${fe.U.htmlEscape(e.refId)}">`),l(fe.U.htmlEscape(s)),l("</comment>"))}}),n.outfiles[g.fileName.replace(/(\.blocks)?\.\w*$/i,"")+".blocks"]=`<xml xmlns="http://www.w3.org/1999/xhtml">
${m}</xml>`,n;function l(e,t="\n"){m+=e+t}function T(e,t){t=t||`Language feature "${e.getFullText().trim()}"" not supported in blocks`,e=fe.patchUpDiagnostics([{file:g,start:e.getFullStart(),length:e.getFullWidth(),messageText:t,category:de.DiagnosticCategory.Error,code:1001}]);pxt.debug("decompilation error: "+t),fe.U.pushRange(n.diagnostics,e),n.success=!1}function I(e){const t=S.apis.byQName[e.decompilerBlockAlias||e.qName];if(t){const e=t.attributes;if(!e.blockId||S.blocksById[e.blockId]||e.blockId===fe.PAUSE_UNTIL_TYPE)return t.attributes}else if(e.decl){const t=fe.parseComments(e.decl);if(t)return t}return{paramDefl:{},callingConvention:0}}function q(){var e;if(1500<++d)throw(e=new Error(fe.Util.lf("Could not decompile because the script is too large"))).programTooLarge=!0,e}function w(e,t){var r={kind:"statement",type:e};return n.blockSourceMap&&(r.id=function(e,t){if(e==de.pxtc.ON_START_TYPE)return"xRRgvHNlG#rZ^u`HECiY";if(e=function(){var t="!#$%()*+,-./:;=?@[]^_`{|}~ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",r=t.length,n=[];for(let e=0;e<20;e++)n[e]=t.charAt(Math.random()*r);return n.join("")}(),t){const de=t.getFullStart();n.blockSourceMap.push({id:e,startPos:de,endPos:de+t.getFullWidth()})}return e}(e,t)),r}function E(e){return{kind:"expr",type:e}}function N(e,t,r,n){return{kind:"value",name:e,value:t,shadowType:r=(!r||r===Le)&&n&&n.min&&n.max?Fe:r,shadowMutation:n}}function c(e){e&&(u(e.type,e),z(e),void 0!==e.data&&l(`<data>${fe.U.htmlEscape(e.data)}</data>`),e.handlers&&e.handlers.forEach(H),e.next&&(l("<next>"),c(e.next),l("</next>")),void 0!==e.comment&&l(`<comment pinned="false">${fe.U.htmlEscape(qe(e.comment))}</comment>`),p())}function j(t,e){l("<mutation ",""),Object.keys(t).forEach(e=>{void 0!==t[e]&&l(`${e}="${t[e]}" `,"")}),e?(l(">"),e.forEach(t=>{l(`<${t.nodeName} `,""),Object.keys(t.attributes).forEach(e=>{l(`${e}="${t.attributes[e]}" `,"")}),l("/>")}),l("</mutation>")):l("/>")}function z(e){e.mutation&&j(e.mutation,e.mutationChildren),e.fields&&e.fields.forEach(G),e.inputs&&e.inputs.forEach(V)}function V(e){l(`<value name="${e.name}">`);let t=!1;if("expr"===e.value.kind){var r=e.value;if(r.type===Le&&e.shadowType===Fe&&(r.type=Fe,r.fields[0].name="SLIDER",r.mutation=e.shadowMutation),!(t=r.type===e.shadowType))switch(r.type){case"math_number":case"math_number_minmax":case"math_integer":case"math_whole_number":case"logic_boolean":case"text":t=!e.shadowType}}if(t)J(e.value,!0);else{if(void 0!==e.shadowType)switch(e.shadowType){case Le:case Me:case De:l(`<shadow type="${e.shadowType}"><field name="NUM">0</field></shadow>`);break;case Fe:l('<shadow type="math_number_minmax">'),e.shadowMutation&&j(e.shadowMutation),l('<field name="SLIDER">0</field></shadow>');break;case Be:l('<shadow type="logic_boolean"><field name="BOOL">TRUE</field></shadow>');break;case Oe:l('<shadow type="text"><field name="TEXT"></field></shadow>');break;default:l(`<shadow type="${e.shadowType}"/>`)}J(e.value)}l("</value>")}function G(e){l(`<field name="${fe.U.htmlEscape(e.name)}">${fe.U.htmlEscape(e.value.toString())}</field>`)}function H(e){l(`<statement name="${fe.U.htmlEscape(e.name)}">`),c(e.statement),l("</statement>")}function J(e,t=!1){var r;"text"===e.kind?l(e.value):(e=e,r=(t=t||e.isShadow)?"shadow":"block",t||q(),l(`<${r} ${e.id?`id="${e.id}" `:""}type="${fe.U.htmlEscape(e.type)}">`),z(e),l(`</${r}>`))}function u(e,t){q(),l(`<block ${t&&t.id?`id="${t.id}" `:""}type="${fe.U.htmlEscape(e)}">`)}function p(){l("</block>")}function A(n){if(ke(n,v))return W(n);switch(n.kind){case Pe.ExpressionStatement:case Pe.ParenthesizedExpression:return A(n.expression);case Pe.Identifier:{var s=n;if(Ie(s)){const p=fe.pxtInfo(s);return te(S.apis.byQName[p.commentAttrs.blockIdentity],p.commentAttrs.enumIdentity)}const p=D(s),d=s.text;let r=null;return v.localReporters.some(t=>{for(let e=0;e<t.length;++e)if(t[e].name===d)return r=t[e],!0;return!1}),r?X(p,r.type,!1):(M(p,pe.InBlocksOnly),$("variables_get","VAR",p));return}case Pe.StringLiteral:case Pe.FirstTemplateToken:case Pe.NoSubstitutionTemplateLiteral:return Z(n.text);case Pe.NumericLiteral:return K(n.text);case Pe.TrueKeyword:return f(!0);case Pe.FalseKeyword:return f(!1);case Pe.BinaryExpression:{s=n;var r=s.operatorToken.getText(),i=Re[r];if(y(s))return Y(s);var a=i.leftName||"A",o=i.rightName||"B";let e,t;t="&&"===r||"||"===r?(e=k(a,s.left),k(o,s.right)):(e=_(a,s.left,Le),_(o,s.right,Le));r=E(i.type);return r.fields=[],i.op&&r.fields.push(U("OP",i.op)),r.inputs=[e,t],r;return}case Pe.PrefixUnaryExpression:var e=n;switch(e.operator){case Pe.ExclamationToken:var t=E("logic_negate");return t.inputs=[k("BOOL",e.operand)],t;case Pe.PlusToken:return A(e.operand);case Pe.MinusToken:return e.operand.kind==Pe.NumericLiteral?K("-"+e.operand.text):ee(e.operand);default:T(e)}return;case Pe.PropertyAccessExpression:return P(n);case Pe.ArrayLiteralExpression:return a=n,(o=E("lists_create_with")).inputs=a.elements.map((e,t)=>_("ADD"+t,e)),o.mutation={items:a.elements.length.toString()},o;case Pe.ElementAccessExpression:return i=n,(r=E("lists_index_get")).inputs=[_("LIST",i.expression),_("INDEX",i.argumentExpression,Le)],r;case Pe.TaggedTemplateExpression:{var l=n;var c=fe.pxtInfo(l).callInfo;let e;var u=function(e){if(e.parent&&e.parent.kind===Pe.CallExpression){var t=e.parent,r=fe.pxtInfo(t).callInfo,t=t.arguments.indexOf(e);if(r&&-1!==t){const e=S.apis.byQName[r.qName];if(e){const fe=pxt.blocks.compileInfo(e);return fe&&fe.parameters[t]}}}}(l);if(u&&u.shadowBlockId){const l=v.blocks.blocksById[u.shadowBlockId];l&&"TD_ID"===l.attributes.shim&&(e=l)}e=e||v.blocks.apis.byQName[I(c).blockIdentity];u=pxt.blocks.compileInfo(e),c=E(e.attributes.blockId),u=u.parameters[0],l=u.fieldOptions&&u.fieldOptions[ce.DecompileArgumentAsString]?l.getText():l.template.text;return c.fields=[U(u.actualName,l)],c;return}case Pe.CallExpression:return L(n,void 0,void 0,!0);default:T(n,fe.Util.lf("Unsupported syntax kind for output expression block: {0}",Pe[n.kind]))}}function Q(s,i,e){if(r){e=r.getRenamesInSpan(i,e);if(e.length){let n=0;e.forEach(e=>{var t=e.span.start+n-i,r=t+e.span.length;n+=e.diff,s=s.slice(0,t)+e.name+s.slice(r)})}}return s}function W(e){var t=Q(e.getFullText(),e.getFullStart(),e.getEnd()).trim();return le(e),Ue(e,x),$(fe.TS_OUTPUT_TYPE,"EXPRESSION",t)}function y(e){if(e.kind===Pe.BinaryExpression){var t=e;if("+"===t.operatorToken.getText()||t.operatorToken.kind==Pe.PlusEqualsToken)return fe.pxtInfo(e).exprInfo}}function Y(e){var t=[],r=(!function e(t,r){y(t)?(e(t.left,r),e(t.right,r)):r.push(t)}(e,t),[]);for(let e=0;e<t.length;e++)(0<e||!Te(t[e].getText()))&&r.push(_("ADD"+r.length,t[e],Oe));e=E("text_join");return e.inputs=r,e.mutation={items:r.length.toString()},e}function _(e,t,r,n){t="number"==typeof t?K(t.toString()):("boolean"==typeof t?f:"string"==typeof t?Z:A)(t);if("expr"==t.kind&&"math_number"==t.type){const e=t.fields[0].value;"math_integer"==r&&e%1==0&&(t.type="math_integer"),"math_whole_number"==r&&e%1==0&&0<e&&(t.type="math_whole_number")}return N(e,t,r,n)}function K(e){return $("math_number","NUM",e)}function Z(e){return $("text","TEXT",e)}function f(e){return $("logic_boolean","BOOL",e?"TRUE":"FALSE")}function $(e,t,r,n){e=E(e);return e.fields=[U(t,r)],e.isShadow=n,e}function C(e,t){return N(e,$("variables_get_reporter","VAR",t,!0),"variables_get_reporter")}function X(e,t,r){var n=pxt.blocks.reporterTypeForArgType(t),e=$(n,"VALUE",e,r);return"argument_reporter_custom"===n&&(e.mutation={typename:t}),e}function U(e,t){return{kind:"field",name:e,value:t}}function ee(e){var t=E("math_arithmetic");return t.inputs=[_("A",0,Le),_("B",e,Le)],t.fields=[U("OP","MINUS")],t}function P(t,r=!1,n){var s=fe.pxtInfo(t).callInfo;if(s){if(t.expression.kind===Pe.Identifier){const fe=t.expression.text;if(v.declaredEnums[fe]){const r=S.enumsByName[fe];if(r&&r.blockId)return $(r.blockId,"MEMBER",t.name.text)}else if(v.declaredKinds[fe])return $(v.declaredKinds[fe].kindInfo.blockId,"MEMBER",t.name.text)}var i=I(s);if(n=i.blockId||n,i.blockCombine)return se(t,t,null,"@get@");if("lists_length"===i.blockId||"text_length"===i.blockId){const r=E(fe.U.htmlEscape(i.blockId));return r.inputs=[_("VALUE",t.expression)],r}let e=fe.U.htmlEscape(i.blockId||s.qName);var[a]=Se(t),a=a&&fe.pxtInfo(a).callInfo;if(r||!n&&!i.blockIdentity||a&&a.qName===i.blockIdentity)return{kind:"text",value:e};i.enumval&&a&&i.useEnumVal&&(e=i.enumval);a=v.compInfo(s);if(n&&a&&a.thisParameter){const r=E(n);return r.inputs=[_(fe.U.htmlEscape(a.thisParameter.definitionName),t.expression,a.thisParameter.shadowBlockId)],r}return te(i.blockIdentity?S.apis.byQName[i.blockIdentity]:S.blocksById[n],e)}T(t)}function te(e,t){var r=/(?:%|\$)([a-zA-Z0-9_]+)/.exec(e.attributes.block),e=E(fe.U.htmlEscape(e.attributes.blockId));return e.fields=[{kind:"field",name:fe.U.htmlEscape(r[1]),value:t}],e}function L(e,t,r,n=!1,s=!1){var a=e;let o,i=!1;var l,c,u,p,d,e=he(a,v,n,s);if(e)o=re(a,void 0,e);else switch(a.kind){case Pe.Block:return ae(a.statements,t,s);case Pe.ExpressionStatement:return L(a.expression,t,r||a,n,s);case Pe.VariableStatement:if(!(o=ae(a.declarationList.declarations,void 0,!1,r||a)))return m();i=!0;break;case Pe.FunctionExpression:case Pe.ArrowFunction:return L(a.body,t);case Pe.BinaryExpression:o=function(e){switch(e.left.text,e.operatorToken.kind){case Pe.EqualsToken:return e.left.kind===Pe.Identifier?F(e,e.left,e.right):e.left.kind==Pe.PropertyAccessExpression?ne(e,e.left,e.right,"@set@"):(t=e.left,r=e.right,(n=w("lists_index_set",e)).inputs=[_("LIST",t.expression),_("INDEX",t.argumentExpression,Le),_("VALUE",r)],n);case Pe.PlusEqualsToken:if(y(e)){const fe=w("variables_set",e),s=D(e.left);return M(s,pe.InBlocksOnly),fe.inputs=[N("VALUE",Y(e),Le)],fe.fields=[U("VAR",s)],fe}return e.left.kind==Pe.PropertyAccessExpression?ne(e,e.left,e.right,"@change@"):F(e,e.left,e.right,!0);case Pe.MinusEqualsToken:t=w("variables_change",e);return t.inputs=[N("VALUE",ee(e.right),Le)],t.fields=[U("VAR",D(e.left))],t;default:return void T(e,fe.Util.lf("Unsupported operator token in statement {0}",Pe[e.operatorToken.kind]))}var t,r,n}(a);break;case Pe.PostfixUnaryExpression:case Pe.PrefixUnaryExpression:o=(d=(p=a).operator===Pe.PlusPlusToken)||p.operator===Pe.MinusMinusToken?F(p,p.operand,d?1:-1,!0):void T(p);break;case Pe.VariableDeclaration:const e=a;if(xe(e))return d=e,O.push([D(d.name),d]),m();o=function(e){if((t=e).name.kind!==Pe.Identifier?(T(t,fe.Util.lf("Variable declarations may not use binding patterns")),0):t.initializer||(T(t,fe.Util.lf("Variable declarations must have an initializer")),0))return F(e,e.name,e.initializer);var t}(a);break;case Pe.WhileStatement:o=((u=w("device_while",p=a)).inputs=[k("COND",p.expression)],u.handlers=[{name:"DO",statement:L(p.statement)}],u);break;case Pe.IfStatement:o=function(e){var t=function t(r){let n={ifStatements:[{expression:r.expression,thenStatement:r.thenStatement}],elseStatement:r.elseStatement};if(r.elseStatement&&r.elseStatement.kind==Pe.IfStatement){let e=t(r.elseStatement);n.ifStatements=n.ifStatements.concat(e.ifStatements),n.elseStatement=e.elseStatement}return n}(e);const n=w("controls_if",e);return n.mutation={elseif:(t.ifStatements.length-1).toString(),else:t.elseStatement?"1":"0"},n.inputs=[],n.handlers=[],t.ifStatements.forEach((e,t)=>{var r=L(e.thenStatement);n.inputs.push(k("IF"+t,e.expression)),n.handlers.push({name:"DO"+t,statement:r})}),t.elseStatement&&(e=L(t.elseStatement),n.handlers.push({name:"ELSE",statement:e})),n}(a);break;case Pe.ForStatement:o=function(e){const t=e.initializer,r=(t.declarations[0].name.text,e.condition),n=D(t.declarations[0].name);let s;if(r.operatorToken.kind!==Pe.LessThanToken||function e(t){return t.kind===Pe.Identifier&&D(t)===n||de.forEachChild(t,e)}(e.statement))if((s=w("pxt_controls_for",e)).fields=[],s.inputs=[],s.handlers=[],s.inputs=[C("VAR",n)],r.operatorToken.kind===Pe.LessThanToken){const de=ve(r.right);if(de.kind===Pe.NumericLiteral){const e=K(parseFloat(de.text)-1+"");s.inputs.push(N("TO",e,De))}else{const e=E("math_arithmetic");e.fields=[U("OP","MINUS")],e.inputs=[_("A",de,Le),_("B",1,Le)],s.inputs.push(N("TO",e,De))}}else r.operatorToken.kind===Pe.LessThanEqualsToken&&s.inputs.push(_("TO",r.right,De));else(s=w("controls_repeat_ext",e)).fields=[],s.inputs=[_("TIMES",r.right,De)],s.handlers=[];e=L(e.statement);return s.handlers=[{name:"DO",statement:e}],s}(a);break;case Pe.ForOfStatement:o=(l=D((u=a).initializer.declarations[0].name),(c=w("pxt_controls_for_of",u)).inputs=[_("LIST",u.expression),C("VAR",l)],l=L(u.statement),c.handlers=[{name:"DO",statement:l}],c);break;case Pe.FunctionDeclaration:o=function(e){const r=D(e.name);v.localReporters.push(e.parameters.map(e=>({name:e.name.getText(),type:e.type.getText()})));var t=L(e.body);let n;return v.localReporters.pop(),(n=w("function_definition",e)).mutation={name:r},e.parameters&&(n.mutationChildren=[],e.parameters.forEach(e=>{var t=e.name.getText();n.mutationChildren.push({nodeName:"arg",attributes:{name:t,type:e.type.getText(),id:v.functionParamIds[r][t]}})})),n.handlers=[{name:"STACK",statement:t}],n}(a);break;case Pe.CallExpression:o=function(t,r){const h=fe.pxtInfo(t).callInfo,g=I(h);if("Math.pow"==h.qName){const de=E("math_arithmetic");return de.inputs=[N("A",A(t.arguments[0]),Le),N("B",A(t.arguments[1]),Le)],de.fields=[U("OP","POWER")],de}if(pxt.Util.startsWith(h.qName,"Math.")){const de=h.qName.substring(5);if(_e(de)){let e;return Ce(de)?e=E("math_js_round"):(e=E("math_js_op"),n=Ke(de)?"unary":$e(de)?"infix":"binary",e.mutation={"op-type":n}),e.inputs=h.args.map((e,t)=>N("ARG"+t,A(e),"math_number")),e.fields=[U("OP",de)],e}}if(g.blockId===fe.PAUSE_UNTIL_TYPE){const de=w(fe.PAUSE_UNTIL_TYPE,t),ce=t.arguments[0];var n=ce.body.kind===Pe.Block?ce.body.statements[0].expression:ce.body;return de.inputs=[N("PREDICATE",A(n),"logic_boolean")],de}if(!g.blockId||!g.block){const de=pxt.blocks.builtinFunctionInfo[h.qName];if(!de){const de=D(t.expression);if(v.declaredFunctions[de]){let s,e=!0;if(h.isExpression){const[de]=Se(t);e=de&&de.kind===Pe.ExpressionStatement}return s=w(e?"function_call":"function_call_output",t),h.args.length&&(s.mutationChildren=[],s.inputs=[],v.declaredFunctions[de].parameters.forEach((e,t)=>{var r=e.name.getText(),n=v.functionParamIds[de][r],r=(s.mutationChildren.push({nodeName:"arg",attributes:{name:r,type:e.type.getText(),id:n}}),N(n,A(h.args[t])));s.inputs.push(r)})),s.mutation={name:de},s}return re(t)}g.blockId=de.blockId}if(!g.imageLiteral){de.isFunctionLike(h.decl);const o=Ne(h,v.blocks),l=v.blocks.apis.byQName[h.decompilerBlockAlias||h.qName],b=pxt.blocks.compileInfo(l),x=r?E(g.blockId):w(g.blockId,t),y=e=>(x.inputs||(x.inputs=[])).push(e),k=e=>(x.fields||(x.fields=[])).push(e);"Math.max"==h.qName&&k({kind:"field",name:"op",value:"max"});let e=0;return o.forEach((s,i)=>{let a,o=s.value;const l=s.param,c=s.info,u=b.parameters[b.thisParameter?i-1:i],p=u&&u.range;if(p){const s=p.min,fe=p.max;a={min:s.toString(),max:fe.toString()}}if(0===i&&g.defaultInstance){if(o.getText()===g.defaultInstance)return;x.mutation={showing:"true"}}if(!g.mutatePropertyEnum||i!==h.args.length-2){let n;if(l&&l.isOptional&&++e,l&&l.shadowBlockId&&(n=S.blocksById[l.shadowBlockId]),o.kind===Pe.CallExpression){const s=fe.pxtInfo(o).callInfo,i=s&&I(s);i&&"TD_ID"===i.shim&&c.isEnum&&(o=ve(s.args[0]))}if(l&&c&&c.isEnum&&o.kind===Pe.Identifier)k(U(fe.U.htmlEscape(l.definitionName),fe.pxtInfo(o).commentAttrs.enumIdentity));else if(l&&l.fieldOptions&&l.fieldOptions[ce.DecompileArgumentAsString])k(U(fe.U.htmlEscape(l.definitionName),fe.Util.htmlEscape(o.getText())));else switch(o.kind){case Pe.FunctionExpression:case Pe.ArrowFunction:o.body;const s=function(){var e=ye(o);if(e)return{callbackproperties:e[0].join(","),renamemap:fe.Util.htmlEscape(JSON.stringify(e[1]))}}();let e=!1;if(s)x.mutation=s;else{var d=o;const fe=S.blocksById[g.blockId].parameters[b.thisParameter?i-1:i],ce=(e,t)=>{var r,n,s,i;"reporter"===g.draggableParameters?y((r="HANDLER_DRAG_PARAM_"+e.name,n=t,s=e.type,i=pxt.blocks.reporterTypeForArgType(s),N(r,X(n,s,!0),i))):y(C("HANDLER_DRAG_PARAM_"+e.name,t))};if(d.parameters.length&&(g.optionalVariableArgs?(x.mutation={numargs:d.parameters.length.toString()},d.parameters.forEach((e,t)=>{x.mutation["arg"+t]=e.name.text})):d.parameters.forEach((e,t)=>{t=fe.handlerParameters[t];g.draggableParameters?ce(t,e.name.text):k(U("HANDLER_"+t.name,e.name.text))})),g.draggableParameters){if(d.parameters.length<fe.handlerParameters.length)for(let e=d.parameters.length;e<fe.handlerParameters.length;e++){const s=fe.handlerParameters[e];ce(s,s.name)}"reporter"===g.draggableParameters&&(v.localReporters.push(fe.handlerParameters),e=!0)}}const u=L(o);(x.handlers||(x.handlers=[])).push({name:"HANDLER",statement:u}),e&&v.localReporters.pop();break;case Pe.PropertyAccessExpression:const p=fe.pxtInfo(o).callInfo,ve=fe.U.htmlEscape(l.definitionName),m=I(p);n&&"TD_ID"===n.attributes.shim?y(N(ve,P(o,!1,l.shadowBlockId),l.shadowBlockId,a)):c&&c.isEnum||p&&(m.fixedInstance||m.blockIdentity===h.qName)?k(U(ve,P(o,!0).value)):y(_(ve,o,l.shadowBlockId,a));break;case Pe.BinaryExpression:if(l&&l.shadowOptions&&l.shadowOptions.toString){const s=o;if(s.operatorToken.kind===Pe.PlusToken&&((d=s.left).kind===Pe.StringLiteral||d.kind===Pe.NoSubstitutionTemplateLiteral)&&""===d.text){y(_(fe.U.htmlEscape(l.definitionName),s.right,l.shadowBlockId||"text"));break}}y(_(fe.U.htmlEscape(l.definitionName),o,l.shadowBlockId,a));break;default:let t;var f=fe.U.htmlEscape(l.definitionName);let r=!0;if("Math.random"==h.qName)t=N(f,function(e){switch(e.kind){case Pe.NumericLiteral:return K((parseInt(e.text)-1).toString());case Pe.BinaryExpression:var t=e;if(t.operatorToken.kind==Pe.PlusToken&&"1"==t.right.text)return A(t.left);default:return A(e)}}(o),Le,a),r=!1;else if(Ee(o)){const s="text"==l.fieldEditor?o.text:o.getText(),i=l.shadowBlockId&&!function(){switch(l.shadowBlockId){case Le:case Fe:case Me:case De:case Oe:case Be:return 1;default:return}}();if(ie(l)&&l.fieldOptions.onParentBlock)return void k(U(f,s));if(i){const i=function(e){if(S.blocksById[e]){e=pxt.blocks.compileInfo(S.blocksById[e]);if(!e.thisParameter&&1===e.parameters.length)return e.parameters[0]}}(l.shadowBlockId);if(i&&ie(i)){const ce=$(l.shadowBlockId,i.definitionName,s,!0);l.shadowOptions&&(ce.mutation={customfield:fe.Util.htmlEscape(JSON.stringify(l.shadowOptions))}),t=N(f,ce,l.shadowBlockId,a),r=!1}}}else if(o.kind===Pe.TaggedTemplateExpression&&l.fieldOptions&&l.fieldOptions[ce.TaggedTemplate])return void k(U(f,fe.Util.htmlEscape(o.getText())));r&&(t=_(f,o,l.shadowBlockId,a)),y(t)}}}),e&&(x.mutation||(x.mutation={}),x.mutation._expanded=e.toString()),x}n=t,r=h;if((t=n.arguments[0]).kind!=Pe.StringLiteral&&t.kind!=Pe.NoSubstitutionTemplateLiteral)T(n);else{var r=I(r),e=w(r.blockId,n),s=(e.fields=[],(t.text||"").replace(/\s+/g,"")),i=(r.imageLiteralColumns||5)*r.imageLiteral,a=r.imageLiteralRows||5,t=i*a;if(t==s.length){let r="";for(let t=0;t<a;++t){for(let e=0;e<i;++e)r+=/[#*1]/.test(s[t*i+e])?"#":".";r+="\n"}return e.fields.push(U("LEDS",`\`${r}\``)),e}T(n,fe.Util.lf("Invalid image pattern ({0} expected vs {1} actual)",t,s.length))}}(a,n);break;case Pe.DebuggerStatement:o=w(fe.TS_DEBUGGER_TYPE,a);break;case Pe.BreakStatement:o=w(fe.TS_BREAK_TYPE,a);break;case Pe.ContinueStatement:o=w(fe.TS_CONTINUE_TYPE,a);break;case Pe.EmptyStatement:o=void 0;break;case Pe.EnumDeclaration:case Pe.ModuleDeclaration:return Ue(a,x),m();case Pe.ReturnStatement:o=(l=a,c=w(fe.TS_RETURN_STATEMENT_TYPE,l),l.expression?c.inputs=[N("RETURN_VALUE",A(l.expression),Le)]:c.mutation={no_return_value:"true"},c);break;default:return void T(a,t?fe.Util.lf("Unsupported statement in block: {0}",Pe[a.kind]):fe.Util.lf("Statement kind unsupported in blocks: {0}",Pe[a.kind]))}if(o){let e=o;for(;e.next;)e=e.next;e.next=m(),e.next&&(e.next.prev=e)}if(!i){var f=r||a;let t,i=[];for(let e=0;e<x.length&&(!(t=x[e]).owner&&t.start>=f.pos&&t.end<=f.end&&(t.owner=f,t.ownerStatement=o,i.push(t)),!(t.start>f.end));e++);if(t&&t.isTrailingComment){const ue=de.getLineAndCharacterOfPosition(g,f.end),h=de.getLineAndCharacterOfPosition(g,t.start);if(ue.line===h.line){if(t.ownerStatement){t.ownerStatement.comment.splice(t.ownerStatement.comment.indexOf(t),1);for(const de of b)de.comment.splice(de.comment.indexOf(t),1)}t.owner=f,t.ownerStatement=o,i.push(t)}}if(i.length){const de=[];if(function e(t){var[t]=Se(t);return!t||t.kind==Pe.SourceFile||(t.kind==Pe.ExpressionStatement?e(t):t.kind==Pe.VariableDeclarationList&&e(t.parent))}(f)){let n=[];const s=[];i.forEach((e,t)=>{var r=e.owner&&e.start<e.owner.getStart();e.kind===ue.MultiLine&&r&&(n.length&&(s.push(n),n=[]),t!=i.length-1)?s.push([e]):(n.push(e),e.followedByEmptyLine&&r&&(s.push(n),n=[]))}),i=n,s.forEach(e=>{var t=B();de.push(t),b.push({comment:e,refId:t})})}o&&(de.length&&(o.data?o.data+=";"+de.join(";"):o.data=de.join(";")),i)&&i.length&&(o.comment?o.comment=o.comment.concat(i):o.comment=i)}}return o;function m(){if(t&&t.length)return L(t.shift(),t,void 0,!1,s)}}function re(e,t,r){a.errorOnGreyBlocks&&T(e);const n=w(fe.TS_STATEMENT_TYPE,e);n.mutation={},le(e);let s=e.getText();s=Q(s,e.getStart(),e.getEnd()),Ue(e,x),t&&(s=t+s);var i=[];if(e.kind===Pe.VariableStatement)for(const fe of e.declarationList.declarations)i.push(D(fe.name));else e.kind===Pe.VariableDeclaration&&i.push(D(e.name));i.length&&(n.mutation.declaredvars=i.join(","));t=s.split("\n");return n.mutation.numlines=t.length.toString(),r&&a.includeGreyBlockMessages&&(n.mutation.error=fe.U.htmlEscape(r)),t.forEach((e,t)=>{n.mutation["line"+t]=fe.U.htmlEscape(e)}),n}function k(e,n){return function(){var e=ve(n);switch(e.kind){case Pe.TrueKeyword:case Pe.FalseKeyword:case Pe.Identifier:case Pe.ElementAccessExpression:return;case Pe.BinaryExpression:switch(e.operatorToken.kind){case Pe.EqualsEqualsToken:case Pe.EqualsEqualsEqualsToken:case Pe.ExclamationEqualsToken:case Pe.ExclamationEqualsEqualsToken:case Pe.LessThanToken:case Pe.LessThanEqualsToken:case Pe.GreaterThanToken:case Pe.GreaterThanEqualsToken:case Pe.AmpersandAmpersandToken:case Pe.BarBarToken:return;default:return fe.Util.lf("Binary expressions in conditionals must evaluate to booleans")}return;case Pe.CallExpression:var t=e,r=fe.pxtInfo(t).callInfo;if(r){const fe=v.blocks.apis.byQName[r.qName];if(fe&&"boolean"==fe.retType)return;if(de.isIdentifier(t.expression)&&v.declaredFunctions[t.expression.text])return}return fe.Util.lf("Only functions that return booleans are allowed as conditions");case Pe.PrefixUnaryExpression:if(e.operator===Pe.ExclamationToken)return;default:return fe.Util.lf("Conditions must evaluate to booleans or identifiers")}}()?N(e,W(n),Be):_(e,n,Be)}function F(e,t,r,n=!1){t=D(t),M(t,pe.InBlocksOnly),n=w(n?"variables_change":"variables_set",e.parent||e);return n.inputs=[_("VALUE",r,Le)],n.fields=[U("VAR",t)],n}function ne(e,t,r,n){return se(e,t,r,n)}function se(e,r,n,s){const i=fe.pxtInfo(r).callInfo,a=v.blocks.apis.byQName[i?i.qName:""];if(a&&a.attributes.blockCombine){const o=`${a.namespace}.${a.retType}.`+s,l=v.blocks.blocks.find(e=>e.qName==o),c=n?w(l.attributes.blockId,e):E(l.attributes.blockId),u=l.attributes._def.parameters;let t=i.qName;return l.combinedProperties&&l.combinedProperties.forEach(e=>{0===e.indexOf(i.qName)&&"@"===e.charAt(i.qName.length)&&(t=e)}),c.inputs=[_(u[0].name,r.expression)],c.fields=[U(u[1].name,t)],n&&c.inputs.push(_(u[2].name,n)),c}T(r)}function ie(e){return e&&e.fieldOptions&&e.fieldOptions[ce.DecompileLiterals]}function ae(s,t,r=!1,e,n=!1){var i=[],a=t||[];for(let e=s.length-1;0<=e;e--){const t=s[e];((t.kind===Pe.FunctionDeclaration||t.kind==Pe.ExpressionStatement&&function(e){var t,r;if(e.expression.kind==Pe.CallExpression)return t=e.expression,(t=fe.pxtInfo(t).callInfo)?(r=I(t)).blockId&&!r.handlerStatement&&!t.isExpression&&we(t,r):(T(e),0)}(t))&&!he(t,v,!1,r)?i:a).unshift(t)}if(i.map(e=>L(e,void 0,void 0,!1,r)).forEach(c),a.length){const s=a.shift(),t=L(s,a,e,!1,r);if(n){let r=t,n=s;if(O.forEach(([e,t])=>{o[e]!==pe.InBlocksOnly&&(t.initializer,(e=o[e]===pe.InTextBlocks?re(t,"let "):F(s,t.name,t.initializer,!1)).next=r,r=e,n=t)}),r){const s=w(de.pxtc.ON_START_TYPE,n);return s.handlers=[{name:"HANDLER",statement:r}],s}oe(t)}return t}n&&oe(void 0)}function oe(e){a.alwaysEmitOnStart&&(u(de.pxtc.ON_START_TYPE,e),p())}function M(e,t){o[e]!==pe.InTextBlocks&&(o[e]=t)}function le(e){de.forEachChild(e,e=>{e.kind===Pe.Identifier&&M(D(e),pe.InTextBlocks),le(e)})}function D(e){if(r){var t=r.getRenameForPosition(e.getStart());if(t)return t.name}return e.text}},me.getLeadingComments=function(e,t,r){return l(t,r||de.getLeadingCommentRangesOfNode(e,t))},me.getTrailingComments=function(e,t){return l(t,de.getTrailingCommentRanges(t.getFullText(),e.end))},me.getCommentsForStatement=function(t,r){var n,s=[];for(let e=0;e<r.length&&(!(n=r[e]).owner&&n.start>=t.pos&&n.end<=t.end&&(n.owner=t,s.push(n)),!(n.start>t.end));e++);return s},me.buildCommentMap=je}}(ts=ts||{}),function(e){function c(e,t){var r;switch(e){case"void":return"None";case"boolean":return"bool";case"string":return"str"}return null!=(r=t.byQName[e])&&r.pyQName?t.byQName[e].pyQName:(r=/^(?:Array<(.+)>)|(?:(.+)\[\])|(?:\[.+\])$/.exec(e))?`List[${c(r[1]||r[2],t)}]`:e}function u(e,t){return`\`\`\`${t?"python":"ts"}
${e}
\`\`\``}(e=(e=e.pxtc||(e.pxtc={})).service||(e.service={})).displayStringForSymbol=function(n,s,i){if(n){switch(n.kind){case 3:case 1:{var a=n;var o=s;var l=i;let e="",t=(3===a.kind?e+=o?"def ":"function ":e+="(method) ",e+=o?a.pyQName:a.qName,""),r=(a.parameters&&a.parameters.length&&(t=a.parameters.map(e=>e.name+": "+(o?e.pyTypeString:e.type)).join(", ")),a.retType||"void");return o&&(r=c(r,l)),u(`${e}(${t}): `+r,o);return}case 6:case 7:{a=s?n.pyQName:n.qName;if(6===n.kind)return u("enum "+a,s);let e="(enum member) "+a;return n.attributes.enumval&&(e+=" = "+n.attributes.enumval),u(e,!1);return}case 5:return u("namespace "+(s?n.pyQName:n.qName),!1);case 9:return u("interface "+(s?n.pyQName:n.qName),!1);case 8:return u("class "+(s?n.pyQName:n.qName),s);case 4:var l=s,t=l?n.pyQName:"let "+n.qName;if(n.retType){let e=n.retType;return u(t+": "+(e=l?c(e,i):e),l)}return u(t,l);case 2:t="(property) "+(s?n.pyQName:n.qName);if(n.retType){let e=n.retType;return u(t+": "+(e=s?c(e,i):e),!1)}return u(t,!1)}return`**${n.qName}**`}},e.displayStringForKeyword=function(e,t){return`\`\`\`${t?"py":"ts"}
(keyword) ${e}
\`\`\``}}(ts=ts||{}),function(e){var h=e.pxtc||(e.pxtc={});{e=h.thumb||(h.thumb={});const t={r0:0,r1:1,r2:2,r3:3,r4:4,r5:5,r6:6,r7:7,r8:8,r9:9,r10:10,r11:10,r12:12,sp:13,r13:13,lr:14,r14:14,pc:15,r15:15};class r extends h.assembler.AbstractProcessor{constructor(){super(),this.addEnc("$r0","R0-7",e=>this.inrange(7,e,e)),this.addEnc("$r1","R0-7",e=>this.inrange(7,e,e<<3)),this.addEnc("$r2","R0-15",e=>this.inrange(15,e,7&e|(8&e)<<4)),this.addEnc("$r3","R0-15",e=>this.inrange(15,e,e<<3)),this.addEnc("$r4","R0-7",e=>this.inrange(7,e,e<<6)),this.addEnc("$r5","R0-7",e=>this.inrange(7,e,e<<8)),this.addEnc("$r01","R0-7",e=>this.inrange(7,e,e|e<<3)),this.addEnc("$i0","#0-255",e=>this.inrange(255,e,e)),this.addEnc("$i1","#0-1020",e=>this.inrange(255,e/4,e>>2)),this.addEnc("$i2","#0-510",e=>this.inrange(127,e/4,e>>2)),this.addEnc("$i3","#0-7",e=>this.inrange(7,e,e<<6)),this.addEnc("$i4","#0-31",e=>this.inrange(31,e,e<<6)),this.addEnc("$i5","#0-124",e=>this.inrange(31,e/4,e>>2<<6)),this.addEnc("$i6","#1-32",e=>0==e?null:32==e?0:this.inrange(31,e,e<<6)),this.addEnc("$i7","#0-62",e=>this.inrange(31,e/2,e>>1<<6)),this.addEnc("$i32","#0-2^32",e=>1),this.addEnc("$rl0","{R0-7,...}",e=>this.inrange(255,e,e)),this.addEnc("$rl1","{LR,R0-7,...}",e=>16384&e?this.inrange(255,-16385&e,256|255&e):this.inrange(255,e,e)),this.addEnc("$rl2","{PC,R0-7,...}",e=>32768&e?this.inrange(255,-32769&e,256|255&e):this.inrange(255,e,e)),this.addEnc("$la","LABEL",e=>this.inrange(255,e/4,e>>2)).isWordAligned=!0,this.addEnc("$lb","LABEL",e=>this.inrangeSigned(127,e/2,e>>1)),this.addEnc("$lb11","LABEL",e=>this.inrangeSigned(1023,e/2,e>>1)),this.addInst("adcs  $r0, $r1",16704,65472),this.addInst("add   $r2, $r3",17408,65280),this.addInst("add   $r5, pc, $i1",40960,63488),this.addInst("add   $r5, sp, $i1",43008,63488),this.addInst("add   sp, $i2",45056,65408).canBeShared=!0,this.addInst("adds  $r0, $r1, $i3",7168,65024),this.addInst("adds  $r0, $r1, $r4",6144,65024),this.addInst("adds  $r01, $r4",6144,65024),this.addInst("adds  $r5, $i0",12288,63488),this.addInst("adr   $r5, $la",40960,63488),this.addInst("ands  $r0, $r1",16384,65472),this.addInst("asrs  $r0, $r1",16640,65472),this.addInst("asrs  $r0, $r1, $i6",4096,63488),this.addInst("bics  $r0, $r1",17280,65472),this.addInst("bkpt  $i0",48640,65280),this.addInst("blx   $r3",18304,65415),this.addInst("bx    $r3",18176,65408),this.addInst("cmn   $r0, $r1",17088,65472),this.addInst("cmp   $r0, $r1",17024,65472),this.addInst("cmp   $r2, $r3",17664,65280),this.addInst("cmp   $r5, $i0",10240,63488),this.addInst("eors  $r0, $r1",16448,65472),this.addInst("ldmia $r5!, $rl0",51200,63488),this.addInst("ldmia $r5, $rl0",51200,63488),this.addInst("ldr   $r0, [$r1, $i5]",26624,63488),this.addInst("ldr   $r0, [$r1, $r4]",22528,65024),this.addInst("ldr   $r5, [pc, $i1]",18432,63488),this.addInst("ldr   $r5, $la",18432,63488),this.addInst("ldr   $r5, [sp, $i1]",38912,63488).canBeShared=!0,this.addInst("ldr   $r5, [sp]",38912,63488).canBeShared=!0,this.addInst("ldrb  $r0, [$r1, $i4]",30720,63488),this.addInst("ldrb  $r0, [$r1, $r4]",23552,65024),this.addInst("ldrh  $r0, [$r1, $i7]",34816,63488),this.addInst("ldrh  $r0, [$r1, $r4]",23040,65024),this.addInst("ldrsb $r0, [$r1, $r4]",22016,65024),this.addInst("ldrsh $r0, [$r1, $r4]",24064,65024),this.addInst("lsls  $r0, $r1",16512,65472),this.addInst("lsls  $r0, $r1, $i4",0,63488),this.addInst("lsrs  $r0, $r1",16576,65472),this.addInst("lsrs  $r0, $r1, $i6",2048,63488),this.addInst("mov   $r2, $r3",17920,65280),this.addInst("movs  $r0, $r1",0,65472),this.addInst("movs  $r5, $i0",8192,63488),this.addInst("muls  $r0, $r1",17216,65472),this.addInst("mvns  $r0, $r1",17344,65472),this.addInst("negs  $r0, $r1",16960,65472),this.addInst("nop",18112,65535),this.addInst("orrs  $r0, $r1",17152,65472),this.addInst("pop   $rl2",48128,65024),this.addInst("push  $rl1",46080,65024),this.addInst("rev   $r0, $r1",47616,65472),this.addInst("rev16 $r0, $r1",47680,65472),this.addInst("revsh $r0, $r1",47808,65472),this.addInst("rors  $r0, $r1",16832,65472),this.addInst("sbcs  $r0, $r1",16768,65472),this.addInst("sev",48960,65535),this.addInst("stm   $r5!, $rl0",49152,63488),this.addInst("stmia $r5!, $rl0",49152,63488),this.addInst("stmea $r5!, $rl0",49152,63488),this.addInst("str   $r0, [$r1, $i5]",24576,63488).canBeShared=!0,this.addInst("str   $r0, [$r1]",24576,63488).canBeShared=!0,this.addInst("str   $r0, [$r1, $r4]",20480,65024),this.addInst("str   $r5, [sp, $i1]",36864,63488).canBeShared=!0,this.addInst("str   $r5, [sp]",36864,63488).canBeShared=!0,this.addInst("strb  $r0, [$r1, $i4]",28672,63488),this.addInst("strb  $r0, [$r1, $r4]",21504,65024),this.addInst("strh  $r0, [$r1, $i7]",32768,63488),this.addInst("strh  $r0, [$r1, $r4]",20992,65024),this.addInst("sub   sp, $i2",45184,65408),this.addInst("subs  $r0, $r1, $i3",7680,65024),this.addInst("subs  $r0, $r1, $r4",6656,65024),this.addInst("subs  $r01, $r4",6656,65024),this.addInst("subs  $r5, $i0",14336,63488),this.addInst("svc   $i0",57088,65280),this.addInst("sxtb  $r0, $r1",45632,65472),this.addInst("sxth  $r0, $r1",45568,65472),this.addInst("tst   $r0, $r1",16896,65472),this.addInst("udf   $i0",56832,65280),this.addInst("uxtb  $r0, $r1",45760,65472),this.addInst("uxth  $r0, $r1",45696,65472),this.addInst("wfe",48928,65535),this.addInst("wfi",48944,65535),this.addInst("yield",48912,65535),this.addInst("cpsid i",46706,65535),this.addInst("cpsie i",46690,65535),this.addInst("beq   $lb",53248,65280),this.addInst("bne   $lb",53504,65280),this.addInst("bcs   $lb",53760,65280),this.addInst("bcc   $lb",54016,65280),this.addInst("bmi   $lb",54272,65280),this.addInst("bpl   $lb",54528,65280),this.addInst("bvs   $lb",54784,65280),this.addInst("bvc   $lb",55040,65280),this.addInst("bhi   $lb",55296,65280),this.addInst("bls   $lb",55552,65280),this.addInst("bge   $lb",55808,65280),this.addInst("blt   $lb",56064,65280),this.addInst("bgt   $lb",56320,65280),this.addInst("ble   $lb",56576,65280),this.addInst("bhs   $lb",53760,65280),this.addInst("blo   $lb",54016,65280),this.addInst("b     $lb11",57344,63488),this.addInst("bal   $lb11",57344,63488),this.addInst("bl    $lb",61440,63488,!0),this.addInst("bb    $lb",57344,63488,!0),this.addInst("ldlit   $r5, $i32",18432,63488)}toFnPtr(e,t,r){return h.target.runtimeIsARM&&/::/.test(r)?e+t&-2:e+t|1}wordSize(){return 4}is32bit(e){return"bl"==e.name||"bb"==e.name}postProcessAbsAddress(e,t){return(t^=1)-e.baseOffset}emit32(e,t,r){var n,s,i=!!(t%2),a=(t=i?t+1&-4:t)>>1;return h.assert(null!=a),(0|a)==a&&-2097152<a&&a<2097152?(n=2047&a,s=a>>11&1023,{opcode:4026531840&a?62464|s:61440|s,opcode2:i?59392|n:63488|n,stack:0,numArgs:[t],labelName:r}):h.assembler.emitErr("jump out of range",r)}expandLdlit(s){let i,a=!1,e=[],o={},l=1;for(let n=0;n<s.lines.length;++n){var c=s.lines[n];if(e.push(c),"instruction"==c.type&&c.instruction&&"ldlit"==c.instruction.name){if(!i){let e=c.location+900,t=n+1;for(;t<s.lines.length&&!(s.lines[t].location>e);++t){var u=s.lines[t].getOp();("b"==u||"bb"==u||"pop"==u&&"pc"==s.lines[t].words[2])&&(i=s.lines[t])}if(i)a=!1;else for(a=!0;--t>n;)if("instruction"==s.lines[t].type){i=s.lines[t];break}}let e=c.words[1],t="#"+c.words[3],r=h.U.lookup(o,t);r||(r="_ldlit_"+ ++l,o[t]=r),c.update(`ldr ${e}, `+r)}if(c===i){i=null;var t,r,p=[],d="_jmpwords_"+ ++l;a&&p.push("bb "+d),p.push(".balign 4");for(t of Object.keys(o)){var f=o[t];p.push(f+": .word "+t.slice(1))}a&&p.push(d+":");for(r of p){s.buildLine(r,e);var m=e[e.length-1];m.scope=c.scope,m.lineNo=c.lineNo}o={}}}s.lines=e}getAddressFromLabel(e,t,r,n=!1){r=e.lookupLabel(r);if(null==r)return null;let s=e.location()+4;return n&&(s&=4294967292),r-s}isPop(e){return 48128==e}isPush(e){return 46080==e}isAddSP(e){return 45056==e}isSubSP(e){return 45184==e}peephole(e,t,r){var n=this.encoders.$lb11,s=this.encoders.$lb;function i(e,t){return null!=e.encode(t.numArgs[0]+8)&&null!=e.encode(t.numArgs[0]-8)&&null!=e.encode(t.numArgs[0])}let a=e.getOp(),o=!1;"bne"!=a&&"beq"!=a||("b"==t.getOp()&&0==e.numArgs[0]&&(o=!0),"bb"==t.getOp()&&2==e.numArgs[0]&&(o=!0)),"bb"==a&&i(n,e)?e.update("b "+e.words[1]):"b"==a&&-2==e.numArgs[0]?e.update(""):"bne"==a&&o&&i(s,t)?(e.update("beq "+t.words[1]),t.update("")):"beq"==a&&o&&i(s,t)?(e.update("bne "+t.words[1]),t.update("")):"push"!=a||16384!=e.numArgs[0]||"push"!=t.getOp()||16384&t.numArgs[0]?"pop"==a&&"pop"==t.getOp()&&32768==t.numArgs[0]?(e.update(e.text.replace("}",", pc}")),t.update("")):"push"==a&&"pop"==t.getOp()&&e.numArgs[0]==t.numArgs[0]?(h.assert(0<e.numArgs[0]),e.update(""),t.update("")):"push"==a&&"pop"==t.getOp()&&4==e.words.length&&4==t.words.length?(h.assert("{"==e.words[1]),e.update("mov "+t.words[2]+", "+e.words[2]),t.update("")):r&&"movs $r5, $i0"==e.getOpExt()&&"mov $r0, $r1"==t.getOpExt()&&e.numArgs[0]==t.numArgs[1]&&(n=r,s=e.numArgs[0],"pop"==n.getOp())&&n.numArgs[0]&1<<s?(e.update("movs r"+t.numArgs[0]+", #"+e.numArgs[1]),t.update("")):"pop"==a&&0<=l(e)&&"push"==t.getOp()&&l(e)==l(t)?(e.update("ldr r"+l(e)+", [sp, #0]"),t.update("")):"push"==a&&"ldr $r5, [sp, $i1]"==t.getOpExt()&&l(e)==t.numArgs[0]&&0==t.numArgs[1]?t.update(""):r&&"push"==a&&0<=l(e)&&(n=t,s=l(e),"movs $r5, $i0"==n.getOpExt())&&n.numArgs[0]!=s&&"pop"==r.getOp()&&l(e)==l(r)&&(e.update(""),r.update("")):(e.update(t.text.replace("{","{lr, ")),t.update(""))}registerNo(e){if(!e)return null;e=e.toLowerCase();e=t[e];return void 0===e?null:e}testAssembler(){h.assembler.expectError(this,"lsl r0, r0, #8"),h.assembler.expectError(this,"push {pc,lr}"),h.assembler.expectError(this,"push {r17}"),h.assembler.expectError(this,"mov r0, r1 foo"),h.assembler.expectError(this,"movs r14, #100"),h.assembler.expectError(this,"push {r0"),h.assembler.expectError(this,"push lr,r0}"),h.assembler.expectError(this,"pop {lr,r0}"),h.assembler.expectError(this,"b #+11"),h.assembler.expectError(this,"b #+102400"),h.assembler.expectError(this,"bne undefined_label"),h.assembler.expectError(this,".foobar"),h.assembler.expect(this,"0200      lsls    r0, r0, #8\nb500      push    {lr}\n2064      movs    r0, #100        ; 0x64\nb401      push    {r0}\nbc08      pop     {r3}\nb501      push    {r0, lr}\nbd20      pop {r5, pc}\nbc01      pop {r0}\n4770      bx      lr\n0000      .balign 4\ne6c0      .word   -72000\nfffe\n"),h.assembler.expect(this,"4291      cmp     r1, r2\nd100      bne     l6\ne000      b       l8\n1840  l6: adds    r0, r0, r1\n4718  l8: bx      r3\n"),h.assembler.expect(this,"          @stackmark base\nb403      push    {r0, r1}\n          @stackmark locals\n9801      ldr     r0, [sp, locals@1]\nb401      push    {r0}\n9802      ldr     r0, [sp, locals@1]\nbc01      pop     {r0}\n          @stackempty locals\n9901      ldr     r1, [sp, locals@1]\n9102      str     r1, [sp, base@0]\n          @stackempty locals\nb002      add     sp, #8\n          @stackempty base\n"),h.assembler.expect(this,"b090      sub sp, #4*16\nb010      add sp, #4*16\n"),h.assembler.expect(this,'6261      .string "abc"\n0063      \n'),h.assembler.expect(this,'6261      .string "abcde"\n6463      \n0065      \n'),h.assembler.expect(this,"3042      adds r0, 0x42\n1c0d      adds r5, r1, #0\nd100      bne #0\n2800      cmp r0, #0\n6b28      ldr r0, [r5, #48]\n0200      lsls r0, r0, #8\n2063      movs r0, 0x63\n4240      negs r0, r0\n46c0      nop\nb500      push {lr}\nb401      push {r0}\nb402      push {r1}\nb404      push {r2}\nb408      push {r3}\nb520      push {r5, lr}\nbd00      pop {pc}\nbc01      pop {r0}\nbc02      pop {r1}\nbc04      pop {r2}\nbc08      pop {r3}\nbd20      pop {r5, pc}\n9003      str r0, [sp, #4*3]\n")}}function l(e){h.assert("push"==e.getOp()||"pop"==e.getOp());let t=0,r=-1,n=e.numArgs[0];for(;0<n;)1&n&&(r=-1==r?t:-2),n>>=1,t++;return 0<=r?r:-1}e.ThumbProcessor=r}}(ts=ts||{}),function(r){var f=r.pxtc||(r.pxtc={});{var t,m=f.ir||(f.ir={});let p,d=f.Util;d.assert,(t=p=m.EK||(m.EK={}))[t.None=0]="None",t[t.NumberLiteral=1]="NumberLiteral",t[t.PointerLiteral=2]="PointerLiteral",t[t.RuntimeCall=3]="RuntimeCall",t[t.ProcCall=4]="ProcCall",t[t.SharedRef=5]="SharedRef",t[t.SharedDef=6]="SharedDef",t[t.FieldAccess=7]="FieldAccess",t[t.Store=8]="Store",t[t.CellRef=9]="CellRef",t[t.Sequence=10]="Sequence",t[t.JmpValue=11]="JmpValue",t[t.Nop=12]="Nop",t[t.InstanceOf=13]="InstanceOf";let s,l,e=0;class b{isExpr(){return!1}isStmt(){return!1}getId(){return this._id||(this._id=++e),this._id}}m.Node=b;class x extends b{constructor(e,t,r){super(),this.exprKind=e,this.args=t,this.data=r,this.callingConvention=0}static clone(e){var t=new x(e.exprKind,e.args?e.args.slice(0):null,e.data);return e.jsInfo&&(t.jsInfo=e.jsInfo),e.totalUses&&(t.totalUses=e.totalUses,t.currUses=e.currUses),t.callingConvention=e.callingConvention,t.mask=e.mask,t.isStringLiteral=e.isStringLiteral,t}reset(){this.currUses=0,this.prevTotalUses&&(this.totalUses=this.prevTotalUses)}ptrlabel(){return this.jsInfo instanceof y?this.jsInfo:null}hexlit(){var e=this.jsInfo;return null!=e.hexlit?e.hexlit:null}isExpr(){return!0}isPure(){return this.isStateless()||this.exprKind==p.CellRef}isLiteral(){switch(this.exprKind){case p.NumberLiteral:case p.PointerLiteral:return!0;default:return!1}}isStateless(){switch(this.exprKind){case p.NumberLiteral:case p.PointerLiteral:case p.SharedRef:return!0;default:return!1}}sharingInfo(){let e=this,t=this.getId();return this.exprKind!=p.SharedRef&&this.exprKind!=p.SharedDef||((e=this.args[0])?t=e.getId():e={currUses:"",totalUses:""}),`${e.currUses}/${e.totalUses} #`+t}toString(){return n(this)}canUpdateCells(){switch(this.exprKind){case p.NumberLiteral:case p.PointerLiteral:case p.CellRef:case p.JmpValue:case p.SharedRef:case p.Nop:return!1;case p.SharedDef:case p.FieldAccess:case p.InstanceOf:return this.args[0].canUpdateCells();case p.RuntimeCall:case p.ProcCall:case p.Sequence:case p.Store:return!0;default:throw f.oops()}}}m.Expr=x,(t=s=m.SK||(m.SK={}))[t.None=0]="None",t[t.Expr=1]="Expr",t[t.Label=2]="Label",t[t.Jmp=3]="Jmp",t[t.StackEmpty=4]="StackEmpty",t[t.Breakpoint=5]="Breakpoint",t[t.Comment=6]="Comment",(t=l=m.JmpMode||(m.JmpMode={}))[t.Always=1]="Always",t[t.IfZero=2]="IfZero",t[t.IfNotZero=3]="IfNotZero",m.lblNumUsesJmpNext=-101;class y extends b{constructor(e,t){super(),this.stmtKind=e,this.expr=t}isStmt(){return!0}toString(){return n(this)}}function n(e){return function e(t){if(t.isExpr()){var r=t,n=r.args?r.args[0]:null;switch(r.exprKind){case p.NumberLiteral:case p.PointerLiteral:return r.data+"";case p.CellRef:return r.data.toString();case p.JmpValue:return"JMPVALUE";case p.Nop:return"NOP";case p.SharedRef:return`SHARED_REF(#${n.getId()})`;case p.SharedDef:return`SHARED_DEF(#${n.getId()} u(${n.totalUses}): ${e(n)})`;case p.FieldAccess:return e(n)+"."+r.data.name;case p.RuntimeCall:return r.data+"("+r.args.map(e).join(", ")+")";case p.ProcCall:var s=r.data;return(null!=s.ifaceIndex?"IFACE@"+s.ifaceIndex:null!=s.virtualIndex?"VTABLE@"+s.virtualIndex:f.getDeclName(s.proc.action))+"("+r.args.map(e).join(", ")+")";case p.Sequence:return"("+r.args.map(e).join("; ")+")";case p.InstanceOf:return"("+e(r.args[0])+" instanceof "+r.data.id+")";case p.Store:return`{ ${e(r.args[0])} := ${e(r.args[1])} }`;default:throw f.oops()}}else{var i=t,a=i.expr?e(i.expr):"{null}";switch(i.stmtKind){case m.SK.Expr:return"    "+a+"\n";case m.SK.Jmp:var o=`goto ${i.lblName}
`;switch(i.jmpMode){case l.Always:return i.expr?`    { JMPVALUE := ${a} } `+o:"    "+o;case l.IfZero:return`    if (! ${a}) `+o;case l.IfNotZero:return`    if (${a}) `+o;default:throw f.oops()}case m.SK.StackEmpty:return"    ;\n";case m.SK.Breakpoint:return"    // brk "+i.breakpointInfo.id+"\n";case m.SK.Comment:return"    // "+i.expr.data+"\n";case m.SK.Label:return i.lblName+":\n";default:throw f.oops()}}}(e)}m.Stmt=y;class k{constructor(e,t,r){this.index=e,this.def=t,this.info=r,this.isarg=!1,this.iscap=!1,this._isLocal=!1,this._isGlobal=!1,this._debugType="?",this.isUserVariable=!1,this.bitSize=0,t&&(f.isInPxtModules(t)||(this.isUserVariable=!0),r)&&f.setCellProps(this)}getName(){return f.getDeclName(this.def)}getDebugInfo(){return{name:this.getName(),type:this._debugType,index:this.index}}toString(){let e="";return this.def&&(e+=this.getName()||"?"),"["+(e=this.isarg?"ARG "+e:e)+"]"}uniqueName(){return this.isarg?"arg"+this.index:this.getName().replace(/[^\w]/g,"_")+"___"+f.getNodeId(this.def)}isLocal(){return this._isLocal}isGlobal(){return this._isGlobal}loadCore(){return o(p.CellRef,null,this)}load(){var e=this.loadCore();return f.target.isNative&&!f.isStackMachine()&&0!=this.bitSize?6==this.bitSize?u("pxt::fromUInt",[e]):u("pxt::fromInt",[e]):this.isByRefLocal()?u("pxtrt::ldlocRef",[e]):e}isByRefLocal(){return this.isLocal()&&this.info.captured&&this.info.written}storeDirect(e){return o(p.Store,[this.loadCore(),e])}storeByRef(e){var t;return this.isByRefLocal()?u("pxtrt::stlocRef",[this.loadCore(),e]):f.target.isNative&&!f.isStackMachine()&&0!=this.bitSize?(t=6==this.bitSize?"pxt::toUInt":"pxt::toInt",this.storeDirect(u(t,[e],1))):this.storeDirect(e)}get isTemporary(){return!1}}m.Cell=k;class S extends k{constructor(e,t){super(e,null,null),this.index=e,this.owningProc=t,this.uid=S.unnamedCellCounter++}getName(){return"unnamed"+this.uid}uniqueName(){return this.getName()+"___U"+this.index}isByRefLocal(){return!1}get isTemporary(){return!0}}function h(r){var e=()=>{if(!r.args)return 0;let e=0;for(var t of r.args)e+=h(t);return r.mask&&r.mask.conversions&&(e+=4*r.mask.conversions.length),e};switch(r.exprKind){case p.NumberLiteral:return 2;case p.PointerLiteral:return 6;case p.RuntimeCall:return e()+2+2+4;case p.CellRef:return 2;case p.FieldAccess:return e()+(r.data.needsCheck?4:0)+2;case p.ProcCall:case p.SharedRef:case p.SharedDef:case p.Store:case p.Sequence:case p.JmpValue:case p.Nop:case p.InstanceOf:return 1e6;default:throw d.oops()}}function i(t){switch((t=x.clone(t)).exprKind){case p.PointerLiteral:case p.NumberLiteral:return t;case p.RuntimeCall:for(let e=0;e<t.args.length;++e)t.args[e]=i(t.args[e]);return t;case p.CellRef:var e=t.data;return e.repl?(e.replUses++,e.repl):t;case p.FieldAccess:return t.args[0]=i(t.args[0]),t;default:throw d.oops()}}function a(e,t){return new y(e,t)}function o(e,t,r){return new x(e,t,r)}function c(e,t){e=o(p.PointerLiteral,null,e);return e.jsInfo=t,e}function u(e,t,r=0){t=o(p.RuntimeCall,t,e);return r&&(t.mask={refMask:r}),t}function g(e,t=!1,r=!1){let n=!!t&&e.some(e=>e.canUpdateCells()),s=[];for(var i of d.reversed(e))i.isStateless()||i.exprKind==p.CellRef&&!n||(i.canUpdateCells()&&(n=!0),s.push(i));s.reverse(),f.isStackMachine()&&!r&&(s=[]);let a=[],o=e.map(r=>{if(0<=s.indexOf(r)){let e=r,t=r;return r.exprKind==p.SharedDef?(r.args[0].totalUses++,e=m.op(p.SharedRef,[r.args[0]])):(e=m.op(p.SharedRef,[r]),t=m.op(p.SharedDef,[r]),r.totalUses=2,r.currUses=0),a.push(t),e}return r});return{precomp:a,flattened:o}}S.unnamedCellCounter=0,m.UnnamedCell=S,m.Procedure=class extends b{constructor(){super(...arguments),this.numArgs=0,this.info=null,this.seqNo=-1,this.isRoot=!1,this.locals=[],this.captured=[],this.args=[],this.parent=null,this.debugInfo=null,this.fillDebugInfo=null,this.classInfo=null,this.perfCounterName=null,this.perfCounterNo=0,this.body=[],this.lblNo=0,this.action=null,this.cachedJS=null,this.usingCtx=null}reset(){this.body=[],this.lblNo=0,this.locals=[],this.captured=[],this.args=[]}isGetter(){return this.action&&this.action.kind==r.SyntaxKind.GetAccessor}vtLabel(){return this.label()+(f.isStackMachine()?"":"_args")}label(){return f.getFunctionLabel(this.action)}toString(){return`
PROC ${f.getDeclName(this.action)}
${this.body.map(e=>e.toString()).join("")}
`}emit(e){this.body.push(e)}emitExpr(e){this.emit(a(s.Expr,e))}mkLabel(e){var t=a(s.Label,null);return t.lblName="."+e+"_"+this.lblNo+++"_"+this.seqNo,t.lbl=t}emitLbl(e){this.emit(e)}emitLblDirect(e){var t=a(s.Label,null);t.lblName=e,t.lbl=t,this.emit(t)}getFullName(){let e=f.getDeclName(this.action);var t;return this.action&&(t=r.pxtc.nodeLocationInfo(this.action),e+=" "+t.fileName.replace("pxt_modules/","")+":"+(t.line+1)),e}getName(){return(this.action&&this.action.name?this.action.name.text:null)||"inline"}mkLocal(e,t){e=new k(this.locals.length,e,t);return this.locals.push(e),e}mkLocalUnnamed(){var e=new S(this.locals.length,this);return this.locals.push(e),e}localIndex(t,e=!1){return this.captured.filter(e=>e.def==t)[0]||this.locals.filter(e=>e.def==t)[0]||(e?null:this.args.filter(e=>e.def==t)[0])}stackEmpty(){this.emit(a(s.StackEmpty,null))}emitJmpZ(e,t){this.emitJmp(e,t,l.IfZero)}emitJmp(e,t,r=l.Always,n=null){t=a(s.Jmp,t);t.jmpMode=r,n&&n.exprKind==p.NumberLiteral&&(n=null),t.terminateExpr=n,"string"==typeof e?t.lblName=e:(t.lbl=e,t.lblName=t.lbl.lblName),this.emit(t)}inlineSelf(e){const{precomp:t,flattened:r}=g(e,!1,!0);d.assert(r.length==this.args.length),this.args.map((e,t)=>{e.repl=r[t],e.replUses=0});e=i(this.inlineBody);return this.args.forEach((e,t)=>{e.repl.exprKind==p.SharedRef&&(e.repl.args[0].prevTotalUses||(e.repl.args[0].prevTotalUses=e.repl.args[0].totalUses),e.repl.args[0].totalUses+=e.replUses-1),e.repl=null,e.replUses=0}),t.length?(t.push(e),o(p.Sequence,t)):e}resolve(){let n=(t,r)=>{if(t.args)for(let e=0;e<t.args.length;++e)t.args[e]=r(t.args[e])},r=e=>{switch(e.exprKind){case p.SharedDef:throw d.oops();case p.SharedRef:var t=e.args[0];if(t.totalUses)return t.totalUses--,e;t.totalUses=-1,t.currUses=0,t.irCurrUses=0;t=x.clone(e);return t.exprKind=p.SharedDef,t.args[0]=r(t.args[0]),t}return n(e,r),e},t=r=>(r.exprKind!=p.SharedRef&&(n(r,t),r.exprKind===p.Sequence)&&(r.args=r.args.filter((e,t)=>t==r.args.length-1||!e.isPure()||(e.exprKind==p.SharedRef&&0<e.args[0].totalUses&&e.args[0].totalUses--,!1))),r),s=e=>{switch(e.exprKind){case p.SharedDef:var t=e.args[0];if(d.assert(t.totalUses<0,"arg.totalUses < 0"),d.assert(0===t.currUses,"arg.currUses === 0"),-1==t.totalUses)return s(t);t.totalUses=1;break;case p.SharedRef:return d.assert(0<e.args[0].totalUses,"e.args[0].totalUses > 0"),e.args[0].totalUses++,e;case p.PointerLiteral:t=e.ptrlabel();t&&(t.lblNumUses||(t.lblNumUses=0),t.lblNumUses++)}return n(e,s),e},i=e=>{switch(e.exprKind){case p.SharedDef:n(e,i);case p.SharedRef:var t=e.args[0];return d.assert(0<t.totalUses,"arg.totalUses > 0"),1==t.totalUses?(d.assert(e.exprKind==p.SharedDef),t):(t.irCurrUses++,e);default:return n(e,i),e}};this.body=this.body.filter(e=>!e.expr||(e.expr=t(r(e.expr)),e.stmtKind!=m.SK.Expr)||!e.expr.isPure());var e,a,o=d.toDictionary(this.body.filter(e=>e.stmtKind==m.SK.Label),e=>e.lblName);for(let e=0;e<this.body.length;++e)this.body[e].stmtNo=e;for(e of this.body)switch(e.expr&&(e.expr=s(e.expr)),e.stmtKind){case m.SK.Expr:break;case m.SK.Jmp:e.lbl=d.lookup(o,e.lblName),e.lbl||f.oops("missing label: "+e.lblName),e.lbl.lblNumUses?e.lbl.lblNumUses++:e.lbl.lblNumUses=1;break;case m.SK.StackEmpty:case m.SK.Label:case m.SK.Breakpoint:case m.SK.Comment:break;default:f.oops()}let l=null,c=!f.target.debugMode,u=null;for(a of this.body)a.expr&&(a.expr=t(i(a.expr))),l&&l.lbl==a&&l.stmtKind==m.SK.Jmp&&a.stmtKind==m.SK.Label&&l.jmpMode==m.JmpMode.Always&&1==a.lblNumUses&&(a.lblNumUses=m.lblNumUsesJmpNext),l=a,a.stmtKind==m.SK.Breakpoint?(a.breakpointInfo.id,a.breakpointInfo):c&&(a.stmtKind==m.SK.Jmp?a.expr&&(u?c=!1:u=a.expr):a.stmtKind==m.SK.StackEmpty||a.stmtKind==m.SK.Label&&a.lblNumUses==m.lblNumUsesJmpNext||(c=!1));c&&u&&h(u)<=4*this.args.length+4+2+(f.target.isNative?4:30)&&(this.inlineBody=u),pxt.options.debug&&pxt.debug(this.toString())}},m.iterExpr=function e(t,r){if(r(t),t.args)for(var n of t.args)e(n,r)},m.stmt=a,m.comment=function(e){return a(s.Comment,c(e,e))},m.op=o,m.numlit=function(e){return o(p.NumberLiteral,null,e)},m.shared=function(e){switch(e.exprKind){case p.SharedRef:e=e.args[0];break;case p.NumberLiteral:return e}return o(p.SharedRef,[e])},m.ptrlit=c,m.rtcall=u,m.rtcallMask=function(e,t,r,n){d.startsWith(e,"@nomask@")&&(e=e.slice(8),t=0);e=u(e,n,t);return e.callingConvention=r,e},m.flattenArgs=g}}(ts=ts||{}),function(_t){{var Kt=_t.pxtc||(_t.pxtc={}),e;class r{constructor(e,t){this.wave=e,this.id=t,this.flags=0,this.resetAll()}refresh(){this.flags&=-9,this.proc&&!this.usedActions&&!zt(this.proc.action)||this.proc&&!this.proc.cachedJS?this.resetEmit():this.usedNodes&&(this.flags|=32),this.classInfo&&this.classInfo.reset()}resetEmit(){this.flags&=-41,this.proc&&this.proc.classInfo&&this.proc.classInfo.ctor==this.proc&&(this.proc.classInfo.ctor=null),this.functionInfo=null,this.variableInfo=null,this.classInfo=null,this.callInfo=null,this.proc=null,this.cell=null,this.exprInfo=null,this.usedNodes=null,this.usedActions=null}resetTSC(){this.flags&=16,this.typeCache=null,this.symbolCache=null,this.commentAttrs=null,this.valueOverride=null,this.declCache=void 0,this.fullName=null,this.constantFolded=void 0}resetAll(){this.resetTSC(),this.resetEmit()}}let n;Kt.PxtNode=r,(e=n=n||{})[e.Enum=0]="Enum",e[e.Number=1]="Number",e[e.String=2]="String",e[e.Boolean=3]="Boolean",e[e.Unsupported=4]="Unsupported",Kt.taggedUndefined=0,Kt.taggedNull=6,Kt.taggedFalse=10,Kt.taggedNaN=14,Kt.taggedTrue=66,Kt.thumbArithmeticInstr={adds:!0,subs:!0,muls:!0,ands:!0,orrs:!0,eors:!0,lsls:!0,asrs:!0,lsrs:!0},Kt.numberArithmeticInstr={div:!0,mod:!0,le:!0,lt:!0,ge:!0,gt:!0,eq:!0,neq:!0};const xr={"Array_::getAt":{name:"_pxt_array_get",argsFmt:["T","T","T"],value:0},"Array_::setAt":{name:"_pxt_array_set",argsFmt:["T","T","T","T"],value:0},"BufferMethods::getByte":{name:"_pxt_buffer_get",argsFmt:["T","T","T"],value:0},"BufferMethods::setByte":{name:"_pxt_buffer_set",argsFmt:["T","T","T","I"],value:0},"pxtrt::mapGetGeneric":{name:"_pxt_map_get",argsFmt:["T","T","S"],value:0},"pxtrt::mapSetGeneric":{name:"_pxt_map_set",argsFmt:["T","T","S","T"],value:0}};let St=Kt.ir.EK,t=(Kt.SK=_t.SyntaxKind,Kt.numReservedGlobals=1,0),vt=1;function $t(e){return e.pxt?!!(16&e.pxt.flags):!!(e=_t.getSourceFileOfNode(e))&&Kt.isPxtModulesFilename(e.fileName)}function Ct(e){if(e.pxt){const r=e.pxt;return r.wave!=vt&&(r.wave=vt,Kt.compileOptions&&Kt.compileOptions.skipPxtModulesTSC&&16&r.flags?Kt.compileOptions.skipPxtModulesEmit?r.refresh():r.resetEmit():r.resetAll()),r}{const Kt=new r(vt,++t);return $t(e)&&(Kt.flags|=16),e.pxt=Kt}}function Ut(e){return Ct(e).id}function Pt(e){return e?_t.SyntaxKind[e.kind]:"<null>"}function Lt(e,t,r=!1){var n=new Error(t);if(n.ksEmitterUserError=!0,n.ksErrorCode=e,r&&At)return wt||(wt=t,Nt=e),n;throw n}function Ft(){return Kt.target.isNative&&Kt.target.nativeType==Kt.NATIVE_TYPE_VM}function Mt(){return Kt.target.isNative&&Kt.target.nativeType!=Kt.NATIVE_TYPE_VM}function Dt(){return Kt.target.isNative&&Kt.target.nativeType==Kt.NATIVE_TYPE_THUMB}function lr(e){return Mt()?Kt.ir.rtcall("pxt::fromInt",[e]):e}function cr(e){return Mt()?Kt.ir.rtcall("pxt::fromBool",[e]):e}function Ot(e){switch(e){case 0:return Kt.target.shortPointers?2:4;case 1:return 1;case 3:return 2;case 5:return 4;case 2:return 1;case 4:return 2;case 6:return 4;default:throw Kt.oops()}}function i(e){switch(e){case 1:case 3:case 5:return!0;case 2:case 4:case 6:return!1;default:throw Kt.oops()}}function Bt(e){switch(e.kind){case Kt.SK.TemplateHead:case Kt.SK.TemplateMiddle:case Kt.SK.TemplateTail:case Kt.SK.StringLiteral:case Kt.SK.NoSubstitutionTemplateLiteral:return 1;default:return}}function Rt(e){return e&&e.modifiers&&e.modifiers.some(e=>e.kind==Kt.SK.StaticKeyword)}function ur(e){return e.modifiers&&e.modifiers.some(e=>e.kind==Kt.SK.ReadonlyKeyword)}function pr(e,t){return!e.explicitDefaults||e.explicitDefaults.indexOf(t)<0?null:e.paramDefl[t]}function a(e){if(!e)return null;switch(e.kind){case Kt.SK.MethodDeclaration:return"";case Kt.SK.Constructor:return"new/";case Kt.SK.GetAccessor:return"get/";case Kt.SK.SetAccessor:return"set/";default:return null}}function qt(e){return a(e)+Yt(e)}function jt(e){return null!=a(e)}function zt(e){let t=e,r=!1;for(;;)switch(t=t.parent,t||Lt(9229,Et("cannot determine parent of {0}",Pt(e))),t.kind){case Kt.SK.MethodDeclaration:case Kt.SK.Constructor:case Kt.SK.GetAccessor:case Kt.SK.SetAccessor:case Kt.SK.FunctionDeclaration:case Kt.SK.ArrowFunction:case Kt.SK.FunctionExpression:return t;case Kt.SK.WhileStatement:case Kt.SK.DoStatement:case Kt.SK.ForInStatement:case Kt.SK.ForOfStatement:case Kt.SK.ForStatement:r=!0;break;case Kt.SK.SourceFile:return r?It:null}}function Vt(e){return"objectFlags"in e}function Gt(e){return!!e&&(e.kind==Kt.SK.VariableDeclaration||e.kind==Kt.SK.BindingElement&&Gt(e.parent.parent))}function Ht(e){return!!e&&(Gt(e)&&!zt(e)||e.kind==Kt.SK.PropertyDeclaration&&Rt(e))}function Jt(e){return!!e&&(e.kind==Kt.SK.Parameter||e.kind==Kt.SK.BindingElement&&Jt(e.parent.parent))}Kt.isInPxtModules=$t,Kt.pxtInfo=Ct,Kt.getNodeId=Ut,Kt.stringKind=Pt,Kt.isStackMachine=Ft,Kt.needsNumberConversions=Mt,Kt.isThumb=Dt,Kt.sizeOfBitSize=Ot,Kt.isBitSizeSigned=i,Kt.setCellProps=function(e){var t;e._isLocal=Gt(t=e.def)&&!Ht(t)||Jt(e.def),e._isGlobal=Ht(e.def),e.def.isThisParameter||((t=tr(e.def)).flags&_t.TypeFlags.Void&&Kt.oops("void-typed variable, "+e.toString()),e.bitSize=function(e){if(!e||!e.type)return 0;if(!br(tr(e)))return 0;if(e.type.kind!=Kt.SK.TypeReference)return 0;switch(e.type.typeName.getText()){case"int8":return 1;case"int16":return 3;case"int32":return 5;case"uint8":return 2;case"uint16":return 4;case"uint32":return 6;default:return 0}}(e.def),0!=e.bitSize?e._debugType=(i(e.bitSize)?"int":"uint")+8*Ot(e.bitSize):sr(t)?e._debugType="string":t.flags&_t.TypeFlags.NumberLike&&(e._debugType="number")),e.isLocal()&&0!=e.bitSize&&(e.bitSize=0,Lt(9256,Et("bit sizes are not supported for locals and parameters")))},Kt.isStatic=Rt,Kt.isReadOnly=ur,Kt.getExplicitDefault=pr,Kt.isObjectType=Vt;class or{constructor(e,t){this.id=e,this.decl=t,this.baseClassInfo=null,this.allfields=[],this.methods={},this.attrs=Wt(t),this.reset()}reset(){this.vtable=null,this.itable=null}get isUsed(){return!!(8&Ct(this.decl).flags)}allMethods(){var e,t=[];for(e of Object.keys(this.methods))for(var r of this.methods[e])t.push(r);return t}usedMethods(){var e,t=[];for(e of Object.keys(this.methods))for(var r of this.methods[e])8&Ct(r).flags&&t.push(r);return t}}Kt.ClassInfo=or;let Tt,It,wt,Et=Kt.assembler.lf,Nt=0,At=0;function Qt(e,t){var r=Ct(t);return null==r.fullName&&(r.fullName=Kt.getFullName(e,t.symbol)),r.fullName}function s(e){var t=e=>{const t=_t.getSourceFileOfNode(e);return t&&(e=_t.getLeadingCommentRangesOfNode(e,t))?e.map(e=>t.text.slice(e.pos,e.end)).join("\n"):""};return(e=e.kind==Kt.SK.VariableDeclaration?e.parent.parent:e).symbol&&e.symbol.declarations&&1<e.symbol.declarations.length?e.symbol.declarations.map(t).join("\n"):t(e)}function dr(e){let t="";for(var r of e.declarations)t+=s(r);return Kt.parseCommentString(t)}function Wt(e){var t,r=e?Ct(e):null;return!r||2&r.flags?Kt.parseCommentString(""):r.commentAttrs||((t=Kt.parseCommentString(s(e)))._name=Yt(e),r.commentAttrs=t)}function Yt(e){return e.name&&e.name.kind==Kt.SK.Identifier?e.name.text:"???"}function Zt(e){return Vt(e)&&e.objectFlags&_t.ObjectFlags.Reference&&e.symbol&&"Array"==e.symbol.name}function Xt(e){return!!e.isThisType||!!Vt(e)&&!!(e.objectFlags&_t.ObjectFlags.Class||e.symbol&&e.symbol.flags&_t.SymbolFlags.Class)}function er(e){var t=Vt(t=e)&&t.objectFlags&_t.ObjectFlags.Reference&&t.typeArguments&&t.typeArguments.length?t.target:null;return Xt(t||e)}function fr(e){return Zt(e)?e.typeArguments[0]:Tt.getIndexTypeOfType(e,_t.IndexKind.Number)}function mr(e){return null===e?Kt.taggedNull:void 0===e?Kt.taggedUndefined:!1===e?Kt.taggedFalse:!0===e?Kt.taggedTrue:isNaN(e)?Kt.taggedNaN:null}function tr(e){let t;var r=Ct(e);if(r.typeCache)return r.typeCache;if(!(t=_t.isExpression(e)?Tt.getContextualType(e):t))try{t=Tt.getTypeAtLocation(e)}catch(e){Lt(9203,Et("Unknown type for expression"))}return t&&(r.typeCache=t)}function rr(e){e=Tt.getSignatureFromDeclaration(e);return!(Tt.getReturnTypeOfSignature(e).flags&_t.TypeFlags.Void)}function o(e){return e&&e.name}function nr(t){let e=o(t)?t.name.text:null;if(!e){if(t.kind!=Kt.SK.Constructor){for(let e=t.parent;e;e=e.parent)if(o(e))return nr(e)+".inline";return"inline"}e="constructor"}return function e(t){if(!t)return"";switch(t.kind){case Kt.SK.ModuleBlock:return e(t.parent);case Kt.SK.ClassDeclaration:case Kt.SK.ModuleDeclaration:return e(t.parent)+t.name.text+".";default:return""}}(t.parent)+e}function hr(e){return nr(e).replace(/[^\w]+/g,"_")}function gr(e){return hr(e)+"__P"+Ut(e)}Kt.getNodeFullName=Qt,Kt.getComments=s,Kt.parseCommentsOnSymbol=dr,Kt.parseComments=Wt,Kt.getName=Yt,Kt.checkType=function(e){return e},Kt.taggedSpecial=mr,Kt.getDeclName=nr,Kt.getFunctionLabel=gr;class yr{constructor(e){this.decl=e,this.capturedVars=[]}get isUsed(){return!!(8&Ct(this.decl).flags)}}function l(e,t,r){return!!(e.flags&t)||function(e){if(!(e.flags&_t.TypeFlags.Union))return n.Unsupported;let t,r=!0;return e.types.forEach(e=>{if(void 0===t)e.flags&_t.TypeFlags.NumberLike?t=n.Number:e.flags&_t.TypeFlags.BooleanLike?t=n.Boolean:e.flags&_t.TypeFlags.StringLike?t=n.String:e.flags&_t.TypeFlags.EnumLike&&(t=n.Enum);else switch(t){case n.Number:r=r&&!!(e.flags&_t.TypeFlags.NumberLike);break;case n.Boolean:r=r&&!!(e.flags&_t.TypeFlags.BooleanLike);break;case n.String:r=r&&!!(e.flags&_t.TypeFlags.StringLike);break;case n.Enum:r=r&&!!(e.flags&_t.TypeFlags.EnumLike)}}),r?t:n.Unsupported}(e)===r}function sr(e){return l(e,_t.TypeFlags.String|_t.TypeFlags.StringLiteral,n.String)}function br(e){return l(e,_t.TypeFlags.Number|_t.TypeFlags.NumberLiteral,n.Number)}Kt.FunctionAddInfo=yr,Kt.compileBinary=function(r,O,x,s){Kt.compilerHooks.preBinary&&Kt.compilerHooks.preBinary(r,O,x),Kt.target=O.target,Kt.compileOptions=O,Kt.target.debugMode=!!O.breakpoints;const o=_t.createDiagnosticCollection();Tt=r.getTypeChecker();let a=Kt.U.cpuUs(),g=[],n=[],A={},I={},ae=null,b=null,i=!1,l=[];if(vt++,O.target.isNative){if(!O.extinfo||!O.extinfo.hexinfo)return{diagnostics:[{file:r.getSourceFiles()[0],start:0,length:0,category:Kt.DiagnosticCategory.Error,code:9043,messageText:Et("The hex file is not available, please connect to internet and try again.")}],emittedFiles:[],emitSkipped:!0};let e=O.extinfo,t=O.target;if(e&&e.disabledDeps){const Kt=(O.otherMultiVariants||[]).find(e=>e.extinfo&&!e.extinfo.disabledDeps);Kt&&(pxt.debug(`using alternative extinfo (due to ${e.disabledDeps})`),e=Kt.extinfo,t=Kt.target)}Kt.hexfile.setupFor(t,e||Kt.emptyExtInfo()),Kt.hexfile.setupInlineAssembly(O)}let B,R=new kr;function c(){R.reset(),B=null,x.breakpoints=[{id:0,isDebuggerStmt:!1,fileName:"bogus",start:0,length:0,line:0,column:0}],x.procCallLocations=[]}R.res=x,R.options=O,R.target=O.target,O.computeUsedSymbols&&(x.usedSymbols={},x.usedArguments={});let u=[];if(!O.forceEmit||0==x.diagnostics.length){let e=r.getSourceFiles().slice();const Kt=e.find(e=>e.fileName===pxt.MAIN_TS),O=(Kt&&(e=e.filter(e=>e.fileName!==pxt.MAIN_TS)).push(Kt),e.find(e=>e.fileName===pxt.TUTORIAL_CODE_STOP));O&&(e=e.filter(e=>e.fileName!==pxt.TUTORIAL_CODE_STOP)).push(O),e.forEach(e=>{e.statements.forEach(e=>{u.push(e)})})}let p=r.getSourceFiles().filter(e=>Kt.Util.endsWith(e.fileName,s))[0],e={kind:Kt.SK.FunctionDeclaration,parameters:[],name:{text:"<main>",pos:0,end:0},body:{kind:Kt.SK.Block,statements:u},parent:p,pos:0,end:0};const d=Ct(It=e);for(d.flags|=3,H(e),g=[],c(),i=!0,gt(e);function(){for(B=S(e);0<g.length;)gt(g.pop())}(),!function(){i=!1;const e=R.usedClassInfos.length;for(var t of R.usedClassInfos){for(var r of t.allMethods()){const e=Ct(r),s=y(r);8&e.flags?s.virtualParent&&J(s.virtualParent.decl):(s.virtualParent&&s.virtualParent.isUsed||ue(r)||(n=Yt(r),null!=Kt.U.lookup(R.explicitlyUsedIfaceMembers,n)))&&J(r)}t=Ce(t.decl);t&&J(t)}var n;return i=!0,0==g.length&&e==R.usedClassInfos.length}(););{let e=R.globals.slice(0);e.forEach((e,t)=>e.index=t);const yt=e=>0==e?10:Ot(e);e.sort((e,t)=>yt(e.bitSize)-yt(t.bitSize)||e.index-t.index);let t=4*Kt.numReservedGlobals,r=0;for(var f of e){const e=Ft()?0:f.bitSize;for(var m=Ot(e);t&m-1;)t++;r||0!=e||(r=t),f.index=t,t+=m}R.globalsWords=t+3>>2,R.nonPtrGlobals=r?r>>2:R.globalsWords}i=!1;{for(var h of R.usedClassInfos)!function e(r){if(Kt.assert(r.isUsed,"inf.isUsed"),r.vtable)return r.vtable;let i=r.baseClassInfo?e(r.baseClassInfo).slice(0):[];r.derivedClasses=[],r.baseClassInfo&&r.baseClassInfo.derivedClasses.push(r);for(var a of r.usedMethods()){R.numMethods++;let s=y(a);const o=Wt(a);if(ue(a)&&!o.shim&&(r.toStringMethod=S(a),r.toStringMethod.info.usedAsIface=!0),s.virtualParent){R.numVirtMethods++;let t=qt(a),r=!1,n=S(a);Kt.U.assert(!!n);for(let e=0;e<i.length;++e)qt(i[e].action)==t&&(i[e]=n,s.virtualIndex=e,r=!0);r||(s.virtualIndex=i.length,i.push(n))}}r.vtable=i,r.itable=[];const n={};for(var s of r.allfields){let e=Yt(s),t=Ge(r,s,!1);n[e]=!0,r.itable.push({name:e,info:(t.idx+1)*(Ft()?1:4),idx:j(e),proc:null})}for(let e=r;e;e=e.baseClassInfo)for(var t of e.usedMethods()){const i=Yt(t);if(!Wt(t).shim){const l=S(t),c=r.itable.find(e=>e.name==i),u=t.kind==Kt.SK.SetAccessor,p=t.kind==Kt.SK.GetAccessor;c?(u&&!c.setProc?c.setProc=l:p&&!c.proc&&(c.proc=l),c.info=0):r.itable.push({name:i,info:0,idx:j(i),proc:u?null:l,setProc:u?l:null}),l.info.usedAsIface=!0}}return r.vtable}(h);var v,T,_,K,t;(t=Object.keys(R.ifaceMemberMap)).sort(Kt.U.strcmp),t.unshift(""),R.emitString(""),R.ifaceMembers=t,R.ifaceMemberMap={};let e=0;for(v of t)R.ifaceMemberMap[v]=e++;for(T of R.usedClassInfos)for(var $ of T.itable)$.idx=j($.name);for(_ of R.usedClassInfos)_.lastSubtypeNo=void 0,_.classNo=void 0;let r=pxt.BuiltInType.User0;const kt=e=>{Kt.U.assert(!e.classNo),e.classNo=r++;for(var t of e.derivedClasses)t.isUsed&&kt(t);e.lastSubtypeNo=r-1};for(K of R.usedClassInfos){let e=K;for(;e.baseClassInfo;)e=e.baseClassInfo;e.classNo||kt(e)}}var C,t=Kt.U.cpuUs();x.times.pass0=t-a;let U=o.getDiagnostics();c(),i=!1,R.finalPass=!0,N(e),Kt.U.assert(0==g.length),x.configData=[];for(C of Object.keys(I))I["!"+C]||x.configData.push({name:C.replace(/^\!/,""),key:I[C].key,value:I[C].value});x.configData.sort((e,t)=>e.key-t.key);var P=Kt.U.cpuUs();return x.times.pass1=P-t,mt(e,function(){if(!O.noEmit){R.writeFile=(e,t)=>{x.outfiles[e]=t};for(var e of R.procs)e.cachedJS&&!e.inlineBody||e.resolve();Kt.target.isNative&&(R.procs=R.procs.filter(e=>!(e.inlineBody&&!e.info.usedAsIface&&!e.info.usedAsValue))),O.target.isNative?(O.extinfo.yotta&&R.writeFile("yotta.json",JSON.stringify(O.extinfo.yotta,null,2)),O.extinfo.platformio&&R.writeFile("platformio.json",JSON.stringify(O.extinfo.platformio,null,2)),O.target.nativeType==Kt.NATIVE_TYPE_VM?Kt.vmEmit(R,O):Kt.processorEmit(R,O,x)):Kt.jsEmit(R)}}),x.times.passFinal=Kt.U.cpuUs()-P,O.ast&&(t=Kt.U.cpuUs(),Kt.annotate(r,s,Kt.target),x.times.passAnnotate=Kt.U.cpuUs()-t),Kt.compileOptions=null,0==U.length&&(U=o.getDiagnostics()),Kt.compilerHooks.postBinary&&Kt.compilerHooks.postBinary(r,O,x),{diagnostics:U,emittedFiles:void 0,emitSkipped:!!O.noEmit};function L(e,t,r,n,s,i){var a;a=Kt.DiagnosticCategory.Error,e=e,t=t,r=r,n=n,s=s,i=i,o.add(_t.createDiagnosticForNode(e,{code:t,message:r,key:r.replace(/^[a-zA-Z]+/g,"_"),category:a},n,s,i))}function q(e,t,r=9202){if(t)return Lt(r,t);e||Lt(r,Et("Sorry, this language feature is not supported"));let n=Pt(e),s=!1,i=null;switch(e.kind){case _t.SyntaxKind.ForInStatement:n=Et("for in loops");break;case _t.SyntaxKind.ForOfStatement:n=Et("for of loops"),s=!0;break;case _t.SyntaxKind.PropertyAccessExpression:n=Et("property access");break;case _t.SyntaxKind.DeleteExpression:n=Et("delete");break;case _t.SyntaxKind.GetAccessor:n=Et("get accessor method"),s=!0;break;case _t.SyntaxKind.SetAccessor:n=Et("set accessor method"),s=!0;break;case _t.SyntaxKind.TaggedTemplateExpression:n=Et("tagged templates");break;case _t.SyntaxKind.SpreadElement:n=Et("spread");break;case _t.SyntaxKind.TryStatement:case _t.SyntaxKind.CatchClause:case _t.SyntaxKind.FinallyKeyword:case _t.SyntaxKind.ThrowStatement:n=Et("throwing and catching exceptions");break;case _t.SyntaxKind.ClassExpression:n=Et("class expressions"),i=Et("declare a class as class C {} not let C = class {}")}let a="";return a=s?Et("{0} not currently supported",n):Et("{0} not supported",_t.SyntaxKind[e.kind]),i&&(a+=" - "+i),Lt(r,a)}function oe(e){return Ut(e)+""}function y(e){var t=Ct(e);return t.functionInfo||(t.functionInfo=new yr(e)),t.functionInfo}function k(e){e=Ct(e);return e.variableInfo||(e.variableInfo={}),e.variableInfo}function F(t,e=!1){var r=k(t),n=(e&&(r.written=!0),zt(t));if(null!=n&&n!=B.action){let e=B.action;for(;e&&e!=n;){var s=y(e);s.capturedVars.indexOf(t)<0&&s.capturedVars.push(t),e=zt(e)}r.captured=!0}}function M(e){var t=e(R);return i&&R.recordAction(b,e),t}function j(r,n=!1){return M(e=>{n&&!Kt.U.lookup(e.explicitlyUsedIfaceMembers,r)&&(Kt.U.assert(!e.finalPass),e.explicitlyUsedIfaceMembers[r]=!0);let t=Kt.U.lookup(e.ifaceMemberMap,r);return null==t&&(Kt.U.assert(!e.finalPass),t=e.ifaceMemberMap[r]=-1,e.emitString(r)),t})}function D(e){e.flags&_t.TypeFlags.Void&&Lt(9203,Et("void-typed variables not supported"))}function le(e){var t=Ct(e);D(tr(e)),t.cell||(t.cell=new Kt.ir.Cell(null,e,k(e))),R.globals.indexOf(t.cell)<0&&R.globals.push(t.cell)}function ce(t){var e;if(Ht(t))return H(t),(e=Ct(t)).cell||le(t),e.cell;{let e=B.localIndex(t);return e||(R.finalPass?Lt(9204,Et("cannot locate identifer")):e=B.mkLocal(t,k(t))),e}}function ue(e){return e.kind==Kt.SK.MethodDeclaration&&0==e.parameters.length&&"toString"==Yt(e)}function pe(e){if(32&e.flags||16&e.flags&&Kt.compileOptions.skipPxtModulesEmit)throw x.needsFullRecompile=!0,Lt(9200,Et("full recompile required"))}function z(e,t=null){const r=Ct(t=t||e.symbol.valueDeclaration);if(!r.classInfo){const e=hr(t)+"__C"+Ut(t),f=new or(e,t),m=((r.classInfo=f).attrs.autoCreate&&(A[f.attrs.autoCreate]=!0),f.baseClassInfo=function(e){if(e.heritageClauses)for(var t of e.heritageClauses)switch(t.token){case Kt.SK.ExtendsKeyword:if(!t.types||1!=t.types.length)throw Lt(9228,Et("invalid extends clause"));var r=tr(t.types[0]);if(r&&Xt(r))return Tt.getTypeAtLocation(e),z(r);throw Lt(9228,Et("cannot inherit from this type"));case Kt.SK.ImplementsKeyword:break;default:throw Lt(9228,Et("invalid heritage clause"))}return null}(t),f.baseClassInfo?Kt.U.toDictionary(f.baseClassInfo.allfields,e=>Yt(e)):{}),h=(e,t=f.baseClassInfo)=>t?t.methods[e]||h(e,t.baseClassInfo):null;for(var n of t.members)if(n.kind==Kt.SK.PropertyDeclaration){var s=n;Rt(s)||f.allfields.push(s);const r=Yt(s);(h(r)||Kt.U.lookup(m,r))&&L(s,9279,Et("redefinition of '{0}' as field",r))}else if(n.kind==Kt.SK.Constructor)for(var i of n.parameters)ir(i)&&f.allfields.push(i);else if(jt(n)){s=y(n);s.parentClassInfo=f,s.isUsed&&Y(f);const r=Yt(n);f.methods.hasOwnProperty(r)||(f.methods[r]=[]),f.methods[r].push(n);n=Kt.U.lookup(m,r);if(n){const e=Ct(n);64&e.flags||(e.flags|=64,8&e.flags&&j(r,!0),pe(e))}}if(f.baseClassInfo){f.allfields=f.baseClassInfo.allfields.concat(f.allfields);{var a=f;for(var o of a.allMethods()){let t=null;var l,c,u=qt(o),p=Yt(o);for(let e=a.baseClassInfo;e;e=e.baseClassInfo)if(e.methods.hasOwnProperty(p))for(var d of e.methods[p])qt(d)==u&&(t=d);t&&(l=y(o),c=y(t),t.parameters.length!=o.parameters.length&&L(o,9255,Et("the overriding method is currently required to have the same number of arguments as the base one")),(l.virtualParent=c).virtualParent||(pe(Ct(t)),c.virtualParent=c),Kt.assert(c.virtualParent==c,"pinf.virtualParent == pinf"))}}}}return r.classInfo}function de(e){return!!e&&!Bt(e)&&(e.kind!==Kt.SK.ArrayLiteralExpression?null==ee(e):e.elements.some(de))}function V(e){var t=X(e);return t?te(t.val):Ht(e)&&Wt(e).shim?Ne(e,e,[]):(t=ce(e),F(e),t.load())}function fe(e){Wt(e).shim&&Lt(9207,Et("built-in functions cannot be yet used as values; did you forget ()?"));var t=y(e);return me(t),t.location?t.location.load():(Kt.assert(!R.finalPass||0==t.capturedVars.length,"!bin.finalPass || info.capturedVars.length == 0"),t.usedAsValue=!0,J(e),Pe(e))}function me(e){void 0===e.usedBeforeDecl?e.usedBeforeDecl=!0:R.finalPass&&e.usedBeforeDecl&&e.capturedVars.length&&zt(e.decl)&&!e.alreadyEmitted&&Lt(9278,Et("function referenced before all variables it uses are defined"))}function he(e){var t=Q(e),r=X(t);if(r)return te(r.val);if(t&&(Gt(t)||Jt(t)))return V(t);if(t&&t.kind==Kt.SK.FunctionDeclaration)return fe(t);if("undefined"==e.text)return te(void 0);throw q(e,Et("Unknown or undeclared identifier"),9235)}function ge(e){e=function e(t){return t?jt(t)?t:e(t.parent):null}(e),e||Lt(9208,Et("'this' used outside of a method")),e=y(e);return e.thisParameter||Kt.oops("no this"),V(e.thisParameter)}function be(e){let t;var r,n;return(t=""==e?Kt.ir.rtcall("String_::mkEmpty",[]):(n=e,r=M(e=>e.emitString(n)),Kt.ir.ptrlit(r,JSON.stringify(e)))).isStringLiteral=!0,t}function G(e){var t=we(e),r=ie(e);return Kt.target.isNative||Bt(e)?Z(r,t):Z(Kt.ir.rtcallMask("String_::stringConv",1,1,[r]),!0)}function xe(e){e=_t.getDeclarationOfKind(e.symbol,Kt.SK.GetAccessor);if(null==e)throw Lt(9281,Et("setter currently requires a corresponding getter"));return e}function ye(e){if(e.kind==Kt.SK.Parameter||e.kind==Kt.SK.PropertyDeclaration)return e=Ct(e),Kt.target.switches.slowFields||64&e.flags}function ke(e,t=null){let r=tr(e.expression),n={callingConvention:0,paramDefl:{}},s=null,i=!1;if(!t&&sr(r)?s="String_::charAt":Zt(r)?s=t?"Array_::setAt":"Array_::getAt":Vt(a=r)&&(a.objectFlags&_t.ObjectFlags.Interface||a.objectFlags&_t.ObjectFlags.Anonymous)&&(n=dr(r.symbol),s=t?n.indexerSet:n.indexerGet),!s&&r.flags&(_t.TypeFlags.Any|_t.TypeFlags.StructuredOrTypeVariable)&&(s=t?"pxtrt::mapSetGeneric":"pxtrt::mapGetGeneric",i=!0),s){if(i||rt(e.argumentExpression))return ne(s,[e.expression,e.argumentExpression],n,t?[t]:[]);throw q(e,Et("non-numeric indexer on {0}",s),9238)}var a;throw q(e,Et("unsupported indexer"),9239)}function Se(e){var t=!(!Ht(t=e)||de(t.initializer)&&!Wt(t).whenUsed)||(t=e).kind==Kt.SK.FunctionDeclaration&&!zt(t)||jt(t)||_t.isClassDeclaration(e);return!Kt.target.switches.noTreeShake&&(!O.testMode||!t||$t(e))&&t}function ve(e){return!Se(e)||(e=Ct(e),R.finalPass?8&e.flags:e==b)}function H(e){var t;e&&((t=Ct(e)).classInfo?Y(t.classInfo):(O.computeUsedSymbols&&e.symbol&&(x.usedSymbols[Qt(Tt,e)]=null),Ft()&&jt(e)&&j(Yt(e),!0),Te(e),8&t.flags||(t.flags|=8,Se(e)&&g.push(e))))}function J(e){H(e)}function Te(e){i&&(b?b.usedNodes[oe(e)]=e:Kt.U.oops("no using ctx for: "+Yt(e)))}function Ie(e){if(!e)return null;var t=Ct(e);if(void 0!==t.declCache)return t.declCache;let r,n=Tt.getSymbolAtLocation(e);return r=n&&!(r=n.valueDeclaration)&&n.declarations&&(t=n.declarations[0])&&t.kind==_t.SyntaxKind.ImportEqualsDeclaration&&(n=Tt.getSymbolAtLocation(t.moduleReference))?n.valueDeclaration:r}function Q(e){let t=Ie(e);return H(t),!t&&e&&e.kind==Kt.SK.PropertyAccessExpression&&(e=e,Ct(t={kind:Kt.SK.PropertySignature,symbol:{isBogusSymbol:!0,name:e.name.getText()},name:e.name}).flags|=2),d.declCache=t||null,t}function we(e){return e.kind==Kt.SK.NullKeyword||e.kind==Kt.SK.NumericLiteral?!!e.isRefOverride:!Bt(e)}function Ee(e){Kt.assert(e.length<=8,"args.length <= 8");let r=0;return e.forEach((e,t)=>{we(e)&&(r|=1<<t)}),r}function Ne(e,t,r){let n=Wt(e),s=!(tr(t).flags&_t.TypeFlags.Void),i=n.shim;if(0<=i.indexOf("(")){var a=/(.*)\((.*)\)$/.exec(i);if(a){r.length&&Kt.U.userError("no arguments expected");var o=[];if(a[2].replace(/\s/g,"")){for(var l of a[2].split(/,/)){let e=parseInt(l);isNaN(e)&&null==(e=null==(e=et(t,l))?function(e,t){let r=Xe(e,t,"userconfig");return r=null==r?Xe(e,t,"config"):r}(t,l):e)&&Kt.U.userError("invalid argument: "+l+" in "+i),o.push(Kt.ir.numlit(e))}4<o.length&&Kt.U.userError("too many args")}return i=a[1],O.target.isNative&&Kt.hexfile.validateShim(nr(e),i,n,!0,o.map(e=>!0)),Kt.ir.rtcallMask(i,0,n.callingConvention,o)}}return"TD_NOOP"==i?(Kt.assert(!s,"!hasRet"),Kt.target.switches.profile&&"perfCounter"==n.shimArgument&&(r[0]&&r[0].kind==Kt.SK.StringLiteral&&(B.perfCounterName=r[0].text),B.perfCounterName||(B.perfCounterName=B.getFullName())),te(void 0)):"TD_ID"==i||"ENUM_GET"===i?(Kt.assert(1==r.length,"args.length == 1"),ie(r[0])):(O.target.shimRenames&&Kt.U.lookup(O.target.shimRenames,i)&&(i=O.target.shimRenames[i]),O.target.isNative&&Kt.hexfile.validateShim(nr(e),i,n,s,r.map(rt)),ne(i,r,n))}function Ae(e,n,s){if(e){var t=e.getParameters(),r=n.length;t.length>n.length&&t.slice(n.length).forEach(r=>{if(r.valueDeclaration&&r.valueDeclaration.kind==Kt.SK.Parameter){r=r.valueDeclaration;if(r.initializer)!function(e){switch(e.kind){case Kt.SK.UndefinedKeyword:case Kt.SK.NullKeyword:case Kt.SK.TrueKeyword:case Kt.SK.FalseKeyword:case Kt.SK.NumericLiteral:return 1;case Kt.SK.PropertyAccessExpression:return ie(e).exprKind==St.NumberLiteral;default:return}}(r.initializer)&&Lt(9212,Et("only numbers, null, true and false supported as default arguments")),n.push(r.initializer);else{let e=pr(s,Yt(r)),t=e?te(parseInt(e)):null;null==t&&(t=te(void 0)),n.push(Z(t))}}else Lt(9213,Et("unsupported default argument (shouldn't happen)"))});for(let e=0;e<r;e++){var i=t[e];i&&i.valueDeclaration&&i.valueDeclaration.kind==Kt.SK.Parameter&&(n[e],i.valueDeclaration)}s.imageLiteral&&(Bt(n[0])||Lt(9214,Et("Only image literals (string literals) supported here; {0}",Pt(n[0]))),n[0]=function(t){t=t||"0 0 0 0 0\n0 0 0 0 0\n0 0 0 0 0\n0 0 0 0 0\n0 0 0 0 0\n";let r=0,n=0,s=0,i="",a=0;t+="\n";for(let e=0;e<t.length;++e)switch(t[e]){case".":case"_":case"0":i+="0,",r++,a++;break;case"#":case"*":case"1":i+="255,",r++,a++;break;case"\t":case"\r":case" ":break;case"\n":r&&(0==n?n=r:r!=n&&Lt(9205,Et("lines in image literal have to have the same width (got {0} and then {1} pixels)",n,r)),r=0,s++);break;default:Lt(9206,Et("Only 0 . _ (off) and 1 # * (on) are allowed in image literals"))}var e="_img"+R.lblNo++,o=(a%2!=0&&(i+="0"),R.otherLiterals.push(`
.balign 4
${e}: .short 0xffff
        .short ${n}, ${s}
        .byte ${i}
`),"new pxsim.Image("+n+", ["+i+"])");return{kind:Kt.SK.NumericLiteral,imageLiteral:e,jsLit:o}}(n[0].text))}}function W(r,e,n,t,s=null,i=null){var a;s=s||Q(e);let o=!1,l=!1,c=!1;var u=r===e;if(s)switch(s.kind){case Kt.SK.PropertySignature:case Kt.SK.PropertyAssignment:case Kt.SK.PropertyDeclaration:case Kt.SK.MethodSignature:o=!0;break;case Kt.SK.Parameter:ir(s)&&(o=!0);break;case Kt.SK.GetAccessor:case Kt.SK.SetAccessor:case Kt.SK.MethodDeclaration:o=!0,l=!0,c=Rt(s);break;case Kt.SK.FunctionDeclaration:c=!0;break;case Kt.SK.ModuleDeclaration:break;default:s=null}else e.kind==Kt.SK.PropertyAccessExpression&&(o=!0);Kt.target.switches.slowMethods&&(l=!1);var p=Wt(s);let d=n.slice(0);if((o=o&&Rt(s)?!1:o)&&!i&&e.kind==Kt.SK.PropertyAccessExpression&&(i=e.expression),x.usedArguments&&p.trackArgs){let t=i?[i].concat(d):d,e=p.trackArgs.map(e=>t[e]).map(e=>{var t=Q(e);return!t||t.kind!=Kt.SK.EnumMember&&t.kind!=Kt.SK.VariableDeclaration?e&&e.kind==Kt.SK.StringLiteral?e.text:"*":Qt(Tt,t)}).join(","),r=Qt(Tt,s),n=x.usedArguments[r];(n=n||(x.usedArguments[r]=[])).indexOf(e)<0&&n.push(e)}function f(){var e=$e(s,r,d.map(e=>ie(e))),t=e.data;return d[0]&&t.proc&&t.proc.classInfo&&(t.isThis=d[0].kind==Kt.SK.ThisKeyword),e}if(Ae(t,d,p),c&&!y(s).location)return p.shim&&!Be(s)?Ne(s,r,d):(J(s),f());if(e.kind==Kt.SK.SuperKeyword){let t=B.classInfo.baseClassInfo.ctor;for(let e=B.classInfo.baseClassInfo;e&&!t;e=e.baseClassInfo)t=e.ctor;if(!t&&R.finalPass)throw Lt(9280,Et("super() call requires an explicit constructor in base class"));n=d.map(e=>ie(e));return n.unshift(ge(e)),_e(t,r,n)}if(o){if(Kt.U.assert(!Rt(s)),i?d.unshift(i):q(r,Et("strange method call"),9241),!s){Kt.U.assert(e.kind==Kt.SK.PropertyAccessExpression);const _t=e.name.text;return Ke(d.map(e=>ie(e)),{ifaceIndex:j(_t,!0),callLocationIndex:xt(r),noArgs:u})}var m=y(s);if(m.parentClassInfo&&Y(m.parentClassInfo),J(s),i.kind==Kt.SK.SuperKeyword)return f();const n=!!m.virtualParent,t=!!Ft()||!!Kt.target.switches.slowMethods;if(n&&!t)return s.kind==Kt.SK.MethodDeclaration?Kt.U.assert(!u):s.kind==Kt.SK.GetAccessor||s.kind==Kt.SK.SetAccessor?Kt.U.assert(u):Kt.U.assert(!1),Kt.U.assert(!R.finalPass||null!=m.virtualIndex,"!bin.finalPass || info.virtualIndex != null"),Ke(d.map(e=>ie(e)),{classInfo:m.parentClassInfo,virtualIndex:m.virtualIndex,noArgs:u,isThis:d[0].kind==Kt.SK.ThisKeyword});if(p.shim&&!Be(s))return Ne(s,r,d);if(p.helper){let e,t=Tt.getSymbolsInScope(r,_t.SymbolFlags.Module);for(var h of t)if("helpers"==h.name)for(var g of h.declarations||[h.valueDeclaration])if(g.kind==Kt.SK.ModuleDeclaration)for(var b of g.body.statements)(null==(a=b.symbol)?void 0:a.name)==p.helper&&(e=b);return e||Lt(9215,Et("helpers.{0} not found",p.helper)),e.kind!=Kt.SK.FunctionDeclaration&&Lt(9216,Et("helpers.{0} isn't a function",p.helper)),J(s=e),f()}return n||Kt.target.switches.slowMethods||!l?Ke(d.map(e=>ie(e)),{ifaceIndex:j(Yt(s),!0),isSet:u&&2==d.length,callLocationIndex:xt(r),noArgs:u}):(Kt.U.assert(s.kind!=Kt.SK.MethodSignature),f())}return s&&s.kind==Kt.SK.ModuleDeclaration&&("String"==Yt(s)?Lt(9219,Et('to convert X to string use: X + ""')):Lt(9220,Et("namespaces cannot be called directly"))),d.unshift(e),Kt.U.assert(!u),Ke(d.map(e=>ie(e)),{virtualIndex:-1,callLocationIndex:xt(r),noArgs:u})}function _e(e,t,r){Kt.U.assert(!R.finalPass||!!e);e={proc:e,callLocationIndex:xt(t),virtualIndex:null,ifaceIndex:null};return Kt.ir.op(St.ProcCall,r,e)}function Ke(e,t){return Kt.ir.op(St.ProcCall,e,t)}function S(e){return Ct(e).proc}function $e(e,t,r){var n=S(e);return e.kind==Kt.SK.FunctionDeclaration&&me(y(e)),Kt.assert(!!n||!R.finalPass,"!!proc || !bin.finalPass"),_e(n,t,r)}function Ce(e){return e.members.filter(e=>e.kind==Kt.SK.Constructor)[0]}function Y(e){Te(e.decl),e.isUsed||(Ct(e.decl).flags|=8,e.baseClassInfo&&Y(e.baseClassInfo),R.usedClassInfos.push(e))}function Ue(e){var t,r=e.parameters.slice(0);return!Rt(e)&&jt(e)&&((t=y(e)).thisParameter||(t.thisParameter={kind:Kt.SK.Parameter,name:{text:"this"},isThisParameter:!0,parent:e}),r.unshift(t.thisParameter)),r}function Pe(e){e=gr(e);return Kt.ir.ptrlit(e+"_Lit",e)}function Le(){const e=l;if(0<e.length){l=[];for(var t of e){const e=B;try{Me(t)}finally{B=e}}}}function Fe(e){R.finalPass&&e.functionsToDefine&&Kt.U.pushRange(l,e.functionsToDefine)}function Me(r){const e=y(r);let n=null;if(R.finalPass){if(e.alreadyEmitted)return Kt.U.assert(e.usedBeforeDecl),null;e.alreadyEmitted=!0}let t=r.kind==Kt.SK.ArrowFunction||r.kind==Kt.SK.FunctionExpression,s=e.capturedVars.slice(0),i=s.map((e,t)=>{t=new Kt.ir.Cell(t,e,k(e));return t.iscap=!0,t});void 0===e.usedBeforeDecl&&(e.usedBeforeDecl=!1),0<s.length?(Kt.assert(null!=zt(r),"getEnclosingFunction(node) != null)"),n=Kt.ir.shared(Kt.ir.rtcall("pxt::mkAction",[Kt.ir.numlit(s.length),Pe(r)])),e.usedAsValue=!0,s.forEach((e,t)=>{var r=B.localIndex(e),e=(r||Lt(9223,Et("cannot find captured value: {0}",Tt.symbolToString(e.symbol))),r.loadCore());B.emitExpr(Kt.ir.rtcall("pxtrt::stclo",[n,Kt.ir.numlit(t),e]))}),r.kind==Kt.SK.FunctionDeclaration&&(e.location=B.mkLocal(r,k(r)),B.emitExpr(e.location.storeDirect(n)),n=null)):t&&(n=Pe(r),e.usedAsValue=!0),Kt.assert(!!n==t,"!!lit == isExpression");var a=S(r);if(a)(B=a).reset();else{Kt.assert(!R.finalPass,"!bin.finalPass");const n=Ct(r),t=new Kt.ir.Procedure;t.isRoot=!!(1&n.flags),t.action=r,t.info=e,(n.proc=t).usingCtx=b,B=t,M(e=>e.addProc(t))}B.captured=i;var o,l,c=[];if(r.parent.kind==Kt.SK.ClassDeclaration){a=z(null,r.parent);if(B.classInfo?Kt.assert(B.classInfo==a,"proc.classInfo == classInfo"):B.classInfo=a,r.kind==Kt.SK.Constructor){if(a.baseClassInfo)for(var u of a.baseClassInfo.decl.members)u.kind==Kt.SK.Constructor&&J(u);a.ctor?Kt.assert(a.ctor==B,"classInfo.ctor == proc"):a.ctor=B;for(var p of a.allfields)p.kind!=Kt.SK.PropertyDeclaration||Rt(p)||(p=p).initializer&&c.push(p)}}const d=[],f=[];B.args=Ue(r).map((e,t)=>{e.name.kind===Kt.SK.ObjectBindingPattern&&d.push(e),r.kind==Kt.SK.Constructor&&ir(e)&&f.push(e);t=new Kt.ir.Cell(t,e,k(e));return Fe(t.info),t.isarg=!0,t}),B.args.forEach(e=>{var t;e.isByRefLocal()&&(t=Kt.ir.shared(Kt.ir.rtcall("pxtrt::mklocRef",[])),B.emitExpr(Kt.ir.rtcall("pxtrt::stlocRef",[t,e.loadCore()],1)),B.emitExpr(e.storeDirect(t)))}),d.forEach(e=>ft(e));for(o of f){var m=Ge(B.classInfo,He(B.classInfo,Yt(o)),!1),m=Kt.ir.op(St.FieldAccess,[V(e.thisParameter)],m);B.emitExpr(Kt.ir.op(St.Store,[m,V(o)]))}for(l of c){var h=Ge(B.classInfo,He(B.classInfo,Yt(l)),!1),h=Kt.ir.op(St.FieldAccess,[V(e.thisParameter)],h);B.emitExpr(Kt.ir.op(St.Store,[h,ie(l.initializer)]))}if(Le(),r.body.kind==Kt.SK.Block){if(N(r.body),rr(B.action)){const e=B.body[B.body.length-1];e&&e.stmtKind==Kt.ir.SK.Jmp&&e.jmpMode==Kt.ir.JmpMode.Always||B.emitJmp(E(r).ret,te(void 0),Kt.ir.JmpMode.Always)}}else{a=ie(r.body);B.emitJmp(E(r).ret,a,Kt.ir.JmpMode.Always)}B.emitLblDirect(E(r).ret),B.stackEmpty();a=B.mkLabel("final");if(rr(B.action)?B.emitJmp(a):B.emitJmp(a,te(void 0)),B.emitLbl(a),e.capturedVars.length&&e.usedBeforeDecl&&r.kind==Kt.SK.FunctionDeclaration&&!R.finalPass){e.capturedVars.sort((e,t)=>t.pos-e.pos);const Kt=k(e.capturedVars[0]);Kt.functionsToDefine||(Kt.functionsToDefine=[]),Kt.functionsToDefine.push(r)}return Kt.assert(!R.finalPass||0==g.length,"!bin.finalPass || usedWorkList.length == 0"),n}function De(e){e=Kt.ir.shared(e);return B.emitExpr(e),e}function Oe(){return De(Kt.ir.op(St.JmpValue,[]))}function Be(e){return!O.target.isNative&&e.body&&(e.body.kind!=Kt.SK.Block||0<e.body.statements.length)}function Re(r){if(ve(r)&&!(32&Ct(r).flags)){var e=Wt(r);if(null!=e.shim){if("@"==e.shim[0])return;if(O.target.isNative&&Kt.hexfile.validateShim(nr(r),e.shim,e,rr(r),Ue(r).map(e=>ar(tr(e)))),!Be(r))return}if(!_t.isInAmbientContext(r)&&r.body){let e=null,t=B;try{e=Me(r)}finally{B=t}return e}}}function qe(){}function je(e){e.needsIRCache=!0,n.push(e)}function ze(e,t=null){let r=n.length;return e.kind!=Kt.SK.PropertyAccessExpression&&e.kind!=Kt.SK.ElementAccessExpression||je(e.expression),t&&je(t),n.length==r?qe:()=>{for(let e=r;e<n.length;++e)n[e].cachedIR=null,n[e].needsIRCache=!1;n.splice(r,n.length-r)}}function Z(e,t=!1){t={kind:Kt.SK.NullKeyword,isRefOverride:t};return Ct(t).valueOverride=e,t}function Ve(e,t,r,n=null){var s=ze(e),n=n?ie(n):te(1),i=Kt.ir.shared(ie(e)),t=Kt.ir.shared(We(t,i,n));return Je(e,Z(t,!0)),s(),r?i:t}function Ge(e,t,r=!0){Rt(t)&&Kt.U.oops("fieldIndex on static field: "+Yt(t));var n=Wt(t),s=e.allfields.indexOf(t);return s<0&&R.finalPass&&Kt.U.oops("missing field"),{idx:s,name:Yt(t),isRef:!0,shimName:n.shim,classInfo:e,needsCheck:r}}function He(e,t){e=e.allfields.filter(e=>e.name.text==t)[0];return e||Lt(9224,Et("field {0} not found",t)),e}function Je(e,t){var r=Q(e),n=Ht(r);if(e.kind==Kt.SK.Identifier||n)r&&(n||Gt(r)||Jt(r))?(n=ce(r),F(r,!0),B.emitExpr(n.storeByRef(ie(t)))):q(e,Et("bad target identifier"),9248);else if(e.kind==Kt.SK.PropertyAccessExpression){r=Q(e);!r||r.kind!=Kt.SK.GetAccessor&&r.kind!=Kt.SK.SetAccessor?r&&(r.kind==Kt.SK.PropertySignature||r.kind==Kt.SK.PropertyAssignment||ye(r))?B.emitExpr(W(e,e,[t],null,r)):(n=ie(e),B.emitExpr(Kt.ir.op(St.Store,[n,ie(t)]))):(xe(r),(r=_t.getDeclarationOfKind(r.symbol,Kt.SK.SetAccessor))||q(e,Et("setter not available"),9253),B.emitExpr(W(e,e,[t],null,r)))}else if(e.kind==Kt.SK.ElementAccessExpression)B.emitExpr(ke(e,t));else if(e.kind==Kt.SK.ArrayLiteralExpression)if(t.kind==Kt.SK.ArrayLiteralExpression){const _t=t.elements.map(e=>{e=Kt.ir.shared(ie(e));return B.emitExpr(e),e});e.elements.forEach((e,t)=>{Je(e,Z(_t[t]))})}else{const _t=Kt.ir.shared(ie(t));e.elements.forEach((e,t)=>{Je(e,Z(re("Array_::getAt",[_t,Kt.ir.numlit(t)])))})}else q(e,Et("bad assignment target"),9249)}function Qe(e){if(Dt())switch(e){case"numops::adds":case"numops::subs":case"numops::eors":case"numops::ands":case"numops::orrs":return"@nomask@"+e}return Ft()&&"pxt::switch_eq"===e?"numops::eq":e}function We(e,t,r){return re(Qe(e),[t,r])}function Ye(e,t){if(t){var r=t.val;switch(function e(t){if(t.kind==Kt.SK.Identifier)return t.text;if(t.kind==Kt.SK.PropertyAccessExpression){const Kt=t,r=e(Kt.expression);if(r)return r+"."+Kt.name.text}return null}(e)){case"Math.floor":return{val:Math.floor(r)};case"Math.ceil":return{val:Math.ceil(r)};case"Math.round":return{val:Math.round(r)}}}return null}function X(e){if(!e)return null;var t=Ct(e);if(void 0===t.constantFolded)if(Gt(e)&&e.parent.flags&_t.NodeFlags.Const){const _t=e;_t.initializer&&(t.constantFolded=ee(_t.initializer))}else if(e.kind==Kt.SK.EnumMember){const _t=e,r=function(e){let t=Wt(e).enumval;if(!t){e=Tt.getConstantValue(e);if(null==e)return null;t=e+""}return/^[+-]?\d+$/.test(t)||/^0x[A-Fa-f\d]{2,8}$/.test(t)?t:(Kt.U.userError("enumval only support number literals"),"0")}(_t);if(null==r)t.constantFolded=ee(_t.initializer);else{const _t=parseInt(r);isNaN(_t)||(t.constantFolded={val:_t})}}else if(e.kind==Kt.SK.PropertyDeclaration&&Rt(e)&&ur(e)){const _t=e;t.constantFolded=ee(_t.initializer)}return t.constantFolded}function ee(e){var t;return e?(void 0===(t=Ct(e)).constantFolded&&(t.constantFolded=null,e=function(e){if(!e)return null;switch(e.kind){case Kt.SK.PrefixUnaryExpression:var t=e,r=ee(t.operand),t=t.operator;if(!r)return null;var n=r.val;switch(t){case Kt.SK.PlusToken:return{val:+n};case Kt.SK.MinusToken:return{val:-n};case Kt.SK.TildeToken:return{val:~n};case Kt.SK.ExclamationToken:return{val:!n};default:return null}return;case Kt.SK.BinaryExpression:r=e,t=ee(r.left);if(t){var s=ee(r.right);if(s){var i=r.operatorToken.kind;if(!t||!s)return null;var a=t.val,o=s.val;switch(i){case Kt.SK.PlusToken:return{val:a+o};case Kt.SK.MinusToken:return{val:a-o};case Kt.SK.SlashToken:return{val:a/o};case Kt.SK.PercentToken:return{val:a%o};case Kt.SK.AsteriskToken:return{val:a*o};case Kt.SK.AsteriskAsteriskToken:return{val:a**o};case Kt.SK.AmpersandToken:return{val:a&o};case Kt.SK.BarToken:return{val:a|o};case Kt.SK.CaretToken:return{val:a^o};case Kt.SK.LessThanLessThanToken:return{val:a<<o};case Kt.SK.GreaterThanGreaterThanToken:return{val:a>>o};case Kt.SK.GreaterThanGreaterThanGreaterThanToken:return{val:a>>>o};case Kt.SK.LessThanEqualsToken:return{val:a<=o};case Kt.SK.LessThanToken:return{val:a<o};case Kt.SK.GreaterThanEqualsToken:return{val:o<=a};case Kt.SK.GreaterThanToken:return{val:o<a};case Kt.SK.EqualsEqualsToken:return{val:a==o};case Kt.SK.EqualsEqualsEqualsToken:return{val:a===o};case Kt.SK.ExclamationEqualsEqualsToken:return{val:a!==o};case Kt.SK.ExclamationEqualsToken:return{val:a!=o};case Kt.SK.BarBarToken:return{val:a||o};case Kt.SK.AmpersandAmpersandToken:return{val:a&&o};default:return null}return}else;}return null;case Kt.SK.NumericLiteral:{const Kt=parseFloat(e.text);return isNaN(Kt)?null:{val:Kt}}case Kt.SK.NullKeyword:return{val:null};case Kt.SK.TrueKeyword:return{val:!0};case Kt.SK.FalseKeyword:return{val:!1};case Kt.SK.UndefinedKeyword:return{val:void 0};case Kt.SK.CallExpression:{const Kt=e;return 1==Kt.arguments.length?Ye(Kt.expression,ee(Kt.arguments[0])):null}case Kt.SK.PropertyAccessExpression:case Kt.SK.Identifier:return X(Ie(e));case Kt.SK.AsExpression:return ee(e.expression);default:return null}}(e),t.constantFolded=e),t.constantFolded):null}function Ze(e){let t=Kt.target.switches.boxDebug,r=null;if(t)try{Kt.target.switches.boxDebug=!1,r=ie(e)}finally{Kt.target.switches.boxDebug=t}else r=ie(e);e=tt(r);if(void 0===e)throw Lt(9267,Et("a constant number-like expression is required here"));return e}function Xe(e,t,r){var n,e=Tt.getSymbolsInScope(e,_t.SymbolFlags.Module).filter(e=>e.name==r&&!!e.valueDeclaration)[0];if(e)for(var s of e.valueDeclaration.body.statements)if(s.kind==Kt.SK.VariableStatement)for(n of s.declarationList.declarations)if(n.symbol.name==t)return Ze(n.initializer);return null}function et(e,t){var e=Tt.getSymbolsInScope(e,_t.SymbolFlags.Enum).filter(e=>"DAL"==e.name&&!!e.valueDeclaration)[0];return(e=e&&e.valueDeclaration.members.filter(e=>e.symbol.name==t)[0])?Tt.getConstantValue(e):null}function tt(e){var t;if(e.exprKind==Kt.ir.EK.NumberLiteral)return t=e.data,O.target.isNative&&!Ft()?t==Kt.taggedNull||t==Kt.taggedUndefined||t==Kt.taggedFalse?0:t==Kt.taggedTrue?1:"number"==typeof t?t>>1:void 0:"number"==typeof t?t:void 0;if(e.exprKind==Kt.ir.EK.RuntimeCall&&2==e.args.length){var r=tt(e.args[0]),n=tt(e.args[1]);if(void 0!==r&&void 0!==n)switch(e.data){case"numops::orrs":return r|n;case"numops::adds":return r+n;default:return void console.log(e)}}}function te(e){if(!O.target.isNative||Ft())return Kt.ir.numlit(e);{const O=mr(e);if(null!=O)return Kt.ir.numlit(O);var t;if("number"==typeof e)return!Kt.target.switches.boxDebug&&(0|e)==e&&-1073741824<=e&&e<=1073741823?Kt.ir.numlit(e<<1|1):(t=R.emitDouble(e),Kt.ir.ptrlit(t,JSON.stringify(e)));throw Kt.U.oops("bad literal: "+e)}}function rt(e){if(e.kind==Kt.SK.NullKeyword){var t=Ct(e).valueOverride;if(null!=t)return t.exprKind==St.NumberLiteral?!O.target.isNative||!!(1&t.data):t.exprKind==St.RuntimeCall&&"pxt::ptrOfLiteral"==t.data?t.args[0].exprKind==St.PointerLiteral&&!isNaN(parseFloat(t.args[0].jsInfo)):t.exprKind==St.PointerLiteral&&!isNaN(parseFloat(t.jsInfo))}return e.kind==Kt.SK.NumericLiteral||ar(tr(e))}function re(e,t){return Kt.ir.rtcallMask(e,(1<<t.length)-1,0,t)}function ne(a,e,o,t=null){let l=[],r=Kt.hexfile.lookupFunc(a);var n;Dt()&&(n=Kt.U.lookup(xr,a))&&(r=n,a=n.name),r&&(l=r.argsFmt);let c=Ee(e=t?e.concat(t):e),u=[],s=e.map((e,t)=>{var r,n=ie(e);if(!Mt())return n;let s=l[t+1],i=rt(e);if(s=!s&&a.indexOf("::")<0?i?"I":"_":s){if("_"==s[0]||"T"==s||"N"==s)return(r=function(){switch(s){case"_Buffer":return pxt.BuiltInType.BoxedBuffer;case"_Image":return Kt.target.imageRefTag||pxt.BuiltInType.RefImage;case"_Action":return pxt.BuiltInType.RefAction;case"_RefCollection":return pxt.BuiltInType.RefCollection;default:return null}}())&&u.push({argIdx:t,method:"_validate",refTag:r,refTagNullable:!!o.argsNullable}),n;if("I"==s)return n.exprKind==St.NumberLiteral&&"number"==typeof n.data?Kt.ir.numlit(n.data>>1):(u.push({argIdx:t,method:"pxt::toInt"}),n);if("B"==s)return c&=~(1<<t),se(e,n);if("S"==s)return n.isStringLiteral||(u.push({argIdx:t,method:"_pxt_stringConv",returnsRef:!0}),c|=1<<t),n;if("F"==s||"D"==s)return"D"==s&&Kt.U.oops("double arguments not yet supported"),i||Kt.U.userError("argsFmt=...F/D... but argument not a number in "+a),u.push({argIdx:t,method:"D"==s?"pxt::toDouble":"pxt::toFloat"}),n;throw Kt.U.oops("invalid format specifier: "+s)}throw Kt.U.userError("not enough args for "+a)}),i=Kt.ir.rtcallMask(a,c,o?o.callingConvention:0,s);return i.mask||(i.mask={refMask:0}),i.mask.conversions=u,O.target.isNative&&("I"==(n=l[0])?i=lr(i):"B"==n?i=cr(i):"F"==n?(t=i,i=Mt()?Kt.ir.rtcall("pxt::fromFloat",[t]):t):"D"==n&&(Kt.U.oops("double returns not yet supported"),i=(e=i,Mt()?Kt.ir.rtcall("pxt::fromDouble",[e]):e))),i}function w(r){R.numStmts++;var e=Kt.assembler.debug||Kt.target.switches.size;let n=!!O.breakpoints;if(e||n){var s=_t.getSourceFileOfNode(r);if(O.justMyCode&&$t(s)&&(n=!1),e||n){let t=r.pos;for(;/^\s$/.exec(s.text[t]);)t++;for(;"/"==s.text[t]&&"/"==s.text[t+1];){for(;s.text[t]&&"\n"!=s.text[t];)t++;t++}var i=_t.getLineAndCharacterOfPosition(s,t);if(e){let e=r.end;80<e-t&&(e=t+80);const O=s.text.slice(t,e).trim().replace(/\n[^]*/,"...");B.emit(Kt.ir.comment(`${s.fileName.replace(/pxt_modules\//,"")}(${i.line+1},${i.character+1}): `+O))}n&&(e=_t.getLineAndCharacterOfPosition(s,r.end),r={id:x.breakpoints.length,isDebuggerStmt:r.kind==Kt.SK.DebuggerStatement,fileName:s.fileName,start:t,length:r.end-t,line:i.line,endLine:e.line,column:i.character,endColumn:e.character},x.breakpoints.push(r),(i=Kt.ir.stmt(Kt.ir.SK.Breakpoint,null)).breakpointInfo=r,B.emit(i))}}}function nt(e,t){switch(t){case Kt.SK.PlusToken:return"numops::adds";case Kt.SK.MinusToken:return"numops::subs";case Kt.SK.SlashToken:return"numops::div";case Kt.SK.PercentToken:return"numops::mod";case Kt.SK.AsteriskToken:return"numops::muls";case Kt.SK.AsteriskAsteriskToken:return"Math_::pow";case Kt.SK.AmpersandToken:return"numops::ands";case Kt.SK.BarToken:return"numops::orrs";case Kt.SK.CaretToken:return"numops::eors";case Kt.SK.LessThanLessThanToken:return"numops::lsls";case Kt.SK.GreaterThanGreaterThanToken:return"numops::asrs";case Kt.SK.GreaterThanGreaterThanGreaterThanToken:return"numops::lsrs";case Kt.SK.LessThanEqualsToken:return"numops::le";case Kt.SK.LessThanToken:return"numops::lt";case Kt.SK.GreaterThanEqualsToken:return"numops::ge";case Kt.SK.GreaterThanToken:return"numops::gt";case Kt.SK.EqualsEqualsToken:return"numops::eq";case Kt.SK.EqualsEqualsEqualsToken:return"numops::eqq";case Kt.SK.ExclamationEqualsEqualsToken:return"numops::neqq";case Kt.SK.ExclamationEqualsToken:return"numops::neq";default:return null}}function st(e){e.statements.forEach(N)}function it(e){if(!(e.flags&_t.NodeFlags.Let||e.flags&_t.NodeFlags.Const))throw Lt(9260,Et("variable needs to be defined using 'let' instead of 'var'"))}function se(e,t=null){if(!t&&Dt()&&e.kind==Kt.SK.BinaryExpression){var r=e,n=Kt.U.lookup(Kt.thumbCmpMap,nt(0,r.operatorToken.kind));if(n)return Kt.ir.rtcall(n,[ie(r.left),ie(r.right)])}return t=t||ie(e),Ft()?t:Kt.ir.rtcall("numops::toBoolDecr",[t])}function E(e){e=Ut(e);return{fortop:".fortop."+e,cont:".cont."+e,brk:".brk."+e,ret:".ret."+e}}function at(e){if(!e)return 1;switch(e.kind){case Kt.SK.Identifier:case Kt.SK.StringLiteral:case Kt.SK.NumericLiteral:case Kt.SK.NullKeyword:return 1}}function ot(e){return ie(e)}function lt(e){at(e)||(w(e),e=ot(e),B.emitExpr(e),B.stackEmpty())}function ct(e=1){for(;e--;)B.emitExpr(re("pxt::endTry",[]))}function ut(){Lt(9282,Et("jumps (return, break, continue) through finally blocks not supported yet"))}function pt(e){let t=0;if(e.kind==_t.SyntaxKind.Block&&e.parent)if(e.parent.kind==_t.SyntaxKind.CatchClause)e.parent.parent.finallyBlock&&(t++,ut());else if(e.parent.kind==_t.SyntaxKind.TryStatement){const _t=e.parent;_t.tryBlock==e&&(_t.catchClause&&t++,_t.finallyBlock)&&(t++,ut())}return t}function dt(t,r,n){if(t.name.kind===Kt.SK.ObjectBindingPattern||t.name.kind==Kt.SK.ArrayBindingPattern)return r||(r=t.initializer?Kt.ir.shared(ie(t.initializer)):V(t),n=t.initializer?tr(t.initializer):tr(t)),t.name.elements.forEach(e=>dt(e,r,n)),B.stackEmpty(),null;if(!ve(t))return null;if(X(t))return null;let e;if(Fe((e=Ht(t)?(le(t),ce(t)):B.mkLocal(t,k(t))).info),e.isByRefLocal()&&B.emitExpr(e.storeDirect(Kt.ir.rtcall("pxtrt::mklocRef",[]))),D(tr(t)),t.kind===Kt.SK.BindingElement){w(t);var[s,,]=function e(t,r,n){const s=t.parent.parent;if(s.kind===Kt.SK.BindingElement){const t=e(s,r,n);r=t[0],n=t[1]}if(t.parent.kind==Kt.SK.ArrayBindingPattern){const s=t.parent.elements.indexOf(t),i=(t.dotDotDotToken&&Lt(9203,Et("spread operator not supported yet")),fr(n,s));return[re("Array_::getAt",[r,Kt.ir.numlit(s)]),i]}return function(e,t,r,n){const s=Tt.getPropertyOfType(r,n),i=(Kt.U.assert(!!s,"field sym"),Tt.getTypeOfSymbolAtLocation(s,e));let a;if(er(r)){const e=z(r);a=Kt.ir.op(St.FieldAccess,[t],Ge(e,He(e,n)))}else a=Ke([t],{ifaceIndex:j(n,!0),callLocationIndex:xt(e),noArgs:!0});return[a,i]}(t,r,n,(t.propertyName||t.name).text)}(t,r,n);B.emitExpr(e.storeByRef(s))}else if(t.initializer){if(w(t),Ht(t)){let e=Wt(t).jres;e&&("true"==e&&(e=Qt(Tt,t)),(s=Kt.U.lookup(O.jres||{},e))?ae=s:Lt(9270,Et("resource '{0}' not found in any .jres file",e)))}t.initializer,B.emitExpr(e.storeByRef(ie(t.initializer))),ae=null,B.stackEmpty()}else!function(e){for(;e;){if(function(e){switch(e.kind){case Kt.SK.WhileStatement:case Kt.SK.ForInStatement:case Kt.SK.ForOfStatement:case Kt.SK.ForStatement:case Kt.SK.DoStatement:return 1;default:return}}(e))return 1;e=e.parent}}(t)||(w(t),B.emitExpr(e.storeByRef(te(void 0))),B.stackEmpty());return e}function ft(e){return dt(e,null,null)}function mt(e,t){var r=wt;At++;try{wt=null;var n=t(e);return wt&&Lt(Nt,wt),wt=r,At--,n}catch(t){return At--,wt=null,L(e,t.ksErrorCode||9200,t.message),pxt.debug(t.stack),null}}function ie(e,t=!0){var r;return t&&e.cachedIR?e.cachedIR:(r=mt(e,ht)||te(void 0),t&&e.needsIRCache?(e.cachedIR=Kt.ir.shared(r),e.cachedIR):r)}function ht(e){e=function(r){switch(r.kind){case Kt.SK.NullKeyword:return Ct(r).valueOverride||te(null);case Kt.SK.TrueKeyword:return te(!0);case Kt.SK.FalseKeyword:return te(!1);case Kt.SK.TemplateHead:case Kt.SK.TemplateMiddle:case Kt.SK.TemplateTail:case Kt.SK.NumericLiteral:case Kt.SK.StringLiteral:case Kt.SK.NoSubstitutionTemplateLiteral:var n=r;if(n.kind==Kt.SK.NumericLiteral)return n.imageLiteral?Kt.ir.ptrlit(n.imageLiteral,n.jsLit):te(parseFloat(n.text));if(Bt(n))return be(n.text);throw Kt.oops();case Kt.SK.TaggedTemplateExpression:{var l=r;function s(e){return/^[0-9a-f]$/i.test(e)}var i,a,n=Q(l.tag);if(!n)throw q(l,Et("invalid tagged template"),9265);let t,o=Wt(n),e={decl:n,qName:n?Qt(Tt,n):"?",args:[l.template],isExpression:!0};function c(e){t=function(t,a){let e=ae;if("_"==a[0]&&"_"==a[1]&&O.jres[a]&&(e=O.jres[a],a=""),""==a&&e){var o=/font\/x-mkcd-b(\d+)/.exec(e.mimeType);if(o)if(R.finalPass){let t=parseInt(o[1]),r=atob(e.data),n=R.usedChars,s="",i="";for(let e=0;e<r.length;e+=t){var l=r.charCodeAt(e)+(r.charCodeAt(e+1)<<8);(l<128||n[l>>5]&1<<(31&l))&&(s+=r.slice(e,e+t),i+=l+", ")}a=Kt.U.toHex(Kt.U.stringToUint8Array(s))}else a="aabbccdd";else e.dataEncoding&&"base64"!=e.dataEncoding?"hex"==e.dataEncoding?a=e.data:Lt(9271,Et("invalid jres encoding '{0}' on '{1}'",e.dataEncoding,e.id)):a=Kt.U.toHex(Kt.U.stringToUint8Array(_t.pxtc.decodeBase64(e.data)))}if(/^e[14]/i.test(a)&&t.parent&&t.parent.kind==Kt.SK.CallExpression&&"image.ofBuffer"==t.parent.expression.getText()){const _t=/^e([14])(..)(..)..(.*)/i.exec(a);a=`870${_t[1]}${_t[2]}00${_t[3]}000000`+_t[4]}let r="";for(let e=0;e<a.length;++e){var n=a[e];if(!s(n)){if(/^[\s\.]$/.test(n))continue;throw q(t,Et("invalid character in hex literal '{0}'",n),9265)}s(a[e+1])&&(r+=n+a[e+1],e++)}if(Kt.target.isNative){const _t=R.emitHexLiteral(r.toLowerCase());return Kt.ir.ptrlit(_t,_t)}{const _t="_hex"+oe(t);return Kt.ir.ptrlit(_t,{hexlit:r.toLowerCase()})}}(l,e(l.template.text))}if(Ct(l).callInfo=e,l.template.kind!=Kt.SK.NoSubstitutionTemplateLiteral)throw q(l,Et("substitution not supported in hex literal",o.shim),9265);switch(o.shim){case"@hex":c(e=>e);break;case"@f4":c(function(t){if(!Array.isArray(o.groups))throw q(l,Et("missing groups in @f4 literal"),9272);let r=[],n=[],s={},i=0;o.groups.forEach((e,t)=>{for(var r of e)s[r]=t}),t+="\n";for(let e=0;e<t.length;++e){var a=t[e];switch(a){case" ":case"\t":break;case"\n":0<n.length&&(r.push(n),i=Math.max(n.length,i),n=[]);break;default:let e=Kt.U.lookup(s,a);if(null==e){if(2!=o.groups.length)throw q(l,Et("invalid character in image literal: '{0}'",e),9273);e=1}n.push(e)}}let e=8;return o.groups.length<=2?e=1:o.groups.length<=16&&(e=4),Kt.f4EncodeImg(i,r.length,e,(e,t)=>r[t][e]||0)});break;default:if(void 0===o.shim&&o.helper){var u=l.template;var p=o;let e,t=Tt.getSymbolsInScope(u,_t.SymbolFlags.Module);for(a of t)if("helpers"==a.name)for(var d of a.declarations||[a.valueDeclaration])if(d.kind==Kt.SK.ModuleDeclaration)for(var f of d.body.statements)(null==(i=f.symbol)?void 0:i.name)==p.helper&&(e=f);e||Lt(9215,Et("helpers.{0} not found",p.helper)),e.kind!=Kt.SK.FunctionDeclaration&&Lt(9216,Et("helpers.{0} isn't a function",p.helper));var m=e;return J(m),$e(m,u,[be(u.text)]);return}throw q(l,Et("invalid shim '{0}' on tagged template",o.shim),9265)}return t=o.helper?Kt.ir.rtcall(o.helper,[t]):t;return}case Kt.SK.PropertyAccessExpression:{var t=r;let e=Q(t);var o=X(e);if(o)return te(o.val);if((e=e.kind==Kt.SK.SetAccessor?xe(e):e).kind==Kt.SK.GetAccessor)return W(t,t,[],null,e);if(e.kind==Kt.SK.EnumMember)throw Lt(9210,Et("Cannot compute enum value"));if(e.kind==Kt.SK.PropertySignature||e.kind==Kt.SK.PropertyAssignment)return W(t,t,[],null,e,t.expression);if(e.kind==Kt.SK.PropertyDeclaration||e.kind==Kt.SK.Parameter)return Rt(e)?V(e):ye(e)?W(t,t,[],null,e,t.expression):(o=function(t){var r=tr(t.expression);if(er(r)){r=z(r);let e=t.expression.kind==Kt.SK.ThisKeyword;return Kt.target.switches.noThisCheckOpt&&(e=!1),Ge(r,He(r,t.name.text),!e)}throw q(t,Et("bad field access"),9247)}(t),Kt.ir.op(St.FieldAccess,[ie(t.expression)],o));if(jt(e)||e.kind==Kt.SK.MethodSignature)throw Lt(9211,Et("cannot use method as lambda; did you forget '()' ?"));if(e.kind==Kt.SK.FunctionDeclaration)return fe(e);if(Gt(e))return V(e);throw q(t,Et("Unknown property access for {0}",Pt(e)),9237);return}case Kt.SK.BinaryExpression:var h=r;if(h.operatorToken.kind==Kt.SK.EqualsToken){let e=(b=h).right;b.parent.kind==Kt.SK.ExpressionStatement&&(e=null);var g=ze(b.left,e),b=(Je(b.left,b.right),e?ie(e):te(void 0));return g(),b}{var x,y,k,S,v,T,I,w,g=ee(h);if(g)return te(g.val);let e=null,t=null;if((h.operatorToken.kind==Kt.SK.PlusToken||h.operatorToken.kind==Kt.SK.PlusEqualsToken)&&(e=tr(h.left),t=tr(h.right),sr(e)||sr(t)&&h.operatorToken.kind==Kt.SK.PlusToken)&&(Ct(h).exprInfo={leftType:Tt.typeToString(e),rightType:Tt.typeToString(t)}),h.operatorToken.kind==Kt.SK.CommaToken)return at(h.left)?ie(h.right):(b=ot(h.left),Kt.ir.op(St.Sequence,[b,ie(h.right)]));switch(h.operatorToken.kind){case Kt.SK.BarBarToken:case Kt.SK.AmpersandAmpersandToken:return y=ie((x=h).left),sr(tr(x.left)),k=B.mkLabel("lazy"),y=Kt.ir.shared(y),S=Kt.ir.rtcall("numops::toBool",[y]),v=B.mkLabel("lazySkip"),T=x.operatorToken.kind==Kt.SK.BarBarToken?Kt.ir.JmpMode.IfZero:x.operatorToken.kind==Kt.SK.AmpersandAmpersandToken?Kt.ir.JmpMode.IfNotZero:Kt.U.oops(),B.emitJmp(v,S,T),B.emitJmp(k,y,Kt.ir.JmpMode.Always,y),B.emitLbl(v),B.emitExpr(re("langsupp::ignore",[y])),B.emitJmp(k,ie(x.right),Kt.ir.JmpMode.Always),B.emitLbl(k),Oe();case Kt.SK.InstanceOfKeyword:return T=tr((S=h).right),(v=er(T)?Q(S.right):null)&&v.kind==Kt.SK.ClassDeclaration||Lt(9275,Et("unsupported instanceof expression")),Y(T=z(T,v)),(v=Kt.ir.op(Kt.ir.EK.InstanceOf,[ie(S.left)],T)).jsInfo="bool",v}return h.operatorToken.kind==Kt.SK.PlusToken&&(sr(e)||sr(t))?ne("String_::concat",[G(h.left),G(h.right)],null):h.operatorToken.kind==Kt.SK.PlusEqualsToken&&sr(e)?(w=ze(h.left),I=Kt.ir.shared(ne("String_::concat",[G(h.left),G(h.right)],null)),Je(h.left,Z(I)),w(),I):(w=function(){switch(h.operatorToken.kind){case Kt.SK.PlusEqualsToken:return Kt.SK.PlusToken;case Kt.SK.MinusEqualsToken:return Kt.SK.MinusToken;case Kt.SK.AsteriskEqualsToken:return Kt.SK.AsteriskToken;case Kt.SK.AsteriskAsteriskEqualsToken:return Kt.SK.AsteriskAsteriskToken;case Kt.SK.SlashEqualsToken:return Kt.SK.SlashToken;case Kt.SK.PercentEqualsToken:return Kt.SK.PercentToken;case Kt.SK.LessThanLessThanEqualsToken:return Kt.SK.LessThanLessThanToken;case Kt.SK.GreaterThanGreaterThanEqualsToken:return Kt.SK.GreaterThanGreaterThanToken;case Kt.SK.GreaterThanGreaterThanGreaterThanEqualsToken:return Kt.SK.GreaterThanGreaterThanGreaterThanToken;case Kt.SK.AmpersandEqualsToken:return Kt.SK.AmpersandToken;case Kt.SK.BarEqualsToken:return Kt.SK.BarToken;case Kt.SK.CaretEqualsToken:return Kt.SK.CaretToken;default:return Kt.SK.Unknown}}(),(I=nt(0,w||h.operatorToken.kind))||q(h.operatorToken,Et("unsupported operator"),9250),w?Ve(h.left,I,!1,h.right):(w=Qe(I),o=[h.left,h.right],Kt.ir.rtcallMask(w,Ee(o),0,o.map(e=>ie(e)))))}case Kt.SK.PrefixUnaryExpression:var e=r,t=ee(e);if(t)return te(t.val);switch(e.operator){case Kt.SK.ExclamationToken:return cr(Kt.ir.rtcall("Boolean_::bang",[se(e.operand)]));case Kt.SK.PlusPlusToken:return Ve(e.operand,"numops::adds",!1);case Kt.SK.MinusMinusToken:return Ve(e.operand,"numops::subs",!1);case Kt.SK.PlusToken:case Kt.SK.MinusToken:var E=ie(e.operand),N=tt(E);return null!=N?te(-N):e.operator==Kt.SK.MinusToken?We("numops::subs",te(0),E):We("numops::subs",E,te(0));case Kt.SK.TildeToken:N=ie(e.operand),E=tt(N);return null!=E?te(~E):re(Qe("numops::bnot"),[N]);default:throw q(e,Et("unsupported prefix unary operation"),9245)}return;case Kt.SK.PostfixUnaryExpression:var A=r;if(br(tr(A.operand)))switch(A.operator){case Kt.SK.PlusPlusToken:return Ve(A.operand,"numops::adds",!0);case Kt.SK.MinusMinusToken:return Ve(A.operand,"numops::subs",!0)}throw q(A,Et("unsupported postfix unary operation"),9246);case Kt.SK.ElementAccessExpression:return ke(r);case Kt.SK.ParenthesizedExpression:return ie(r.expression);case Kt.SK.TypeAssertionExpression:return r.expression,ie(r.expression);case Kt.SK.ArrayLiteralExpression:var _=r;fr(tr(_));var K,F=Kt.ir.shared(Kt.ir.rtcall("Array_::mk",[]));for(K of _.elements){var M=we(K)?2:0;B.emitExpr(Kt.ir.rtcall("Array_::push",[F,ie(K)],M))}return F;case Kt.SK.NewExpression:_=r;if(($=Tt.getTypeAtLocation(_))&&Zt($))throw Kt.oops();if($&&er($)){let t,e=Q(_.expression);e.kind!=Kt.SK.ClassDeclaration&&Lt(9221,Et("new expression only supported on class types"));var $=z(tr(_),e);for(let e=$;e&&!(t=Ce(e.decl));e=e.baseClassInfo);Y($);let r=$.id+"_VT",n=Kt.ir.rtcall("pxt::mkClassInstance",[Kt.ir.ptrlit(r,r)]);return t?(n=De(n),H(t),$=(_.arguments||[]).slice(0),L=Wt(t),Ae(Tt.getResolvedSignature(_),$,L),$=$.map(e=>ie(e)),L.shim?Kt.ir.rtcall(L.shim,$):($.unshift(n),B.emitExpr($e(t,_,$)),n)):(_.arguments&&_.arguments.length&&Lt(9222,Et("constructor with arguments not found")),n)}throw q(_,Et("unknown type for new"),9243);case Kt.SK.SuperKeyword:case Kt.SK.ThisKeyword:return ge(r);case Kt.SK.CallExpression:return L=r,$=Tt.getResolvedSignature(L),W(L,L.expression,L.arguments,$);case Kt.SK.FunctionExpression:case Kt.SK.ArrowFunction:return Re(r);case Kt.SK.Identifier:return he(r);case Kt.SK.ConditionalExpression:return C=r,U=B.mkLabel("condexprz"),P=B.mkLabel("condexprfin"),B.emitJmp(U,se(C.condition),Kt.ir.JmpMode.IfZero),B.emitJmp(P,ie(C.whenTrue),Kt.ir.JmpMode.Always),B.emitLbl(U),B.emitJmp(P,ie(C.whenFalse),Kt.ir.JmpMode.Always),B.emitLbl(P),Oe();case Kt.SK.AsExpression:return r.expression,ie(r.expression);case Kt.SK.TemplateExpression:{U=r;let n=0,e=(e,t)=>{return Bt(r=t)&&""==r.text?e:(n++,ne("String_::concat",[Z(e,!0),G(t)],null));var r},t=Ct(G(U.head)).valueOverride;for(var D of U.templateSpans)t=e(t,D.expression),t=e(t,D.literal);return 0==n?ne("String_::concat",[Z(t,!0),Z(Kt.ir.rtcall("String_::mkEmpty",[]),!1)],null):t;return}case Kt.SK.ObjectLiteralExpression:{C=r;let i=Kt.ir.shared(Kt.ir.rtcall("pxtrt::mkMap",[]));return C.properties.forEach(e=>{let t,r;if(Kt.assert(!e.questionToken),e.kind==Kt.SK.ShorthandPropertyAssignment){const i=e,n=(Kt.assert(!i.equalsToken&&!i.objectAssignmentInitializer),t=e.name.text,Tt.getShorthandAssignmentValueSymbol(e)),s=n&&n.valueDeclaration&&n.valueDeclaration.name;if(!s||s.kind!=Kt.SK.Identifier)throw q(e);r=he(s)}else{if(e.name.kind==Kt.SK.ComputedPropertyName){const Kt=e.name.expression;return void B.emitExpr(ne("pxtrt::mapSetByString",[Z(i,!0),Kt,e.initializer],null))}t=e.name.kind==Kt.SK.StringLiteral?e.name.text:e.name.getText(),r=ie(e.initializer)}const n=Kt.target.isNative?Kt.ir.numlit(j(t)):Kt.ir.ptrlit(null,JSON.stringify(t)),s=[i,n,r];B.emitExpr(Kt.ir.rtcall(Kt.target.isNative?"pxtrt::mapSet":"pxtrt::mapSetByString",s))}),i;return}case Kt.SK.TypeOfExpression:return ne("pxt::typeOf",[r.expression],null);case _t.SyntaxKind.DeleteExpression:{P=r;let e,t;if(P.expression.kind==Kt.SK.PropertyAccessExpression){const Kt=P.expression;e=Kt.expression,t=Z(be(Kt.name.text))}else{if(P.expression.kind!=Kt.SK.ElementAccessExpression)throw Lt(9276,Et("expression not supported as argument to 'delete'"));{const Kt=P.expression;e=Kt.expression,t=Kt.argumentExpression}}P=tr(e);if(Xt(P))throw Lt(9277,Et("'delete' not supported on class types"));if(Zt(P))throw Lt(9277,Et("'delete' not supported on array"));return ne("pxtrt::mapDeleteByString",[e,t],null);return}default:return q(r),null}var C,U,P,L}(e);if(e.isExpr())return e;throw new Error("expecting expression")}function gt(e){var t=Ct(e);if(t.usedNodes){i=!1;for(var r of Kt.U.values(t.usedNodes))H(r);for(var n of t.usedActions)n(R);i=!0}else Ht(e)||_t.isClassDeclaration(e)?(i=!1,(b=t).usedNodes=null,b.usedActions=null,Ht(e)&&!X(e)&&le(e),N(e),i=!0):((b=t).usedNodes={},b.usedActions=[],N(e),b=null)}function N(e){mt(e,bt)}function bt(a){switch(a.kind){case Kt.SK.SourceFile:return void a.statements.forEach(N);case Kt.SK.InterfaceDeclaration:var e=a,t=e,r=e=>{e&&e.kind==Kt.SK.ClassDeclaration&&Lt(9261,Et("Interface with same name as a class not supported"))};if(r(t.symbol.valueDeclaration),t.symbol.declarations&&t.symbol.declarations.forEach(r),t.heritageClauses)for(var n of t.heritageClauses)n.token===Kt.SK.ExtendsKeyword&&Xt(tr(n.types[0]))&&Lt(9262,Et("Extending a class by an interface not supported."));return void((r=Wt(e)).autoCreate&&(A[r.autoCreate]=!0));case Kt.SK.VariableStatement:var s=a;if(s.declarationList.flags&_t.NodeFlags.Const){var i=s.parent&&s.parent.kind==Kt.SK.ModuleBlock?Yt(s.parent.parent):"?";if("config"==i||"userconfig"==i)for(var o of s.declarationList.declarations){let t=nr(o);if(o.initializer){var o=Ze(o.initializer),l=et(s,"CFG_"+t);if(null==l||0==l)throw Lt(9268,Et("can't find DAL.CFG_{0}",t));"userconfig"==i&&(t="!"+t);{c=void 0;var c={name:t,key:l,value:o};let e=Kt.U.lookup(I,c.name);if(e||(e=c,I[c.name]=e),e.value!=c.value)throw Lt(9269,Et("conflicting values for config.{0}",c.name))}}}}return void(_t.isInAmbientContext(s)||(it(s.declarationList),s.declarationList.declarations.forEach(N)));case Kt.SK.ModuleDeclaration:return void N(a.body);case Kt.SK.EnumDeclaration:return;case Kt.SK.FunctionDeclaration:case Kt.SK.Constructor:case Kt.SK.MethodDeclaration:return void Re(a);case Kt.SK.ExpressionStatement:return void lt(a.expression);case Kt.SK.Block:case Kt.SK.ModuleBlock:return st(a);case Kt.SK.VariableDeclaration:return ft(a),void Le();case Kt.SK.IfStatement:return w(t=a),e=B.mkLabel("else"),B.emitJmpZ(e,se(t.expression)),N(t.thenStatement),r=B.mkLabel("afterif"),B.emitJmp(r),B.emitLbl(e),t.elseStatement&&N(t.elseStatement),void B.emitLbl(r);case Kt.SK.WhileStatement:return w(S=a),v=E(S),B.emitLblDirect(v.cont),w(S.expression),B.emitJmpZ(v.brk,se(S.expression)),N(S.statement),B.emitJmp(v.cont),void B.emitLblDirect(v.brk);case Kt.SK.DoStatement:return w(S=a),v=E(S),B.emitLblDirect(v.cont),N(S.statement),w(S.expression),B.emitJmpZ(v.brk,se(S.expression)),B.emitJmp(v.cont),void B.emitLblDirect(v.brk);case Kt.SK.ForStatement:return(k=a).initializer&&k.initializer.kind==Kt.SK.VariableDeclarationList?(it(k.initializer),k.initializer.declarations.forEach(N)):lt(k.initializer),w(k),u=E(k),B.emitLblDirect(u.fortop),k.condition&&(w(k.condition),B.emitJmpZ(u.brk,se(k.condition))),N(k.statement),B.emitLblDirect(u.cont),lt(k.incrementor),B.emitJmp(u.fortop),void B.emitLblDirect(u.brk);case Kt.SK.ForOfStatement:k=a;if(k.initializer&&k.initializer.kind==Kt.SK.VariableDeclarationList){u=k.initializer;if(1!=u.declarations.length)q(k,"only a single variable may be used to iterate a collection");else{it(u);let e=tr(k.expression),t="",r="";if(sr(e))t="String_::charAt",r="String_::length";else{if(!Zt(e))return void q(k.expression,"cannot use for...of with this expression");t="Array_::getAt",r="Array_::length"}H(u.declarations[0]);var u=ft(u.declarations[0]),p=(Kt.U.assert(!!u||!R.finalPass),B.stackEmpty(),B.mkLocalUnnamed()),d=(B.emitExpr(p.storeByRef(ie(k.expression))),B.mkLocalUnnamed()),f=(B.emitExpr(d.storeByRef(te(0))),B.stackEmpty(),w(k),E(k)),m=(B.emitLblDirect(f.fortop),Kt.ir.rtcall(r,[p.loadCore()])),m=We("numops::lt_bool",d.load(),lr(m));B.emitJmpZ(f.brk,m),u&&B.emitExpr(u.storeByRef(Kt.ir.rtcall(t,[p.loadCore(),(m=d.loadCore(),Mt()?Kt.ir.rtcall("pxt::toInt",[m]):m)]))),Le(),N(k.statement),B.emitLblDirect(f.cont),B.emitExpr(d.storeByRef(We("numops::adds",d.load(),te(1)))),B.emitJmp(f.fortop),B.emitLblDirect(f.brk),B.emitExpr(p.storeByRef(te(void 0)))}}else q(k,"only a single variable may be used to iterate a collection");return;case Kt.SK.ContinueStatement:case Kt.SK.BreakStatement:{m=a;w(m);let r=m.label?m.label.text:null,n=m.kind==Kt.SK.BreakStatement,s=0,e=function e(t){return t?r&&t.kind==Kt.SK.LabeledStatement&&t.label.text==r?t.statement:t.kind==Kt.SK.SwitchStatement&&!r&&n||!r&&_t.isIterationStatement(t,!1)?t:(s+=pt(t),e(t.parent)):null}(m);e?(d=E(e),ct(s),m.kind==Kt.SK.ContinueStatement?_t.isIterationStatement(e,!1)?B.emitJmp(d.cont):L(m,9231,Et("continue on non-loop")):m.kind==Kt.SK.BreakStatement?B.emitJmp(d.brk):Kt.oops()):L(m,9230,Et("cannot find outer loop"));return}case Kt.SK.LabeledStatement:return p=E((f=a).statement),N(f.statement),void B.emitLblDirect(p.brk);case Kt.SK.ReturnStatement:{var h=a;w(h);let e=null,t=(h.expression?e=ie(h.expression):rr(B.action)&&(e=te(void 0)),0);for(let e=h;e&&e!=B.action;e=e.parent)t+=pt(e);ct(t),B.emitJmp(E(B.action).ret,e,Kt.ir.JmpMode.Always);return}case Kt.SK.ClassDeclaration:return(y=z(null,h=a)).isUsed&&R.usedClassInfos.indexOf(y)<0&&R.usedClassInfos.push(y),void h.members.forEach(N);case Kt.SK.PropertyDeclaration:case Kt.SK.PropertyAssignment:return void(Rt(y=a)?ft(y):y.initializer&&(y=z(tr(y.parent)),R.finalPass)&&y.isUsed&&!y.ctor&&Lt(9209,Et("class field initializers currently require an explicit constructor")));case Kt.SK.SwitchStatement:{var g=a;w(g);let s,e=E(g),i=Kt.ir.shared(ie(g.expression)),r=g.caseBlock.clauses.map(e=>{var t,r,n=B.mkLabel("switch");return e.kind==Kt.SK.CaseClause?(t=ie((r=e).expression),r=we(r.expression)?1:0,r=Kt.ir.rtcallMask(Qe("pxt::switch_eq"),r,0,[t,i]),B.emitJmp(n,r,Kt.ir.JmpMode.IfNotZero,i)):e.kind==Kt.SK.DefaultClause?(Kt.assert(!s,"!defaultLabel"),s=n):Kt.oops(),n});s?B.emitJmp(s,i):B.emitJmp(e.brk,i),g.caseBlock.clauses.forEach((e,t)=>{B.emitLbl(r[t]),e.statements.forEach(N)}),B.emitLblDirect(e.brk);return}case Kt.SK.TypeAliasDeclaration:return;case _t.SyntaxKind.TryStatement:{var b=a;const T=e=>re("pxt::beginTry",[Kt.ir.ptrlit(e.lblName,e)]);w(b);var g=B.mkLabel("catch"),x=(g.lblName="_catch_"+Ut(b),B.mkLabel("finally"));if(x.lblName="_finally_"+Ut(b),b.finallyBlock&&B.emitExpr(T(x)),b.catchClause&&B.emitExpr(T(g)),B.stackEmpty(),st(b.tryBlock),B.stackEmpty(),b.catchClause){const Kt=B.mkLabel("catchend"),T=(ct(),B.emitJmp(Kt),B.emitLbl(g),b.catchClause.variableDeclaration);if(T){ft(T);const b=ce(T);B.emitExpr(b.storeByRef(re("pxt::getThrownValue",[])))}Le(),st(b.catchClause.block),B.emitLbl(Kt)}b.finallyBlock&&(ct(),B.emitLbl(x),st(b.finallyBlock),B.emitExpr(re("pxt::endFinally",[])));return}case _t.SyntaxKind.ThrowStatement:return w(x=a),void B.emitExpr(re("pxt::throwValue",[ie(x.expression)]));case Kt.SK.DebuggerStatement:return void w(a);case Kt.SK.GetAccessor:case Kt.SK.SetAccessor:return void Re(a);case Kt.SK.ImportEqualsDeclaration:case Kt.SK.EmptyStatement:case Kt.SK.SemicolonClassElement:return;default:q(a)}var y,k,u,S,v}function xt(e){return x.procCallLocations.push(Kt.nodeLocationInfo(e))-1}},Kt.isStringType=sr;class kr{constructor(){this.procs=[],this.globals=[],this.finalPass=!1,this.writeFile=(e,t)=>{},this.usedClassInfos=[],this.numStmts=1,this.commSize=0,this.itEntries=0,this.itFullEntries=0,this.numMethods=0,this.numVirtMethods=0,this.usedChars=new Uint32Array(2048),this.explicitlyUsedIfaceMembers={},this.ifaceMemberMap={},this.strings={},this.hexlits={},this.doubles={},this.otherLiterals=[],this.codeHelpers={},this.lblNo=0}reset(){this.lblNo=0,this.otherLiterals=[],this.strings={},this.hexlits={},this.doubles={},this.numStmts=0}getTitle(){var e=this.options.name||Kt.U.lf("Untitled");return 90<=e.length?e.slice(0,87)+"...":e}addProc(e){Kt.assert(!this.finalPass,"!this.finalPass"),this.procs.push(e),e.seqNo=this.procs.length}recordHelper(e,t,r){var n=e=>{e.codeHelpers[t]||(e.codeHelpers[t]=r(e))};n(this),this.recordAction(e,n)}recordAction(e,t){e?e.usedActions&&e.usedActions.push(t):Kt.U.oops("no using ctx!")}emitLabelled(e,t,r){var n=Kt.U.lookup(t,e);return null!=n?n:(n=r+this.lblNo++,t[e]=n)}emitDouble(e){return this.emitLabelled(Kt.target.switches.numFloat?(t=e,(r=new Float32Array(1))[0]=t,Kt.U.toHex(new Uint8Array(r.buffer))):(t=e,(r=new Float64Array(1))[0]=t,Kt.U.toHex(new Uint8Array(r.buffer))),this.doubles,"_dbl");var t,r}emitString(t){if(!this.finalPass)for(let e=0;e<t.length;++e){var r=t.charCodeAt(e);128<=r&&(this.usedChars[r>>5]|=1<<(31&r))}return this.emitLabelled(t,this.strings,"_str")}emitHexLiteral(e){return this.emitLabelled(e,this.hexlits,"_hexlit")}setPerfCounters(e){if(!Kt.target.switches.profile)return[];const t=e.slice();return this.procs.forEach(e=>{e.perfCounterName&&(Kt.U.assert(Kt.target.switches.profile),e.perfCounterNo=t.length,t.push(e.perfCounterName))}),t}}function ir(e){if(e.modifiers&&e.parent.kind==Kt.SK.Constructor)for(var t of e.modifiers)if(t.kind==Kt.SK.PrivateKeyword||t.kind==Kt.SK.PublicKeyword||t.kind==Kt.SK.ProtectedKeyword)return!0;return!1}function ar(e){return e.flags&_t.TypeFlags.Union?e.types.every(e=>ar(e)):!!(e.flags&(_t.TypeFlags.NumberLike|_t.TypeFlags.EnumLike|_t.TypeFlags.BooleanLike))}Kt.Binary=kr,Kt.isCtorField=ir}}(ts=ts||{}),function(ts){var pxtc;!function(pxtc){function getTsCompilerOptions(e){var t=ts.getDefaultCompilerOptions();return t.target=ts.ScriptTarget.ES5,t.module=ts.ModuleKind.None,t.noImplicitAny=!0,t.noImplicitReturns=!0,t.allowUnreachableCode=!0,t}function nodeLocationInfo(e){var t=ts.getSourceFileOfNode(e),r=e.getStart?e.getStart():e.pos,{line:n,character:s}=ts.getLineAndCharacterOfPosition(t,r),{line:i,character:a}=ts.getLineAndCharacterOfPosition(t,e.end);return{start:r,length:e.end-r,line:n,column:s,endLine:i,endColumn:a,fileName:t.fileName}}function patchUpDiagnostics(e,t=!1){t=(e=t?e.filter(e=>5012!==e.code):e).filter(e=>1148==e.code);return(e=0<t.length?t:e).map(e=>{var t;return e.file?(t=ts.getLineAndCharacterOfPosition(e.file,e.start),1148==(t={code:e.code,start:e.start,length:e.length,line:t.line,column:t.character,messageText:ts.flattenDiagnosticMessageText(e.messageText,"\n"),category:e.category,fileName:e.file.fileName}).code&&(t.messageText=pxtc.Util.lf("all symbols in top-level scope are always exported; please use a namespace if you want to export only some")),t):{code:e.code,start:e.start,length:e.length,line:0,column:0,messageText:ts.flattenDiagnosticMessageText(e.messageText,"\n"),category:e.category,fileName:"?"}})}function py2tsIfNecessary(e){if(e.target.preferredEditor==pxt.PYTHON_PROJECT_NAME)return pxtc.transpile.pyToTs(e)}function mkCompileResult(){return{outfiles:{},diagnostics:[],success:!1,times:{}}}function storeGeneratedFiles(e,t){for(var r of e.generatedFiles||[])t.outfiles[r]=e.fileSystem[r]}function runConversionsAndStoreResults(e,t){var r=pxtc.U.cpuUs(),n=(t=t||mkCompileResult(),py2tsIfNecessary(e)),n=(storeGeneratedFiles(e,t=n?Object.assign(Object.assign({},t),{diagnostics:n.diagnostics,sourceMap:n.sourceMap,globalNames:n.globalNames}):t),e.sourceFiles||(e.sourceFiles=Object.keys(e.fileSystem)),e.sourceFiles.indexOf(pxt.MAIN_TS)),n=(0<=n&&(e.sourceFiles.splice(n,1),e.sourceFiles.push(pxt.MAIN_TS)),e.sourceFiles.indexOf(pxt.TUTORIAL_CODE_STOP));return 0<=n&&(e.sourceFiles.splice(n,1),e.sourceFiles.push(pxt.TUTORIAL_CODE_STOP)),t.times.conversions=pxtc.U.cpuUs()-r,t}function timesToMs(e){for(var t of Object.keys(e.times))e.times[t]=Math.round(e.times[t])/1e3}function buildProgram(e,s){let i={};for(var t in e.fileSystem)i[normalizePath(t)]=e.fileSystem[t];var r=getTsCompilerOptions(e),n={getSourceFile:(e,t,r)=>{e=normalizePath(e);let n="";return i.hasOwnProperty(e)?n=i[e]:r&&r("File not found: "+e),null==n&&(r("File not found: "+e),n=""),ts.createSourceFile(e,n,t,!0)},fileExists:e=>(e=normalizePath(e),i.hasOwnProperty(e)),getCanonicalFileName:e=>e,getDefaultLibFileName:()=>"no-default-lib.d.ts",writeFile:(e,t,r,n)=>{s.outfiles[e]=t},getCurrentDirectory:()=>".",useCaseSensitiveFileNames:()=>!0,getNewLine:()=>"\n",readFile:e=>(e=normalizePath(e),i[e]||""),directoryExists:e=>!0,getDirectories:()=>[]},a=e.sourceFiles.filter(e=>pxtc.U.endsWith(e,".ts"));return ts.createProgram(a,r,n)}function isPxtModulesFilename(e){return pxtc.U.startsWith(e,"pxt_modules/")}function compile(opts,service){pxtc.compilerHooks||(pxtc.compilerHooks={},opts.target.compilerExtension&&eval(opts.target.compilerExtension)),pxtc.compilerHooks.init&&pxtc.compilerHooks.init(opts,service);let startTime=pxtc.U.cpuUs(),res=mkCompileResult(),program;if(service)storeGeneratedFiles(opts,res),program=service.getProgram();else{if(runConversionsAndStoreResults(opts,res),0<res.diagnostics.length)return res;program=buildProgram(opts,res)}const entryPoint=opts.sourceFiles.filter(e=>pxtc.U.endsWith(e,".ts")).pop().replace(/.*\//,"");if(res.diagnostics=patchUpDiagnostics(program.getSyntacticDiagnostics(),opts.ignoreFileResolutionErrors),0<res.diagnostics.length)opts.forceEmit&&(pxt.debug("syntactic errors, forcing emit"),pxtc.compileBinary(program,opts,res,entryPoint));else{res.diagnostics=patchUpDiagnostics(program.getOptionsDiagnostics().concat(pxtc.Util.toArray(program.getGlobalDiagnostics())),opts.ignoreFileResolutionErrors);const semStart=pxtc.U.cpuUs(),emitStart=(0==res.diagnostics.length&&(res.diagnostics=patchUpDiagnostics(program.getSemanticDiagnostics(),opts.ignoreFileResolutionErrors)),pxtc.U.cpuUs());if(res.times["typescript-syn"]=semStart-startTime,res.times["typescript-sem"]=emitStart-semStart,res.times.typescript=emitStart-startTime,opts.ast&&(res.ast=program),opts.ast||opts.forceEmit||0==res.diagnostics.length){const e=pxtc.compileBinary(program,opts,res,entryPoint);res.times.compilebinary=pxtc.U.cpuUs()-emitStart,res.diagnostics=res.diagnostics.concat(patchUpDiagnostics(e.diagnostics))}0==res.diagnostics.length&&(res.success=!0);for(var e of opts.sourceFiles)pxtc.Util.startsWith(e,"built/")&&(res.outfiles[e.slice(6)]=opts.fileSystem[e]);res.times.all=pxtc.U.cpuUs()-startTime,pxt.tickEvent("compile",res.times)}return res}function decompile(e,t,r,n=!1){var s=e.getSourceFile(r),r=(pxtc.annotate(e,r,pxtc.target||pxt.appTarget&&pxt.appTarget.compile),pxtc.getApiInfo(e,t.jres)),r=pxtc.getBlocksInfo(r,t.bannedCategories),n={snippetMode:t.snippetMode||!1,alwaysEmitOnStart:t.alwaysDecompileOnStart,includeGreyBlockMessages:n,generateSourceMap:!!t.ast,allowedArgumentTypes:t.allowedArgumentTypes||["number","boolean","string"],errorOnGreyBlocks:!!t.errorOnGreyBlocks},[t,,]=pxtc.decompiler.buildRenameMap(e,s,{declarations:"variables",takenNames:{}});return pxtc.decompiler.decompileToBlocks(r,s,n,t)}function decompileSnippets(e,t,r=!1){const n=pxtc.getApiInfo(e,t.jres),s=pxtc.getBlocksInfo(n,t.bannedCategories),i=new pxtc.decompiler.RenameMap([]),a={snippetMode:t.snippetMode||!1,alwaysEmitOnStart:t.alwaysDecompileOnStart,includeGreyBlockMessages:r,generateSourceMap:!!t.ast,allowedArgumentTypes:t.allowedArgumentTypes||["number","boolean","string"],errorOnGreyBlocks:!!t.errorOnGreyBlocks};let o;var l=[];if(t.sourceTexts)for(let e=0;e<t.sourceTexts.length;e++){t.fileSystem[pxt.MAIN_TS]=t.sourceTexts[e],t.fileSystem[pxt.MAIN_BLOCKS]="";var c=getTSProgram(t,o);const n=c.getSourceFile(pxt.MAIN_TS),u=pxtc.decompiler.decompileToBlocks(s,n,a,i);l.push(u.outfiles[pxt.MAIN_BLOCKS]),o=c}return l}function getTSProgram(e,t){let s={},i={};for(var r in e.fileSystem)i[normalizePath(r)]=e.fileSystem[r];var n=getTsCompilerOptions(e),a={getSourceFile:(e,t,r)=>{e=normalizePath(e);let n="";return i.hasOwnProperty(e)?n=i[e]:r&&r("File not found: "+e),null==n&&(r("File not found: "+e),n=""),ts.createSourceFile(e,n,t,!0)},fileExists:e=>(e=normalizePath(e),i.hasOwnProperty(e)),getCanonicalFileName:e=>e,getDefaultLibFileName:()=>"no-default-lib.d.ts",writeFile:(e,t,r,n)=>{s[e]=t},getCurrentDirectory:()=>".",useCaseSensitiveFileNames:()=>!0,getNewLine:()=>"\n",readFile:e=>(e=normalizePath(e),i[e]||""),directoryExists:e=>!0,getDirectories:()=>[]};e.sourceFiles||(e.sourceFiles=Object.keys(e.fileSystem));let o=e.sourceFiles.filter(e=>pxtc.U.endsWith(e,".ts")),l=o.filter(e=>e!=pxt.MAIN_TS);o.length>l.length&&(o=l).push(pxt.MAIN_TS);var c=o.indexOf(pxt.TUTORIAL_CODE_STOP),c=(0<=c&&(o.splice(c,1),o.push(pxt.TUTORIAL_CODE_STOP)),ts.createProgram(o,n,a,t));return pxtc.annotate(c,pxt.MAIN_TS,pxtc.target||pxt.appTarget&&pxt.appTarget.compile),c}function normalizePath(e){e=e.replace(/\\/g,"/");const t=[];return e.split("/").forEach(e=>{".."===e&&t.length?t.pop():"."!==e&&t.push(e)}),t.join("/")}pxtc.getTsCompilerOptions=getTsCompilerOptions,pxtc.nodeLocationInfo=nodeLocationInfo,pxtc.patchUpDiagnostics=patchUpDiagnostics,pxtc.py2tsIfNecessary=py2tsIfNecessary,pxtc.storeGeneratedFiles=storeGeneratedFiles,pxtc.runConversionsAndStoreResults=runConversionsAndStoreResults,pxtc.timesToMs=timesToMs,pxtc.isPxtModulesFilename=isPxtModulesFilename,pxtc.compile=compile,pxtc.decompile=decompile,pxtc.decompileSnippets=decompileSnippets,pxtc.getTSProgram=getTSProgram}(pxtc=ts.pxtc||(ts.pxtc={}))}(ts=ts||{}),function(p){{var e=p.elf||(p.elf={});const d=["type","offset","vaddr","paddr","filesz","memsz","flags","align"],f=p.HF2.read32,m=p.HF2.read16;e.parse=function(i){1179403647!=f(i,0)&&p.U.userError("no magic"),1!=i[4]&&p.U.userError("not 32 bit"),1!=i[5]&&p.U.userError("not little endian"),1!=i[6]&&p.U.userError("bad version"),2!=m(i,16)&&p.U.userError("wrong object type"),40!=m(i,18)&&p.U.userError("not ARM");let a=f(i,28),o=(f(i,32),0==a&&p.U.userError("expecting program headers"),m(i,42)),e=m(i,44),t=p.U.range(e).map(e=>{var t,r=a+e*o,n={},e=r;for(t of d)n[t]=f(i,r),r+=4;var s=n;return s._filepos=e,s}),r=i.length+1;for(;15&r;)r++;let n=0;for(var s of t)1==s.type&&(n=Math.max(n,s.vaddr+s.memsz));let l=(n+4096-1&-4096)+(4095&r),c=-1;for(var u of t)4==u.type&&(c=u._filepos);return{imageMemStart:l,imageFileStart:r,phOffset:c,template:i}},e.patch=function(t,r){var n=new Uint8Array(t.imageFileStart+r.length);n.fill(0),p.U.memcpy(n,0,t.template),p.U.memcpy(n,t.imageFileStart,r);{var s=n,i={_filepos:t.phOffset,type:1,offset:t.imageFileStart,vaddr:t.imageMemStart,paddr:t.imageMemStart,filesz:r.length,memsz:r.length,flags:5,align:4096},a;let e=i._filepos;for(a of d)p.HF2.write32(s,e,i[a]||0),e+=4}return n}}}(pxt=pxt||{}),function(l){{var e=l.esp||(l.esp={});const u=l.HF2.read32,p=l.HF2.read16,d=[{name:"esp32",chipId:0,memmap:[{from:0,to:65536,id:"PADDING"},{from:1061158912,to:1065353216,id:"DROM"},{from:1065353216,to:1069547520,id:"EXTRAM_DATA"},{from:1073217536,to:1073225728,id:"RTC_DRAM"},{from:1073283072,to:1073741824,id:"BYTE_ACCESSIBLE"},{from:1073405952,to:1073741824,id:"DRAM"},{from:1073610752,to:1073741820,id:"DIRAM_DRAM"},{from:1073741824,to:1074200576,id:"IROM"},{from:1074200576,to:1074233344,id:"CACHE_PRO"},{from:1074233344,to:1074266112,id:"CACHE_APP"},{from:1074266112,to:1074397184,id:"IRAM"},{from:1074397184,to:1074528252,id:"DIRAM_IRAM"},{from:1074528256,to:1074536448,id:"RTC_IRAM"},{from:1074593792,to:1077936128,id:"IROM"},{from:1342177280,to:1342185472,id:"RTC_DATA"}]},{name:"esp32-s2",chipId:2,memmap:[{from:0,to:65536,id:"PADDING"},{from:1056964608,to:1073217536,id:"DROM"},{from:1062207488,to:1073217536,id:"EXTRAM_DATA"},{from:1073340416,to:1073348608,id:"RTC_DRAM"},{from:1073340416,to:1073741824,id:"BYTE_ACCESSIBLE"},{from:1073340416,to:1074208768,id:"MEM_INTERNAL"},{from:1073414144,to:1073741824,id:"DRAM"},{from:1073741824,to:1073848576,id:"IROM_MASK"},{from:1073872896,to:1074200576,id:"IRAM"},{from:1074200576,to:1074208768,id:"RTC_IRAM"},{from:1074266112,to:1082130432,id:"IROM"},{from:1342177280,to:1342185472,id:"RTC_DATA"}]},{name:"esp32-s3",chipId:4,memmap:[{from:0,to:65536,id:"PADDING"},{from:1006632960,to:1023410176,id:"DROM"},{from:1023410176,to:1040187392,id:"EXTRAM_DATA"},{from:1611653120,to:1611661312,id:"RTC_DRAM"},{from:1070104576,to:1070596096,id:"BYTE_ACCESSIBLE"},{from:1070104576,to:1077813248,id:"MEM_INTERNAL"},{from:1070104576,to:1070596096,id:"DRAM"},{from:1073741824,to:1073848576,id:"IROM_MASK"},{from:1077346304,to:1077805056,id:"IRAM"},{from:1611653120,to:1611661312,id:"RTC_IRAM"},{from:1107296256,to:1115684864,id:"IROM"},{from:1342177280,to:1342185472,id:"RTC_DATA"}]},{name:"esp32-c3",chipId:5,memmap:[{from:0,to:65536,id:"PADDING"},{from:1006632960,to:1015021568,id:"DROM"},{from:1070071808,to:1070465024,id:"DRAM"},{from:1070104576,to:1070596096,id:"BYTE_ACCESSIBLE"},{from:1072693248,to:1072824320,id:"DROM_MASK"},{from:1073741824,to:1074135040,id:"IROM_MASK"},{from:1107296256,to:1115684864,id:"IROM"},{from:1077395456,to:1077805056,id:"IRAM"},{from:1342177280,to:1342185472,id:"RTC_IRAM"},{from:1342177280,to:1342185472,id:"RTC_DRAM"},{from:1611653120,to:1611661312,id:"MEM_INTERNAL2"}]}];function o(e){return`0x${e.addr.toString(16)} 0x${e.data.length.toString(16)} bytes; ${e.isDROM?"drom ":""}${e.isMapped?"mapped ":""}${l.U.toHex(e.data.slice(0,20))}...`}function t(t){if(233!=t[0])throw new Error("ESP: invalid magic: "+t[0]);let r=24;const n=p(t,12),s=d.find(e=>e.chipId==n);if(!s)throw new Error("ESP: unknown chipid: "+n);var i={header:t.slice(0,r),chipName:s.name,segments:[]},a=t[1];for(let e=0;e<a;++e){const p=u(t,r),d=u(t,r+4),n=(r+=8,t.slice(r,r+d));if(n.length!=d)throw new Error("too short file");if(r+=d,!o(p,"PADDING")){const s=i.segments.filter(e=>e.addr+e.data.length==p)[0];s?s.data=l.U.uint8ArrayConcat([s.data,n]):i.segments.push({addr:p,isMapped:o(p,"DROM")||o(p,"IROM"),isDROM:o(p,"DROM"),data:n})}}return i;function o(t,r){return s.memmap.some(e=>e.id==r&&e.from<=t&&t<=e.to)}}function c(e){e=l.U.flatClone(e);return e.segments=e.segments.map(l.U.flatClone),e}e.toBuffer=function(e,t=!0){let r=(e=function(t){const r=65535,n=((t=c(t)).segments.sort((e,t)=>e.addr-t.addr),l.debug("esp padding:\n"+t.segments.map(o).join("\n")+"\n"),t.segments.filter(e=>e.isMapped)),s=t.segments.filter(e=>!e.isMapped);t.segments=[];let i=t.header.length;for(const t of n){const n=t.addr+t.data.length&r;if(n<36){const r=new Uint8Array(36-n);t.data=l.U.uint8ArrayConcat([t.data,r])}}for(;0<n.length;){let e=n[0];const s=function(e){let t=(e.addr-8&r)-i&r;return 0==t?0:((t-=8)<0&&(t+=65536),t)}(e);if(0<s)e=a(s);else{if((i+8&r)!=(e.addr&r))throw new Error(`pad oops 0 ${i}+8 != ${e.addr} (mod mask)`);n.shift()}if(t.segments.push(e),3&(i+=8+e.data.length))throw new Error("pad oops 1")}return t.segments=t.segments.concat(s),l.debug("esp padded:\n"+t.segments.map(o).join("\n")+"\n"),t;function a(e){var t,r;return!s.length||e<=8?{addr:0,isMapped:!1,isDROM:!1,data:new Uint8Array(e)}:(r={addr:(t=s[0]).addr,isMapped:t.isMapped,isDROM:t.isDROM,data:t.data.slice(0,e)},t.data=t.data.slice(e),t.addr+=r.data.length,0==t.data.length&&s.shift(),r)}}(e)).header.length;for(const l of e.segments)r+=8+l.data.length;r=r+16&-16;let n=new Uint8Array(r),s=(n.set(e.header),n[1]=e.segments.length,e.header.length),i=239;for(const t of e.segments){l.HF2.write32(n,s,t.addr),l.HF2.write32(n,s+4,t.data.length),n.set(t.data,s+8),s+=8+t.data.length;for(let e=0;e<t.data.length;++e)i^=t.data[e]}if(n[n.length-1]=i,t){n[23]=1;const e=ts.pxtc.BrowserImpl.sha256buffer(n);n=l.U.uint8ArrayConcat([n,l.U.fromHex(e)])}else n[23]=0;return n},e.parseBuffer=t,e.parseB64=function(e){return t(l.U.stringToUint8Array(atob(e.join(""))))},e.cloneStruct=c}}(pxt=pxt||{}),function(d){{var x=d.pxtc||(d.pxtc={}),e;let g;(e=g=g||{})[e.None=0]="None",e[e.Whitespace=1]="Whitespace",e[e.Identifier=2]="Identifier",e[e.Keyword=3]="Keyword",e[e.Operator=4]="Operator",e[e.CommentLine=5]="CommentLine",e[e.CommentBlock=6]="CommentBlock",e[e.NewLine=7]="NewLine",e[e.Literal=8]="Literal",e[e.Tree=9]="Tree",e[e.Block=10]="Block",e[e.EOF=11]="EOF";let p,b=d.SyntaxKind;function y(e){switch(e){case b.CommaToken:return 1;case b.EqualsToken:case b.PlusEqualsToken:case b.MinusEqualsToken:case b.AsteriskEqualsToken:case b.AsteriskAsteriskEqualsToken:case b.SlashEqualsToken:case b.PercentEqualsToken:case b.LessThanLessThanEqualsToken:case b.GreaterThanGreaterThanEqualsToken:case b.GreaterThanGreaterThanGreaterThanEqualsToken:case b.AmpersandEqualsToken:case b.BarEqualsToken:case b.CaretEqualsToken:return 1;case b.QuestionToken:case b.ColonToken:case b.BarBarToken:case b.AmpersandAmpersandToken:case b.BarToken:case b.CaretToken:case b.AmpersandToken:return 1;case b.EqualsEqualsToken:case b.ExclamationEqualsToken:case b.EqualsEqualsEqualsToken:case b.ExclamationEqualsEqualsToken:return 1;case b.LessThanToken:case b.GreaterThanToken:case b.LessThanEqualsToken:case b.GreaterThanEqualsToken:case b.InstanceOfKeyword:case b.InKeyword:case b.AsKeyword:return 1;case b.LessThanLessThanToken:case b.GreaterThanGreaterThanToken:case b.GreaterThanGreaterThanGreaterThanToken:return 1;case b.PlusToken:case b.MinusToken:return 1;case b.AsteriskToken:case b.SlashToken:case b.PercentToken:case b.AsteriskAsteriskToken:case b.DotToken:return 1;default:return}}function f(e,t){for(;e[t]&&e[t].kind==g.Whitespace;)t++;return t}function k(){return{kind:g.EOF,synKind:b.EndOfFileToken,pos:0,lineNo:0,text:""}}function S(e,t){return{kind:g.Whitespace,synKind:b.WhitespaceTrivia,pos:e.pos-t.length,lineNo:e.lineNo,text:t}}function v(e){return{kind:g.Block,synKind:b.OpenBraceToken,pos:e[0].pos,lineNo:e[0].lineNo,stmts:[{tokens:e}],text:"{",endToken:null}}function T(n,s,i=null){let a,o=[],l=0,c=!1;for(n=n.concat([k()]);n[l].kind!=g.EOF;){var e=l;h(),x.Util.assert(l>e,"Error at "+n[l].text),function(e){if(0!=(e=s?I(e):e).length){if(e.forEach(u),e=function r(n){let s=[],i=0;for(;i<n.length;)if(n[i].blockSpanLength){let e=n.slice(i,i+n[i].blockSpanLength),t=!!e[0].blockSpanIsVirtual;delete e[0].blockSpanLength,delete e[0].blockSpanIsVirtual,i+=e.length,e=r(e),t?s.push((a=e,{kind:g.Tree,synKind:b.WhitespaceTrivia,pos:a[0].pos,lineNo:a[0].lineNo,children:a,endToken:null,text:""})):(s.push(S(e[0]," ")),s.push(v(I(e))))}else s.push(n[i++]);var a;return s}(e),s&&0<o.length){var t=o[o.length-1].tokens[0].synKind,r=e[0].synKind;if(t==b.IfKeyword&&r==b.ElseKeyword||t==b.TryKeyword&&r==b.CatchKeyword||t==b.TryKeyword&&r==b.FinallyKeyword||t==b.CatchKeyword&&r==b.FinallyKeyword)return e.unshift(S(e[0]," ")),x.Util.pushRange(o[o.length-1].tokens,e)}o.push({tokens:e})}}(n.slice(e,l))}return o;function u(e){e.kind==g.Tree&&(e.children=x.Util.concat(T(e.children,!1,e).map(e=>e.tokens)))}function p(){for(;;)switch(l++,n[l].kind){case g.Whitespace:case g.CommentBlock:case g.CommentLine:case g.NewLine:break;default:return}}function d(){for(;n[l].kind==g.Whitespace;)l++;n[l].kind==g.NewLine&&l++}function f(){x.Util.assert(n[l].synKind==b.OpenBraceToken);var e=n[l],t=(x.Util.assert(e.kind==g.Tree),n[l]);t.stmts=T(e.children,!0,a),delete e.children,t.kind=g.Block,l++,c=!0}function m(){var e=l+1;p(),n[l].synKind==b.OpenBraceToken?(f(),d()):(h(),n[e].blockSpanLength=l-e)}function h(){for(;;){let e=n[l],t=l;if(a=e,c=!1,e.kind==g.EOF)return;if(s&&e.synKind==b.SemicolonToken)return l++,d();if(e.synKind==b.EqualsGreaterThanToken){if(p(),n[l].synKind==b.OpenBraceToken){f();continue}{var r=l;h();let e=l;for(;n[e].kind==g.NewLine;)e--;return n[r].blockSpanLength=e-r,n[r].blockSpanIsVirtual=!0}}if(s&&y(e.synKind)){r=l;if(p(),!function(e){if(e)switch(e.synKind){case b.IfKeyword:case b.ElseKeyword:case b.LetKeyword:case b.ConstKeyword:case b.VarKeyword:case b.DoKeyword:case b.WhileKeyword:case b.SwitchKeyword:case b.CaseKeyword:case b.DefaultKeyword:case b.ForKeyword:case b.ReturnKeyword:case b.BreakKeyword:case b.ContinueKeyword:case b.TryKeyword:case b.CatchKeyword:case b.FinallyKeyword:case b.DeleteKeyword:case b.FunctionKeyword:case b.ClassKeyword:case b.YieldKeyword:case b.DebuggerKeyword:return 1;default:return}}(n[l]))continue;l=r}if(s&&e.kind==g.NewLine){if(p(),y((e=n[l]).synKind)&&e.synKind!=b.PlusToken&&e.synKind!=b.MinusToken)continue;return l=t+1}if(e.synKind==b.OpenBraceToken&&i&&i.synKind==b.ClassKeyword){let e=l-1;for(;0<=e&&n[e].kind==g.Whitespace;)e--;if(e<0||n[e].synKind!=b.EqualsToken)return l--,m()}switch(x.Util.assert(t==l),e.synKind){case b.ForKeyword:case b.WhileKeyword:case b.IfKeyword:case b.CatchKeyword:if(p(),n[l].synKind!=b.OpenParenToken)continue;return m();case b.DoKeyword:if(m(),l--,p(),n[l].synKind!=b.WhileKeyword)return;l++;continue;case b.ElseKeyword:if(p(),n[l].synKind==b.IfKeyword)continue;return l=t,m();case b.TryKeyword:case b.FinallyKeyword:return m();case b.ClassKeyword:case b.NamespaceKeyword:case b.ModuleKeyword:case b.InterfaceKeyword:case b.FunctionKeyword:for(;;)switch(l++,n[l].kind){case g.EOF:return;case g.Tree:if(n[l].synKind==b.OpenBraceToken)return l--,void m()}return}x.Util.assert(!c,"forgot continue/return after expectBlock"),l++}}}function t(e){return e&&(e.kind==g.Whitespace||e.kind==g.NewLine)}function m(t){let r=[],n=!1;for(let e=0;e<t.length;++e)t[e=n?f(t,e):e]&&(r.push(t[e]),n=t[e].kind==g.NewLine);return r}function I(e){for(e=e.slice(0);t(e[0]);)e.shift();for(;t(e[e.length-1]);)e.pop();return e}function h(s,e){if(e.synKind==b.NoSubstitutionTemplateLiteral&&/^`[\s\.#01]*`$/.test(e.text)){var i=e.text.slice(1,e.text.length-1).split("\n").map(e=>e.replace(/\s/g,"")).filter(e=>!!e);if(!(i.length<4||5<i.length)){let r=Math.floor((Math.max(...i.map(e=>e.length))+2)/5),n=(r<=0&&(r=1),"`\n");for(let t=0;t<5;++t){let e=i[t]||"";for(;e.length<5*r;)e+=".";e=(e=(e=e.replace(/0/g,".")).replace(/1/g,"#")).replace(/...../g,e=>"/"+e),n+=s+e.replace(/./g,e=>" "+e).replace(/\//g," ").slice(3)+"\n"}n+=s+"`",e.text=n}}}x.toStr=function e(t){return Array.isArray(t)?"[[ "+t.map(e).join("  ")+" ]]":"string"==typeof t.text?JSON.stringify(t.text):t+""},x.format=function(e,t){let r=T(function(n){let s=[];s.push({synKind:b.EndOfFileToken,token:{children:[]}});var i,a;for(let r=0;r<n.length;++r){let e=n[r],t=s[s.length-1];if(t.token.children.push(e),e.kind===g.Operator)switch(e.synKind){case b.OpenBraceToken:case b.OpenParenToken:case b.OpenBracketToken:a=(i=e).synKind+1,i.children=[],i.kind=g.Tree,s.push({synKind:a,token:i});break;case b.CloseBraceToken:case b.CloseParenToken:case b.CloseBracketToken:for(t.token.children.pop();;){if((t=s.pop()).synKind==e.synKind){t.token.endToken=e;break}if(0==s.length||t.synKind==b.CloseBraceToken){s.push(t);break}}}}return s[0].token.children}(function(r,n){let s=[],e=!0,i=1;for(let t=0;t<r.length;++t){if(e){var a=t;if(r[t=f(r,t)].kind==g.NewLine){let e=!1;0<=n&&r[t].pos>=n&&(n=-1,e=!0),s.push({text:"",kind:g.CommentLine,pos:r[t].pos,lineNo:i,synKind:b.SingleLineCommentTrivia,isCursor:e})}else t=a}s.push(r[t]),r[t].lineNo=i,r[t].kind==g.NewLine?(e=!0,i++):e=!1,0<=n&&r[t].pos>=n&&(n=-1)}return s}(function(e){p=e;let r=d.createScanner(d.ScriptTarget.Latest,!1,d.LanguageVariant.Standard,e,e=>{var t=r.getTextPos();console.log("scanner error",t,e.message)}),t=[],n=0,s=-1;for(;;){let e=r.scan();e==b.CloseBraceToken&&n==s&&(s=-1,e=r.reScanTemplateToken());var i={kind:function(e){switch(e){case b.EndOfFileToken:return g.EOF;case b.SingleLineCommentTrivia:return g.CommentLine;case b.MultiLineCommentTrivia:return g.CommentBlock;case b.NewLineTrivia:return g.NewLine;case b.WhitespaceTrivia:return g.Whitespace;case b.ShebangTrivia:case b.ConflictMarkerTrivia:return g.CommentBlock;case b.NumericLiteral:case b.StringLiteral:case b.RegularExpressionLiteral:case b.NoSubstitutionTemplateLiteral:case b.TemplateHead:case b.TemplateMiddle:case b.TemplateTail:return g.Literal;case b.Identifier:return g.Identifier;default:return e<b.Identifier?g.Operator:g.Keyword}}(e=(e=e==b.SlashEqualsToken&&(i=r.reScanSlashToken())==b.RegularExpressionLiteral?i:e)==b.GreaterThanToken?r.reScanGreaterToken():e),synKind:e,lineNo:0,pos:r.getTokenPos(),text:r.getTokenText()};if(e==b.OpenBraceToken&&n++,e==b.CloseBraceToken&&--n<0&&(n=-1e7),t.push(i),e!=b.TemplateHead&&e!=b.TemplateMiddle||(s=n),i.kind==g.EOF)break}return{tokens:t,braceBalance:n}}(e).tokens,t)),!0),a="",o="",n=-1,s=0;return r.forEach(c),r.forEach(e=>e.tokens.forEach(i)),-1==n&&(n=o.length),{formatted:o,pos:n};function i(e){var t;e.kind==g.Tree?((t=e).synKind,b.OpenBraceToken,t.children.forEach(i)):e.kind==g.Block&&e.stmts.forEach(e=>e.tokens.forEach(i))}function l(e,t){s==e.lineNo?t():(s=e.lineNo,e=a,a+="    ",t(),a=e)}function c(e){let t=m(e.tokens);(1!=t.length||t[0].isCursor||""!=t[0].text)&&(o+=a,l(t[0],()=>{!function s(i){i=function(t){let n=[],s=0,i=k();for(t=t.concat([k()]);s<t.length;){s=f(t,s);let r=t[s];if(r.kind==g.EOF)break;let e=f(t,s+1);if(r.kind==g.NewLine&&t[e].synKind==b.OpenBraceToken)s=e;else{let e=!0,t=0==n.length?(a=r,{kind:g.NewLine,synKind:b.NewLineTrivia,pos:a.pos,lineNo:a.lineNo,text:"\n"}):n[n.length-1];switch(t.synKind){case b.ExclamationToken:case b.TildeToken:case b.DotToken:e=!1;break;case b.PlusToken:case b.MinusToken:case b.PlusPlusToken:case b.MinusMinusToken:t.isPrefix&&(e=!1)}switch(r.synKind){case b.DotToken:case b.CommaToken:case b.NewLineTrivia:case b.ColonToken:case b.SemicolonToken:case b.OpenBracketToken:e=!1;break;case b.PlusPlusToken:case b.MinusMinusToken:t.kind!=g.Tree&&t.kind!=g.Identifier&&t.kind!=g.Keyword||(e=!1);case b.PlusToken:case b.MinusToken:i.kind!=g.EOF&&!y(i.synKind)&&i.synKind!=b.SemicolonToken||(r.isPrefix=!0);break;case b.OpenParenToken:if(t.kind==g.Identifier&&(e=!1),t.kind==g.Keyword)switch(t.synKind){case b.IfKeyword:case b.ForKeyword:case b.WhileKeyword:case b.SwitchKeyword:case b.ReturnKeyword:case b.ThrowKeyword:case b.CatchKeyword:break;default:e=!1}}(e=t.kind==g.NewLine?!1:e)&&n.push(S(r," ")),n.push(r),r.kind!=g.NewLine&&(i=r),s++}}var a;return n}(i);for(let n=0;n<i.length;++n){let r=i[n];switch(h(a,r),u(r),r.kind){case g.Tree:let e=r;l(r,()=>{s(m(e.children))}),e.endToken&&u(e.endToken);break;case g.Block:let t=r;0==t.stmts.length?o+=" ":(o+="\n",t.stmts.forEach(c),o+=a.slice(4)),t.endToken?u(t.endToken):o+="}";break;case g.NewLine:i[n+1]&&i[n+1].kind==g.CommentLine&&""==i[n+1].text&&!i[n+1].isCursor||(n==i.length-1?o+=a.slice(4):o+=a);break;case g.Whitespace:}}}(t)}),"\n"==o[o.length-1])||(o+="\n")}function u(e){-1==n&&e.pos+e.text.length>=t&&(n=o.length+(t-e.pos)),o+=e.text}}}}(ts=ts||{}),function(m){{var k=m.pxtc||(m.pxtc={});let b;function S(n,s){if(s.packedSource){let e=n.currPtr+4096&-256,r=new Uint8Array(256);for(let t=0;t<s.packedSource.length;t+=256){for(let e=0;e<256;++e)r[e]=s.packedSource.charCodeAt(t+e);k.UF2.writeBytes(n,e,r,k.UF2.UF2_FLAG_NOFLASH),e+=256}}}{var a=b=k.hexfile||(k.hexfile={});a.asmTotalSource="";let o={},i=[],y={commBase:0,funcInfo:{},codeStartIdx:-1,codePaddingSize:0,sha:null,codeStartAddrPadded:void 0,hexlines:void 0,jmpStartAddr:void 0,jmpStartIdx:void 0,codeStartAddr:void 0,elfInfo:void 0,espInfo:void 0};function v(e){let t="",r=0;for(;r<e.length;r+=2)t=e[r]+e[r+1]+t;return k.assert(r==e.length),t}function h(e){if(!(e=e.replace(/^[\s:]/,"")))return[];let t=[];if(e.replace(/([a-f0-9][a-f0-9])/gi,e=>(t.push(parseInt(e,16)),"")))throw k.oops("bad bytes "+e);return t}function g(e){return e.flashCodeAlign||1024}a.getCommBase=function(){return y.commBase},a.getStartAddress=function(){return y.codeStartAddrPadded},a.setupInlineAssembly=function(e){o={};var t,r=e.sourceFiles.filter(e=>k.U.endsWith(e,".asm"));a.asmTotalSource="";let n=0;for(t of r){var s=e.fileSystem[t],s=(s.replace(/^\s*(\w+):/gm,(e,t)=>(o[t]=!0,"")),".section code\n@stackmark func\n@scope user"+n+++"\n"+s+"\n@stackempty func\n@scope\n");a.asmTotalSource+=s}},a.parseHexBytes=h,a.parseHexRecord=function(e){e=h(e);return{len:e[0],addr:e[1]<<8|e[2],type:e[3],data:e.slice(4,e.length-1),checksum:e[e.length-1]}},a.flashCodeAlign=g;const N="0108010842424242010801083ed8e98d";function l(e){return y.funcInfo[e]}function T(){let e=y.sha?y.sha.slice(0,16):"";for(;e.length<16;)e+="0";return e.toUpperCase()}function I(e){let t=0,r=":";return e.forEach(e=>t+=e),e.push(255&-t),e.forEach(e=>r+=("0"+e.toString(16)).slice(-2)),r.toUpperCase()}a.setupFor=function(o,r){if(!(y=i.find(e=>e.sha==r.sha))){y={commBase:0,funcInfo:{},codeStartIdx:-1,codePaddingSize:0,sha:null,codeStartAddrPadded:void 0,hexlines:void 0,jmpStartAddr:void 0,jmpStartIdx:void 0,codeStartAddr:void 0,elfInfo:void 0,espInfo:void 0},(i=10<i.length?[]:i).push(y);let a=r.functions;y.commBase=r.commBase||0,y.sha=r.sha;const m=r.hexinfo.hex;if(y.hexlines=m,k.target.nativeType==k.NATIVE_TYPE_VM){y.codeStartAddr=0,y.codeStartAddrPadded=0,y.jmpStartAddr=-1,y.jmpStartIdx=-1;for(var e of a)y.funcInfo[e.name]=e,e.value=16777215;if(k.target.useESP){const o=pxt.esp.parseB64(m),n=k.U.fromHex(N),i=(t,r)=>{for(let e=0;e<n.length;++e)if(t[r+e]!=n[e])return!1;return!0},v=o.segments.filter(e=>e.isDROM);k.U.assert(1==v.length);let t=!1;const g=v[0];y.codeStartAddr=g.addr+g.data.length,y.codeStartAddrPadded=y.codeStartAddr+255&-256,y.codePaddingSize=y.codeStartAddrPadded-y.codeStartAddr,pxt.debug(`user code start: 0x${y.codeStartAddrPadded.toString(16)}; dromlen=${g.data.length} pad=`+y.codePaddingSize);for(let e=0;e<g.data.length;e+=32)if(i(g.data,e)){t=!0;const k=e+=n.length;for(var s of r.vmPointers||[])"0"!=s&&(s=s.replace(/^&/,""),y.funcInfo[s]={name:s,argsFmt:[],value:pxt.HF2.read32(g.data,e)},e+=4);pxt.HF2.write32(g.data,k,y.codeStartAddrPadded);break}k.U.assert(t||0==(r.vmPointers||[]).length),y.espInfo=o,y.codeStartAddrPadded=0}}else if(m.length<=2){const o=k.U.fromHex(m[0]);if(o[2]<=2&&96==o[3]){const k=1610612736,r=4096,e=o.length+4096-1&-4096;y.elfInfo={template:o,imageMemStart:1610612736+e,imageFileStart:e,phOffset:-1e3}}else y.elfInfo=pxt.elf.parse(o);y.codeStartAddr=y.elfInfo.imageMemStart,y.codeStartAddrPadded=y.elfInfo.imageMemStart;var t=m[0].indexOf(N);t<0&&k.oops("no jmp table in elf"),y.jmpStartAddr=t/2,y.jmpStartIdx=-1,d(m[0].slice(t+32,t+32+8*a.length+16)),void f()}else{var n,l=m;for(let e=0;e<l.length;++e)"2"==l[e][8]&&(n=/^:02....02(....)..$/.exec(l[e]),k.U.assert(!!n),n=16*parseInt(n[1],16),k.U.assert(0==(65535&n)),l[e]=I([2,0,0,4,0,n>>16]));let e=0,t="0000",s=0,i=0;y.codeStartAddr=0;for(var c=()=>{if(!y.codeStartAddr){var e=h(m[i]),t=16-(s+e[0]&15)&15;if(t)if(15&e[2]){var r=s+e[0],n=[t,r>>8,255&r,0];for(let e=0;e<t;++e)n.push(0);i++,m.splice(i,0,I(n)),y.codeStartAddr=r+t}else{if(16!=e[0]){for(e.pop(),e[0]=16;e.length<20;)e.push(0);m[i]=I(e)}y.codeStartAddr=s+16}else y.codeStartAddr=s+e[0];y.codeStartIdx=i+1;r=g(o),r=(y.codeStartAddrPadded=(y.codeStartAddr&~(r-1))+r,y.codeStartAddrPadded-y.codeStartAddr);k.assert(0==(15&r)),y.codePaddingSize=r}};e<m.length;++e){var u=/:02000004(....)/.exec(m[e]);u&&(t=u[1]),(u=/^:..(....)00/.exec(m[e]))&&(u=parseInt(t+u[1],16),!o.flashUsableEnd&&s&&65536<u-s&&c(),o.flashUsableEnd&&u>=o.flashUsableEnd&&c(),i=e,s=u),/^:00000001/.test(m[e])&&c(),/^:10....000108010842424242010801083ED8E98D/.exec(m[e])&&(y.jmpStartAddr=s,y.jmpStartIdx=e)}pxt.debug(`code start: ${y.codeStartAddrPadded}, jmptbl: `+y.jmpStartAddr),y.jmpStartAddr||k.oops("No hex start"),y.codeStartAddr||k.oops("No hex end"),y.funcInfo={};for(let e=y.jmpStartIdx+1;e<m.length;++e){var p=/^:..(....)00(.{4,})/.exec(m[e]);if(p&&(d(p[2]),0==a.length))break}function d(r){for(var n=o.shortPointers?4:8;r.length>=n;){let e=r.slice(0,n),t=parseInt(v(e),16);r=r.slice(n);var s=a.shift();if(!s)break;y.funcInfo[s.name]=s,t||k.U.oops("No value for "+s.name+" / "+e),0==s.argsFmt.length?t^=1:o.runtimeIsARM||o.nativeType!=k.NATIVE_TYPE_THUMB||1&t||k.U.oops("Non-thumb addr for "+s.name+" / "+e),s.value=t}}function f(){a.length&&k.oops("premature EOF in hex file; missing: "+a.map(e=>e.name).join(", "))}f()}}},a.validateShim=function(e,t,r,n,s){if("TD_ID"!=t&&"TD_NOOP"!=t&&"ENUM_GET"!=t&&!k.U.lookup(o,t)){var i=e+`(...) (shim=${t})`,a=l(t);if(a){n?"V"==a.argsFmt[0]&&k.U.userError("expecting function for "+i):"V"!=a.argsFmt[0]&&k.U.userError("expecting procedure for "+i);for(let e=0;e<s.length;++e)a.argsFmt[e+1]||k.U.userError("excessive parameters passed to "+i);s.length!=a.argsFmt.length-1&&k.U.userError(`not enough arguments for ${i} (got ${s.length}; fmt=${a.argsFmt.join(",")})`)}else k.U.userError("function not found: "+i)}},a.lookupFunc=l,a.lookupFunctionAddr=function(e){return"_pxt_comm_base"==e?y.commBase:(e=l(e))?e.value:null},a.hexTemplateHash=T,a.hexPrelude=function(){return`    .startaddr 0x${y.codeStartAddrPadded.toString(16)}
`},a.hexBytes=I,a.patchHex=function(r,n,e,t){let s=y.hexlines.slice(0,y.codeStartIdx);r.target.useESP||(u=2*n.length+7>>3,k.assert(u<64e3,"program too large, bytes: "+2*n.length),n[17]=u,n[20]=r.commSize);let i=[];for(let e=0;e<y.codePaddingSize>>1;++e)i.push(0);n=i.concat(n);let a=0;function o(t,e){var r=[16,e>>8&255,255&e,0];for(let e=0;e<8;++e)r.push(255&(t[a]||0)),r.push((t[a]||0)>>>8),a++;return r}var l=[16912,0,65535&y.codeStartAddrPadded,y.codeStartAddrPadded>>>16],c=T();for(let e=0;e<4;++e)l.push(parseInt(v(c.slice(4*e,4*e+4)),16));var u,p=t?k.UF2.newBlockFile(k.target.uf2Family):null;if(y.elfInfo){var d=new Uint8Array(2*n.length);for(let e=0;e<n.length;++e)pxt.HF2.write16(d,2*e,n[e]);var f=pxt.elf.patch(y.elfInfo,d);for(let e=0;e<l.length;++e)pxt.HF2.write16(f,2*e+y.jmpStartAddr,l[e]);if(!p||r.target.switches.rawELF)return[k.U.uint8ArrayToString(f)];{let e=r.options.name||"pxt";return e=e.replace(/[^a-zA-Z0-9\-\.]+/g,"_"),p.filename="Projects/"+e+".elf",k.UF2.writeBytes(p,0,f),[k.UF2.serializeFile(p)]}}if(y.espInfo){const e=pxt.esp.cloneStruct(y.espInfo),v=e.segments.find(e=>e.isDROM);let t=v.data.length;const s=new Uint8Array(t+2*n.length+255&-256);s.set(v.data);for(let e=0;e<n.length;++e)pxt.HF2.write16(s,t,n[e]),t+=2;v.data=s;const i=pxt.esp.toBuffer(e);return p?(k.UF2.writeBytes(p,0,i),S(p,r),[k.UF2.serializeFile(p)]):[k.U.uint8ArrayToString(i)]}if(p){if(k.UF2.writeHex(p,s),k.UF2.writeBytes(p,y.jmpStartAddr,o(l,y.jmpStartIdx).slice(4)),r.checksumBlock){var m,h=[];for(m of r.checksumBlock)h.push(255&m,m>>8);k.UF2.writeBytes(p,r.target.flashChecksumAddr,h)}}else s[y.jmpStartIdx]=I(o(l,y.jmpStartAddr)),r.checksumBlock&&k.U.oops("checksum block in HEX not implemented yet");a=0,e&&(s=[]);let g=y.codeStartAddr,b=g-16>>16;for(;a<n.length;)p?k.UF2.writeBytes(p,g,o(n,g).slice(4)):(g>>16!=b&&(b=g>>16,s.push(I([2,0,0,4,b>>8,255&b]))),s.push(I(o(n,g)))),g+=16;if(e||(u=y.hexlines.slice(y.codeStartIdx),p?k.UF2.writeHex(p,u):k.Util.pushRange(s,u)),!p&&r.target.moveHexEof){for(;!s[s.length-1];)s.pop();":00000001FF"==s[s.length-1]&&s.pop()}if(r.packedSource)if(p)S(p,r);else{let e=0;for(let t=0;t<r.packedSource.length;t+=16){var x=[16,e>>8&255,255&e,14];for(let e=0;e<16;++e)x.push(255&(r.packedSource.charCodeAt(t+e)||0));s.push(I(x)),e+=16}}return!p&&r.target.moveHexEof&&s.push(":00000001FF"),p?[k.UF2.serializeFile(p)]:s}}k.hexDump=function(n,e=0){function s(e,t=8){let r=e.toString(16);for(;r.length<t;)r="0"+r;return r}let i="";for(let r=0;r<n.length;r+=16){i+=s(e+r)+": ";let t="";for(let e=0;e<16;e++){0==(3&e)&&(i+=" ");var a=n[r+e];null!=a?(i+=s(a,2)+" ",t+=32<=a&&a<127?String.fromCharCode(a):"."):i+="   "}i+=" "+t+"\n"}return i},k.asmline=function(e){return 0<=e.indexOf("\n")?e.replace(/^\s*/gm,"").replace(/^(.*)$/gm,(e,t)=>";"==t[0]&&" "==t[1]||/:\*$/.test(t)?t:"    "+t)+"\n":(e=/(^[\s;])|(:$)/.test(e)?e:"    "+e)+"\n"},k.firstMethodOffset=function(){return 9};const e=[21078089,22513679,15655169,18636881,19658081,21486649,21919277,20041213,20548751,16180187,18361627,19338023,19772677,16506547,23530697,22998697,21225203,19815283,23679599,19822889,21136133,19540043,21837031,18095489,23924267,23434627,22582379,21584111,22615171,23403001,19640683,19998031,18460439,20105387,17595791,16482043,23199959,18881641,21578371,22765747,20170273,16547639,16434589,21435019,20226751,19506731,21454393,23224541,23431973,23745511];function x(a){let o=32;k.U.assert(k.U.unique(a,e=>""+e).length==a.length,"non unique");for(let i=2;;i<<=1)if(o--,!(i<a.length)){let t,n=-1,s=-1;for(var l of e){var c,u=l<<8|o,p=new Uint16Array(i+k.vtLookups+1);k.U.assert(0==(1&p.length));let r=0,e=[];for(c of a){k.U.assert(0<c);var d=Math.imul(c,u)>>>o;e.push(d);let t=!1;for(let e=0;e<k.vtLookups;e++){if(!p[d+e]){t=!0,p[d+e]=c;break}r++}if(!t){r=-1;break}}(-1==n||n>r)&&(n=r,s=u,t=p)}if(0<=n)return{mult:s,mapping:t,size:i}}}function y(e,t,r){var n=x(e.itable.map(e=>e.idx));let s=k.target.shortPointers?".short":".word",i=`
        .balign 4
${e.id}_VT:
        .short ${4*e.allfields.length+4}  ; size in bytes
        .byte ${pxt.ValTypeObject}, ${pxt.VTABLE_MAGIC} ; magic
        ${s} ${e.id}_IfaceVT
        .short ${e.classNo} ; class-id
        .short 0 ; reserved
        .word ${n.mult} ; hash-mult
`,a=e=>{"0"!=e&&(e+="@fn"),i+=`        ${s} ${e}
`};a("pxt::RefRecord_destroy"),a("pxt::RefRecord_print"),a("pxt::RefRecord_scan"),a("pxt::RefRecord_gcsize");var o,l,c=e.toStringMethod;a(c?c.vtLabel():"0");for(o of e.vtable)a(o.label()+"_nochk");i+=`
        .balign ${k.target.shortPointers?2:4}
${e.id}_IfaceVT:
`;const u=2*n.mapping.length;let p="",d=u,f={};for(l of e.itable){f[l.idx+""]=d;const e=l.proc?l.proc.isGetter()?1:2:0;p=(p+=`  .short ${l.idx}, ${e} ; ${l.name}
`)+`  .word ${l.proc?l.proc.vtLabel()+"@fn":l.info}
`,d+=8,l.setProc&&(p=(p+=`  .short ${l.idx}, 0 ; set ${l.name}
`)+`  .word ${l.setProc.vtLabel()}@fn
`,d+=8)}p+="  .word 0, 0 ; the end\n",d+=8;var m=n.mapping;for(let e=0;e<m.length;++e)r.itEntries++,m[e]&&r.itFullEntries++;return i=(i+="  .short "+k.U.toArray(m).map((e,t)=>(f[e+""]||u)-2*t).join(", ")+"\n")+p+"\n"}k.vtLookups=3,k.computeHashMultiplier=x,k.vtableToAsm=y;const E=["GC"];function s(e){var t=e.nativeType==k.NATIVE_TYPE_VM?new k.assembler.VMFile(new k.vm.VmProcessor(e)):new k.assembler.File(new k.thumb.ThumbProcessor);return t.ei.testAssembler(),e.switches.noPeepHole&&(t.disablePeepHole=!0),t.lookupExternalLabel=b.lookupFunctionAddr,t.normalizeExternalLabel=e=>{var t=b.lookupFunc(e);return t?t.name:e},t}function i(e){if(0<e.errors.length){let r="";throw e.errors.forEach(e=>{var t=/^user(\d+)/.exec(e.scope);t&&(parseInt(t[1]),r=(r+=k.U.lf("At inline assembly:\n"))+e.message)}),r&&(console.log(k.U.lf("errors in inline assembly")),console.log(r)),new Error(e.errors[0].message)}}function w(e,t,r){var n=s(e);return n.emit(r),r=`; Interface tables: ${t.itFullEntries}/${t.itEntries} (${Math.round(100*t.itFullEntries/t.itEntries)}%)
; Virtual methods: ${t.numVirtMethods} / ${t.numMethods}
`+n.getSource(!0,t.numStmts,e.flashEnd),i(n),{src:r,buf:n.buf,thumbFile:n}}function o(n,s,i,r){var e=i.extinfo.disabledDeps,a=(n=e?""+b.hexPrelude()+`
; compilation disabled on this variant due to ${i.extinfo.disabledDeps}
.hex 718E3B92C615A841C49866C975EE5197
.string "${i.extinfo.disabledDeps}"`:`; start
${b.hexPrelude()}
    .hex 708E3B92C615A841C49866C975EE5197 ; magic number
    .hex ${b.hexTemplateHash()} ; hex template hash
    .hex 873266330af9dbdb ; replaced in binary by program hash
`+n,i.embedBlob&&(s.packedSource=function(e,t){let r=k.Util.toUTF8(e),n=(r.length,t.length,"A//");return(n=(n+=k.U.uint8ArrayToString([255&r.length,r.length>>8,255&t.length,t.length>>8,0,0,0,0]))+r+t).length%2&&(n+="\0"),n}(i.embedMeta,m.pxtc.decodeBase64(i.embedBlob)),!s.target.noSourceInFlash)&&s.packedSource.length<4e4&&(n+=function(t){let r="";for(let e=0;e<t.length;++e){var n=255&t.charCodeAt(e);r+=n<=15?"0"+n.toString(16):n.toString(16)}return`
    .balign 16
_stored_program: .hex ${r}
`}(s.packedSource),s.packedSource=null),b.flashCodeAlign(i.target));if(!e&&i.target.flashChecksumAddr){let e=0;for(;a>1<<e;)e++;var o=parseInt(b.hexTemplateHash().slice(8,16),16);const s=b.getStartAddress()/a;o=4294967040&o|e;let t=0,r=s;i.target.flashChecksumAddr<b.getStartAddress()&&(t=Math.ceil((i.target.flashChecksumAddr+32)/a),r-=t),n+=`
    .balign 4
__end_marker:
    .word ${o}

; ------- this will get removed from the final binary ------
__flash_checksums:
    .word 0x87eeb07c ; magic
    .word __end_marker ; end marker position
    .word ${o} ; end marker
    ; template region
    .short ${t}, ${r}
    .word 0x${b.hexTemplateHash().slice(0,8)}
    ; user region
    .short ${s}, 0xffff
    .hex 87326633 ; replaced later
    .word 0x0 ; terminator
`}const t=i.extinfo.outputPrefix||"",l=(s.writeFile(t+k.BINARY_ASM,n),w(i.target,s,n));if(l.thumbFile.commPtr&&(s.commSize=l.thumbFile.commPtr-b.getCommBase()),l.src&&s.writeFile(t+k.BINARY_ASM,l.src),e)return f();var o=r.configData||[];if(o.some(e=>"BOOTLOADER_BOARD_ID"==e.name)){let e="const uint32_t configData[] = {\n";e=(e+="    0x1e9e10f1, 0x20227a79, // magic\n")+`    ${o.length}, 0, // num. entries; reserved
`;for(var c of o)e+=`    ${c.key}, 0x${c.value.toString(16)}, // ${c.name}
`;e+="    0, 0\n};\n",s.writeFile(t+"config.c",e)}if(l.buf){const m=l.buf;let t="";for(let e=0;e<m.length;++e)t+=String.fromCharCode(255&m[e],m[e]>>8);const n=k.U.sha256(t).slice(0,16),r=k.U.range(4).map(e=>parseInt(n.slice(2*e,2*e+2),16));k.U.assert(12935==m[12]);for(let e=0;e<r.length;++e)m[12+e]=r[e];i.target.flashChecksumAddr&&(e=l.thumbFile.lookupLabel("__flash_checksums")/2,k.U.assert(e==m.length-16),o=m.slice(m.length-16),m.splice(m.length-16,16),i=Math.ceil(2*m.length/a),k.U.assert(12935==o[o.length-4]),o[o.length-4]=r[0],o[o.length-3]=r[1],o[o.length-5]=i,s.checksumBlock=o),f()}if(!r.procDebugInfo){for(var u of r.breakpoints){var p=k.U.lookup(l.thumbFile.getLabels(),"__brkp_"+u.id);null!=p&&(u.binAddr=p)}for(var d of s.procs)d.fillDebugInfo(l.thumbFile);if(r.procDebugInfo=s.procs.map(e=>e.debugInfo),s.target.switches.size){const b=[];for(const n of s.procs){const s=m.pxtc.nodeLocationInfo(n.action),i=[s.fileName.replace("pxt_modules/",""),k.getDeclName(n.action),n.debugInfo.size,"function",s.line+1];b.push(i.map(e=>`"${e}"`).join(","))}b.sort(),b.unshift("filename,name,size,type,line"),s.writeFile(t+"size.csv",b.join("\n"))}}function f(){if(pxt.isOutputText(k.target)){const m=b.patchHex(s,l.buf,!1,!1).join("\r\n")+"\r\n";s.writeFile(t+pxt.outputName(k.target),m)}else{var e=m.pxtc.encodeBase64(b.patchHex(s,l.buf,!1,!!k.target.useUF2)[0]);s.writeFile(t+pxt.outputName(k.target),e)}}}k.processorInlineAssemble=function(e,t){var r=s(e),n=(r.disablePeepHole=!0,r.emit(t),i(r),[]);for(let e=0;e<r.buf.length;e+=2)n.push(((r.buf[e+1]||0)<<16|r.buf[e])>>>0);return n},k.assemble=w,k.processorEmit=function(e,t,r){var n=function(t){let r=`
    .short ${t.globalsWords}   ; num. globals
    .short 0 ; patched with number of 64 bit words resulting from assembly
    .word _pxt_config_data
    .short 0 ; patched with comm section size
    .short ${t.nonPtrGlobals} ; number of globals that are not pointers (they come first)
    .word _pxt_iface_member_names
    .word _pxt_lambda_trampoline@fn
    .word _pxt_perf_counters
    .word _pxt_restore_exception_state@fn
    .word ${t.emitString(t.getTitle())} ; name
`,n=null;n=new k.ThumbSnippets;var e,s,i,a,o,l=t.setPerfCounters(E),c=(t.procs.forEach(e=>{e=new k.ProctoAssembler(n,t,e);r+="\n"+e.getAssembly()+"\n"}),new k.ProctoAssembler(n,t,null));c.emitHelpers(),r=(r+="\n"+c.getAssembly()+"\n")+b.asmTotalSource+"_code_end:\n\n",k.U.iterMap(t.codeHelpers,(e,t)=>{r+=`    .section code
${t}:
${e}
`}),r=r+n.arithmetic()+"_helpers_end:\n\n",t.usedClassInfos.forEach(e=>{r+=y(e,0,t)}),r=(r+="\n.balign 4\n_pxt_iface_member_names:\n")+`    .word ${t.ifaceMembers.length}
`;let u=0;for(e of t.ifaceMembers){var p=t.emitString(e);r+=`    .word ${p}  ; ${u++} .${e}
`}r=(r+="    .word 0\n")+"_vtables_end:\n\n\n.balign 4\n_pxt_config_data:\n";for(s of t.res.configData||[])r+=`    .word ${s.key}, ${s.value}  ; ${s.name}=${s.value}
`;r+="    .word 0\n\n";var d=n,f=t;for(i of k.U.unique(f.ifaceMembers.concat(Object.keys(f.strings)),e=>e))f.otherLiterals.push(d.string_literal(f.strings[i],i));for(a of Object.keys(f.doubles)){var m=f.doubles[a];f.otherLiterals.push(`
.balign 4
${m}: ${d.obj_header("pxt::number_vt")}
        .hex ${a}
`)}for(o of Object.keys(f.hexlits))f.otherLiterals.push(d.hex_literal(f.hexlits[o],o)),f.otherLiterals.push();r=(r=r+t.otherLiterals.join("")+"\n.balign 4\n.section code\n_pxt_perf_counters:\n")+`    .word ${l.length}
`;let h="";for(let e=0;e<l.length;++e){var g=".perf"+e;r+=`    .word ${g}
`,h+=g+`: .string ${JSON.stringify(l[e])}
`}return r=r+h+"_literals_end:\n"}(e),s=k.U.flatClone(t);b.setupFor(t.target,t.extinfo||k.emptyExtInfo()),o(n,e,t,r);const i=s.otherMultiVariants||[];if(i.length)try{for(var a of i){const i=k.U.flatClone(s);i.extinfo=a.extinfo,a.target.isNative=!0,i.target=a.target,b.setupFor(i.target,i.extinfo),o(n,e,i,r)}}finally{b.setupFor(s.target,s.extinfo)}},k.validateShim=b.validateShim}}(ts=ts||{}),function(e){(e.pxtc||(e.pxtc={})).getHelpForKeyword=function(e,t){var r={abstract:null,any:null,as:null,break:null,case:null,catch:null,class:null,continue:null,const:null,constructor:null,debugger:null,declare:null,delete:null,do:null,else:null,enum:null,export:null,extends:null,false:lf("Represents the negative outcome of a logical expression"),finally:null,for:null,from:null,function:null,get:null,if:null,implements:null,in:null,instanceof:null,interface:null,is:null,let:null,namespace:null,new:null,null:null,private:null,protected:null,public:null,return:null,set:null,static:null,super:null,switch:null,this:null,throw:null,true:lf("Represents the positive outcome of a logical expression"),try:null,type:null,typeof:null,undefined:null,void:null,while:null,with:null,of:null};return(t?{True:r.true,False:r.false,None:null,abs:null,all:null,any:null,ascii:null,bin:null,bool:null,bytearray:null,bytes:null,callable:null,chr:null,classmethod:null,compile:null,complex:null,copyright:null,credits:null,delattr:null,dict:null,dir:null,divmod:null,enumerate:null,eval:null,exec:null,exit:null,filter:null,float:null,format:null,frozenset:null,getattr:null,globals:null,hasattr:null,hash:null,help:null,hex:null,id:null,input:null,int:null,isinstance:null,issubclass:null,iter:null,len:null,license:null,list:null,locals:null,map:null,max:null,memoryview:null,min:null,next:null,object:null,oct:null,open:null,ord:null,pow:null,print:null,property:null,quit:null,range:null,repr:null,reversed:null,round:null,set:null,setattr:null,slice:null,sorted:null,staticmethod:null,str:null,sum:null,super:null,tuple:null,type:null,vars:null}:r)[e]}}(ts=ts||{}),function(e){(e.pxtc||(e.pxtc={})).LSHost=class{constructor(e){this.p=e}getCompilationSettings(){var e=this.p.getCompilerOptions();return e.noLib=!0,e}getNewLine(){return"\n"}getScriptFileNames(){return this.p.getSourceFiles().map(e=>e.fileName)}getScriptVersion(e){return"0"}getScriptSnapshot(e){const t=this.p.getSourceFile(e);return{getLength:()=>t.getFullText().length,getText:()=>t.getFullText(),getChangeRange:()=>{}}}getCurrentDirectory(){return"."}getDefaultLibFileName(e){return""}useCaseSensitiveFileNames(){return!0}}}(ts=ts||{}),function(N){function A(e){e=null==(e=null==(e=null==e?void 0:e.pxt)?void 0:e.callInfo)?void 0:e.qName;return B.lastApiInfo.apis.byQName[e]}function _(t,r,n){if(t&&!(r<0)){let e=t.parameters[r];if(t.attributes._def){var s=t.attributes._def.parameters[r].shadowBlockId;if(s){const t=n.blocksById[s],r=B.lastApiInfo.apis.byQName[t.qName];"TD_ID"===r.attributes.shim&&1===r.parameters.length&&(e=r.parameters[0])}}return e}}function K(e,t,r,n,s=!1){const i={};n.forEach(e=>{var t;let r=e.symbol.retType;s&&(7==e.symbol.kind?r=e.symbol.namespace:4==e.symbol.kind&&1<(null==(t=null==(t=null==(t=e.symbol.attributes)?void 0:t.enumIdentity)?void 0:t.split("."))?void 0:t.length)&&(r=t[0])),i[r]=[...i[r]||[],e]});var a,n=i[e]||[];let o=[];for(a of n){const n=l(a.symbol,t,N.SymbolFlags.Enum);if(n){const N=r.getTypeOfSymbolAtLocation(n,t),e=O.getEnumMembers(r,N).map(e=>O.enumMemberToQName(r,e)).map(e=>B.lastApiInfo.apis.byQName[e]);o=[...o,...e]}}return[...n,...F(o,1)]}function i(e){return e.flags&N.SymbolFlags.Variable?4:e.flags&N.SymbolFlags.Class?8:e.flags&N.SymbolFlags.Enum?6:e.flags&N.SymbolFlags.EnumMember?7:e.flags&N.SymbolFlags.Method?1:e.flags&N.SymbolFlags.Module?5:e.flags&N.SymbolFlags.Property?2:0}function $(e){return{kind:0,name:e,pyName:e,qName:e,pyQName:e,namespace:"",attributes:{callingConvention:0,paramDefl:{}},fileName:pxt.MAIN_TS,parameters:[],retType:"any"}}function C(e,t){var r=e.getName(),n=/(.*)\.(.*)/.exec(r),s=n?n[2]:r,n=n?n[1]:"",t=null!=(t=null==(t=t.getSymbol())?void 0:t.getName())?t:"any";return{kind:i(e),name:s,pyName:s,qName:r,pyQName:r,namespace:n,attributes:{callingConvention:0,paramDefl:{}},fileName:pxt.MAIN_TS,parameters:[],retType:t}}function U(e,t,r){if(e)return t.byQName[r.getFullyQualifiedName(e)]}function P(e,t){return e.weight!==t.weight?t.weight-e.weight:O.compareSymbols(e.symbol,t.symbol)}function L(e,t){return{symbol:e,weight:t}}function F(e,t){return e.map(e=>L(e,t))}function M(e,t){return e.flags&N.TypeFlags.NumberLiteral?"Number":e.flags&N.TypeFlags.StringLiteral?"String":e.flags&N.TypeFlags.BooleanLiteral?"Boolean":null!=(e={number:"Number",string:"String",boolean:"Boolean"}[t=t.typeToString(e)])?e:t}function r(e,t){return"."===t.charAt(0)&&(t=t.substr(1)),e.substr(0,e.lastIndexOf(".")+1)+t}function l(e,t,r){var n,s=B.service&&B.service.getProgram().getTypeChecker();if(s)for(n of s.getSymbolsInScope(t,r))if(n.escapedName.toString()===e.qName)return n;return null}function D({symbol:e}){return!(/^__/.test(e.name)||/^__/.test(e.namespace)||e.attributes.hidden||e.attributes.deprecated||"TD_ID"==e.attributes.shim||e.attributes.blockAliasFor)}var O,B;O=N.pxtc||(N.pxtc={}),(B=O.service||(O.service={})).getCallSymbol=A,B.getParameter=_,B.getApisForTsType=K,B.getBasicKindDefault=function(e,t){switch(e){case O.SK.StringKeyword:return'""';case O.SK.NumberKeyword:return"0";case O.SK.BooleanKeyword:return t?"False":"false";case O.SK.ArrayType:return"[]";case O.SK.NullKeyword:return t?"None":"null";default:return}},B.tsSymbolToPxtSymbolKind=i,B.makePxtSymbolFromKeyword=$,B.makePxtSymbolFromTsSymbol=C,B.getPxtSymbolFromTsSymbol=U,B.compareCompletionSymbols=P,B.completionSymbol=L,B.completionSymbols=F,B.getNodeAndSymbolAtLocation=function(e,t,r,n){var t=e.getSourceFile(t),s=e.getTypeChecker(),t=O.findInnerMostNodeAtPosition(t,r);if(t){const e=s.getSymbolAtLocation(t);if(e)return[t,U(e,n,s)]}return null},B.tsTypeToPxtTypeString=M,B.filenameWithExtension=r,B.getWordAtPosition=function(t,e){let r=e,n=e;for(;0<r&&s(r);)--r;for(;n<t.length-1&&s(n);)++n;return r!=n?{text:t.substring(r+1,n),start:r+1,end:n}:null;function s(e){e=t.charCodeAt(e);return 65<=e&&e<=90||97<=e&&e<=122}},B.getTsSymbolFromPxtSymbol=l,B.getDefaultEnumValue=function(e,t){const r=B.service&&B.service.getProgram().getTypeChecker(),n=O.getEnumMembers(r,e);for(const e of n)if(e.name.kind===O.SK.Identifier){const n=O.enumMemberToQName(r,e),s=B.lastApiInfo.apis.byQName[n];return s?s.attributes.alias?t&&s.attributes.pyAlias||s.attributes.alias:t?s.pyQName:s.qName:n}return"0"},B.getCompletions=function(a){const{fileName:e,fileContent:t,position:o,wordStartPos:l,wordEndPos:c,runtime:u}=a;let p=t;t&&B.host.setFile(e,t);const d=r(e,"ts"),f={startPos:l,endPos:c},m=/\.py$/.test(e),h={entries:[],isMemberCompletion:!1,isNewIdentifierLocation:!0,isTypeLocation:!1,namespace:[]};var g=p.lastIndexOf("\n",o-1),g=Math.max(0,g),g=p.substring(g+1,o),b=m?"#":"//";if(!g.trim().startsWith(b)){let t=-1,r=-1;for(let e=o-1;0<=e;--e){if("."==p[e]){t=e;break}if(!/\w/.test(p[e]))break;-1==r&&(r=e)}t==o-1?p=p.slice(0,o)+"_"+p.slice(o):-1==r&&(p=p.slice(0,o)+"_"+p.slice(o),r=o);const x=-1!==t,y=(h.isMemberCompletion=x)?p.slice(t+1,c):p.slice(l,c),k=(x&&(r=t),{});g=B.cloneCompileOpts(B.host.opts);g.fileSystem[e]=p,B.addApiInfo(g),g.syntaxInfo={position:r,type:h.isMemberCompletion?"memberCompletion":"identifierCompletion"};let n,s=[];if(m){const N=O.transpile.pyToTs(g);if(N.syntaxInfo&&N.syntaxInfo.symbols&&(s=F(N.syntaxInfo.symbols,1)),N.globalNames&&(B.lastGlobalNames=N.globalNames),!s.length&&N.globalNames&&(s=F(pxt.U.values(N.globalNames),1)),Object.keys(N.outfiles).forEach(e=>{e===d&&B.host.setFile(e,N.outfiles[e])}),N.sourceMap){const B=p,A=N.outfiles[d]||"",_=O.BuildSourceMapHelpers(N.sourceMap,A,B).py.smallestOverlap(f);_&&(n=_.ts.startPos)}!x&&50<s.length&&(s=s.filter(e=>0<=(m?e.symbol.pyQName:e.symbol.qName).toLowerCase().indexOf(y.toLowerCase()))),g.ast=!0,O.compile(g,B.service)}else n=o,g.ast=!0,B.host.setOpts(g),B.runConversionsAndCompileUsingService();const S=B.service.getProgram(),v=S.getSourceFile(d),T=S.getTypeChecker();let i=O.findInnerMostNodeAtPosition(v,n);if(!(O.decompiler.buildCommentMap(v).some(e=>e.start<=o&&o<=e.end)||i&&[O.SK.StringLiteral,O.SK.FirstTemplateToken,O.SK.NoSubstitutionTemplateLiteral].some(e=>i.kind===e))){h.namespace=O.getCurrentNamespaces(i);let e=!1;if(x){const N=O.findInnerMostNodeAtPosition(v,m?n:t-1);if(N){const A=T.getSymbolAtLocation(N);if(g=0<(null==(b=null==A?void 0:A.members)?void 0:b.size)?T.getDeclaredTypeOfSymbol(A):A?T.getTypeOfSymbolAtLocation(A,N):T.getTypeAtLocation(N)){const N=g.symbol?T.getFullyQualifiedName(g.symbol):M(g,T);N&&(s=g.getApparentProperties().map(e=>N+"."+e.getName()).map(e=>B.lastApiInfo.apis.byQName[e]).filter(e=>!!e).map(e=>L(e,1)),e=!0)}}}var b=pxt.U.values(B.lastApiInfo.apis.byQName);if(0===s.length&&(s=F(b.filter(e=>0<=(m?e.pyQName:e.qName).toLowerCase().indexOf(y.toLowerCase())),1)),!m&&!e){i=(i=O.findInnerMostNodeAtPosition(v,l))||v.getSourceFile();let e=N.SymbolFlags.Variable,t=T.getSymbolsInScope(i,e),r=i.getText();g=(t="_"!==r?t.filter(e=>0<=e.name.indexOf(r)):t).map(e=>{let t=U(e,B.lastApiInfo.apis,T);return t=t||C(e,T.getTypeOfSymbolAtLocation(e,i))}).filter(e=>!!e).map(e=>L(e,1));g.forEach(e=>e.weight+=5),s=[...s,...g]}b=O.getParentCallExpression(i);if(b){let e=O.findCurrentCallArgIdx(b,i,n);if(0<=e){const O=B.blocksInfoOp(B.lastApiInfo.apis,u.bannedCategories),a=A(b);if(a){const B=_(a,e=e>=a.parameters.length?a.parameters.length-1:e,O);B&&K(B.type,b,T,s,B.isEnum).forEach(e=>e.weight=10)}}}if(!x){let e;b=(e=m?(g=pxt.py.keywords,Object.keys(g)):[...ts.pxtc.reservedWords,...ts.pxtc.keywordTypes]).filter(e=>0<=e.indexOf(y)).map($).map(e=>L(e,0));s=[...s,...b]}g=m&&B.lastGlobalNames?B.lastGlobalNames:B.lastApiInfo.apis.byQName;s.map(e=>!e.symbol.attributes.alias||x&&7===e.symbol.kind?e:L(B.lastApiInfo.apis.byQName[e.symbol.attributes.alias],e.weight)).filter(D).forEach(e=>{k[e.symbol.qName]=e}),(s=pxt.Util.values(k).filter(e=>!!e&&!!e.symbol)).sort(P),a.light&&100<s.length&&(s=s.splice(0,100));const{bannedCategories:I,screenSize:w}=a.runtime,E={takenNames:g,blocksInfo:B.blocksInfoOp(B.lastApiInfo.apis,I),screenSize:w,apis:B.lastApiInfo.apis,checker:null==(b=null===B.service||void 0===B.service?void 0:B.service.getProgram())?void 0:b.getTypeChecker()};s.forEach(e=>{var e=e.symbol,t=m,r=E,n=B.lastApiInfo.decls[e.qName];if(N.isFunctionLike(n)&&(e.snippetAddsDefinitions||t&&!e.pySnippet||!t&&!e.snippet)){const N=B.getSnippet(r,e,n,t),s=B.snippetStringify(N),i=B.snippetStringify(N,!0),a=B.snippetAddsDefinitions(N);t?(e.pySnippet=s,e.pySnippetWithMarkers=i):(e.snippet=s,e.snippetWithMarkers=i),e.snippetAddsDefinitions=a}}),h.entries=s.map(e=>e.symbol)}}return h}}(ts=ts||{}),function(a){function i(e){e=t(e),a.sys.write(e)}function o(e){for(const t of e)i(t)}function t(e){let t;var r;t=void 0!==e.file?({line:s,character:i}=a.getLineAndCharacterOfPosition((r=e).file,r.start),n=r.file.fileName,Object.assign({fileName:n,line:s,column:i},r)):Object.assign({fileName:void 0,line:void 0,column:void 0},e);{var n=t;let e="";n.fileName&&(e+=`${n.fileName}(${n.line+1},${n.column+1}): `);var s=a.sys?a.sys.newLine:"\n",i=u.DiagnosticCategory[n.category].toLowerCase();return e+=`${i} TS${n.code}: `+u.flattenDiagnosticMessageText(n.messageText,s)+s}}function l(e,t){var r=a.createCompilerHost(t);return r.getDefaultLibFileName=()=>"node_modules/pxt-core/pxtcompiler/ext-typescript/lib/lib.d.ts",a.createProgram(e,t,r)}function c(e){let t=e.getSyntacticDiagnostics();return(t=0===t.length&&0===(t=e.getOptionsDiagnostics().concat(u.Util.toArray(e.getGlobalDiagnostics()))).length?e.getSemanticDiagnostics():t).slice(0)}var u;(u=a.pxtc||(a.pxtc={})).getDiagnosticString=t,u.plainTscCompileDir=function(r){const n=a.parseCommandLine([]);let s=a.findConfigFile(r,a.sys.fileExists);var e=function(){var e=a.sys.readFile(s),e=a.parseConfigFileTextToJson(s,e),t=e.config;if(t){if(!(0<(t=a.parseJsonConfigFileContent(t,a.sys,r,n.options,s)).errors.length))return t;o(t.errors)}else o([e.error]);a.sys.exit(a.ExitStatus.DiagnosticsPresent_OutputsSkipped)}(),e=l(e.fileNames,e.options);return c(e).forEach(i),e},u.plainTscCompileFiles=l,u.getProgramDiagnostics=c}(ts=ts||{}),function(g){{var b=g.pxtc||(g.pxtc={});function x(e){if(!e||!e.kind)return null;switch(e.kind){case g.SyntaxKind.StringKeyword:return"str";case g.SyntaxKind.NumberKeyword:return"number";case g.SyntaxKind.BooleanKeyword:return"bool";case g.SyntaxKind.VoidKeyword:return"None";case g.SyntaxKind.FunctionType:return r=x((t=e).type),`(${t.parameters.map(e=>e.type).map(x).join(", ")}) -> `+r;case g.SyntaxKind.ArrayType:return`List[${x(e.elementType)}]`;case g.SyntaxKind.TypeReference:t=e;return t.typeName&&t.typeName.getText?t.typeName.getText():"";case g.SyntaxKind.AnyKeyword:return"any";default:return pxt.tickEvent("depython.todo.tstypenodetopytype",{kind:e.kind}),""}var t,r}function y(e){if(!e||!e.flags)return null;switch(e.flags){case g.TypeFlags.String:return"str";case g.TypeFlags.Number:return"number";case g.TypeFlags.Boolean:return"bool";case g.TypeFlags.Void:return"None";case g.TypeFlags.Any:return"any";default:return pxt.tickEvent("depython.todo.tstypetopytype",{kind:e.flags}),""}}function s(e){return!!e.attributes.block&&!!e.attributes.blockId}let n;function p(t,r){function e(e){return-e(t)+e(r)}return e(e=>s(e)?1:-1)||e(e=>e.namespace?-1:1)||(n||((n={})[4]=100,n[5]=101,n[3]=99,n[2]=98,n[1]=97,n[8]=89,n[6]=81,n[7]=80),e(e=>n[e.kind]||0))||e(e=>e.attributes.weight||50)||b.U.strcmp(t.name,r.name)}function i(e,t,r=!1){const i={byQName:{},jres:t},a={},o=e.getTypeChecker(),l=n=>{var s;if(n.kind!=b.SK.VariableStatement){if(b.isExported(n)){if(!n.symbol)return void console.warn("no symbol",n);let e=k(o,n.symbol),r=(n.kind==b.SK.SetAccessor&&(e+="@set"),a[e]=n,function(d,a,o){function f(e,t,r=!1){let n=d.getTypeAtLocation(t);if(!n)return"None";r&&(n=n.getCallSignatures()[0].getReturnType());t=d.typeToString(n,void 0,g.TypeFormatFlags.UseFullyQualifiedType);return/^\d/.test(t)?"number":"this"==t?k(d,n.symbol):t}var l,c=function(){switch(o.kind){case b.SK.MethodDeclaration:case b.SK.MethodSignature:return 1;case b.SK.PropertyDeclaration:case b.SK.PropertySignature:case b.SK.GetAccessor:case b.SK.SetAccessor:return 2;case b.SK.Constructor:case b.SK.FunctionDeclaration:return 3;case b.SK.VariableDeclaration:return 4;case b.SK.ModuleDeclaration:return 5;case b.SK.EnumDeclaration:return 6;case b.SK.EnumMember:return 7;case b.SK.ClassDeclaration:return 8;case b.SK.InterfaceDeclaration:return 9;default:return 0}}();if(0==c)return null;{let e=o,p=b.parseComments(e);if(p.weight<0)return null;let t,r=/^(.*)\.(.*)/.exec(a),n=3==c||1==c,s=null,i=g.getSourceFileOfNode(o);if(i&&(l=/^pxt_modules\/([^\/]+)/.exec(i.fileName))&&(s=l[1]),8==c||9==c)if(t=[],o.heritageClauses)for(var u of o.heritageClauses)if(u.types)for(var m of u.types)t.push(f(0,m));6!=c&&7!==c||(t=t||[]).push("Number");var h={kind:c,qName:a,namespace:r?r[1]:"",name:r?r[2]:a,fileName:o.getSourceFile().fileName,attributes:p,pkg:s,pkgs:null,extendsTypes:t,retType:o.kind==g.SyntaxKind.Constructor?"void":5==c?"":f(e.type,e,n),parameters:n?b.Util.toArray(e.parameters).map((r,e)=>{let t,n,s=b.getName(r),i=p.paramHelp[s]||"",a=p.paramMin&&p.paramMin[s],o=p.paramMax&&p.paramMax[s];if(/\beg\.?:\s*(.+)/.exec(i),r.type&&r.type.kind===b.SK.FunctionType){const x=d.getSignatureFromDeclaration(r.type).getParameters();"objectdestructuring"===p.mutate?(b.assert(0<x.length),t=d.getTypeAtLocation(x[0].valueDeclaration).getProperties().map(e=>({name:e.getName(),type:d.typeToString(d.getTypeOfSymbolAtLocation(e,x[0].valueDeclaration))}))):n=x.map((e,t)=>({name:e.getName(),type:d.typeToString(d.getTypeOfSymbolAtLocation(e,r),void 0,g.TypeFormatFlags.UseFullyQualifiedType)}))}var l={},c=d.getTypeAtLocation(r),u=c&&!!(c.flags&(g.TypeFlags.Enum|g.TypeFlags.EnumLiteral));if(p.block&&p.paramShadowOptions){const g=[];p.block.replace(/%(\w+)/g,(e,t)=>(g.push(t),"")),p.paramShadowOptions[g[e]]&&(l.fieldEditorOptions={value:p.paramShadowOptions[g[e]]})}a&&(l.min={value:a}),o&&(l.max={value:o});e=r.type&&x(r.type)||c&&y(c)||"unknown",c=r.initializer?r.initializer.getText():b.getExplicitDefault(p,s)||(r.questionToken?"undefined":void 0);return{name:s,description:i,type:f(r.type,r),pyTypeString:e,initializer:c,default:p.paramDefl[s],properties:t,handlerParameters:n,options:l,isEnum:u}}):null,snippet:g.isFunctionLike(o)?null:void 0};switch(h.kind){case 7:h.pyName=b.U.snakify(h.name).toUpperCase();break;case 4:case 1:case 2:case 3:h.pyName=b.U.snakify(h.name);break;default:h.pyName=h.name}return o.kind!==b.SK.GetAccessor&&(o.kind!==b.SK.PropertyDeclaration&&o.kind!==b.SK.PropertySignature||!b.isReadonly(o))||(h.isReadOnly=!0),h}}(o,e,n));if(r){let t=b.U.lookup(i.byQName,e);if(t)if(9==t.kind&&9!=r.kind)i.byQName[e+"@type"]=t;else if(9!=t.kind&&9==r.kind)i.byQName[e+"@type"]=r,r=t;else{const n=null==(s=t.attributes._source)?void 0:s.trim(),i=null==(s=r.attributes._source)?void 0:s.trim();let e=n+"\n"+i;n&&0<=(null==i?void 0:i.indexOf(n))?e=i:i&&0<=(null==n?void 0:n.indexOf(i))&&(e=n),r.attributes=b.parseCommentString(e),5!==t.kind||(r.pkgs=t.pkgs||[],t.pkg===r.pkg)||r.pkgs.find(e=>e===t.pkg)||r.pkgs.push(t.pkg),t.extendsTypes&&(r.extendsTypes=r.extendsTypes||[],t.extendsTypes.forEach(e=>{-1===r.extendsTypes.indexOf(e)&&r.extendsTypes.push(e)}))}!n.parent||n.parent.kind!=b.SK.ClassDeclaration&&n.parent.kind!=b.SK.InterfaceDeclaration||b.isStatic(n)||(r.isInstance=!0),i.byQName[e]=r}}n.kind==b.SK.ModuleDeclaration?(s=n).body.kind==b.SK.ModuleBlock?s.body.statements.forEach(l):s.body.kind==b.SK.ModuleDeclaration&&l(s.body):n.kind!=b.SK.InterfaceDeclaration&&n.kind!=b.SK.ClassDeclaration&&n.kind!=b.SK.EnumDeclaration||n.members.forEach(l)}else n.declarationList.declarations.forEach(l)};for(var n of e.getSourceFiles())n.statements.forEach(l);var s,c=[];for(s in i.byQName){var u,p,d=i.byQName[s];d.qName=s,d.attributes._source=null,d.extendsTypes&&d.extendsTypes.length&&c.push(d);let e=d.attributes.jres;e&&("true"==e&&(e=s),(u=b.U.lookup(t||{},e))&&u.icon&&!d.attributes.iconURL&&(d.attributes.iconURL=u.icon),u)&&u.data&&!d.attributes.jresURL&&(d.attributes.jresURL="data:"+u.mimeType+";base64,"+u.data),d.pyName&&((u=b.U.lookup(b.ts2PyFunNameMap,d.qName))&&u.n?(d.pyQName=u.n,d.pySnippet=u.snippet,d.pySnippetName=u.n,d.pySnippetWithMarkers=void 0):d.namespace?(p=i.byQName[d.namespace])?d.pyQName=p.pyQName+"."+d.pyName:(pxt.log("namespace missing: "+d.namespace),d.pyQName=d.namespace+"."+d.pyName):d.pyQName=d.pyName)}let f={},m=e=>{if(!b.U.lookup(f,e.qName)){f[e.qName]=!0;var t,r={};r[e.qName]=!0;for(t of e.extendsTypes||[]){r[t]=!0;var n=i.byQName[t];if(n){m(n);for(var s of n.extendsTypes)r[s]=!0}}e.extendsTypes=Object.keys(r)}};return c.forEach(m),r&&delete i.byQName["Array.map"],{apis:i,decls:a}}function k(e,t){return t.isBogusSymbol?t.name:e.getFullyQualifiedName(t)}b.placeholderChar="",b.ts2PyFunNameMap={"Math.trunc":{n:"int",t:g.SyntaxKind.NumberKeyword,snippet:"int(0)"},"Math.min":{n:"min",t:g.SyntaxKind.NumberKeyword,snippet:"min(0, 0)"},"Math.max":{n:"max",t:g.SyntaxKind.NumberKeyword,snippet:"max(0, 0)"},"Math.abs":{n:"abs",t:g.SyntaxKind.NumberKeyword,snippet:"abs(0)"},"console.log":{n:"print",t:g.SyntaxKind.VoidKeyword,snippet:'print(":)")'},".length":{n:"len",t:g.SyntaxKind.NumberKeyword},".toLowerCase()":{n:"string.lower",t:g.SyntaxKind.StringKeyword},".toUpperCase()":{n:"string.upper",t:g.SyntaxKind.StringKeyword},".charCodeAt(0)":{n:"ord",t:g.SyntaxKind.NumberKeyword},"pins.createBuffer":{n:"bytearray",t:g.SyntaxKind.Unknown},"pins.createBufferFromArray":{n:"bytes",t:g.SyntaxKind.Unknown},"control.createBuffer":{n:"bytearray",t:g.SyntaxKind.Unknown},"control.createBufferFromArray":{n:"bytes",t:g.SyntaxKind.Unknown},"!!":{n:"bool",t:g.SyntaxKind.BooleanKeyword},"Array.indexOf":{n:"Array.index",t:g.SyntaxKind.Unknown},"Array.push":{n:"Array.append",t:g.SyntaxKind.Unknown},parseInt:{n:"int",t:g.SyntaxKind.NumberKeyword,snippet:'int("0")'},"_py.range":{n:"range",t:g.SyntaxKind.Unknown,snippet:"range(4)"}},b.emitPyTypeFromTypeNode=x,b.emitPyTypeFromTsType=y,b.genDocs=function(n,e,s={}){pxt.debug("generating docs for "+n),pxt.debug(JSON.stringify(Object.keys(e.byQName),null,2));const i={},t=b.Util.values(e.byQName),r=t.filter(e=>7==e.kind).sort(p),a={},o={},l={},c=t=>{var e;s.locs&&t.qName&&!/^__/.test(t.name)&&(pxt.debug("loc: "+t.qName),7!=t.kind&&(e=g.pxtc.blocksCategory(t))&&(o["{id:category}"+e]=e),t.attributes.jsDoc&&(l[t.qName]=t.attributes.jsDoc),t.attributes.block&&(o[t.qName+"|block"]=t.attributes.block),t.attributes.group&&(o["{id:group}"+t.attributes.group]=t.attributes.group),t.attributes.subcategory&&(o["{id:subcategory}"+t.attributes.subcategory]=t.attributes.subcategory),t.parameters)&&t.parameters.filter(e=>!!e.description).forEach(e=>{l[t.qName+"|param|"+e.name]=e.description})},u=(t,e)=>{if(s.locs){const r={};Object.keys(t).sort().forEach(e=>r[e]=t[e]),i[n+e+"-strings.json"]=JSON.stringify(r,null,2)}};for(const g of t){if(5==g.kind){if(!t.filter(e=>e.namespace==g.name&&!!e.attributes.jsDoc)[0])continue;g.attributes.block||(g.attributes.block=g.name)}c(g)}return s.locs&&r.forEach(e=>{e.attributes.block&&(o[e.qName+"|block"]=e.attributes.block),e.attributes.jsDoc&&(o[e.qName]=e.attributes.jsDoc)}),u(o,""),u(l,"-jsdoc"),s.pxtsnippet&&(s.pxtsnippet.forEach(e=>{{var r=a;const n=["label","title","hint","errorMessage"];r[e.label]=e.label,e.questions.forEach(t=>{n.forEach(e=>{t[e]&&(r[t[e]]=t[e])})})}}),u(a,"-snippet")),i},b.hasBlock=s,b.compareSymbols=p,b.getApiInfo=function(e,t,r=!1){return i(e,t,r).apis},b.internalGetApiInfo=i,b.getFullName=k}}(ts=ts||{}),function(o){var p=o.pxtc||(o.pxtc={});{var d=p.service||(p.service={});let l,r,e={fileSystem:{},sourceFiles:[],target:{isNative:!1,hasHex:!1,switches:{}}};class n{constructor(){this.opts=e,this.fileVersions={},this.projectVer=0,this.pxtModulesOK=null}getProjectVersion(){return this.projectVer+""}setFile(e,t){this.opts.fileSystem[e]!=t&&(this.fileVersions[e]=(this.fileVersions[e]||0)+1,this.opts.fileSystem[e]=t,this.projectVer++)}reset(){this.setOpts(e),this.pxtModulesOK=null}setOpts(e){p.Util.iterMap(e.fileSystem,(e,t)=>{this.opts.fileSystem[e]!=t&&(this.fileVersions[e]=(this.fileVersions[e]||0)+1)}),this.opts=Object.assign(Object.assign({},e),{fileSystem:Object.assign({},e.fileSystem)}),this.projectVer++}getCompilationSettings(){return p.getTsCompilerOptions(this.opts)}getScriptFileNames(){return this.opts.sourceFiles.filter(e=>p.U.endsWith(e,".ts"))}getScriptVersion(e){return(this.fileVersions[e]||0).toString()}getScriptSnapshot(e){e=this.opts.fileSystem[e];return null!=e?o.ScriptSnapshot.fromString(e):null}getNewLine(){return"\n"}getCurrentDirectory(){return"."}getDefaultLibFileName(e){return"no-default-lib.d.ts"}log(e){console.log("LOG",e)}trace(e){console.log("TRACE",e)}error(e){console.error("ERROR",e)}useCaseSensitiveFileNames(){return!0}}function c(e,t){return e?(d.lastLocBlocksInfo||(d.lastLocBlocksInfo=p.getBlocksInfo(e,t)),d.lastLocBlocksInfo):(d.lastBlocksInfo||(d.lastBlocksInfo=p.getBlocksInfo(d.lastApiInfo.apis,t)),d.lastBlocksInfo)}function f(e){return d.lastApiInfo||(d.lastApiInfo=p.internalGetApiInfo(d.service.getProgram(),e.jres)),d.lastApiInfo}function m(e){var t;e.apisInfo||(t=f(e),e.apisInfo=p.U.clone(t.apis))}function h(e){e=pxt.U.flatClone(e);return e.fileSystem=pxt.U.flatClone(e.fileSystem),e}d.blocksInfoOp=c,d.getLastApiInfo=f,d.addApiInfo=m,d.cloneCompileOpts=h,d.IsOpErr=function(e){return!!e.errorMessage};const s={reset:()=>{d.service=o.createLanguageService(d.host),d.lastApiInfo=void 0,d.lastGlobalNames=void 0,d.host.reset()},setOptions:e=>{d.host.setOpts(e.options)},syntaxInfo:t=>{var e,r,n;let s=t.fileContent;t.fileContent&&d.host.setFile(t.fileName,t.fileContent);var i=h(d.host.opts);i.fileSystem[t.fileName]=s,m(i),i.syntaxInfo={position:t.position,type:t.infoType};const a=i.target.preferredEditor==pxt.PYTHON_PROJECT_NAME,o="symbol"===i.syntaxInfo.type,l="signature"===i.syntaxInfo.type;if(a){var c=p.transpile.pyToTs(i);c.globalNames&&(d.lastGlobalNames=c.globalNames)}else{i.ast=!0,d.host.setOpts(i),g();const r=d.service.getProgram(),n=r.getSourceFile(t.fileName),s=r.getTypeChecker();if(o||l){var u,c=p.findInnerMostNodeAtPosition(n,t.position);if(c)if(o){const t=s.getSymbolAtLocation(c);t&&(u=d.getPxtSymbolFromTsSymbol(t,i.apisInfo,s),i.syntaxInfo.symbols=[u],i.syntaxInfo.beginPos=c.getStart(),i.syntaxInfo.endPos=c.getEnd())}else if(l){const d=null==(e=null==c?void 0:c.pxt)?void 0:e.callInfo;if(d){const e=i.apisInfo.byQName[d.qName],n=(i.syntaxInfo.symbols=[e],i.syntaxInfo.beginPos=c.getStart(),i.syntaxInfo.endPos=c.getEnd(),p.getParentCallExpression(c));if(n){const d=p.findCurrentCallArgIdx(n,c,t.position);i.syntaxInfo.auxResult=d}}}}}if(o&&(null==(r=i.syntaxInfo.symbols)||!r.length)){const e=d.getWordAtPosition(t.fileContent,t.position);if(e)if(a&&"range"===e.text){const t=f(i).apis;t.byQName["_py.range"]&&(i.syntaxInfo.symbols=[t.byQName["_py.range"]],i.syntaxInfo.beginPos=e.start,i.syntaxInfo.endPos=e.end)}else{const t=p.getHelpForKeyword(e.text,a);t&&(i.syntaxInfo.auxResult={documentation:t,displayString:d.displayStringForKeyword(e.text,a)},i.syntaxInfo.beginPos=e.start,i.syntaxInfo.endPos=e.end)}}if(null!=(n=i.syntaxInfo.symbols)&&n.length){const t=f(i).apis;a&&(i.syntaxInfo.symbols=i.syntaxInfo.symbols.map(e=>t.byQName[e.qName]||e)),o&&(i.syntaxInfo.auxResult=i.syntaxInfo.symbols.map(e=>d.displayStringForSymbol(e,a,t)))}return i.syntaxInfo},getCompletions:e=>d.getCompletions(e),compile:e=>{d.host.setOpts(e.options);e=g();return p.timesToMs(e),e},decompile:e=>(d.host.setOpts(e.options),p.decompile(d.service.getProgram(),e.options,e.fileName,!1)),pydecompile:e=>(d.host.setOpts(e.options),p.transpile.tsToPy(d.service.getProgram(),e.fileName)),decompileSnippets:e=>(d.host.setOpts(e.options),p.decompileSnippets(d.service.getProgram(),e.options,!1)),assemble:e=>({words:p.processorInlineAssemble(d.host.opts.target,e.fileContent)}),py2ts:e=>(m(e.options),p.transpile.pyToTs(e.options)),fileDiags:e=>p.patchUpDiagnostics(function(e){if(!/\.ts$/.test(e))return[];let t=d.service.getSyntacticDiagnostics(e);return t=(t=t&&t.length?t:d.service.getSemanticDiagnostics(e))||[]}(e.fileName)),allDiags:()=>{var e=g();return p.timesToMs(e),d.host.opts.target.switches.time&&console.log("DIAG-TIME",e.times),e},format:e=>{e=e.format;return p.format(e.input,e.pos)},apiInfo:()=>{if(d.lastBlocksInfo=void 0,l=void 0,d.host.opts!==e)return d.lastApiInfo=p.internalGetApiInfo(d.service.getProgram(),d.host.opts.jres),d.lastApiInfo.apis},snippet:e=>{var t=e.snippet;if(d.lastApiInfo){var r,n,s,i=d.lastApiInfo.apis.byQName[t.qName],a=d.lastApiInfo.decls[t.qName];if(i&&a&&o.isFunctionLike(a))return s={},s=(t=!!t.python)&&d.lastGlobalNames?d.lastGlobalNames:d.lastApiInfo.apis.byQName,{bannedCategories:e,screenSize:r}=e.runtime,n=d.lastApiInfo["apis"],n={apis:n,blocksInfo:c(n,e),takenNames:s,bannedCategories:e,screenSize:r,checker:d.service&&d.service.getProgram().getTypeChecker()},s=d.getSnippet(n,i,a,t),d.snippetStringify(s)}},blocksInfo:e=>c(e,e.blocks&&e.blocks.bannedCategories),apiSearch:i=>{const n=i.search,a=c(n.localizedApis,i.blocks&&i.blocks.bannedCategories),e=(n.localizedStrings&&pxt.Util.setLocalizedStrings(n.localizedStrings),(t,e,r)=>{if(t)return"string"==typeof t?t:e?t[e]:Object.keys(t).map(e=>t[e]).join(" ")});if(!d.builtinItems){d.builtinItems=[],d.blockDefinitions=pxt.blocks.blockDefinitions();for(const i in d.blockDefinitions){const n=d.blockDefinitions[i];if(n.operators)for(const l in n.operators)n.operators[l].forEach(e=>d.builtinItems.push({id:i,name:n.name,jsdoc:"string"==typeof n.tooltip?n.tooltip:n.tooltip[e],block:e,field:[l,e],builtinBlock:!0}));else d.builtinItems.push({id:i,name:n.name,jsdoc:e(n.tooltip,n.tooltipSearch),block:e(n.block,n.blockTextSearch),builtinBlock:!0})}}let o;if(!l||n.subset){const i={};let e=[],t=(n.subset&&(d.tbSubset=n.subset,e=d.builtinItems.filter(e=>!!d.tbSubset[e.id])),d.tbSubset?o=a.blocks.filter(e=>!!d.tbSubset[e.attributes.blockId]):(o=a.blocks,e=d.builtinItems),o.map(e=>({id:e.attributes.blockId,qName:e.qName,name:e.name,namespace:e.namespace,block:(e=>{if(null!=(n=e.attributes)&&n._def){var t,r=[],n=e.attributes._def,s=pxt.blocks.compileInfo(e);for(t of n.parts)switch(t.kind){case"label":r.push(t.text);break;case"param":var i=s.definitionNameToParam[t.name];r.push((null==i?void 0:i.defaultValue)||t.varName||(null==i?void 0:i.actualName)||t.name)}return r.join(" ")}return e.attributes.block})(e),params:(e=>{const t=null==(e=e.attributes)?void 0:e.paramHelp;return t&&Object.keys(t).map(e=>t[e]).join(" "),""})(e),jsdoc:e.attributes.jsDoc,localizedCategory:d.tbSubset&&"string"==typeof d.tbSubset[e.attributes.blockId]?d.tbSubset[e.attributes.blockId]:void 0}))),r={},s=(e.forEach(e=>r[e.id]=!0),t=t.filter(e=>!(e.id in r)),0);o.forEach(e=>{var t,r=i[e.qName]=(r=(e=e).attributes.weight||50,(1e3*((t=a.apis.byQName[e.namespace])&&t.attributes.weight||50)+r)*(t&&t.attributes.advanced||e.attributes.advanced?1:1e6));s=Math.max(s,r)}),t=t.concat(e),l=new Fuse(t,{shouldSort:!0,threshold:.6,location:0,distance:100,maxPatternLength:16,minMatchCharLength:2,findAllMatches:!1,caseSensitive:!1,keys:[{name:"name",weight:.3},{name:"namespace",weight:.1},{name:"localizedCategory",weight:.1},{name:"block",weight:.4375},{name:"params",weight:.0625},{name:"jsdoc",weight:.0625}],sortFn:function(e,t){var r=e.qName?1-i[e.item.qName]/s:1,n=t.qName?1-i[t.item.qName]/s:1;return e.score*(1+r/10)-t.score*(1+n/10)}})}return l.search(n.term).slice(0,7)},projectSearch:e=>{var e=e.projectSearch,t=e.headers;return(r=r||new Fuse(t,{shouldSort:!0,threshold:.6,location:0,distance:100,maxPatternLength:16,minMatchCharLength:2,findAllMatches:!1,caseSensitive:!1,keys:[{name:"name",weight:.3}]})).search(e.term)},projectSearchClear:()=>{r=void 0}};function g(){m(d.host.opts);const e=p.U.flatClone(d.host.opts.fileSystem);let t=p.runConversionsAndStoreResults(d.host.opts);null!=t&&t.globalNames&&(d.lastGlobalNames=t.globalNames);var r,n=d.host.opts.fileSystem;d.host.opts.fileSystem=e;for(r of Object.keys(n))d.host.setFile(r,n[r]);if(0==t.diagnostics.length){d.host.opts.skipPxtModulesEmit=!1,d.host.opts.skipPxtModulesTSC=!1;const e=d.host.opts.target.isNative?"native":"js";!d.host.opts.target.switches.noIncr&&d.host.pxtModulesOK&&(d.host.opts.skipPxtModulesTSC=!0,d.host.opts.noEmit?d.host.opts.skipPxtModulesEmit=!0:d.host.opts.target.isNative?d.host.opts.skipPxtModulesEmit=!1:"js"!=d.host.pxtModulesOK||d.host.opts.breakpoints&&!d.host.opts.justMyCode||(d.host.opts.skipPxtModulesEmit=!0));var s=p.compile(d.host.opts,d.service);((t=Object.assign({sourceMap:t.sourceMap},s)).needsFullRecompile||(!t.success||t.diagnostics.length)&&d.host.opts.clearIncrBuildAndRetryOnError)&&(pxt.debug("triggering full recompile"),pxt.tickEvent("compile.fullrecompile"),d.host.opts.skipPxtModulesEmit=!1,s=p.compile(d.host.opts,d.service),t=Object.assign({sourceMap:t.sourceMap},s)),t.diagnostics.every(e=>!p.isPxtModulesFilename(e.fileName))&&(d.host.pxtModulesOK=e),t.ast&&(s=p.internalGetApiInfo(t.ast))&&(d.lastApiInfo=s)}return t}d.runConversionsAndCompileUsingService=g,d.performOperation=function(e,t){d.service||(d.host=new n,d.service=o.createLanguageService(d.host));let r=null;if(s.hasOwnProperty(e))try{r=(0,s[e])(t)||{}}catch(e){r={errorMessage:e.stack}}else r={errorMessage:"No such operation: "+e};return r}}}(ts=ts||{}),function(L){function o(e){return"object"==typeof e&&void 0!==e.default}function l(e){return"object"==typeof e&&"number"==typeof e.length}function F(e,s=!1){const i={};let a=1;return function t(r){if(o(r)){if(s){if(c(r.default))return t(r.default);const s=F(r.default,!1);let e=i[s];var n;return(e&&!r.isLiteral||(e=a,a++,i[s]=e),0<=s.indexOf(".")&&s.indexOf(" ")<0)?((n=s.split("."))[n.length-1]="${"+e+":"+n[n.length-1]+"}",n.join(".")):"${"+e+":"+s+"}"}return t(r.default)}return l(r)?r.map(e=>t(e)).join(""):r}(e)}function c(e){return!!o(e)||!!l(e)&&e.map(c).reduce((e,t)=>e||t,!1)}function M(e){return e.attributes.shim&&"@"==e.attributes.shim[0]||e.attributes.pyConvertToTaggedTemplate}var D,O;D=L.pxtc||(L.pxtc={}),(O=D.service||(D.service={})).snippetStringify=F,O.snippetHasReplacementPoints=c,O.snippetAddsDefinitions=function e(t){return o(t)?t.isDefinition||e(t.default):!!l(t)&&t.map(e).reduce((e,t)=>e||t,!1)},O.getSnippet=function i(a,o,e,l,c=0){let{apis:u,takenNames:t,blocksInfo:r,screenSize:p,checker:d}=a;const f=pxt.py.INDENT,m=l?"python":"typescript";let n=o.namespace,s=!1,h=!1,g="",b=0,x=[];if(M(o))return l?o.name+'(""" """)':o.name+"``";let y="";y=e.kind==D.SK.Constructor?$(e.symbol)||e.parent.name.getText():$(e.symbol)||e.name.getText(),l&&(y=D.U.snakify(y));const k=o.attributes;if("TD_ID"===k.shim&&c&&e.parameters.length)return _(e.parameters[0]);const S=r.blocksById,v=e.parameters?e.parameters.filter(e=>!e.initializer&&!e.questionToken):[],T=v.map(_).map(e=>({default:e,isLiteral:!0})),I=o;if(I.attributes.block)if(I.attributes.defaultInstance)n=I.attributes.defaultInstance,l&&(n=n&&D.U.snakify(n));else if(I.namespace){const L=u.byQName[I.namespace];if(L.attributes.fixedInstances){let e,t=D.Util.values(u.byQName),r=t.filter(e=>4===e.kind&&e.attributes.fixedInstance);const o=r.filter(e=>e.retType==L.qName).sort((e,t)=>e.name.localeCompare(t.name));e=(o.length?o:r.filter(e=>{return-1!==(r=L.qName,t.filter(e=>e.extendsTypes).filter(e=>e.extendsTypes.reduce((e,t)=>e||-1!=t.indexOf(r),!1)).reduce((e,t)=>e.concat(t.extendsTypes),[]).indexOf(e.retType));var r}).sort((e,t)=>e.name.localeCompare(t.name)))[0],(g=(e?(n=""+C(e),e):L).namespace)&&(h=!0),s=!0}else if(1==I.kind||2==I.kind){const L=pxt.blocks.compileInfo(I);if(L.thisParameter){let e;L.thisParameter.definitionName&&(e="my"+(e=(e=L.thisParameter.definitionName)[0].toUpperCase()+e.substring(1))),n=L.thisParameter.defaultValue||e,l&&(n=n&&D.U.snakify(n))}s=!0}else if(8===L.kind)return}var w,e=k&&(l?k.pySnippet:k.snippet);let E;if(e)E=[e];else if(E=[y],null!=T&&T.length||1==I.kind||3==I.kind||8==I.kind){const L=T.reduce((e,t)=>[...e,e.length?", ":"",t],[]);E=E.concat(["(",...L,")"])}let N=n?[n,".",...E]:E;return N=h?[(e=g,(w=e.indexOf("."))<0?e:e.substring(0,w)),".",...N]:N,k&&k.blockSetVariable&&(N=l?[{default:A(D.U.snakify(k.blockSetVariable)),isDefinition:!0}," = ",...N]:["let ",{default:A(k.blockSetVariable),isDefinition:!0}," = ",...N]),[x,N];function A(e){return t[e]?L.pxtc.decompiler.getNewName(e,t,!1):e}function _(t){const r=t.type;if(r){var e=t.name.kind===D.SK.Identifier?t.name.text:void 0,n=null==(n=null==k?void 0:k.paramDefl)?void 0:n[e];if(n){let e;if(r.kind==D.SK.AnyKeyword){const O=n.toUpperCase();e=Number.isNaN(+O)?"FALSE"==O||"TRUE"==O?D.SK.BooleanKeyword:O.includes(".")?D.SK.EnumKeyword:D.SK.StringKeyword:D.SK.NumberKeyword}if(r.kind===D.SK.StringKeyword||e===D.SK.StringKeyword)return 0!=n.indexOf('"')?`"${n}"`:n;const i=null==d?void 0:d.getTypeAtLocation(t),a=O.getPxtSymbolFromTsSymbol(null==i?void 0:i.symbol,u,d);return null!=a&&a.attributes.fixedInstances&&l?pxt.Util.snakify(n):l?D.tsSnippetToPySnippet(n,a):n}n=function(t){var e=null==(e=pxt.blocks.compileInfo(o).parameters)?void 0:e.find(e=>e.actualName===t);if(null!=e&&e.shadowBlockId){e=S[e.shadowBlockId];if(e){var r=null==(r=e.attributes)?void 0:r.paramFieldEditor;if(r){r=r[t];if(r){e=e.attributes.paramFieldEditorOptions||{};if("sprite"===r){r=e[t];const s={initColor:0,initWidth:16,initHeight:16};if(null!=r&&r.sizes){const n=r.sizes.split(";"),i=[];for(let e=0;e<n.length;e++){const s=n[e].split(",");if(2===s.length){let e=parseInt(s[0]),t=parseInt(s[1]);isNaN(e)||isNaN(t)||(e<0&&p&&(e=p.width),t<0&&p&&(t=p.height),i.push([e,t]))}}0<i.length&&(s.initWidth=i[0][0],s.initHeight=i[0][1])}return s.initColor=n(null==r?void 0:r.initColor,s.initColor),s.initWidth=n(null==r?void 0:r.initWidth,s.initWidth),s.initHeight=n(null==r?void 0:r.initHeight,s.initHeight),pxt.sprite.imageLiteralFromDimensions(s.initWidth,s.initHeight,s.initColor,m);function n(e,t){e=parseInt(e);return isNaN(e)?t:e}}}}}}return null}(e);if(n)return n;n=function(e){let t=(k._shadowOverrides||{})[e];if(!t){const r=pxt.blocks.compileInfo(o);for(const s of r.parameters)if(s.actualName===e){t=s.shadowBlockId;break}}if(!t)return null;let r=S[t];var n;return r?("TD_ID"===r.attributes.shim&&r.parameters.length&&(n=r.parameters[0].type,r=u.byQName[n]||r),r):null}(e);if(n){var s=O.getTsSymbolFromPxtSymbol(n,t,L.SymbolFlags.Enum);if(s){s=d.getTypeOfSymbolAtLocation(s,t);if(s){s=K(s);if(s)return s}}const r=n.attributes;if("KIND_GET"===r.shim&&r.blockId){const L=r.kindNamespace||o.namespace,O=D.Util.values(u.byQName).find(e=>e.namespace===L&&e.attributes.isKind);if(O)return l?O.pyQName:O.qName}if(c<3&&O.lastApiInfo.decls[n.qName]){s=i(a,n,O.lastApiInfo.decls[n.qName],l,c+1);if(s)return s}}if(r.kind===D.SK.StringKeyword&&"leds"===e)return l?'"""\n. . . . .\n. . . . .\n. . # . .\n. . . . .\n. . . . .\n"""':"`\n. . . . .\n. . . . .\n. . # . .\n. . . . .\n. . . . .\n`";if(r.kind===D.SK.FunctionType){const L=r;n=d?d.getSignatureFromDeclaration(L):void 0;return n?U(n,!0):P(e)}s=O.getBasicKindDefault(r.kind,l);if(void 0!==s)return s;n=d&&d.getTypeAtLocation(t);if(n){e=K(n);if(e)return e}}return l?"None":"null"}function K(e){if(e.symbol&&e.symbol.flags&L.SymbolFlags.Enum)return O.getDefaultEnumValue(e,l);var n,t=O.getPxtSymbolFromTsSymbol(e.symbol,u,d);if(D.isObjectType(e)){const D=t&&t.attributes&&(l?t.attributes.pySnippet:t.attributes.snippet);if(D)return D;if(e.objectFlags&L.ObjectFlags.Anonymous){const D=d.getSignaturesOfType(e,L.SignatureKind.Call);return D&&D.length?U(D[0],!1):P()}}if(e.flags&L.TypeFlags.NumberLike)return"0";if(t&&t.attributes.fixedInstances){n=t;const L=pxt.Util.values(u.byQName).filter(e=>{return 4===e.kind&&e.attributes.fixedInstance&&(t=u,e=e.retType,r=n.qName,e==r||!(!(t=t.byQName[e])||!t.extendsTypes)&&0<=t.extendsTypes.indexOf(r));var t,r});if(L.length){const D=L[0];return l?D.pyQName:D.qName}}}function $(e){if(d){e=D.getFullName(d,e),e=u.byQName[e];if(e)return C(e)}}function C(e){return l?e.pyName:e.name}function U(t,r){let n="",e=d.getReturnTypeOfSignature(t);if(e.flags&L.TypeFlags.NumberLike?n="return 0":e.flags&L.TypeFlags.StringLike?n='return ""':e.flags&(L.TypeFlags.Boolean|L.TypeFlags.BooleanLiteral)&&(n=l?"return False":"return false"),l){var s=k.optionalVariableArgs?"()":`(${t.parameters.map(e=>e.name).join(", ")})`;let e=y||"fn";0<b++&&(e+=b),r&&!/^on/i.test(e)&&(e="on"+pxt.Util.capitalize(e));r=v.filter(e=>{e=d&&d.getTypeAtLocation(e);return!!(e&&e.symbol&&e.symbol.flags&L.SymbolFlags.Enum)}).map(e=>{var e=F(_(e)).toLowerCase(),t=e.lastIndexOf(".");return-1!==t?e.substr(t+1):e}).join("_");return r&&(e+="_"+r),e=A(e=D.U.snakify(e)),x=[...x,x.length?"\n":"","def ",{default:e,isDefinition:!0},s,`:
`+f,{default:n||"pass"},"\n"],{default:e}}{let e="()";return k.optionalVariableArgs||(r=L.mapToDisplayParts(e=>{d.getSymbolDisplayBuilder().buildSignatureDisplay(t,e,void 0,L.TypeFormatFlags.UseFullyQualifiedType)}),s=L.displayPartsToString(r),e=s.substr(0,s.lastIndexOf(":"))),["function",e,` {
`+f,{default:n},"\n}"]}}function P(e){return l?(e=A(e=D.U.snakify(e=e||"fn")),x=[...x,x.length?"\n":"","def ",{default:e,isDefinition:!0},`():
`+f,{default:"pass"},"\n"],{default:e}):"function () {}"}},O.isTaggedTemplate=M}(ts=ts||{}),function(e){(e=(e=e.pxtc||(e.pxtc={})).transpile||(e.transpile={})).pyToTs=function(e,t=0){return pxt.py.py2ts(e)},e.tsToPy=function(e,t="main.ts"){return pxt.py.decompileToPython(e,t)}}(ts=ts||{}),function(a){{var o=a.pxtc||(a.pxtc={}),e;let n;function s(e,t){var r;if(e)return(r=t(e))===n.Continue?s(e.parent,t):r!==n.Abort?r===n.Found?e:r:void 0}function i(e){return s(e,e=>a.isModuleDeclaration(e)?n.Found:n.Continue)}o.getParentCallExpression=function(e){return s(e,e=>a.isCallExpression(e)?n.Found:a.isBlock(e)?n.Abort:n.Continue)},o.findCurrentCallArgIdx=function(e,t,r){let n=e.arguments.map(e=>e===t).indexOf(!0);if(!(0<=n)){if(!(e.arguments.pos<=r&&r<e.end))return-1;if(0===e.arguments.length)return 0;n=0;for(var s of e.arguments){if(!(s.end<=r))break;n++}e.arguments.hasTrailingComma||(n=Math.max(0,n-1))}return n},(e=n=o.TraverseCheck||(o.TraverseCheck={}))[e.Found=0]="Found",e[e.Continue=1]="Continue",e[e.Abort=2]="Abort",o.traverseUp=s,o.enumMemberToQName=function(e,t){if(t.name.kind===o.SK.Identifier)return e.getFullyQualifiedName(e.getSymbolAtLocation(t.name))},o.findInnerMostNodeAtPosition=function e(t,r){for(var n of t.getChildren())if(!(n.kind>=a.SyntaxKind.FirstPunctuation&&n.kind<=a.SyntaxKind.LastPunctuation)){var s=n.getStart(),i=n.getEnd();if(s<=r&&r<i)return e(n,r)}return t&&t.kind===o.SK.SourceFile?null:t},o.getParentNamespace=i,o.getCurrentNamespaces=function e(t){var r;return(t=t&&i(t))?(r=t.name.getText(),[...e(t.parent),r]):[]},o.getEnumMembers=function(e,t){if(e&&t.symbol&&t.symbol.declarations&&t.symbol.declarations.length)for(let e=0;e<t.symbol.declarations.length;e++){var r=t.symbol.declarations[e];if(r.kind===o.SK.EnumDeclaration)return r.members}},o.isExported=function(e){if(e.modifiers&&e.modifiers.some(e=>e.kind==o.SK.PrivateKeyword||e.kind==o.SK.ProtectedKeyword))return!1;let t=e.symbol;if(!t)return!1;for(;;){var r=t.parent;if(!r)break;t=r}let n=t.valueDeclaration||t.declarations[0];return!(!(n=n.kind==o.SK.VariableDeclaration?n.parent.parent:n).parent||n.parent.kind!=o.SK.SourceFile)},o.isReadonly=function(e){return e.modifiers&&e.modifiers.some(e=>e.kind==o.SK.ReadonlyKeyword)}}}(ts=ts||{}),function(e){var u=e.pxtc||(e.pxtc={});{var o=u.vm||(u.vm={});const p=u.assembler.emitErr,r=p("opcode name doesn't match","<name>");class s extends u.assembler.Instruction{constructor(e,t,r){super(e,t,r,r,!1)}emit(s){var t=s.words;if(t[0]!=this.name)return r;let i=this.opcode,a=1,o=[],l=null,c=null;for(let e=0;e<this.args.length;++e){let r=this.args[e],n=t[a++];if("$"==r[0]){let e=this.ei.encoders[r],t=null;if(e.isImmediate||e.isLabel){if(!n)return p("expecting number",n);if(n=n.replace(/^#/,""),null==(t=s.bin.parseOneInt(n)))return p("expecting number",n)}else u.oops();if(null==t)return p("didn't understand it",n);u.U.assert(0<=t),11111!=t&&"$lbl"==r&&(t=t-(s.bin.location()+2)>>1),o.push(t);const a=t;if(null==(t=e.encode(t)))return p(`argument (${a}) out of range or mis-aligned`,n);"$i3"==r?t=c|t<<6:"$i5"==r&&(t=c|t<<8),"$i2"==r||"$i4"==r?c=t:"$rt"==r?(11111!=t&&4096<t&&u.U.oops("label: "+n+" v="+t),i=32768|t,"callrt.p"==this.name&&(i|=8192)):s.isLong||t<0||255<t?(s.isLong=!0,"$lbl"==r&&--t,i=t>>9&65535|49152,l=this.opcode+(t<<7)&65535):i=this.opcode+(t<<7)&65535}else if(r!=n)return p("expecting "+r,n)}return t[a]?p("trailing tokens",t[a]):{stack:0,opcode:i,opcode2:l,numArgs:o,labelName:s.bin.normalizeExternalLabel(null)}}}o.VmInstruction=s,o.withPush={},o.opcodes=["stloc     $i1","ldloc     $i1","stfld     $i4, $i5","ldfld     $i4, $i5","newobj    $i1","ldcap     $i1","bitconv   $i1","stglb     $i1","ldglb     $i1","ldint     $i1","ldintneg  $i1","ldspecial $i1","ldnumber  $i1","ldlit     $i1","checkinst $i1","mapget","mapset","ret       $i2, $i3","popmany   $i1","pushmany  $i1","callind   $i1","callproc  $i1","calliface $i2, $i3","callget   $i1","callset   $i1","jmp       $lbl","jmpnz     $lbl","jmpz      $lbl","try       $lbl","push","pop"];class t extends u.assembler.AbstractProcessor{constructor(e){super(),this.addEnc("$i1","#0-8388607",e=>this.inrange(8388607,e,e)),this.addEnc("$i2","#0-31",e=>this.inrange(31,e,e)),this.addEnc("$i3","#0-262143",e=>this.inrange(262143,e,e)),this.addEnc("$i4","#0-255",e=>this.inrange(255,e,e)),this.addEnc("$i5","#0-32767",e=>this.inrange(32767,e,e)),this.addEnc("$lbl","LABEL",e=>this.inminmax(-4194304,4194303,e,e)).isLabel=!0;let t=1,r=this.addEnc("$rt","SHIM",e=>this.inrange(8388607,e,e)).isLabel=!0;for(var n of o.opcodes.concat(["callrt $rt"])){let e=new s(this,n,t);this.instructions[e.name]=[e],!r&&"callrt"!=e.name||(o.withPush[e.name]=!0,e=new s(this,n.replace(/\w+/,e=>e+".p"),64|t),this.instructions[e.name]=[e]),"mapset.p"==e.name&&(r=!1),t++}}testAssembler(){}postProcessRelAddress(e,t){return t}postProcessAbsAddress(e,t){return t}getAddressFromLabel(e,t,r,n=0){r=e.lookupLabel(r);return null==r?null:t.is32bit?r:r-(e.pc()+2)}toFnPtr(e,t){return e}wordSize(){return 8}peephole(e,t,r){let n=e.getOp(),s="";var i,a;t&&(i=n+";"+(s=t.getOp()),(a=this.file.peepCounts)[i]=(a[i]||0)+1),"stloc"==n&&"ldloc"==s&&e.numArgs[0]==t.numArgs[0]?(/LAST/.test(t.text)&&e.update(""),t.update("")):o.withPush[n]&&"push"==s&&(e.update(e.text.replace(/\w+/,e=>e+".p")),t.update(""))}}o.VmProcessor=t}}(ts=ts||{});