(function(s){{var e=s.analytics||(s.analytics={});const a={},o={};let t=!1;e.addDefaultProperties=function(t){Object.keys(t).forEach(e=>{"string"==typeof t[e]?a[e]=t[e]:o[e]=t[e]})},e.enable=function(){if(s.aiTrackException&&s.aiTrackEvent&&!t){t=!0,s.debug("setting up app insights");const i=s.tickEvent,r=(s.tickEvent=function(e,t,n){if(i&&i(e,t,n),null!=n&&n.interactiveConsent&&s.setInteractiveConsent(!0),t){const i=Object.assign({},a)||{},n=Object.assign({},o)||{};Object.keys(t).forEach(e=>{"string"==typeof t[e]?i[e]=t[e]:"number"==typeof t[e]?n[e]=t[e]:i[e]=JSON.stringify(t[e]||"")}),s.aiTrackEvent(e,i,n)}else s.aiTrackEvent(e)},s.reportException),e=(s.reportException=function(e,t){r&&r(e,t);var n={target:s.appTarget.id,version:s.appTarget.versions.target};t&&s.Util.jsonMergeFrom(n,t),s.aiTrackException(e,"exception",n)},s.reportError);s.reportError=function(t,n,i){e&&e(t,n,i);try{throw n}catch(e){t={target:s.appTarget.id,version:s.appTarget.versions.target,category:t,message:n};i&&s.Util.jsonMergeFrom(t,i),s.aiTrackException(e,"error",t)}}}}}})(pxt=(pxt=pxt||{})||{}),function(e){{e=e.AudioContextManager||(e.AudioContextManager={});let n,i,r,s=0,a=!1;function t(){n&&(r.gain.setTargetAtTime(0,n.currentTime,.015),s=0)}e.mute=function(e){n&&(a=e,t(),e)&&i&&(i.disconnect(),r.disconnect(),i=void 0,r=void 0)},e.stop=t,e.frequency=function(){return s},e.tone=function(e){if(!(a||e<0)){s=e;var t=n=n||function(){if(window.AudioContext=window.AudioContext||window.webkitAudioContext,window.AudioContext)try{return new window.AudioContext}catch(e){}}();if(t)try{i||((i=t.createOscillator()).type="triangle",(r=t.createGain()).gain.value=0,r.connect(t.destination),i.connect(r),i.start(0)),i.frequency.linearRampToValueAtTime(e,n.currentTime),r.gain.setTargetAtTime(.2,n.currentTime,.015)}catch(e){i=void 0}}}}}(pxt=(pxt=pxt||{})||{}),function(a){{var r=a.auth||(a.auth={});const l="auth",c="csrf-token",u="login-state",h="user-state";let e,t=!1,n=(r.DEFAULT_USER_PREFERENCES=()=>({highContrast:!1,language:a.appTarget.appTheme.defaultLocale,reader:"",skillmap:{mapProgress:{},completedTags:{}}}),r.client=function(){return e},0),i=0;r.AuthClient=class{constructor(){this.initialUserPreferences_=void 0,this.initialAuthCheck_=void 0,a.Util.assert(!e),e=this}async initAsync(){try{this.state$=await a.storage.shared.getAsync(l,h)}catch(e){}this.state$||(this.state$={}),this.setUserProfileAsync(this.state$.profile),this.setUserPreferencesAsync(this.state$.preferences)}async loginAsync(e,t,n){var i,r;o()&&(i=e,0<s().filter(e=>e.id===i).length)&&(n=null!=n?n:d,(r=this.getState()).profile||await this.authCheckAsync(),(null==(r=r.profile)?void 0:r.idp)===e?a.debug(`loginAsync: Already signed into ${e}.`):(this.clearState(),r={key:(Math.PI*Math.random()).toString(36).slice(2),callbackState:n,callbackPathname:window.location.pathname,idp:e},await a.storage.shared.setAsync(l,u,r),n=a.Util.stringifyQueryString("/api/auth/login",{response_type:"token",provider:e,persistent:t,redirect_uri:""+window.location.origin+window.location.pathname+"?authcallback=1&state="+r.key}),(t=await this.apiAsync(n)).success?(a.tickEvent("auth.login.start",{provider:e}),window.location.href=t.resp.loginUrl):await this.onSignInFailed()))}async logoutAsync(e){o()&&(a.tickEvent("auth.logout"),await this.apiAsync("/api/auth/logout"),await a.storage.shared.delAsync(l,c),this.clearState(),e=e?e.startsWith("#")?e:"#"+e:"",a.BrowserUtils.hasWindow())&&(window.location.href=""+window.location.origin+window.location.pathname+e,location.reload())}async deleteProfileAsync(){var e;if(await this.loggedInAsync()){var t=null==(e=this.getState().profile)?void 0:e.id,n=await this.apiAsync("/api/user",null,"DELETE");if(n.err)await this.onApiError(n.err);else try{await a.storage.shared.delAsync(l,c);try{await this.onProfileDeleted(t)}catch(e){a.tickEvent("auth.profile.cloudToLocalFailed")}this.clearState()}finally{a.tickEvent("auth.profile.deleted")}}}async initialUserPreferencesAsync(){if(await this.loggedInAsync())return this.initialUserPreferences_||(this.initialUserPreferences_=this.fetchUserPreferencesAsync()),this.initialUserPreferences_}async userProfileAsync(){var e;if(await this.loggedInAsync())return e=this.getState(),Object.assign({},e.profile)}async userPreferencesAsync(){var e=this.getState();return Object.assign({},e.preferences)}async authCheckAsync(){var e,t;if(o()&&await a.storage.shared.getAsync(l,c))return null!=(e=(t=this.getState()).profile)&&e.id?this.initialAuthCheck_||(this.initialAuthCheck_=Promise.resolve(t.profile)):this.initialAuthCheck_||(this.initialAuthCheck_=this.fetchUserAsync()),this.initialAuthCheck_}async loggedInAsync(){return await this.authCheckAsync(),this.hasUserId()}async updateUserProfileAsync(e){var t;return!!await this.loggedInAsync()&&(t=this.getState(),(t=await this.apiAsync("/api/user/profile",{id:t.profile.id,username:e.username,avatarUrl:e.avatarUrl})).success&&await this.setUserProfileAsync(t.resp),t.success)}async patchUserPreferencesAsync(t){var e;(t=Array.isArray(t)?t:[t]).length&&(e=await this.userPreferencesAsync(),ts.pxtc.jsonPatch.patchInPlace(e,t),await this.setUserPreferencesAsync(e),await this.loggedInAsync())&&(clearTimeout(n),e=async()=>{i=0;var e=await this.apiAsync("/api/user/preferences",t,"PATCH");e.success?(a.debug("Updating local user preferences w/ cloud data after result of POST"),this.setUserPreferencesAsync(e.resp)):a.reportError("identity","update preferences failed",e)},i=i||a.U.now(),3e4<a.U.now()-i?await e():n=setTimeout(e,5e3))}hasUserId(){var e;return!!o()&&!(null==(e=this.getState().profile)||!e.id)}async fetchUserAsync(){var e;if(o()){var t=this.getState();if(null!=(e=t.profile)&&e.id)return t.profile;t=await this.apiAsync("/api/user/profile");if(t.success){const e=t.resp;return await this.setUserProfileAsync(e),e}}}async setUserProfileAsync(e){var t=this.hasUserId(),e=(this.transformUserProfile(e),this.hasUserId());this.onUserProfileChanged(),e&&!t?await this.onSignedIn():!e&&t&&await this.onSignedOut()}async setUserPreferencesAsync(e){var t=null!=(t=this.getState().preferences)?t:r.DEFAULT_USER_PREFERENCES(),n=ts.pxtc.jsonPatch.diff(t,e);this.transformUserPreferences(Object.assign(Object.assign({},t),e)),await this.onUserPreferencesChanged(n)}async fetchUserPreferencesAsync(){var e,t;if(await this.loggedInAsync())return e=this.getState(),(t=await this.apiAsync("/api/user/preferences")).success&&t.resp?(this.setUserPreferencesAsync(t.resp),e.preferences):void 0}transformUserProfile(e){this.state$=Object.assign(Object.assign({},this.state$),{profile:Object.assign({},e)}),this.saveState()}transformUserPreferences(e){this.state$=Object.assign(Object.assign({},this.state$),{preferences:Object.assign({},e)}),this.saveState()}getState(){return this.state$}saveState(){a.storage.shared.setAsync(l,h,this.state$).then(()=>{})}clearState(){this.state$={},a.storage.shared.delAsync(l,h).then(()=>this.onStateCleared())}async apiAsync(t,e,n){var i={},r=await a.storage.shared.getAsync(l,c);return r&&(i.authorization="mkcd "+r),i["x-pxt-target"]=null==(r=a.appTarget)?void 0:r.id,t=a.BrowserUtils.isLocalHostDev()?"https://staging.pxt.io"+t:t,a.Util.requestAsync({url:t,headers:i,data:e,method:n||(e?"POST":"GET"),withCredentials:!0}).then(e=>({statusCode:e.statusCode,resp:e.json,success:2===Math.floor(e.statusCode/100),err:null})).catch(async e=>(/logout/.test(t)||401!=e.statusCode||await this.logoutAsync(),{statusCode:e.statusCode,err:e,resp:null,success:!1}))}};const d={hash:"",params:{}};function s(){var e;return Object.keys((null==(e=null==(e=a.appTarget)?void 0:e.cloud)?void 0:e.cloudProviders)||{}).map(e=>a.appTarget.cloud.cloudProviders[e]).filter(e=>e.identity).sort((e,t)=>e.order-t.order)}function o(){return!t&&!a.BrowserUtils.isPxtElectron()&&0<s().length}r.loginCallbackAsync=async function(e){let t,n=Object.assign({},d);do{if(!(t=await a.storage.shared.getAsync(l,u)))return void a.debug("Auth state not found in storge.");await a.storage.shared.delAsync(l,u);const i=e.state;if(!i||t.key!==i)return void a.debug("Failed to get auth state for key");n=Object.assign(Object.assign({},d),t.callbackState);const r=e.error;if(r){const l=e.error_description;a.tickEvent("auth.login.error",{error:r,provider:t.idp}),a.log(`Auth failed: ${r}:`+l),n=Object.assign({},d);break}const s=e.token;if(!s){a.debug("Missing authToken in auth callback.");break}await a.storage.shared.setAsync(l,c,s),a.tickEvent("auth.login.success",{provider:t.idp})}while(0);const i=n.hash.startsWith("#")?n.hash:"#"+n.hash,r=a.Util.stringifyQueryString("",n.params),s=""+(t.callbackPathname.startsWith("/")?t.callbackPathname:"/"+t.callbackPathname)+i+r;window.location.href=s},r.identityProviders=s,r.identityProvider=function(t){return s().filter(e=>e.id===t).shift()},r.hasIdentity=o,r.enableAuth=function(e=!0){t=!e},r.userName=function(e){var t;return null!=(e=null!=(t=null==(t=null==e?void 0:e.idp)?void 0:t.displayName)?t:null==(t=null==e?void 0:e.idp)?void 0:t.username)?e:"??"},r.userInitials=function(e){e=a.auth.userName(e);return ts.pxtc.Util.initials(e)},r.generateUserProfilePicDataUrl=function(e){var t,n;if(null!=(n=null==(t=null==e?void 0:e.idp)?void 0:t.picture)&&n.encoded){const t=window.URL||window.webkitURL;try{const n=a.Util.stringToUint8Array(atob(e.idp.picture.encoded)),i=new Blob([n],{type:e.idp.picture.mimeType});e.idp.picture.dataUrl=t.createObjectURL(i)}catch(e){}}}}}(pxt=pxt||{}),(pxt||(pxt={})).tickEvent=function(e){},function(e){(e.pxtc||(e.pxtc={})).__dummy=42}(ts=ts||{});var pxt,ts,pxtmelody,pxtc=ts.pxtc;!function(r){r=r.pxtc||(r.pxtc={});{var o=r.Util||(r.Util={});function s(e){return e.replace(/[^\w .!?\-$]/g,e=>{e=e.charCodeAt(0).toString(16);return"\\u"+"0000".substr(0,4-e.length)+e})}o.assert=function(e,t="Assertion failed"){if(!e)throw new Error(t)},o.flatClone=function(t){if(null==t)return null;let n={};return Object.keys(t).forEach(e=>{n[e]=t[e]}),n},o.clone=function(e){return null==e?null:JSON.parse(JSON.stringify(e))},o.htmlEscape=function(e){return e&&e.replace(/([^\w .!?\-$])/g,e=>"&#"+e.charCodeAt(0)+";")},o.htmlUnescape=function(e){return e&&e.replace(/(&#\d+;)/g,e=>String.fromCharCode(Number(e.substr(2,e.length-3))))},o.jsStringQuote=s,o.jsStringLiteral=function(e){return'"'+s(e)+'"'},o.initials=function(e){return(/^\w+@/.test(e)?e.match(/^\w\w/).shift():((e=e.match(/\b\w/g)||[]).shift()||"")+(e.pop()||"")).toUpperCase()};let t="en",n={},e={},i=!1;function a(){return t}function l(e){var t=/^(\w{2})-(\w{2}$)/i.exec(e);return t&&t[1]&&t[2]?[t[1].toLowerCase()+"-"+t[2].toUpperCase(),t[1].toLowerCase(),t[1].toLowerCase()+"-"+t[2].toLowerCase()]:[(e||"en").toLowerCase()]}function c(e,i){return 0==i.length?e:e.replace(/\{([0-9]+)(\:[^\}]+)?\}/g,function(e,t,n){let r=i[parseInt(t)],s="",a=/^:f(\d*)\.(\d+)/.exec(n);if(a){let e=parseInt(a[2]),t=parseInt(a[1])||0,n=/^0/.test(a[1])?"0":" ",i=r.toFixed(e);if(0<t&&0<e&&(t+=e+1),0<t)for(;i.length<t;)i=n+i;s=i}else s=":x"==n?"0x"+r.toString(16):void 0===r?"(undef)":null===r?"(null)":r.toString?r.toString():r+"";return":a"==n?/^\s*[euioah]/.test(s.toLowerCase())?s="an "+s:/^\s*[bcdfgjklmnpqrstvwxz]/.test(s.toLowerCase())&&(s="a "+s):":s"==n?s=1==r?"":"s":":q"==n?s=o.htmlEscape(s):":jq"==n?s=o.jsStringQuote(s):":uri"==n?s=encodeURIComponent(s).replace(/'/g,"%27").replace(/"/g,"%22"):":url"==n?s=encodeURI(s).replace(/'/g,"%27").replace(/"/g,"%22"):":%"==n&&(s=(100*r).toFixed(1).toString()+"%"),s})}o.enableLiveLocalizationUpdates=function(){i=!0},o.liveLocalizationEnabled=function(){return i},o.localeInfo=function(){return(i?"live-":"")+t},o.userLanguage=a,o.normalizeLanguageCode=l,o.setUserLanguage=function(e){t=l(e)[0]},o.isUserLanguageRtl=function(){return/^ar|dv|fa|ha|he|ks|ku|ps|ur|yi/i.test(t)},o.TRANSLATION_LOCALE="pxt",o.isTranslationMode=function(){return t==o.TRANSLATION_LOCALE},o._localize=function(e){return n[e]||e},o.getLocalizedStrings=function(){return n},o.setLocalizedStrings=function(e){n=e},o.translationsCache=function(){return e},o.fmt_va=c,o.fmt=function(e,...t){return c(e,t)};const h={};function u(e,t){if(!e)return e;h[e]=(h[e]||0)+1;let n=o._localize(e);return c(n=n.replace(/^\{(id|loc):[^\}]+\}/g,""),t)}o.dumpLocStats=function(){const t={};Object.keys(h).sort((e,t)=>h[t]-h[e]).forEach(e=>t[e]=e),console.log("prioritized list of strings:"),console.log(JSON.stringify(t,null,2))},o.lf_va=u,o.lf=function(e,...t){return u(e,t)},o.rlf=function(e,...t){return u(e,t)},o.lookup=function(e,t){return e.hasOwnProperty(t)?e[t]:null},o.isoTime=function(e){e=new Date(1e3*e);return o.fmt("{0}-{1:f02.0}-{2:f02.0} {3:f02.0}:{4:f02.0}:{5:f02.0}",e.getFullYear(),e.getMonth()+1,e.getDate(),e.getHours(),e.getMinutes(),e.getSeconds())},o.userError=function(e){e=new Error(e);throw e.isUserError=!0,e},o.deq=function t(n,i){if(n!==i){if(!n||!i)return"Null value";if("object"!=typeof n||"object"!=typeof i)return"Unable to compare "+n+", "+i;if(Array.isArray(n)){if(!Array.isArray(i))return"Expected array";if(n.length!=i.length)return"Expected array of length "+n.length+", got "+i.length;for(let e=0;e<n.length;e++)if(null!=t(n[e],i[e]))return"Expected array value "+n[e]+" got "+i[e]}else{var r=Object.keys(n),e=Object.keys(n);if(r.length!=e.length)return"Expected "+r.length+" keys, got "+e.length;for(let e=0;e<r.length;e++){if(!Object.prototype.hasOwnProperty.call(i,r[e]))return"Missing key "+r[e];if(null!=t(n[r[e]],i[r[e]]))return"Expected value of "+r[e]+" to be "+n[r[e]]+", got "+i[r[e]]}}}return null}}}(ts=ts||{});const lf=ts.pxtc.Util.lf;!function(e){(e=e.pxtc||(e.pxtc={})).decodeBase64=function(e){return atob(e)},e.encodeBase64=function(e){return btoa(e)}}(ts=ts||{}),function(l){var d=l.pxtc||(l.pxtc={});{var e,f=d.Util||(d.Util={});function i(t,n){if(n)for(let e=0;e<n.length;++e)t.push(n[e])}function t(t){var n=[];for(let e=0;e<t.length;++e)i(n,t[e]);return n}function r(e){return e&&"object"==typeof e&&!Array.isArray(e)}function a(t,n,i,r,s){void 0===r&&(r=0),void 0===s&&(s=i.length-r);for(let e=0;e<s;++e)t[n+e]=i[r+e]}function s(e,t){return e==t?0:e<t?-1:1}f.CancellationToken=class{constructor(){this.pending=!1,this.cancelled=!1}startOperation(){this.pending=!0}isRunning(){return this.pending}onProgress(e){this.progressHandler=e}reportProgress(e,t){this.progressHandler&&this.progressHandler(e,t)}cancel(){this.cancelled=!0,this.pending=!1}cancelAsync(){return this.cancelled||!this.pending?(this.cancelled=!0,this.pending=!1,Promise.resolve()):(this.cancelled=!0,this.deferred=new Promise(e=>{this.resolve=e}),this.deferred)}isCancelled(){return this.cancelled}throwIfCancelled(){if(this.isCancelled())throw new Error}resolveCancel(){this.pending=!1,this.deferred&&(this.resolve(),this.deferred=void 0,this.resolve=void 0)}},f.codalHash16=function(e){const r=[251,175,119,215,81,14,79,191,103,49,181,143,186,157,0,232,31,32,55,60,152,58,17,237,174,70,160,144,220,90,57,223,59,3,18,140,111,166,203,196,134,243,124,95,222,179,197,65,180,48,36,15,107,46,233,130,165,30,123,161,209,23,97,16,40,91,219,61,100,10,210,109,250,127,22,138,29,108,244,67,207,9,178,204,74,98,126,249,167,116,34,77,193,200,121,5,20,113,71,35,128,13,182,94,25,226,227,199,75,27,41,245,230,224,43,225,177,26,155,150,212,142,218,115,241,73,88,105,39,114,62,255,192,201,145,214,168,158,221,148,154,122,12,84,82,163,44,139,228,236,205,242,217,11,187,146,159,64,86,239,195,42,106,198,118,112,184,172,87,2,173,117,176,229,247,253,137,185,99,164,102,147,45,66,231,52,141,211,194,206,246,238,56,110,78,248,63,240,189,93,92,51,53,183,19,171,72,50,33,104,101,69,8,252,83,120,76,135,85,54,202,125,188,213,96,235,136,208,162,129,190,132,156,38,47,1,7,254,24,4,216,131,89,21,28,133,37,153,149,80,170,68,6,169,234,151];if(e){var n,i=e,s=new Uint8Array(i.length);for(let e=0;e<i.length;++e){const a=i.charCodeAt(e);s[e]=255&a}let t=0;for(let e=0;e<2;++e)n=function(t){let n=0;for(let e=0;e<t.length;e++){var i=t[e];n=r[n^i]}return n}(s),t|=n<<8*e,s[0]=(s[0]+1)%255;return t}return 0},f.bufferSerial=function(t,n="",i="?",r=255){for(let e=0;e<n.length;++e){var s=n[e];t[i]=(t[i]||"")+s,("\n"===s||t[i].length>r)&&(s=t[i],t[i]="",window.postMessage({type:"serial",id:i,data:s},"*"))}},f.blobReadAsDataURL=function(i){return i?new Promise((e,t)=>{const n=new FileReader;n.onload=()=>e(n.result),n.onerror=e=>t(e),n.readAsDataURL(i)}):Promise.resolve(void 0)},f.fileReadAsBufferAsync=function(i){return i?new Promise((t,e)=>{let n=new FileReader;n.onerror=e=>t(null),n.onload=e=>t(new Uint8Array(n.result)),n.readAsArrayBuffer(i)}):Promise.resolve(null)},f.fileReadAsTextAsync=function(i){return i?new Promise((t,e)=>{let n=new FileReader;n.onerror=e=>t(null),n.onload=e=>t(n.result),n.readAsText(i)}):Promise.resolve(null)},f.repeatMap=function(t,n){t=t||0;var i=[];for(let e=0;e<t;++e)i.push(n(e));return i},f.listsEqual=function(t,n){if(!t||!n||t.length!==n.length)return!1;for(let e=0;e<t.length;e++)if(t[e]!==n[e])return!1;return!0},f.oops=function(e="OOPS"){throw new Error(e)},f.reversed=function(e){return(e=e.slice(0)).reverse(),e},f.iterMap=function(t,n){Object.keys(t).forEach(e=>n(e,t[e]))},f.mapMap=function(t,n){let i={};return Object.keys(t).forEach(e=>i[e]=n(e,t[e])),i},f.values=function(t){return Object.keys(t||{}).map(e=>t[e])},f.pushRange=i,f.concatArrayLike=t,f.concat=t,f.memcpy=a,f.uint8ArrayConcat=function(e){let t=0;for(var n of e)t+=n.length;let i=new Uint8Array(t),r=0;for(var s of e)a(i,r,s),r+=s.length;return i},f.jsonTryParse=function(e){try{return JSON.parse(e)}catch(e){}},f.jsonMergeFrom=function t(n,i){i&&Object.keys(i).forEach(e=>{r(n[e])&&r(i[e])?t(n[e],i[e]):n[e]=f.clone(i[e])})},f.jsonCopyFrom=function(e,t){var n,i=f.clone(t);for(n of Object.keys(t))e[n]=i[n]},f.jsonFlatten=function(e){let i={},r=(e,t)=>{if(null!==t&&"object"==typeof t){f.assert(!Array.isArray(t)),e&&(e+=".");for(var n of Object.keys(t))r(e+n,t[n])}else i[e]=t};return r("",e),i},f.jsonUnFlatten=function(i){var r,e={};for(r of Object.keys(i)){let t=e,n=r.split(".");for(let e=0;e<n.length;++e){var s=n[e];e==n.length-1?t[s]=i[r]:("object"!=typeof t[s]&&(t[s]={}),t=t[s])}}return e},f.strcmp=s,f.stringMapEq=function(e,t){var n,i=Object.keys(e),r=Object.keys(t);if(i.length!=r.length)return!1;for(n of i){if(!t.hasOwnProperty(n))return!1;if(e[n]!==t[n])return!1}return!0},f.endsWith=function(e,t){return!(e.length<t.length||0!=t.length&&e.slice(-t.length)!=t)},f.startsWith=function(e,t){return!(e.length<t.length||0!=t.length&&e.slice(0,t.length)!=t)},f.contains=function(e,t){return!(e.length<t.length)&&(0==t.length||-1<e.indexOf(t))},f.replaceAll=function(e,t,n){return t?e.split(t).join(n):e},f.snakify=function(n){const i=n.toUpperCase(),t=n.toLowerCase();if(n==i||n==t)return n;if(0<n.lastIndexOf("_"))return n;var r,s=e=>n[e]!=t[e];let a="",o=0;for(;o<n.length;){let e=s(o),t=o;for(;t<n.length;){if(e&&(r=t,n[r]!=i[r])){if(2<t-o){t--;break}e=!1}if(!e&&s(t))break;t++}a&&(a+="_"),a+=n.slice(o,t),o=t}return a.toUpperCase()===a?a:a.toLowerCase()},f.sortObjectFields=function(t){var e=Object.keys(t);e.sort(s);let n={};return e.forEach(e=>n[e]=t[e]),n},f.chopArray=function(t,n){var i=[];for(let e=0;e<t.length;e+=n)i.push(t.slice(e,e+n));return i},f.unique=function(e,n){let i=[],r={};return e.forEach(e=>{var t=n(e);r.hasOwnProperty(t)||(r[t]=null,i.push(e))}),i},f.groupBy=function(e,n){let i={};return e.forEach(e=>{var t=n(e);i.hasOwnProperty(t)||(i[t]=[]),i[t].push(e)}),i},f.toDictionary=function(e,t){let n={};return e.forEach(e=>{n[t(e)]=e}),n},f.toSet=function(e,t){let n={};return e.forEach(e=>{n[t(e)]=!0}),n},f.toArray=function(t){if(Array.isArray(t))return t;var n=[];if(t)for(let e=0;e<t.length;++e)n.push(t[e]);return n},f.indexOfMatching=function(t,n){for(let e=0;e<t.length;++e)if(n(t[e]))return e;return-1};const x=Promise.resolve();async function n(t,n,i){let r=0;const s=[],a=[];for(let e=0;e<t;e++){const t=(async()=>{for(;r<n.length;){var e=r++,t=n[e];a[e]=await i(t)}})();s.push(t)}try{await Promise.all(s)}catch(t){throw r=n.length,t}return a}function o(n,i){const r={};return e=>{var t=n(e);return r.hasOwnProperty(t)?r[t]:r[t]=i(e)}}function c(e){return e=e&&e.replace(/\\/g,"/")}function u(n){return f.httpRequestCoreAsync(n).then(e=>{const t=e.statusCode;if((n.successCodes||[304,200,201,202]).indexOf(t)<0&&!n.allowHttpErrors){const d=f.lf("Bad HTTP status code: {0} at {1}; message: {2}",e.statusCode,n.url,(e.text||"").slice(0,500)),t=new Error(d);return t.statusCode=e.statusCode,Promise.reject(t)}return e.text&&/application\/json/.test(e.headers["content-type"])&&(e.json=d.U.jsonTryParse(e.text)),e})}function p(n,i){let r="";if(n)for(let t=0;t<n.length;++t){let e=n.charCodeAt(t);var s;e<=127?r+=n.charAt(t):e<=2047?r+=String.fromCharCode(192|e>>6,128|63&e):(!i&&55296<=e&&e<=56319&&(s=n.charCodeAt(++t),isNaN(s)||(e=65536+(e-55296<<10)+(s-56320))),r+=e<=65535?String.fromCharCode(224|e>>12,128|e>>6&63,128|63&e):String.fromCharCode(240|e>>18,128|e>>12&63,128|e>>6&63,128|63&e))}return r}function g(){return Date.now()}function m(){var e=new Uint8Array(4);return f.getRandomBuf(e),new Uint32Array(e.buffer)[0]}function b(r,s,a,o){function t(n){pxt.debug(`downloading translations for ${r} ${s} `+(a||""));let e=pxt.BrowserUtils.isLocalHost()||pxt.webConfig.isStatic?"https://makecode.com/api/":"",t=e+`translations?lang=${encodeURIComponent(r)}&filename=${encodeURIComponent(s)}&approved=true`;a&&(t+="&branch="+encodeURIComponent(a));var i={};return o&&!pxt.Cloud.useCdnApi()&&(i["If-None-Match"]=o),(e?u:pxt.Cloud.apiRequestWithCdnAsync)({url:t,headers:i}).then(t=>304==t.statusCode||200==t.statusCode?(o=t.headers.etag||"",pxt.BrowserUtils.translationDbAsync().then(e=>e.setAsync(r,s,a,o,t.json||n)).then(()=>t.json||n)):t.json,e=>{console.log("failed to load translations from "+t)})}return pxt.BrowserUtils.translationDbAsync().then(e=>e.getAsync(r,s,a)).then(e=>e?(o=e.etag,300<(Date.now()-e.time)/1e3&&t(e.strings),e.strings):t())}function y(e){var[e,t]=f.normalizeLanguageCode(e),n=pxt.appTarget.appTheme;if(n&&n.availableLocales){if(-1<n.availableLocales.indexOf(e))return!0;if(t&&-1<n.availableLocales.indexOf(t))return!0}return!1}f.nextTick=function(e){x.then(e)},f.delay=async function(t,e){e=await e;return await new Promise(e=>setTimeout(()=>e(),t)),e},f.promiseMapAll=function(e,t){return Promise.all(e.map(e=>t(e)))},f.promiseMapAllSeries=function(e,t){return n(1,e,t)},f.promisePoolAsync=n,f.memoizeString=function(e){return o(e=>e,e)},f.promiseTimeout=async function(n,e,i){let r,s;var t=new Promise((e,t)=>{s=e,r=setTimeout(()=>{s=void 0,clearTimeout(r),t(i||`Promise timed out after ${n}ms`)},n)});return Promise.race([e,t]).then(e=>(s&&(clearTimeout(r),s()),e))},f.defer=function(){let i,n,r,e=!1;return{resolve:function(t){e?pxt.debug("Deferred promise already resolved"):(n?n(t):i=i||new Promise(function(e){e(t)}),e=!0)},reject:function(n){e?pxt.debug("Deferred promise already resolved"):(r?r(n):i=i||new Promise(function(e,t){t(n)}),e=!0)},promise:new Promise(function(e,t){i?e(i):(n=e,r=t)})}},f.memoize=o,f.debounce=function(i,r,s){let a;return function(){let e=this,t=arguments,n=s&&!a;return clearTimeout(a),a=setTimeout(function(){a=null,s||i.apply(e,t)},r),n&&i.apply(e,t),a}},f.AdaptiveDebouncer=class{constructor(e,t=300,n=2e3,i=2){this.func=e,this.minDelay=t,this.maxDelay=n,this.slowdownFactor=i,this.lastPoke=0,this.recentGaps=[],this.wrapped=()=>{this.timeout=null,this.func()}}poke(){var e=Date.now();if(this.lastPoke){var t=e-this.lastPoke;if(t<10)return;for(t<4e3&&this.recentGaps.push(t);10<this.recentGaps.length;)this.recentGaps.shift()}this.lastPoke=e}trigger(){let e=this.maxDelay;var t;this.lastPoke&&((t=this.recentGaps.slice()).sort(),t=t[t.length>>1]||1,e=Math.min(Math.max(t*this.slowdownFactor|0,this.minDelay),this.maxDelay),(e-=Date.now()-this.lastPoke)<0&&(e=0),this.lastPoke=null),clearTimeout(this.timeout),this.timeout=setTimeout(this.wrapped,e)}},f.throttle=function(i,r,s){let a;return function(){let e=this,t=arguments,n=s&&!a;a=a||setTimeout(function(){a=null,s||i.apply(e,t)},r),n&&i.apply(e,t)}},f.randomPermute=function(t){for(let e=0;e<t.length;++e){var n=m()%t.length,i=t[e];t[e]=t[n],t[n]=i}},f.randomPick=function(e){return 0==e.length?null:e[m()%e.length]},f.timeSince=function(e){let t=(Date.now()-(e*=1e3))/1e3;return isNaN(t)?"":t<-30?(t=-t)<60?f.lf("in a few seconds"):t<120?f.lf("in a minute"):t<3600?f.lf("in {0} minute{0:s}",Math.floor(t/60)):t<7200?f.lf("in an hour"):t<86400?f.lf("in {0} hour{0:s}",Math.floor(t/60/60)):t<2592e3?f.lf("in {0} day{0:s}",Math.floor(t/60/60/24)):t<31536e3?f.lf("in {0} month{0:s}",Math.floor(t/60/60/24/30)):f.lf("in {0} year{0:s}",Math.floor(t/60/60/24/365)):t<0?f.lf("now"):t<10?f.lf("a few seconds ago"):t<60?f.lf("{0} second{0:s} ago",Math.floor(t)):t<120?f.lf("a minute ago"):t<3600?f.lf("{0} minute{0:s} ago",Math.floor(t/60)):t<7200?f.lf("an hour ago"):t<86400?f.lf("{0} hour{0:s} ago",Math.floor(t/60/60)):t<2592e3?f.lf("{0} day{0:s} ago",Math.floor(t/60/60/24)):t<31536e3?f.lf("{0} month{0:s} ago",Math.floor(t/60/60/24/30)):f.lf("{0} year{0:s} ago",Math.floor(t/60/60/24/365))},f.unicodeToChar=function(e){return e.replace(/\\u([\d\w]{4})/gi,function(e,t){return String.fromCharCode(parseInt(t,16))})},f.escapeForRegex=function(e){return null==e?void 0:e.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")},f.stripUrlProtocol=function(e){return null==e?void 0:e.replace(/.*?:\/\//g,"")},f.normalizePath=c,f.pathJoin=function(e,t){if(c(e),c(t),e||t)return e?t?("/"!==e.charAt(e.length-1)&&(e+="/"),e+(t="/"==t.charAt(0)?t.substring(1):t)):e:t},f.isNodeJS="undefined"==typeof window,f.requestAsync=u,f.httpGetTextAsync=function(e){return u({url:e}).then(e=>e.text)},f.httpGetJsonAsync=function(e){return u({url:e}).then(e=>e.json)},f.httpPostJsonAsync=function(e,t){return u({url:e,data:t||{}}).then(e=>e.json)},f.stringToUint8Array=function(t){var n=t.length,i=new Uint8Array(n);for(let e=0;e<n;++e)i[e]=255&t.charCodeAt(e);return i},f.uint8ArrayToString=function(t){let n=t.length,i="";for(let e=0;e<n;++e)i+=String.fromCharCode(t[e]);return i},f.fromUTF8=function(t){if(!t)return"";let n="";for(let e=0;e<t.length;++e){var i=255&t.charCodeAt(e);n+=37==i||127<i?"%"+i.toString(16):t.charAt(e)}return decodeURIComponent(n)},f.toUTF8=p,f.toHex=function(t){let n="";for(let e=0;e<t.length;++e)n+=("0"+t[e].toString(16)).slice(-2);return n},f.fromHex=function(t){var n=new Uint8Array(t.length>>1);for(let e=0;e<t.length;e+=2)n[e>>1]=parseInt(t.slice(e,e+2),16);return n},f.PromiseQueue=class{constructor(){this.promises={}}enqueue(i,r){return new Promise((e,t)=>{let n=this.promises[i];(n=n||(this.promises[i]=[])).push(()=>r().finally(()=>{n.shift(),0==n.length?delete this.promises[i]:n[0]()}).then(e,t)),1==n.length&&n[0]()})}};let h;function v(e,n,i,r,s,t,a){if(a=a||h.Editor,"en-US"===(i=f.normalizeLanguageCode(i)[0])||"en"===i)return Promise.resolve(void 0);let o,l,c=i+`/${t}/`+a;if(f.translationsCache()[c])return Promise.resolve(f.translationsCache()[c]);switch(a){case h.Editor:o=[{branch:r,staticName:"strings.json",path:"strings.json"},{branch:s,staticName:"target-strings.json",path:e+"/target-strings.json"}];break;case h.Sim:o=[{branch:s,staticName:"sim-strings.json",path:e+"/sim-strings.json"}];break;case h.Apis:o=[{branch:s,staticName:"bundled-strings.json",path:e+"/bundled-strings.json"}];break;case h.SkillMap:o=[{branch:s,staticName:"skillmap-strings.json",path:"/skillmap-strings.json"}]}function u(t){t&&(l=l||{},Object.keys(t).filter(e=>!!t[e]).forEach(e=>l[e]=t[e]))}if(t){let t=0;return d.U.promiseMapAllSeries(o,e=>b(i,e.path,e.branch).then(u,e=>{console.log(e.message),++t})).then(()=>(t&&(f.translationsCache()[c]=l),t!==o.length&&l?Promise.resolve(l):(pxt.tickEvent("translations.livetranslationsfailed"),v(e,n,i,r,s,!1,a))))}return Promise.all(o.map(e=>f.httpGetJsonAsync(n+`locales/${i}/`+e.staticName).catch(e=>{}))).then(e=>{let t={};e.forEach(e=>pxt.Util.jsonMergeFrom(t,e)),Object.keys(t).length&&(l=t,f.translationsCache()[c]=l)},e=>{console.error("failed to load localizations")}).then(()=>l)}function w(e){var t={};for(const n of Object.keys(e))t[n]=k(e[n]);return t}function k(e){var t;return{attributes:Object.assign({},e.attributes),parameters:null==(t=e.parameters)?void 0:t.map(A),extendsTypes:e.extendsTypes?[...e.extendsTypes]:void 0,pkgs:e.pkgs?[...e.pkgs]:void 0,combinedProperties:e.combinedProperties?[...e.combinedProperties]:void 0,name:e.name,namespace:e.namespace,fileName:e.fileName,kind:e.kind,retType:e.retType,isInstance:e.isInstance,isContextual:e.isContextual,qName:e.qName,pkg:e.pkg,snippet:e.snippet,snippetName:e.snippetName,snippetWithMarkers:e.snippetWithMarkers,pySnippet:e.pySnippet,pySnippetName:e.pySnippetName,pySnippetWithMarkers:e.pySnippetWithMarkers,blockFields:e.blockFields,isReadOnly:e.isReadOnly,pyName:e.pyName,pyQName:e.pyQName,snippetAddsDefinitions:e.snippetAddsDefinitions}}function A(e){var t;return{name:e.name,description:e.description,type:e.type,pyTypeString:e.pyTypeString,initializer:e.initializer,default:e.default,properties:null==(t=e.properties)?void 0:t.map(T),handlerParameters:null==(t=e.handlerParameters)?void 0:t.map(T),options:e.options?d.U.clone(e.options):void 0,isEnum:e.isEnum}}function T(e){return{name:e.name,type:e.type}}f.PromiseBuffer=class{constructor(){this.waiting=[],this.available=[]}drain(){for(var e of this.waiting)e(new Error("Promise Buffer Reset"));this.waiting=[],this.available=[]}pushError(e){this.push(e)}push(e){var t=this.waiting.shift();t?t(e):this.available.push(e)}shiftAsync(e=0){var t;return 0<this.available.length?(t=this.available.shift())instanceof Error?Promise.reject(t):Promise.resolve(t):new Promise((t,n)=>{let i=e=>{(e instanceof Error?n:t)(e)};this.waiting.push(i),0<e&&d.U.delay(e).then(()=>{var e=this.waiting.indexOf(i);0<=e&&(this.waiting.splice(e,1),n(new Error("Timeout")))})})}},f.now=g,f.nowSeconds=function(){return Math.round(g()/1e3)},f.timeout=function(t){return new Promise(e=>setTimeout(()=>e(),t))},f.cpuUs=()=>{const e="undefined"!=typeof performance?performance.now.bind(performance)||performance.moznow.bind(performance)||performance.msNow.bind(performance)||performance.webkitNow.bind(performance)||performance.oNow.bind(performance):Date.now;return f.cpuUs=()=>1e3*e(),f.cpuUs()},f.getMime=function(e){e=/\.([a-zA-Z0-9]+)$/.exec(e);if(!e)return"application/octet-stream";switch(e[1].toLowerCase()){case"txt":return"text/plain";case"html":case"htm":return"text/html";case"css":return"text/css";case"js":return"application/javascript";case"jpg":case"jpeg":return"image/jpeg";case"png":return"image/png";case"ico":return"image/x-icon";case"manifest":return"text/cache-manifest";case"webmanifest":return"application/manifest+json";case"json":return"application/json";case"svg":return"image/svg+xml";case"eot":return"application/vnd.ms-fontobject";case"ttf":return"font/ttf";case"woff":return"application/font-woff";case"woff2":return"application/font-woff2";case"md":return"text/markdown";case"xml":return"application/xml";case"m4a":return"audio/m4a";case"mp3":return"audio/mp3";default:return"application/octet-stream"}},f.randomUint32=m,f.guidGen=function(){function e(){return(65536|m()).toString(16).slice(-4)}return e()+e()+"-"+e()+"-4"+e().slice(-3)+"-"+e()+"-"+e()+e()+e()},f.downloadLiveTranslationsAsync=b,f.pxtLangCookieId="PXT_LANG",f.langCookieExpirationDays=30,f.allLanguages={af:{englishName:"Afrikaans",localizedName:"Afrikaans"},ar:{englishName:"Arabic",localizedName:"العربية"},az:{englishName:"Azerbaijani",localizedName:"آذربایجان دیلی"},bg:{englishName:"Bulgarian",localizedName:"български"},bn:{englishName:"Bengali",localizedName:"বাংলা"},ca:{englishName:"Catalan",localizedName:"Català"},cs:{englishName:"Czech",localizedName:"Čeština"},da:{englishName:"Danish",localizedName:"Dansk"},de:{englishName:"German",localizedName:"Deutsch"},el:{englishName:"Greek",localizedName:"Ελληνικά"},en:{englishName:"English",localizedName:"English"},"es-ES":{englishName:"Spanish (Spain)",localizedName:"Español (España)"},"es-MX":{englishName:"Spanish (Mexico)",localizedName:"Español (México)"},et:{englishName:"Estonian",localizedName:"Eesti"},eu:{englishName:"Basque",localizedName:"Euskara"},fa:{englishName:"Persian",localizedName:"فارسی"},fi:{englishName:"Finnish",localizedName:"Suomi"},fr:{englishName:"French",localizedName:"Français"},"fr-CA":{englishName:"French (Canada)",localizedName:"Français (Canada)"},"gu-IN":{englishName:"Gujarati",localizedName:"ગુજરાતી"},he:{englishName:"Hebrew",localizedName:"עברית"},hr:{englishName:"Croatian",localizedName:"Hrvatski"},hu:{englishName:"Hungarian",localizedName:"Magyar"},"hy-AM":{englishName:"Armenian (Armenia)",localizedName:"Հայերէն (Հայաստան)"},id:{englishName:"Indonesian",localizedName:"Bahasa Indonesia"},is:{englishName:"Icelandic",localizedName:"Íslenska"},it:{englishName:"Italian",localizedName:"Italiano"},ja:{englishName:"Japanese",localizedName:"日本語"},kab:{englishName:"Kabyle",localizedName:"شئعم"},ko:{englishName:"Korean",localizedName:"한국어"},kmr:{englishName:"Kurmanji (Kurdish)",localizedName:"کورمانجی‎"},kn:{englishName:"Kannada",localizedName:"ಕನ್ನಡ"},lt:{englishName:"Lithuanian",localizedName:"Lietuvių"},lv:{englishName:"Latvian",localizedName:"Latviešu"},"ml-IN":{englishName:"Malayalam",localizedName:"മലയാളം"},mr:{englishName:"Marathi",localizedName:"मराठी"},nl:{englishName:"Dutch",localizedName:"Nederlands"},no:{englishName:"Norwegian",localizedName:"Norsk"},nb:{englishName:"Norwegian Bokmal",localizedName:"Norsk bokmål"},"nn-NO":{englishName:"Norwegian Nynorsk",localizedName:"Norsk nynorsk"},"pa-IN":{englishName:"Punjabi",localizedName:"ਪੰਜਾਬੀ"},pl:{englishName:"Polish",localizedName:"Polski"},"pt-BR":{englishName:"Portuguese (Brazil)",localizedName:"Português (Brasil)"},"pt-PT":{englishName:"Portuguese (Portugal)",localizedName:"Português (Portugal)"},ro:{englishName:"Romanian",localizedName:"Română"},ru:{englishName:"Russian",localizedName:"Русский"},"si-LK":{englishName:"Sinhala (Sri Lanka)",localizedName:"සිංහල (ශ්රී ලංකා)"},sk:{englishName:"Slovak",localizedName:"Slovenčina"},sl:{englishName:"Slovenian",localizedName:"Slovenski"},sr:{englishName:"Serbian",localizedName:"Srpski"},su:{englishName:"Sundanese",localizedName:"ᮘᮞ ᮞᮥᮔ᮪ᮓ"},"sv-SE":{englishName:"Swedish (Sweden)",localizedName:"Svenska (Sverige)"},ta:{englishName:"Tamil",localizedName:"தமிழ்"},te:{englishName:"Telugu",localizedName:"తెలుగు"},th:{englishName:"Thai",localizedName:"ภาษาไทย"},tl:{englishName:"Tagalog",localizedName:"ᜏᜒᜃᜅ᜔ ᜆᜄᜎᜓᜄ᜔"},tr:{englishName:"Turkish",localizedName:"Türkçe"},uk:{englishName:"Ukrainian",localizedName:"Українська"},"ur-IN":{englishName:"Urdu (India)",localizedName:"اردو (ہندوستان)"},"ur-PK":{englishName:"Urdu (Pakistan)",localizedName:"اردو (پاکستان)"},vi:{englishName:"Vietnamese",localizedName:"Tiếng việt"},"zh-CN":{englishName:"Chinese (Simplified)",localizedName:"简体中文"},"zh-TW":{englishName:"Chinese (Traditional)",localizedName:"繁體中文"}},f.isLocaleEnabled=y,f.updateLocalizationAsync=function(e){const{targetId:t,baseUrl:n,pxtBranch:i,targetBranch:r,force:s}=e;let a=e["code"];if((a="en-US"===(a=f.normalizeLanguageCode(a)[0])?"en":a)===f.userLanguage()||!y(a)&&!s)return pxt.debug(`loc: ${a} (using built-in)`),Promise.resolve();pxt.debug("loc: "+a);const o=pxt.Util.liveLocalizationEnabled();return v(t,n,a,i,r,o,l.pxtc.Util.TranslationsKind.Editor).then(e=>(e&&(f.setUserLanguage(a),f.setLocalizedStrings(e)),l.pxtc.Util.downloadTranslationsAsync(t,n,a,i,r,o,l.pxtc.Util.TranslationsKind.Apis).then(e=>{e&&(l.pxtc.apiLocalizationStrings=e)})))},(e=h=f.TranslationsKind||(f.TranslationsKind={}))[e.Editor=0]="Editor",e[e.Sim=1]="Sim",e[e.Apis=2]="Apis",e[e.SkillMap=3]="SkillMap",f.downloadTranslationsAsync=v,f.capitalize=function(e){return e&&e[0].toLocaleUpperCase()+e.slice(1)},f.uncapitalize=function(e){return(e||"").split(/(?=[A-Z])/g).join(" ").toLowerCase()},f.range=function(t){var n=[];for(let e=0;e<t;++e)n.push(e);return n},f.multipartPostAsync=function(e,n={},t=null,i=null){const r="--------------------------0461489f461126c5";let s="";Object.keys(n).forEach(e=>{var t=e,e=n[e];s=(s+=r+"\r\n")+'Content-Disposition: form-data; name="'+t+'"\r\n\r\n'+e+"\r\n"}),t&&(i=i,a=(t=t).split("/").reverse()[0],s=(s=s+r+'\r\nContent-Disposition: form-data; name="files['+t+']"; filename="'+a+'"\r\n')+"\r\n"+i+"\r\n"),s+=r+"--\r\n";var a,t={url:e,method:"POST",headers:{"Content-Type":"multipart/form-data; boundary="+r.slice(2)},data:s};return f.httpRequestCoreAsync(t)},f.toDataUri=function(e,t){return/^https?:/i.test(e)||/^data:/i.test(e)?e:(t||/^<svg/i.test(e)&&(t="image/svg+xml"),/xml|svg/.test(t)?`data:${t},`+encodeURIComponent(e):`data:${t||"image/png"};base64,`+d.encodeBase64(p(e)))},f.imageMagic=1496611453,f.imageHeaderSize=36,f.encodeBlobAsync=function(e,t){var n=f.imageHeaderSize+t.length,i=3*(e.width*e.height-1);let r=1;for(;r<4&&!(i*r>=8*n);)r++;let s=i*r>>3,a=n-s,o=0,l=e.width*e.height*4;if(0<a){const t=3*e.width,f=(o=Math.ceil(a/t),document.createElement("canvas"));f.width=e.width,f.height=e.height+o,f.getContext("2d").drawImage(e,0,0),e=f}var c=pxt.HF2.encodeU32LE([f.imageMagic,t.length,o,0,0,0,0,0,0]);function u(n,i,r,s){let a=0,o=0,l=s[o++];var c=(1<<r)-1;let u=!0;for(;u;){let e=l>>a&c,t=8-a;if(t<=r){if(o>=s.length){if(0==t)break;u=!1}l=s[o++],e|=l<<t&c,a=r-t}else a+=r;n[i]=255&(n[i]&~c|e),3==(3&++i)&&(n[i++]=255)}return i}pxt.Util.assert(c.length==f.imageHeaderSize);var h=e.getContext("2d"),d=h.getImageData(0,0,e.width,e.height);u(d.data,0,1,[r]);let p=4;for(p=u(d.data,p,r,c),pxt.Util.assert(0==(3&p)),p=0==o?u(d.data,p,r,t):(c=s-c.length,p=u(d.data,p,r,t.slice(0,c)),u(d.data,l,8,t.slice(c))),p|=3;p<d.data.length;)d.data[p]=255,p+=4;return h.putImageData(d,0,0),e},f.decodeBlobAsync=function(e){return pxt.BrowserUtils.loadCanvasAsync(e).then(e=>{const o=e.getContext("2d").getImageData(0,0,e.width,e.height).data,t=1&o[0]|(1&o[1])<<1|(1&o[2])<<2;if(5<t||0==t)return Promise.reject(new Error(f.lf("Invalid encoded PNG format")));function n(e,t,n){let i=0,r=0,s=0;for(var a=(1<<t)-1;r<n.length;)s|=(o[e++]&a)<<i,3==(3&e)&&e++,8<=(i+=t)&&(n[r++]=255&s,s>>=8,i-=8);return e}const i=new Uint8Array(pxt.Util.imageHeaderSize);var r=n(4,t,i),s=pxt.HF2.decodeU32LE(i);if(s[0]!=pxt.Util.imageMagic)return Promise.reject(new Error(f.lf("Invalid magic in encoded PNG")));var a=new Uint8Array(s[1]),s=s[2];if(0<s){const o=(e.height-s)*e.width,f=new Uint8Array((3*(o-1)*t>>3)-pxt.Util.imageHeaderSize),i=(n(r,t,f),a.set(f),new Uint8Array(a.length-f.length));n(4*o,8,i),a.set(i,f.length)}else n(r,t,a);return a})},f.parseQueryString=function(e){let i={};return e.replace(/\+/g," ").replace(/([^#?&=]+)=([^#?&=]*)/g,(e,t,n)=>(i[decodeURIComponent(t)]=decodeURIComponent(n),"")),i},f.stringifyQueryString=function(e,t){for(var n of Object.keys(t))0<=e.indexOf("?")?e+="&":e+="?",e+=encodeURIComponent(n)+"="+encodeURIComponent(t[n]);return e},f.cloneTargetBundle=function(e){const t=(e=Object.assign({},e)).apiInfo;delete e.apiInfo;var n=e.bundleddirs,i=(delete e.bundleddirs,e.bundledpkgs),r=(delete e.bundledpkgs,e.tutorialInfo),s=(delete e.tutorialInfo,f.clone(e));if(t){s.apiInfo={};for(const e of Object.keys(t)){const f=t[e].apis;s.apiInfo[e]={sha:t[e].sha,apis:{jres:Object.assign({},f.jres),byQName:w(f.byQName)}}}}if(n&&(s.bundleddirs=[...n]),i){s.bundledpkgs={};for(const e of Object.keys(i))s.bundledpkgs[e]=Object.assign({},i[e])}if(r){s.tutorialInfo={};for(const e of Object.keys(r)){const t=r[e];s.tutorialInfo[e]={hash:t.hash,usedBlocks:Object.assign({},t.usedBlocks),snippetBlocks:Object.assign({},t.snippetBlocks)}}}return s},f.cloneApis=w,f.cloneSymbolInfo=k,f.toUTF8Array=function(e){return(new TextEncoder).encode(e)},f.fromUTF8Array=function(e){return(new TextDecoder).decode(e)}}}(ts=ts||{}),function(e){var b=e.pxtc||(e.pxtc={});{e=b.BrowserImpl||(b.BrowserImpl={});b.Util.httpRequestCoreAsync=function(l){return new Promise((e,t)=>{let n,i=!1,r=b.Util.clone(l.headers)||{};n=new XMLHttpRequest,l.responseArrayBuffer&&(n.responseType="arraybuffer"),l.withCredentials&&(n.withCredentials=!0),n.onreadystatechange=()=>{if(!i&&4==n.readyState){i=!0;let t={statusCode:n.status,headers:{},buffer:n.responseBody||n.response,text:l.responseArrayBuffer?void 0:n.responseText};n.getAllResponseHeaders().split(/\r?\n/).forEach(e=>{e=/^\s*([^:]+): (.*)/.exec(e);e&&(t.headers[e[1].toLowerCase()]=e[2])}),e(t)}};let s,a=l.data,o=l.method||(null==a?"GET":"POST");null==a?s=null:a instanceof Uint8Array?s=a:"object"==typeof a?(s=JSON.stringify(a),r["content-type"]="application/json; charset=utf8"):"string"==typeof a?s=a:b.Util.oops("bad data"),n.open(o,l.url),Object.keys(r).forEach(e=>{n.setRequestHeader(e,r[e])}),null==s?n.send():n.send(s)})},b.Util.sha256=n,b.Util.getRandomBuf=t=>{if(window.crypto)window.crypto.getRandomValues(t);else for(let e=0;e<t.length;++e)t[e]=Math.floor(255*Math.random())};const v=new Uint32Array([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]);function y(e,t){return e>>>t|e<<32-t}function t(e){let g=new Uint32Array(8),m=(g[0]=1779033703,g[1]=3144134277,g[2]=1013904242,g[3]=2773480762,g[4]=1359893119,g[5]=2600822924,g[6]=528734635,g[7]=1541459225,new Uint32Array(64));function t(n){var e=n.length-63;for(let t=0;t<e;t+=64){for(let e=0;e<16;e++){var i=(e<<2)+t;m[e]=n[i]<<24|n[i+1]<<16|n[i+2]<<8|n[i+3]}{c=void 0;u=void 0;h=void 0;d=void 0;p=void 0;f=void 0;var c=g;var u=m;b.Util.assert(8==c.length),b.Util.assert(64==u.length);for(let e=16;e<64;++e){var h=y(u[e-15],7)^y(u[e-15],18)^u[e-15]>>>3,d=y(u[e-2],17)^y(u[e-2],19)^u[e-2]>>>10;u[e]=u[e-16]+h+u[e-7]+d|0}let t=c[0],n=c[1],i=c[2],r=c[3],s=c[4],a=c[5],o=c[6],l=c[7];for(let e=0;e<64;++e){var p=l+(y(s,6)^y(s,11)^y(s,25))+(s&a^~s&o)+v[e]+u[e]|0,f=t&n^t&i^n&i;l=o,o=a,a=s,s=r+p|0,r=i,i=n,t=p+((y(n=t,2)^y(t,13)^y(t,22))+f|0)|0}c[0]+=t,c[1]+=n,c[2]+=i,c[3]+=r,c[4]+=s,c[5]+=a,c[6]+=o,c[7]+=l}}}t(e);let n=64-(e.length+9)%64,i=(64==n&&(n=0),e.length-e.length%64),r=new Uint8Array(e.length-i+1+n+8),s=0;for(;i<e.length;)r[s++]=e[i++];for(r[s++]=128;0<n--;)r[s++]=0;let a=8*e.length;for(s=r.length;0<a;)r[--s]=255&a,a>>=8;t(r);let o="";for(let e=0;e<g.length;++e)o+=("000000000"+g[e].toString(16)).slice(-8);return o.toLowerCase()}function n(e){pxt.perf.measureStart("sha256buffer");e=t(b.Util.toUTF8Array(e));return pxt.perf.measureEnd("sha256buffer"),e}e.sha256buffer=t,e.sha256string=n}}(ts=ts||{}),function(e){e=e.pxtc||(e.pxtc={});{e=e.jsonPatch||(e.jsonPatch={});const o={add:(e,t,n)=>{if("object"!=typeof e)throw new Error("jsonPatch: expected object type");if(t in e)throw new Error("jsonPatch: object already contains key "+t);e[t]=n},replace:(e,t,n)=>{if("object"!=typeof e)throw new Error("jsonPatch: expected object type");e[t]=n},remove:(e,t)=>{if("object"!=typeof e)throw new Error("jsonPatch: expected object type");delete e[t]}},l={add:(e,t,n)=>{if(!Array.isArray(e))throw new Error("jsonPatch: expected array type");if(t in e)throw new Error(`jsonPatch: key ${t} already exists in array`);"number"!=typeof t||t!==Math.floor(t)?e[t]=n:e.splice(t,0,n)},replace:(e,t,n)=>{if(!Array.isArray(e))throw new Error("jsonPatch: expected array type");"number"!=typeof t||t!==Math.floor(t)?e[t]=n:e.splice(t,1,n)},remove:(e,t)=>{if(!Array.isArray(e))throw new Error("jsonPatch: expected array type");"number"!=typeof t||t!==Math.floor(t)?delete e[t]:e.splice(t,1)}};e.diff=function(e,t){const c={add:[],remove:[],replace:[]};function u(e,t){return!Array.isArray(e)||(e=Number.parseFloat(t),Number.isNaN(e))?t:e}return function e(t,n,i){if(!Object.is(t,n)){n=n||{},t=t||{};for(var r of Object.keys(t))if(!(r in n)){const n=u(t,r);c.remove.push({op:"remove",path:i.concat(n)})}for(const l of Object.keys(n)){var s=t[l],a=n[l],o=u(n,l);o in t?"object"!=typeof s&&"object"!=typeof a&&s!==a||typeof s!=typeof a||Array.isArray(s)!==Array.isArray(a)?c.replace.push({op:"replace",path:i.concat(o),value:a}):e(s,a,i.concat(o)):void 0!==n[o]&&(i.length&&c.add.push({op:"add",path:i,value:Array.isArray(n)?[]:{}}),c.add.push({op:"add",path:i.concat(o),value:a}))}}}(e,t,[]),[...c.remove.reverse(),...c.replace,...c.add.sort((e,t)=>e.path.length-t.path.length)]},e.patchInPlace=function(n,i){if(!n||"object"!=typeof n)throw new Error("jsonPatch: Must be an object or an array.");for(const s of i){const i=s.path.slice(),a=i.pop();if(null==a)throw new Error("jsonPatch: missing last key");let e=n,t=i.shift();for(;null!=t;){if(!(t in e))throw new Error("jsonPatch: missing parent element "+t);e=e[t],t=i.shift()}if(Array.isArray(e)&&"number"!=typeof a)throw new Error("jsonPatch: expected numeric index for array object");var r=Array.isArray(e)?l:o;"remove"===s.op?r.remove(e,a):"add"!==s.op||a in e?"replace"===s.op&&r.replace(e,a,s.value):r.add(e,a,s.value)}}}}(ts=ts||{}),function(n){function s(t,n){if(t===n)return 1;if(t&&n&&"object"==typeof t&&"object"==typeof n){var e=Array.isArray(t),i=Array.isArray(n);if(e&&i){if(t.length!==n.length)return;for(let e=0;e<t.length;++e)if(!s(t[e],n[e]))return}else{if(e!==i)return;e=Object.keys(t);if(e.length!==Object.keys(n).length)return;for(const r of e){if(!n.hasOwnProperty(r))return;if(!s(t[r],n[r]))return}}return 1}return t!=t&&n!=n}var e;(e=(e=(e=n.pxtc||(n.pxtc={})).jsonPatch||(e.jsonPatch={})).tests||(e.tests={})).diffTests=function(){const e=[{comment:"test 1",obja:{a:4,b:5},objb:{a:3,b:5},expected:[{op:"replace",path:["a"],value:3}]},{comment:"test 2",obja:{a:3,b:5},objb:{a:4,c:5},expected:[{op:"remove",path:["b"]},{op:"replace",path:["a"],value:4},{op:"add",path:["c"],value:5}]},{comment:"test 3",obja:{a:4,b:[1,2,3]},objb:{a:3,b:[1,2,4]},expected:[{op:"replace",path:["a"],value:3},{op:"replace",path:["b",2],value:4}]},{comment:"test 4",obja:{a:3,b:[1,2,4]},objb:{a:3,b:[1,2,4,5]},expected:[{op:"add",path:["b"],value:[]},{op:"add",path:["b",3],value:5}]},{comment:"test 5",obja:{a:4,b:{c:3}},objb:{a:4,b:{c:4}},expected:[{op:"replace",path:["b","c"],value:4}]},{comment:"test 6",obja:{a:4,b:{c:4}},objb:{a:5,b:{d:4}},expected:[{op:"remove",path:["b","c"]},{op:"replace",path:["a"],value:5},{op:"add",path:["b"],value:{}},{op:"add",path:["b","d"],value:4}]},{comment:"test 7",obja:{a:4,b:[2,"foo"]},objb:{a:4,b:[2,"foo",["this","that"]]},expected:[{op:"add",path:["b"],value:[]},{op:"add",path:["b",2],value:["this","that"]}]}];for(const t of e){console.log(t.comment);const e=n.pxtc.jsonPatch.diff(t.obja,t.objb);s(e,t.expected)?console.log("succeeded"):(console.error("FAILED"),console.log("got",e),console.log("exp",t.expected))}},e.patchTests=function(){for(const e of[{comment:"test 1",obj:{a:"foo",b:[4,11]},patches:[{op:"remove",path:["b"]},{op:"replace",path:["a"],value:4},{op:"add",path:["c"],value:5}],expected:{a:4,c:5}},{comment:"test 2",obj:{a:4,b:[1,2,3]},patches:[{op:"replace",path:["a"],value:3},{op:"replace",path:["b",2],value:4},{op:"add",path:["b",3],value:9}],expected:{a:3,b:[1,2,4,9]}},{comment:"test 3",obj:{a:4,b:{c:3}},patches:[{op:"replace",path:["a"],value:5},{op:"remove",path:["b","c"]},{op:"add",path:["b","d"],value:4}],expected:{a:5,b:{d:4}}},{comment:"test 4",obj:{a:4},patches:[{op:"add",path:["b"],value:[]},{op:"add",path:["b",0],value:"foo"},{op:"add",path:["b",1],value:"bar"}],expected:{a:4,b:["foo","bar"]},validate:e=>e.b&&e.b.forEach}])console.log(e.comment),n.pxtc.jsonPatch.patchInPlace(e.obj,e.patches),s(e.obj,e.expected)&&e.validate&&!e.validate(e.obj)?e.expected&&(console.error("FAILED"),console.log("got",e.obj),console.log("exp",e.expected)):console.log("succeeded")}}(ts=ts||{}),function(e){e.perf||(e.perf={})}(pxt=pxt||{}),pxt.perf.report||(pxt.perf.report=()=>{}),pxt.perf.recordMilestone||(pxt.perf.recordMilestone=()=>{}),pxt.perf.measureStart||(pxt.perf.measureStart=()=>{}),pxt.perf.measureEnd||(pxt.perf.measureEnd=()=>{}),function(r){let n;r.U=pxtc.Util,r.Util=pxtc.Util;let s,a,e,o={};function i(e,t){/^csv-/.test(e)?r.setAppTargetVariant(e.replace(/^csv-*/,"")):r.appTarget&&(o[e]=t,r.U.jsonCopyFrom(r.appTarget.compile.switches,o),r.U.jsonCopyFrom(n.compile.switches,o))}function l(){let t=r.appTarget.compile,n=((t=t||(r.appTarget.compile={isNative:!1,hasHex:!1,switches:{}})).hasHex&&!t.nativeType&&(t.nativeType=pxtc.NATIVE_TYPE_THUMB),t.switches||(t.switches={}),r.U.jsonCopyFrom(t.switches,o),t.jsRefCounting=!1,t.useUF2||t.useELF||null!=t.noSourceInFlash||(t.noSourceInFlash=!0),void 0===t.utf8&&(t.utf8=!0),r.appTarget.appTheme||(r.appTarget.appTheme={}),r.appTarget.appTheme.embedUrl||(r.appTarget.appTheme.embedUrl=r.appTarget.appTheme.homeUrl),r.appTarget.compileService);n&&n.yottaTarget&&!n.yottaBinary&&(n.yottaBinary="pxt-microbit-app-combined.hex");const i=r.appTarget.appTheme;i&&Object.keys(i).filter(e=>/(logo|hero)$/i.test(e)&&/^@cdnUrl@/.test(i[e])).forEach(e=>i[e]=r.BrowserUtils.patchCdn(i[e]));var e=r.appTarget.simulator;if(e&&e.boardDefinition&&e.boardDefinition.visual&&(e=e.boardDefinition.visual).image&&(e.image=r.BrowserUtils.patchCdn(e.image),e.outlineImage)&&(e.outlineImage=r.BrowserUtils.patchCdn(e.outlineImage)),Object.keys(r.appTarget.bundledpkgs).forEach(e=>{var e=r.appTarget.bundledpkgs[e],t=JSON.parse(e[r.CONFIG_NAME]);t.icon&&(t.icon=r.BrowserUtils.patchCdn(t.icon)),e[r.CONFIG_NAME]=r.Package.stringifyConfig(t)}),"undefined"!=typeof window){const t={"lockededitor=1":{appTheme:{lockedEditor:!0}},"hidemenu=1":{appTheme:{hideMenuBar:!0}}},n=(r.appTarget.queryVariants&&r.Util.jsonCopyFrom(t,r.appTarget.queryVariants),window.location.href);Object.keys(t).forEach(e=>{new RegExp(e,"i").exec(n)&&(e=t[e])&&r.U.jsonMergeFrom(r.appTarget,e)})}}function c(e=!1){r.perf.measureStart("reloadAppTargetVariant");var t=e?"":JSON.stringify(r.appTarget);if(r.appTarget=r.U.cloneTargetBundle(n),r.appTargetVariant){const n=r.appTarget.variants&&r.appTarget.variants[r.appTargetVariant];n?r.U.jsonMergeFrom(r.appTarget,n):r.U.userError(lf("Variant '{0}' not defined in pxtarget.json",r.appTargetVariant))}l(),!e&&r.onAppTargetChanged&&t!=JSON.stringify(r.appTarget)&&r.onAppTargetChanged(),r.perf.measureEnd("reloadAppTargetVariant")}function t(){return{relprefix:"/--",workerjs:"/worker.js",monacoworkerjs:"/monacoworker.js",gifworkerjs:"/gifjs/gif.worker.js",serviceworkerjs:"/serviceworker.js",typeScriptWorkerJs:"/tsworker.js",pxtVersion:"local",pxtRelId:"localRelId",pxtCdnUrl:"/cdn/",commitCdnUrl:"/cdn/",blobCdnUrl:"/blb/",cdnUrl:"/cdn/",targetUrl:"",targetVersion:"local",targetRelId:"",targetId:r.appTarget?r.appTarget.id:"",simUrl:"/sim/simulator.html",simserviceworkerUrl:"/simulatorserviceworker.js",simworkerconfigUrl:"/sim/workerConfig.js",partsUrl:"/sim/siminstructions.html"}}function u(){return e=e||r.Cloud.downloadTargetConfigAsync().then(e=>e||{},e=>({}))}function h(e=null){return(e=e||r.appTarget.compile).nativeType==ts.pxtc.NATIVE_TYPE_VM?e.useESP?e.useUF2?ts.pxtc.BINARY_UF2:ts.pxtc.BINARY_ESP:ts.pxtc.BINARY_PXT64:e.useUF2&&!e.switches.rawELF?ts.pxtc.BINARY_UF2:e.useELF?ts.pxtc.BINARY_ELF:ts.pxtc.BINARY_HEX}r.setAppTarget=function(e){r.appTarget=e||{},l(),n=r.U.cloneTargetBundle(r.appTarget)},r.setBundledApiInfo=function(e){for(const r of Object.keys(e)){const s=e[r].apis.byQName;for(const e of Object.keys(s)){var t=s[e],n=e.lastIndexOf("."),i=t.pyQName,n=s[e]={kind:Math.abs(t.kind||7),qName:e,namespace:e.slice(0,n<0?0:n),name:e.slice(n+1),pyQName:i,pyName:i?i.slice(i.lastIndexOf(".")+1):void 0,fileName:"",attributes:t.attributes||{},retType:t.retType||"void",parameters:t.parameters?t.parameters.map(e=>({name:e.name,description:e.description||"",type:e.type||"number",initializer:e.initializer,default:e.default,options:e.options||{},isEnum:!!e.isEnum,handlerParameters:e.handlerParameters})):null,extendsTypes:t.extendsTypes,snippet:t.kind&&t.kind<0?null:void 0,isInstance:!!t.isInstance,isReadOnly:!!t.isReadOnly},i=n.attributes;i.paramDefl||(i.paramDefl={}),i.callingConvention||(i.callingConvention=0),i.paramHelp||(i.paramHelp={}),i.jsDoc||(i.jsDoc=""),i._name=n.name.replace(/@.*/,"")}}s=e},r.getBundledApiInfo=function(){return s},r.savedAppTheme=function(){return n?n.appTheme:void 0},r.setCompileSwitch=i,r.setCompileSwitches=function(e){if(e)for(var t of e.split(/[\s,;:]+/))t&&("-"==t[0]?i(t.slice(1),!1):i(t,!0))},r.bundledSvg=function(n){if(n){let e=a&&a[n];if(e)return e;if(r.appTarget.simulator&&r.appTarget.simulator.dynamicBoardDefinition){a=a||{};var i=r.appTarget.bundledpkgs[n];if(i){if(JSON.parse(i["pxt.json"]).core&&i["board.json"]){const t=JSON.parse(i["board.json"]);if(t&&t.visual&&t.visual.image){let e=t.visual.image;/^pkg:\/\//.test(e)&&(e=i[e.slice(6)]),a[n]="data:image/svg+xml;base64,"+ts.pxtc.encodeBase64(r.Util.toUTF8(e))}}return a[n]}}}},r.reloadAppTargetVariant=c,r.setAppTargetVariant=function(e,t={}){r.debug("app variant: "+e),(t.force||r.appTargetVariant!==e&&(r.appTargetVariant||e))&&(r.appTargetVariant=e,c(t.temporary))},r.setHwVariant=function(e,t){e=e.replace(/.*---/,""),/^[\w\-]+$/.test(e)?(r.hwVariant=e,r.hwName=t||e):(r.hwVariant=null,r.hwName=null),r.debug(`hwVariant: ${r.hwVariant} (${r.hwName})`)},r.hasHwVariants=function(){return!!r.appTarget.variants&&Object.keys(r.appTarget.bundledpkgs).some(e=>/^hw---/.test(e))},r.getHwVariants=function(){return r.appTarget.variants?Object.keys(r.appTarget.bundledpkgs).filter(e=>/^hw---/.test(e)).map(e=>JSON.parse(r.appTarget.bundledpkgs[e][r.CONFIG_NAME])).filter(e=>!!r.appTarget.appTheme.experimentalHw||!e.experimentalHw):[]},r.options={},r.debug="undefined"!=typeof console&&console.debug?e=>{r.options.debug&&console.debug(e)}:()=>{},r.log="undefined"!=typeof console&&console.log?e=>{console.log(e)}:()=>{},r.reportException=function(e,t){if(console&&(console.error(e),t))try{console.log(t)}catch(e){}},r.reportError=function(e,t,n){if(console&&(console.error(e+": "+t),n))try{r.log(JSON.stringify(n,null,2))}catch(e){}},r.localWebConfig=t,r.getOnlineCdnUrl=function(){var e;return r.webConfig&&(e=/^(https:\/\/[^\/]+)/.exec(r.webConfig.commitCdnUrl))?e[1]:null},r.setupWebConfig=function(e){e?r.webConfig=e:r.webConfig||(r.webConfig=t())},r.getEmbeddedScript=function(e){return r.U.lookup(r.appTarget.bundledpkgs||{},e)},r.targetConfigAsync=u,r.packagesConfigAsync=function(){return u().then(e=>e?e.packages:void 0)},r.CONFIG_NAME="pxt.json",r.SIMSTATE_JSON=".simstate.json",r.SERIAL_EDITOR_FILE="serial.txt",r.README_FILE="README.md",r.GITIGNORE_FILE=".gitignore",r.ASSETS_FILE="assets.json",r.CLOUD_ID="pxt/",r.BLOCKS_PROJECT_NAME="blocksprj",r.JAVASCRIPT_PROJECT_NAME="tsprj",r.PYTHON_PROJECT_NAME="pyprj",r.MAIN_BLOCKS="main.blocks",r.MAIN_TS="main.ts",r.MAIN_PY="main.py",r.DEFAULT_GROUP_NAME="other",r.TILEMAP_CODE="tilemap.g.ts",r.TILEMAP_JRES="tilemap.g.jres",r.IMAGES_CODE="images.g.ts",r.IMAGES_JRES="images.g.jres",r.TUTORIAL_CODE_START="_onCodeStart.ts",r.TUTORIAL_CODE_STOP="_onCodeStop.ts",r.TUTORIAL_INFO_FILE="tutorial-info-cache.json",r.TUTORIAL_CUSTOM_TS="tutorial.custom.ts",r.BREAKPOINT_TABLET=991,r.outputName=h,r.isOutputText=function(e=null){return h(e)==ts.pxtc.BINARY_HEX}}(pxt=pxt||{}),function(r){{var i=r.blocks||(r.blocks={});const f="this";let t;function n(){if((t={device_while:{name:r.Util.lf("a loop that repeats while the condition is true"),tooltip:r.Util.lf("Run the same sequence of actions while the condition is met."),url:"/blocks/loops/while",category:"loops",block:{message0:r.Util.lf("while %1"),appendField:r.Util.lf("{id:while}do")}},pxt_controls_for:{name:r.Util.lf("a loop that repeats the number of times you say"),tooltip:r.Util.lf("Have the variable '{0}' take on the values from 0 to the end number, counting by 1, and do the specified blocks."),url:"blocks/loops/for",category:"loops",block:{message0:r.Util.lf("for %1 from 0 to %2"),variable:r.Util.lf("{id:var}index"),appendField:r.Util.lf("{id:for}do")}},controls_simple_for:{name:r.Util.lf("a loop that repeats the number of times you say"),tooltip:r.Util.lf("Have the variable '{0}' take on the values from 0 to the end number, counting by 1, and do the specified blocks."),url:"blocks/loops/for",category:"loops",block:{message0:r.Util.lf("for %1 from 0 to %2"),variable:r.Util.lf("{id:var}index"),appendField:r.Util.lf("{id:for}do")}},pxt_controls_for_of:{name:r.Util.lf("a loop that repeats for each value in an array"),tooltip:r.Util.lf("Have the variable '{0}' take the value of each item in the array one by one, and do the specified blocks."),url:"blocks/loops/for-of",category:"loops",block:{message0:r.Util.lf("for element %1 of %2"),variable:r.Util.lf("{id:var}value"),appendField:r.Util.lf("{id:for_of}do")}},controls_for_of:{name:r.Util.lf("a loop that repeats for each value in an array"),tooltip:r.Util.lf("Have the variable '{0}' take the value of each item in the array one by one, and do the specified blocks."),url:"blocks/loops/for-of",category:"loops",block:{message0:r.Util.lf("for element %1 of %2"),variable:r.Util.lf("{id:var}value"),appendField:r.Util.lf("{id:for_of}do")}},math_op2:{name:r.Util.lf("minimum or maximum of 2 numbers"),tooltip:{min:r.Util.lf("smaller value of 2 numbers"),max:r.Util.lf("larger value of 2 numbers")},url:"/blocks/math",operators:{op:["min","max"]},category:"math"},math_op3:{name:r.Util.lf("absolute number"),tooltip:r.Util.lf("absolute value of a number"),url:"/reference/math",category:"math",block:{message0:r.Util.lf("absolute of %1")}},math_number:{name:r.Util.lf("{id:block}number"),url:"/blocks/math/random",category:"math",tooltip:r.appTarget&&r.appTarget.compile?r.Util.lf("a decimal number"):r.Util.lf("an integer number")},math_integer:{name:r.Util.lf("{id:block}number"),url:"/blocks/math/random",category:"math",tooltip:r.Util.lf("an integer number")},math_whole_number:{name:r.Util.lf("{id:block}number"),url:"/blocks/math/random",category:"math",tooltip:r.Util.lf("a whole number")},math_number_minmax:{name:r.Util.lf("{id:block}number"),url:"/blocks/math/random",category:"math"},math_arithmetic:{name:r.Util.lf("arithmetic operation"),url:"/blocks/math",tooltip:{ADD:r.Util.lf("Return the sum of the two numbers."),MINUS:r.Util.lf("Return the difference of the two numbers."),MULTIPLY:r.Util.lf("Return the product of the two numbers."),DIVIDE:r.Util.lf("Return the quotient of the two numbers."),POWER:r.Util.lf("Return the first number raised to the power of the second number.")},operators:{OP:["ADD","MINUS","MULTIPLY","DIVIDE","POWER"]},category:"math",block:{MATH_ADDITION_SYMBOL:r.Util.lf("{id:op}+"),MATH_SUBTRACTION_SYMBOL:r.Util.lf("{id:op}-"),MATH_MULTIPLICATION_SYMBOL:r.Util.lf("{id:op}×"),MATH_DIVISION_SYMBOL:r.Util.lf("{id:op}÷"),MATH_POWER_SYMBOL:r.Util.lf("{id:op}**")}},math_modulo:{name:r.Util.lf("division remainder"),tooltip:r.Util.lf("Return the remainder from dividing the two numbers."),url:"/blocks/math",category:"math",block:{MATH_MODULO_TITLE:r.Util.lf("remainder of %1 ÷ %2")}},math_js_op:{name:r.Util.lf("math function"),tooltip:{sqrt:r.Util.lf("Returns the square root of the argument"),sin:r.Util.lf("Returns the sine of the argument"),cos:r.Util.lf("Returns the cosine of the argument"),tan:r.Util.lf("Returns the tangent of the argument"),atan2:r.Util.lf("Returns the arctangent of the quotient of the two arguments"),idiv:r.Util.lf("Returns the integer portion of the division operation on the two arguments"),imul:r.Util.lf("Returns the integer portion of the multiplication operation on the two arguments")},url:"/blocks/math",operators:{OP:["sqrt","sin","cos","tan","atan2","idiv","imul"]},category:"math",block:{sqrt:r.Util.lf("{id:op}square root"),sin:r.Util.lf("{id:op}sin"),cos:r.Util.lf("{id:op}cos"),tan:r.Util.lf("{id:op}tan"),atan2:r.Util.lf("{id:op}atan2"),idiv:r.Util.lf("{id:op}integer ÷"),imul:r.Util.lf("{id:op}integer ×")}},math_js_round:{name:r.Util.lf("rounding functions"),tooltip:{round:r.Util.lf("Increases the argument to the next higher whole number if its fractional part is more than one half"),ceil:r.Util.lf("Increases the argument to the next higher whole number"),floor:r.Util.lf("Decreases the argument to the next lower whole number"),trunc:r.Util.lf("Removes the fractional part of the argument")},url:"/blocks/math",operators:{OP:["round","ceil","floor","trunc"]},category:"math",block:{round:r.Util.lf("{id:op}round"),ceil:r.Util.lf("{id:op}ceiling"),floor:r.Util.lf("{id:op}floor"),trunc:r.Util.lf("{id:op}truncate")}},variables_change:{name:r.Util.lf("update the value of a number variable"),tooltip:r.Util.lf("Changes the value of the variable by this amount"),url:"/blocks/variables/change",category:"variables",block:{message0:r.Util.lf("change %1 by %2")}},controls_repeat_ext:{name:r.Util.lf("a loop that repeats and increments an index"),tooltip:r.Util.lf("Do some statements several times."),url:"/blocks/loops/repeat",category:"loops",block:{CONTROLS_REPEAT_TITLE:r.Util.lf("repeat %1 times"),CONTROLS_REPEAT_INPUT_DO:r.Util.lf("{id:repeat}do")}},variables_get:{name:r.Util.lf("get the value of a variable"),tooltip:r.Util.lf("Returns the value of this variable."),url:"/blocks/variables",category:"variables",block:{VARIABLES_GET_CREATE_SET:r.Util.lf("Create 'set %1'")}},variables_get_reporter:{name:r.Util.lf("get the value of a variable"),tooltip:r.Util.lf("Returns the value of this variable."),url:"/blocks/variables",category:"variables",block:{VARIABLES_GET_CREATE_SET:r.Util.lf("Create 'set %1'")}},variables_set:{name:r.Util.lf("assign the value of a variable"),tooltip:r.Util.lf("Sets this variable to be equal to the input."),url:"/blocks/variables/assign",category:"variables",block:{VARIABLES_SET:r.Util.lf("set %1 to %2")}},controls_if:{name:r.Util.lf("a conditional statement"),tooltip:{CONTROLS_IF_TOOLTIP_1:r.Util.lf("If a value is true, then do some statements."),CONTROLS_IF_TOOLTIP_2:r.Util.lf("If a value is true, then do the first block of statements. Otherwise, do the second block of statements."),CONTROLS_IF_TOOLTIP_3:r.Util.lf("If the first value is true, then do the first block of statements. Otherwise, if the second value is true, do the second block of statements."),CONTROLS_IF_TOOLTIP_4:r.Util.lf("If the first value is true, then do the first block of statements. Otherwise, if the second value is true, do the second block of statements. If none of the values are true, do the last block of statements.")},tooltipSearch:"CONTROLS_IF_TOOLTIP_2",url:"/blocks/logic/if",category:"logic",block:{CONTROLS_IF_MSG_IF:r.Util.lf("{id:logic}if"),CONTROLS_IF_MSG_THEN:r.Util.lf("{id:logic}then"),CONTROLS_IF_MSG_ELSE:r.Util.lf("{id:logic}else"),CONTROLS_IF_MSG_ELSEIF:r.Util.lf("{id:logic}else if")}},lists_create_with:{name:r.Util.lf("create an array"),tooltip:r.Util.lf("Creates a new array."),url:"/reference/arrays/create",category:"arrays",blockTextSearch:"LISTS_CREATE_WITH_INPUT_WITH",block:{LISTS_CREATE_EMPTY_TITLE:r.Util.lf("empty array"),LISTS_CREATE_WITH_INPUT_WITH:r.Util.lf("array of"),LISTS_CREATE_WITH_CONTAINER_TITLE_ADD:r.Util.lf("array"),LISTS_CREATE_WITH_ITEM_TITLE:r.Util.lf("value")}},lists_length:{name:r.Util.lf("array length"),tooltip:r.Util.lf("Returns the number of items in an array."),url:"/reference/arrays/length",category:"arrays",block:{LISTS_LENGTH_TITLE:r.Util.lf("length of array %1")}},lists_index_get:{name:r.Util.lf("get a value in an array"),tooltip:r.Util.lf("Returns the value at the given index in an array."),url:"/reference/arrays/get",category:"arrays",block:{message0:r.Util.lf("%1 get value at %2")}},lists_index_set:{name:r.Util.lf("set a value in an array"),tooltip:r.Util.lf("Sets the value at the given index in an array"),url:"/reference/arrays/set",category:"arrays",block:{message0:r.Util.lf("%1 set value at %2 to %3")}},logic_compare:{name:r.Util.lf("comparing two numbers"),tooltip:{LOGIC_COMPARE_TOOLTIP_EQ:r.Util.lf("Return true if both inputs equal each other."),LOGIC_COMPARE_TOOLTIP_NEQ:r.Util.lf("Return true if both inputs are not equal to each other."),LOGIC_COMPARE_TOOLTIP_LT:r.Util.lf("Return true if the first input is smaller than the second input."),LOGIC_COMPARE_TOOLTIP_LTE:r.Util.lf("Return true if the first input is smaller than or equal to the second input."),LOGIC_COMPARE_TOOLTIP_GT:r.Util.lf("Return true if the first input is greater than the second input."),LOGIC_COMPARE_TOOLTIP_GTE:r.Util.lf("Return true if the first input is greater than or equal to the second input.")},url:"/blocks/logic/boolean",category:"logic",block:{search:"= ≠ < ≤ > ≥"}},logic_operation:{name:r.Util.lf("boolean operation"),tooltip:{LOGIC_OPERATION_TOOLTIP_AND:r.Util.lf("Return true if both inputs are true."),LOGIC_OPERATION_TOOLTIP_OR:r.Util.lf("Return true if at least one of the inputs is true.")},url:"/blocks/logic/boolean",category:"logic",block:{LOGIC_OPERATION_AND:r.Util.lf("{id:op}and"),LOGIC_OPERATION_OR:r.Util.lf("{id:op}or")}},logic_negate:{name:r.Util.lf("logical negation"),tooltip:r.Util.lf("Returns true if the input is false. Returns false if the input is true."),url:"/blocks/logic/boolean",category:"logic",block:{LOGIC_NEGATE_TITLE:r.Util.lf("not %1")}},logic_boolean:{name:r.Util.lf("a `true` or `false` value"),tooltip:r.Util.lf("Returns either true or false."),url:"/blocks/logic/boolean",category:"logic",block:{LOGIC_BOOLEAN_TRUE:r.Util.lf("{id:boolean}true"),LOGIC_BOOLEAN_FALSE:r.Util.lf("{id:boolean}false")}},text:{name:r.Util.lf("a piece of text"),tooltip:r.Util.lf("A letter, word, or line of text."),url:"types/string",category:"text",block:{search:r.Util.lf("a piece of text")}},text_length:{name:r.Util.lf("number of characters in the string"),tooltip:r.Util.lf("Returns the number of letters (including spaces) in the provided text."),url:"reference/text/length",category:"text",block:{TEXT_LENGTH_TITLE:r.Util.lf("length of %1")}},text_join:{name:r.Util.lf("join items to create text"),tooltip:r.Util.lf("Create a piece of text by joining together any number of items."),url:"reference/text/join",category:"text",block:{TEXT_JOIN_TITLE_CREATEWITH:r.Util.lf("join")}},procedures_defnoreturn:{name:r.Util.lf("define the function"),tooltip:r.Util.lf("Create a function."),url:"types/function/define",category:"functions",block:{PROCEDURES_DEFNORETURN_TITLE:r.Util.lf("function"),PROCEDURE_ALREADY_EXISTS:r.Util.lf("A function named '%1' already exists.")}},procedures_callnoreturn:{name:r.Util.lf("call the function"),tooltip:r.Util.lf("Call the user-defined function."),url:"types/function/call",category:"functions",block:{PROCEDURES_CALLNORETURN_TITLE:r.Util.lf("call function")}},function_return:{name:r.Util.lf("return a value from within a function"),tooltip:r.Util.lf("Return a value from within a user-defined function."),url:"types/function/return",category:"functions",block:{message_with_value:r.Util.lf("return %1"),message_no_value:r.Util.lf("return")}},function_definition:{name:r.Util.lf("define the function"),tooltip:r.Util.lf("Create a function."),url:"types/function/define",category:"functions",block:{FUNCTIONS_EDIT_OPTION:r.Util.lf("Edit Function")}},function_call:{name:r.Util.lf("call the function"),tooltip:r.Util.lf("Call the user-defined function."),url:"types/function/call",category:"functions",block:{FUNCTIONS_CALL_TITLE:r.Util.lf("call"),FUNCTIONS_GO_TO_DEFINITION_OPTION:r.Util.lf("Go to Definition")}},function_call_output:{name:r.Util.lf("call the function with a return value"),tooltip:r.Util.lf("Call the user-defined function with a return value."),url:"types/function/call",category:"functions",block:{}}})[pxtc.ON_START_TYPE]={name:r.Util.lf("on start event"),tooltip:r.Util.lf("Run code when the program starts"),url:"/blocks/on-start",category:"loops",block:{message0:r.Util.lf("on start %1 %2")}},t[pxtc.PAUSE_UNTIL_TYPE]={name:r.Util.lf("pause until"),tooltip:r.Util.lf("Pause execution of code until the given boolean expression is true"),url:"/blocks/pause-until",category:"loops",block:{message0:r.Util.lf("pause until %1")}},t[pxtc.TS_BREAK_TYPE]={name:r.Util.lf("break"),tooltip:r.Util.lf("Break out of the current loop or switch"),url:"/blocks/loops/break",category:"loops",block:{message0:r.Util.lf("break")}},t[pxtc.TS_CONTINUE_TYPE]={name:r.Util.lf("continue"),tooltip:r.Util.lf("Skip current iteration and continues with the next iteration in the loop"),url:"/blocks/loops/continue",category:"loops",block:{message0:r.Util.lf("continue")}},r.Util.isTranslationMode()){const i=Blockly.Msg;r.Util.values(t).filter(e=>e.block).forEach(n=>{var e=Object.keys(n.block);n.translationIds=r.Util.values(n.block),e.forEach(t=>r.crowdin.inContextLoadAsync(n.block[t]).then(e=>{n.block[t]=e,/^[A-Z_]+$/.test(t)&&(i[t]=e)}))})}}i.MATH_FUNCTIONS={unary:["sqrt","sin","cos","tan"],binary:["atan2"],infix:["idiv","imul"]},i.ROUNDING_FUNCTIONS=["round","ceil","floor","trunc"],i.builtinFunctionInfo={"Math.abs":{blockId:"math_op3",params:["x"]},"Math.min":{blockId:"math_op2",params:["x","y"]},"Math.max":{blockId:"math_op2",params:["x","y"]}},i.normalizeBlock=function(e,t=r.log){if(!e)return e;let n=e.replace(/(?:^|[^\\])([%$])\s+/g,"$1");return n!=e&&(t("block has extra spaces: "+e),e=n),(n=(e=n).replace(/([%$]\w+)\s*=\s*(\w+)/,"$1=$2"))!=e&&(t("block has space between %name and = : "+e),e=n),n=n.replace(/\s*\|\s*/g,"|")},i.compileInfo=function(n){const r={parameters:[],actualNameToParam:{},definitionNameToParam:{},handlerArgs:[]},t=(1==n.kind||2==n.kind)&&!n.attributes.defaultInstance,s=!!n.attributes._def,a=s?n.attributes._def.parameters.slice(0):void 0,o=s?a.length:n.parameters?n.parameters.length:0,l=i.builtinFunctionInfo[n.qName],c=(s&&n.attributes._expandedDef&&a.push(...n.attributes._expandedDef.parameters),{}),u=a?a.filter(e=>!e.ref||(c[e.name]=e,!1)):[];if(t&&s&&a.length){const i=c.this||a[0],t=i.name;let e;i.shadowBlockId&&"variables_get"!==i.shadowBlockId||(e=i.varName||n.attributes.paramDefl[t]||n.attributes.paramDefl.this),r.thisParameter={actualName:f,definitionName:t,shadowBlockId:i.shadowBlockId,type:n.namespace,defaultValue:e,fieldEditor:h(t,f),fieldOptions:d(t,f),shadowOptions:p(t,f)}}if(n.parameters){let i=t&&!c.this?1:0;n.parameters.forEach((t,e)=>{let n;if(c[t.name]?n=c[t.name]:i<u.length&&(n=u[i],++i),n||!s){let e;t.options&&t.options.min&&t.options.max&&(e={min:t.options.min.value,max:t.options.max.value});const s=n?n.name:l?l.params[i++]:t.name,c=n&&("variables_get"===n.shadowBlockId||"lists_create_with"==n.shadowBlockId);r.parameters.push({actualName:t.name,type:t.type,defaultValue:c&&n.varName||t.default,definitionName:s,shadowBlockId:n&&n.shadowBlockId,isOptional:!!a&&a.indexOf(n)>=o,fieldEditor:h(s,t.name),fieldOptions:d(s,t.name),shadowOptions:p(s,t.name),range:e})}t.handlerParameters&&t.handlerParameters.forEach(t=>{r.handlerArgs.push({name:t.name,type:t.type,inBlockDef:!!a&&a.some(e=>e.ref&&e.name===t.name)})})})}return r.parameters.forEach(e=>{r.actualNameToParam[e.actualName]=e,r.definitionNameToParam[e.definitionName]=e}),r;function h(e,t){return n.attributes.paramFieldEditor&&(n.attributes.paramFieldEditor[e]||n.attributes.paramFieldEditor[t])}function d(e,t){return n.attributes.paramFieldEditorOptions&&(n.attributes.paramFieldEditorOptions[e]||n.attributes.paramFieldEditorOptions[t])}function p(e,t){return n.attributes.paramShadowOptions&&(n.attributes.paramShadowOptions[e]||n.attributes.paramShadowOptions[t])}},i.hasHandler=function(e){return e.parameters&&e.parameters.some(e=>{var t;return"() => void"==e.type||"Action"==e.type||!(null==(t=e.properties)||!t.length)||!(null==(t=e.handlerParameters)||!t.length)})},i.reporterTypeForArgType=function(e){let t="boolean"!==e&&"number"!==e&&"string"!==e?"argument_reporter_custom":"argument_reporter_"+e;return t},i.defaultIconForArgType=function(e=""){switch(e){case"number":return"calculator";case"string":return"text width";case"boolean":return"random";case"Array":return"list";default:return"align justify"}},i.parseFields=function(e){return e.split("|").map((e,t)=>{var n=/([^%]*)\s*%([a-zA-Z0-9_]+)/.exec(e);if(!n)return{n:e,ni:t};let i=n[1];return{n:e,ni:t,pre:i=i&&i.trim(),p:n[2]}})},i.blockDefinitions=function(){return t||n(),t},i.getBlockDefinition=function(e){return t||n(),t[e]}}}(pxt=pxt||{}),function(u){{var l=u.BrowserUtils||(u.BrowserUtils={});function s(){return"undefined"!=typeof navigator}function e(){return s()&&/(Win32|Win64|WOW64)/i.test(navigator.platform)}function o(){return s()&&/mobi/i.test(navigator.userAgent)}function c(){return s()&&/Mac/i.test(navigator.platform)}function h(){return!!navigator&&/Linux/i.test(navigator.platform)}function d(){return s()&&/arm/i.test(navigator.platform)}function p(){return s()&&/Edge/i.test(navigator.userAgent)}function f(){return s()&&/Trident/i.test(navigator.userAgent)}function g(){return!p()&&!f()&&!!navigator&&(/Chrome/i.test(navigator.userAgent)||/Chromium/i.test(navigator.userAgent))}function m(){return!g()&&!p()&&!!navigator&&/(Macintosh|Safari|iPod|iPhone|iPad)/i.test(navigator.userAgent)}function b(){return!m()&&!!navigator&&(/Firefox/i.test(navigator.userAgent)||/Seamonkey/i.test(navigator.userAgent))}function y(){return s()&&/Opera|OPR/i.test(navigator.userAgent)}function v(){return s()&&/Midori/i.test(navigator.userAgent)}function w(){return s()&&/Epiphany/i.test(navigator.userAgent)}function k(){return"undefined"!=typeof window&&("ontouchstart"in window||navigator&&0<navigator.maxTouchPoints)}function A(){return"undefined"!=typeof window&&!!window.pxtElectron}function T(){return"undefined"!=typeof window&&!!window.ipcRenderer}function x(){return A()||T()}function E(e){var t;try{return"undefined"!=typeof window&&/^http:\/\/(localhost|127\.0\.0\.1):\d+\//.test(window.location.href)&&(e||!/nolocalhost=1/.test(window.location.href))&&!(null!=(t=null==u?void 0:u.webConfig)&&t.isStatic)}catch(e){return!1}}function C(){return"undefined"!=typeof window&&!!window.PointerEvent}function I(){return e()?"windows":c()?"mac":h()&&d()?"rpi":h()?"linux":"unknown"}function U(){return p()?"edge":w()?"epiphany":v()?"midori":y()?"opera":f()?"ie":g()?"chrome":m()?"safari":b()?"firefox":"unknown"}function S(){if(!s())return null;let e=[];return y()&&(e=/(Opera|OPR)\/([0-9\.]+)/i.exec(navigator.userAgent)),(e=w()?/Epiphany\/([0-9\.]+)/i.exec(navigator.userAgent):v()?/Midori\/([0-9\.]+)/i.exec(navigator.userAgent):m()?(e=/Version\/([0-9\.]+)/i.exec(navigator.userAgent))||/(Macintosh|iPod( touch)?|iPhone|iPad); (CPU|Intel).*?OS (X )?(\d+)/i.exec(navigator.userAgent):(g()?/(Chrome|Chromium)\/([0-9\.]+)/i:p()?/Edge\/([0-9\.]+)/i:f()?/(MSIE |rv:)([0-9\.]+)/i:/(Firefox|Seamonkey)\/([0-9\.]+)/i).exec(navigator.userAgent))&&0!=e.length?e[e.length-1]:null}l.isIFrame=function(){try{return window&&window.self!==window.top}catch(e){return!0}},l.hasNavigator=s,l.hasWindow=function(){return"undefined"!=typeof window},l.isWindows=e,l.isWindows10=function(){return s()&&/(Win32|Win64|WOW64)/i.test(navigator.platform)&&/Windows NT 10/i.test(navigator.userAgent)},l.isMobile=o,l.isIOS=function(){return s()&&(/iPad|iPhone|iPod/.test(navigator.userAgent)||"MacIntel"===navigator.platform&&1<navigator.maxTouchPoints)},l.isAndroid=function(){return s()&&/android/i.test(navigator.userAgent)},l.isMac=c,l.isLinux=h,l.isARM=d,l.isUwpEdge=function(){return"undefined"!=typeof window&&!!window.Windows},l.isEdge=p,l.isChromiumEdge=function(){return s()&&/Edg\//i.test(navigator.userAgent)},l.isIE=f,l.isChrome=g,l.isSafari=m,l.isFirefox=b,l.isOpera=y,l.isMidori=v,l.isEpiphany=w,l.isTouchEnabled=k,l.isPxtElectron=A,l.isIpcRenderer=T,l.isElectron=x,l.isWinRT=()=>!1,l.isLocalHost=E,l.isLocalHostDev=function(){return E()&&!x()},l.isSkillmapEditor=function(){try{return/skill(?:s?)Map=1/.test(window.location.href)}catch(e){return!1}},l.isTabletSize=function(){return(null===window||void 0===window?void 0:window.innerWidth)<u.BREAKPOINT_TABLET},l.isComputerSize=function(){return(null===window||void 0===window?void 0:window.innerWidth)>=u.BREAKPOINT_TABLET},l.noSharedLocalStorage=function(){try{return/nosharedlocalstorage/i.test(window.location.href)}catch(e){return!1}},l.useOldTutorialLayout=function(){try{return/tutorialview=old/.test(window.location.href)}catch(e){return!1}},l.hasPointerEvents=C,l.hasSaveAs=function(){return p()||f()||b()},l.os=I,l.browser=U,l.browserVersion=S;let a=!1;function $(){return o()&&m()&&!/downloadWindowOpen=0/i.test(window.location.href)}function N(t,e,n){var i=$(),r=S(),s=parseInt(r||"0");if(i)n?n.location.href=t:window.open(t,"_self");else if(u.BrowserUtils.isSafari()&&(s<10||0==r.indexOf("10.0")||o())){let e=document.getElementById("downloader");e||(u.debug("injecting downloader iframe"),(e=document.createElement("iframe")).id="downloader",e.style.position="absolute",e.style.right="0",e.style.bottom="0",e.style.zIndex="-1",e.style.width="1px",e.style.height="1px",document.body.appendChild(e)),e.src=t}else/^data:/i.test(t)&&(u.BrowserUtils.isEdge()||u.BrowserUtils.isIE())?(i=atob(t.split(",")[1]),n=u.Util.stringToUint8Array(i),s=new Blob([n],{type:"img/png"}),window.navigator.msSaveOrOpenBlob(s,e)):"string"==typeof(r=window.document.createElement("a")).download?(r.href=t,r.download=e,document.body.appendChild(r),r.click(),document.body.removeChild(r)):document.location.href=t}function H(e,t){let n="data";o()&&m()&&u.appTarget.appTheme.mobileSafariDownloadProtocol&&(n=u.appTarget.appTheme.mobileSafariDownloadProtocol);var i=/downloadProtocol=([a-z0-9:/?]+)/i.exec(window.location.href);return(n=i?i[1]:n)+":"+t+";base64,"+e}function P(e,t,n={}){u.debug("trigger download");var{contentType:i="application/octet-stream",userContextWindow:r,onError:n,maintainObjectURL:s}=n,a=null==(a=window.URL)?void 0:a.createObjectURL,o=u.appTarget.appTheme.disableBlobObjectDownload;let l;try{if(a&&!o){const n=a(new Blob([u.Util.stringToUint8Array(atob(e))],{type:i}));N(n,t,r),s?l=n:window.setTimeout(()=>window.URL.revokeObjectURL(l),0)}else N(l=H(e,t),t,r)}catch(e){n&&n(e),u.debug("saving failed")}return l}function G(n){const i=document.createElement("img");return new Promise((e,t)=>{i.onload=()=>e(i),i.onerror=()=>e(void 0),i.crossOrigin="anonymous",i.src=n})}function _(e){return/^https?:\/\//i.test(e)?e:(window.MonacoPaths||{})[e]||(u.U.startsWith(e,u.webConfig.commitCdnUrl)?e:u.webConfig.commitCdnUrl+e)}l.isBrowserSupported=function(){var e,t,n,i,r,s;return!navigator||!!/bot|crawler|spider|crawling/i.test(navigator.userAgent)||(null==(e=(null==(e=u.appTarget)?void 0:e.unsupportedBrowsers)||(null==(e=window.pxtTargetBundle)?void 0:e.unsupportedBrowsers))||!e.some(e=>e.id==U()))&&(e=S(),i=parseInt(e||"0"),s=g()&&38<=i,r=b()&&31<=i,t=p(),n=m()&&9<=i,i=y()&&g()&&21<=i,s=s||r||t||n||i,r=v()||h()&&d()&&w(),s=(s=s&&!r)||/anybrowser=(true|1)/.test(window.location.href),a||(u.log(`Browser: ${U()} ${e} on `+I()),s||u.tickEvent("browser.unsupported",{useragent:navigator.userAgent}),a=!0),s)},l.devicePixelRatio=function(){var e,t;return"undefined"!=typeof window&&window.screen?(e=window.screen.systemXDPI,t=window.screen.logicalXDPI,void 0!==e&&void 0!==t&&t<e?e/t:window&&void 0!==window.devicePixelRatio?window.devicePixelRatio:1):1},l.browserDownloadBinText=function(e,t,n){return P(ts.pxtc.encodeBase64(e),t,n)},l.browserDownloadText=function(e,t,n){return P(ts.pxtc.encodeBase64(u.Util.toUTF8(e)),t,n)},l.isBrowserDownloadInSameWindow=$,l.isBrowserDownloadWithinUserContext=function(){var e=S(),e=parseInt(e||"0");return o()&&m()&&11<=e||/downloadUserContext=1/i.test(window.location.href)},l.browserDownloadDataUri=N,l.browserDownloadUInt8Array=function(e,t,n){return P(ts.pxtc.encodeBase64(u.Util.uint8ArrayToString(e)),t,n)},l.toDownloadDataUri=H,l.browserDownloadBase64=P,l.loadImageAsync=G,l.loadCanvasAsync=function(e){return G(e).then(e=>{var t=document.createElement("canvas");return t.width=e.width,t.height=e.height,t.getContext("2d").drawImage(e,0,0),t})},l.scaleImageData=function(e,t){var n=document.createElement("canvas"),i=(n.width=e.width*t,n.height=e.height*t,n.getContext("2d"));return i.putImageData(e,0,0),i.imageSmoothingEnabled=!1,i.scale(t,t),i.drawImage(n,0,0),i.getImageData(0,0,e.width*t,e.height*t)},l.imageDataToPNG=function(e,t=1){var n,i;if(e)return(n=document.createElement("canvas")).width=e.width*t,n.height=e.height*t,(i=n.getContext("2d")).putImageData(e,0,0),i.imageSmoothingEnabled=!1,i.scale(t,t),i.drawImage(n,0,0),n.toDataURL("image/png")},l.encodeToPngAsync=function(t,e){const{width:s,height:a,pixelDensity:o=4,maxSize:l=1e6,text:c}=e||{};return new Promise((i,e)=>{const r=new Image;r.onload=function(){const t=document.createElement("canvas"),e=t.getContext("2d");t.width=(s||r.width)*o,t.height=(a||r.height)*o,c&&(e.fillStyle="#fff",e.fillRect(0,0,t.width,t.height)),e.drawImage(r,0,0,s,a,0,0,t.width,t.height);let n=t.toDataURL("image/png");for(;n.length>l;)t.width=t.width/2>>0,t.height=t.height/2>>0,u.debug(`screenshot size ${n.length}b, shrinking to ${t.width}x`+t.height),e.drawImage(r,0,0,s,a,0,0,t.width,t.height),n=t.toDataURL("image/png");c?u.lzmaCompressAsync(c).then(e=>{e=u.Util.encodeBlobAsync(t,e);i(e.toDataURL("image/png"))}):i(n)},r.onerror=e=>{u.reportError("png","png rendering failed"),i(void 0)},r.src=t})},l.resolveCdnUrl=_,l.loadStyleAsync=function(e,t){const i="style-"+(e=t?"rtl"+e:e);if(document.getElementById(i))return Promise.resolve();const r=_(e),n=u.Util.toArray(document.head.getElementsByTagName("link")).filter(e=>e.getAttribute("href")==r)[0];return n?(n.id||(n.id=i),Promise.resolve()):new Promise((e,t)=>{var n=document.createElement("link");n.href=r,n.rel="stylesheet",n.type="text/css",n.id=i,n.addEventListener("load",()=>e()),n.addEventListener("error",e=>t(e)),document.head.appendChild(n)})};let t,n,i,r={};function z(e,t){return e?t?(e.indexOf("/")==e.length-1?e.substring(0,e.length-1):e)+"/"+(0==t.indexOf("/")?t.substring(1):t):e:t}function V(){var e=s()&&window.navigator;return e&&e.storage&&e.storage.estimate?e.storage.estimate():Promise.resolve({})}l.loadScriptAsync=function(e){const i=_(e);let t=r[i];return t=t||(r[i]=new Promise((e,t)=>{u.debug("script: loading "+i);var n=document.createElement("script");n.type="text/javascript",n.addEventListener("load",()=>e()),n.addEventListener("error",e=>{delete r[i],t(e)}),n.src=i,n.async=!0,document.body.appendChild(n)}))},l.loadAjaxAsync=function(i){return new Promise((e,t)=>{let n=new XMLHttpRequest;n.onreadystatechange=function(){n.readyState==XMLHttpRequest.DONE&&(200==n.status?e(n.responseText):t(n.status))},n.open("GET",i,!0),n.send()})},l.loadBlocklyAsync=function(){if(!t){u.debug("blockly: delay load");let e=u.BrowserUtils.loadStyleAsync("blockly.css",ts.pxtc.Util.isUserLanguageRtl());e=(e="undefined"==typeof Blockly?e.then(()=>u.BrowserUtils.loadScriptAsync("pxtblockly.js")):e).then(()=>{u.debug("blockly: loaded")}),t=e}return t},l.patchCdn=function(e){var t;return e&&((t=u.getOnlineCdnUrl())?e.replace("@cdnUrl@",t):e.replace(/@cdnUrl@\/(blob|commit)\/[a-f0-9]{40}\//,"./"))},l.initTheme=function(){const e=u.appTarget.appTheme;if(e&&e.accentColor&&((t=document.createElement("style")).type="text/css",t.appendChild(document.createTextNode(`.ui.accent { color: ${e.accentColor}; }
                .ui.inverted.menu .accent.active.item, .ui.inverted.accent.menu  { background-color: ${e.accentColor}; }`)),document.getElementsByTagName("head")[0].appendChild(t)),u.Util.isUserLanguageRtl()){u.debug("rtl layout"),u.BrowserUtils.addClass(document.body,"rtl"),document.body.style.direction="rtl";const e=u.Util.toArray(document.head.getElementsByTagName("link")),n=e.filter(e=>u.Util.endsWith(e.getAttribute("href"),"semantic.css"))[0];if(n){const e=n.getAttribute("data-rtl");e&&(u.debug("swapping to "+e),n.setAttribute("href",e))}var t=e.filter(e=>u.Util.endsWith(e.getAttribute("href"),"blockly.css"))[0];if(t){const e=t.getAttribute("data-rtl");e&&(u.debug("swapping to "+e),t.setAttribute("href",e),t.removeAttribute("data-rtl"))}}},l.changeHash=function(e,t){"#"!=e.charAt(0)&&(e="#"+e),t?window.location.hash=e:window.history.replaceState("","",e)},l.urlJoin=z,l.joinURLs=function(...t){let n;if(t)for(let e=0;e<t.length;e++)n=z(n,t[e]);return n},l.storageEstimateAsync=V,l.scheduleStorageCleanup=s()&&navigator.storage&&navigator.storage.estimate?ts.pxtc.Util.throttle(function(){V().then(e=>(u.debug(`storage estimate: ${e.usage/e.quota*100>>0}%, ${e.usage/1e6>>0}/${e.quota/1e6>>0}Mb`),e.quota&&e.usage&&1e6<e.quota&&.9<e.usage/e.quota?(u.log("quota usage exceeded, clearing translations"),u.tickEvent("storage.cleanup"),O()):Promise.resolve())).catch(e=>{u.reportException(e)})},1e4,!1):()=>{},l.stressTranslationsAsync=function t(){let n="...";for(let e=0;e<16;++e)n+=n+Math.random();return console.log(`adding entry ${2*n.length} bytes`),u.U.delay(1).then(()=>J()).then(e=>e.setAsync("foobar",Math.random().toString(),"",null,void 0,n)).then(()=>u.BrowserUtils.storageEstimateAsync()).then(e=>!e.quota||e.usage/e.quota<.8?t():Promise.resolve())};class M{constructor(){this.translations={}}key(e,t,n){return e+`|${t}|`+(n||"master")}get(e,t,n){return this.translations[this.key(e,t,n)]}getAsync(e,t,n){return Promise.resolve(this.get(e,t,n))}set(e,t,n,i,r,s,a){this.translations[this.key(e,t,n)]={etag:i,time:r,strings:s,md:a}}setAsync(e,t,n,i,r,s){return this.set(e,t,n,i,u.Util.now(),r),Promise.resolve()}clearAsync(){return this.translations={},Promise.resolve()}}class j{constructor(e,t,n,i){this.name=e,this.version=t,this.upgradeHandler=n,this.quotaExceededHandler=i}throwIfNotOpened(){if(!this._db)throw new Error("Database not opened; call IDBWrapper.openAsync() first")}errorHandler(e,t,n){console.error(new Error(this.name+` IDBWrapper error for ${t}: `+e.message)),n(e),"QuotaExceededError"==e.name&&(u.log("storage quota exceeded..."),u.tickEvent("storage.quotaexceedederror"),this.quotaExceededHandler)&&this.quotaExceededHandler()}getObjectStore(e,t="readonly"){return this.throwIfNotOpened(),this._db.transaction([e],t).objectStore(e)}static deleteDatabaseAsync(i){return new Promise((e,t)=>{const n=(window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB).deleteDatabase(i);n.onsuccess=()=>e(),n.onerror=()=>t(n.error)})}openAsync(){return new Promise((e,t)=>{const n=(window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB).open(this.name,this.version);n.onsuccess=()=>{this._db=n.result,e()},n.onerror=()=>this.errorHandler(n.error,"open",t),n.onupgradeneeded=e=>this.upgradeHandler(e,n)})}getAsync(i,r){return new Promise((e,t)=>{const n=this.getObjectStore(i).get(r);n.onsuccess=()=>e(n.result),n.onerror=()=>this.errorHandler(n.error,"get",t)})}getAllAsync(r){return new Promise((e,t)=>{const n=this.getObjectStore(r).openCursor(),i=[];n.onsuccess=()=>{n.result?(i.push(n.result.value),n.result.continue()):e(i)},n.onerror=()=>this.errorHandler(n.error,"getAll",t)})}setAsync(r,s){return new Promise((e,t)=>{var n=this.getObjectStore(r,"readwrite");let i;(i=void 0!==s.id&&null!==s.id?n.put(s):n.add(s)).onsuccess=()=>e(),i.onerror=()=>this.errorHandler(i.error,"set",t)})}deleteAsync(i,r){return new Promise((e,t)=>{const n=this.getObjectStore(i,"readwrite").delete(r);n.onsuccess=()=>e(),n.onerror=()=>this.errorHandler(n.error,"delete",t)})}deleteAllAsync(i){return new Promise((e,t)=>{const n=this.getObjectStore(i,"readwrite").clear();n.onsuccess=()=>e(),n.onerror=()=>this.errorHandler(n.error,"deleteAll",t)})}}l.IDBWrapper=j;class F{constructor(e){this.db=e,this.mem=new M}static dbName(){return"__pxt_translations_"+(u.appTarget.id||"")}static createAsync(){function t(){const e=new j(F.dbName(),2,(e,t)=>{t.result.createObjectStore(F.TABLE,{keyPath:F.KEYPATH})},()=>{O().catch(e=>{})});return e.openAsync().then(()=>new F(e))}return t().catch(e=>(console.log("db: failed to open database, try delete entire store..."),j.deleteDatabaseAsync(F.dbName()).then(()=>t())))}getAsync(t,n,i){t=(t||"en-US").toLowerCase();var e=this.mem.key(t,n,i),r=this.mem.get(t,n,i);return r?Promise.resolve(r):this.db.getAsync(F.TABLE,e).then(e=>e?(this.mem.set(t,n,i,e.etag,e.time,e.strings),Promise.resolve(e)):Promise.resolve(void 0)).catch(e=>Promise.resolve(void 0))}setAsync(e,t,n,i,r,s){e=(e||"en-US").toLowerCase();var a=this.mem.key(e,t,n),o=u.Util.now(),e=(this.mem.set(e,t,n,i,o,r,s),r&&Object.keys(r).filter(e=>!r[e]).forEach(e=>delete r[e]),{id:a,etag:i,time:o,strings:r,md:s});return this.db.setAsync(F.TABLE,e).finally(()=>l.scheduleStorageCleanup()).catch(e=>(console.log(`db: set failed (${e.message}), recycling...`),this.clearAsync()))}clearAsync(){return this.db.deleteAllAsync(F.TABLE).then(()=>console.debug("db: all clean")).catch(e=>{console.error("db: failed to delete all")})}}function J(){return u.Util.isNodeJS?Promise.resolve(new M):n=n||F.createAsync().catch(()=>new M)}function O(){function t(){const t=F.dbName();return j.deleteDatabaseAsync(t).then(()=>{n=void 0}).catch(e=>{u.log("db: failed to delete "+t),n=void 0})}return n?n.then(e=>e.clearAsync()).catch(e=>t().then()):t()}function D(e){e=JSON.stringify(e)+u.appTarget.versions.pxt+"_"+u.appTarget.versions.target;return pxtc.U.sha256(e)}function L(e,t){return e+"|"+(t||"master")}F.TABLE="files",F.KEYPATH="id",l.translationDbAsync=J,l.clearTranslationDbAsync=O,l.getTutorialCodeHash=D;class B{constructor(e){this.db=e}static dbName(){return"__pxt_tutorialinfo_"+(u.appTarget.id||"")}static createAsync(){function t(){const e=new u.BrowserUtils.IDBWrapper(B.dbName(),2,(e,t)=>{t.result.createObjectStore(B.TABLE,{keyPath:B.KEYPATH})},()=>{u.BrowserUtils.IDBWrapper.deleteDatabaseAsync(B.dbName())});return e.openAsync().then(()=>new B(e))}return t().catch(e=>(console.log("db: failed to open tutorial info database, try delete entire store..."),u.BrowserUtils.IDBWrapper.deleteDatabaseAsync(B.dbName()).then(()=>t())))}getAsync(e,t,n){const i=L(e,n),r=D(t);return this.db.getAsync(B.TABLE,i).then(e=>{if(e&&e.hash==r&&u.Util.now()-(e.time||0)<864e5)return e;this.db.deleteAsync(B.TABLE,i)})}setAsync(e,t,n,i){u.perf.measureStart("tutorial info db setAsync"),L(e,i);i=D(n);return this.setWithHashAsync(e,t,i)}setWithHashAsync(e,n,t,i){u.perf.measureStart("tutorial info db setAsync");const r=L(e,i),s={};Object.keys(n).forEach(t=>{Object.keys(n[t]).forEach(e=>{s[e]=n[t][e]})});e={id:r,time:u.Util.now(),hash:t,snippets:n,blocks:s};return this.db.setAsync(B.TABLE,e).then(()=>{u.perf.measureEnd("tutorial info db setAsync")})}clearAsync(){return this.db.deleteAllAsync(B.TABLE).then(()=>console.debug("db: all clean")).catch(e=>{console.error("db: failed to delete all")})}}function R(e){return e.split(/\s+/).filter(e=>!!e)}function q(){var e=new RegExp(u.Util.escapeForRegex(u.Util.pxtLangCookieId)+"=(.*?)(?:;|$)").exec(document.cookie);return e&&e[1]||null}B.TABLE="info",B.KEYPATH="id",l.tutorialInfoDbAsync=function(){return i=i||B.createAsync()},l.clearTutorialInfoDbAsync=function(){function t(){const t=B.dbName();return j.deleteDatabaseAsync(t).then(()=>{i=void 0}).catch(e=>{u.log("db: failed to delete "+t),i=void 0})}return i?i.then(e=>e.clearAsync()).catch(e=>t().then()):t()},l.pointerEvents=C()?{up:"pointerup",down:["pointerdown"],move:"pointermove",enter:"pointerenter",leave:"pointerleave"}:k()?{up:"mouseup",down:["mousedown","touchstart"],move:"touchmove",enter:"touchenter",leave:"touchend"}:{up:"mouseup",down:["mousedown"],move:"mousemove",enter:"mouseenter",leave:"mouseleave"},l.getPageX=function(e){return("pageX"in e?e:e.changedTouches[0]).pageX},l.getPageY=function(e){return("pageY"in e?e:e.changedTouches[0]).pageY},l.getClientX=function(e){return("clientX"in e?e:e.changedTouches[0]).clientX},l.getClientY=function(e){return("clientY"in e?e:e.changedTouches[0]).clientY},l.popupWindow=function(e,t,n,i){try{const u=window.screenLeft||window.screenX,r=window.screenTop||window.screenY,s=window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth,a=window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight,o=s/2-n/2+u,l=a/2-i/2+r,c=window.open(e,t,"width="+n+", height="+i+", top="+l+", left="+o);return c.focus&&c.focus(),c}catch(t){return u.tickEvent("pxt.popupError",{url:e,msg:t.message}),null}},l.containsClass=function(n,e){return R(e).every(e=>{return e=e,(t=n).classList?t.classList.contains(e):!((t.className+"").split(/\s+/).indexOf(e)<0);var t})},l.addClass=function(n,e){R(e).forEach(e=>{var t;e=e,(t=n).classList?t.classList.add(e):(t.className+"").split(/\s+/).indexOf(e)<0&&(t.className.baseVal+=" "+e)})},l.removeClass=function(n,e){R(e).forEach(e=>{var t;t=e,(e=n).classList?e.classList.remove(t):e.className.baseVal=(e.className+"").split(/\s+/).filter(e=>e!=t).join(" ")})},l.getCookieLang=q,l.setCookieLang=function(e,t=!1){u.Util.allLanguages[e]&&e!==q()&&(u.tickEvent("menu.lang.setcookielang",{lang:e,docs:""+t}),(t=new Date).setTime(t.getTime()+24*u.Util.langCookieExpirationDays*60*60*1e3),document.cookie=`${u.Util.pxtLangCookieId}=${e}; expires=${t.toUTCString()}; path=/`)},l.cacheBustingUrl=function(e){return e&&(/[?&]rnd=/.test(e)?e:`${e}${0<e.indexOf("?")?"&":"?"}rnd=`+Math.random())}}}(pxt=pxt||{}),function(e){(e.cloud||(e.cloud={})).cloudStatus={none:{value:"none"},synced:{value:"synced",icon:"cloud-saved-b",tooltip:lf("Project saved to cloud"),shortStatus:lf("saved"),longStatus:lf("Saved to cloud"),indicator:""},justSynced:{value:"justSynced",icon:"cloud-saved-b",tooltip:lf("Project saved to cloud"),shortStatus:lf("saved!"),longStatus:lf("Saved to cloud!"),indicator:""},offline:{value:"offline",icon:"cloud-error-b",tooltip:lf("Unable to connect to cloud"),shortStatus:lf("offline"),longStatus:lf("Offline"),indicator:lf("offline")},syncing:{value:"syncing",icon:"cloud-saving-b",tooltip:lf("Saving project to cloud..."),shortStatus:lf("saving..."),longStatus:lf("Saving to cloud..."),indicator:lf("syncing...")},conflict:{value:"conflict",icon:"cloud-error-b",tooltip:lf("Project was edited in two places and the changes conflict"),shortStatus:lf("conflict!"),longStatus:lf("Project has a conflict!"),indicator:"!"},localEdits:{value:"localEdits",icon:"cloud-saving-b",tooltip:lf("Saving project to the cloud..."),shortStatus:lf("saving..."),longStatus:lf("Saving to cloud..."),indicator:"*"}}}(pxt=pxt||{}),function(e){var n;(n=e.commands||(e.commands={})).deployCoreAsync=void 0,n.deployFallbackAsync=void 0,n.hasDeployFn=()=>n.deployCoreAsync||n.deployFallbackAsync,n.deployAsync=(e,t)=>(n.deployCoreAsync||n.deployFallbackAsync)(e,t),n.patchCompileResultAsync=void 0,n.browserDownloadAsync=void 0,n.saveOnlyAsync=void 0,n.renderBrowserDownloadInstructions=void 0,n.renderUsbPairDialog=void 0,n.renderIncompatibleHardwareDialog=void 0,n.showUploadInstructionsAsync=void 0,n.saveProjectAsync=void 0,n.electronDeployAsync=void 0,n.webUsbPairDialogAsync=void 0,n.onTutorialCompleted=void 0}(pxt=pxt||{}),function(r){function e(){let e;return e||(e=r.U.isNodeJS?Promise.resolve(require("lzma")):Promise.resolve(window.LZMA)).then(e=>(e||r.reportError("lzma","failed to load"),e)),e}r.lzmaDecompressAsync=function(i){return e().then(t=>new Promise((n,e)=>{try{t.decompress(i,(e,t)=>{t&&r.debug("lzma decompression failed"),n(t?void 0:e)})}catch(e){e&&r.debug("lzma decompression failed"),n(void 0)}}))},r.lzmaCompressAsync=function(i){return e().then(t=>new Promise((n,e)=>{try{t.compress(i,7,(e,t)=>{t&&r.reportException(t),n(t?void 0:new Uint8Array(e))})}catch(e){r.reportException(e),n(void 0)}}))}}(pxt=pxt||{}),function(ce){{var e=ce.cpp||(ce.cpp={}),ue=pxtc.Util;let oe=ue.lf;const pe={"pxt::mkAction":1,"pxt::dumpPerfCounters":1,"pxt::deepSleep":1,"pxt::getConfig":1,"pxtrt::mkMap":1,"pxtrt::mapSet":1,"pxtrt::stclo":1,"pxtrt::mklocRef":1,"pxtrt::stlocRef":1,"pxtrt::ldlocRef":1,"pxtrt::panic":1};function he(n="namespace"){let i="",r="",e=(e,t="")=>{r!=e&&(r&&(i+="}\n"),e&&(i+=t||n+" "+e+" {\n"),r=e)},t="    ";return{setNs:e,clear:()=>{i="",r=""},write:e=>{e.trim()?(e=e.trim().replace(/^\s*/gm,t).replace(/^(\s*)\*/gm,(e,t)=>t+" *"),i+=e+"\n"):i+="\n"},incrIndent:()=>{t+="    "},decrIndent:()=>{t=t.slice(4)},finish:()=>(e(""),i)}}function de(e){if(!e)return null;e=e.trim();var t=/^\((.*)\)/.exec(e);return t&&(e=t[1]),/^-?(\d+|0[xX][0-9a-fA-F]+)$/.test(e)?parseInt(e):null}e.nsWriter=he,e.parseCppInt=de;let le={};class fe extends Error{constructor(e){super(e),this.isUserError=!0,this.message=e}}function l(t){if(!t)return"";let n="";for(let e=0;e<t.length;++e){var i=255&t[e];n+=37==i||127<i?"%"+i.toString(16):String.fromCharCode(i)}return decodeURIComponent(n)}function c(e){let t="",n=0;for(;n<e.length;n+=2)t=e[n]+e[n+1]+t;return ce.Util.assert(n==e.length),t}function s(n){var i=[65,20,14,47,184,47,162,187];e:for(let t=0;t<n.length;t+=16)if(n[t]==i[0]){for(let e=0;e<i.length;++e)if(n[t+e]!=i[e])continue e;var e,r=n[t+8]|n[t+9]<<8,s=n[t+10]|n[t+11]<<8|n[t+12]<<16|n[t+13]<<24,s=(t+=16)+r+s;if(!(s>n.length))return e=n.slice(t,t+r),r=n.slice(t+r,s),{meta:l(e),text:r}}return null}function t(e){function t(e){return ce.debug(e),Promise.reject(new Error(e))}let n;var i;if(ce.HF2.read32(e,0)==ts.pxtc.UF2.UF2_MAGIC_START0&&(i=ts.pxtc.UF2.toBin(e))&&(n=s(i.buf)),1179403647==ce.HF2.read32(e,0)&&(n=s(e)),!(n=58==e[0]?function(e){if(e){let n,i=0,r=0,s=0,a=0;if(e.split(/\r?\n/).forEach(e=>{var t=/^:10....0[0E]41140E2FB82FA2BB(....)(....)(....)(....)(..)/.exec(e);if(t)i=parseInt(c(t[1]),16),r=parseInt(c(t[2]),16),s=i+r,n=new Uint8Array(s);else if(0<s&&(t=/^:10....0[0E](.*)(..)$/.exec(e))){let e=t[1];for(;0<s&&0<e.length;)n[a++]=parseInt(e[0]+e[1],16),e=e.slice(2),s--}}),n&&0==s&&a==n.length){var t=new Uint8Array(i),o=new Uint8Array(r);for(let e=0;e<i;++e)t[e]=n[e];for(let e=0;e<r;++e)o[e]=n[i+e];return{meta:l(t),text:o}}}}(l(e)||""):n)||!n.meta||!n.text)return t("This .hex file doesn't contain source.");let r=JSON.parse(n.meta);return r?"LZMA"==r.compression?ce.lzmaDecompressAsync(n.text).then(e=>{var t;return e?(t=e.slice(0,r.headerSize||r.metaSize||0),e=e.slice(t.length),t&&ce.Util.jsonCopyFrom(r,JSON.parse(t)),{meta:r,source:e}):null}):r.compression?t(`Compression type ${r.compression} not supported.`):Promise.resolve({source:l(n.text)}):t("This .hex file is not valid.")}e.PkgConflictError=fe,e.getExtensionInfo=function(t){var e,R={__appVariant:ce.appTargetVariant||""},M="dal.d.ts";let n="/source/",i="",j=[];for(e of t.sortedDeps(!0).sort((e,t)=>"this"==e.id?1:"this"==t.id?-1:ue.strcmp(e.id,t.id)))e.disablesVariant(ce.appTargetVariant)||e.resolvedDependencies().some(e=>e.disablesVariant(ce.appTargetVariant))?(i&&(i+=", "),i+=e.id,ce.debug(`disable variant ${ce.appTargetVariant} due to `+e.id)):(j.push(e),e.addSnapshot(R,[M,".h",".cpp"]));var r,F=JSON.stringify(R),s=le[F];if(s){ce.debug("Using cached extinfo");const t=ue.flatClone(s);return t.disabledDeps=i,t}ce.debug("Generating new extinfo");const m=pxtc.emptyExtInfo();m.disabledDeps=i;let a=ce.appTarget.compileService,o=(a=a||{gittag:"none",serviceId:"nocompile"},a=ue.clone(a),t.getTargetOptions());o=o||{isNative:!1,hasHex:!1,switches:{}};const B=!!a.platformioIni,l="codal"==a.buildEngine||"dockercodal"==a.buildEngine,$="dockermake"==a.buildEngine||"dockercross"==a.buildEngine,H="dockerespidf"==a.buildEngine,b=!(B||l||$||H),G=o.nativeType==pxtc.NATIVE_TYPE_VM;B?n="/src/":l||$?n="/pxtapp/":H&&(n="/main/");let z="// Configuration defines\n",y="\nPXT_SHIMS_BEGIN\n",v="",V="",J='#include "pxt.h"\n',c="",w=e=>c+=`   ${W}(${q}): ${e}
`,q=0,W="",k=he("namespace"),A=he("declare namespace"),T=he("declare namespace"),Y="",K={},X={};const Q={true:"1",false:"0",null:"0",NULL:"0"};function x(e){return e.trim().replace(/[\_\*]$/,"")}for(const t of j){if(0<=t.getFiles().indexOf(M)){const ue=t.host().readFile(t,M);ce.Util.assert(!!ue,"dal.d.ts not found in "+t.id),ue.split(/\r?\n/).forEach(e=>{e=/^\s*(\w+) = (.*),/.exec(e);e&&(Q[e[1]]=e[2])})}for(const ce of t.getFiles())(0<=["Makefile","sdkconfig.defaults","CMakeLists.txt"].indexOf(ce)||ue.endsWith(ce,".mk"))&&(m.generatedFiles["/"+ce]=t.host().readFile(t,ce))}let Z=["0","false","PXT_UTF8"],u={};function ee(e){return e.replace(/\/\/.*/,"").replace(/\/\*/,"")}o.switches.boxDebug&&(u.PXT_BOX_DEBUG=1),o.utf8&&(u.PXT_UTF8=1),o.switches.profile&&(u.PXT_PROFILE=1),o.switches.gcDebug&&(u.PXT_GC_DEBUG=1),o.switches.numFloat&&(u.PXT_USE_FLOAT=1),o.nativeType==pxtc.NATIVE_TYPE_VM&&(u.PXT_VM=1);let E=0,C=!1,I="",U="",S="",N=!1;function te(){A.setNs(""),A.write(""),A.write(""),(S||U)&&(A.write(U),A.write(S),S="",U="")}function ne(e,h){let d,t=(I="",U="",S="",N=!1,-1);function p(){var e=I.replace(/Methods$/,"");return e==I?null:e}function f(e){switch(e.replace(/\s+/g,"")){case"void":return"void";case"int32_t":case"int":return"int32";case"uint32_t":case"unsigned":return"uint32";case"TNumber":case"float":case"double":return"number";case"uint16_t":return"uint16";case"int16_t":case"short":return"int16";case"uint8_t":case"byte":return"uint8";case"int8_t":case"sbyte":return"int8";case"bool":return o.shortPointers&&w("use 'boolean' not 'bool' on 8 bit targets"),"boolean";case"StringData*":case"String":case"ImageLiteral_":case"ImageLiteral":return"string";case"Action":return"() => void";case"TValue":return"any";default:return x(e)}}function g(e){switch(e=e.replace(/\s+/g,"")){case"int32_t":case"uint32_t":case"unsigned":case"uint16_t":case"int16_t":case"short":case"uint8_t":case"byte":case"int8_t":case"sbyte":case"int":case"ramint_t":return"I";case"void":return"V";case"float":return"F";case"TNumber":return"N";case"TValue":return"T";case"bool":return"B";case"double":return"D";case"ImageLiteral_":return"T";case"String":return"S";default:return ue.lookup(K,e)?"I":"_"+e.replace(/[\*_]+$/,"")}}e=e.replace(/^(\s*#\s*if\s+(\w+)\s*$)([^]*?)(^\s*#\s*(elif|else|endif)\s*$)/gm,(e,t,n,i,r)=>0<=Z.indexOf(n)&&!u[n]?t+i.replace(/[^\n]/g,"")+r:e),q=0,C=!1,E=0,T.setNs(""),A.setNs(""),e.split(/\r?\n/).forEach(c=>{++q;var u=ee(c),e=c,i=ee(e);if(C&&0<=i.indexOf("}")&&(C=!1,T.write("}")),C){var r=/^\s*(\w+)\s*(=\s*(.*?))?,?\s*$/.exec(i);if(r){let e=r[1],t=r[3],n="";t?(t=t.trim(),null!=(r=ue.lookup(Q,t))&&(n="  // "+t,t=r),null==(E=de(t))&&w("cannot determine value of "+i)):(E++,t=E+""),T.write(`    ${x(e)} = ${t},`+n)}else T.write(e)}r=/^\s*enum\s+(|class\s+|struct\s+)(\w+)\s*({|$)/.exec(u);if(r&&(i=r[2],e=r[3],C=!0,E=-1,T.write(""),T.write(""),(S||U)&&(T.write(U),T.write(S),S="",U=""),T.write(`declare const enum ${x(i)} `+e),K[i]=!0,h||(k.setNs(I),k.write(`enum ${r[2]} : int;`))),u=c,!C&&!(/^\s*\/\*\*/.test(u)?(N=!0,U=u+"\n",/\*\//.test(u)&&(N=!1),1):N?(U+=u+"\n",/\*\//.test(u)&&(N=!1),1):/^\s*\/\/%/.test(u)&&(S+=u+"\n",1))){/^typedef.*;\s*$/.test(c)&&(k.setNs(I),k.write(c));let l=/^\s*namespace\s+(\w+)/.exec(c);if(l)I=l[1],p()?(te(),e=p(),A.setNs(I,`declare interface ${e} {`)):(S||U)&&(te(),A.setNs(x(I)),T.setNs(x(I)));else{if((l=/^PXT_ABI\((\w+)\)/.exec(c))&&!G&&(y+=`PXT_FNPTR(::${l[1]}),
`,V+=`extern "C" void ${l[1]}();
`,m.functions.push({name:l[1],argsFmt:[],value:0})),(l=/^\s*PXT_EXPORT\(([:\&\w]+)\)/.exec(c))&&(m.vmPointers||(m.vmPointers=[]),m.vmPointers.push(l[1])),(l=/^#define\s+PXT_COMM_BASE\s+([0-9a-fx]+)/.exec(c))&&(m.commBase=parseInt(l[1])),l=/^\s*(\w+)([\*\&]*\s+[\*\&]*)(\w+)\s*\(([^\(\)]*)\)\s*(;\s*$|\{|$)/.exec(c),!S||!l){if(l=/^\s*extern const (\w+) (\w+);/.exec(c),S&&l)return i={name:I+"::"+l[2],argsFmt:[],value:null},m.functions.push(i),G||(y+="PXT_FNPTR(&::"+i.name+"),\n"),void(S="");if(l=/^\s*(\w+)\s+(\w+)\s*;/.exec(c),S&&l){var u=pxtc.parseCommentString(S),e=(u.indexedInstanceNS&&(d=u,A.setNs(u.indexedInstanceNS),t=0),l[1]),i=l[2];if(d)return S=S.trim(),S+=` fixedInstance shim=${d.indexedInstanceShim}(${t++})`,A.write(""),A.write(U),A.write(S),A.write(`const ${i}: ${f(e)};`),U="",void(S="")}return S&&c.trim()?(w("declaration not understood: "+c),S="",void(U="")):void 0}{d=null;let t=pxtc.parseCommentString(S),e=(I||w("missing namespace declaration"),(l[1]+l[2]).replace(/\s+/g,"")),n=l[3],i=l[4],r=(S=S.trim().replace(/ \w+\.defl=\w+/g,""),[g(e)]),s=[],a=i.split(/,/).filter(e=>!!e).map(e=>{e=function(e,t){t=t.trim();let n=/(.*)=\s*(-?\w+)$/.exec(t),i="",r="";var s;return n&&(i=n[2],r="?",t=n[1].trim()),(n=/^(.*?)(\w+)$/.exec(t))?(s=n[2],e.paramDefl[s]&&(i=e.paramDefl[s],r="?"),e=i?ue.lookup(Q,i):null,(i=null!=e?e:i)&&(null==de(i)&&w("Invalid default value (non-integer): "+i),S+=` ${s}.defl=`+i),{name:s+r,type:n[1]}):(w("invalid argument: "+t),{name:"???",type:"int"})}(t,e);return r.push(g(e.type)),s.push(e.type.replace(/ /g,"")),e.name+": "+f(e.type)}),o={name:I+"::"+n,argsFmt:r,value:null};if(U&&(A.setNs(x(I)),A.write(""),A.write(U),/ImageLiteral/.test(l[4])&&!/imageLiteral=/.test(S)&&(S+=" imageLiteral=1"),S+=" shim="+o.name,A.write(S),n=x(n),p()?((u=(a[0]||"").replace(/^.*:\s*/,"").trim()).toLowerCase()!=p().toLowerCase()&&w(oe("Invalid first argument; should be of type '{0}', but is '{1}'",p(),u)),a.shift(),0==a.length&&/\bproperty\b/.test(S)?A.write(`${n}: ${f(e)};`):A.write(`${n}(${a.join(", ")}): ${f(e)};`)):A.write(`function ${n}(${a.join(", ")}): ${f(e)};`)),U="",S="",h||(k.setNs(I),k.write(`${e} ${n}(${i});`)),m.functions.push(o),b)y+="(uint32_t)(void*)::"+o.name+",\n";else if(G){if(ue.startsWith(o.name,"pxt::op_")||pe[o.name]||t.expose||!ue.startsWith(o.name,"pxt::")&&!ue.startsWith(o.name,"pxtrt::")){const c=function(a,o){if("FiberContext*"==o[0])return"::"+a.name;var e="_wrp_"+a.name.replace(/:/g,"_");if(!X[a.name]){X[a.name]=!0,v+=`
void ${e}(FiberContext *ctx) {
`;var l=o.length;let i=[],r=!1,s="";for(let n=0;n<l;++n){const u=a.argsFmt[n+1],h=o[n];let e="I"==u?"toInt":"B"==u?"numops::toBool":"";var c=n==l-1?"ctx->r0":`ctx->sp[${l-n-2}]`;let t="";switch(h){case"TValue":case"TNumber":break;case"Action":e="asRefAction";break;case"String":e="convertToString",t="ctx, ",r=!0;break;default:e=e||"as"+h.replace(/\*/g,"")}s+=`  ${h} a${n} = (${h}) ${e}(${t}${c});
`,i.push("a"+n)}r&&(v+="  auto prevSP = ctx->sp;\n"),v+=s,r&&(v+="  if (panicCode) { ctx->sp = prevSP; return; }\n");const u=`::${a.name}(${i.join(", ")})`;"V"==a.argsFmt[0]?v=v+`  ${u};
`+"  ctx->r0 = NULL;\n":"I"==a.argsFmt[0]?v+=`  ctx->r0 = fromInt(${u});
`:"B"==a.argsFmt[0]?v+=`  ctx->r0 = fromBool(${u});
`:v+=`  ctx->r0 = (TValue)${u};
`,r&&(v+="  ctx->sp = prevSP;\n"),1<l&&(v+=`  ctx->sp += ${l-1};
`),v+="}\n"}return e}(o,s),h=o.argsFmt.length-1;y+=`{ "${o.name}", (OpFun)(void*)${c}, ${h} },
`}}else y+="PXT_FNPTR(::"+o.name+"),\n"}}}})}const ie=ue.clone(a.yottaConfig||{}),h={},re={},se={};if(b&&o.hasHex&&(s=a,ue.assert(!!s.yottaCorePackage),ue.assert(!!s.githubCorePackage),ue.assert(!!s.gittag),_=s.githubCorePackage+"#"+a.gittag,m.yotta.dependencies[s.yottaCorePackage]=_),t){let e=!1;for(var d of j){c="";{p=void 0;r=void 0;var p=d;const O=p.config.platformio,D=(O&&O.dependencies&&ue.jsonCopyFrom(m.platformio.dependencies,O.dependencies),m.npmDependencies&&p.config.npmDependencies&&ue.jsonCopyFrom(m.npmDependencies,p.config.npmDependencies),p.config.codal);if(l&&D)for(const p of D.libraries||[]){const O=ce.github.parseRepoId(p),D=(O||ue.userError(oe("codal library {0} doesn't look like github repo",p)),ce.github.stringifyRepo(O)),L=ue.lookup(se,O.project);L?ce.github.stringifyRepo(L)!=D&&ue.userError(oe("conflict between codal libraries: {0} and {1}",ce.github.stringifyRepo(L),D)):se[O.project]=O}const L=p.config.yotta;if(L){if(L.dependencies&&ue.jsonCopyFrom(m.yotta.dependencies,L.dependencies),L.config){const ce=ue.jsonFlatten(L.config);for(const O of Object.keys(ce)){const D=ue.lookup(re,O),L=ce[O];if(!D||D.config.yotta.configIsJustDefaults)re[O]=p,ie[O]=L;else if(ie[O]!==L)if(!p.parent.config.yotta||!p.parent.config.yotta.ignoreConflicts)throw(r=new fe(oe("conflict on yotta setting {0} between extensions {1} and {2}",O,p.id,D.id))).pkg0=D,r.pkg1=p,r.settingName=O,r}}if(L.optionalConfig){const ce=ue.jsonFlatten(L.optionalConfig);for(const p of Object.keys(ce)){const ue=ce[p];h[p]=ue}}}}d==t?(e=!0,A.clear(),T.clear()):ue.assert(!e);const he=e=>ue.endsWith(e,".h"),de=".cpp",le=d.getFiles().filter(he).concat(d.getFiles().filter(e=>!he(e)));for(var f of le){const t=he(f);if(t||ue.endsWith(f,".cpp")){let e=d.config.name+"/"+f;("base"==d.config.name||/^core($|---)/.test(d.config.name))&&t&&(e=f),t&&(J+=`#include "${b?n.slice(1):""}${e}"
`);var g=d.readFile(f);null==g&&ue.userError(oe("C++ file {0} is missing in extension {1}.",f,d.config.name)),W=e,ne(g,t),m.extensionFiles[n+e]=g,0==d.level&&(m.onlyPublic=!1),d.verProtocol()&&"pub"!=d.verProtocol()&&"embed"!=d.verProtocol()&&(m.onlyPublic=!1)}(ue.endsWith(f,".c")||ue.endsWith(f,".S")||ue.endsWith(f,".s"))&&(g=d.readFile(f),m.extensionFiles[n+d.config.name+"/"+f.replace(/\.S$/,".s")]=g)}c&&(Y+=oe("Extension {0}:\n",d.id)+c)}e||(A.clear(),T.clear())}function P(t){return Object.keys(m.extensionFiles).concat(Object.keys(m.generatedFiles)).filter(e=>ue.endsWith(e,t)).map(e=>e.slice(1))}Y&&ue.userError(Y),ue.jsonCopyFrom(h,ie),ue.iterMap(h,(e,t)=>{null===t&&delete h[e]}),Object.keys(h).filter(e=>/-/.test(e)).forEach(e=>{var t=h[e];delete h[e],h[e.replace(/-/g,"_")]=t}),!b&&a.yottaConfigCompatibility&&Object.keys(h).forEach(e=>h["YOTTA_CFG_"+e]=h[e]),h.PXT_TARGET=JSON.stringify(ce.appTarget.id);var ae,s=ue.jsonUnFlatten(h);if($){var _={name:"pxt-app",private:!0,dependencies:m.npmDependencies};m.generatedFiles["/package.json"]=JSON.stringify(_,null,4)+"\n"}else if(H){const ce=ue.concatArrayLike([P(".c"),P(".cpp"),P(".s")]).map(e=>e.slice(n.length-1)).concat(["main.cpp"]);ce.push("pointers.cpp"),m.generatedFiles[n+"CMakeLists.txt"]="idf_component_register(\n  SRCS\n"+ce.map(e=>`    "${e}"
`).join("")+'  INCLUDE_DIRS\n    "."\n)\n'}else if(l){let e=a,n=ue.clone(e.codalDefinitions)||{},t=e.codalTarget;"string"==typeof t&&(t+=".json");_={target:t,definitions:n,config:n,application:"pxtapp",output_folder:"build",pxt_gitrepo:e.githubCorePackage,pxt_gittag:e.gittag,libraries:ue.values(se).map(e=>({name:e.project,url:"https://github.com/"+e.fullName,branch:e.tag||"master",type:"git"}))};0==_.libraries.length&&delete _.libraries,ue.iterMap(ue.jsonFlatten(s),(e,t)=>{e=e.replace(/^codal\./,"device.").toUpperCase().replace(/\./g,"_"),n[e]=t}),m.generatedFiles["/codal.json"]=JSON.stringify(_,null,4)+"\n",ce.debug("codal.json: "+m.generatedFiles["/codal.json"])}else if(B){const ce=a.platformioIni.slice();ce.push("lib_deps ="),ue.iterMap(m.platformio.dependencies,(e,t)=>{e=/[@#\/]/.test(t)?t:e+"@"+t;ce.push("  "+e)}),m.generatedFiles["/platformio.ini"]=ce.join("\n")+"\n"}else{m.yotta.config=s;let e="pxt-app";_={name:e=a.yottaBinary?a.yottaBinary.replace(/-combined/,"").replace(/\.hex$/,""):e,version:"0.0.0",description:"Auto-generated. Do not edit.",license:"n/a",dependencies:m.yotta.dependencies,targetDependencies:{},bin:"./source"};m.generatedFiles["/module.json"]=JSON.stringify(_,null,4)+"\n",ce.debug("module.json: "+m.generatedFiles["/module.json"])}for(ae of Object.keys(u))z+=`#define ${ae} ${u[ae]}
`;if(o.uf2Family&&(z+=`#define PXT_UF2_FAMILY ${o.uf2Family}
`),m.generatedFiles[n+"pointers.cpp"]=J+k.finish()+V+v+y+"\nPXT_SHIMS_END\n",m.generatedFiles[n+"pxtconfig.h"]=z,ce.debug("pxtconfig.h: "+m.generatedFiles[n+"pxtconfig.h"]),b&&(m.generatedFiles["/config.json"]=JSON.stringify(s,null,4)+"\n",ce.debug("yotta config.json: "+m.generatedFiles["/config.json"])),m.generatedFiles[n+"main.cpp"]='\n#include "pxt.h"\n#ifdef PXT_MAIN\nPXT_MAIN\n#else\nint main() {\n    uBit.init();\n    pxt::start();\n    release_fiber();\n    return 0;   // your program will never reach this line.\n}\n#endif\n',m.generatedFiles["/Makefile"]){let n="",e=(e,t)=>{n+=`${e} = ${P(t).join(" ")}\n`};e("PXT_C",".c"),e("PXT_CPP",".cpp"),e("PXT_S",".s"),e("PXT_HEADERS",".h"),n=n+"PXT_SOURCES := $(PXT_C) $(PXT_S) $(PXT_CPP)\n"+"PXT_OBJS := $(addprefix bld/, $(PXT_C:.c=.o) $(PXT_S:.s=.o) $(PXT_CPP:.cpp=.o))\n",m.generatedFiles["/Makefile.inc"]=n}m.generatedFiles["/functions.json"]=JSON.stringify(m.functions,null,1);_=m.extensionFiles,ue.jsonCopyFrom(_,m.generatedFiles),s={config:a.serviceId,tag:a.gittag,replaceFiles:_,dependencies:b?m.yotta.dependencies:null},_=JSON.stringify(s);return m.sha=ue.sha256(_),m.skipCloudBuild=!!a.skipCloudBuild,m.compileData=ts.pxtc.encodeBase64(ue.toUTF8(_)),m.shimsDTS=A.finish(),m.enumsDTS=T.finish(),(le=10<Object.keys(le).length?{}:le)[F]=m},e.unpackSourceFromHexFileAsync=function(e){if(e)return ce.Util.fileReadAsBufferAsync(e).then(e=>t(new Uint8Array(e)))},e.unpackSourceFromHexAsync=t}}(pxt=pxt||{}),function(u){{var i=u.hexloader||(u.hexloader={});const t={};let n,s={};function a(e){return t.hasOwnProperty(e.sha)||(t[e.sha]=function(t){let c="";return i.showLoading(u.U.lf("Compiling (this may take a minute)...")),u.tickEvent("cppcompile.start"),((e=t).skipCloudBuild?Promise.resolve({hex:["SKIP"]}):u.webConfig&&u.webConfig.isStatic?u.Util.requestAsync({url:`${u.webConfig.cdnUrl}hexcache/${e.sha}.hex`}).then(e=>{if(e.text){const u={enums:[],functions:[],hex:e.text.split(/\r?\n/)};return Promise.resolve(u)}return u.log("Hex info not found in bundled hex cache"),Promise.resolve()}).catch(e=>(u.log("Error fetching hex info from bundled hex cache"),Promise.resolve())):u.Cloud.localToken&&window&&u.BrowserUtils.isLocalHost()?(e="compile/"+e.sha,u.Cloud.localRequestAsync(e,void 0).then(e=>e.json).then(e=>e&&!e.notInOfflineCache&&e.hex?(e.hex=e.hex.split(/\r?\n/),e):Promise.resolve(void 0)).catch(e=>Promise.resolve(void 0))):Promise.resolve(void 0)).then(e=>{return e?(u.tickEvent("cppcompile.cachehit"),e):(n||(e=u.getOnlineCdnUrl(),n=e?Promise.resolve(e):(e=u.webConfig&&u.webConfig.isStatic,u.Cloud.privateGetAsync("clientconfig",e).then(e=>e.primaryCdnUrl)))).then(e=>(c=e+"/compile/"+t.sha,u.U.httpGetTextAsync(c+".hex"))).then(e=>e,e=>u.Cloud.privatePostAsync("compile/extension",{data:t.compileData},!0).then(l=>new Promise((n,e)=>{let i=0;const r=8e3,s=18e4,a=u.U.now(),o=()=>{if(i++,u.U.now()-a>s)return u.log("abandoning C++ build"),u.tickEvent("cppcompile.cancel",{retry:i}),n(null),null;let t=l.hex.replace(/\.hex/,".json");return u.log(`polling C++ build ${t} (attempt #${i})`),u.tickEvent("cppcompile.poll",{retry:i}),u.Util.httpGetJsonAsync(t).then(e=>{u.log("build log "+t.replace(/\.json$/,".log")),u.tickEvent("cppcompile.done",{success:null!=e&&e.success?1:0,retry:i,duration:u.U.now()-a}),e.success?(u.log("fetching "+c+".hex"),n(u.U.httpGetTextAsync(c+".hex"))):(u.log("build failed"),e.mbedresponse&&e.mbedresponse.result&&e.mbedresponse.result.exception&&u.log(e.mbedresponse.result.exception),n(null))},e=>(u.log(`waiting ${r/1e3|0}s for C++ build...`),setTimeout(o,r),null))};o()}))).then(e=>(i.hideLoading(),{hex:e&&e.split(/\r?\n/)}))}).finally(()=>{i.hideLoading()});var e}(e)),t[e.sha]}function o(n,i,r,e,s=10){return n.cacheStoreAsync(r,e).then(()=>n.cacheGetAsync(i)).then(e=>{let t;try{t=JSON.parse(e||"[]")}catch(e){console.error("invalid cache entry, clearing entry"),t=[]}(t=t.filter(e=>e!=r)).unshift(r);e=t.slice(s);return t=t.slice(0,s),u.U.promiseMapAll(e,e=>n.cacheStoreAsync(e,"[]")).then(()=>n.cacheStoreAsync(i,JSON.stringify(t)))})}function l(n,i,r){return n.cacheGetAsync(i).then(e=>{let t;try{t=JSON.parse(e||"[]")}catch(e){return console.error("invalid cache entry, clearing entry"),n.cacheStoreAsync(i,"[]")}return t[0]!=r?((t=t.filter(e=>e!=r)).unshift(r),n.cacheStoreAsync(i,JSON.stringify(t))):null})}i.showLoading=e=>{},i.hideLoading=()=>{},i.storeWithLimitAsync=o,i.recordGetAsync=l,i.getHexInfoAsync=function(i,n,e){if(!n.sha)return Promise.resolve(null);var t=s[n.sha];if(t)return Promise.resolve(t);u.debug("get hex info: "+n.sha);let r="hex-"+n.sha;return i.cacheGetAsync(r).then(e=>{let t;try{t=e?JSON.parse(e):null}catch(e){console.log("invalid cache entry, clearing entry"),t=null}return t&&t.hex?(u.debug("cache hit, size="+e.length),t.hex=function(i){var s=[];for(let n=0;n<i.length;n++){var a=/^([@!])(....)$/.exec(i[n]);if(a){let e=parseInt(a[2],16),t=i[++n],r="";if("@"==a[1]){r="";let e=parseInt(t,16);for(;0<e--;)r+="\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0"}else r=ts.pxtc.decodeBase64(t);u.Util.assert(0<r.length),u.Util.assert(r.length%16==0);for(let i=0;i<r.length;){var o=[16,e>>8&255,255&e,0];e+=16;for(let e=0;e<16;++e)o.push(r.charCodeAt(i++));let t=0;for(let e=0;e<o.length;++e)t+=o[e];o.push(255&-t);let n=":";for(let e=0;e<o.length;++e){var l=255&o[e];l<=15&&(n+="0"),n+=l.toString(16)}s.push(n.toUpperCase())}}else s.push(i[n])}return s}(t.hex),l(i,"hex-keys",r).then(()=>t)):a(n).then(e=>{var t=e.hex,n=(e.hex=function(r){let s=[],a=0;for(let i=0;i<r.length;i+=a){let e=-1,n="",t=(a=0,!1);for(;a<500;){var o=/^:10(....)00(.{32})(..)$/.exec(r[i+a]);if(!o)break;var l=o[2],c=/^0+$/.test(l),u=parseInt(o[1],16);if(-1==e)t=c,s.push((t?"@":"!")+o[1]),e=u-16;else{if(c!=t)break;if(e+16!=u)break}t||(n+=l),e=u,a++}if(0==a)s.push(r[i]),a=1;else if(t)s.push(a.toString(16));else{let t="";for(let e=0;e<n.length;e+=2)t+=String.fromCharCode(parseInt(n.slice(e,e+2),16));s.push(ts.pxtc.encodeBase64(t))}}return s}(e.hex),JSON.stringify(e));return e.hex=t,o(i,"hex-keys",r,n).then(()=>e)}).catch(e=>(u.reportException(e,{sha:n.sha}),Promise.resolve(null)))}).then(e=>(e&&((s=20<Object.keys(s).length?{}:s)[n.sha]=e),e))}}}(pxt=pxt||{}),function(p){function f(e,t,n={},i=null,r=null){if(s.testMode||e==s.TEST_KEY){const p={success:!0};return Promise.resolve({statusCode:200,headers:{},text:JSON.stringify(p),json:p})}return p.Util.multipartPostAsync(t,n,i,r)}function g(e,t,n,i,r){p.Util.assert(!!t&&!!n&&!!i);t="https://api.crowdin.com/api/project/"+t+"/";return r=r||{},s.testMode?delete r.key:r.key=n,e&&(r.branch=e),t+i+"?"+Object.keys(r).map(e=>e+"="+encodeURIComponent(r[e])).join("&")}function e(e){let t=0;return function(){if(10<t++)throw new Error("Too many API calls for "+e)}}function m(n,i,r,s,a){return s=t(s),p.debug(`create directory ${n||""}/`+s),a=a||e(s),f(r,g(n,i,r,"add-directory"),{json:"true",name:s}).then(e=>{if(p.debug("crowdin resp: "+e.statusCode),200==e.statusCode||400==e.statusCode)return Promise.resolve();if(500==e.statusCode&&e.text&&50===JSON.parse(e.text).error.code)return p.log("directory already exists"),Promise.resolve();var t=e.json||JSON.parse(e.text)||{error:{}};if(404==e.statusCode&&17==t.error.code){p.log("parent directory missing for "+s);const e=s.replace(/\/[^\/]+$/,"");if(e!=s)return m(n,i,r,e,a).then(()=>m(n,i,r,s,a))}throw new Error(`cannot create directory ${n||""}/${s}: ${e.statusCode} `+JSON.stringify(t))})}function t(e){return e.replace(/\\/g,"/")}function i(t,n){const i=p.appTarget.versions.pxtCrowdinBranch||"",r=p.appTarget.versions.targetCrowdinBranch||"";let s=[];if(t.forEach(e=>function t(n,i,r,s){const e=i.name,a=r?r+"/"+e:e;switch(i.fullName=a,i.branch=s||"",i.node_type){case"file":n.push(i);break;case"directory":(i.files||[]).forEach(e=>t(n,e,a,s));break;case"branch":(i.files||[]).forEach(e=>t(n,e,r,i.name))}}(s,e,"")),s=s.filter(e=>e.fullName.indexOf("/")<0?e.branch==i:e.branch==r),n&&(s=s.filter(e=>0==e.fullName.indexOf(n))),"core"!=p.appTarget.id){const t=p.appTarget.id+"/";s=s.filter(e=>e.fullName.indexOf("/")<0||e.fullName.substr(0,t.length)==t||0<=e.fullName.indexOf("common-docs"))}return s}function r(e,t){e=g("",e,t,"info",{json:"true"});return p.Util.httpGetTextAsync(e).then(e=>JSON.parse(e))}var s;(s=p.crowdin||(p.crowdin={})).KEY_VARIABLE="CROWDIN_KEY",s.testMode=!1,s.TEST_KEY="!!!testmode!!!",s.setTestMode=function(){p.crowdin.testMode=!0,p.log("CROWDIN TEST MODE - files will NOT be uploaded")},s.downloadTranslationsAsync=function(s,a,o,l,c={}){const e=g(s,a,o,"info",{json:"true"}),u={};return l=t(l),p.Util.httpGetTextAsync(e).then(e=>{e=JSON.parse(e);if(!e)throw new Error("info failed");let i=e.languages.filter(e=>"en"!=e.code);p.appTarget&&p.appTarget.appTheme&&p.appTarget.appTheme.availableLocales&&(i=i.filter(e=>-1<p.appTarget.appTheme.availableLocales.indexOf(e.code))),p.log("languages: "+i.map(e=>e.code).join(", "));const r=()=>{const t=i.pop();if(!t)return Promise.resolve();const n=g(s,a,o,"export-file",{file:l,language:t.code,export_translated_only:c.translatedOnly?"1":"0",export_approved_only:c.validatedOnly?"1":"0"});return p.log(`downloading ${t.name} - ${t.code} (${i.length} more)`),p.Util.httpGetTextAsync(n).then(e=>{try{const p=JSON.parse(e);p&&(u[t.code]=p)}catch(e){p.log(n+" "+e)}return r()}).then(()=>p.Util.delay(1e3))};return r()}).then(()=>u)},s.createDirectoryAsync=m,s.uploadTranslationAsync=function s(a,o,l,c,u){p.Util.assert(!!o),p.Util.assert(!!l);const h=e(c=t(c));function d(){return function r(e,t){return t.type="auto",t.json="",t.escape_quotes="0",h(),f(l,g(a,o,l,e),t,c,u).then(e=>{{var t;const n=e.statusCode,i=p.Util.jsonTryParse(e.text)||{};if(p.debug("upload result: "+n),404==n&&i.error&&8==i.error.code)return p.log("create new translation file: "+c),r("add-file",{});if(404==n&&17==(null==(t=i.error)?void 0:t.code))return m(a,o,l,c.replace(/\/[^\/]+$/,""),h).then(()=>d());if(i.success||53!=(null==(t=i.error)?void 0:t.code)){if(429==n&&55==(null==(t=i.error)?void 0:t.code))return p.log("Maximum concurrent requests reached, waiting 10s and retry..."),p.U.delay(1e4).then(()=>s(a,o,l,c,u));if(200==n||i.success)return Promise.resolve();throw new Error(`Error, upload translation: ${c}, ${n}, `+e.text)}return p.log(c+" being updated, waiting 5s and retry..."),p.U.delay(5e3).then(()=>s(a,o,l,c,u))}})}("update-file",{update_option:"update_as_unapproved"})}return d()},s.projectInfoAsync=r,s.listFilesAsync=function(e,t,n){return p.log("crowdin: listing files under "+n),r(e,t).then(e=>{if(e)return e=i(e.files,n),p.debug(`crowdin: found ${e.length} under `+n),e.map(e=>({fullName:e.fullName,branch:e.branch||""}));throw new Error("info failed")})},s.languageStatsAsync=function(e,t,n){e=g("",e,t,"language-status",{language:n,json:"true"});return p.Util.httpGetJsonAsync(e).then(e=>i(e.files))},s.inContextLoadAsync=function(i){const r=document.createElement("input");r.type="text",r.setAttribute("class","hidden"),r.value=i;var e=new Promise((t,e)=>{const n=new MutationObserver(()=>{var e;i!=r.value&&(e=p.Util.rlf(r.value),r.remove(),n.disconnect(),t(e))});n.observe(r,{attributes:!0})});return document.body.appendChild(r),e}}(pxt=pxt||{}),function(f){function E(e){return e?e.split(/\r?\n/):[]}function g(e,i,r={}){r.ignoreWhitespace&&(e=e.replace(/[\r\n]+$/,""),i=i.replace(/[\r\n]+$/,""));const s=E(e),a=E(i),o=Math.min(r.maxDiffSize||1024,s.length+a.length);if(0==o)return[];const l=65520<s.length?Uint32Array:Uint16Array,c={};let u=0;const h=t(s),d=t(a);function t(e){var t,n=new l(e.length);let i=0;for(t of e)r.ignoreWhitespace&&(t=t.replace(/\s+$/g,"").replace(/^\s+/g,"")),c.hasOwnProperty(t)?n[i]=c[t]:(++u,n[i]=u,c[t]=u),i++;return n}var n=new l(2*o+1);let p=-1;for(let e=0;e<=o;e++)null!=x(e,n)&&(p=e);if(-1==p)return null;var f=[];let g=null;for(let e=0;e<=p;e++){const i=f.length?f[f.length-1].slice(0):new l(2*p+1);if(f.push(i),null!=(g=x(e,i)))break}var m=[];let b=g;for(let n=f.length-1;0<=n;n--){const i=f[n];let t=0,e=0;var y=(t=b==-n||b!=n&&i[o+b-1]<i[o+b+1]?(e=b+1,i[o+e]):(e=b-1,i[o+e]+1))-b;for(let e=i[o+b]-t-1;0<=e;--e)m.push("  "+a[y+e]);e==b-1?m.push("- "+s[t-1]):0<y&&m.push("+ "+a[y-1]),b=e}if(m.reverse(),r.context==1/0||r.full)return m;let v=1,w=1,k=0;for(var A=[],T=r.context||3;k<m.length;){let e=k;for(;e<m.length&&" "==m[e][0];)e++;if(e==m.length)break;const i=e-T,E=i-k,r=(0<E&&(v+=E,w+=E,k=i),A.length),s=v,a=w;A.push("@@");let t=k,n=0;for(;t<m.length;){if(" "==m[t][0]){if(++n>2*T+2){t-=T+2;break}}else n=0;t++}for(;k<t;){switch(A.push(m[k]),m[k][0]){case"-":v++;break;case"+":w++;break;case" ":v++,w++}k++}A[r]=`@@ -${s},${v-s} +${a},${w-a} @@`}return A;function x(i,r){for(let n=-i;n<=i;n+=2){let e=0,t=(e=n==-i||n!=i&&r[o+n-1]<r[o+n+1]?r[o+n+1]:r[o+n-1]+1)-n;for(;e<h.length&&t<d.length&&h[e]==d[t];)e++,t++;if((r[o+n]=e)>=h.length&&t>=d.length)return n}return null}}function s(e){return E(e).map(e=>e.replace(/;\s*$/,"")).join("\n")}function m(e){e=/^@@ -(\d+),(\d+) \+(\d+),(\d+)/.exec(e);return e&&{oldStart:parseInt(e[1])-1,oldLength:parseInt(e[2]),newStart:parseInt(e[3])-1,newLength:parseInt(e[4])}}var e;(e=f.diff||(f.diff={})).toLines=E,e.compute=g,e.diff3=function(e,t,n,l,c){var u=i(e),h=i(n);if(u&&h){var d=E(e),p=E(n);let r=0,s=[],a=0,o=0;for(let i=0;i<u.length-1;)if(u[i]==a&&h[i]==o)s.push(d[a]),a++,o++,i++;else{let e=!0,t=!0,n=i;for(;n<u.length&&(u[n]!=a+n-i&&(e=!1),h[n]!=o+n-i&&(t=!1),null==u[n]||null==h[n]);)n++;if(f.U.assert(n<u.length),e)for(;o<h[n];)s.push(p[o++]);else if(t)for(;a<u[n];)s.push(d[a++]);else if(d.slice(a,u[n]).join("\n")==p.slice(o,h[n]).join("\n"))for(;a<u[n];)s.push(d[a++]);else{for(r++,s.push("<<<<<<< "+l);a<u[n];)s.push(d[a++]);for(s.push("=======");o<h[n];)s.push(p[o++]);s.push(">>>>>>> "+c)}i=n,a=u[n],o=h[n]}return{merged:s.join("\n"),numConflicts:r};function i(n){n=g(t,n,{context:1/0});if(n){var i,r=[];let e=0,t=0;for(i of n)"+"==i[0]?e++:"-"==i[0]?(r[t]=null,t++):" "==i[0]?(r[t]=e,e++,t++):f.U.oops();return r.push(e+1),r}}}},e.removeTrailingSemiColumns=s,e.split=function(e,t){var n=e.split(/-{10,}/,2);if(n.length<2)return{fileA:e,fileB:void 0};let i=n[0].replace(/\n$/,""),r=n[1].replace(/^\n/,"");return t&&t.removeTrailingSemiColumns&&(i=s(i),r=s(r)),{fileA:i,fileB:r}},e.parseDiffMarker=m,e.render=function(e,t,a={}){const o=g(e,t,a);if(!o)return f.dom.el("div",null,pxtc.Util.lf("Too many differences to render diff."));const l={"@":"diff-marker"," ":"diff-unchanged","+":"diff-added","-":"diff-removed"};let c=0,u=0,h="";const d=f.dom.el("tbody"),n=f.dom.el("table",{class:"diffview "+(a.update?"update":"")},d);let p=null;return o.forEach((e,t)=>{var n=m(e),n=(n?(c=n.oldStart,u=n.newStart):("+"!=e[0]&&c++,"-"!=e[0]&&u++),o[t+1]?o[t+1][0]:""),i=o[t+2]?o[t+2][0]:"",r=e.slice(2);let s=f.dom.el("code",null,r);if(p)s=p,p=null;else if(!("-"!=e[0]||" "!=h&&"@"!=h||"+"!=n||" "!=i&&"@"!=i&&""!=i)){const a=function(e,t){var n=g(e.split("").join("\n"),t.split("").join("\n"),{context:1/0});if(!n)return{a:f.dom.el("div",{class:"inline-diff"},f.dom.el("code",null,e)),b:f.dom.el("div",{class:"inline-diff"},f.dom.el("code",null,t))};var i=[],r=[];for(let t=0;t<n.length;){let e=t;const g=n[t][0];for(;n[e]&&n[e][0]==g;)e++;var s=n.slice(t,e).map(e=>e.slice(2)).join("");" "==g?(i.push(f.dom.el("code",{class:"ch-common"},s)),r.push(f.dom.el("code",{class:"ch-common"},s))):"-"==g?i.push(f.dom.el("code",{class:"ch-removed"},s)):"+"==g?r.push(f.dom.el("code",{class:"ch-added"},s)):f.Util.oops(),t=e}return{a:f.dom.el("div",{class:"inline-diff"},i),b:f.dom.el("div",{class:"inline-diff"},r)}}(e.slice(2),o[t+1].slice(2));s=a.a,p=a.b}h=e[0],a.hideMarkerLine&&"@"==h||a.hideRemoved&&"-"==h||(r="@"==h,n=""+l[h],d.appendChild(f.dom.el("tr",{class:n},[!a.hideLineNumbers&&f.dom.el("td",{class:"line-a","data-content":c}),!a.hideLineNumbers&&f.dom.el("td",{class:"line-b","data-content":u}),r&&f.dom.el("td",{colspan:2,class:"change"},f.dom.el("code",null,e)),!a.hideMarker&&!r&&f.dom.el("td",{class:"marker","data-content":h}),!r&&f.dom.el("td",{class:"change"},s)])))}),n},e.resolveMergeConflictMarker=function(e,t,n,i){let r=f.diff.toLines(e),s=t;for(;s<r.length&&!/^<<<<<<<[^<]/.test(r[s]);)s++;let a=s+1;for(;a<r.length&&!/^=======$/.test(r[a]);)a++;let o=a+1;for(;o<r.length&&!/^>>>>>>>[^>]/.test(r[o]);)o++;if(o>=r.length)return f.debug(`diff marker mistmatch: ${r.length} -> ${s} ${a} `+o),e;if(r[s]=void 0,r[a]=void 0,r[o]=void 0,!n)for(let e=s;e<=a;++e)r[e]=void 0;if(!i)for(let e=a;e<=o;++e)r[e]=void 0;return r.filter(e=>void 0!==e).join("\n")},e.mergeDiff3Config=function(e,t,n){let i=f.Util.jsonTryParse(e),r=f.Util.jsonTryParse(t),s=f.Util.jsonTryParse(n);if(i&&!s)return e;if(!i)return n||t;if(!r&&s&&(r=s),i&&r&&s){delete i.installedVersion,delete r.installedVersion,delete s.installedVersion;const h={},d=f.U.unique(Object.keys(r).concat(Object.keys(i)).concat(Object.keys(s)),e=>e);for(const e of d){const t=i[e],n=r[e],d=s[e];if(JSON.stringify(t)==JSON.stringify(d))void 0!==t&&(h[e]=t);else switch(e){case"name":h[e]=(a=t,o=n,l=d,a==o||l!=o&&a==lf("Untitled")?l:a);break;case"version":h[e]=0<f.semver.strcmp(t,d)?t:d;break;case"languageRestriction":case"preferredEditor":case"targetVersion":h[e]=t;break;case"public":h[e]=t&&d;break;case"files":case"testFiles":{const f=c(t||[],n||[],d||[]);if(!f)return;h[e]=f.length?f:void 0;break}case"dependencies":case"testDependencies":{const f=u(t||{},n||{},d||{});if(Object.keys(f).length)return;h[e]=f;break}case"description":if(t&&!d)h[e]=t;else{if(t||!d)return;h[e]=d}break;default:return}}var a,o,l;return f.Package.stringifyConfig(h);function c(e,t,n){const i=[],r=f.U.unique(t.concat(e).concat(n),e=>e);for(const f of r){const r=-1<e.indexOf(f),s=-1<n.indexOf(f),a=-1<t.indexOf(f);r==s||s==a?r&&i.push(f):s&&i.push(f)}return i}function u(e,t,n){const i={},r=f.U.unique(Object.keys(t).concat(Object.keys(e)).concat(Object.keys(n)),e=>e);for(const s of r){const r=e[s],a=n[s],o=t[s];if(r==a)r&&(i[s]=r);else{const e=f.github.parseRepoId(r),t=f.github.parseRepoId(a);if(e&&t&&f.semver.tryParse(e.tag)&&f.semver.tryParse(t.tag)&&e.owner&&e.project&&e.owner==t.owner&&e.project==t.project){const n=(0<f.semver.strcmp(e.tag,t.tag)?e:t).tag;i[s]=`github:${e.owner}/${e.project}#`+n}else a==o?r&&(i[s]=r):a&&(i[s]=a)}}return i}}},e.hasMergeConflictMarker=function(e){return e&&/^(<<<<<<<[^<]|>>>>>>>[^>])/m.test(e)},e.reconstructConfig=function(t,n,e,i){let r={},s=e.tree.tree.map(e=>e.path).filter(e=>/\.(ts|blocks|md|jres|asm|json)$/.test(e)).filter(e=>e!=f.CONFIG_NAME);return(s=t.fileName?s.filter(e=>0===e.indexOf(t.fileName)).map(e=>e.slice(t.fileName.length+1)):s).find(e=>/\.ts$/.test(e))||(i.config.files.filter(e=>s.indexOf(e)<0).forEach(e=>{s.push(e),n[e]=i.files[e]}),f.Util.jsonCopyFrom(r,i.config.dependencies)),Object.keys(r).length||(r[f.appTarget.corepkg]="*"),{name:"",files:s,dependencies:r,preferredEditor:s.find(e=>/.blocks$/.test(e))?f.BLOCKS_PROJECT_NAME:f.JAVASCRIPT_PROJECT_NAME}}}(pxt=pxt||{}),function(i){var e;(e=i.discourse||(i.discourse={})).extractSharedIdFromPostUrl=function(e){return i.Util.httpGetJsonAsync(e+".json").then(e=>e.post_stream&&e.post_stream.posts&&e.post_stream.posts[0]&&e.post_stream.posts[0].link_counts.map(e=>i.Cloud.parseScriptId(e.url)).filter(e=>!!e)[0])},e.topicsByTag=function(n,e){e=`${n=n.replace(/\/$/,"")}/tag/${e}.json`;return i.Util.httpGetJsonAsync(e).then(e=>{const t=i.Util.toDictionary(e.users,e=>e.id.toString());return e.topic_list.topics.map(e=>({id:e.id,title:e.title,url:`${n}/t/${e.slug}/`+e.id,imageUrl:e.image_url,author:t[e.posters[0].user_id].username,cardType:"forumUrl"}))})}}(pxt=pxt||{}),function(o){{var w=o.docs||(o.docs={}),x=pxtc.Util;let v,k={},A={};var e="\x3c!-- @CMD@ @ARGS@ --\x3e";let T={parent:e,short:e,description:"\x3c!-- desc --\x3e",activities:"\x3c!-- activities --\x3e",explicitHints:"\x3c!-- hints --\x3e",flyoutOnly:"\x3c!-- flyout --\x3e",hideIteration:"\x3c!-- iter --\x3e",codeStart:"\x3c!-- start --\x3e",codeStop:"\x3c!-- stop --\x3e",autoOpen:"\x3c!-- autoOpen --\x3e",autoexpandOff:"\x3c!-- autoexpandOff --\x3e",preferredEditor:"\x3c!-- preferredEditor --\x3e",tutorialCodeValidation:"\x3c!-- tutorialCodeValidation --\x3e"};function t(e,t,n){return e.split(t).join(n)}function n(e){return e=t(e,"&","&amp;"),e=t(e,"<","&lt;"),e=t(e,">","&gt;"),e=t(e,'"',"&quot;"),t(e,"'","&#39;")}function E(e){return e&&n(e.replace(/\&([#a-z0-9A-Z]+);/g,(e,t)=>{switch(t){case"amp":return"&";case"lt":return"<";case"gt":return">";case"quot":return'"';default:return"#"==t[0]?String.fromCharCode(parseInt(t.slice(1))):e}}))}w.htmlQuote=n,w.html2Quote=E;const P=[{rx:/^vimeo\.com\/(\d+)/i,cmd:"### @vimeo $1"},{rx:/^(www\.youtube\.com\/watch\?v=|youtu\.be\/)([\w\-]+(\#t=([0-9]+m[0-9]+s|[0-9]+m|[0-9]+s))?)/i,cmd:"### @youtube $2"}],_=(w.requireMarked=()=>"undefined"!=typeof marked?marked:"undefined"!=typeof require?require("marked"):void 0,w.requireDOMSanitizer=()=>"undefined"!=typeof DOMPurify?DOMPurify.sanitize:"undefined"!=typeof require?require("DOMPurify").sanitize:void 0,e=>`<div class='ui negative message'>${n(e)}</div>`);function C(r){let s=x.clone(k),a=x.clone(A),o=x.clone(T),l={},c={},n=r.params,e=r.theme,u=(r.boxes=s,r.macros=a,r.settings=o,r.html=r.html.replace(/<aside\s+([^<>]+)>([^]*?)<\/aside>/g,(e,t,n)=>{var t=function(t){for(var n,i={};t.trim();){let e=/\s*([^=\s]+)=("([^"]*)"|'([^']*)'|(\S*))/.exec(t);e?(n=e[3]||e[4]||e[5]||"",i[e[1].toLowerCase()]=n):i[(e=/^\s*(\S+)/.exec(t))[1]]="true",t=t.slice(e[0].length)}return i}(t),i=t["data-name"]||t.id;return i?(/box/.test(t.class)?s[i]=n:/aside/.test(t.class)?s[i]=`<!-- BEGIN-ASIDE ${i} -->${n}<!-- END-ASIDE -->`:/setting/.test(t.class)?o[i]=n:/menu/.test(t.class)?l[i]=n:/toc/.test(t.class)?c[i]=n:a[i]=n,`<!-- macro ${i} -->`):_("id or data-name missing on macro")}),(e,t)=>{let n=l.item,i={NAME:e.name};if(e.subitems)n=l["toc-dropdown"]||(0==t?l["top-dropdown"]:l["inner-dropdown"]),i.ITEMS=e.subitems.map(e=>u(e,t+1)).join("\n");else{if(/^-+$/.test(e.name)&&(n=l.divider),e.path&&!/^(https?:|\/)/.test(e.path))return _("Invalid link: "+e.path);i.LINK=e.path}return S(n,i,["ITEMS"])}),h=[{name:lf("Docs"),href:"/docs"}];var i=r.TOC||e.TOC||[];let d=[],p=e=>{for(var t of e.subitems||[])if(p(t))return d.push(e),!0;return!(!r.filepath||!e.path||0!=r.filepath.indexOf(e.path)||(d.push(e),0))},f=(i.forEach(p),(e,t)=>{let n=c.item,i={NAME:e.name};return e.path&&!/^(https?:|\/)/.test(e.path)?_("Invalid link: "+e.path):(/^\//.test(e.path)&&r.versionPath&&(e.path="/"+r.versionPath+e.path),i.LINK=e.path,0<=d.indexOf(e)?(i.ACTIVE="active",i.EXPANDED="true",h.push({name:e.name,href:e.path})):i.EXPANDED="false",e.subitems&&0<e.subitems.length?(n=c["toc-dropdown"]?""!==e.name?c["toc-dropdown"]:c["toc-dropdown-noLink"]:0==t?""!==e.name?c["top-dropdown"]:c["top-dropdown-noHeading"]:1==t?c["inner-dropdown"]:c["nested-dropdown"],i.ITEMS=e.subitems.map(e=>f(e,t+1)).join("\n")):/^-+$/.test(e.name)&&(n=c.divider),S(n,i,["ITEMS"]))}),t=(n.menu=(e.docMenu||[]).map(e=>u(e,0)).join("\n"),n.TOC=i.map(e=>f(e,0)).join("\n"),e.appStoreID&&(n.appstoremeta=`<meta name="apple-itunes-app" content="app-id=${x.htmlEscape(e.appStoreID)}"/>`),"");1<h.length&&(t=`
            <nav class="ui breadcrumb" aria-label="${lf("Breadcrumb")}">
                ${h.map((e,t)=>`<a class="${t==h.length-1?"active":""} section"
                        href="${E(e.href)}" aria-current="${t==h.length-1?"page":""}">${E(e.name)}</a>`).join('<i class="right chevron icon divider"></i>')}
            </nav>`),n.breadcrumb=t,e.boardName&&(n.boardname=E(e.boardName)),e.boardNickname&&(n.boardnickname=E(e.boardNickname)),e.driveDisplayName&&(n.drivename=E(e.driveDisplayName)),e.homeUrl&&(n.homeurl=E(e.homeUrl)),n.targetid=e.id||"???",n.targetname=e.name||"Microsoft MakeCode",n.docsheader=e.docsHeader||"Documentation",n.orgtitle="MakeCode";var i=e.docsLogo&&x.htmlEscape(e.docsLogo),g=(e.organizationWideLogo||e.organizationLogo)&&x.htmlEscape(e.organizationWideLogo||e.organizationLogo),m=e.organizationLogo&&x.htmlEscape(e.organizationLogo),i=(n.targetlogo=i?`<img aria-hidden="true" role="presentation" class="ui ${e.logoWide?"small":"mini"} image" src="${i}" />`:"",n.orglogo=g?`<img aria-hidden="true" role="presentation" class="ui image" src="${g}" />`:"",n.orglogomobile=m?`<img aria-hidden="true" role="presentation" class="ui image" src="${m}" />`:"",r.ghEditURLs||[]);if(i.length){let e='<p style="margin-top:1em">\n',t=lf("Edit this page on GitHub");for(var b of i)e+=`<a href="${b}"><i class="write icon"></i>${t}</a><br>
`,t=lf("Edit template of this page on GitHub");e+="</p>\n",n.github=e}else n.github="";var y,g=`
            <a href="#maincontent" class="ui item link" tabindex="0" role="menuitem">${lf("Skip to main content")}</a>
        `,m=(n.accMenu=g,lf("Print this page")),i=(n.printBtn=`
            <button id="printbtn" class="circular ui icon right floated button hideprint" title="${m}" aria-label="${m}">
                <i class="icon print"></i>
            </button>
        `,`
            <a id="togglesidebar" class="launch icon item" tabindex="0" title="Side menu" aria-label="${lf("Side menu")}" role="menuitem" aria-expanded="false">
                <i class="content icon"></i>
            </a>
        `),g=(n.sidebarToggle=i,["tocsearch1","tocsearch2"].map(e=>`
                <input type="search" name="q" placeholder="${lf("Search...")}" aria-label="${lf("Search Documentation")}">
                <i onclick="document.getElementById('${e}').submit();" tabindex="0" class="search link icon" aria-label="${lf("Search")}" role="button"></i>
            `));n.searchBar1=g[0],n.searchBar2=g[1];let v="";e.accentColor&&(v+=`
.ui.accent { color: ${e.accentColor}; }
.ui.inverted.accent { background: ${e.accentColor}; }
`),n.targetstyle=v,n.tocclass=e.lightToc?"lighttoc":"inverted";for(y of Object.keys(e)){var w=e[y];void 0===n[y]&&"string"==typeof w&&(n[y]=w)}r.finish=()=>S(r.html,n,["body","menu","accMenu","TOC","prev","next","printBtn","breadcrumb","targetlogo","orglogo","orglogomobile","github","JSON","appstoremeta","sidebarToggle","searchBar1","searchBar2"])}function I(e){e.image=function(e,t,n){let i='<img class="ui image" src="'+e+'" alt="'+n+'"';return t&&(i+=' title="'+t+'"'),i=(i+=' loading="lazy"')+(this.options.xhtml?"/>":">")},e.listitem=function(e){var t=/^\s*\[( |x)\]/i.exec(e);return t?`<li class="${" "==t[1]?"unchecked":"checked"}">`+e.slice(t[0].length)+"</li>\n":"<li>"+e+"</li>\n"},e.heading=function(e,t,n){let i=/(.*)#([\w\-]+)\s*$/.exec(e),r="";return r=i?(e=i[1],i[2]):n.toLowerCase().replace(/[^\w]+/g,"-"),(e=(e=e&&e.replace(/@(fullscreen|unplugged|showdialog|showhint)/gi,"")).trim()).match(/^\{([\s\S]+)\}$/)&&(e=e.substr(1,e.length-2)),`<h${t} id="${this.options.headerPrefix}${r}">${e}</h${t}>`}}function U(e,r){return e.replace(/<!--\s*@(ifn?def)\s+(\w+)\s*-->([^]*?)<!--\s*@endif\s*-->/g,(e,t,n,i)=>"ifdef"==t&&r[n]||"ifndef"==t&&!r[n]?`<!-- ${t} ${n} -->${i}<!-- endif -->`:`<!-- ${t} ${n} endif -->`)}function S(e,i,r=[]){return e?e.replace(/@(\w+)@/g,(e,t)=>{let n=x.lookup(i,t)||"";return n+="",n=r.indexOf(t)<0?E(n):n}):""}w.prepTemplate=C,w.setupRenderer=I,w.renderConditionalMacros=U,w.renderMarkdown=function(a){let e=!0,o=(a.pubinfo||(e=!1,a.pubinfo={}),a.pubinfo);a.theme||(a.theme={}),delete a.pubinfo.private,o.time&&(n=parseInt(o.time),o.timems||(o.timems=1e3*n+""),o.humantime||(o.humantime=x.isoTime(n))),o.name&&(o.dirname=o.name.replace(/[^A-Za-z0-9_]/g,"-"),o.title=o.name),e&&(o.JSON=JSON.stringify(o,null,4).replace(/</g,"\\u003c"));let t=a.template,l=(t=U(t=t.replace(/<!--\s*@include\s+(\S+)\s*-->/g,(e,t)=>"\x3c!-- include "+t+" --\x3e\n"+((a.theme.htmlDocIncludes||{})[t]||"")+"\n\x3c!-- end include --\x3e\n"),o),{html:t=a.locale?N(t,a.locale).text:t,theme:a.theme,filepath:a.filepath,versionPath:a.versionPath,ghEditURLs:a.ghEditURLs,params:o,TOC:a.TOC}),s=(C(l),new(v=v||w.requireMarked()).Renderer);I(s);const c=s.link;s.link=function(e,t,n){var i=new RegExp("^[/#]").test(e),r=i?"":"_blank";return i&&l.versionPath&&(e="/"+l.versionPath+e),c.call(s,e,t,n).replace(/^<a /,`<a ${r?`target="${r}"`:""} rel="nofollow noopener" `)};var n=w.requireDOMSanitizer();v.setOptions({renderer:s,gfm:!0,tables:!0,breaks:!1,pedantic:!1,sanitize:!0,sanitizer:n,smartLists:!0,smartypants:!0});let i=a.markdown,r=(a.repo&&(i+=`
\`\`\`package
${a.repo.name.replace(/^pxt-/,"")}=github:${a.repo.fullName}#${a.repo.tag||"master"}
\`\`\`
`),i=(i=i.replace(/^\s*https?:\/\/(\S+)\s*$/gm,(e,t)=>{for(var i of P){let n=i.rx.exec(t);if(n)return i.cmd.replace(/\$(\d+)/g,(e,t)=>n[parseInt(t)]||"")+"\n"}return e})).replace(/@([a-z]+)@/gi,(e,t)=>{var n=o[t];return!n&&a.throwOnError&&x.userError("unknown macro "+t),n||"unknown macro"}),v(i)),u=(r=(r=r.replace(/&lt;br\s*\/&gt;/gi,"<br/>")).replace(/(<img [^>]* src=")\/docs\/static\/([^">]+)"/g,(e,t,n)=>t+"/static/"+n+'"'),""),h=0;function d(e,t,n){let i=n;return e<=h&&(i=u+i,u="",h=0),i}r=r.replace(/<h(\d)[^>]+>\s*([~@])?\s*(.*?)<\/h\d>/g,(e,t,n,i)=>{var r,s=/^(\w+)\s+(.*)/.exec(i),i=s?s[1]:i,s=E(s?s[2]:""),i=E(i);if(t=parseInt(t),n){if("@"==n){let e=x.lookup(l.settings,i);if(null!=e)o[i]=s;else if(null==(e=x.lookup(l.macros,i)))return a.throwOnError&&x.userError("Unknown command: @"+i),_("Unknown command: @"+i);return d(t,0,S(e,{ARGS:s,CMD:i},["ARGS","CMD"]))}return i?(n=x.lookup(l.boxes,i))?(s=d(t,0,(r=n.split("@BODY@"))[0].replace("@ARGS@",s)),u=r[1],(r=n.match(/data-[^>\s]+/gi))&&0<=r.indexOf("data-inferred")&&(h=t),s):(a.throwOnError&&x.userError("Unknown box: ~ "+i),_("Unknown box: ~ "+i)):(n=u,u="",n)}return d(t,0,e)}),u&&(r+=u),o.title||(n=/<h1[^<>]*>([^<>]+)<\/h1>/.exec(r))&&(o.title=E(n[1])),o.description||(n=/<p>([^]+?)<\/p>/.exec(r))&&(o.description=E(n[1]));var p,f,g,m,n=/<div class="ui embed mdvid"[^<>]+?data-placeholder="([^"]+)"[^>]*\/?>/i.exec(r)||/<img class="ui [^"]*image" src="([^"]+)"[^>]*\/?>/i.exec(r);n&&(o.cardLogo=E(n[1])),o.twitter=E(a.theme.twitter||"@msmakecode");let b={main:""};r=(r=r.replace(/<!-- BEGIN-ASIDE (\S+) -->([^]*?)<!-- END-ASIDE -->/g,(e,t,n)=>{var i=x.lookup(b,t);return b[t]=(i||"")+n,"\x3c!-- aside --\x3e"})).replace(/\n<\/code>/g,"</code>"),b.main=r,r="";for(p of Object.keys(b))r+=(f=p+"-container",g=b[p],S(l.boxes[f]||"@BODY@",{BODY:g},["BODY"]));o.body=r,o.name=o.title||"";for(m of Object.keys(a.theme)){var y=a.theme[m];"string"==typeof y&&(o["theme_"+m]=y)}return l.finish()},w.embedUrl=function(e,t,n,i){return`<div style="position:relative;height:0;padding-bottom:70%;overflow:hidden;"><iframe style="position:absolute;top:0;left:0;width:100%;height:100%;" src="${e+`#${t}:`+n}" frameborder="0" sandbox="allow-popups allow-forms allow-scripts allow-same-origin"></iframe></div>`},w.runUrl=function(e,t,n){return`<div style="position:relative;height:0;padding-bottom:${t};overflow:hidden;"><iframe style="position:absolute;top:0;left:0;width:100%;height:100%;" src="${e}?id=${encodeURIComponent(n)}" allowfullscreen="allowfullscreen" sandbox="allow-popups allow-forms allow-scripts allow-same-origin" frameborder="0"></iframe></div>`},w.codeEmbedUrl=function(e,t,n){e=e+"---codeembed#pub:"+t;return`<div style="position:relative;height:calc(${n=Math.ceil(n||300)}px + 5em);width:100%;overflow:hidden;"><iframe style="position:absolute;top:0;left:0;width:100%;height:100%;" src="${e}" allowfullscreen="allowfullscreen" frameborder="0" sandbox="allow-scripts allow-same-origin"></iframe></div>`};const l={b:1,strong:1,em:1};function N(e,i){const r={};function s(e){let t=/^(\s*)([^]*?)(\s*)$/.exec(e),n=t[2].replace(/\s+/g," ");return""==n||/^((IE=edge,.*|width=device-width.*|(https?:\/\/|\/)[\w@\/\.]+|@[\-\w]+@|\{[^\{\}]+\}|[^a-zA-Z]*|(&nbsp;)+)\s*)+$/.test(n)?null:((e=x.lookup(i,n))?n=e:r[n]="",t[1]+n+t[3])}function a(e){return e.replace(/&llt;/g,"<").replace(/&ggt;/g,">")}return{text:e=(e=(e=(e="<start>"+e.replace(/<([\/\w]+)([^<>]*)>/g,(e,t,n)=>{var i=t.replace(/^\//,"").toLowerCase();return 1===l[i]?"&llt;"+t+n+"&ggt;":e})).replace(/(<([\/\w]+)([^<>]*)>)([^<>]+)/g,(e,t,n,i,r)=>{return"script"==n||"style"==n||null==(n=s(a(r)))?a(e):t+n})).replace(/(<[^<>]*)(content|placeholder|alt|title)="([^"]+)"/g,(e,t,n,i)=>null==s(i)?e:t+n+'="'+i.replace(/"/g,"''")+'"')).replace(/^<start>/g,""),missing:r}}function b(e,i){let t=0,r=[{level:0,id:"",title:"",start:t,text:"",children:[]}],n=(e=e.replace(/\r/g,"")).split(/\n/),s={};for(var a of n){let e=/^\s*(#+)\s*(.*?)(#(\S+)\s*)?$/.exec(a),n=null;if(i&&e)if(e[4])if(s[e[4]])e=null;else{n=function e(t,n){if(t.id==n)return t;for(var i of t.children)if(i=e(i,n))return i;return null}(i,e[4]);let t=e=>{e.id&&(s[e.id]=!0),e.children.forEach(t)};n&&t(n)}else e=null;if(e){var o={level:i?1:e[1].length,title:e[2].trim(),id:e[4]||"",start:t,text:"",children:[]};if(n){a="";for(let e=0;e<n.level;++e)a+="#";a=(a=(a+=" ")+(o.title||n.title))+(" #"+o.id)}for(;r[r.length-1].level>=o.level;)r.pop();r[r.length-1].children.push(o),r.push(o)}r[r.length-1].text+=a+"\n",t++}return r[0]}w.translate=N,w.buildTOC=function(e){if(!e)return null;var t=o.docs.requireMarked(),n=w.requireDOMSanitizer(),n={renderer:new t.Renderer,gfm:!0,tables:!1,breaks:!1,pedantic:!1,sanitize:!0,sanitizer:n,smartLists:!1,smartypants:!1};let i={name:"dummy",subitems:[]},r=[],s=(r.push(i),t.lexer(e,n)),a=!1;s.forEach(e=>{switch(e.type){case"heading":e.depth;break;case"list_start":break;case"list_item_start":case"loose_item_start":a=!0;var t={name:"",path:"",subitems:[]};return void r.push(t);case"text":let i=r[r.length-1];0<=e.text.indexOf("[")?e.text.replace(/\[(.*?)\]\((.*?)\)/i,function(e,t,n){i.name=t,i.path=n.replace(".md","")}):a&&(i.name=e.text);break;case"list_item_end":case"loose_item_end":t=r.pop();r[r.length-1].subitems.push(t)}a=!1});t=i.subitems;return t&&0!=t.length?t:null};let m=!(w.visitTOC=function(e,t){e.forEach(function(e){t(e),e.subitems&&e.subitems.forEach(t)})});w.augmentDocs=function r(e,t){if(m||(m=!0,n(i="\n# T0\n## Examples #ex\n### Example 1\nTEx1\n### Example 2 #ex2\nTEx2\n### Example 3\nTEx3\n\n## See also #also\nTAlso\n","",i),n(i," ",i),n(i,"\n# @extends\n# #ex2\nMy example\n## See Also These! #also\nMy links\n","\n# T0\n## Examples #ex\n### Example 1\nTEx1\n### Example 2 #ex2\nMy example\n### Example 3\nTEx3\n\n## See Also These! #also\nMy links\n"),n(i,"\n# @extends\n### #ex\nFoo\n#### Example 1\nEx1\n#### Example 2x #ex2\nEx2\n## See Also These! #also\nMy links\n","\n# T0\n## Examples #ex\nFoo\n#### Example 1\nEx1\n#### Example 2x #ex2\nEx2\n## See Also These! #also\nMy links\n")),!t)return e;function n(e,t,n){var i=r(e,t).trim();if(i!=(n=n.trim()))throw console.log(`*** Template:
${e}
*** Input:
${t}
*** Expected:
${n}
*** Output:
`+i),new Error("augment docs test fail")}var i,s,a;let o=b(e,null),l=b(t,o),c={},u={};for(s of l.children)x.assert(0==s.children.length),x.assert(!!s.id),c[s.id]=s.text;let h=e=>{e.id&&void 0!==c[e.id]&&(u[e.id]=!0,e.text=c[e.id],e.children=[]),e.children.forEach(h)},d=(h(o),""),p=e=>{d+=e.text,e.children.forEach(p)},f=(p(o),""),g=l.text.replace(/^\s*#+\s*@extends.*/gm,"").replace(/^\s*\n/gm,"");g.trim()&&(f+=g.trim()+"\n");for(a of l.children)u[a.id]||(f+=a.text);return f&&(d+="## Couldn't apply replacement logic to:\n"+f),d}}}(pxt=pxt||{}),function(e){(e.dom||(e.dom={})).el=function(e,t,n){const i=document.createElement(e);return t&&Object.keys(t).forEach(e=>i.setAttribute(e,t[e]+"")),function t(e){Array.isArray(e)?e.forEach(e=>t(e)):"string"==typeof e?i.appendChild(document.createTextNode(e)):e instanceof HTMLElement&&i.appendChild(e)}(n),i}}(pxt=pxt||{}),function(l){function c(e){e=/```package\s+((.|\s)+?)\s*```/i.exec(e);let t;return e&&(t={},e[1].split("\n").map(e=>e.replace(/\s*/g,"")).filter(e=>!!e).map(e=>e.split("=")).forEach(e=>t[e[0]]=e[1]||"*")),t}function u(e){e=/```config\s+((.|\s)+?)\s*```/i.exec(e);let t=[];return e&&e[1].split("\n").map(e=>e.replace(/\s*/g,"")).filter(e=>!!e).map(e=>e.split("=")).filter(e=>"feature"==e[0]&&!!e[1]).forEach(e=>t.push(e[1])),t.length?t:void 0}function h(e){var t=/```jres\s+((.|\s)+?)\s*```/i.exec(e);if(t){const e=t[1],n=JSON.parse(e);return{jres:e,ts:l.emitTilemapsFromJRes(n)}}}function d(e){e=/```assetjson\s+((.|\s)+?)\s*```/i.exec(e);return e?l.tutorial.parseAssetJson(e[1]):{}}function s(e){let t=l.Util.jsonTryParse(e);return null!=(t=t&&!Array.isArray(t)?[t]:t)&&t.length||null!=(t=e.split(/^---$/gm).filter(e=>!!e).map(e=>{let i={};return e.replace(/^\s*(?:-|\*)\s+(\w+)\s*:\s*(.*)$/gm,(e,t,n)=>{if("flags"==t)i[t]=n.split(",");else if("otherAction"===t){const e=n.split(",").map(e=>null==e?void 0:e.trim());(i.otherActions||(i.otherActions=[])).push({url:e[0],editor:e[1],cardType:e[2]})}else i[t]=n;return""}),!!Object.keys(i).length&&i}).filter(e=>!!e))&&t.length?t:void 0}function t(e){if(!e)return[];const t=[];let n,i=!1,r="";return e.split(/\r?\n/).forEach(e=>{if(/^## /.test(e))n=e.substr(2).trim();else if(/^(### ~ |```)codecard$/.test(e))i=!0;else if(/^(### ~|```)$/.test(e)){if(i=!1,n&&r){const e=s(r);null!=e&&e.length?t.push({name:n,cards:e}):l.log("invalid gallery format")}r="",n=void 0}else i&&(r+=e+"\n")}),t.forEach(e=>e.cards.forEach(t=>{var e;!t.otherActions||t.otherActions.length||"tutorial"!=t.cardType&&"example"!=t.cardType||(e=["js"],l.appTarget.appTheme.python&&e.unshift("py"),t.otherActions=e.map(e=>({url:t.url,cardType:t.cardType,editor:e})))})),t}var e;(e=l.gallery||(l.gallery={})).parsePackagesFromMarkdown=c,e.parseFeaturesFromMarkdown=u,e.parseJResFromMarkdown=h,e.parseTemplateProjectJSON=d,e.parseExampleMarkdown=function(e,t){if(t){var n,i,r,s,a,o=/```(blocks?|typescript|python|spy|sim)\s+((.|\s)+?)\s*```/i.exec(t);if(o)return n=c(t),i=o[1],r=o[2],s=u(t),a=h(t),(e={name:e,filesOverride:{[l.MAIN_BLOCKS]:'<xml xmlns="http://www.w3.org/1999/xhtml"></xml>',["python"===o[1]?l.MAIN_PY:l.MAIN_TS]:r},dependencies:n,features:s,snippetType:i,source:r}).filesOverride=Object.assign(Object.assign({},e.filesOverride),d(t)),a&&(e.filesOverride[l.TILEMAP_JRES]=a.jres,e.filesOverride[l.TILEMAP_CODE]=a.ts),e}},e.parseCodeCards=s,e.parseCodeCardsHtml=function(e){let n,t=[];return Array.from(e.children).forEach(e=>{"UL"===e.tagName||"OL"===e.tagName?(n=n||{},Array.from(e.querySelectorAll("li")).forEach(e=>{var e=e.innerText,t=/^\s*(\w+)\s*:\s*(.*)$/.exec(e);if(t){const e=t[1];n[e]=t[2].trim(),"flags"===e&&(n[e]=n[e].split(/,\s*/))}})):"HR"==e.tagName&&(n&&t.push(n),n=void 0)}),n&&t.push(n),!(null==(t=0===t.length&&"CODE"===e.tagName?l.Util.jsonTryParse(e.textContent):t)||!t.length)&&t},e.parseGalleryMardown=t,e.loadGalleryAsync=function(e){return l.Cloud.markdownAsync(e).then(e=>t(e))},e.codeCardsToMarkdown=function(e){return`### ~ codecard

${(e||[]).map(t=>Object.keys(t).filter(e=>!!t[e]).map(e=>"otherActions"===e?t[e].map(e=>`* otherAction: ${e.url}, ${e.editor||""}, `+(e.cardType||"")).join("\n"):`* ${e}: `+t[e]).join("\n")).join("\n\n---\n\n")}

### ~
`}}(pxt=pxt||{}),function(o){o.GDBServer=class{constructor(e){this.io=e,this.q=new o.U.PromiseQueue,this.dataBuf="",this.numSent=0,this.pktSize=400,this.trace=!1,this.bmpMode=!0,this.targetInfo="",this.onEvent=e=>{},this.io.onData=e=>this.onData(e)}onData(e){for(this.dataBuf+=o.U.uint8ArrayToString(e);0<this.dataBuf.length;){var t=this.dataBuf[0];if("+"==t)this.dataBuf=this.dataBuf.slice(1);else if("$"==t||"%"==t){var n=this.decodeResp(this.dataBuf.slice(1));if(null==n)break;"$"==t?(this.io.sendPacketAsync(this.buildCmd("+")),this.onResponse?this.onResponse(n):0<this.numSent&&this.io.error("unexpected response: "+n)):this.onEvent(n)}else this.io.error("invalid character: "+t)}}buildCmd(t){if("+"==t)return o.U.stringToUint8Array(t);let n="";for(let e=0;e<t.length;++e){var i=t.charAt(e);"}"==i||"#"==i||"$"==i?n=(n+="}")+String.fromCharCode(32^i.charCodeAt(0)):n+=i}let r=0;t=n;for(let e=0;e<t.length;++e)r=r+t.charCodeAt(e)&255;return n="$"+t+"#"+("0"+r.toString(16)).slice(-2),o.U.stringToUint8Array(n)}decodeResp(i){let r="";for(let n=0;n<i.length;++n){var e=i[n];if("}"==e)++n,r+=String.fromCharCode(32^i.charCodeAt(n));else if("*"==e){++n;let e=i.charCodeAt(n)-29,t=r.charAt(r.length-1);for(;0<e--;)r+=t}else{if("#"==e)return 2==i.slice(n+1,n+3).length?(this.dataBuf=i.slice(n+3),r):null;r+=e}}return null}sendCmdOKAsync(e){return this.sendCmdAsync(e,e=>"OK"==e)}error(e){this.io.error(e),this.io.disconnectAsync()}sendCmdAsync(n,i){this.numSent++;const e=this.buildCmd(n);return this.q.enqueue("one",()=>null===i?this.io.sendPacketAsync(e).then(()=>null):new Promise(t=>{this.onResponse=e=>{this.onResponse=null,this.trace&&o.log(`GDB: '${n}' -> '${e}'`),void 0===i||i(e)||this.error(`Invalid GDB command response: '${n}' -> '${e}'`),t(e)},this.io.sendPacketAsync(e)}))}sendRCmdAsync(e){return this.sendMCmdAsync("qRcmd,"+o.U.toHex(o.U.stringToUint8Array(e)))}sendMCmdAsync(i){this.numSent++;const e=this.buildCmd(i);let r="";return this.q.enqueue("one",()=>new Promise(n=>{this.onResponse=e=>{var t;"OK"!=e&&"O"==e[0]?r+=(t=e.slice(1),o.U.uint8ArrayToString(o.U.fromHex(t))):("OK"!=e&&(r+=" - "+e),this.onResponse=null,this.trace&&o.log(`Final GDB: '${i}' -> '${r}'`),n(r))},this.io.sendPacketAsync(e)}))}write32Async(e,t){var n=new Uint8Array(4);return o.HF2.write32(n,0,t),this.writeMemAsync(e,n)}writeMemAsync(e,t){var n=this.pktSize/2-10;return o.U.assert(t.length<n),this.sendCmdOKAsync("M"+e.toString(16)+","+t.length.toString(16)+":"+o.U.toHex(t)).then(e=>{console.log(e)})}readMemAsync(e,i){const r=this.pktSize/2-6;if(i>r){const s=new Uint8Array(i),a=t=>{const n=Math.min(i-t,r);return 0==n?Promise.resolve(s):this.readMemAsync(e+t,n).then(e=>(o.U.memcpy(s,t,e),a(t+n)))};return a(0)}return this.sendCmdAsync("m"+e.toString(16)+","+i.toString(16)).then(e=>o.U.fromHex(e))}initBMPAsync(){return Promise.resolve().then(()=>this.sendRCmdAsync("swdp_scan")).then(e=>(this.targetInfo=e,this.sendCmdAsync("vAttach;1",e=>"T"==e[0]))).then(()=>{})}initAsync(){return o.U.delay(1e3).then(()=>this.sendCmdAsync("!")).then(()=>this.sendCmdAsync("qSupported")).then(e=>{let i={};return e=(e=";"+e+";").replace(/;([^;]+)[=:]([^:;]+)/g,(e,t,n)=>(i[t]=n,";")),this.pktSize=parseInt(i.PacketSize)||1024,o.log("GDB-server caps: "+JSON.stringify(i)+" "+e.replace(/;+/g,";")),this.bmpMode?this.initBMPAsync():this.sendCmdAsync("c").then(()=>{})})}}}(pxt=pxt||{}),function(a){{var o=a.github||(a.github={}),e;function l(){var e;return!!o.forceProxy||!a.U.isNodeJS&&!(null!=(e=null==(e=null==a?void 0:a.appTarget)?void 0:e.cloud)&&e.noGithubProxy)}o.token=null,o.forceProxy=!1;const P={};function r(r){var e;return r.method=null!=(e=r.method)?e:"GET",function t(e){var n;const i=a.U.clone(r);return o.token&&(i.headers||(i.headers={}),i.url==O?i.headers.Authorization="bearer "+o.token:(i.url=a.BrowserUtils.cacheBustingUrl(i.url),i.headers.Authorization="token "+o.token)),i.allowHttpErrors=null!=(n=i.allowHttpErrors)&&n,a.U.requestAsync(i).catch(e=>{if(a.tickEvent("github.error",{statusCode:e.statusCode}),o.handleGithubNetworkError&&o.handleGithubNetworkError(i,e))return t();throw e})}(o.token)}function c(e){return r({url:e,method:"GET"}).then(e=>e.json)}function u(e){return a.Cloud.apiRequestWithCdnAsync({url:"gh/"+e,forceLiveEndpoint:!0}).then(e=>e.json)}function h(e){a.log("github proxy error: "+e.message),a.debug(e)}o.isOrgAsync=function(e){return r({url:"https://api.github.com/orgs/"+e,method:"GET",allowHttpErrors:!0}).then(e=>200==e.statusCode)};class _{constructor(){this.configs={},this.packages={}}proxyWithCdnLoadPackageAsync(e,t){const n=e+"/"+t;var i=this.packages[n];return i?(a.debug(`github cache ${e}/${t}/text`),Promise.resolve(i)):u(U((i=E(e)).slug,t,i.fileName,"text")).then(e=>this.packages[n]={files:e})}cacheConfig(e,t){t=a.Package.parseAndValidConfig(t);return this.configs[e]=t,a.U.clone(t)}async loadConfigAsync(e,t){var n=e+"/"+(t=t||"master"),i=this.configs[n];if(i)return a.debug(`github cache ${e}/${t}/config`),a.U.clone(i);if(l())try{const l=await this.proxyWithCdnLoadPackageAsync(e,t);return this.cacheConfig(n,l.files[a.CONFIG_NAME])}catch(e){h(e)}i=await p(e,t,a.CONFIG_NAME);return this.cacheConfig(n,i)}async loadPackageAsync(e,t){if(t=t||"master",l())try{return await this.proxyWithCdnLoadPackageAsync(e,t).then(e=>a.U.clone(e))}catch(e){h(e)}return this.githubLoadPackageAsync(e,t)}githubLoadPackageAsync(r,n){return y(r,n).then(i=>{const t=r+"/"+i;var e=this.packages[t];return e?(a.debug(`github cache ${r}/${n}/text`),Promise.resolve(a.U.clone(e))):(a.log(`Downloading ${r}/${n} -> `+i),p(r,i,a.CONFIG_NAME).then(e=>{const n={files:{}};n.files[a.CONFIG_NAME]=e;e=JSON.parse(e);return a.U.promiseMapAll(a.allPkgFiles(e).slice(1),t=>p(r,i,t).then(e=>{n.files[t]=e})).then(()=>(this.packages[t]=n,a.U.clone(n)))}))})}}function d(t,e,n){return r({url:"https://api.github.com/repos/"+U(t.slug,"contents",t.fileName,n+"?ref="+e),method:"GET"}).then(e=>{e=e.json;return P[t.slug]=!0,e&&"base64"==e.encoding&&null!=e.content?atob(e.content):a.U.httpGetTextAsync(e.download_url)})}function p(e,t,n){const i=E(e);return P[i.slug]?d(i,t,n):a.U.requestAsync({url:"https://raw.githubusercontent.com/"+U(i.slug,t,i.fileName,n),allowHttpErrors:!0}).then(e=>200==e.statusCode?e.text:d(i,t,n))}function f(e,t,n,i){return r({url:/^https:/.test(e)?e:"https://api.github.com/repos/"+e,headers:n,method:i||"POST",data:t,successCodes:[200,201,202,204]}).then(e=>e.json)}function g(e,t){let n=1;for(;e.refs[t+n];)n++;return t+n}async function m(e,t,n){return await f(e+"/git/refs",{ref:"refs/heads/"+t,sha:n}),t}function b(e,n="tags",t,i){e=E(e),t=!!o.forceProxy||!(o.token&&!t)&&l();let r=null;t=t?a.U.httpGetJsonAsync(a.BrowserUtils.cacheBustingUrl(`${a.Cloud.apiRoot}gh/${e.slug}/refs`+(i?"?nocache=1":""))).then(t=>{var e=Object.keys(t.refs).filter(e=>a.U.startsWith(e,"refs/"+n+"/")).map(e=>({ref:e,object:{sha:t.refs[e]}}));return r=t.refs.HEAD,e}):c(`https://api.github.com/repos/${e.slug}/git/refs/${n}/?per_page=100`);let s=e=>e.replace(/^refs\/[^\/]+\//,"");return t.then(e=>{e.sort((e,t)=>a.semver.strcmp(s(e.ref),s(t.ref)));var t,n={};for(t of e)n[s(t.ref)]=t.object.sha;return{refs:n,head:r}},e=>404==e.statusCode?{refs:{}}:Promise.reject(e))}function i(e){return"commit"==e.object.type?Promise.resolve(e.object.sha):"tag"==e.object.type?c(e.object.url).then(e=>"commit"==e.object.type?e.object.sha:Promise.reject(new Error("Bad type (2nd order) "+e.object.type))):Promise.reject(new Error("Bad type "+e.object.type))}function y(e,t){if(/^[a-f0-9]{40}$/.test(t))return Promise.resolve(t);const n=E(e);return c(`https://api.github.com/repos/${n.slug}/git/refs/tags/`+t).then(i,e=>c(`https://api.github.com/repos/${n.slug}/git/refs/heads/`+t).then(i))}function v(e,t="master"){return o.db.loadConfigAsync(e,t)}function w(n,i){var e=E(n);return e?T(e,i)?(a.tickEvent("github.download.banned"),a.log("Github repo is banned"),Promise.resolve(void 0)):o.db.loadPackageAsync(e.fullName,e.tag).then(e=>{var t=N(i,n);if(t){const i=a.Package.parseAndValidConfig(e.files[a.CONFIG_NAME]);i&&(a.log(`auto-disable ${t.join(",")} due to targetconfig entry for `+n),i.disablesVariants=t,e.files[a.CONFIG_NAME]=a.Package.stringifyConfig(i))}return e}):(a.log("Unknown GitHub syntax"),Promise.resolve(void 0))}let s;function t(e){return a.Cloud.cdnApiUrl(`gh/${e.fullName}/icon`)}function k(e,t){var n;if(e)return(n={owner:e.owner.login.toLowerCase(),slug:e.full_name.toLowerCase(),fullName:((null==t?void 0:t.fullName)||e.full_name).toLowerCase(),fileName:null==(n=null==t?void 0:t.fileName)?void 0:n.toLocaleLowerCase(),name:e.name,description:e.description,defaultBranch:e.default_branch,tag:null==t?void 0:t.tag,updatedAt:Math.round(new Date(e.updated_at).getTime()/1e3),fork:e.fork,private:e.private}).status=A(n,null==t?void 0:t.config),n}function A(e,t){return e?T(e,t)?s.Banned:(r=t=t,(i=n=e)&&r&&i.owner&&r.approvedOrgs&&r.approvedOrgs.some(e=>e.toLowerCase()==i.owner.toLowerCase())||n&&t&&n.fullName&&t.approvedRepos&&t.approvedRepos.some(e=>e.toLowerCase()==n.fullName.toLowerCase())?s.Approved:s.Unknown):s.Unknown;var n,i,r}function T(t,e){return n=t,(i=e)&&(!n||!n.owner||i.bannedOrgs&&i.bannedOrgs.some(e=>e.toLowerCase()==n.owner.toLowerCase()))||e&&(!t||!t.fullName||e.bannedRepos&&e.bannedRepos.some(e=>e.toLowerCase()==t.fullName.toLowerCase()));var n,i}async function x(e,t){e=E(e);if(e){var n,i,r=A(e,t);if(r!=s.Banned){if(l())try{return i=r,await u((n=e).slug).then(e=>{if(e)return{github:!0,owner:n.owner,fullName:n.fullName,fileName:n.fileName,slug:n.slug,name:n.fileName?e.name+"-"+n.fileName:e.name,description:e.description,defaultBranch:e.defaultBranch||"master",tag:n.tag,status:i}}).catch(e=>{a.reportException(e)})}catch(e){h(e)}return k(await c("https://api.github.com/repos/"+e.slug),{config:t,fullName:e.fullName,fileName:e.fileName,tag:e.tag})}}}function E(t){if(t){t=(t=t.trim()).replace(/\/$/,"");var n=/^https:\/\/([^./#]+)\.github\.io\/([^/#]+)\/?$/i.exec(t),n=(t=(t=(t=(t=n?`github:${n[1]}/`+n[2]:t).replace(/^github:/i,"")).replace(/^https:\/\/github\.com\//i,"")).replace(/\.git\b/i,""),/^([^#\/:]+)\/([^#\/:]+)(\/([^#]+))?(#([^\/:]*))?$/.exec(t));if(n){var t=n[1],i=n[2];let e=n[4];var n=n[6],r=e&&/^tree\/([^\/]+\/)/.exec(e);return r&&(e=e.slice(r[0].length)),{owner:t,project:i,slug:U(t,i),fullName:U(t,i,e),tag:n,fileName:e}}}}function C(e){return!!e&&"github:"==e.slice(0,7)}function I(e){return e?"github:"+e.fullName.toLowerCase()+"#"+(e.tag||"master"):void 0}function U(...e){return e.filter(e=>!!e).join("/")}function S(e,t){return e&&e.upgrades&&(t=E(t))?a.U.lookup(e.upgrades,t.fullName.toLowerCase()):null}function N(e,t){e=S(e,t),t=/^dv:(.*)/.exec(e);if(t){const e=t[1].split(/,/);return e.some(e=>!/^\w+$/.test(e))?null:e}return null}o.MemoryGithubDb=_,o.downloadTextAsync=p,o.db=new _,o.authenticatedUserAsync=function(){return o.token?c("https://api.github.com/user"):Promise.resolve(void 0)},o.getCommitsAsync=function(e,t){return c("https://api.github.com/repos/"+E(e).slug+"/commits?sha="+t).then(e=>e.map(e=>{var t=e.commit;return t.url=e.url,t.sha=e.sha,t}))},o.getCommitAsync=function(e,t){return c("https://api.github.com/repos/"+E(e).slug+"/git/commits/"+t).then(t=>c(t.tree.url+"?recursive=1").then(e=>(t.tree=e,t)))},o.createObjectAsync=function(e,t,n){return f(E(e).slug+"/git/"+t+"s",n).then(e=>e.sha)},o.postCommitComment=function(e,t,n,i,r){return f(E(e).slug+`/commits/${t}/comments`,{body:n,path:i,position:r}).then(e=>e.id)},o.fastForwardAsync=async function(e,t,n){return 200==(await r({url:`https://api.github.com/repos/${E(e).slug}/git/refs/heads/`+t,method:"PATCH",allowHttpErrors:!0,data:{sha:n,force:!1}})).statusCode},o.putFileAsync=async function(e,t,n){e=E(e);await r({url:"https://api.github.com/repos/"+a.github.join(e.slug,"contents",e.fileName,t),method:"PUT",allowHttpErrors:!0,data:{message:lf("Initialize empty repo"),content:btoa(a.U.toUTF8(n)),branch:"master"},successCodes:[201]})},o.createTagAsync=async function(e,t,n){await f(e+"/git/refs",{ref:"refs/tags/"+t,sha:n})},o.createReleaseAsync=async function(e,t,n){await f(e+"/releases",{tag_name:t,target_commitish:n,name:t,draft:!1,prerelease:!1})},o.createPRFromBranchAsync=async function(e,t,n,i,r){e=await f(e+"/pulls",{title:i,body:r||lf("Automatically created from MakeCode."),head:n,base:t,maintainer_can_modify:!0});return null==e?void 0:e.html_url},o.mergeAsync=function(t,e,n,i){return r({url:`https://api.github.com/repos/${E(t).slug}/merges`,method:"POST",successCodes:[201,204,409],data:{base:e,head:n,commit_message:i}}).then(e=>{if(201==e.statusCode||204==e.statusCode)return e.json.sha;if(409==e.statusCode)return null;throw a.U.userError(lf("Cannot merge in github.com/{1}; code: {2}",t,e.statusCode))})},o.getRefAsync=function(e,t){return c("https://api.github.com/repos/"+e+"/git/refs/heads/"+(t=t||"master")).then(i).catch(e=>{404!=e.statusCode&&Promise.reject(e)})},o.getNewBranchNameAsync=async function(e,t="patch-"){return g(await b(e,"heads"),t)},o.createNewBranchAsync=m,o.forkRepoAsync=async function(e,t,n="pr-"){var e=E(e),i=k(await f(e.slug+"/forks",{}),{fullName:e.fullName,fileName:e.fileName}),r=Date.now()+3e5;let s=null;for(;!s&&Date.now()<r;){await a.U.delay(1e3);try{s=await b(i.slug,"heads")}catch(e){}}if(s)return e=g(s,n),await m(i.slug,e,t),i.fullName+"#"+e;throw new Error(lf("Timeout waiting for fork"))},o.listRefsAsync=function(e,t="tags",n,i){return b(e,t,n,i).then(e=>Object.keys(e.refs))},o.listRefsExtAsync=b,o.pkgConfigAsync=v,o.downloadPackageAsync=w,o.downloadLatestPackageAsync=async function(e){var t=await a.packagesConfigAsync(),n=await a.github.latestVersionAsync(e.slug,t),i=e.fullName+"#"+n;return await a.github.downloadPackageAsync(i,t),{version:"github:"+i,config:await v(e.fullName,n)}},o.cacheProjectDependenciesAsync=async function(n){var i,e=null==(i=Object.keys(n.dependencies))?void 0:i.filter(e=>C(n.dependencies[e]));if(e.length){const i=await a.packagesConfigAsync();await Promise.all(e.map(async e=>{var t=n.dependencies[e];if(!await w(t,i))throw new Error(lf("Cannot load extension {0} from {1}",e,t))}))}},(e=s=o.GitRepoStatus||(o.GitRepoStatus={}))[e.Unknown=0]="Unknown",e[e.Approved=1]="Approved",e[e.Banned=2]="Banned",o.listUserReposAsync=function(){return n('{\n  viewer {\n    repositories(first: 100, affiliations: [OWNER, COLLABORATOR], orderBy: {field: PUSHED_AT, direction: DESC}) {\n      nodes {\n        name\n        description\n        full_name: nameWithOwner\n        private: isPrivate\n        fork: isFork\n        updated_at: updatedAt\n        owner {\n          login\n        }\n        defaultBranchRef {\n          name\n        }\n        pxtjson: object(expression: "master:pxt.json") {\n          ... on Blob {\n            text\n          }\n        }\n        readme: object(expression: "master:README.md") {\n          ... on Blob {\n            text\n          }\n        }\n      }\n    }\n  }\n}').then(e=>e.data.viewer.repositories.nodes.filter(e=>e.pxtjson).filter(e=>{e.default_branch=e.defaultBranchRef.name;var t=a.Package.parseAndValidConfig(e.pxtjson&&e.pxtjson.text),e=e.readme&&e.readme.text;return!!t&&(t.supportedTargets?-1<t.supportedTargets.indexOf(a.appTarget.id):e&&-1<e.indexOf("PXT/"+a.appTarget.id))}).map(e=>k(e,{fullName:e.full_name})))},o.createRepoAsync=function(e,t,n){return f("https://api.github.com/user/repos",{name:e,description:t,private:!!n,has_issues:!0,has_projects:!1,has_wiki:!1,allow_rebase_merge:!1,allow_merge_commit:!0,delete_branch_on_merge:!1}).then(e=>k(e))},o.enablePagesAsync=async function(e){const t=E(e);let n;try{const a=await c(`https://api.github.com/repos/${t.slug}/pages`);a&&(n=a.html_url)}catch(e){}if(!n)try{n=(await f(`https://api.github.com/repos/${t.slug}/pages`,{source:{branch:"master",path:"/"}},{Accept:"application/vnd.github.switcheroo-preview+json"})).html_url}catch(e){a.tickEvent("github.pages.error"),a.reportException(e)}if(n){const t=await c("https://api.github.com/repos/"+e);if(t&&!t.homepage)try{await f("https://api.github.com/repos/"+e,{homepage:n},void 0,"PATCH")}catch(e){a.tickEvent("github.homepage.error")}}},o.repoIconUrl=function(e){if(e.status==s.Approved)return t(e)},o.mkRepoIconUrl=t,o.repoStatus=A,o.repoAsync=x,o.searchAsync=function(e,t){var n;return t?0<(n=e.split("|").map(E).filter(e=>!!e)).length?Promise.all(n.map(e=>x(e.fullName,t))).then(e=>e.filter(e=>e&&e.status!=s.Banned)):a.U.httpGetJsonAsync(`${a.Cloud.apiRoot}ghsearch/${a.appTarget.id}/${a.appTarget.platformid||a.appTarget.id}?q=`+encodeURIComponent(e)).then(e=>e.items.map(e=>k(e,{config:t,fullName:e.full_name})).filter(e=>e.status==s.Approved||t.allowUnapproved&&e.status==s.Unknown).filter(e=>!a.appTarget.appTheme.githubUrl||"https://github.com/"+e.fullName!=a.appTarget.appTheme.githubUrl.toLowerCase())).catch(e=>[]):Promise.resolve([])},o.parseRepoId=E,o.toGithubDependencyPath=function(e,t){let n="github:"+e;return t&&(n+="#"+t),n},o.isGithubId=C,o.stringifyRepo=I,o.normalizeRepoId=function(e){e=E(e);if(e)return e.tag=e.tag||"master",I(e)},o.join=U,o.upgradedPackageReference=function(e,t){const n=S(e,t);if(!n)return null;var i=/^min:(.*)/.exec(n),r=i&&a.semver.tryParse(i[1]);if(r){const e=E(t),n=a.semver.tryParse(e.tag);return n&&a.semver.cmp(n,r)<0?(e.tag=i[1],a.debug(`upgrading ${t} to `+i[1]),I(e)):(n||a.log(`not upgrading ${t} - cannot parse version`),null)}return N(e,t)||a.log(`invalid upgrade rule: ${t} -> `+n),t},o.upgradedPackageId=function(e,t){e=N(e,t);return e?t+"?dv="+e.join(","):t},o.latestVersionAsync=function(e,r,t,n){const s=E(e);return s?x(s.slug,r).then(i=>{if(i)return b(i.slug,"tags",t,n).then(t=>{var e=Object.keys(t.refs),e=a.semver.sortLatestTags(e),n=a.appTarget.versions&&a.semver.tryParse(a.appTarget.versions.target);if(n&&r.releases&&r.releases["v"+n.major]){const t=r.releases["v"+n.major].map(e=>a.github.parseRepoId(e)).filter(e=>e&&e.fullName.toLowerCase()==s.fullName.toLowerCase())[0];if(t){if(e.some(e=>e==t.tag))return a.debug(`approved release ${t.fullName}#${t.tag} for v`+n.major),Promise.resolve(t.tag);a.reportError("packages",`approved release ${t.fullName}#${t.tag} for v${n.major} not found anymore`,{repo:i.fullName})}}return e[0]?Promise.resolve(e[0]):t.head||y(i.slug,i.defaultBranch)})}):Promise.resolve(null)},o.resolveMonoRepoVersions=function(n){n=a.Util.clone(n);const i={};return Object.keys(n).map(e=>({id:e,ghid:o.parseRepoId(n[e])})).filter(e=>{return null==(e=e.ghid)?void 0:e.tag}).forEach(e=>{var t=e["ghid"];let n=i[t.slug];(n=n||(i[t.slug]={tag:t.tag,deps:[]})).deps.push(e),a.semver.strcmp(n.tag,t.tag)<0&&(a.debug("dep: resolve later monorepo tag to "+a.github.stringifyRepo(t)),n.tag=t.tag)}),a.U.values(i).forEach(t=>t.deps.forEach(e=>{e.ghid.tag!==t.tag&&(a.debug(`dep: ${a.github.stringifyRepo(e.ghid)} -> `+t.tag),e.ghid.tag=t.tag,n[e.id]=a.github.stringifyRepo(e.ghid))})),n},o.GIT_JSON=".git.json";const O="https://api.github.com/graphql";function n(e){e=JSON.stringify({query:e});return f(O,e)}o.lookupFile=function(e,t,n){if(!t)return null;const i=U(e.fileName,n);return t.tree.tree.find(e=>e.path==i)},o.ghGraphQLQueryAsync=n,o.findPRNumberforBranchAsync=function(e,t){e=E(e);return n(`
{
    repository(owner: ${JSON.stringify(e.owner)}, name: ${JSON.stringify(e.project)}) {
        pullRequests(last: 1, states: [OPEN, MERGED], headRefName: ${JSON.stringify(t)}) {
            edges {
                node {
                    number
                    state
                    mergeable
                    baseRefName
                    url
                    isDraft
                }
            }
        }
    }
}
`).then(e=>{var t=e.data.repository.pullRequests.edges[0];if(t&&t.node){const e=t.node;return{number:e.number,mergeable:e.mergeable,state:e.state,title:e.title,url:e.url,base:e.baseRefName}}return{number:-1}})},o.getPagesStatusAsync=function(e){return c(`https://api.github.com/repos/${e}/pages`).catch(e=>({status:null}))}}}(pxt=pxt||{}),function(e){e.REFCNT_FLASH="0xfffe",e.VTABLE_MAGIC=249,e.ValTypeObject=4,(e=e.BuiltInType||(e.BuiltInType={}))[e.BoxedString=1]="BoxedString",e[e.BoxedNumber=2]="BoxedNumber",e[e.BoxedBuffer=3]="BoxedBuffer",e[e.RefAction=4]="RefAction",e[e.RefImage=5]="RefImage",e[e.RefCollection=6]="RefCollection",e[e.RefRefLocal=7]="RefRefLocal",e[e.RefMap=8]="RefMap",e[e.RefMImage=9]="RefMImage",e[e.MMap=10]="MMap",e[e.BoxedString_SkipList=11]="BoxedString_SkipList",e[e.BoxedString_ASCII=12]="BoxedString_ASCII",e[e.ZPin=13]="ZPin",e[e.User0=16]="User0"}(pxt=pxt||{}),function(l){{var c=l.HF2||(l.HF2={});function o(e,t,n){e[t+0]=n>>0&255,e[t+1]=n>>8&255,e[t+2]=n>>16&255,e[t+3]=n>>24&255}function u(e,t,n){e[t+0]=n>>0&255,e[t+1]=n>>8&255}function s(e,t){return(e[t]|e[t+1]<<8|e[t+2]<<16|e[t+3]<<24)>>>0}function h(e,t){return e[t]|e[t+1]<<8}function n(t){var n=new Uint8Array(4*t.length);for(let e=0;e<t.length;++e)o(n,4*e,t[e]);return n}c.HF2_CMD_BININFO=1,c.HF2_MODE_BOOTLOADER=1,c.HF2_MODE_USERSPACE=2,c.HF2_CMD_INFO=2,c.HF2_CMD_RESET_INTO_APP=3,c.HF2_CMD_RESET_INTO_BOOTLOADER=4,c.HF2_CMD_START_FLASH=5,c.HF2_CMD_WRITE_FLASH_PAGE=6,c.HF2_CMD_CHKSUM_PAGES=7,c.HF2_CMD_READ_WORDS=8,c.HF2_CMD_WRITE_WORDS=9,c.HF2_CMD_DMESG=16,c.HF2_FLAG_SERIAL_OUT=128,c.HF2_FLAG_SERIAL_ERR=192,c.HF2_FLAG_CMDPKT_LAST=64,c.HF2_FLAG_CMDPKT_BODY=0,c.HF2_FLAG_MASK=192,c.HF2_SIZE_MASK=63,c.HF2_STATUS_OK=0,c.HF2_STATUS_INVALID_CMD=1,c.HF2_STATUS_EXEC_ERR=2,c.HF2_STATUS_EVENT=128,c.HF2_CMD_JDS_CONFIG=32,c.HF2_CMD_JDS_SEND=33,c.HF2_EV_JDS_PACKET=8388640,c.CUSTOM_EV_JACDAC="jacdac",c.HF2_EV_MASK=8388608,c.write32=o,c.write16=u,c.read32=s,c.read16=h,c.encodeU32LE=n;let t=!(c.decodeU32LE=function(t){var n=[];for(let e=0;e<t.length;e+=4)n.push(s(t,e));return n});function d(e){t?l.log("HF2: "+e):l.debug("HF2: "+e)}c.enableLog=function(){t=!0};class i{constructor(a){var e;this.io=a,this.cmdSeq=l.U.randomUint32(),this.lock=new l.U.PromiseQueue,this.flashing=!1,this.rawMode=!1,this.maxMsgSize=63,this.bootloaderMode=!1,this.reconnectTries=0,this.autoReconnect=!1,this.icon=(null==(e=l.appTarget.appTheme.downloadDialogTheme)?void 0:e.deviceIcon)||"usb",this.msgs=new l.U.PromiseBuffer,this.eventHandlers={},this.jacdacAvailable=!1,this.onSerial=(e,t)=>{},this.onCustomEvent=(e,t)=>{};let o=[];a.onDeviceConnectionChanged=e=>this.disconnectAsync().then(()=>e&&this.reconnectAsync()),a.onSerial=(e,t)=>this.onSerial(e,t),a.onData=e=>{var i=e[0]&c.HF2_FLAG_MASK,t=63&e[0],n=new Uint8Array(t);if(l.U.memcpy(n,0,e,1,t),i&c.HF2_FLAG_SERIAL_OUT)this.onSerial(n,i==c.HF2_FLAG_SERIAL_ERR);else if(o.push(n),i!=c.HF2_FLAG_CMDPKT_BODY){l.U.assert(i==c.HF2_FLAG_CMDPKT_LAST);let e=0;for(var r of o)e+=r.length;let t=new Uint8Array(e),n=0;for(var s of o)l.U.memcpy(t,n,s),n+=s.length;o=[],t[2]&c.HF2_STATUS_EVENT?a.onEvent(t):this.msgs.push(t)}},a.onEvent=e=>{var t=s(e,0),n=l.U.lookup(this.eventHandlers,t+"");n?n(e.slice(4)):d("unhandled event: "+t.toString(16))},a.onError=e=>{d("recv error: "+e.message),this.autoReconnect&&(this.autoReconnect=!1,this.reconnectAsync().then(()=>{this.autoReconnect=!0},e=>{d("reconnect error: "+e.message)}))},this.onEvent(c.HF2_EV_JDS_PACKET,e=>{this.onCustomEvent(c.CUSTOM_EV_JACDAC,e)})}resetState(){this.lock=new l.U.PromiseQueue,this.info=null,this.infoRaw=null,this.pageSize=null,this.flashSize=null,this.maxMsgSize=63,this.bootloaderMode=!1,this.msgs.drain()}onEvent(e,t){l.U.assert(!!(e&c.HF2_EV_MASK)),this.eventHandlers[e+""]=t}sendCustomEventAsync(e,t){return e==c.CUSTOM_EV_JACDAC?this.jacdacAvailable?this.talkAsync(c.HF2_CMD_JDS_SEND,t).then(()=>{}):Promise.resolve():Promise.reject(new Error("invalid custom event type"))}reconnectAsync(){return this.resetState(),d("reconnect raw="+this.rawMode),this.io.reconnectAsync().then(()=>this.initAsync()).catch(e=>{if(this.reconnectTries<5)return this.reconnectTries++,d(`error ${e.message}; reconnecting attempt #`+this.reconnectTries),l.U.delay(500).then(()=>this.reconnectAsync());throw e})}disconnectAsync(){return d("disconnect"),this.io.disconnectAsync()}error(e){return this.io.error(e)}talkAsync(e,t){if(this.io.talksAsync)return this.io.talksAsync([{cmd:e,data:t}]).then(e=>e[0]);let n=8,i=(t&&(n+=t.length),new Uint8Array(n)),r=65535&++this.cmdSeq,s=(o(i,0,e),u(i,4,r),u(i,6,0),t&&l.U.memcpy(i,8,t,0,t.length),0),a=()=>this.msgs.shiftAsync(1e3).then(e=>{if(h(e,0)!=r){if(s<3)return s++,d(`message out of sync, (${r} vs ${h(e,0)}); will re-try`),a();this.error("out of sync")}let t="";switch(e[3]&&(t="; info="+e[3]),e[2]){case c.HF2_STATUS_OK:return e.slice(4);case c.HF2_STATUS_INVALID_CMD:this.error("invalid command"+t);break;case c.HF2_STATUS_EXEC_ERR:this.error("execution error"+t);break;default:this.error("error "+e[2]+t)}return null});return this.sendMsgAsync(i).then(a)}sendMsgAsync(e){return this.sendMsgCoreAsync(e)}sendSerialAsync(e,t=!1){return this.io.sendSerialAsync?this.io.sendSerialAsync(e,t):this.sendMsgCoreAsync(e,t?2:1)}sendMsgCoreAsync(i,e=0){let r=new Uint8Array(64),s=t=>{let n=i.length-t;if(n<=0)return Promise.resolve();63<n?(n=63,r[0]=c.HF2_FLAG_CMDPKT_BODY):r[0]=c.HF2_FLAG_CMDPKT_LAST,e&&(r[0]=1==e?c.HF2_FLAG_SERIAL_OUT:c.HF2_FLAG_SERIAL_ERR),r[0]|=n;for(let e=0;e<n;++e)r[e+1]=i[t+e];return this.io.sendPacketAsync(r).then(()=>s(t+n))};return this.lock.enqueue("out",()=>s(0))}switchToBootloaderAsync(){return this.bootloaderMode?Promise.resolve():(d("Switching into bootloader mode"),this.io.isSwitchingToBootloader&&this.io.isSwitchingToBootloader(),this.maybeReconnectAsync().then(()=>this.talkAsync(c.HF2_CMD_START_FLASH).then(()=>{},e=>this.talkAsync(c.HF2_CMD_RESET_INTO_BOOTLOADER).then(()=>{},e=>{}).then(()=>this.reconnectAsync().catch(e=>{throw"devicenotfound"===e.type&&(e.type="repairbootloader"),e})))).then(()=>this.initAsync()).then(()=>{this.bootloaderMode||this.error("cannot switch into bootloader mode")}))}isFlashing(){return!!this.flashing}reflashAsync(e){d("reflash"),l.U.assert(l.appTarget.compile.useUF2);const t=e.outfiles[pxtc.BINARY_UF2],n=pxtc.UF2.parseFile(l.Util.stringToUint8Array(atob(t)));return this.flashing=!0,this.io.reconnectAsync().then(()=>this.flashAsync(n)).then(()=>l.U.delay(100)).finally(()=>this.flashing=!1).then(()=>this.reconnectAsync())}writeWordsAsync(e,t){return l.U.assert(t.length<=64),this.talkAsync(c.HF2_CMD_WRITE_WORDS,n([e,t.length].concat(t))).then(()=>{})}readWordsAsync(e,t){var n=new Uint8Array(8);return o(n,0,e),o(n,4,t),l.U.assert(t<=64),this.talkAsync(c.HF2_CMD_READ_WORDS,n)}pingAsync(){return this.rawMode?Promise.resolve():this.talkAsync(c.HF2_CMD_BININFO).then(e=>{})}maybeReconnectAsync(){return this.pingAsync().catch(e=>this.reconnectAsync().then(()=>this.pingAsync()))}flashAsync(i){let n=Date.now(),r=0,s=e=>{var t,n;return e>=i.length?Promise.resolve():(t=i[e],o(n=new Uint8Array(4+t.payloadSize),0,t.targetAddr),l.U.memcpy(n,4,t.data,0,t.payloadSize),this.talkAsync(c.HF2_CMD_WRITE_FLASH_PAGE,n).then(()=>s(e+1)))};return this.switchToBootloaderAsync().then(()=>{var e=256*i.length;return d(`Starting flash (${Math.round(e/1024)}kB).`),r=Date.now(),16384<this.pageSize?i:a(i,(e,t)=>this.readWordsAsync(e,t))}).then(e=>{e.length!=i.length&&(e=256*(i=e).length,d(`Performing partial flash (${Math.round(e/1024)}kB).`))}).then(()=>s(0)).then(()=>{var e=Date.now(),t=e-n,e=e-r;d(`Flashing done at ${Math.round(256*i.length/e*1e3/1024)} kB/s in ${t}ms (reset ${t-e}ms). Resetting.`)}).then(()=>this.talkAsync(c.HF2_CMD_RESET_INTO_APP).catch(e=>{})).then(()=>{})}initAsync(){return this.rawMode?Promise.resolve():Promise.resolve().then(()=>this.talkAsync(c.HF2_CMD_BININFO)).then(e=>(this.bootloaderMode=e[0]==c.HF2_MODE_BOOTLOADER,this.pageSize=s(e,4),this.flashSize=s(e,8)*this.pageSize,this.maxMsgSize=s(e,12),this.familyID=s(e,16),d(`Connected; msgSize ${this.maxMsgSize}B; flash ${this.flashSize/1024}kB; ${this.bootloaderMode?"bootloader":"application"} mode; family=0x`+this.familyID.toString(16)),this.talkAsync(c.HF2_CMD_INFO))).then(e=>{this.infoRaw=l.Util.fromUTF8Array(e),l.debug("Info: "+this.infoRaw);let i={};("Header: "+this.infoRaw).replace(/^([\w\-]+):\s*([^\n\r]*)/gm,(e,t,n)=>(i[t.replace(/-/g,"")]=n,"")),this.info=i;e=/v(\d\S+)(\s+(\S+))?/.exec(this.info.Header);this.info.Parsed=e?{Version:e[1],Features:e[3]||""}:{Version:"?",Features:""},d(`Board-ID: ${this.info.BoardID} v${this.info.Parsed.Version} f`+this.info.Parsed.Features)}).then(()=>this.talkAsync(c.HF2_CMD_JDS_CONFIG,new Uint8Array([1])).then(()=>{this.jacdacAvailable=!0},e=>{this.jacdacAvailable=!1})).then(()=>{this.reconnectTries=0})}}function a(i,e){if(!l.appTarget.compile.flashChecksumAddr)return Promise.resolve(i);let t=pxtc.UF2.readBytes(i,l.appTarget.compile.flashChecksumAddr,48),r=pxtc.parseChecksumBlock(t);return r?(n=e,(l.appTarget.compile.flashChecksumAddr?n(l.appTarget.compile.flashChecksumAddr,12).then(e=>{let t=pxtc.parseChecksumBlock(e);return t?n(t.endMarkerPos,1).then(e=>s(e,0)!=t.endMarker?(l.log("end-marker mismatch"),null):t):null}):Promise.resolve(null)).then(e=>{if(!e)return i;let n=e.regions.filter(t=>r.regions.some(e=>t.checksum==e.checksum&&t.length==e.length&&t.start==e.start));if(0==n.length)return i;d("skipping flash at: "+n.map(e=>`${pxtc.assembler.tohex(e.start)} (${e.length/1024}kB)`).join(", "));let t=t=>n.some(e=>e.start<=t&&t<e.start+e.length);return i.filter(e=>!(t(e.targetAddr)&&t(e.targetAddr+e.payloadSize-1)))})):Promise.resolve(i);var n}c.Wrapper=i,c.mkHF2PacketIOWrapper=function(e){return l.debug("packetio: wrapper hf2"),new i(e)},c.onlyChangedBlocksAsync=a}}(pxt=pxt||{}),function(r){{var s=r.HWDBG||(r.HWDBG={}),g=r.Util,m=r.HF2;const T=m.read32;let d,e,n,t,p,f,a,o,i=!1;function b(e){return 1&e?e>>1:0!=e?2&e?e==s.taggedNull?null:e!=s.taggedFalse&&(e==s.taggedTrue||{tagged:e>>2}):{ptr:e}:void 0}function l(e,t){var n;if(g.assert(!(3&e)),g.assert(0<=e),e<2097152)return n=new Uint8Array(t),e-=a.start,g.memcpy(n,0,a.buf,e,t),Promise.resolve(n);var i=o.maxMsgSize-32;if(i<t){for(var r=[];0<t;){var s=Math.min(i,t);r.push(l(e,s)),t-=s,e+=s}return Promise.all(r).then(g.uint8ArrayConcat)}return o.readWordsAsync(e,Math.ceil(t/4)).then(e=>e.length>t?e.slice(0,t):e)}function c(i){if("object"!=typeof i||!i)return Promise.resolve(i);if("number"!=typeof i.ptr)return Promise.resolve(i);{if(3&i.ptr)return Promise.resolve({unalignedPtr:i.ptr});let n=0;return l(i.ptr,56).then(t=>{n=m.read16(t,2);let e=t.length;return n==r.BuiltInType.BoxedString||n==r.BuiltInType.BoxedBuffer?e=m.read16(t,4)+6:n==r.BuiltInType.BoxedNumber&&(e=12),e>t.length?l(i.ptr+t.length,e-t.length).then(e=>g.uint8ArrayConcat([t,e])):e<t.length?t.slice(0,e):t}).then(e=>n==r.BuiltInType.BoxedString?g.uint8ArrayToString(e.slice(6)):n==r.BuiltInType.BoxedBuffer?{type:"buffer",data:e.slice(6)}:n==r.BuiltInType.BoxedNumber?new Float64Array(e.buffer.slice(4))[0]:{type:"unknown",tag:n,refcnt:m.read16(e,0),data:e.slice(4)})}}function y(n){var e=[];for(let t of Object.keys(n))e.push(c(n[t]).then(e=>{n[t]=e}));return Promise.all(e).then(()=>{})}function v(e){let t=d.breakpoints,n=t[0],i=1/0;for(var r of t){var s=e-r.binAddr;0<=s&&s<i&&(i=s,n=r)}return n}function u(t){if(i)return Promise.resolve();let h;return i=!0,A().then(i=>{var e=m.decodeU32LE(t)[0],r={};for(let n of d.procDebugInfo[0].locals){let e=i.globals,t=(()=>{switch(n.type){case"uint32":return m.read32(e,n.index);case"int32":return 0|m.read32(e,n.index);case"uint16":return m.read16(e,n.index);case"int16":return m.read16(e,n.index)<<16>>16;case"uint8":return e[n.index];case"int8":return e[n.index]<<24>>24;default:return null}})();null===t&&(g.assert(0==(3&n.index)),t=b(m.read32(e,n.index))),r[n.name]=t}return p=v(e),h={type:"debugger",subtype:"breakpoint",breakpointId:p.id,globals:r,stackframes:[]},n(),o.talkAsync(1888490768)}).then(e=>{{var s=m.decodeU32LE(e),a=h;let n=p.binAddr,i=0,r=d.procDebugInfo.filter(e=>e.codeStartLoc<=n&&n<=e.codeEndLoc)[0];for(;r&&r!=d.procDebugInfo[0];){var o,l=v(n),c=g.clone(l);c.functionName=r.name,c.argumentNames=r.args&&r.args.map(e=>e.name),a.stackframes.push({locals:{},funcInfo:c,breakpointId:l.id});let e=a.stackframes[a.stackframes.length-1],t=0;for(o of r.locals)g.assert(o.index==t++),e.locals[o.name]=b(s[i++]);n=2147483646&s[i++];var u,c=f[n+""];for(u of r.args)e.locals[u.name]=b(s[i+(r.args.length-1-u.index)]);if(!c)break;r=c.from,i+=c.stack-r.localsMark}}e=[h.globals].concat(h.stackframes.map(e=>e.locals));return g.promiseMapAll(e,y)}).then(()=>s.postMessage(h))}function h(){i=!1,e=new Promise((e,t)=>{n=e})}function w(e=!1){return Promise.resolve().then(()=>o.talkAsync(665147697,m.encodeU32LE([e?1:3]))).then(h)}function k(){return e=e||Promise.resolve()}function A(){return(t?Promise.resolve(t):o.talkAsync(1409050336).then(e=>t={numGlobals:T(e,0),globalsPtr:T(e,4)})).then(e=>o.readWordsAsync(e.globalsPtr,e.numGlobals)).then(e=>({staticState:t,globals:e}))}s.taggedUndefined=0,s.taggedNull=6,s.taggedFalse=10,s.taggedTrue=66,s.postMessage=e=>console.log(e),s.decodeValue=b,s.heapExpandAsync=c,s.heapExpandMapAsync=y,s.startDebugAsync=function(r,e){return(o=e).onEvent(915601917,u),i=!1,d=null,t=null,Promise.resolve().then(()=>{d=r,f={};var e,t,n=[];for(e of r.procDebugInfo)n[e.idx]=e;for(t of r.procDebugInfo)for(var i of t.calls)f[i.addr+""]={from:t,to:n[i.procIndex],stack:i.stack}}).then(()=>{var e=d.outfiles[pxtc.BINARY_UF2],e=g.stringToUint8Array(atob(e));return a=pxtc.UF2.toBin(e),o.reflashAsync(d).then(()=>o.reconnectAsync())}).then(()=>o.talkAsync(287358355).catch(e=>{})).then(()=>g.delay(200)).then(()=>o.reconnectAsync()).then(h).then(k)},s.handleMessage=function(t){if(console.log("HWDBGMSG",t),"debugger"==t.type){let e=!1;switch(t.subtype){case"stepinto":e=!0;case"stepover":w(e)}}},s.resumeAsync=w,s.waitForHaltAsync=k,s.getHwStateAsync=A}}(pxt=pxt||{}),function(f){f.ImageConverter=class{logTime(){var e;this.start&&(e=Date.now()-this.start,f.debug("Icon creation: "+e+"ms"))}convert(e){this.start||(this.start=Date.now());let t=atob(e.slice(e.indexOf(",")+1)),n=t.charCodeAt(0),i=t.charCodeAt(1),r=t.charCodeAt(2);if(135===n&&(n=224|t.charCodeAt(1),i=t.charCodeAt(2)|t.charCodeAt(3)<<8,r=t.charCodeAt(4)|t.charCodeAt(5)<<8,t=t.slice(4)),225!=n&&228!=n)return null;if(!this.palette){var s=f.appTarget.runtime.palette.map(function(e){e=parseInt(e.replace(/#/,""),16);return[e>>0&255,e>>8&255,e>>16&255,255]});s[0][3]=0,this.palette=new Uint8Array(4*s.length);for(let e=0;e<s.length;++e)this.palette[4*e+0]=s[e][0],this.palette[4*e+1]=s[e][1],this.palette[4*e+2]=s[e][2],this.palette[4*e+3]=s[e][3]}return 225==n?this.genMonochrome(t,i,r):(e=(f.BrowserUtils.isEdge()||f.BrowserUtils.isIE())&&i<100&&r<100?3:1,this.genColor(t,i,r,e))}genMonochrome(t,n,i){var r=n+3&-4,s=54+this.palette.length,e=s+r*i,a=new Uint8Array(e);a[0]=66,a[1]=77,f.HF2.write32(a,2,e),f.HF2.write32(a,10,s),f.HF2.write32(a,14,40),f.HF2.write32(a,18,n),f.HF2.write32(a,22,-i),f.HF2.write16(a,26,1),f.HF2.write16(a,28,8),f.HF2.write32(a,38,2835),f.HF2.write32(a,42,2835),f.HF2.write32(a,46,this.palette.length>>2),a.set(this.palette,54);let o=4,l=s,c=1,u=t.charCodeAt(o++);for(let e=0;e<n;++e){l=s+e;for(let e=0;e<i;++e)a[l]=u&c?1:0,l+=r,256==(c<<=1)&&(c=1,u=t.charCodeAt(o++))}return"data:image/bmp;base64,"+btoa(f.U.uint8ArrayToString(a))}genColor(s,e,a,o){var t=e*(o=Math.max(1,0|o)),l=a*o,c=t<<2,e=138+c*l,u=new Uint8Array(e);u[0]=66,u[1]=77,f.HF2.write32(u,2,e),f.HF2.write32(u,10,138),f.HF2.write32(u,14,124),f.HF2.write32(u,18,t),f.HF2.write32(u,22,-l),f.HF2.write16(u,26,1),f.HF2.write16(u,28,32),f.HF2.write16(u,30,3),f.HF2.write32(u,38,2835),f.HF2.write32(u,42,2835),f.HF2.write32(u,54,16711680),f.HF2.write32(u,58,65280),f.HF2.write32(u,62,255),f.HF2.write32(u,66,4278190080),u[70]=66,u[71]=71,u[72]=82,u[73]=115;let h=4,d=138,p=!0;for(let r=0;r<t;r++){let t=!1,e=(d=138+(r<<2),h),n=s.charCodeAt(h++),i=t?(n>>4&15)<<2:(15&n)<<2;for(let e=0;e<l;e++)n&&(p=!1),u[d]=this.palette[i],u[d+1]=this.palette[i+1],u[d+2]=this.palette[i+2],u[d+3]=this.palette[i+3],d+=c,e%o==o-1&&(t&&(n=s.charCodeAt(h++)),t=!t,i=t?(n>>4&15)<<2:(15&n)<<2);if(p&&(u[141]=1),r%o==o-1)for(a%2||--h;3&h;)h++;else h=e}return"data:image/bmp;base64,"+btoa(f.U.uint8ArrayToString(u))}}}(pxt=pxt||{}),function(s){function a(){const t={"tsconfig.json":i.TS_CONFIG,"test.ts":`// ${lf("tests go here; this will not be compiled when this package is used as an extension.")}
`,"_config.yml":"makecode:\n  target: @TARGET@\n  platform: @PLATFORM@\n  home_url: @HOMEURL@\ntheme: jekyll-theme-slate\ninclude:\n  - assets\n  - README.md\n",Makefile:"all: deploy\n\nbuild:\n\tpxt build\n\ndeploy:\n\tpxt deploy\n\ntest:\n\tpxt test\n",Gemfile:"source 'https://rubygems.org'\ngem 'github-pages', group: :jekyll_plugins","README.md":`
> ${lf("Open this page at {0}","[https://@REPOOWNER@.github.io/@REPONAME@/](https://@REPOOWNER@.github.io/@REPONAME@/)")}

## ${lf("Use as Extension")}

${lf("This repository can be added as an **extension** in MakeCode.")}

* ${lf("open [@HOMEURL@](@HOMEURL@)")}
* ${lf("click on **New Project**")}
* ${lf("click on **Extensions** under the gearwheel menu")}
* ${lf("search for **https://github.com/@REPO@** and import")}

## ${lf("Edit this project")} ![${lf("Build status badge")}](https://github.com/@REPO@/workflows/MakeCode/badge.svg)

${lf("To edit this repository in MakeCode.")}

* ${lf("open [@HOMEURL@](@HOMEURL@)")}
* ${lf("click on **Import** then click on **Import URL**")}
* ${lf("paste **https://github.com/@REPO@** and click import")}

## ${lf("Blocks preview")}

${lf("This image shows the blocks code from the last commit in master.")}
${lf("This image may take a few minutes to refresh.")}

![${lf("A rendered view of the blocks")}](https://github.com/@REPO@/raw/master/.github/makecode/blocks.png)

#### ${lf("Metadata (used for search, rendering)")}

* for PXT/@TARGET@
<script src="https://makecode.com/gh-pages-embed.js"></script><script>makeCodeRender("{{ site.makecode.home_url }}", "{{ site.github.owner_name }}/{{ site.github.repository_name }}");</script>
`,".gitignore":"# MakeCode\nbuilt\nnode_modules\nyotta_modules\nyotta_targets\npxt_modules\n_site\n*.db\n*.tgz\n.header.json\n.simstate.json\n",".vscode/settings.json":'{\n    "editor.formatOnType": true,\n    "files.autoSave": "afterDelay",\n    "files.watcherExclude": {\n        "**/.git/objects/**": true,\n        "**/built/**": true,\n        "**/node_modules/**": true,\n        "**/yotta_modules/**": true,\n        "**/yotta_targets": true,\n        "**/pxt_modules/**": true\n    },\n    "files.associations": {\n        "*.blocks": "html",\n        "*.jres": "json"\n    },\n    "search.exclude": {\n        "**/built": true,\n        "**/node_modules": true,\n        "**/yotta_modules": true,\n        "**/yotta_targets": true,\n        "**/pxt_modules": true\n    }\n}',".github/workflows/makecode.yml":"name: MakeCode\n\non: [push]\n\njobs:\n  build:\n\n    runs-on: ubuntu-latest\n\n    strategy:\n      matrix:\n        node-version: [14.x]\n\n    steps:\n      - uses: actions/checkout@v1\n      - name: Use Node.js ${{ matrix.node-version }}\n        uses: actions/setup-node@v1\n        with:\n          node-version: ${{ matrix.node-version }}\n      - name: npm install\n        run: |\n          npm install -g pxt\n          pxt target @TARGET@\n      - name: build\n        run: |\n          pxt install\n          pxt build --cloud\n        env:\n          CI: true\n",".github/workflows/cfg-check.yml":"name: Check pxt.json\n\non:\n  push:\n    branches:\n      - 'master'\n      - 'main'\n\njobs:\n  check-cfg:\n    runs-on: ubuntu-latest\n    strategy:\n      matrix:\n        node-version: [14.x]\n    steps:\n      - uses: actions/checkout@v2\n      - name: Use Node.js ${{ matrix.node-version }}\n        uses: actions/setup-node@v1\n        with:\n          node-version: ${{ matrix.node-version }}\n      - name: npm install\n        run: |\n          npm install -g pxt\n          pxt target @TARGET@\n      - name: Checkout current state\n        run: |\n          git checkout -- .\n          git clean -fd\n      - name: Fix files listed in config if necessary\n        run: pxt checkpkgcfg\n      - name: Create Pull Request\n        uses: peter-evans/create-pull-request@v3\n        continue-on-error: true\n        with:\n          title: 'Removing missing files from pxt.json'\n          commit-message: 'Removing missing files from pxt.json'\n          delete-branch: true\n",".vscode/tasks.json":'\n// A task runner that calls the MakeCode (PXT) compiler\n{\n    "version": "2.0.0",\n    "tasks": [{\n        "label": "pxt deploy",\n        "type": "shell",\n        "command": "pxt deploy --local",\n        "group": "build",\n        "problemMatcher": [ "$tsc" ]\n    }, {\n        "label": "pxt build",\n        "type": "shell",\n        "command": "pxt build --local",\n        "group": "build",\n        "problemMatcher": [ "$tsc" ]\n    }, {\n        "label": "pxt install",\n        "type": "shell",\n        "command": "pxt install",\n        "group": "build",\n        "problemMatcher": [ "$tsc" ]\n    }, {\n        "label": "pxt clean",\n        "type": "shell",\n        "command": "pxt clean",\n        "group": "test",\n        "problemMatcher": [ "$tsc" ]\n    }]\n}\n'},n=e();return n&&Object.keys(n).forEach(e=>t[e]=n[e]),t}function e(){var e=s.appTarget.bundledpkgs[s.template.TEMPLATE_PRJ];if(e)return delete(e=s.Util.clone(e))[s.CONFIG_NAME],e}var i;(i=s.template||(s.template={})).TS_CONFIG='{\n    "compilerOptions": {\n        "target": "ES5",\n        "noImplicitAny": true,\n        "outDir": "built",\n        "rootDir": "."\n    },\n    "exclude": ["pxt_modules/**/*test.ts"]\n}\n',i.defaultFiles=a,i.targetTemplateFiles=e,i.TEMPLATE_PRJ="template",i.packageFiles=function(e){var t=s.appTarget.blocksprj||s.appTarget.tsprj,n=s.U.clone(t.config),i=(delete n.installedVersion,delete n.additionalFilePath,delete n.additionalFilePaths,n.preferredEditor=n.files.find(e=>/\.blocks$/.test(e))?s.BLOCKS_PROJECT_NAME:s.JAVASCRIPT_PROJECT_NAME,n.name=e,n.public=!0,n.version||(n.version="0.0.0"),{}),r=a();for(const s in r)i[s]=r[s];for(const s in t.files)"README.md"!=s&&(i[s]=t.files[s]);e=Object.keys(i).filter(e=>/\.(blocks|md|ts|asm|cpp|h|py)$/.test(e));return n.files=e.filter(e=>!/test/.test(e)),n.testFiles=e.filter(e=>/test/.test(e)),n.supportedTargets=[s.appTarget.id],i[s.CONFIG_NAME]=s.Package.stringifyConfig(n),i},i.packageFilesFixup=function(n,e){const i=JSON.parse(n[s.CONFIG_NAME]);e&&s.Util.jsonMergeFrom(i,e),s.webConfig&&(Object.keys(s.webConfig).forEach(e=>i[e.toLowerCase()]=s.webConfig[e]),i.platform=s.appTarget.platformid||s.appTarget.id,i.target=s.appTarget.id,i.docs=s.appTarget.appTheme.homeUrl||"./",i.homeurl=s.appTarget.appTheme.homeUrl||"???"),s.U.iterMap(n,(e,t)=>{t=t.replace(/@([A-Z]+)@/g,(e,t)=>i[t.toLowerCase()]||""),n[e]=t})}}(pxt=pxt||{}),function(b){{var e=b.blocks||(b.blocks={}),t,n;let g,m;(t=g=e.NT||(e.NT={}))[t.Prefix=0]="Prefix",t[t.Postfix=1]="Postfix",t[t.Infix=2]="Infix",t[t.Block=3]="Block",t[t.NewLine=4]="NewLine",(t=m=e.GlueMode||(e.GlueMode={}))[t.None=0]="None",t[t.WithSpace=1]="WithSpace",t[t.NoSpace=2]="NoSpace";const k=["break","case","catch","class","const","continue","debugger","default","delete","do","else","enum","export","extends","false","finally","for","function","if","import","in","instanceof","new","null","return","super","switch","this","throw","true","try","typeof","var","void","while","with"];function i(e){return"`"+e.replace(/[\\`${}]/g,e=>"\\"+e)+"`"}function r(e){return 20<e.length&&/\n/.test(e)?i(e):JSON.stringify(e)}function s(e,t,n){return{type:e,op:t,children:n}}function a(){return s(g.NewLine,"",[])}function o(e,t){return s(g.Prefix,e,t)}function l(e,t,n){return s(g.Infix,t,null==e?[n]:[e,n])}function y(e){return o(e,[])}function c(e){return s(g.Block,"",e)}function v(e){return o("",e)}function u(e,t=!1){var n=[];for(const i of e)t?(0<n.length&&n.push(y(",")),n.push(a())):0<n.length&&n.push(y(", ")),n.push(i);return t&&n.push(a()),v(n)}function h(e,t,n=!1,i=!1){return v(i?[l(t[0],".",y(e)),y("("),u(t.slice(1),n),y(")")]:[y(e),y("("),u(t,n),y(")")])}function d(e,t,n,i){return h(e+"."+t,n,i)}function p(e,t){return b.U.assert(2==t.length),l(t[0],e,t[1])}e.backtickLit=i,e.stringLit=r,e.mkNode=s,e.mkNewLine=a,e.mkPrefix=o,e.mkPostfix=function(e,t){return s(g.Postfix,t,e)},e.mkInfix=l,e.mkText=y,e.mkBlock=c,e.mkGroup=v,e.mkStmt=function(...e){var t=e[e.length-1];return t&&t.type==g.Block||e.push(a()),v(e)},e.mkCommaSep=u,(n=t=e.Helpers||(e.Helpers={})).mkArrayLiteral=function(e,t){return v([y("["),u(e,t),y("]")])},n.mkNumberLiteral=function(e){return y(e.toString())},n.mkBooleanLiteral=function(e){return y(e?"true":"false")},n.mkStringLiteral=function(e){return y(r(e))},n.mkPropertyAccess=function(e,t){return v([l(t,".",y(e))])},n.mkCall=h,n.stdCall=function(e,t,n){return h(e,t,n)},n.extensionCall=function(e,t,n){return h(e,t,n,!0)},n.namespaceCall=d,n.mathCall=function(e,t){return d("Math",e,t,!1)},n.mkGlobalRef=y,n.mkSimpleCall=p,n.mkWhile=function(e,t){return v([y("while ("),e,y(")"),c(t)])},n.mkComment=function(e){return y("// "+e)},n.mkMultiComment=function(e){let i=[y("/**"),a()];return e.split("\n").forEach((e,t,n)=>{e&&(i.push(y(" * "+e)),i.push(a()),t<n.length-1)&&(i.push(y(" * ")),i.push(a()))}),v(i.concat([y(" */"),a()]))},n.mkAssign=function(e,t){return p("=",[e,t])},n.mkParenthesizedExpression=function(e){return w(f([e]).output)?e:v([y("("),e,y(")")])},e.H=t;const A={"=":3,"+=":3,"-=":3,"?":4,":":4,"||":5,"&&":6,"|":7,"^":8,"&":9,"==":10,"!=":10,"===":10,"!==":10,"<":11,">":11,"<=":11,">=":11,">>":12,">>>":12,"<<":12,"+":13,"-":13,"*":14,"/":14,"%":14,"**":15,"!":16,"~":16,"P-":16,"P+":16,"++":16,"--":16,".":18};function f(e){let a=[],o={},l="",c="",u=[{}],h=0;function d(e){"string"==typeof e&&(h+=(e.match(/\n/g)||[]).length),l+=e}e=v(e);return function e(n,i){if(n.type!=g.Infix)for(var t of n.children)e(t,-1);else{let t=[];var r,s=b.U.lookup(A,n.op);function a(e){"P"==e[0]&&(e=e.slice(1)),t.push(y(e))}null==s&&b.U.oops("bad infix op: "+n.op),s<i&&a("("),1==n.children.length?(a(n.op),e(n.children[0],s),t.push(n.children[0])):(r=3!=s&&"**"!=n.op,e(n.children[0],r?s:s+.1),t.push(n.children[0]),"."==n.op?a("."):a(" "+n.op+" "),e(n.children[1],r?s+.1:s),t.push(n.children[1])),s<i&&a(")"),n.type=g.Prefix,n.op="",n.children=t}}(e,-1),function r(e){e.glueToBlock&&(f(),e.glueToBlock==m.WithSpace)&&d(" ");let t=h,n=l.length;switch(e.type){case g.Infix:b.U.oops("no infix should be left");break;case g.NewLine:d("\n"+c);break;case g.Block:!function(e){let t=e.noFinalNewline?"":"\n";if(0==e.children.length)return p(" {\n\t\n}"+t);let n=b.U.clone(u[u.length-1]||{});u.push(n),c+="    "," "!=l[l.length-1]&&p(" "),p("{\n");for(var i of e.children)r(i);c=c.slice(4),f(),p("\n}"+t),u.pop()}(e);break;case g.Prefix:e.canIndentInside?d(e.op.replace(/\n/g,"\n"+c+"    ")):d(e.op),e.children.forEach(r);break;case g.Postfix:e.children.forEach(r),e.canIndentInside?d(e.op.replace(/\n/g,"\n"+c+"    ")):d(e.op)}let i=h,s=Math.max(l.length,1);if(e.id)if(o[e.id]){const b=o[e.id];b.startLine=Math.min(b.startLine,t),b.endLine=Math.max(b.endLine,i),b.startPos=Math.min(b.startPos,n),b.endPos=Math.max(b.endPos,s)}else{const b={id:e.id,startLine:t,startPos:n,endLine:i,endPos:s};o[e.id]=b,a.push(b)}}(e),l||d("\n"),{output:l,sourceMap:a};function p(e){d(e.replace(/\n/g,"\n"+c))}function f(){l=l.replace(/\n *$/,function(){return h--,""})}}function w(n){if("("===n[0]&&")"===n[n.length-1]){let t=1;for(let e=1;e<n.length;e++){var i=n[e];if("("===i)t++;else if(")"===i&&0===--t)return e===n.length-1}}return!1}e.flattenNode=f,e.isReservedWord=function(e){return-1!==k.indexOf(e)},e.isParenthesized=w}}(pxt=pxt||{}),function(c){{var a=c.sprite||(c.sprite={});const k=[".","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f"];a.BLOCKLY_TILESET_TYPE="BLOCKLY_TILESET_TYPE",a.TILE_PREFIX="tile",a.TILE_NAMESPACE="myTiles",a.IMAGES_NAMESPACE="myImages",a.IMAGE_PREFIX="image",a.ANIMATION_NAMESPACE="myAnimations",a.ANIMATION_PREFIX="anim";class A{constructor(e,t,n=0,i=0,r){this.width=e,this.height=t,this.x0=n,this.y0=i,this.width||(this.width=16),this.height||(this.height=16),this.buf=r||new Uint8ClampedArray(this.dataLength())}static fromData(e){return new A(e.width,e.height,e.x0,e.y0,e.data)}set(e,t,n){e<this.width&&t<this.height&&0<=e&&0<=t&&(e=this.coordToIndex(e,t),this.setCore(e,n))}get(e,t){return e<this.width&&t<this.height&&0<=e&&0<=t?(e=this.coordToIndex(e,t),this.getCore(e)):0}copy(n=0,i=0,e=this.width,r=this.height){var s=new A(e,r);s.x0=n,s.y0=i;for(let t=0;t<e;t++)for(let e=0;e<r;e++)s.set(t,e,this.get(n+t,i+e));return s}apply(n,i=!1){var r;for(let t=0;t<n.width;t++)for(let e=0;e<n.height;e++)!(r=n.get(t,e))&&i||this.set(n.x0+t,n.y0+e,r)}equals(t){if(this.width!==t.width||this.height!==t.height||this.x0!==t.x0||this.y0!==t.y0||this.buf.length!==t.buf.length)return!1;for(let e=0;e<this.buf.length;e++)if(this.buf[e]!==t.buf[e])return!1;return!0}data(){return{width:this.width,height:this.height,x0:this.x0,y0:this.y0,data:this.buf}}resize(e,t){return s(this,e,t)}coordToIndex(e,t){return e+t*this.width}getCore(e){var t=Math.floor(e/2);return e%2==0?15&this.buf[t]:(240&this.buf[t])>>4}setCore(e,t){var n=Math.floor(e/2);this.buf[n]=e%2==0?240&this.buf[n]|15&t:15&this.buf[n]|(15&t)<<4}dataLength(){return Math.ceil(this.width*this.height/2)}}a.Bitmap=A;class T extends A{static fromData(e){return new T(e.width,e.height,e.x0,e.y0,e.data)}copy(n=0,i=0,e=this.width,r=this.height){var s=new T(e,r);s.x0=n,s.y0=i;for(let t=0;t<e;t++)for(let e=0;e<r;e++)s.set(t,e,this.get(n+t,i+e));return s}resize(e,t){return u(this,e,t)}getCore(e){return this.buf[e]}setCore(e,t){this.buf[e]=t}dataLength(){return this.width*this.height}}a.Tilemap=T;class x{constructor(e,t,n){this.tilemap=e,this.tileset=t,this.layers=n,this.nextId=0}cloneData(){var e=this.tilemap.copy(),t={tileWidth:this.tileset.tileWidth,tiles:this.tileset.tiles.map(e=>Object.assign(Object.assign({},e),{bitmap:A.fromData(e.bitmap).copy().data()}))},n=A.fromData(this.layers).copy().data();return new x(e,t,n)}equals(t){if(!this.tilemap.equals(t.tilemap)||this.tileset.tileWidth!=t.tileset.tileWidth||this.tileset.tiles.length!=t.tileset.tiles.length||!e(this.layers,t.layers))return!1;for(let e=0;e<this.tileset.tiles.length;e++)if(!c.assetEquals(this.tileset.tiles[e],t.tileset.tiles[e]))return!1;return!0}}function n(e){return t(atob(e.slice(e.indexOf(",")+1)))}function t(r){let e=r.charCodeAt(0),s=r.charCodeAt(1),a=r.charCodeAt(2);135===e&&(e=224|r.charCodeAt(1),s=r.charCodeAt(2)|r.charCodeAt(3)<<8,a=r.charCodeAt(4)|r.charCodeAt(5)<<8,r=r.slice(4));var o=new c.sprite.Bitmap(s,a);let l=4;if(225===e){let n=1,i=r.charCodeAt(l++);for(let t=0;t<s;++t)for(let e=0;e<a;++e)o.set(t,e,i&n?1:0),256==(n<<=1)&&(n=1,i=r.charCodeAt(l++))}else for(let t=0;t<s;t++){for(let e=0;e<a;e+=2){var n=r.charCodeAt(l++);o.set(t,e,15&n),e!=a-1&&o.set(t,e+1,n>>4&15)}for(;3&l;)l++}return o}function o(e,t){!(e=(e=(e=e.replace(/[ `]|(?:&#96;)|(?:&#9;)|(?:hex)/g,"").trim()).replace(/^["`\(\)]*/,"").replace(/["`\(\)]*$/,"")).replace(/&#10;/g,"\n"))&&t&&(e=t);var t=parseInt(e.substr(0,2),16)|parseInt(e.substr(2,2),16)<<8,n=parseInt(e.substr(4,2),16)|parseInt(e.substr(6,2),16)<<8,e=b(e.substring(8));return T.fromData({width:t,height:n,x0:0,y0:0,data:e})}function i(e){return""+r(e.width,2)+r(e.height,2)+y(e.data().data)}function l(e,i){return(e=e.replace(/[\[\]]/g,""))?e.split(",").filter(e=>!!e.trim()).map(e=>{var t=e,n=i;if(0===(t=t.trim()).indexOf("img"))return e=h(t),n.createNewTile(e.data());switch(t){case"myTiles.tile0":case"myTiles.transparency16":return n.getTransparency(16);case"myTiles.transparency8":return n.getTransparency(8);case"myTiles.transparency32":return n.getTransparency(32);default:return n.resolveTile(t)}}):[]}function r(e,t){let n=e.toString(16);var i=t<<1;for(1&n.length&&(n="0"+n);n.length<i;)n+="0";return n}function s(e,t,n){t=new A(t,n);return t.apply(e),t}function u(e,t,n){t=new T(t,n);return t.apply(e),t}function h(e){const n=(e=(e=(e=e.replace(/[ `]|(?:&#96;)|(?:&#9;)|(?:img)/g,"").trim()).replace(/^["`\(\)]*/,"").replace(/["`\(\)]*$/,"")).replace(/&#10;/g,"\n")).split("\n"),i=[];let r=0;for(let e=0;e<n.length;e++){const A=n[e],s=[];for(let e=0;e<A.length;e++)switch(A[e]){case"0":case".":s.push(0);break;case"1":case"#":s.push(1);break;case"2":case"T":s.push(2);break;case"3":case"t":s.push(3);break;case"4":case"N":s.push(4);break;case"5":case"n":s.push(5);break;case"6":case"G":s.push(6);break;case"7":case"g":s.push(7);break;case"8":s.push(8);break;case"9":s.push(9);break;case"a":case"A":case"R":s.push(10);break;case"b":case"B":case"P":s.push(11);break;case"c":case"C":case"p":s.push(12);break;case"d":case"D":case"O":s.push(13);break;case"e":case"E":case"Y":s.push(14);break;case"f":case"F":case"W":s.push(15);break;default:if(!/\s/.test(A[e]))return}s.length&&(i.push(s),r=Math.max(r,s.length))}const s=i.length,a=new A(r,s);for(let t=0;t<s;t++){const n=i[t];for(let e=0;e<r;e++)e<n.length?a.set(e,t,n[e]):a.set(e,t,0)}return a}function d(e){let t="";return t="python"===e?'img("""':"img`"}function p(e){let t="";return t+="python"===e?'""")':"`"}function f(n,i){if(!n||0===n.height||0===n.width)return"";let r=d(i);if(n){const i=300<n.width*n.height?"":" ";for(let t=0;t<n.height;t++){r+="\n";for(let e=0;e<n.width;e++)r+=k[n.get(e,t)]+i}}return r=(r+="\n")+p(i)}function e(e,t){return c.sprite.Bitmap.fromData(e).equals(c.sprite.Bitmap.fromData(t))}function g(e){switch(e){case 8:return"TileScale.Eight";case 16:return"TileScale.Sixteen";case 32:return"TileScale.ThirtyTwo";default:return Math.floor(Math.log2(e)).toString()}}function m(e){switch(e=e.replace(/\s/g,"")){case"TileScale.Eight":return 8;case"TileScale.Sixteen":return 16;case"TileScale.ThirtyTwo":return 32;default:return Math.pow(2,parseInt(e))}}function b(t){var n=new Uint8ClampedArray(t.length>>1);for(let e=0;e<t.length;e+=2)n[e>>1]=parseInt(t.slice(e,e+2),16);return n}function y(t){var n="0123456789abcdef";let i="";for(let e=0;e<t.length;++e)i=(i+=n[t[e]>>4])+n[15&t[e]];return i}function v(e,t,n){e[t]=255&n,e[t+1]=n>>8&255}function w(e){e=function(e){if(e){if(6===e.length)return parseInt("0x"+e);if(7===e.length)return parseInt("0x"+e.substr(1))}return 0}(e);return[e>>16&255,e>>8&255,255&e]}a.TilemapData=x,a.Bitmask=class{constructor(e,t){this.width=e,this.height=t,this.mask=new Uint8Array(Math.ceil(e*t/8))}set(e,t){e+=this.width*t;this.mask[e>>3]|=1<<(7&e)}get(e,t){e+=this.width*t;return this.mask[e>>3]>>(7&e)&1}},a.encodeTilemap=function(e,t){return e?`tiles.createTilemap(${n=e.tilemap,n?`hex\`${i(n)}\``:"hex``"}, ${f(A.fromData(e.layers),t)}, [${e.tileset.tiles.map(e=>e.id)}], ${g(e.tileset.tileWidth)})`:"null";var n},a.decodeTilemap=function(e,t,n){var i,r,s;return(e=c.Util.htmlUnescape(e).trim()).trim()?(i=(e=(e=e.substr(e.indexOf("(")+1)).substr(0,e.lastIndexOf(")"))).substr(0,e.indexOf(",")),r=(e=e.substr(i.length+1)).substr(0,e.indexOf(",")),s=(e=e.substr(r.length+1)).substr(0,e.lastIndexOf("]")+1),e=e=e.substr(s.length+1),new x(o(i),{tiles:l(s,n),tileWidth:m(e)},h(r).data())):null},a.trimTilemapTileset=function(e){const n=e.tileset.tiles.slice(),i=e.tilemap,r={};r[n[0].id]=!0;for(let t=0;t<i.width;t++)for(let e=0;e<i.height;e++)r[n[i.get(t,e)].id]=!0;const t=e.editedTiles||[],s=n.filter(e=>r[e.id]||"*"===e.id.charAt(0)||-1!==t.indexOf(e.id));if(s.length!==n.length){var a=[];for(let e=0;e<n.length;e++)a.push(s.indexOf(n[e]));for(let t=0;t<i.width;t++)for(let e=0;e<i.height;e++)i.set(t,e,a[i.get(t,e)]);e.tileset.tiles=s}},a.isEmptyTilemap=function(e){var n=e.tileset.tiles,i=e.tilemap,r=n[0].id;for(let t=0;t<i.width;t++)for(let e=0;e<i.height;e++)if(n[i.get(t,e)].id!==r)return!1;return!0},a.computeAverageColor=function(n,e){var i=e.map(w),r=[0,0,0];let s=0;for(let t=0;t<n.width;t++)for(let e=0;e<n.height;e++){var a=n.get(t,e);if(a){++s;const n=i[a];r[0]+=n[0],r[1]+=n[1],r[2]+=n[2]}}return s?"#"+function(t){let n="";for(let e=0;e<t.length;++e)n+=("0"+t[e].toString(16)).slice(-2);return n}(r.map(e=>Math.floor(e/s))):"#00000000"},a.getBitmap=function(e,t){e=e.apis.byQName[t];return e?n(e.attributes.jresURL):null},a.getBitmapFromJResURL=n,a.hexToBitmap=t,a.filterItems=function(e,t){const r=(t=t.filter(e=>!!e).map(e=>e.toLowerCase())).filter(e=>0!==e.indexOf("!")),s=t.filter(e=>0===e.indexOf("!")&&1<e.length).map(e=>e.substring(1));return e.filter(e=>{return i=e,r.every(t=>{const n="?"+t;return i.tags.some(e=>e===t||e===n)})&&(n=e,s.every(t=>!n.tags.some(e=>e===t)));var n,i})},a.getGalleryItems=function(e,t){i=e.apis,r=t;let n=c.Util.values(i.byQName).filter(e=>{return 4===e.kind&&e.attributes.fixedInstance&&((e=e.retType)==r||!(!(e=i.byQName[e])||!e.extendsTypes)&&0<=e.extendsTypes.indexOf(r))});var i,r;n=n.filter(e=>e.namespace!=a.TILE_NAMESPACE);{e=n;const s=new c.ImageConverter;e.forEach(e=>{e.attributes.jresURL&&!e.attributes.iconURL&&0==e.attributes.jresURL.indexOf("data:image/x-mkcd-f")&&(e.attributes.iconURL=s.convert(e.attributes.jresURL))})}return n.map(e=>{var t=(e.attributes.tags||"").split(" ").filter(e=>!!e).map(e=>c.Util.startsWith(e,"category-")?e:e.toLowerCase());return{qName:e.qName,src:e.attributes.iconURL,alt:e.qName,tags:t}})},a.base64EncodeBitmap=function(e){const n=A.fromData(e),t=pxtc.f4EncodeImg(e.width,e.height,4,(e,t)=>n.get(e,t));return btoa(c.U.uint8ArrayToString(b(t)))},a.tilemapLiteralToTilemap=o,a.hexEncodeTilemap=i,a.formatByte=r,a.resizeBitmap=s,a.resizeTilemap=u,a.imageLiteralToBitmap=h,a.encodeAnimationString=function(e,t){const n=e.map(e=>e.data),i=new Uint8ClampedArray(8+n[0].length*n.length);v(i,0,t),v(i,2,e[0].width),v(i,4,e[0].height),v(i,6,e.length);let r=8;return n.forEach(e=>{i.set(e,r),r+=e.length}),btoa(c.sprite.uint8ArrayToHex(i))},a.addMissingTilemapTilesAndReferences=function(e,t){var n=e.getProjectTiles(t.data.tileset.tileWidth,!0);t.data.projectReferences=[];for(const i of n.tiles)t.data.tileset.tiles.some(e=>e.id===i.id)||t.data.tileset.tiles.push(i),e.isAssetUsed(i,null,[t.id])&&t.data.projectReferences.push(i.id)},a.updateTilemapReferencesFromResult=function(t,n){var i=n.data;if(i.deletedTiles)for(const c of i.deletedTiles)t.deleteTile(c);if(i.editedTiles)for(const c of i.editedTiles){const n=i.tileset.tiles.findIndex(e=>e.id===c),e=i.tileset.tiles[n];e&&(i.tileset.tiles[n]=t.updateTile(e))}for(let e=0;e<i.tileset.tiles.length;e++){const n=i.tileset.tiles[e];n.jresData||(i.tileset.tiles[e]=t.resolveTile(n.id))}c.sprite.trimTilemapTileset(i)},a.imageLiteralFromDimensions=function(t,n,i,e){let r=d(e);var s=300<t*n?"":" ";for(let e=0;e<n;e++){r+="\n";for(let e=0;e<t;e++)r+=k[i]+s}return r=(r+="\n")+p(e)},a.bitmapToImageLiteral=f,a.bitmapEquals=e,a.tileWidthToTileScale=g,a.tileScaleToTileWidth=m,a.hexToUint8Array=b,a.uint8ArrayToHex=y,a.colorStringToRGB=w}}(pxt=pxt||{}),function(s){var a=s.sprite||(s.sprite={});{var e=a.legacy||(a.legacy={});const n=new RegExp(`^\\s*${a.TILE_NAMESPACE}\\s*\\.\\s*${a.TILE_PREFIX}(\\d+)\\s*$`);class l{constructor(e,t,n){this.tilemap=e,this.tileset=t,this.layers=n,this.nextId=0}}function o(e){return(e=e.replace(/[\[\]]/g,""))?e.split(",").filter(e=>!!e.trim()).map(e=>{return 0===(e=(e=e).trim()).indexOf("img")?{data:a.imageLiteralToBitmap(e).data()}:(t=n.exec(e))?{data:null,projectId:Number(t[1])}:{data:null,qualifiedName:e};var t}):[]}e.LegacyTilemapData=l,e.decodeTilemap=function(e,t){var n,i,r;return null!=(e=null==(n=s.Util.htmlUnescape(e))?void 0:n.trim())&&e.trim()?(n=(e=(e=e.substr(e.indexOf("(")+1)).substr(0,e.lastIndexOf(")"))).substr(0,e.indexOf(",")),i=(e=e.substr(n.length+1)).substr(0,e.indexOf(",")),r=(e=e.substr(i.length+1)).substr(0,e.lastIndexOf("]")+1),e=e=e.substr(r.length+1),new l(a.tilemapLiteralToTilemap(n),{tiles:o(r),tileWidth:a.tileScaleToTileWidth(e)},a.imageLiteralToBitmap(i).data())):new l(new a.Tilemap(16,16),{tileWidth:16,tiles:[]},new a.Bitmap(16,16).data())},e.tileToBlocklyVariable=function(e){return`${e.projectId};${e.data.width};${e.data.height};`+pxtc.Util.toHex(e.data.data)},e.blocklyVariableToTile=function(e){e=e.split(";");return 4!==e.length?null:{projectId:parseInt(e[0]),data:{width:parseInt(e[1]),height:parseInt(e[2]),data:new Uint8ClampedArray(pxtc.Util.fromHex(e[3])),x0:0,y0:0}}}}}(pxt=pxt||{}),function(i){{var e=i.storage||(i.storage={});class a{constructor(){this.items={}}removeItem(e){delete this.items[e]}getItem(e){return this.items[e]}setItem(e,t){this.items[e]=t}clear(){this.items={}}}class o{constructor(e){this.storageId=e}targetKey(e){return this.storageId+"/"+e}removeItem(e){window.localStorage.removeItem(this.targetKey(e))}getItem(e){return window.localStorage[this.targetKey(e)]}setItem(e,t){window.localStorage[this.targetKey(e)]=t}clear(){var t=this.targetKey(""),n=[];for(let e=0;e<window.localStorage.length;++e){var i=window.localStorage.key(e);0==i.indexOf(t)&&n.push(i)}n.forEach(e=>window.localStorage.removeItem(e))}}function r(){var e;return i.appTarget?i.appTarget.id:(e=window.pxtConfig)?e.targetId:(e=window.pxtTargetBundle)?e.id:""}let n;function s(){if(!n){var t=r();let e=!1;if(!i.shell.isSandboxMode())try{window.localStorage[t]="1",window.localStorage[t],e=!0}catch(e){}e?(n=new o(t),i.debug("storage: local under "+t)):(n=new a,i.debug("storage: in memory"))}}e.storageId=r,e.setLocal=function(e,t){s(),n.setItem(e,t)},e.getLocal=function(e){return s(),n.getItem(e)},e.removeLocal=function(e){s(),n.removeItem(e)},e.clearLocal=function(){s(),n.clear()}}}(pxt=pxt||{}),function(s){var e=s.storage||(s.storage={});{e=e.shared||(e.shared={});const l="http://localhost:3232/api/store/";function a(){return s.BrowserUtils.isLocalHostDev()&&!s.BrowserUtils.noSharedLocalStorage()}function o(){return s.BrowserUtils.isChromiumEdge()?"chromium-edge":s.BrowserUtils.browser()}e.getAsync=async function(e,t){if(a()){e+="-"+o();const a=await s.Util.requestAsync({url:""+l+encodeURIComponent(e)+"/"+encodeURIComponent(t),method:"GET",allowHttpErrors:!0});return a.json||a.text||void 0}{const l=s.storage.getLocal(e+":"+t),a=s.Util.jsonTryParse(l);return a||l}},e.setAsync=async function(e,t,n){if(void 0===n)await s.storage.shared.delAsync(e,t);else{var i="object"==typeof n?JSON.stringify(n):n.toString();if(a()){e+="-"+o();const a={type:"object"==typeof n?"json":"text",val:i},r=JSON.stringify(a);await s.Util.requestAsync({url:""+l+encodeURIComponent(e)+"/"+encodeURIComponent(t),method:"POST",data:r})}else s.storage.setLocal(e+":"+t,i)}},e.delAsync=async function(e,t){a()?(e+="-"+o(),await s.Util.requestAsync({url:""+l+encodeURIComponent(e)+"/"+encodeURIComponent(t),method:"DELETE",allowHttpErrors:!0})):s.storage.removeLocal(e+":"+t)}}}(pxt=pxt||{}),function(u){const i=["name","version","description","license","dependencies","files","testFiles","testDependencies","fileDependencies","public","targetVersions","supportedTargets","preferredEditor","languageRestriction","additionalFilePath","additionalFilePaths"];class h{constructor(e,t,n,i){this.id=e,this._verspec=t,this.parent=n,this.level=-1,this.isLoaded=!1,this.ignoreTests=!1,this.cppOnly=!1,i&&(this.level=i.level+1),this.addedBy=[i]}static stringifyConfig(e){var t=e,n={};for(const e of i)t.hasOwnProperty(e)&&(n[e]=t[e]);for(const e of Object.keys(t))n.hasOwnProperty(e)||(n[e]=t[e]);return JSON.stringify(n,null,4)+"\n"}static parseAndValidConfig(e){const t=u.Util.jsonTryParse(e);return t&&void 0!==t.name&&"string"==typeof t.name&&t.files&&Array.isArray(t.files)&&t.files.every(e=>"string"==typeof e)&&t.dependencies&&Object.keys(t.dependencies).every(e=>"string"==typeof t.dependencies[e])&&t}static getConfigAsync(t,n,i){return Promise.resolve().then(()=>{if(u.github.isGithubId(i)){const t=u.github.parseRepoId(i);return u.packagesConfigAsync().then(e=>u.github.repoAsync(t.fullName,e)).then(e=>e?u.github.pkgConfigAsync(t.fullName,t.tag):null)}var e=u.patching.upgradePackageReference(t,n,i),e=u.appTarget.bundledpkgs[e];return JSON.parse(e[u.CONFIG_NAME])})}static corePackages(){const t=u.appTarget.bundledpkgs;return Object.keys(t).map(e=>JSON.parse(t[e][u.CONFIG_NAME])).filter(e=>!!e)}disablesVariant(e){return this.config&&this.config.disablesVariants&&0<=this.config.disablesVariants.indexOf(e)}invalid(){return/^invalid:/.test(this.version())}version(){return this.resolvedVersion||this._verspec}verProtocol(){var e=this.version().split(":");return 1<e.length?e[0]:""}verArgument(){var e=this.verProtocol();return e?this.version().slice(e.length+1):this.version()}targetVersion(){return this.parent&&this.parent!=this?this.parent.targetVersion():this.config.targetVersions?this.config.targetVersions.target:void 0}commonDownloadAsync(){const e=this.verProtocol();if("pub"==e)return u.Cloud.downloadScriptFilesAsync(this.verArgument());if("github"==e)return u.packagesConfigAsync().then(e=>u.github.downloadPackageAsync(this.verArgument(),e)).then(e=>e.files);if("embed"==e){const e=u.getEmbeddedScript(this.verArgument());return Promise.resolve(e)}if("pkg"!=e)return Promise.resolve(null);{const e=(this.parent||this).readFile(this.verArgument()),t=ts.pxtc.Util.jsonTryParse(e);return t||u.log("unable to find "+this.verArgument()),Promise.resolve(t)}}host(){return this.parent._host}readFile(e){return this.host().readFile(this,e)}readGitJson(){var e=this.readFile(u.github.GIT_JSON);return u.Util.jsonTryParse(e)}resolveDep(e){return this.parent.deps.hasOwnProperty(e)?this.parent.deps[e]:null}saveConfig(){var e=u.U.clone(this.config),e=(delete e.additionalFilePaths,u.Package.stringifyConfig(e));this.host().writeFile(this,u.CONFIG_NAME,e)}setPreferredEditor(e){this.config.preferredEditor!=e&&(this.config.preferredEditor=e,this.saveConfig())}getPreferredEditor(){let e=this.config.preferredEditor;if(e)return e;{if(!(0<=this.getFiles().indexOf(u.MAIN_BLOCKS)))return u.JAVASCRIPT_PROJECT_NAME;const e=this.readFile(u.MAIN_BLOCKS),t=this.readFile(u.MAIN_TS);return!e&&t?u.JAVASCRIPT_PROJECT_NAME:u.BLOCKS_PROJECT_NAME}}parseJRes(e={}){for(const t of this.getFiles())u.U.endsWith(t,".jres")&&n(JSON.parse(this.readFile(t)),e);return e}resolveVersionAsync(){var e;let t=this._verspec;if(u.getEmbeddedScript(this.id))this.resolvedVersion=t="embed:"+this.id;else if(t&&"*"!=t){if("github"==this.verProtocol()){const n=u.github.parseRepoId(this._verspec);n&&!n.tag&&this.parent&&(u.debug("dep: unbound github extensions, trying to resolve tag"),e=u.semver.sortLatestTags(u.Util.values((null==(e=this.parent)?void 0:e.deps)||{}).map(e=>u.github.parseRepoId(e.version())).filter(e=>(null==e?void 0:e.slug)===n.slug).map(e=>e.tag))[0])&&(n.tag=e,this.resolvedVersion=t=u.github.stringifyRepo(n),u.debug(`dep: github patched ${this._verspec} to `+t))}}else this.configureAsInvalidPackage(lf("version not specified for {0}",this.id)),t=this._verspec;return Promise.resolve(t)}downloadAsync(){return this.resolveVersionAsync().then(e=>{if(this.invalid())u.debug("skip download of invalid package "+this.id);else if(/^embed:/.test(e)||this.installedVersion!=e)return u.debug("downloading "+e),this.host().downloadPackageAsync(this).then(()=>{this.loadConfig(),u.debug(`installed ${this.id} /`+e)})})}loadConfig(){var e;0!=this.level&&this.invalid()||((e=this.readFile(u.CONFIG_NAME))||u.U.userError(`extension ${this.id} is missing `+u.CONFIG_NAME),this.parseConfig(e),0!=this.level&&(this.installedVersion=this.version()),this.saveConfig())}validateConfig(){this.config.dependencies||u.U.userError("Missing dependencies in config of: "+this.id),Array.isArray(this.config.files)||u.U.userError("Missing files in config of: "+this.id),"string"==typeof this.config.name&&this.config.name||(this.config.name=lf("Untitled")),this.config.targetVersions&&this.config.targetVersions.target&&this.config.targetVersions.targetId===u.appTarget.id&&u.appTarget.versions&&0<u.semver.majorCmp(this.config.targetVersions.target,u.appTarget.versions.target)&&u.U.userError(lf("{0} requires target version {1} (you are running {2})",this.config.name,this.config.targetVersions.target,u.appTarget.versions.target))}isPackageInUse(n,e=this.readFile(u.MAIN_TS)){let i=null;var t=u.patching.computePatches(this.targetVersion(),"missingPackage");return t&&t.forEach(t=>{Object.keys(t.map).forEach(e=>{t.map[e]===n&&(i=new RegExp(e,"g"))})}),(i=i||new RegExp(n+"\\.","g")).test(e)}upgradePackagesAsync(){return this.config||this.loadConfig(),u.packagesConfigAsync().then(i=>{let r=0,s={};return u.U.iterMap(this.config.dependencies,(e,t)=>{var n;u.github.isGithubId(t)&&(n=u.github.upgradedPackageReference(i,t))&&n!=t&&(u.log(`upgrading dep ${e}: ${t} -> `+n),s[t]=n,this.config.dependencies[e]=n,r++)}),r&&this.saveConfig(),r&&s})}getMissingPackages(r,s){const e=u.patching.computePatches(this.targetVersion(),"missingPackage"),a={};return s&&e&&e.forEach(i=>{Object.keys(i.map).forEach(e=>{const t=new RegExp(e,"g"),n=i.map[e];s.replace(t,e=>(r.dependencies[n]||(a[n]="*"),""))})}),a}findConflictsAsync(e,o){let l,c=[];return Promise.resolve().then(()=>"string"==typeof e?h.getConfigAsync(this.targetVersion(),e,o):Promise.resolve(e)).then(a=>{if(l=a){const a=l.yotta?u.U.jsonFlatten(l.yotta.config):null;this.parent.sortedDeps().forEach(t=>{if(l.core&&t.config.core&&l.name!=t.config.name){const a=new u.cpp.PkgConflictError(lf("conflict between core extensions {0} and {1}",l.name,t.id));a.pkg0=t,void c.push(a)}else{let e=!1;if(a){const o=t.config||JSON.parse(t.readFile(u.CONFIG_NAME));if(o&&o.yotta&&t.config.yotta.config){var n=u.U.jsonFlatten(o.yotta.config);for(const s of Object.keys(a)){var i=n[s],r=l.yotta.configIsJustDefaults||o.yotta.configIsJustDefaults;if(n.hasOwnProperty(s)&&i!==a[s]&&!r&&(!t.parent.config.yotta||!t.parent.config.yotta.ignoreConflicts)){const a=new u.cpp.PkgConflictError(lf("conflict on yotta setting {0} between extensions {1} and {2}",s,l.name,t.id));a.pkg0=t,a.settingName=s,c.push(a),e=!0}}}}if(!e&&l.name===t.id&&t._verspec!==o&&!/^file:/.test(t._verspec)&&!/^file:/.test(o)){const a=/^github:/.test(t._verspec)&&u.github.parseRepoId(t._verspec),l=/^github:/.test(o)&&u.github.parseRepoId(o);if(!a||!l||a.fullName!==l.fullName||l.tag&&u.semver.strcmp(a.tag,l.tag)<0){const a=new u.cpp.PkgConflictError(lf("version mismatch for extension {0} (installed: {1}, installing: {2})",t.id,t._verspec,o));a.pkg0=t,a.isVersionConflict=!0,c.push(a)}}}})}return Object.keys(l.dependencies).reduce((e,t)=>e.then(()=>this.findConflictsAsync(t,l.dependencies[t])).then(e=>c.push.apply(c,e)),Promise.resolve())}).then(()=>{const i=e=>{const t=[];return e.addedBy.forEach(e=>{e.id!==this.id&&(t.push.apply(i(e)),t.push(e))}),t},e=[];return c.forEach(n=>{e.push.apply(e,i(n.pkg0).map(e=>{var t=new u.cpp.PkgConflictError(n.isVersionConflict?lf("a dependency of {0} has a version mismatch with extension {1} (installed: {1}, installing: {2})",e.id,l.name,n.pkg0._verspec,o):lf("conflict on yotta setting {0} between extensions {1} and {2}",n.settingName,l.name,n.pkg0.id));return t.pkg0=e,t}))}),c.push.apply(c,e),c=c.filter((t,n)=>{for(let e=0;e<n;++e)if(t.pkg0.id===c[e].pkg0.id)return!1;return!0})})}configureAsInvalidPackage(e){u.log(`invalid package ${this.id}: `+e),this._verspec="invalid:"+this.id,this.config={name:this.id,description:e,dependencies:{},files:[]}}parseConfig(e,t){try{const u=JSON.parse(e);this.config=u}catch(e){this.configureAsInvalidPackage(lf("Syntax error in pxt.json")),u.tickEvent("package.invalidConfigEncountered")}var n=JSON.stringify(this.config);for(const e in this.config.dependencies){const t=u.patching.upgradePackageReference(this.targetVersion(),e,this.config.dependencies[e]);t!=e&&(delete this.config.dependencies[e],t)&&(this.config.dependencies[t]="*")}t&&(this.config.targetVersions={target:t}),JSON.stringify(this.config)!=n&&this.saveConfig(),this.validateConfig()}patchCorePackage(){u.Util.assert(u.appTarget.simulator&&u.appTarget.simulator.dynamicBoardDefinition),u.Util.assert(0==this.level);const e=Object.keys(this.config.dependencies).filter(e=>!!e&&(e==u.BLOCKS_PROJECT_NAME||e==u.JAVASCRIPT_PROJECT_NAME||JSON.parse((u.appTarget.bundledpkgs[e]||{})[u.CONFIG_NAME]||"{}").core));if(0==e.length){const e=u.Package.corePackages();e.length&&this.config.dependencies[e[0].name]}else 1<e.length&&(e.pop(),e.forEach(e=>{u.log("removing core package "+e),delete this.config.dependencies[e]}))}resolvedDependencies(){return Object.keys(this.dependencies()).map(e=>this.resolveDep(e))}dependencies(e=!1){if(!this.config)return{};const n=u.Util.clone(this.config.dependencies||{});return 0==this.level&&this.config.testDependencies&&u.Util.iterMap(this.config.testDependencies,(e,t)=>{"*"==t&&!u.appTarget.bundledpkgs[e]||(n[e]=t)}),e&&this.config.cppDependencies&&u.Util.jsonMergeFrom(n,this.config.cppDependencies),n}loadAsync(a=!1,e){if(this.isLoaded)return Promise.resolve();let t=Promise.resolve();0!=this.level||u.appTarget.multiVariants||u.setAppTargetVariant(null),this.isLoaded=!0;const n=this.readFile(u.CONFIG_NAME),o=(null==n?a||u.U.userError("Package not installed: "+this.id+", did you forget to run `pxt install`?"):t=t.then(()=>this.parseConfig(n)),0!=this.level||a||(t=t.then(()=>this.upgradePackagesAsync().then(()=>{}))),a&&(t=t.then(()=>this.downloadAsync())),0==this.level&&a&&(t=t.then(()=>this.upgradePackagesAsync()).then(e=>e?(Object.keys(e).forEach(e=>u.tickEvent("package.doubleload",{extension:e})),u.log("upgraded, downloading again"),u.debug(e),this.downloadAsync()):Promise.resolve())),u.appTarget.simulator&&u.appTarget.simulator.dynamicBoardDefinition&&(t=(t=0==this.level?t.then(()=>this.patchCorePackage()):t).then(()=>{var e,t;this.config.compileServiceVariant&&u.setAppTargetVariant(this.config.compileServiceVariant),this.config.files.indexOf("board.json")<0||((e=u.appTarget.simulator.boardDefinition=JSON.parse(this.readFile("board.json"))).id=this.config.name,u.appTarget.appTheme.boardName=e.boardName||lf("board"),u.appTarget.appTheme.driveDisplayName=e.driveDisplayName||lf("DRIVE"),e=e=>{var t,n=/^pkg:\/\/(.*)/.exec(e);return n?(n=n[1],t=this.readFile(n),u.U.toDataUri(t,u.U.getMime(n))):e},"object"==typeof(t=u.appTarget.simulator.boardDefinition).visual&&((t=t.visual).image=e(t.image),t.outlineImage=e(t.outlineImage)))})),(e,t)=>{if(u.debug(`version spec mismatch: ${e._verspec} != `+t),/^github:/.test(e._verspec)&&/^github:/.test(t)){var n=u.github.parseRepoId(e._verspec),i=u.github.parseRepoId(t);if(null!=n&&n.slug&&(null==n?void 0:n.slug)===(null==i?void 0:i.slug)){n=(null==n?void 0:n.tag)||(null==(n=e.config)?void 0:n.version),i=u.semver.strcmp(n,i.tag);if(0==i)return void u.debug("resolved version are "+n);if(i<0)return void u.debug(`auto-upgraded ${t} to `+n)}}/^file:/.test(e._verspec)||/^file:/.test(t)?u.debug("ignore file: mismatch issues"):e.configureAsInvalidPackage(lf("version mismatch"))}),r=async(e,t,n=!1)=>{e=e||t.dependencies(n),u.debug(`deps: ${t.id}->`+Object.keys(e).join(", ")),e=u.github.resolveMonoRepoVersions(e),u.debug(`deps: resolved ${t.id}->`+Object.keys(e).join(", "));for(var i of Object.keys(e)){var r=e[i]||"*",s=(u.debug(`dep: load ${t.id}.${i}${n?"++":""}: `+r),"hw"==i&&u.hwVariant&&(i="hw---"+u.hwVariant),t.resolveDep(i));s?(s.invalid()||s._verspec===r||o(s,r),!s.invalid()&&n||(s.level=Math.min(s.level,t.level+1),s.addedBy.push(t))):(s=new h(i,r,t.parent,t),n&&(s.cppOnly=!0),t.parent.deps[i]=s,await(t.parent.deps[i.replace(/---.*/,"")]=s).loadAsync(a))}};return t.then(()=>r(null,this)).then(()=>{if(this.config.palette&&u.appTarget.runtime&&(u.appTarget.runtime.palette=u.U.clone(this.config.palette),this.config.paletteNames)&&(u.appTarget.runtime.paletteNames=this.config.paletteNames),this.config.screenSize&&u.appTarget.runtime&&(u.appTarget.runtime.screenSize=u.U.clone(this.config.screenSize)),0!==this.level)return Promise.resolve(null);{var e=this.readFile(u.MAIN_TS);if(!e)return Promise.resolve(null);const i=this.getMissingPackages(this.config,e);let n=!1;return Object.keys(i).reduce((e,t)=>e.then(()=>this.findConflictsAsync(t,i[t])).then(e=>{if(e.length){const i=e.map(e=>e.pkg0.id).join(", "),n=e.map(e=>e.settingName).filter(e=>!!e).join(", ");return u.log(`skipping missing package ${t} because it conflicts with the following packages: ${i} (conflicting settings: ${n})`),Promise.resolve(null)}{u.log("adding missing package "+t),n=!0,this.config.dependencies[t]="*";const e={};return e[t]=i[t],r(e,this)}}),Promise.resolve(null)).then(()=>(n&&(this.saveConfig(),this.validateConfig()),Promise.resolve(null)))}}).then(()=>0!=this.level?Promise.resolve():Promise.all(u.U.values(this.parent.deps).map(e=>r(null,e,!0)))).then(()=>{u.debug("  installed "+this.id)})}getFiles(){let e;e=0!=this.level||this.ignoreTests?this.config.files.slice(0):this.config.files.concat(this.config.testFiles||[]);const t=this.config.fileDependencies;return e=this.config.fileDependencies?e.filter(n=>{const i=e=>{if("!"==(e=e.trim())[0])return!i(e.slice(1));if(/^[\w-]+$/.test(e)){const u=this.parent.resolveDep(e);return!(!u||u.cppOnly)}var t=/^target:(\w+)$/.exec(e);return t?t[1]==u.appTarget.id||t[1]==u.appTarget.platformid:(h.depWarnings[e]||(h.depWarnings[e]=!0,u.log(`invalid dependency expression: ${e} in ${this.id}/`+n)),!1)},e=u.U.lookup(t,n);return!e||!e.trim()||e.split("||").some(e=>e.split("&&").every(i))}):e}addSnapshot(e,n=[""]){for(let t of this.getFiles())n.some(e=>u.U.endsWith(t,e))&&(e[this.id+"/"+t]=this.readFile(t));e[this.id+"/"+u.CONFIG_NAME]=this.readFile(u.CONFIG_NAME)}packageLocalizationStringsAsync(n){const i=u.appTarget.id,e=[this.config.name+"-jsdoc",this.config.name],r={},s=u.appTarget.appTheme||{};return this.config.skipLocalization?Promise.resolve(r):u.Util.liveLocalizationEnabled()&&"this"!=this.id&&u.appTarget.bundledpkgs[this.id]?(u.debug("loading live translations for "+this.id),Promise.all(e.map(t=>u.Util.downloadLiveTranslationsAsync(n,i+`/${t}-strings.json`,s.crowdinBranch).then(e=>{e&&Object.keys(e).length?u.Util.jsonMergeFrom(r,e):(u.tickEvent("translations.livetranslationsfailed",{filename:t}),u.Util.jsonMergeFrom(r,this.bundledStringsForFile(n,t)))}).catch(e=>{u.tickEvent("translations.livetranslationsfailed",{filename:t}),u.log(`error while downloading ${i}/${t}-strings.json`),u.Util.jsonMergeFrom(r,this.bundledStringsForFile(n,t))}))).then(()=>r)):(e.map(e=>this.bundledStringsForFile(n,e)).filter(e=>!!e).forEach(e=>u.Util.jsonMergeFrom(r,e)),Promise.resolve(r))}bundledStringsForFile(e,t){let n={},[i,r,s]=u.Util.normalizeLanguageCode(e);var e=this.config.files,a=`_locales/${i}/${t}-strings.json`;return n=-1<e.indexOf(a)||s&&(-1<e.indexOf(a=`_locales/${s}/${t}-strings.json`)||r&&-1<e.indexOf(a=`_locales/${r}/${t}-strings.json`))?JSON.parse(this.readFile(a)):n}}function n(a,o={}){var l,c=a["*"]||{};for(l of Object.keys(a))if("*"!=l){let e=a[l],t=(e="string"==typeof e?{data:e}:e).namespace||c.namespace||"",n=(t&&(t+="."),e.id||t+l),i=e.icon,r=e.mimeType||c.mimeType,s=e.dataEncoding||c.dataEncoding||"base64";i||"base64"!=s||"image/png"!=r&&"image/jpeg"!=r||(i="data:"+r+";base64,"+e.data),o[n]={id:n,data:e.data,dataEncoding:s,icon:i,namespace:t,mimeType:r,tilemapTile:e.tilemapTile,displayName:e.displayName,tileset:e.tileset}}return o}h.depWarnings={},u.Package=h,u.MainPackage=class extends h{constructor(e){super("this","file:.",null,null),this._host=e,this.deps={},(this.parent=this).addedBy=[this],this.level=0,this.deps[this.id]=this}installAllAsync(e){return this.loadAsync(!0,e)}sortedDeps(n=!1){let i={},r=[];const s=e=>e.config?Object.keys(e.config.cppDependencies||{}).length:0,a=e=>{var t;e&&!u.U.lookup(i,e.id)&&(i[e.id]=!0,(t=Object.keys(e.dependencies(n)).map(e=>this.resolveDep(e))).sort((e,t)=>s(t)-s(e)||u.U.strcmp(e.id,t.id)),t.forEach(a),r.push(e.id))};return a(this),r.map(e=>this.resolveDep(e))}localizationStringsAsync(t){const n={};return Promise.all(u.Util.values(this.deps).map(e=>e.packageLocalizationStringsAsync(t).then(t=>{t&&Object.keys(t).forEach(e=>{n[e]||(n[e]=t[e])})}))).then(()=>{const t=u.U.getLocalizedStrings();return Object.keys(n).forEach(e=>{!u.U.startsWith(e,"{id:subcategory}")&&!u.U.startsWith(e,"{id:group}")||t[e]||(t[e]=n[e])}),u.U.setLocalizedStrings(t),Promise.resolve(n)})}getTargetOptions(){let t=u.U.clone(u.appTarget.compile);return u.U.assert(!!t),t.utf8||this.sortedDeps(!0).forEach(e=>{e.config&&e.config.utf8&&(u.debug("forcing utf8 mode: pkg="+e.id),t.utf8=!0)}),t}getJRes(){if(!this._jres){this._jres={};for(const u of this.sortedDeps())u.parseJRes(this._jres);var e=(u.appTarget.runtime&&u.appTarget.runtime.palette?u.appTarget.runtime.palette:["#000000","#ffffff"]).map(e=>("000000"+parseInt(e.replace(/#/,""),16).toString(16)).slice(-6)).join("");this._jres.__palette={id:"__palette",data:e,dataEncoding:"hex",mimeType:"application/x-palette"}}return this._jres}updateJRes(){this._jres&&this.parseJRes(this._jres)}resolveBannedCategories(){if(void 0===this._resolvedBannedCategories){let t=[];u.appTarget&&u.appTarget.runtime&&u.appTarget.runtime.bannedCategories&&u.appTarget.runtime.bannedCategories.length&&(t=u.appTarget.runtime.bannedCategories.slice(),Object.keys(this.deps).map(e=>this.deps[e]).filter(e=>!!e).map(e=>u.Util.jsonTryParse(e.readFile(u.CONFIG_NAME))).filter(e=>e&&e.requiredCategories).forEach(e=>e.requiredCategories.forEach(e=>{e=t.indexOf(e);-1<e&&t.splice(e,1)})),this._resolvedBannedCategories=t),this._resolvedBannedCategories=t,this._resolvedBannedCategories.length||(this._resolvedBannedCategories=null)}return this._resolvedBannedCategories}async getCompileOptionsAsync(s=this.getTargetOptions()){var e,t,n={sourceFiles:[],fileSystem:{},target:s,name:this.config?this.config.name:""};const a=(e,t)=>{this.config.files.indexOf(e)<0&&u.U.userError(lf("please add '{0}' to \"files\" in {1}",e,u.CONFIG_NAME)),t="// Auto-generated. Do not edit.\n"+t+"\n// Auto-generated. Do not edit. Really.\n",this.host().readFile(this,e,!0)!==t&&(u.debug(`updating ${e} (size=${t.length})...`),this.host().writeFile(this,e,t,!0))};let o=!1;const i=async e=>{var t={extinfo:null,target:null},n=u.appTargetVariant;e&&u.setAppTargetVariant(e,{temporary:!0});try{var i=u.cpp.getExtensionInfo(this),r=(o||!i.shimsDTS&&!i.enumsDTS||(o=!0,i.shimsDTS&&a("shims.d.ts",i.shimsDTS),i.enumsDTS&&a("enums.d.ts",i.enumsDTS)),s.isNative?await this.host().getHexInfoAsync(i):null),i=u.U.flatClone(i);s.keepCppFiles||(delete i.compileData,delete i.generatedFiles,delete i.extensionFiles),i.hexinfo=r,t.extinfo=i,t.target=u.appTarget.compile}finally{e&&u.setAppTargetVariant(n,{temporary:!0})}return t};await this.loadAsync(),n.bannedCategories=this.resolveBannedCategories(),n.target.preferredEditor=this.getPreferredEditor(),u.debug("building: "+this.sortedDeps().map(e=>e.config.name).join(", "));let r=null;for(t of e=u.appTarget.multiVariants?u.appTargetVariant?[u.appTargetVariant]:u.appTarget.alwaysMultiVariant||u.appTarget.compile.switches.multiVariant?u.appTarget.multiVariants:[u.appTarget.multiVariants[0]]:[null]){r&&u.debug("building for "+t);const a=await i(t),o=a.extinfo;o.appVariant=t,o.outputPrefix=1!=e.length&&t?t+"-":"",r?n.otherMultiVariants.push(a):(r=o,n.otherMultiVariants=[])}if(n.extinfo=r,!u.appTarget.compile.shortPointers&&"vm"!=u.appTarget.compile.nativeType&&!this.config.binaryonly&&n.target.isNative){const s=await this.filesToBePublishedAsync(!0),a=JSON.stringify({name:this.config.name,comment:this.config.description,status:"unpublished",scriptId:this.installedVersion,cloudId:u.CLOUD_ID+u.appTarget.id,editor:this.getPreferredEditor(),targetVersions:u.appTarget.versions}),o=JSON.stringify(s),i=await u.lzmaCompressAsync(a+o);i&&(n.embedMeta=JSON.stringify({compression:"LZMA",headerSize:a.length,textSize:o.length,name:this.config.name,eURL:u.appTarget.appTheme.embedUrl,eVER:u.appTarget.versions?u.appTarget.versions.target:"",pxtTarget:u.appTarget.id}),n.embedBlob=ts.pxtc.encodeBase64(u.U.uint8ArrayToString(i)))}for(const u of this.sortedDeps())for(const s of u.getFiles())if(/\.(ts|asm|py)$/.test(s)){let e=s;0<u.level&&(e="pxt_modules/"+u.id+"/"+s),n.sourceFiles.push(e),n.fileSystem[e]=u.readFile(s)}n.jres=this.getJRes();var l=u.appTarget.runtime&&u.appTarget.runtime.functionsOptions;return n.allowedArgumentTypes=l&&l.extraFunctionEditorTypes&&l.extraFunctionEditorTypes.map(e=>e.typeName).concat("number","boolean","string"),n}prepareConfigToBePublished(){const i=u.U.clone(this.config);return delete i.installedVersion,delete i.additionalFilePath,delete i.additionalFilePaths,i.targetVersions||(i.targetVersions=u.Util.clone(u.appTarget.versions)),u.U.iterMap(i.dependencies,(e,t)=>{if(!t||/^(file|workspace):/.test(t)){t="*";try{const i=this.resolveDep(e).readGitJson();var n;i&&i.repo&&((n=u.github.parseRepoId(i.repo)).tag=i.commit.tag||i.commit.sha,t=u.github.stringifyRepo(n))}catch(e){}i.dependencies[e]=t}}),i}filesToBePublishedAsync(i=!1){const r={};return this.loadAsync().then(()=>{i||this.config.public||u.U.userError('Only packages with "public":true can be published');var e,t,n=this.prepareConfigToBePublished();r[u.CONFIG_NAME]=u.Package.stringifyConfig(n);for(e of this.getFiles())e!=u.CONFIG_NAME&&(null==(t=this.readFile(e))&&u.U.userError("referenced file missing: "+e),r[e]=t);return u.U.sortObjectFields(r)})}saveToJsonAsync(){return this.filesToBePublishedAsync(!0).then(e=>({meta:{cloudId:u.CLOUD_ID+u.appTarget.id,targetVersions:u.appTarget.versions,editor:this.getPreferredEditor(),name:this.config.name},source:JSON.stringify(e,null,2)}))}compressToFileAsync(){return this.saveToJsonAsync().then(e=>u.lzmaCompressAsync(JSON.stringify(e,null,2)))}computePartDefinitions(i){if(!i||!i.length)return{};let r={};return this.sortedDeps().forEach(n=>{var t=n.readFile("pxtparts.json");if(t)try{let e=JSON.parse(t);Object.keys(e).forEach(t=>{if(0<=i.indexOf(t)){t=r[t]=e[t];if("string"==typeof t.visual.image&&/\.svg$/i.test(t.visual.image)){let e=n.readFile(t.visual.image);e||u.reportError("parts","invalid part definition",{error:"missing visual "+t.visual.image}),/^data:image\/svg\+xml/.test(e)||(e="data:image/svg+xml,"+encodeURIComponent(e)),t.visual.image=e}}})}catch(e){u.reportError("parts","invalid pxtparts.json file")}}),r}},u.inflateJRes=n,u.allPkgFiles=function(e){return[u.CONFIG_NAME].concat(e.files||[]).concat(e.testFiles||[])},u.isPkgBeta=function(e){return e&&/\bbeta\b/.test(e.description)}}(pxt=pxt||{}),function(l){{var c=l.packetio||(l.packetio={});let i,n,r,s,a,o=()=>{};function u(){if(a)return a;let e=Promise.resolve();if(i){l.debug("packetio: disconnect");const t=i;e=e.then(()=>t.disconnectAsync()).then(()=>t.io.disposeAsync()).catch(e=>{l.reportException(e)}).finally(()=>{n=void 0,i=void 0,a=void 0}),o&&(e=e.then(()=>o())),a=e}return e}c.isActive=function(){return!!i},c.isConnected=function(){return!!i&&i.io.isConnected()},c.isConnecting=function(){return!!i&&i.io.isConnecting()},c.icon=function(){var e;return!!i&&(i.icon||(null==(e=l.appTarget.appTheme.downloadDialogTheme)?void 0:e.deviceIcon)||"usb")},c.unsupportedParts=function(){return null!=i&&i.unsupportedParts?i.unsupportedParts():[]},c.disconnectAsync=u,c.configureEvents=function(e,t,n){o=e,r=t,s=n,i&&(i.io.onConnectionChanged=o,i.onSerial=r,i.onCustomEvent=n)},c.sendCustomEventAsync=function(e,t){return i?i.sendCustomEventAsync(e,t):Promise.resolve()},c.initAsync=function(t=!1){if(l.debug("packetio: init "+(t?"(force)":"")),!n){let e=Promise.resolve();t&&(e=e.then(()=>u())),n=e.then(()=>i?Promise.resolve(i):c.mkPacketIOAsync?(l.debug("packetio: new wrapper"),c.mkPacketIOAsync().then(e=>(e.onConnectionChanged=o,i=c.mkPacketIOWrapper(e),r&&(i.onSerial=r),s&&(i.onCustomEvent=s),o&&o(),i))):(l.debug("packetio: not defined, skipping"),Promise.resolve(void 0))).finally(()=>{n=void 0})}return n}}}(pxt=pxt||{}),function(s){var e;(e=s.patching||(s.patching={})).computePatches=function(e,n){const i=s.appTarget.compile?s.appTarget.compile.patches:void 0;if(i){const r=s.semver.tryParse(e||"0.0.0")||s.semver.tryParse("0.0.0");let t=[];return Object.keys(i).filter(e=>s.semver.inRange(e,r)).forEach(e=>t=t.concat(i[e])),(t=n?t.filter(e=>e.type==n):t).length?t:void 0}},e.upgradePackageReference=function(e,t,n){if("*"!=n)return t;n=s.patching.computePatches(e,"package");let i=t;return n&&n.forEach(t=>{Object.keys(t.map).forEach(e=>{i==e&&(i=t.map[e])})}),i},e.patchJavaScript=function(e,t){e=s.patching.computePatches(e);let i=t;return e&&(e.filter(e=>"api"===e.type).forEach(n=>{Object.keys(n.map).forEach(e=>{var t=new RegExp(e,"g");i=i.replace(t,n.map[e])})}),e.filter(e=>"userenum"===e.type).forEach(n=>{Object.keys(n.map).forEach(e=>{var t=new RegExp("enum\\s+"+e+"\\s*{","gm"),t=(i=i.replace(t,`enum ${n.map[e]} {`),new RegExp(`(^|[^_a-zA-Z0-9])${e}(\\s*\\.)`,"g"));i=i.replace(t,`$1${n.map[e]}$2`)})})),i}}(pxt=pxt||{}),function(e){e.react||(e.react={})}(pxt=pxt||{}),function(a){function s(n,i){if(n){if(i){let t=n.major-i.major||n.minor-i.minor||n.patch-i.patch;if(t)return t;if(0==n.pre.length&&0<i.pre.length)return 1;if(0<n.pre.length&&0==i.pre.length)return-1;for(let e=0;e<n.pre.length+1;++e){var r=n.pre[e],s=i.pre[e];if(!r)return s?-1:0;if(!s)return 1;if(/^\d+$/.test(r)){if(!/^\d+$/.test(s))return-1;if(t=parseInt(r)-parseInt(s))return t}else{if(/^\d+$/.test(s))return 1;if(t=a.U.strcmp(r,s))return t}}return 0}return-1}return i?1:0}function o(e,t){t=l(e)||l(t);return t||a.U.userError(a.U.lf("'{0}' doesn't look like a semantic version number",e)),t}function l(e){if(!e)return null;if("*"===e)return{major:Number.MAX_SAFE_INTEGER,minor:Number.MAX_SAFE_INTEGER,patch:Number.MAX_SAFE_INTEGER,pre:[],build:[]};/^v\d/i.test(e)&&(e=e.slice(1));e=/^(\d+)\.(\d+)\.(\d+)(-([0-9a-zA-Z\-\.]+))?(\+([0-9a-zA-Z\-\.]+))?$/.exec(e);return e?{major:parseInt(e[1]),minor:parseInt(e[2]),patch:parseInt(e[3]),pre:e[5]?e[5].split("."):[],build:e[7]?e[7].split("."):[]}:null}function c(e){let t=e.major+"."+e.minor+"."+e.patch;return e.pre.length&&(t+="-"+e.pre.join(".")),e.build.length&&(t+="+"+e.build.join(".")),t}function t(e,t){var n=l(e),i=l(t);return n||i?s(n,i):a.U.strcmp(e,t)}function u(e,t){var n,e=e.split(" - ");return 2==e.length&&(n=l(e[0]),e=l(e[1]),!(!n||!e))&&(!t||(n=s(n,t),t=s(t,e),n<=0&&t<0))}var n;(n=a.semver||(a.semver={})).cmp=s,n.parse=o,n.tryParse=l,n.normalize=function(e){return c(o(e))},n.stringify=c,n.majorCmp=function(e,t){e=l(e),t=l(t);return e.major-t.major},n.strcmp=t,n.inRange=u,n.sortLatestTags=function(e){e=e.filter(e=>!!n.tryParse(e));return e.sort(t),e.reverse(),e},n.test=function(){console.log("Test semver");var n=["0.9.0","1.0.0-0.3.7","1.0.0-alpha","1.0.0-alpha.1","1.0.0-alpha.beta","1.0.0-beta","1.0.0-beta.2","1.0.0-beta.11","1.0.0-rc.1","1.0.0-x.7.z.92","1.0.0","1.0.1","1.9.0","1.10.0","1.11.0"];for(let t=0;t<n.length;++t){var i=o(n[t]);console.log(n[t],i),a.U.assert(c(i)==n[t]);for(let e=0;e<n.length;++e){var r=s(i,o(n[e]));console.log(n[t],n[e],r),t<e?a.U.assert(r<0):t>e?a.U.assert(0<r):a.U.assert(0==r)}}var e=l("1.2.3");a.U.assert(u("0.1.2 - 2.2.3",e)),a.U.assert(u("1.2.3 - 2.2.3",e)),a.U.assert(!u("0.0.0 - 1.2.3",e)),a.U.assert(!u("1.2.4 - 4.2.3",e)),a.U.assert(!u("0.0.0 - 0.0.1",e))}}(pxt=pxt||{}),function(e){{var y=e.pxtc||(e.pxtc={}),u;function t(e){return y.Util.values(e.byQName).filter(e=>e.attributes.block&&/^{[^:]+:[^}]+}/.test(e.attributes.block)).forEach(e=>{e.attributes.block=e.attributes.block.replace(/^{[^:]+:[^}]+}/,"")}),e}y.assert=y.Util.assert,y.oops=y.Util.oops,y.U=y.Util,y.ON_START_TYPE="pxt-on-start",y.ON_START_COMMENT="on start",y.HANDLER_COMMENT="code goes here",y.TS_STATEMENT_TYPE="typescript_statement",y.TS_DEBUGGER_TYPE="debugger_keyword",y.TS_BREAK_TYPE="break_keyword",y.TS_CONTINUE_TYPE="continue_keyword",y.TS_OUTPUT_TYPE="typescript_expression",y.TS_RETURN_STATEMENT_TYPE="function_return",y.PAUSE_UNTIL_TYPE="pxt_pause_until",y.COLLAPSED_BLOCK="pxt_collapsed_block",y.FUNCTION_DEFINITION_TYPE="function_definition",y.BINARY_JS="binary.js",y.BINARY_ASM="binary.asm",y.BINARY_HEX="binary.hex",y.BINARY_UF2="binary.uf2",y.BINARY_ELF="binary.elf",y.BINARY_PXT64="binary.pxt64",y.BINARY_ESP="binary.bin",y.NATIVE_TYPE_THUMB="thumb",y.NATIVE_TYPE_VM="vm",y.BuildSourceMapHelpers=function(r,t,n){const e=e=>{const t=e.split("\n").map(e=>e.length),n=t.reduce(({lens:e,sum:t},n)=>({lens:[...e,t+n+1],sum:t+n+1}),{lens:[],sum:0}).lens;return{posToLineCol:i=>{var e=n.reduce((e,t,n)=>i<t?e:n+1,0);return[e,t[e]-(n[e]-i)+1]},lineColToPos:(e,t)=>(n[e-1]||0)+t}},s={ts:e(t),py:e(n)},a=e=>e.endPos-e.startPos,i=(e,t)=>{const{startPos:n,endPos:i}=e;return r.filter(e=>e[t].startPos<=n&&i<=e[t].endPos)},o=(e,n)=>{e=i(e,n);return e.reduce((e,t)=>a(t[n])<a(e[n])?t:e,e[0])},l={allOverlaps:e=>i(e,"ts"),smallestOverlap:e=>o(e,"ts")},c={allOverlaps:e=>i(e,"py"),smallestOverlap:e=>o(e,"py")},u=(i,r)=>e=>{e=e;var t,[e,n]=[s[i].lineColToPos(e.line,e.column),e.length],e=o({startPos:e,endPos:e+n},i);if(e)return[n,t]=s[r].posToLineCol(e[r].startPos),{fileName:"main."+r,start:e[r].startPos,length:a(e[r]),line:n,column:t}},h=u("ts","py"),d=u("py","ts");return{ts:Object.assign(Object.assign(Object.assign({},s.ts),l),{locToLoc:h,getText:e=>t.substring(e.startPos,e.endPos)}),py:Object.assign(Object.assign(Object.assign({},s.py),c),{locToLoc:d,getText:e=>n.substring(e.startPos,e.endPos)})}},y.computeUsedParts=function(t,e){if(!t.usedSymbols||!pxt.appTarget.simulator||!pxt.appTarget.simulator.parts)return[];let n=[];if(Object.keys(t.usedSymbols).forEach(e=>{var e=t.usedSymbols[e];e&&e.attributes.parts&&(e=e.attributes.parts)&&e.split(/[ ,]+/).forEach(e=>{0<e.length&&n.indexOf(e)<0&&n.push(e)})}),e){const t=pxt.appTarget.simulator.boardDefinition.onboardComponents;t&&("ignorebuiltin"===e?n=n.filter(e=>-1===t.indexOf(e)):"onlybuiltin"===e&&(n=n.filter(e=>0<=t.indexOf(e))))}return n.sort(),n=n.reverse()},y.buildSimJsInfo=function(e){return{js:e.outfiles[y.BINARY_JS],targetVersion:pxt.appTarget.versions.target,fnArgs:e.usedArguments,parts:y.computeUsedParts(e,"ignorebuiltin"),usedBuiltinParts:y.computeUsedParts(e,"onlybuiltin")}},y.blocksCategory=function(e){e=e?e.attributes.blockNamespace||e.namespace:void 0;return e?y.Util.capitalize(e.split(".")[0]):void 0},y.getBlocksInfo=function(t,e){var n,i,r,s;let d=[];const p={},f={},g={},a={},o={};function l(n,i){const r="get"==n,s="set"==n,a="number"==i.retType,o=r?f:s?p:g,l=i.namespace+"."+i.retType;let c=y.U.lookup(o,l);if(!c){const p=`@${n}@`;let e,t;if(i.attributes.blockCombineShadow){const n=i.attributes.blockCombineShadow,r=n.match(/^([^,.]*),?([^,.]*)$/);r&&3==r.length&&(e=r[1].trim(),0!=(t=r[2].trim()).length||y.Util.endsWith(n,",")||(t=e,e=""))}var u=`${i.attributes.blockSetVariable||i.namespace.toLocaleLowerCase()}=`+(e||""),h="value="+(t||"");(c=o[l]={attributes:{blockId:`${a?i.namespace:l}_blockCombine_`+n,callingConvention:0,group:i.attributes.group,paramDefl:{},jsDoc:r?y.U.lf("Read value of a property on an object"):y.U.lf("Update value of property on an object")},name:p,namespace:i.namespace,fileName:i.fileName,qName:l+"."+p,pkg:i.pkg,kind:2,parameters:[{name:"property",description:r?y.U.lf("the name of the property to read"):y.U.lf("the name of the property to change"),isEnum:!0,type:"@combined@"},{name:"value",description:s?y.U.lf("the new value of the property"):y.U.lf("the amount by which to change the property"),type:i.retType}].slice(0,r?1:2),retType:r?i.retType:"void",combinedProperties:[]}).attributes.block=r?y.U.lf("%{0} %property",u):s?y.U.lf("set %{0} %property to %{1}",u,h):y.U.lf("change %{0} %property by %{1}",u,h),w(c.attributes),pxt.Util.isTranslationMode()&&(c.attributes.translationId=c.attributes.block,c.attributes.block=r?`%${u} %property`:s?`set %${u} %property to %`+h:`change %${u} %property by %`+h,w(c.attributes),pxt.crowdin.inContextLoadAsync(c.attributes.translationId).then(e=>{c.attributes.block=e,w(c.attributes)})),d.push(c)}c.combinedProperties.push(i.qName)}for(i of y.Util.values(t.byQName)){if("ENUM_GET"===i.attributes.shim&&i.attributes.enumName&&i.attributes.blockId){let e=!1;if(a[i.attributes.enumName]&&(console.warn(`Enum block ${i.attributes.blockId} trying to overwrite enum `+i.attributes.enumName),e=!0),i.attributes.enumMemberName||(console.warn(`Enum block ${i.attributes.blockId} should specify enumMemberName`),e=!0),i.attributes.enumPromptHint||(console.warn(`Enum block ${i.attributes.blockId} should specify enumPromptHint`),e=!0),i.attributes.enumInitialMembers&&i.attributes.enumInitialMembers.length||(console.warn(`Enum block ${i.attributes.blockId} should specify enumInitialMembers`),e=!0),e)continue;const t=parseInt(i.attributes.enumStartValue);a[i.attributes.enumName]={blockId:i.attributes.blockId,name:i.attributes.enumName,memberName:i.attributes.enumMemberName,firstValue:isNaN(t)?void 0:t,isBitMask:i.attributes.enumIsBitMask,isHash:i.attributes.enumIsHash,initialMembers:i.attributes.enumInitialMembers,promptHint:i.attributes.enumPromptHint}}if("KIND_GET"===i.attributes.shim&&i.attributes.blockId){const n=i.attributes.kindNamespace||i.attributes.blockNamespace||i.namespace;if(o[n]){console.warn("More than one block defined for kind "+n);continue}const v=[];if(t.byQName[n])for(const e of y.Util.values(t.byQName))e.namespace===n&&e.attributes.isKind&&v.push(e.name);o[n]={blockId:i.attributes.blockId,name:n,memberName:i.attributes.kindMemberName||n,initialMembers:v,promptHint:i.attributes.enumPromptHint||y.Util.lf("Create a new kind..."),createFunctionName:i.attributes.kindCreateFunction||"create"}}if(i.attributes.blockCombine)/@set/.test(i.name)||l("get",i),i.isReadOnly||("number"==i.retType&&l("change",i),l("set",i));else if(i.attributes.block&&!i.attributes.fixedInstance&&7!=i.kind&&5!=i.kind&&9!=i.kind&&8!=i.kind){if(i.attributes.blockId||(i.attributes.blockId=i.qName.replace(/\./g,"_")),"true"==i.attributes.block){let e=y.U.uncapitalize(i.name);1!=i.kind&&2!=i.kind||(e+=" %"+i.namespace.toLowerCase());const d=null!=(n=null==(n=i.parameters)?void 0:n.filter(e=>!v(e)))?n:[];for(var c of d)e+=" %"+c.name;i.attributes.block=e,w(i.attributes)}d.push(i)}}for(r of d){var u=y.U.lookup(t.byQName,r.namespace);if(u){var h,m=u.attributes,b=r.attributes;for(h of["blockNamespace","color","blockGap"])void 0===b[h]&&m[h]&&(b[h]=m[h])}}return{apis:t,blocks:d=e&&(s=e).length?d.filter(e=>{e=(e.attributes.blockNamespace||e.namespace).split(".")[0];return-1===s.indexOf(e)}):d,blocksById:pxt.Util.toDictionary(d,e=>e.attributes.blockId),enumsByName:a,kindsByName:o}},y.tsSnippetToPySnippet=function(e,t){const n={true:"True",false:"False",null:"None"}[e];if(n)return n;if(t&&6==t.kind||!t&&e.includes(".")){const t=e.lastIndexOf("."),n=e.substr(0,t);var i=e.substr(t+1);return n+"."+y.U.snakify(i).toUpperCase()}return e},y.apiLocalizationStrings={},y.localizeApisAsync=async function(l,e){const c=y.Util.userLanguage();if("en"==c)return Promise.resolve(t(l));const u=c.toLowerCase(),h=u+"|jsdoc",d=u+"|block",p=await e.localizationStringsAsync(c);y.apiLocalizationStrings&&y.Util.jsonMergeFrom(p,y.apiLocalizationStrings);e=y.Util.values(l.byQName).filter(e=>e.attributes._translatedLanguageCode!==c);return await y.Util.promiseMapAll(e,async i=>{var e;const t=i.attributes.useLoc||i.attributes.blockAliasFor,r=t&&l.byQName[t],n=(i.attributes._untranslatedJsDoc&&(i.attributes.jsDoc=i.attributes._untranslatedJsDoc),i.attributes._untranslatedBlock&&(i.attributes.jsDoc=i.attributes._untranslatedBlock),(e,t)=>{var n;return p[i.qName+e]||(null==(n=i.attributes.locs)?void 0:n[t])||r&&(p[r.qName+e]||(null==(n=r.attributes.locs)?void 0:n[t]))}),s=n("",h);s&&(i.attributes._untranslatedJsDoc||(i.attributes._untranslatedJsDoc=i.attributes.jsDoc),i.attributes.jsDoc=s),null!=(a=i.parameters)&&a.forEach(e=>{var t="|param|"+e.name,t=n(t,u+t);t&&(e.description=t)});var a=p["{id:category}"+y.Util.capitalize(i.qName)];let o=p[i.qName+"|block"]||(null==(e=i.attributes.locs)?void 0:e[d]);if(!o&&r){const y=p[r.qName+"|block"]||(null==(e=r.attributes.locs)?void 0:e[d]);i.attributes.block===(r.attributes._untranslatedBlock||r.attributes.block)&&y&&(o=y)}if(o&&pxt.Util.isTranslationMode()&&(i.attributes.translationId=o,o=await pxt.crowdin.inContextLoadAsync(o)),a)i.attributes.block?i.attributes.block=o||i.attributes.block:i.attributes.block=a,w(i.attributes);else if(i.attributes.block&&o){const y=pxt.blocks.compileInfo(i),l=i.attributes.block;i.attributes.block=pxt.blocks.normalizeBlock(o,e=>{pxt.tickEvent("loc.normalized",{block:i.attributes.block,lang:c,error:e})}),i.attributes._untranslatedBlock||(i.attributes._untranslatedBlock=l),l!=i.attributes.block&&(w(i.attributes),function(e,t){if(e.parameters.length!=t.parameters.length)return pxt.debug("Localized block has extra or missing parameters"),0;for(const n of e.parameters){const e=t.actualNameToParam[n.actualName];if(!e||n.type!=e.type||n.shadowBlockId!=e.shadowBlockId)return pxt.debug(`Parameter ${n.actualName} type or shadow block does not match after localization`),0}return 1}(y,pxt.blocks.compileInfo(i))||(pxt.log(`block has non matching arguments: ${l} vs `+i.attributes.block),pxt.reportError("loc.errors","invalid translations",{block:i.attributes.blockId,lang:c}),i.attributes.block=l,w(i.attributes)))}else w(i.attributes);i.attributes._translatedLanguageCode=c}),t(l)},y.emptyExtInfo=function(){let e=pxt.appTarget.compileService;var t=!!(e=e||{}).platformioIni,n="dockermake"==e.buildEngine||"dockercross"==e.buildEngine||"dockerespidf"==e.buildEngine,i={functions:[],generatedFiles:{},extensionFiles:{},sha:"",compileData:"",shimsDTS:"",enumsDTS:"",onlyPublic:!0};return t?i.platformio={dependencies:{}}:n?i.npmDependencies={}:i.yotta={config:{},dependencies:{}},i};const o=["weight","imageLiteral","topblockWeight"],f=["advanced","handlerStatement","afterOnStart","optionalVariableArgs","blockHidden","constantShim","blockCombine","enumIsBitMask","enumIsHash","decompileIndirectFixedInstances","topblock","callInDebugger","duplicateShadowOnDrag","argsNullable"];function v(e){return"Action"===e.type||/^\([^\)]*\)\s*=>/.test(e.type)}function w(n){var e;function t(e){return n._shadowOverrides&&e.parameters.forEach(e=>{var t=n._shadowOverrides[e.name];"unset"===t?delete e.shadowBlockId:null!=t&&(e.shadowBlockId=t)}),e}n.block&&(e=n.block.split("||"),n._def=t(i(e[0])),n._def||pxt.debug("Unable to parse block def for id: "+n.blockId),e[1]&&(n._expandedDef=t(i(e[1]))),e[1])&&!n._expandedDef&&pxt.debug("Unable to parse expanded block def for id: "+n.blockId)}function i(i){const n=[];let r,s=0;for(;s<i.length;s++){const a=i[s],o=s;let t;switch(a){case"*":case"_":const n=d(e=>e==a),r="_"===a?2:0;1===n.length?t={kind:1<<r,content:n}:2===n.length?t={kind:2<<r,content:n}:3===n.length?t={kind:3<<r,content:n}:s=o;break;case"`":const e=p("`");void 0===e?s=o:t={kind:256,content:e};break;case"|":t={kind:32};break;case"\\":s<i.length-1&&(t={kind:16,content:i[1+s++]});break;case"[":const c=p("]");if(void 0!==c&&"("===i[1+s++]){const i=p(")");if(void 0!==i){t={kind:512,content:c,type:i};break}}s=o;break;case"$":case"%":const u=d(e=>/[a-zA-Z0-9_=]/.test(e),!0).split("=");if(2<u.length)s=o;else{let e;if("("===i[s+1]){const i=s;++s,(e=p(")"))||(s=i)}t={kind:"$"===a?1024:64,content:u[0],type:u[1],name:e}}}t?(r&&n.push({kind:128,content:r}),r=void 0,n.push(t)):r?r+=a:r=a}r&&n.push({kind:128,content:r});const a=[],o=[];let l=[],c=0,u="",h=[];for(let e=0;e<n.length;e++){const r=n[e].kind,s=l[l.length-1];if(15&r)if(g(n[e].content),r&c)if(s&r){l.pop();const i=s&(c^=r)|r&c;i&&l.push(i)}else f();else c|=r,l.push(r);else 144&r?u+=n[e].content:1120&r&&t();if(64==r){const r={kind:"param",name:n[e].content,shadowBlockId:n[e].type,ref:!1};n[e].name&&(r.varName=n[e].name),a.push(r),o.push(r)}else if(1024==r){const r={kind:"param",name:n[e].content,shadowBlockId:n[e].type,ref:!0};n[e].name&&(r.varName=n[e].name),a.push(r),o.push(r)}else 256==r?(g(),h.push({kind:"image",uri:n[e].content})):512==r?(g(),h.push({kind:"label",text:n[e].content,cssClass:n[e].type})):32==r&&a.push({kind:"break"})}return t(),{parts:a,parameters:o};function d(e,t=!1){let n="";for(t&&s++;s<i.length&&e(i[s]);)n+=i[s],++s;return n&&s--,n}function p(t){var e=d(e=>e!==t,!0);if(i[s+1]===t)return++s,e}function f(){let e="",t=[];for(const n of h)n.kind?(t.push({content:e,styles:0}),t.push(n),e=""):(e+=n.content,n.endingToken&&(e+=n.endingToken));h=t,e&&h.push({content:e,styles:0}),l=[],c=0}function t(){for(g(),c&&f();h.length;){var e,t=h.shift();t.kind?a.push(t):t.content&&(e=[],10&t.styles&&e.push("bold"),5&t.styles&&e.push("italics"),a.push({kind:"label",text:t.content,style:e}))}}function g(e){h.push({content:u,styles:c,endingToken:e}),u=""}}function p(n){var i=e=>n[e]+(n[e+1]<<8)+(n[e+2]<<16)+(n[e+3]<<24)>>>0;if(!n||512!=n.length||i(0)!=u.UF2_MAGIC_START0||i(4)!=u.UF2_MAGIC_START1||i(n.length-4)!=u.UF2_MAGIC_END)return null;let e=i(8),r=i(16),s=(476<r&&(r=256),null),t=0,a=0;if(e&u.UF2_FLAG_FILE){let e=n.slice(32+r),t=e.indexOf(0);0<=t&&(e=e.slice(0,t)),s=y.U.fromUTF8Array(e),a=i(28)}return e&u.UF2_FLAG_FAMILY_ID_PRESENT&&(t=i(28)),{flags:e,targetAddr:i(12),payloadSize:r,blockNo:i(20),numBlocks:i(24),fileSize:a,familyId:t,data:n.slice(32,32+r),filename:s}}function a(e,t){return!!e&&e.targetAddr<=t&&t<e.targetAddr+e.payloadSize}function h(e,t,n){e[t]=255&n,e[t+1]=n>>8&255,e[t+2]=n>>16&255,e[t+3]=n>>24&255}function r(e){return{currBlock:null,currPtr:-1,blocks:[],ptrs:[],filesize:0,familyId:(e="string"==typeof e?parseInt(e):e)||0}}function s(t){for(let e=0;e<t.blocks.length;++e)h(t.blocks[e],20,e),h(t.blocks[e],24,t.blocks.length),t.filename&&h(t.blocks[e],28,t.filesize)}function d(t,e,n,i=0){let r=t.currBlock,s=e>>8,a=256-(255&e);if(n.length>a){var o=new Uint8Array(n);for(d(t,e,o.slice(0,a));a<n.length;){var l=Math.min(a+256,n.length);d(t,e+a,o.slice(a,l)),a=l}}else{if(s!=t.currPtr){r=null;for(let e=0;e<t.ptrs.length;++e)if(t.ptrs[e]==s){r=t.blocks[e];break}if(!r){r=new Uint8Array(512),t.filename?i|=u.UF2_FLAG_FILE:t.familyId&&(i|=u.UF2_FLAG_FAMILY_ID_PRESENT),h(r,0,u.UF2_MAGIC_START0),h(r,4,u.UF2_MAGIC_START1),h(r,8,i),h(r,12,s<<8),h(r,16,256),h(r,20,t.blocks.length),h(r,28,t.familyId),h(r,508,u.UF2_MAGIC_END);for(let e=32;e<288;++e)r[e]=255;t.filename&&y.U.memcpy(r,288,y.U.toUTF8Array(t.filename)),t.blocks.push(r),t.ptrs.push(s)}t.currPtr=s,t.currBlock=r}var c=32+(255&e);for(let e=0;e<n.length;++e)r[c+e]=n[e];t.filesize=Math.max(t.filesize,n.length+e)}}y.parseCommentString=function(e){let l={paramDefl:{},callingConvention:0,_source:e},c=!0;for(;c;)c=!1,e=e.replace(/\/\/%[ \t]*([\w\.-]+)(=(("[^"\n]*")|'([^'\n]*)'|([^\s]*)))?/,(e,t,n,i,r,s,a)=>{let o=r?JSON.parse(r):n?r||s||a:"true";if(o=o||"",y.U.startsWith(t,"block.loc."))l.locs||(l.locs={}),l.locs[t.slice("block.loc.".length).toLowerCase()+"|block"]=o;else if(y.U.startsWith(t,"jsdoc.loc."))l.locs||(l.locs={}),l.locs[t.slice("jsdoc.loc.".length).toLowerCase()+"|jsdoc"]=o;else if(y.U.contains(t,".loc.")){l.locs||(l.locs={});const y=t.slice(0,t.indexOf(".loc.")),e=t.slice(t.indexOf(".loc.")+".loc.".length);l.locs[e+"|param|"+y]=o}else if(y.U.endsWith(t,".defl"))-1<o.indexOf(" ")?l.paramDefl[t.slice(0,t.length-5)]=`"${o}"`:l.paramDefl[t.slice(0,t.length-5)]=o,l.explicitDefaults||(l.explicitDefaults=[]),l.explicitDefaults.push(t.slice(0,t.length-5));else if(y.U.endsWith(t,".shadow"))l._shadowOverrides||(l._shadowOverrides={}),l._shadowOverrides[t.slice(0,t.length-7)]=o;else if(y.U.endsWith(t,".fieldEditor"))l.paramFieldEditor||(l.paramFieldEditor={}),l.paramFieldEditor[t.slice(0,t.length-12)]=o;else if(y.U.contains(t,".fieldOptions.")){l.paramFieldEditorOptions||(l.paramFieldEditorOptions={});const y=t.slice(0,t.indexOf(".fieldOptions.")),e=t.slice(t.indexOf(".fieldOptions.")+14,t.length);l.paramFieldEditorOptions[y]||(l.paramFieldEditorOptions[y]={}),l.paramFieldEditorOptions[y][e]=o}else if(y.U.contains(t,".shadowOptions.")){l.paramShadowOptions||(l.paramShadowOptions={});const y=t.slice(0,t.indexOf(".shadowOptions.")),e=t.slice(t.indexOf(".shadowOptions.")+15,t.length);l.paramShadowOptions[y]||(l.paramShadowOptions[y]={}),l.paramShadowOptions[y][e]=o}else y.U.endsWith(t,".min")?(l.paramMin||(l.paramMin={}),l.paramMin[t.slice(0,t.length-4)]=o):y.U.endsWith(t,".max")?(l.paramMax||(l.paramMax={}),l.paramMax[t.slice(0,t.length-4)]=o):l[t]=o;return c=!0,"//% "});for(var t of o)"string"==typeof l[t]&&(l[t]=parseInt(l[t]));for(var n of f)"string"==typeof l[n]&&(l[n]="true"==l[n]||"1"==l[n]);if(l.trackArgs&&(l.trackArgs=l.trackArgs.split(/[ ,]+/).map(e=>parseInt(e)||0)),l.enumInitialMembers&&(l.enumInitialMembers=l.enumInitialMembers.split(/[ ,]+/)),l.blockExternalInputs&&!l.inlineInputMode&&(l.inlineInputMode="external"),l.paramHelp={},l.jsDoc="",e=e.replace(/\/\*\*([^]*?)\*\//g,(e,t)=>(t=(t=t.replace(/\n\s*(\*\s*)?/g,"\n")).replace(/^\s*@param\s+(\w+)\s+(.*)$/gm,(e,t,n)=>{if(l.paramHelp[t]=n,!l.paramDefl[t]){n=/\beg\.?:\s*(.+)/.exec(n);if(n&&n[1]){n=/(?:"([^"]*)")|(?:'([^']*)')|(?:([^\s,]+))/g.exec(n[1]);if(n){let e=n[1]||n[2]||n[3];-1<(e=e||"").indexOf(" ")?l.paramDefl[t]=`"${e}"`:l.paramDefl[t]=e}}}return""}),l.jsDoc+=t,"")),l.jsDoc=l.jsDoc.trim(),l.async&&(l.callingConvention=1),l.promise&&(l.callingConvention=2),l.jres&&(l.whenUsed=!0),l.subcategories)try{l.subcategories=JSON.parse(l.subcategories)}catch(e){l.subcategories=void 0}if(l.groups)try{l.groups=JSON.parse(l.groups)}catch(e){l.groups=void 0}if(l.groupIcons)try{l.groupIcons=JSON.parse(l.groupIcons)}catch(e){l.groupIcons=void 0}if(l.groupHelp)try{l.groupHelp=JSON.parse(l.groupHelp)}catch(e){l.groupHelp=void 0}return w(l),l},y.parameterTypeIsArrowFunction=v,y.updateBlockDef=w,y.parseBlockDefinition=i,y.parseChecksumBlock=function(t,n=0){var e=pxt.HF2.read32(t,n);if(133083260!=(2147483647&e))return pxt.log("no checksum block magic"),null;var i=pxt.HF2.read32(t,n+4),r=pxt.HF2.read32(t,n+8);if(3&i)return pxt.log("invalid end marker position"),null;var s=1<<(255&r);if(s!=pxt.appTarget.compile.flashCodeAlign)return pxt.log("invalid page size: "+s),null;var a={magic:e,endMarkerPos:i,endMarker:r,regions:[]};for(let e=n+12;e<t.length-7;e+=8){var o={start:s*pxt.HF2.read16(t,e),length:s*pxt.HF2.read16(t,e+2),checksum:pxt.HF2.read32(t,e+4)};if(!o.length||!o.checksum)break;a.regions.push(o)}return a},(u=y.UF2||(y.UF2={})).UF2_MAGIC_START0=171066965,u.UF2_MAGIC_START1=2656915799,u.UF2_MAGIC_END=179400496,u.UF2_FLAG_NONE=0,u.UF2_FLAG_NOFLASH=1,u.UF2_FLAG_FILE=4096,u.UF2_FLAG_FAMILY_ID_PRESENT=8192,u.parseBlock=p,u.parseFile=function(t){var n=[];for(let e=0;e<t.length;e+=512){var i=p(t.slice(e,e+512));i&&n.push(i)}return n},u.toBin=function(t,n){if(t.length<512)return null;let i=-1,r=-1,s=[];for(let e=0;e<t.length;++e){var a=512*e,o=p(t.slice(a,512+a));if(o){if(n&&o.targetAddr+256>n)break;-1==i&&(i=o.targetAddr,r=i);var l=o.targetAddr-i;l<0||l%4||1048576<l||(0<l&&s.push(new Uint8Array(l)),s.push(t.slice(32+a,32+a+o.payloadSize)),i=o.targetAddr+o.payloadSize)}}let e=0;for(var c of s)e+=c.length;if(0==e)return null;let u=new Uint8Array(e),h=0;for(var d of s)for(let e=0;e<d.length;++e)u[h++]=d[e];return{buf:u,start:r}},u.readBytes=function(t,n,i){let r,s=new Uint8Array(i);for(let e=0;e<i;++e,++n)(r=a(r,n)?r:t.filter(e=>a(e,n))[0])&&(s[e]=r.data[n-r.targetAddr]);return s},u.newBlockFile=r,u.finalizeFile=s,u.concatFiles=function(e){for(var t of e)s(t),t.filename=null;var n,i=r();i.blocks=y.U.concat(e.map(e=>e.blocks));for(n of e)n.blocks=[];return i},u.serializeFile=function(e){s(e);let t="";for(var n of e.blocks)t+=y.Util.uint8ArrayToString(n);return t},u.readBytesFromFile=function e(t,n,i){let r,s=n>>8;if(s==t.currPtr)r=t.currBlock;else{for(let e=0;e<t.ptrs.length;++e)if(t.ptrs[e]==s){r=t.blocks[e];break}r&&(t.currPtr=s,t.currBlock=r)}var a,o;return r?(a=new Uint8Array(i),o=Math.min(i,256-(255&n)),y.U.memcpy(a,0,r,32+(255&n),o),0<(i=i-o)&&(n=e(t,n+o,i),y.U.memcpy(a,o,n)),a):null},u.writeBytes=d,u.writeHex=function(t,n){let i="0000";for(let e=0;e<n.length;++e){var r=/:02000004(....)/.exec(n[e]);if(r&&(i=r[1]),r=/^:..(....)00(.*)[0-9A-F][0-9A-F]$/.exec(n[e])){var s=parseInt(i+r[1],16),a=r[2],o=[];for(let e=0;e<a.length;e+=2)o.push(parseInt(a[e]+a[e+1],16));d(t,s,o)}}}}}(ts=ts||{}),function(c){{var e=c.shell||(c.shell={}),t;let s,a,o=((t=s=e.EditorLayoutType||(e.EditorLayoutType={}))[t.IDE=0]="IDE",t[t.Sandbox=1]="Sandbox",t[t.Widget=2]="Widget",!(t[t.Controller=3]="Controller")),l=!1;function n(){if(void 0===a){if(c.BrowserUtils.hasWindow()){const e=/sandbox=1|#sandbox|#sandboxproject/i.test(window.location.href)||c.BrowserUtils.isIFrame(),t=/nosandbox=1/i.test(window.location.href),n=/controller=1/i.test(window.location.href)&&c.BrowserUtils.isIFrame(),u=/readonly=1/i.test(window.location.href),i=/editorlayout=(widget|sandbox|ide)/i.exec(window.location.href),r=/noproject=1/i.test(window.location.href);if(a=s.IDE,t?a=s.Widget:n?a=s.Controller:e&&(a=s.Sandbox),n&&u&&(o=!0),n&&r&&(l=!0),i)switch(i[1].toLowerCase()){case"widget":a=s.Widget;break;case"sandbox":a=s.Sandbox;break;case"ide":a=s.IDE}}else a=s.Sandbox;c.debug(`shell: layout type ${s[a]}, readonly `+u())}}function i(){return n(),a==s.Sandbox}function u(){return!c.BrowserUtils.hasWindow()||i()&&!/[?&]edit=1/i.test(window.location.href)||r()&&o}function r(){return n(),a==s.Controller}e.layoutTypeClass=function(){return n(),c.shell.EditorLayoutType[a].toLowerCase()},e.isSandboxMode=i,e.isReadOnly=u,e.isNoProject=function(){return l},e.isControllerMode=r,e.isPyLangPref=function(){return"py"==c.storage.getLocal("editorlangpref")},e.getEditorLanguagePref=function(){return c.storage.getLocal("editorlangpref")},e.setEditorLanguagePref=function(e){e.match(/prj$/)&&(e=e.replace(/prj$/,"")),c.storage.setLocal("editorlangpref",e)},e.getToolboxAnimation=function(){return c.storage.getLocal("toolboxanimation")},e.setToolboxAnimation=function(){c.storage.setLocal("toolboxanimation","1")}}}(pxt=pxt||{}),function(e){{var t=e.skillmap||(e.skillmap={});t.USER_VERSION="0.0.1";class n{constructor(){this.db=new e.BrowserUtils.IDBWrapper(n.databaseName,n.version,(e,t)=>{t=t.result;e.oldVersion<1&&(t.createObjectStore(n.projectTable,{keyPath:n.projectKey}),t.createObjectStore(n.userTable,{keyPath:n.userKey}))})}initAsync(){return this.db.openAsync()}getAllProjectsAsync(){return this.db.getAllAsync(n.projectTable).then(e=>e.map(e=>e.project).filter(e=>!e.deleted))}deleteProjectAsync(e){return this.getProjectAsync(e).then(e=>{e.deleted=!0,this.saveProjectAsync(e)})}getProjectAsync(e){return this.db.getAsync(n.projectTable,e).then(e=>{return null==(e=e)?void 0:e.project})}saveProjectAsync(e){return this.db.setAsync(n.projectTable,{id:e.header.id,project:e})}getUserStateAsync(){return this.db.getAsync(n.userTable,"local-user").then(e=>{return null==(e=e)?void 0:e.user})}saveUserStateAsync(e){return this.db.setAsync(n.userTable,{id:"local-user",user:e})}}n.version=6,n.databaseName="local-skill-map",n.projectTable="projects",n.projectKey="id",n.userTable="users",n.userKey="id",t.IndexedDBWorkspace=n}}(pxt=pxt||{}),function(n){var e;(e=n.streams||(n.streams={})).createStreamAsync=function(e,t){return n.Cloud.privatePostAsync("streams",{target:e,name:t||"data"}).then(e=>e)},e.postPayloadAsync=function(e,t){return n.Util.assert(!!e.privatekey),n.Cloud.privatePostAsync(e.id+"/data?privatekey="+e.privatekey,t)}}(pxt=pxt||{}),function(n){{var r=n.svgUtil||(n.svgUtil={}),e;let t,i;(e=t=r.PatternUnits||(r.PatternUnits={}))[e.userSpaceOnUse=0]="userSpaceOnUse",e[e.objectBoundingBox=1]="objectBoundingBox",(e=i=r.LengthUnit||(r.LengthUnit={}))[e.em=0]="em",e[e.ex=1]="ex",e[e.px=2]="px",e[e.in=3]="in",e[e.cm=4]="cm",e[e.mm=5]="mm",e[e.pt=6]="pt",e[e.pc=7]="pc",e[e.percent=8]="percent";class o{constructor(e){this.el=s(e)}attr(t){return Object.keys(t).forEach(e=>{this.setAttribute(e,t[e])}),this}setAttribute(e,t){return this.el.setAttribute(e,t.toString()),this}setAttributeNS(e,t,n){return this.el.setAttributeNS(e,t,n.toString()),this}id(e){return this.setAttribute("id",e)}setClass(...e){return this.setAttribute("class",e.join(" "))}appendClass(e){return n.BrowserUtils.addClass(this.el,e),this}removeClass(e){n.BrowserUtils.removeClass(this.el,e)}title(e){this.titleElement||(this.titleElement=s("title"),this.el.firstChild?this.el.insertBefore(this.titleElement,this.el.firstChild):this.el.appendChild(this.titleElement)),this.titleElement.textContent=e}setVisible(e){return this.setAttribute("visibility",e?"visible":"hidden")}}r.BaseElement=o;class l extends o{draw(e){e=function(e){switch(e){case"text":return new f;case"circle":return new m;case"rect":return new g;case"line":return new b;case"polygon":return new w;case"polyline":return new v;case"path":return new k;default:return new p(e)}}(e);return this.el.appendChild(e.el),e}element(e,t){return t(this.draw(e)),this}group(){var e=new c;return this.el.appendChild(e.el),e}appendChild(e){this.el.appendChild(e.el)}onDown(e){return r.events.down(this.el,e),this}onUp(e){return r.events.up(this.el,e),this}onMove(e){return r.events.move(this.el,e),this}onEnter(e){return r.events.enter(this.el,e),this}onLeave(e){return r.events.leave(this.el,e),this}onClick(e){return r.events.click(this.el,e),this}}r.DrawContext=l,r.SVG=class extends l{constructor(e){super("svg"),e&&e.appendChild(this.el)}define(e){return this.defs||(this.defs=new h(this.el)),e(this.defs),this}};class c extends l{constructor(e){super("g"),e&&e.appendChild(this.el)}translate(e,t){return this.left=e,this.top=t,this.updateTransform()}scale(e){return this.scaleFactor=e,this.updateTransform()}def(){return new h(this.el)}style(){return new d(this.el)}updateTransform(){let e="";return null!=this.left&&(e+=`translate(${this.left} ${this.top})`),null!=this.scaleFactor&&(e+=` scale(${this.scaleFactor})`),this.setAttribute("transform",e),this}}r.Group=c;class u extends l{constructor(){super("pattern")}units(e){return this.setAttribute("patternUnits",e===t.objectBoundingBox?"objectBoundingBox":"userSpaceOnUse")}contentUnits(e){return this.setAttribute("patternContentUnits",e===t.objectBoundingBox?"objectBoundingBox":"userSpaceOnUse")}size(e,t){return this.setAttribute("width",e),this.setAttribute("height",t),this}}r.Pattern=u;class h extends o{constructor(e){super("defs"),e.appendChild(this.el)}create(e,t){let n;switch(e){case"path":n=new k;break;case"pattern":n=new u;break;case"radialGradient":n=new x;break;case"linearGradient":n=new T;break;case"clipPath":n=new E;break;default:n=new o(e)}return n.id(t),this.el.appendChild(n.el),n}}r.DefsElement=h;class d extends o{constructor(e){super("style"),e.appendChild(this.el)}content(e){this.el.textContent=e}}r.StyleElement=d;class p extends l{at(e,t){return this.setAttribute("x",e),this.setAttribute("y",t),this}moveTo(e,t){return this.at(e,t)}fill(e,t){return this.setAttribute("fill",e),null!=t&&this.opacity(t),this}opacity(e){return this.setAttribute("fill-opacity",e)}stroke(e,t){return this.setAttribute("stroke",e),null!=t&&this.strokeWidth(t),this}strokeWidth(e){return this.setAttribute("stroke-width",e)}strokeOpacity(e){return this.setAttribute("stroke-opacity",e)}clipPath(e){return this.setAttribute("clip-path",e)}}r.Drawable=p;class f extends p{constructor(e){super("text"),null!=e&&this.text(e)}text(e){return this.el.textContent=e,this}fontFamily(e){return this.setAttribute("font-family",e)}fontSize(e,t){return this.setAttribute("font-size",a(e,t))}offset(e,t,n){return 0!==e&&this.setAttribute("dx",a(e,n)),0!==t&&this.setAttribute("dy",a(t,n)),this}anchor(e){return this.setAttribute("text-anchor",e)}}r.Text=f;class g extends p{constructor(){super("rect")}width(e,t=i.px){return this.setAttribute("width",a(e,t))}height(e,t=i.px){return this.setAttribute("height",a(e,t))}corner(e){return this.corners(e,e)}corners(e,t){return this.setAttribute("rx",e),this.setAttribute("ry",t),this}size(e,t,n=i.px){return this.width(e,n),this.height(t,n),this}}r.Rect=g;class m extends p{constructor(){super("circle")}at(e,t){return this.setAttribute("cx",e),this.setAttribute("cy",t),this}radius(e){return this.setAttribute("r",e)}}r.Circle=m;class b extends p{constructor(){super("line")}at(e,t,n,i){return this.from(e,t),null!=n&&null!=i&&this.to(n,i),this}from(e,t){return this.setAttribute("x1",e),this.setAttribute("y1",t),this}to(e,t){return this.setAttribute("x2",e),this.setAttribute("y2",t),this}}r.Line=b;class y extends p{points(e){return this.setAttribute("points",e)}with(e){return this.points(e.map(({x:e,y:t})=>e+" "+t).join(","))}}r.PolyElement=y;class v extends y{constructor(){super("polyline")}}r.Polyline=v;class w extends y{constructor(){super("polygon")}}r.Polygon=w;class k extends p{constructor(){super("path"),this.d=new C}update(){return this.setAttribute("d",this.d.toAttribute())}path(e){return e(this.d),this.update()}}r.Path=k,r.Image=class extends p{constructor(){super("image")}src(e){return this.setAttributeNS("http://www.w3.org/1999/xlink","href",e)}width(e,t=i.px){return this.setAttribute("width",a(e,t))}height(e,t=i.px){return this.setAttribute("height",a(e,t))}size(e,t,n=i.px){return this.width(e,n),this.height(t,n),this}};class A extends o{units(e){return this.setAttribute("gradientUnits",e===t.objectBoundingBox?"objectBoundingBox":"userSpaceOnUse")}stop(e,t,n){var i=s("stop");return i.setAttribute("offset",e+"%"),null!=t&&i.setAttribute("stop-color",t),null!=n&&i.setAttribute("stop-opacity",n),this.el.appendChild(i),this}}r.Gradient=A;class T extends A{constructor(){super("linearGradient")}start(e,t){return this.setAttribute("x1",e),this.setAttribute("y1",t),this}end(e,t){return this.setAttribute("x2",e),this.setAttribute("y2",t),this}}r.LinearGradient=T;class x extends A{constructor(){super("radialGradient")}center(e,t){return this.setAttribute("cx",e),this.setAttribute("cy",t),this}focus(e,t,n){return this.setAttribute("fx",e),this.setAttribute("fy",t),this.setAttribute("fr",n),this}radius(e){return this.setAttribute("r",e)}}r.RadialGradient=x;class E extends l{constructor(){super("clipPath")}clipPathUnits(e){return e?this.setAttribute("clipPathUnits","objectBoundingBox"):this.setAttribute("clipPathUnits","userSpaceOnUse")}}function s(e){return document.createElementNS("http://www.w3.org/2000/svg",e)}r.ClipPath=E;class C{constructor(){this.ops=[]}clear(){this.ops=[]}moveTo(e,t){return this.op("M",e,t)}moveBy(e,t){return this.op("m",e,t)}lineTo(e,t){return this.op("L",e,t)}lineBy(e,t){return this.op("l",e,t)}cCurveTo(e,t,n,i,r,s){return this.op("C",e,t,n,i,r,s)}cCurveBy(e,t,n,i,r,s){return this.op("c",e,t,n,i,r,s)}qCurveTo(e,t,n,i){return this.op("Q",e,t,n,i)}qCurveBy(e,t,n,i){return this.op("q",e,t,n,i)}sCurveTo(e,t,n,i){return this.op("S",e,t,n,i)}sCurveBy(e,t,n,i){return this.op("s",e,t,n,i)}tCurveTo(e,t){return this.op("T",e,t)}tCurveBy(e,t){return this.op("t",e,t)}arcTo(e,t,n,i,r,s,a){return this.op("A",e,t,n,i?1:0,r?1:0,s,a)}arcBy(e,t,n,i,r,s,a){return this.op("a",e,t,n,i?1:0,r?1:0,s,a)}close(){return this.op("z")}toAttribute(){return this.ops.map(e=>e.op+" "+e.args.join(" ")).join(" ")}op(e,...t){return this.ops.push({op:e,args:t}),this}}function a(e,t){switch(t){case i.em:return e+"em";case i.ex:return e+"ex";case i.px:return e+"px";case i.in:return e+"in";case i.cm:return e+"cm";case i.mm:return e+"mm";case i.pt:return e+"pt";case i.pc:return e+"pc";case i.percent:return e+"%";default:return e.toString()}}r.PathContext=C}}(pxt=pxt||{}),function(e){function n(){return"undefined"!=typeof window&&("ontouchstart"in window||navigator&&0<navigator.maxTouchPoints)}function i(){return"undefined"!=typeof window&&!!window.PointerEvent}(e=(e=e.svgUtil||(e.svgUtil={})).events||(e.events={})).isTouchEnabled=n,e.hasPointerEvents=i,e.down=function(e,t){i()?e.addEventListener("pointerdown",t):n()?(e.addEventListener("mousedown",t),e.addEventListener("touchstart",t)):e.addEventListener("mousedown",t)},e.up=function(e,t){i()?e.addEventListener("pointerup",t):(n(),e.addEventListener("mouseup",t))},e.enter=function(e,t){i()?e.addEventListener("pointerover",e=>{t(!!(1&e.buttons))}):n()?e.addEventListener("touchstart",e=>{t(!0)}):e.addEventListener("mouseover",e=>{t(!!(1&e.buttons))})},e.leave=function(e,t){i()?e.addEventListener("pointerleave",t):n()?e.addEventListener("touchend",t):e.addEventListener("mouseleave",t)},e.move=function(e,t){i()?e.addEventListener("pointermove",t):n()?e.addEventListener("touchmove",t):e.addEventListener("mousemove",t)},e.click=function(e,t){e.addEventListener("click",t)}}(pxt=pxt||{}),function(e){e=e.svgUtil||(e.svgUtil={});{var t=e.helpers||(e.helpers={});class n extends e.Text{at(e,t){return this.cx=e,this.cy=t,this.rePosition(),this}text(e,t=12){return super.text(e),this.fontSizePixels=t,this.setAttribute("font-size",t+"px"),this.rePosition(),this}rePosition(){null!=this.cx&&null!=this.cy&&null!=this.fontSizePixels&&(this.setAttribute("x",this.cx),this.setAttribute("y",this.cy),this.setAttribute("text-anchor","middle"),this.setAttribute("alignment-baseline","middle"))}}t.CenteredText=n}}(pxt=pxt||{}),function(h){h.IMAGE_MIME_TYPE="image/x-mkcd-f4",h.TILEMAP_MIME_TYPE="application/mkcd-tilemap",h.ANIMATION_MIME_TYPE="application/mkcd-animation";class t{constructor(){this.assets=[],this.takenNames={},this.listeners=[]}add(e){return this.takenNames[e.id]?this.update(e.id,e):(e=s(e),this.takenNames[e.id]=!0,this.takenNames[d(e)]=!0,e.meta.displayName&&e.meta.displayName!==e.id&&(this.takenNames[e.meta.displayName]&&(e.meta.displayName=this.generateNewDisplayName(e.meta.displayName)),this.takenNames[e.meta.displayName]=!0),this.assets.push(e),s(e))}getSnapshot(t){return(t?this.assets.filter(e=>t(e)):this.assets).map(s)}update(e,t){let n;return this.takenNames[e]?l(this.lookupByID(e),t)?n=t:(this.removeByID(e),n=this.add(t),this.notifyListener(t.internalID)):n=this.add(t),n}removeByID(t){var e=this.lookupByID(t);this.assets=this.assets.filter(e=>e.id!==t),delete this.takenNames[t],e&&delete this.takenNames[d(e)],null!=e&&e.meta.displayName&&delete this.takenNames[null==e?void 0:e.meta.displayName]}getByID(e){e=this.lookupByID(e);return e&&s(e)}getByDisplayName(e){if(this.takenNames[e])for(const t of this.assets)if(t.meta.displayName===e||d(t)===e)return s(t)}isIDTaken(e){return!!this.takenNames[e]}clone(){var e=new t;return e.assets=this.getSnapshot(),e.takenNames=Object.assign({},this.takenNames),e}serializeToJRes(e={}){for(const t of this.assets)i(t,e);return e}addListener(e,t){this.listeners.push({internalID:e,callback:t})}removeListener(t){this.listeners=this.listeners.filter(e=>e.callback!==t)}diff(e){let t={before:[],after:[]},n={};for(const i of e.assets){n[i.internalID]=!0;const e=this.lookupByInternalID(i.internalID);e&&l(i,e)||(t.before.push(i),t.after.push(e))}for(const e of this.assets.filter(e=>!n[e.internalID]))t.before.push(null),t.after.push(e);return t}applyDiff(e,t=!1){var n=t?e.after:e.before,i=t?e.before:e.after;h.Util.assert(n.length===i.length);for(let e=0;e<n.length;e++)n[e]?(this.removeByInternalID(n[e].internalID),i[e]&&this.assets.push(i[e]),this.notifyListener(n[e].internalID)):(this.assets.push(i[e]),this.notifyListener(i[e].internalID));this.takenNames={};for(const e of this.assets)h.Util.assert(!this.takenNames[e.id]),this.takenNames[e.id]=!0,this.takenNames[d(e)]=!0,e.meta.displayName&&(e.meta.displayName!==e.id&&h.Util.assert(!this.takenNames[e.meta.displayName]),this.takenNames[e.meta.displayName]=!0)}lookupByID(e){for(const t of this.assets)if(t.id===e)return t;return null}lookupByInternalID(e){for(const t of this.assets)if(t.internalID===e)return t;return null}removeByInternalID(t){this.assets=this.assets.filter(e=>e.internalID!==t)}notifyListener(e){for(const t of this.listeners)t.internalID===e&&t.callback()}generateNewDisplayName(e){e=e.replace(/\d+$/,"");let t=0;for(;this.takenNames[e+t];)++t;return e+t}}function r(e){var t=[];for(const i of Object.keys(e)){var n=e[i];n.mimeType===h.TILEMAP_MIME_TYPE&&t.push(n)}return t}function a(e,t){return`
    helpers._registerFactory("${e}", function(name: string) {
        switch(helpers.stringTrim(name)) {
`+t.map(e=>e.keys.filter(e=>!!e).map(e=>`            case "${e}":`).join("\n")+`return ${e.expression};`).join("\n")+"\n        }\n        return null;\n    })\n"}function n(e){return h.sprite.Bitmap.fromData(e).copy().data()}function o(e,t){var n=atob(e.data),n=h.U.fromHex(n),i=n[1]|n[2]<<8,r=n[3]|n[4]<<8,e={tileWidth:n[0],tiles:e.tileset.map(e=>t&&t(e)||{id:e})},s=n.slice(5,5+i*r),a=new h.sprite.Tilemap(i,r,0,0,new Uint8ClampedArray(s)),n=n.slice(5+s.length),s=new h.sprite.Bitmap(i,r,0,0,new Uint8ClampedArray(n)).data();return new h.sprite.TilemapData(a,e,s)}function s(e){switch(e.meta=Object.assign({},e.meta),e.type){case"tile":case"image":return Object.assign(Object.assign({},e),{bitmap:n(e.bitmap)});case"animation":return Object.assign(Object.assign({},e),{frames:e.frames.map(e=>n(e))});case"tilemap":return Object.assign(Object.assign({},e),{data:e.data.cloneData()})}}function i(e,t){var n,i,r,s,a=e.id.substr(e.id.lastIndexOf(".")+1);switch(e.type){case"image":t[a]=e.jresData,e.meta.displayName&&(t[a]={data:e.jresData,mimeType:h.IMAGE_MIME_TYPE,displayName:e.meta.displayName});break;case"tile":t[a]={data:e.jresData,mimeType:h.IMAGE_MIME_TYPE,tilemapTile:!0,displayName:e.meta.displayName};break;case"tilemap":n=e.data,i=e.id,r=e.meta.displayName,o=n.tilemap.data(),(s=new Uint8ClampedArray(5+o.data.length+n.layers.data.length))[0]=n.tileset.tileWidth,s[1]=255&o.width,s[2]=o.width>>8&255,s[3]=255&o.height,s[4]=o.height>>8&255,s.set(o.data,5),s.set(n.layers.data,5+o.data.length);var o={id:i,mimeType:h.TILEMAP_MIME_TYPE,data:btoa(h.sprite.uint8ArrayToHex(s)),tileset:n.tileset.tiles.map(e=>e.id),displayName:r};t[o.id]=o;break;case"animation":t[a]={namespace:(i=e).id.substr(0,i.id.lastIndexOf(".")),id:i.id.substr(i.id.lastIndexOf(".")+1),mimeType:h.ANIMATION_MIME_TYPE,data:h.sprite.encodeAnimationString(i.frames,i.interval),displayName:i.meta.displayName}}}function l(e,t){if(e==t)return!0;if(e.id!==t.id||e.type!==t.type||!p(e.meta.tags,t.meta.tags)||!p(e.meta.blockIDs,t.meta.blockIDs)||e.meta.displayName!==t.meta.displayName)return!1;switch(e.type){case"image":case"tile":return h.sprite.bitmapEquals(e.bitmap,t.bitmap);case"animation":return e.interval===t.interval&&p(e.frames,t.frames,h.sprite.bitmapEquals);case"tilemap":return e.data.equals(t.data)}}function c(e){e=/^\s*(?:(?:assets\s*\.\s*(image|tile|animation|tilemap))|(tilemap))\s*(?:`|\(""")([^`"]+)(?:`|"""\))\s*$/m.exec(e);if(e)return{type:e[1]||e[2],name:e[3].trim()}}function d(e){return u(e.type,e.id)}function u(e,t,n=!1){let i;switch(e){case"image":i=h.sprite.IMAGES_NAMESPACE+".";break;case"tile":i=h.sprite.TILE_NAMESPACE+".";break;case"tilemap":i="";break;case"animation":i=h.sprite.ANIMATION_NAMESPACE+"."}if(i)if(t.startsWith(i)){const h=t.substr(i.length);if(-1===h.indexOf("."))return h}else if(!n)return null;return t}function p(t,n,i=(e,t)=>e===t){if(t!=n){if(!t&&n||!n&&t||t.length!==n.length)return!1;for(let e=0;e<t.length;e++)if(!i(t[e],n[e]))return!1}return!0}function f(e){var t=atob(e.data),n=new Uint8ClampedArray(h.U.fromHex(t)),t=g(n,0),i=g(n,2),r=g(n,4),s=g(n,6),a=Math.ceil(i*r/2);let o=8;var l=[];for(let e=0;e<s;e++){const h=n.slice(o,o+a);l.push({x0:0,y0:0,width:i,height:r,data:h}),o+=a}let c=e.id;return{type:"animation",internalID:0,id:c=c.startsWith(e.namespace)?c:(c=e.namespace+"."+c).replace(/\.\./g,"."),interval:t,frames:l,meta:{displayName:e.displayName}}}function g(e,t){return e[t]|e[t+1]<<8}h.TilemapProject=class{constructor(){this.needsRebuild=!0,this.nextID=0,this.nextInternalID=0,this.committedState={revision:0,tilemaps:new t,tiles:new t,animations:new t,images:new t},this.state={revision:this.nextID++,tilemaps:new t,tiles:new t,animations:new t,images:new t},this.gallery={revision:0,tilemaps:new t,tiles:new t,animations:new t,images:new t},this.undoStack=[],this.redoStack=[]}getNewInternalId(){return this.nextInternalID++}createNewImage(e=16,t=16){var n=this.generateNewID("image"),e=new h.sprite.Bitmap(e,t).data(),t={internalID:this.getNewInternalId(),id:n,type:"image",bitmap:e,meta:{},jresData:h.sprite.base64EncodeBitmap(e)};return this.state.images.add(t)}createNewAnimation(e=16,t=16){var n=this.generateNewID("animation"),e=new h.sprite.Bitmap(e,t).data(),t={internalID:this.getNewInternalId(),id:n,type:"animation",frames:[e],interval:500,meta:{}};return this.state.animations.add(t)}createNewAnimationFromData(e,t=500,n){var i=this.generateNewID("animation"),i={internalID:this.getNewInternalId(),id:i,type:"animation",frames:e,interval:t,meta:{displayName:n}};return this.state.animations.add(i)}getGalleryTiles(t){return this.extensionTileSets?this.extensionTileSets.map(e=>e.tileSets.find(e=>e.tileWidth===t)).filter(e=>null==e?void 0:e.tiles.length):null}getProjectImages(){return this.state.images.getSnapshot()}getProjectTiles(t,e){var n=this.state.tiles.getSnapshot(e=>e.bitmap.width===t);return 0===n.length?e?(this.createNewTile(new h.sprite.Bitmap(t,t).data()),this.getProjectTiles(t,!1)):null:{tileWidth:t,tiles:n}}createNewTile(e,t,n){this.onChange(),t&&!this.isNameTaken("tile",t)||(t=this.generateNewID("tile"));t={internalID:this.getNewInternalId(),id:t,type:"tile",jresData:h.sprite.base64EncodeBitmap(e),bitmap:e,meta:{displayName:n},isProjectTile:!0};return this.state.tiles.add(t)}createNewProjectImage(e,t){this.onChange();t={internalID:this.getNewInternalId(),id:this.generateNewID("image"),type:"image",jresData:h.sprite.base64EncodeBitmap(e),meta:{displayName:t},bitmap:e};return this.state.images.add(t)}updateTile(t){this.onChange();var e=this.resolveProjectTileByInternalID(t.internalID);if(e){if(this.state.tiles.update(e.id,t),e.id!==t.id||!h.sprite.bitmapEquals(e.bitmap,t.bitmap))for(const h of this.getAssets("tilemap"))h.data.tileset.tiles.some(e=>e.internalID===t.internalID)&&(h.data.tileset.tiles=h.data.tileset.tiles.map(e=>e.internalID===t.internalID?t:e),this.updateTilemap(h.id,h.data));return t}return null}deleteTile(e){this.onChange(),this.state.tiles.removeByID(e)}getProjectTilesetJRes(){var e={};return this.state.tiles.serializeToJRes(e),this.state.tilemaps.serializeToJRes(e),e["*"]={mimeType:"image/x-mkcd-f4",dataEncoding:"base64",namespace:h.sprite.TILE_NAMESPACE},e}getProjectAssetsJRes(){var e={};return this.state.images.serializeToJRes(e),this.state.animations.serializeToJRes(e),e["*"]={mimeType:"image/x-mkcd-f4",dataEncoding:"base64",namespace:h.sprite.IMAGES_NAMESPACE},e}getTilemap(e){return this.state.tilemaps.getByID(e)}updateTilemap(e,t){var n=this.state.tilemaps.getByID(e);return n?(this.onChange(),n=Object.assign(Object.assign({},n),{data:t}),this.state.tilemaps.update(e,n),n):null}createNewTilemap(e,t,n=16,i=16){return this.createNewTilemapFromData(this.blankTilemap(t,n,i),e)}blankTilemap(e,t=16,n=16){var i=new h.sprite.Tilemap(t,n),t=new h.sprite.Bitmap(t,n),n={tileWidth:e,tiles:[this.getTransparency(e)]};return new h.sprite.TilemapData(i,n,t.data())}resolveTile(e){return this.lookupAsset("tile",e)}resolveProjectTileByInternalID(t){return this.state.tiles.getSnapshot(e=>e.internalID===t)[0]}resolveTileByBitmap(e){const t=h.sprite.base64EncodeBitmap(e);return this.state.tiles.getSnapshot(e=>e.jresData===t)[0]}getTransparency(e){var t=h.sprite.TILE_NAMESPACE+".transparency"+e;let n=this.state.tiles.getByID(t);return n||(e=new h.sprite.Bitmap(e,e).data(),n={internalID:this.getNewInternalId(),id:t,type:"tile",bitmap:e,jresData:h.sprite.base64EncodeBitmap(e),meta:{},isProjectTile:!0},this.state.tiles.add(n))}createNewTilemapFromData(e,t){this.onChange();t=this.generateNewIDInternal("tilemap",t||lf("level"));return this.state.tilemaps.add({internalID:this.getNewInternalId(),id:t,type:"tilemap",meta:{displayName:t},data:e}),[t,e]}cloneState(){return{revision:this.state.revision,images:this.state.images.clone(),tilemaps:this.state.tilemaps.clone(),animations:this.state.animations.clone(),tiles:this.state.tiles.clone()}}undo(){var e;this.state.revision!==this.committedState.revision&&this.pushUndo(),this.undoStack.length&&(e=this.undoStack.pop(),this.state.tiles.applyDiff(e.tiles,!0),this.state.images.applyDiff(e.images,!0),this.state.tilemaps.applyDiff(e.tilemaps,!0),this.state.animations.applyDiff(e.animations,!0),this.state.revision=e.beforeRevision,this.redoStack.push(e),this.committedState=this.cloneState(),this.needsRebuild=!0)}redo(){var e;this.redoStack.length&&(e=this.redoStack.pop(),this.state.tiles.applyDiff(e.tiles),this.state.images.applyDiff(e.images),this.state.tilemaps.applyDiff(e.tilemaps),this.state.animations.applyDiff(e.animations),this.state.revision=e.afterRevision,this.undoStack.push(e),this.committedState=this.cloneState(),this.needsRebuild=!0)}pushUndo(){this.undoStack.length&&this.committedState.revision===this.state.revision||(this.redoStack=[],this.undoStack.push({beforeRevision:this.committedState.revision,afterRevision:this.state.revision,tiles:this.state.tiles.diff(this.committedState.tiles),images:this.state.images.diff(this.committedState.images),tilemaps:this.state.tilemaps.diff(this.committedState.tilemaps),animations:this.state.animations.diff(this.committedState.animations)}),this.committedState=this.cloneState(),this.cleanupTemporaryAssets())}revision(){return this.state.revision}encodeTilemap(e,t){var n=e.tilemap.data(),i=new Uint8ClampedArray(5+n.data.length+e.layers.data.length);return i[0]=e.tileset.tileWidth,i[1]=255&n.width,i[2]=n.width>>8&255,i[3]=255&n.height,i[4]=n.height>>8&255,i.set(n.data,5),i.set(e.layers.data,5+n.data.length),{id:t,mimeType:h.TILEMAP_MIME_TYPE,data:btoa(h.sprite.uint8ArrayToHex(i)),tileset:e.tileset.tiles.map(e=>e.id)}}forceUpdate(){this.onChange()}isNameTaken(t,e){var n=e=>{switch(t){case"image":return this.state.images.isIDTaken(e)||this.gallery.images.isIDTaken(e);case"tile":return this.state.tiles.isIDTaken(e)||this.gallery.tiles.isIDTaken(e);case"tilemap":return this.state.tilemaps.isIDTaken(e)||this.gallery.tilemaps.isIDTaken(e);case"animation":return this.state.animations.isIDTaken(e)||this.gallery.animations.isIDTaken(e)}},i=u(t,e),r=i&&i!==e;return n(e)||r&&n(i)}isAssetUsed(n,i,r){var s,a,o;if(0<((null==(a=null==(s=n.meta)?void 0:s.blockIDs)?void 0:a.filter(e=>!r||(null==r?void 0:r.indexOf(e))<0))||[]).length)return!0;if("tile"==n.type)for(const h of this.getAssets("tilemap"))if(!(0<=(null==r?void 0:r.indexOf(h.id)))&&h.data.tileset.tiles.some(e=>e.id===n.id))return!0;if(i){const s=h.Util.escapeForRegex(d(n)),a=h.Util.escapeForRegex(null==(o=n.meta)?void 0:o.displayName)||"";let e;switch(n.type){case"tile":e=`myTiles.${s}|assets.tile\`${s}\``,a&&(e+=`|assets.tile\`${a}\``);break;case"tilemap":e=`tilemap\`${s}\``;break;case"animation":e=`assets.animation\`${s}\``,a&&(e+=`|assets.animation\`${a}\``);break;default:e=`assets.image\`${s}\``,a&&(e+=`|assets.image\`${a}\``)}var l=new RegExp(e,"gm");let t;switch(n.type){case"tile":t=`myTiles.${s}|assets.tile("""${s}""")`,a&&(t+=`|assets.tile("""${a}""")`);break;case"tilemap":t=`assets.tilemap("""${s}""")`;break;case"animation":t=`assets.animation("""${s}""")`,a&&(t+=`|assets.animation("""${a}""")`);break;default:t=`assets.image("""${s}""")`,a&&(t+=`|assets.image("""${a}""")`)}var c,u=new RegExp(t,"gm");for(c of Object.keys(i))if(!(0<=(null==r?void 0:r.indexOf(c)))){const n=i[c];if(c.match(/((?!\.g).{2}|^.{0,1})\.ts$/i)){if(n.content.match(l))return!0}else if(c.endsWith(".py")&&n.content.match(u))return!0}}return!1}lookupAsset(e,t){switch(e){case"image":return this.state.images.getByID(t)||this.gallery.images.getByID(t);case"tile":return this.state.tiles.getByID(t)||this.gallery.tiles.getByID(t);case"tilemap":return this.state.tilemaps.getByID(t)||this.gallery.tilemaps.getByID(t);case"animation":return this.state.animations.getByID(t)||this.gallery.animations.getByID(t)}}lookupAssetByName(e,t){switch(e){case"image":return this.state.images.getByDisplayName(t);case"tile":return this.state.tiles.getByDisplayName(t);case"tilemap":return this.state.tilemaps.getByDisplayName(t);case"animation":return this.state.animations.getByDisplayName(t)}}getAssets(e){switch(e){case"image":return this.state.images.getSnapshot();case"tile":return this.state.tiles.getSnapshot();case"tilemap":return this.state.tilemaps.getSnapshot();case"animation":return this.state.animations.getSnapshot()}}getGalleryAssets(e){switch(e){case"image":return this.gallery.images.getSnapshot();case"tile":return this.gallery.tiles.getSnapshot();case"tilemap":return this.gallery.tilemaps.getSnapshot();case"animation":return this.gallery.animations.getSnapshot()}}lookupBlockAsset(e,t){var n=e=>{return-1!==(null==(e=null==(e=e.meta)?void 0:e.blockIDs)?void 0:e.indexOf(t))};switch(e){case"image":return this.state.images.getSnapshot(n)[0];case"tile":return this.state.tiles.getSnapshot(n)[0];case"tilemap":return this.state.tilemaps.getSnapshot(n)[0];case"animation":return this.state.animations.getSnapshot(n)[0]}}updateAsset(e){switch(this.onChange(),e.type){case"image":return this.state.images.update(e.id,e);case"tile":return this.updateTile(e);case"tilemap":return this.state.tilemaps.update(e.id,e);case"animation":return this.state.animations.update(e.id,e)}}duplicateAsset(e,t){this.onChange();var n=s(e),i=t||(null==(t=n.meta)?void 0:t.displayName);let r;switch(e.type){case"image":r=this.createNewProjectImage(n.bitmap,i);break;case"tile":r=this.createNewTile(n.bitmap,null,i);break;case"tilemap":const[e,t]=this.createNewTilemapFromData(n.data,i);r=this.getTilemap(e);break;case"animation":r=this.createNewAnimationFromData(n.frames,n.interval,i)}return r}removeAsset(e){switch(this.onChange(),e.type){case"image":return this.state.images.removeByID(e.id);case"tile":return this.state.tiles.removeByID(e.id);case"tilemap":return this.state.tilemaps.removeByID(e.id);case"animation":return this.state.animations.removeByID(e.id)}}addChangeListener(e,t){switch(e.type){case"image":this.state.images.addListener(e.internalID,t);break;case"tile":this.state.tiles.addListener(e.internalID,t);break;case"tilemap":this.state.tilemaps.addListener(e.internalID,t);break;case"animation":this.state.animations.addListener(e.internalID,t)}}removeChangeListener(e,t){switch(e){case"image":this.state.images.removeListener(t);break;case"tile":this.state.tiles.removeListener(t);break;case"tilemap":this.state.tilemaps.removeListener(t);break;case"animation":this.state.animations.removeListener(t)}}loadPackage(e){const t=e.sortedDeps();this.extensionTileSets=[];for(const e of t){const t="this"===e.id,r=this.readImages(e.parseJRes(),t);for(const e of r)("tile"===e.type?(t?this.state:this.gallery).tiles:"image"===e.type?(t?this.state:this.gallery).images:(t?this.state:this.gallery).animations).add(e)}for(const t of r(e.parseJRes()))this.state.tilemaps.add({internalID:this.getNewInternalId(),type:"tilemap",id:t.id,meta:{displayName:t.displayName||t.id},data:o(t,e=>this.resolveTile(e))});this.committedState=this.cloneState(),this.undoStack=[],this.redoStack=[]}loadTilemapJRes(e,t=!1){e=h.inflateJRes(e);var n=this.readImages(e,!0).filter(e=>"tile"===e.type);let i={};for(const h of n){if(t){const e=this.resolveTileByBitmap(h.bitmap);if(e){i[h.id]=e.id;continue}}const e=this.createNewTile(h.bitmap,h.id,h.meta.displayName);e.id!==h.id&&(i[h.id]=e.id)}for(const h of r(e))this.state.tilemaps.add({internalID:this.getNewInternalId(),type:"tilemap",id:h.id,meta:{displayName:h.displayName||h.id},data:o(h,e=>(i[e]&&(e=i[e]),this.resolveTile(e)))})}loadAssetsJRes(e){e=h.inflateJRes(e);var t=[];for(const i of Object.keys(e)){var n=e[i];if(n.tilemapTile)this.state.tiles.add(this.generateImage(n,"tile"));else if(n.mimeType===h.IMAGE_MIME_TYPE)this.state.images.add(this.generateImage(n,"image"));else if(n.mimeType===h.ANIMATION_MIME_TYPE){const[h,e]=this.generateAnimation(n);e?t.push(h):this.state.animations.add(h)}}for(const h of t)this.state.animations.add(this.inflateAnimation(h,this.state.images.getSnapshot()))}removeInactiveBlockAssets(i){function e(e){var t=e.getSnapshot(e=>{return!e.meta.displayName&&(null==(e=e.meta.blockIDs)?void 0:e.some(e=>-1===i.indexOf(e)))}),n=[];for(const e of t)1!==e.meta.blockIDs.length&&(e.meta.blockIDs=e.meta.blockIDs.filter(e=>-1!==i.indexOf(e)),0!==e.meta.blockIDs.length)||n.push(e);for(const i of n)e.removeByID(i.id)}e(this.state.images),e(this.state.tiles),e(this.state.tilemaps),e(this.state.animations)}generateImage(e,t){return{internalID:this.getNewInternalId(),type:t,id:e.id,meta:{displayName:e.displayName},jresData:e.data,bitmap:h.sprite.getBitmapFromJResURL(`data:${h.IMAGE_MIME_TYPE};base64,`+e.data).data()}}generateAnimation(t){if("json"!==t.dataEncoding)return[Object.assign(Object.assign({},f(t)),{internalID:this.getNewInternalId()}),!1];{let e;try{e=JSON.parse(t.data)}catch(e){console.warn("could not parse json data of '"+t.id+"'")}return[{internalID:this.getNewInternalId(),type:"animation",meta:{displayName:t.displayName},id:t.id,frames:[],frameIds:e.frames,interval:100,flippedHorizontal:e.flippedHorizontal},!0]}}inflateAnimation(e,n){return e.frames=e.frameIds.map(t=>n.find(e=>e.id===t).bitmap),e.flippedHorizontal&&(e.frames=e.frames.map(e=>{var n=h.sprite.Bitmap.fromData(e),i=new h.sprite.Bitmap(e.width,e.height);for(let t=0;t<i.width;t++)for(let e=0;e<i.height;e++)i.set(t,e,n.get(n.width-t-1,e));return i.data()})),e}generateNewID(e){switch(e){case"animation":return this.generateNewIDInternal("animation",h.sprite.ANIMATION_PREFIX,h.sprite.ANIMATION_NAMESPACE);case"image":return this.generateNewIDInternal("image",h.sprite.IMAGE_PREFIX,h.sprite.IMAGES_NAMESPACE);case"tile":return this.generateNewIDInternal("tile",h.sprite.TILE_PREFIX,h.sprite.TILE_NAMESPACE);case"tilemap":return this.generateNewIDInternal("tilemap",lf("level"))}}generateNewIDInternal(e,t,n){t=t.replace(/\d+$/,"");var i=n?n+"."+t:t;let r=1;for(;this.isNameTaken(e,i+r);)++r;return i+r}onChange(){this.needsRebuild=!0,this.state.revision=this.nextID++}readImages(e,t=!1){var n=[],i=[];for(const s of Object.keys(e)){var r=e[s];if(r.tilemapTile){const h=this.generateImage(r,"tile");h.isProjectTile=t,n.push(h)}else if(r.mimeType===h.IMAGE_MIME_TYPE)n.push(this.generateImage(r,"image"));else if(r.mimeType===h.ANIMATION_MIME_TYPE){const[h,e]=this.generateAnimation(r);(e?i:n).push(h)}}for(const h of i)n.push(this.inflateAnimation(h,n));return n}cleanupTemporaryAssets(){for(const e of this.state.images.getSnapshot(e=>{return!(e.meta.displayName||null!=(e=e.meta.blockIDs)&&e.length)}))this.state.images.removeByID(e.id)}},h.emitTilemapsFromJRes=function(e){const t=Object.keys(e);let n="";var i=[],r=[];for(const a of t)if("*"!==a){const t=e[a];if(t.tilemapTile&&(n=(n+="    //% fixedInstance jres blockIdentity=images._tile\n")+`    export const ${a} = image.ofBuffer(hex\`\`);
`,r.push({keys:[t.displayName,u("tile",a,!0)],expression:a})),t.mimeType===h.TILEMAP_MIME_TYPE){const e=o(t);i.push({keys:[t.displayName,u("tilemap",t.id)],expression:h.sprite.encodeTilemap(e,"typescript")})}}i.length&&(n+=a("tilemap",i)),r.length&&(n+=a("tile",r));var s=lf("Auto-generated code. Do not edit.");return`// ${s}
namespace ${h.sprite.TILE_NAMESPACE} {
${n}
}
// ${s}
`},h.emitProjectImages=function(e){const n=Object.keys(e);var t="",i=[],r=[];for(const a of n)if("*"!==a){const n=e[a];if("string"==typeof n||n.mimeType===h.IMAGE_MIME_TYPE){let e,t=[u("image",a,!0)];"string"==typeof n?e=h.sprite.bitmapToImageLiteral(h.sprite.getBitmapFromJResURL(n),"typescript"):(e=h.sprite.bitmapToImageLiteral(h.sprite.getBitmapFromJResURL(n.data),"typescript"),t.push(n.displayName)),i.push({keys:t,expression:e})}else if(n.mimeType===h.ANIMATION_MIME_TYPE){const e=f(n);r.push({keys:[n.displayName,u("animation",a,!0)],expression:`[${e.frames.map(e=>h.sprite.bitmapToImageLiteral(h.sprite.Bitmap.fromData(e),"typescript")).join(", ")}]`})}}var s=lf("Auto-generated code. Do not edit."),t=(t+=a("image",i))+a("animation",r);return`// ${s}
namespace ${h.sprite.IMAGES_NAMESPACE} {
${t}
}
// ${s}
`},h.cloneAsset=s,h.assetEquals=l,h.validateAssetName=function(e){return!!e&&!/[\u0000-\u001f\u0021-\u002c\u002e\u002f\u003a-\u0040\u005b-\u005e\u0060\u007b-\u007f]/.test(e)},h.getTSReferenceForAsset=function(e,t=!1){var n,i=null!=(n=e.meta)&&n.displayName?e.meta.displayName:d(e);if(!i)return"image"===e.type||"tile"===e.type?e.id:void 0;var r=t?'("""':"`",s=t?'""")':"`";switch(e.type){case"tile":return"assets.tile"+r+i+s;case"image":return"assets.image"+r+i+s;case"animation":return"assets.animation"+r+i+s;case"tilemap":return"tilemap"+r+i+s}},h.parseAssetTSReference=c,h.lookupProjectAssetByTSReference=function(e,t){var n=c(e);if(n){const{type:e,name:i}=n;switch(e){case"tile":return t.lookupAssetByName("tile",i);case"image":return t.lookupAssetByName("image",i);case"tilemap":return t.lookupAssetByName("tilemap",i)||t.lookupAsset("tilemap",i);case"animation":return t.lookupAssetByName("animation",i)}}},h.getDefaultAssetDisplayName=function(e){switch(e){case"image":return lf("myImage");case"tile":return lf("myTile");case"tilemap":return lf("level");case"animation":return lf("myAnim");default:return lf("asset")}},h.getShortIDForAsset=d}(pxt=pxt||{}),function(r){{var e=r.toolbox||(r.toolbox={});e.blockColors={loops:"#107c10",logic:"#006970",math:"#712672",variables:"#A80000",functions:"#005a9e",text:"#996600",arrays:"#A94400",advanced:"#3c3c3c",addpackage:"#717171",search:"#000",debug:"#e03030",default:"#dddddd",topblocks:"#aa8f00",recipes:"#717171"},e.blockIcons={loops:"",logic:"",math:"",variables:"",functions:"",text:"",arrays:"",advancedcollapsed:"",advancedexpanded:"",more:"",addpackage:"",search:"",debug:"",default:"",topblocks:"",recipes:""};let i="";function n(e){e=function(e,t){let n=0,i=0,r=0;var s=Math.floor(e/60),e=e/60-s,a=.55*t,o=t*(1-.45*e),l=t*(1-.45*(1-e));switch(s){case 1:n=o,i=t,r=a;break;case 2:n=a,i=t,r=l;break;case 3:n=a,i=o,r=t;break;case 4:n=l,i=a,r=t;break;case 5:n=t,i=a,r=o;break;case 6:case 0:n=t,i=l,r=a}return[Math.floor(n),Math.floor(i),Math.floor(r)]}(e,165.75);return"#"+t(e[0])+t(e[1])+t(e[2])}function t(e){e=e.toString(16);return 1==e.length?"0"+e:e}e.appendToolboxIconCss=function(e,t){var n;-1<i.indexOf(e)||(1===t.length?(n=r.Util.unicodeToChar(t),i+=`
                .blocklyTreeIcon.${e}::before {
                    content: "${n}";
                }
            `):i+=`
                .blocklyTreeIcon.${e} {
                    background-image: url("${r.Util.pathJoin(r.webConfig.commitCdnUrl,encodeURI(t))}")!important;
                    width: 30px;
                    height: 100%;
                    background-size: 20px !important;
                    background-repeat: no-repeat !important;
                    background-position: 50% 50% !important;
                }
            `)},e.getNamespaceColor=function(e){return e=e.toLowerCase(),r.appTarget.appTheme.blockColors&&r.appTarget.appTheme.blockColors[e]?r.appTarget.appTheme.blockColors[e]:r.toolbox.blockColors[e]||""},e.getNamespaceIcon=function(e){return e=e.toLowerCase(),r.appTarget.appTheme.blockIcons&&r.appTarget.appTheme.blockIcons[e]?r.appTarget.appTheme.blockIcons[e]:r.toolbox.blockIcons[e]||""},e.advancedTitle=function(){return r.Util.lf("{id:category}Advanced")},e.addPackageTitle=function(){return r.Util.lf("{id:category}Extensions")},e.recipesTitle=function(){return r.Util.lf("{id:category}Tutorials")},e.convertColor=function(e){e=(t=e)?"0x"==t.substring(0,2)?"#"+t.substring(2):t:"#000000";var t=parseInt(e);return isNaN(t)?e:n(t)},e.hueToRgb=n,e.fadeColor=function(t,n,i){(t=t.replace(/[^0-9a-f]/gi,"")).length<6&&(t=t[0]+t[0]+t[1]+t[1]+t[2]+t[2]);let r="#";for(let e=0;e<3;e++){var s=parseInt(t.substr(2*e,2),16),s=(s=Math.round(Math.min(Math.max(0,i?s+s*n:s-s*n),255))).toString(16);r+=("00"+s).substr(s.length)}return r}}}(pxt=pxt||{}),function(k){{var e=k.tutorial||(k.tutorial={});const E=/^##[^#](.*)$([\s\S]*?)(?=^##[^#]|$(?![\r\n]))/gim,C=/^###[^#](.*)$([\s\S]*?)(?=^###[^#]|$(?![\r\n]))/gim;function A(e,t,a){let n=t||E,o=[];if(e.replace(n,function(e,t,n){var{header:i,hint:r,requiredBlocks:s}=function(t,e,n){let i,r,s=t=T(t);if(e){const e=/#+ ~ tutorialhint([\s\S]*)/i;s=t.replace(e,function(e,t){return i=t,""})}else{const e=/(^[\s\S]*?\S)\s*((```|\[?\!\[[\s\S]+?\]\(\S+?\)\]?)[\s\S]*)/im;t=t.match(e);if(t&&2<t.length&&(s=t[1].trim(),i=t[2].trim(),n)){let e=t[2].trim();e=e.replace(/``` *(requiredTutorialBlock)\s*\n([\s\S]*?)\n```/gim,function(e,t,n){return r=`{
${n}
}`,""}),i=e}}return{header:s,hint:i,requiredBlocks:r}}(n=n.trim(),a&&a.explicitHints,a.tutorialCodeValidation),n={title:t.match(/^\{.*\}$/)?void 0:t.replace(/@(fullscreen|unplugged|showdialog|showhint|tutorialCompleted|resetDiff)/gi,"").trim(),contentMd:n,headerContentMd:i};return/@(fullscreen|unplugged|showdialog|showhint)/i.test(t)&&(n.showHint=!0),/@(unplugged|showdialog)/i.test(t)&&(n.showDialog=!0),/@tutorialCompleted/.test(t)&&(n.tutorialCompleted=!0),/@resetDiff/.test(t)&&(n.resetDiff=!0),r&&(n.hintContentMd=r),a.tutorialCodeValidation&&s&&(n.requiredBlockMd=s),o.push(n),""}),0!=e.indexOf("# Not found"))return o;k.debug("tutorial not found")}function T(e){return e&&e.replace(/```(filterblocks|package|ghost|config|template|jres|assetjson|customts)\s*\n([\s\S]*?)\n```/gim,"").trim()}function x(e){if(e)return e=JSON.parse(e),{[k.TILEMAP_JRES]:e[k.TILEMAP_JRES],[k.TILEMAP_CODE]:e[k.TILEMAP_CODE],[k.IMAGES_JRES]:e[k.IMAGES_JRES],[k.IMAGES_CODE]:e[k.IMAGES_CODE]}}e.parseTutorial=function(n){const{metadata:t,body:i}=function(){const i={},e=n.replace(/### @(\S+) ([ \S]+)/gi,function(e,t,n){try{i[t]=JSON.parse(n)}catch(e){i[t]=n}return""}),t=i;return void 0!==t.explicitHints&&k.appTarget.appTheme&&k.appTarget.appTheme.tutorialExplicitHints&&(t.explicitHints=!0),{metadata:t,body:e}}(),{steps:r,activities:s}=function(t,n){if(n&&n.activities){var o=n;let s=[],a=[];return t.replace(E,function(e,t,n){let i=a.length,r=(a.push({name:t||lf("Activity {0}",i),step:s.length}),A(n,C,o));return r=r.map(e=>(e.activity=i,e)),s=s.concat(r),""}),{steps:s,activities:a}}{let e=A(t,null,n);return{steps:e=!e||e.length<1?A(t,C,n):e,activities:null}}}(i,t),a=(o=i.match(/^#[^#](.*)$/im))&&1<o.length?o[1].trim():null;if(r){var{code:o,templateCode:l,editor:c,language:u,jres:h,assetJson:d,customTs:p,tutorialValidationRulesStr:f}=function(e){let t;let i,r,s,a,o,l,c=[];return e.replace(/((?!.)\s)+/g,"\n").replace(/``` *(sim|block|blocks|filterblocks|spy|ghost|typescript|ts|js|javascript|template|python|jres|assetjson|customts|tutorialValidationRules|requiredTutorialBlock)\s*\n([\s\S]*?)\n```/gim,function(e,t,n){switch(t){case"block":case"blocks":case"requiredTutorialBlock":case"filterblocks":if(u(k.BLOCKS_PROJECT_NAME))break;return;case"spy":case"python":if(!u(k.PYTHON_PROJECT_NAME))return;"python"==t&&(s=t);break;case"typescript":case"ts":case"javascript":case"js":if(u(k.JAVASCRIPT_PROJECT_NAME))break;return;case"template":r=n;break;case"jres":i=n;break;case"assetjson":a=n;break;case"customts":o=n,n="";break;case"tutorialValidationRules":l=n}return c.push("python"==t?`
${n}
`:`{
${n}
}`),""}),t=t||k.BLOCKS_PROJECT_NAME,{code:c,templateCode:r,editor:t,language:s,jres:i,assetJson:a,customTs:o,tutorialValidationRulesStr:l};function u(e){return t&&t!=e?(k.debug("tutorial ambiguous: contains snippets of different types"),0):(t=e,1)}}(i);let e;if(t.tutorialCodeValidation){e=k.Util.jsonTryParse(f);{var g=e;var m=a;var b=Object.keys(g);for(let e=0;e<b.length;e++){var y={ruleName:b[e],enabled:g[b[e]]?"true":"false",tutorial:m};k.tickEvent("tutorial.validation.setValidationRules",y)}}}if(!0===t.diffs||!1!==t.diffs&&!0!==t.noDiffs&&(c==k.BLOCKS_PROJECT_NAME&&k.appTarget.appTheme.tutorialBlocksDiff||c!=k.BLOCKS_PROJECT_NAME&&k.appTarget.appTheme.tutorialTextDiff)){f=r;var v=s;let l;function w(e){const a={typescript:"diff",spy:"diffspy",blocks:"diffblocks",python:"diff"},o=/\s*(\/\/|#)\s*@highlight/gm;return e&&e.replace(/```(typescript|spy|python|blocks|ghost|template)((?:.|[\r\n])+)```/,function(e,t,n){var i=l,r=/^(template|ghost)$/.test(t),s=o.test(n);return n=n.replace(/^\n+/,"").replace(/\n+$/,""),s&&(n=n.replace(o,"")),l=n,!i||s||r?e:`\`\`\`${a[t]}
${i}
----------
${n}
\`\`\``})}f.forEach((e,t)=>{if((e.resetDiff||v&&v.find(e=>e.step==t))&&(l=void 0),e.hintContentMd){const v=w(e.hintContentMd);if(v&&v!=e.hintContentMd)return void(e.hintContentMd=v)}if(e.headerContentMd){const v=w(e.headerContentMd);v&&v!=e.headerContentMd&&(e.headerContentMd=v)}})}f=x(d);return r.forEach(e=>{e.contentMd=T(e.contentMd),e.headerContentMd=T(e.headerContentMd),e.hintContentMd=T(e.hintContentMd),e.requiredBlockMd=T(e.requiredBlockMd)}),{editor:c,title:a,steps:r,activities:s,code:o,templateCode:l,metadata:t,language:u,jres:h,assetFiles:f,customTs:p,tutorialValidationRules:e}}},e.getMetadataRegex=function(){return/``` *(sim|block|blocks|filterblocks|spy|ghost|typescript|ts|js|javascript|template|python|jres|assetjson|customts|tutorialValidationRules|requiredTutorialBlock)\s*\n([\s\S]*?)\n```/gim},e.highlight=function(n){let i=n.textContent;if(i=(i=i.replace(/img\s*\(\s*"{3}[\s\da-f.#tngrpoyw]*"{3}\s*\)/g,'img(""" """)')).replace(/img\s*`[\s\da-f.#tngrpoyw]*`\s*/g,"img` `"),/@highlight/.test(i)){n.textContent="";var r=i.split("\n");for(let t=0;t<r.length;++t){0<t&&t<r.length&&n.appendChild(document.createTextNode("\n"));let e=r[t];if(/@highlight/.test(e)){if(void 0!==(e=r[++t])){const i=document.createElement("span");i.className="highlight-line",i.textContent=e,n.appendChild(i)}}else n.appendChild(document.createTextNode(e))}}else n.textContent=i},e.getTutorialOptions=function(e,t,n,i,r){var s=k.tutorial.parseTutorial(e);if(s)return{options:{tutorial:t,tutorialName:s.title||n,tutorialReportId:i,tutorialStep:0,tutorialReady:!0,tutorialHintCounter:0,tutorialStepInfo:s.steps,tutorialActivityInfo:s.activities,tutorialMd:e,tutorialCode:s.code,tutorialRecipe:!!r,templateCode:s.templateCode,autoexpandStep:!(null!=(t=s.metadata)&&t.autoexpandOff),metadata:s.metadata,language:s.language,jres:s.jres,assetFiles:s.assetFiles,customTs:s.customTs,tutorialValidationRules:s.tutorialValidationRules},editor:s.editor};throw new Error(lf("Invalid tutorial format"))},e.parseCachedTutorialInfo=function(e,i){let r=k.Util.jsonTryParse(e);return r?k.BrowserUtils.tutorialInfoDbAsync().then(e=>{if(i&&r[i]){var t=r[i];t.usedBlocks&&t.hash&&e.setWithHashAsync(i,t.snippetBlocks,t.hash)}else for(var n of Object.keys(r)){const i=r[n];i.usedBlocks&&i.hash&&e.setWithHashAsync(n,i.snippetBlocks,i.hash)}}).catch(e=>{}):Promise.resolve()},e.resolveLocalizedMarkdown=function(e,t,n){var n=(n||e.fileName||"README")+".md",[e,i,r]=k.Util.normalizeLanguageCode(k.Util.userLanguage()),r=e&&i&&r?t[`_locales/${e}/`+n]||t[`_locales/${r}/`+n]||t[`_locales/${i}/`+n]:t[`_locales/${e}/`+n];return r||t[n]},e.parseAssetJson=x}}(pxt=pxt||{}),function(u){(u.tutorial||(u.tutorial={})).validate=async function(n,e,i){var t,r=function(t){var n=[];if(null!=t){var i=Object.keys(t);for(let e=0;e<i.length;e++){var r=i[e],r={ruleName:r,ruleTurnOn:t[r]};n.push(r)}}return n}(n.tutorialValidationRules);if(0<r.length&&0<e.length){const i=function(t){var n={};for(let e=0;e<t.length;e++)n[t[e]]||(n[t[e]]=0),n[t[e]]=n[t[e]]+1;return n}(e.map(e=>e.type)),{tutorialStepInfo:a,tutorialStep:o}=n,l=(a[o],t=n,await u.BrowserUtils.tutorialInfoDbAsync().then(e=>e.getAsync(t.tutorial,t.tutorialCode).then(e=>null!=e&&e.snippets?Promise.resolve(e.snippets):Promise.resolve(void 0)))),c=function(e,t){var n=e["tutorialStep"],e=e.tutorialStepInfo[n].hintContentMd;let i="";null!=e&&e.replace(/((?!.)\s)+/g,"\n").replace(/``` *(block|blocks)\s*\n([\s\S]*?)\n```/gim,function(e,t,n){return i=`{
${n}
}`,""});n=u.BrowserUtils.getTutorialCodeHash([i]);let r={};return r=null!=t?t[n]:r}(n,l);for(let t=0;t<r.length;t++){let e=r[t];var s=r[t].ruleName;if(r[t].ruleTurnOn)switch(s){case"exact":e=function(t,n,e){e.isStrict=!0;var i=Object.keys(t);let r=[],s=[],a=(null!=n&&(r=Object.keys(n)),i.length>=r.length);i=lf("These are the blocks you seem to be missing:");for(let e=0;e<r.length;e++){var o=r[e];(!t[o]||t[o]<n[o])&&(s.push(o),a=!1)}return e.ruleMessage=i,e.ruleStatus=a,e.blockIds=s,e}(i,c,e);break;case"atleast":e=function(t,e,n){var i=Object.keys(t),r=Object.keys(null!=e?e:{});let s=i.length>=r.length;for(let e=0;e<r.length;e++)if(!t[r[e]]){s=!1;break}return n.ruleStatus=s,n}(i,c,e);break;case"required":e=function(t,e,n){n.isStrict=!0,Object.keys(t);let i=[],r=[],s=(null!=e&&(i=Object.keys(e)),!0);e=lf("You are required to have the following block:");for(let e=0;e<i.length;e++){var a=i[e];t[a]||(r.push(a),s=!1)}return n.ruleMessage=e,n.ruleStatus=s,n.blockIds=r,n}(i,function(e,t){var n=e["tutorialStep"],e=e.tutorialStepInfo[n].requiredBlockMd,n=u.BrowserUtils.getTutorialCodeHash([e]);let i={};return i=null!=t?t[n]:i}(n,l),e)}}}return r}}(pxt=pxt||{}),function(i){{var r=i.pxtc||(i.pxtc={}),e;let n;r.flattenDiagnosticMessageText=function(i,r){if("string"==typeof i)return i;{let e=i,t="",n=0;for(;e;){if(n){t+=r;for(let e=0;e<n;e++)t+="  "}t+=e.messageText,n++,e=e.next}return t}},(e=n=r.ScriptTarget||(r.ScriptTarget={}))[e.ES3=0]="ES3",e[e.ES5=1]="ES5",e[e.ES6=2]="ES6",e[e.ES2015=2]="ES2015",e[e.Latest=2]="Latest",r.isIdentifierStart=function(e,t){return 65<=e&&e<=90||97<=e&&e<=122||36===e||95===e||127<e&&s(e,t)},r.isIdentifierPart=function(e,t){return 65<=e&&e<=90||97<=e&&e<=122||48<=e&&e<=57||36===e||95===e||127<e&&(e=e,t>=n.ES5?a(e,l):a(e,u))},r.reservedWords=["abstract","any","as","break","case","catch","class","continue","const","constructor","debugger","declare","default","delete","do","else","enum","export","extends","false","finally","for","from","function","get","if","implements","import","in","instanceof","interface","is","let","module","namespace","new","null","package","private","protected","public","require","global","return","set","static","super","switch","symbol","this","throw","true","try","type","typeof","var","void","while","with","yield","async","await","of","Math"],r.keywordTypes=["boolean","number","string"],r.escapeIdentifier=function(e){if(!e)return"_";let t=e.replace(/\s+/g,"_").replace(/[^a-zA-Z0-9_$]/g,e=>i.pxtc.isIdentifierPart(e.charCodeAt(0),i.pxtc.ScriptTarget.ES5)?e:"");return t=t&&i.pxtc.isIdentifierStart(t.charCodeAt(0),i.pxtc.ScriptTarget.ES5)&&-1===r.reservedWords.indexOf(t)?t:"_"+t};const o=[170,170,181,181,186,186,192,214,216,246,248,705,710,721,736,740,748,748,750,750,880,884,886,887,890,893,902,902,904,906,908,908,910,929,931,1013,1015,1153,1162,1319,1329,1366,1369,1369,1377,1415,1488,1514,1520,1522,1568,1610,1646,1647,1649,1747,1749,1749,1765,1766,1774,1775,1786,1788,1791,1791,1808,1808,1810,1839,1869,1957,1969,1969,1994,2026,2036,2037,2042,2042,2048,2069,2074,2074,2084,2084,2088,2088,2112,2136,2208,2208,2210,2220,2308,2361,2365,2365,2384,2384,2392,2401,2417,2423,2425,2431,2437,2444,2447,2448,2451,2472,2474,2480,2482,2482,2486,2489,2493,2493,2510,2510,2524,2525,2527,2529,2544,2545,2565,2570,2575,2576,2579,2600,2602,2608,2610,2611,2613,2614,2616,2617,2649,2652,2654,2654,2674,2676,2693,2701,2703,2705,2707,2728,2730,2736,2738,2739,2741,2745,2749,2749,2768,2768,2784,2785,2821,2828,2831,2832,2835,2856,2858,2864,2866,2867,2869,2873,2877,2877,2908,2909,2911,2913,2929,2929,2947,2947,2949,2954,2958,2960,2962,2965,2969,2970,2972,2972,2974,2975,2979,2980,2984,2986,2990,3001,3024,3024,3077,3084,3086,3088,3090,3112,3114,3123,3125,3129,3133,3133,3160,3161,3168,3169,3205,3212,3214,3216,3218,3240,3242,3251,3253,3257,3261,3261,3294,3294,3296,3297,3313,3314,3333,3340,3342,3344,3346,3386,3389,3389,3406,3406,3424,3425,3450,3455,3461,3478,3482,3505,3507,3515,3517,3517,3520,3526,3585,3632,3634,3635,3648,3654,3713,3714,3716,3716,3719,3720,3722,3722,3725,3725,3732,3735,3737,3743,3745,3747,3749,3749,3751,3751,3754,3755,3757,3760,3762,3763,3773,3773,3776,3780,3782,3782,3804,3807,3840,3840,3904,3911,3913,3948,3976,3980,4096,4138,4159,4159,4176,4181,4186,4189,4193,4193,4197,4198,4206,4208,4213,4225,4238,4238,4256,4293,4295,4295,4301,4301,4304,4346,4348,4680,4682,4685,4688,4694,4696,4696,4698,4701,4704,4744,4746,4749,4752,4784,4786,4789,4792,4798,4800,4800,4802,4805,4808,4822,4824,4880,4882,4885,4888,4954,4992,5007,5024,5108,5121,5740,5743,5759,5761,5786,5792,5866,5870,5872,5888,5900,5902,5905,5920,5937,5952,5969,5984,5996,5998,6e3,6016,6067,6103,6103,6108,6108,6176,6263,6272,6312,6314,6314,6320,6389,6400,6428,6480,6509,6512,6516,6528,6571,6593,6599,6656,6678,6688,6740,6823,6823,6917,6963,6981,6987,7043,7072,7086,7087,7098,7141,7168,7203,7245,7247,7258,7293,7401,7404,7406,7409,7413,7414,7424,7615,7680,7957,7960,7965,7968,8005,8008,8013,8016,8023,8025,8025,8027,8027,8029,8029,8031,8061,8064,8116,8118,8124,8126,8126,8130,8132,8134,8140,8144,8147,8150,8155,8160,8172,8178,8180,8182,8188,8305,8305,8319,8319,8336,8348,8450,8450,8455,8455,8458,8467,8469,8469,8473,8477,8484,8484,8486,8486,8488,8488,8490,8493,8495,8505,8508,8511,8517,8521,8526,8526,8544,8584,11264,11310,11312,11358,11360,11492,11499,11502,11506,11507,11520,11557,11559,11559,11565,11565,11568,11623,11631,11631,11648,11670,11680,11686,11688,11694,11696,11702,11704,11710,11712,11718,11720,11726,11728,11734,11736,11742,11823,11823,12293,12295,12321,12329,12337,12341,12344,12348,12353,12438,12445,12447,12449,12538,12540,12543,12549,12589,12593,12686,12704,12730,12784,12799,13312,19893,19968,40908,40960,42124,42192,42237,42240,42508,42512,42527,42538,42539,42560,42606,42623,42647,42656,42735,42775,42783,42786,42888,42891,42894,42896,42899,42912,42922,43e3,43009,43011,43013,43015,43018,43020,43042,43072,43123,43138,43187,43250,43255,43259,43259,43274,43301,43312,43334,43360,43388,43396,43442,43471,43471,43520,43560,43584,43586,43588,43595,43616,43638,43642,43642,43648,43695,43697,43697,43701,43702,43705,43709,43712,43712,43714,43714,43739,43741,43744,43754,43762,43764,43777,43782,43785,43790,43793,43798,43808,43814,43816,43822,43968,44002,44032,55203,55216,55238,55243,55291,63744,64109,64112,64217,64256,64262,64275,64279,64285,64285,64287,64296,64298,64310,64312,64316,64318,64318,64320,64321,64323,64324,64326,64433,64467,64829,64848,64911,64914,64967,65008,65019,65136,65140,65142,65276,65313,65338,65345,65370,65382,65470,65474,65479,65482,65487,65490,65495,65498,65500],l=[170,170,181,181,186,186,192,214,216,246,248,705,710,721,736,740,748,748,750,750,768,884,886,887,890,893,902,902,904,906,908,908,910,929,931,1013,1015,1153,1155,1159,1162,1319,1329,1366,1369,1369,1377,1415,1425,1469,1471,1471,1473,1474,1476,1477,1479,1479,1488,1514,1520,1522,1552,1562,1568,1641,1646,1747,1749,1756,1759,1768,1770,1788,1791,1791,1808,1866,1869,1969,1984,2037,2042,2042,2048,2093,2112,2139,2208,2208,2210,2220,2276,2302,2304,2403,2406,2415,2417,2423,2425,2431,2433,2435,2437,2444,2447,2448,2451,2472,2474,2480,2482,2482,2486,2489,2492,2500,2503,2504,2507,2510,2519,2519,2524,2525,2527,2531,2534,2545,2561,2563,2565,2570,2575,2576,2579,2600,2602,2608,2610,2611,2613,2614,2616,2617,2620,2620,2622,2626,2631,2632,2635,2637,2641,2641,2649,2652,2654,2654,2662,2677,2689,2691,2693,2701,2703,2705,2707,2728,2730,2736,2738,2739,2741,2745,2748,2757,2759,2761,2763,2765,2768,2768,2784,2787,2790,2799,2817,2819,2821,2828,2831,2832,2835,2856,2858,2864,2866,2867,2869,2873,2876,2884,2887,2888,2891,2893,2902,2903,2908,2909,2911,2915,2918,2927,2929,2929,2946,2947,2949,2954,2958,2960,2962,2965,2969,2970,2972,2972,2974,2975,2979,2980,2984,2986,2990,3001,3006,3010,3014,3016,3018,3021,3024,3024,3031,3031,3046,3055,3073,3075,3077,3084,3086,3088,3090,3112,3114,3123,3125,3129,3133,3140,3142,3144,3146,3149,3157,3158,3160,3161,3168,3171,3174,3183,3202,3203,3205,3212,3214,3216,3218,3240,3242,3251,3253,3257,3260,3268,3270,3272,3274,3277,3285,3286,3294,3294,3296,3299,3302,3311,3313,3314,3330,3331,3333,3340,3342,3344,3346,3386,3389,3396,3398,3400,3402,3406,3415,3415,3424,3427,3430,3439,3450,3455,3458,3459,3461,3478,3482,3505,3507,3515,3517,3517,3520,3526,3530,3530,3535,3540,3542,3542,3544,3551,3570,3571,3585,3642,3648,3662,3664,3673,3713,3714,3716,3716,3719,3720,3722,3722,3725,3725,3732,3735,3737,3743,3745,3747,3749,3749,3751,3751,3754,3755,3757,3769,3771,3773,3776,3780,3782,3782,3784,3789,3792,3801,3804,3807,3840,3840,3864,3865,3872,3881,3893,3893,3895,3895,3897,3897,3902,3911,3913,3948,3953,3972,3974,3991,3993,4028,4038,4038,4096,4169,4176,4253,4256,4293,4295,4295,4301,4301,4304,4346,4348,4680,4682,4685,4688,4694,4696,4696,4698,4701,4704,4744,4746,4749,4752,4784,4786,4789,4792,4798,4800,4800,4802,4805,4808,4822,4824,4880,4882,4885,4888,4954,4957,4959,4992,5007,5024,5108,5121,5740,5743,5759,5761,5786,5792,5866,5870,5872,5888,5900,5902,5908,5920,5940,5952,5971,5984,5996,5998,6e3,6002,6003,6016,6099,6103,6103,6108,6109,6112,6121,6155,6157,6160,6169,6176,6263,6272,6314,6320,6389,6400,6428,6432,6443,6448,6459,6470,6509,6512,6516,6528,6571,6576,6601,6608,6617,6656,6683,6688,6750,6752,6780,6783,6793,6800,6809,6823,6823,6912,6987,6992,7001,7019,7027,7040,7155,7168,7223,7232,7241,7245,7293,7376,7378,7380,7414,7424,7654,7676,7957,7960,7965,7968,8005,8008,8013,8016,8023,8025,8025,8027,8027,8029,8029,8031,8061,8064,8116,8118,8124,8126,8126,8130,8132,8134,8140,8144,8147,8150,8155,8160,8172,8178,8180,8182,8188,8204,8205,8255,8256,8276,8276,8305,8305,8319,8319,8336,8348,8400,8412,8417,8417,8421,8432,8450,8450,8455,8455,8458,8467,8469,8469,8473,8477,8484,8484,8486,8486,8488,8488,8490,8493,8495,8505,8508,8511,8517,8521,8526,8526,8544,8584,11264,11310,11312,11358,11360,11492,11499,11507,11520,11557,11559,11559,11565,11565,11568,11623,11631,11631,11647,11670,11680,11686,11688,11694,11696,11702,11704,11710,11712,11718,11720,11726,11728,11734,11736,11742,11744,11775,11823,11823,12293,12295,12321,12335,12337,12341,12344,12348,12353,12438,12441,12442,12445,12447,12449,12538,12540,12543,12549,12589,12593,12686,12704,12730,12784,12799,13312,19893,19968,40908,40960,42124,42192,42237,42240,42508,42512,42539,42560,42607,42612,42621,42623,42647,42655,42737,42775,42783,42786,42888,42891,42894,42896,42899,42912,42922,43e3,43047,43072,43123,43136,43204,43216,43225,43232,43255,43259,43259,43264,43309,43312,43347,43360,43388,43392,43456,43471,43481,43520,43574,43584,43597,43600,43609,43616,43638,43642,43643,43648,43714,43739,43741,43744,43759,43762,43766,43777,43782,43785,43790,43793,43798,43808,43814,43816,43822,43968,44010,44012,44013,44016,44025,44032,55203,55216,55238,55243,55291,63744,64109,64112,64217,64256,64262,64275,64279,64285,64296,64298,64310,64312,64316,64318,64318,64320,64321,64323,64324,64326,64433,64467,64829,64848,64911,64914,64967,65008,65019,65024,65039,65056,65062,65075,65076,65101,65103,65136,65140,65142,65276,65296,65305,65313,65338,65343,65343,65345,65370,65382,65470,65474,65479,65482,65487,65490,65495,65498,65500],c=[170,170,181,181,186,186,192,214,216,246,248,543,546,563,592,685,688,696,699,705,720,721,736,740,750,750,890,890,902,902,904,906,908,908,910,929,931,974,976,983,986,1011,1024,1153,1164,1220,1223,1224,1227,1228,1232,1269,1272,1273,1329,1366,1369,1369,1377,1415,1488,1514,1520,1522,1569,1594,1600,1610,1649,1747,1749,1749,1765,1766,1786,1788,1808,1808,1810,1836,1920,1957,2309,2361,2365,2365,2384,2384,2392,2401,2437,2444,2447,2448,2451,2472,2474,2480,2482,2482,2486,2489,2524,2525,2527,2529,2544,2545,2565,2570,2575,2576,2579,2600,2602,2608,2610,2611,2613,2614,2616,2617,2649,2652,2654,2654,2674,2676,2693,2699,2701,2701,2703,2705,2707,2728,2730,2736,2738,2739,2741,2745,2749,2749,2768,2768,2784,2784,2821,2828,2831,2832,2835,2856,2858,2864,2866,2867,2870,2873,2877,2877,2908,2909,2911,2913,2949,2954,2958,2960,2962,2965,2969,2970,2972,2972,2974,2975,2979,2980,2984,2986,2990,2997,2999,3001,3077,3084,3086,3088,3090,3112,3114,3123,3125,3129,3168,3169,3205,3212,3214,3216,3218,3240,3242,3251,3253,3257,3294,3294,3296,3297,3333,3340,3342,3344,3346,3368,3370,3385,3424,3425,3461,3478,3482,3505,3507,3515,3517,3517,3520,3526,3585,3632,3634,3635,3648,3654,3713,3714,3716,3716,3719,3720,3722,3722,3725,3725,3732,3735,3737,3743,3745,3747,3749,3749,3751,3751,3754,3755,3757,3760,3762,3763,3773,3773,3776,3780,3782,3782,3804,3805,3840,3840,3904,3911,3913,3946,3976,3979,4096,4129,4131,4135,4137,4138,4176,4181,4256,4293,4304,4342,4352,4441,4447,4514,4520,4601,4608,4614,4616,4678,4680,4680,4682,4685,4688,4694,4696,4696,4698,4701,4704,4742,4744,4744,4746,4749,4752,4782,4784,4784,4786,4789,4792,4798,4800,4800,4802,4805,4808,4814,4816,4822,4824,4846,4848,4878,4880,4880,4882,4885,4888,4894,4896,4934,4936,4954,5024,5108,5121,5740,5743,5750,5761,5786,5792,5866,6016,6067,6176,6263,6272,6312,7680,7835,7840,7929,7936,7957,7960,7965,7968,8005,8008,8013,8016,8023,8025,8025,8027,8027,8029,8029,8031,8061,8064,8116,8118,8124,8126,8126,8130,8132,8134,8140,8144,8147,8150,8155,8160,8172,8178,8180,8182,8188,8319,8319,8450,8450,8455,8455,8458,8467,8469,8469,8473,8477,8484,8484,8486,8486,8488,8488,8490,8493,8495,8497,8499,8505,8544,8579,12293,12295,12321,12329,12337,12341,12344,12346,12353,12436,12445,12446,12449,12538,12540,12542,12549,12588,12593,12686,12704,12727,13312,19893,19968,40869,40960,42124,44032,55203,63744,64045,64256,64262,64275,64279,64285,64285,64287,64296,64298,64310,64312,64316,64318,64318,64320,64321,64323,64324,64326,64433,64467,64829,64848,64911,64914,64967,65008,65019,65136,65138,65140,65140,65142,65276,65313,65338,65345,65370,65382,65470,65474,65479,65482,65487,65490,65495,65498,65500],u=[170,170,181,181,186,186,192,214,216,246,248,543,546,563,592,685,688,696,699,705,720,721,736,740,750,750,768,846,864,866,890,890,902,902,904,906,908,908,910,929,931,974,976,983,986,1011,1024,1153,1155,1158,1164,1220,1223,1224,1227,1228,1232,1269,1272,1273,1329,1366,1369,1369,1377,1415,1425,1441,1443,1465,1467,1469,1471,1471,1473,1474,1476,1476,1488,1514,1520,1522,1569,1594,1600,1621,1632,1641,1648,1747,1749,1756,1759,1768,1770,1773,1776,1788,1808,1836,1840,1866,1920,1968,2305,2307,2309,2361,2364,2381,2384,2388,2392,2403,2406,2415,2433,2435,2437,2444,2447,2448,2451,2472,2474,2480,2482,2482,2486,2489,2492,2492,2494,2500,2503,2504,2507,2509,2519,2519,2524,2525,2527,2531,2534,2545,2562,2562,2565,2570,2575,2576,2579,2600,2602,2608,2610,2611,2613,2614,2616,2617,2620,2620,2622,2626,2631,2632,2635,2637,2649,2652,2654,2654,2662,2676,2689,2691,2693,2699,2701,2701,2703,2705,2707,2728,2730,2736,2738,2739,2741,2745,2748,2757,2759,2761,2763,2765,2768,2768,2784,2784,2790,2799,2817,2819,2821,2828,2831,2832,2835,2856,2858,2864,2866,2867,2870,2873,2876,2883,2887,2888,2891,2893,2902,2903,2908,2909,2911,2913,2918,2927,2946,2947,2949,2954,2958,2960,2962,2965,2969,2970,2972,2972,2974,2975,2979,2980,2984,2986,2990,2997,2999,3001,3006,3010,3014,3016,3018,3021,3031,3031,3047,3055,3073,3075,3077,3084,3086,3088,3090,3112,3114,3123,3125,3129,3134,3140,3142,3144,3146,3149,3157,3158,3168,3169,3174,3183,3202,3203,3205,3212,3214,3216,3218,3240,3242,3251,3253,3257,3262,3268,3270,3272,3274,3277,3285,3286,3294,3294,3296,3297,3302,3311,3330,3331,3333,3340,3342,3344,3346,3368,3370,3385,3390,3395,3398,3400,3402,3405,3415,3415,3424,3425,3430,3439,3458,3459,3461,3478,3482,3505,3507,3515,3517,3517,3520,3526,3530,3530,3535,3540,3542,3542,3544,3551,3570,3571,3585,3642,3648,3662,3664,3673,3713,3714,3716,3716,3719,3720,3722,3722,3725,3725,3732,3735,3737,3743,3745,3747,3749,3749,3751,3751,3754,3755,3757,3769,3771,3773,3776,3780,3782,3782,3784,3789,3792,3801,3804,3805,3840,3840,3864,3865,3872,3881,3893,3893,3895,3895,3897,3897,3902,3911,3913,3946,3953,3972,3974,3979,3984,3991,3993,4028,4038,4038,4096,4129,4131,4135,4137,4138,4140,4146,4150,4153,4160,4169,4176,4185,4256,4293,4304,4342,4352,4441,4447,4514,4520,4601,4608,4614,4616,4678,4680,4680,4682,4685,4688,4694,4696,4696,4698,4701,4704,4742,4744,4744,4746,4749,4752,4782,4784,4784,4786,4789,4792,4798,4800,4800,4802,4805,4808,4814,4816,4822,4824,4846,4848,4878,4880,4880,4882,4885,4888,4894,4896,4934,4936,4954,4969,4977,5024,5108,5121,5740,5743,5750,5761,5786,5792,5866,6016,6099,6112,6121,6160,6169,6176,6263,6272,6313,7680,7835,7840,7929,7936,7957,7960,7965,7968,8005,8008,8013,8016,8023,8025,8025,8027,8027,8029,8029,8031,8061,8064,8116,8118,8124,8126,8126,8130,8132,8134,8140,8144,8147,8150,8155,8160,8172,8178,8180,8182,8188,8255,8256,8319,8319,8400,8412,8417,8417,8450,8450,8455,8455,8458,8467,8469,8469,8473,8477,8484,8484,8486,8486,8488,8488,8490,8493,8495,8497,8499,8505,8544,8579,12293,12295,12321,12335,12337,12341,12344,12346,12353,12436,12441,12442,12445,12446,12449,12542,12549,12588,12593,12686,12704,12727,13312,19893,19968,40869,40960,42124,44032,55203,63744,64045,64256,64262,64275,64279,64285,64296,64298,64310,64312,64316,64318,64318,64320,64321,64323,64324,64326,64433,64467,64829,64848,64911,64914,64967,65008,65019,65056,65059,65075,65076,65101,65103,65136,65138,65140,65140,65142,65276,65296,65305,65313,65338,65343,65343,65345,65370,65381,65470,65474,65479,65482,65487,65490,65495,65498,65500];function s(e,t){return t>=n.ES5?a(e,o):a(e,c)}function a(i,r){if(!(i<r[0])){let e,t=0,n=r.length;for(;t+1<n;){if(e=t+(n-t)/2,r[e-=e%2]<=i&&i<=r[1+e])return!0;i<r[e]?n=e:t=2+e}}return!1}r.isUnicodeIdentifierStart=s,(e=r.DiagnosticCategory||(r.DiagnosticCategory={}))[e.Warning=0]="Warning",e[e.Error=1]="Error",e[e.Message=2]="Message"}}(ts=ts||{}),function(s){{var i=s.webBluetooth||(s.webBluetooth={}),e;function t(){return!!navigator&&!!navigator.bluetooth&&"TextDecoder"in window&&s.appTarget.appTheme.bluetoothUartConsole&&s.appTarget.appTheme.bluetoothUartFilters&&0<s.appTarget.appTheme.bluetoothUartFilters.length}function n(){return!!navigator&&!!navigator.bluetooth&&!!s.appTarget.appTheme.bluetoothPartialFlashing}i.isAvailable=function(){return t()||n()},i.hasConsole=t,i.hasPartialFlash=n,i.isValidUUID=function(e){return/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/.test(e)};class o{constructor(e,t){this.connectionTimeout=2e4,this.connectPromise=void 0,this.id=e,this.aliveToken=t}debug(e){s.debug(this.id+": "+e)}alivePromise(e){return new Promise((t,n)=>{this.aliveToken.isCancelled()&&n(new Error),e.then(e=>t(e),e=>n(e))})}cancelConnect(){this.connectPromise=void 0}createConnectPromise(){return Promise.resolve()}connectAsync(){return this.connectPromise||(this.connectPromise=this.alivePromise(this.createConnectPromise())),s.Util.promiseTimeout(this.connectionTimeout,this.connectPromise,"connection timeout").then(()=>this.aliveToken.throwIfCancelled()).catch(e=>{throw this.connectPromise=void 0,e})}disconnect(){this.cancelConnect()}kill(){this.disconnect(),this.aliveToken.cancel()}}i.BLERemote=o;class l extends o{constructor(e,t,n){super(e,t.aliveToken),this.device=t,this.autoReconnect=n,this.autoReconnectDelay=1e3,this.disconnectOnAutoReconnect=!1,this.reconnectPromise=void 0,this.failedConnectionServicesVersion=-1,this.handleDisconnected=this.handleDisconnected.bind(this),this.device.device.addEventListener("gattserverdisconnected",this.handleDisconnected)}handleDisconnected(e){this.aliveToken.isCancelled()||(this.disconnect(),this.autoReconnect&&!this.reconnectPromise&&(this.reconnectPromise=s.U.delay(this.autoReconnectDelay).then(()=>this.exponentialBackoffConnectAsync(8,500)).finally(()=>this.reconnectPromise=void 0)))}exponentialBackoffConnectAsync(t,n){return this.debug("retry connect"),this.aliveToken.throwIfCancelled(),this.connectAsync().then(()=>{this.aliveToken.throwIfCancelled(),this.debug("reconnect success"),this.reconnectPromise=void 0}).catch(e=>(this.debug("reconnect error "+e.message),this.aliveToken.throwIfCancelled(),this.device.isPaired?this.autoReconnect?0==t?(this.debug("give up, max tries"),void(this.reconnectPromise=void 0)):this.failedConnectionServicesVersion==this.device.servicesVersion?(this.debug("services haven't changed, giving up"),void(this.reconnectPromise=void 0)):(this.debug(`retry connect ${n}ms... (${t} tries left)`),this.device.connected&&(this.failedConnectionServicesVersion=this.device.servicesVersion),this.disconnectOnAutoReconnect&&this.device.disconnect(),s.U.delay(n).then(()=>this.exponentialBackoffConnectAsync(--t,1.8*n))):(this.debug("autoreconnect disabled"),void(this.reconnectPromise=void 0)):(this.debug("give up, device unpaired"),void(this.reconnectPromise=void 0))))}}i.BLEService=l;class c extends l{constructor(e,t,n,i){super(e,t,!0),this.device=t,this.serviceUUID=n,this.txCharacteristicUUID=i,this.handleValueChanged=this.handleValueChanged.bind(this)}createConnectPromise(){return this.debug("connecting"),this.device.connectAsync().then(()=>this.alivePromise(this.device.gatt.getPrimaryService(this.serviceUUID))).then(e=>(this.debug("service connected"),this.service=e,this.alivePromise(this.service.getCharacteristic(this.txCharacteristicUUID)))).then(e=>(this.debug("tx characteristic connected"),this.txCharacteristic=e,this.txCharacteristic.addEventListener("characteristicvaluechanged",this.handleValueChanged),this.txCharacteristic.startNotifications())).then(()=>{s.tickEvent("webble.connected",{id:this.id})})}handlePacket(e){}handleValueChanged(e){e=e.target.value;this.handlePacket(e)}disconnect(){if(super.disconnect(),this.txCharacteristic&&this.device&&this.device.connected)try{this.txCharacteristic.stopNotifications(),this.txCharacteristic.removeEventListener("characteristicvaluechanged",this.handleValueChanged)}catch(e){s.log(this.id+": error "+e.message)}this.service=void 0,this.txCharacteristic=void 0}}i.BLETXService=c;class u extends c{constructor(e){super("hf2",e,u.SERVICE_UUID,u.CHARACTERISTIC_TX_UUID),this.device=e}handlePacket(n){var e=n.getUint8(0);switch(192&e){case u.BLEHF2_FLAG_SERIAL_OUT:case u.BLEHF2_FLAG_SERIAL_ERR:var i=Math.min(n.byteLength-1,-193&e);let t="";for(let e=0;e<i;++e)t+=String.fromCharCode(n.getUint8(e+1));t&&window.postMessage({type:"serial",id:this.device.name||"hf2",data:t},"*")}}}u.SERVICE_UUID="b112f5e6-2679-30da-a26e-0273b6043849",u.CHARACTERISTIC_TX_UUID="b112f5e6-2679-30da-a26e-0273b604384a",u.BLEHF2_FLAG_SERIAL_OUT=128,u.BLEHF2_FLAG_SERIAL_ERR=192,i.HF2Service=u;class h extends c{constructor(e){super("uart",e,h.SERVICE_UUID,h.CHARACTERISTIC_TX_UUID),this.device=e}handlePacket(e){e=(new window.TextDecoder).decode(e);e&&window.postMessage({type:"serial",id:this.device.name||"uart",data:e},"*")}}let r;h.SERVICE_UUID="6e400001-b5a3-f393-e0a9-e50e24dcca9e",h.CHARACTERISTIC_TX_UUID="6e400002-b5a3-f393-e0a9-e50e24dcca9e",i.UARTService=h,(e=r=r||{})[e.Idle=1]="Idle",e[e.StatusRequested=2]="StatusRequested",e[e.PairingModeRequested=4]="PairingModeRequested",e[e.RegionDALRequested=8]="RegionDALRequested",e[e.RegionMakeCodeRequested=16]="RegionMakeCodeRequested",e[e.Flash=32]="Flash",e[e.EndOfTransmision=64]="EndOfTransmision",e[e.USBFlashRequired=128]="USBFlashRequired";class d extends l{constructor(e){super("partial flashing",e,!1),this.device=e,this.state=r.Idle,this.disconnectOnAutoReconnect=!0,this.handleCharacteristic=this.handleCharacteristic.bind(this)}clearFlashData(){this.version=0,this.mode=0,this.regions=[],this.chunkDelay=d.CHUNK_MIN_DELAY,this.hex=void 0,this.bin=void 0,this.magicOffset=void 0,this.dalHash=void 0,this.makeCodeHash=void 0,this.flashReject=void 0,this.flashResolve=void 0,this.flashOffset=void 0}createConnectPromise(){return this.debug("connecting to partial flash service"),this.device.connectAsync().then(()=>this.alivePromise(this.device.gatt.getPrimaryService(d.SERVICE_UUID))).then(e=>(this.debug("connecting to characteristic"),this.alivePromise(e.getCharacteristic(d.CHARACTERISTIC_UUID)))).then(e=>(this.debug("starting notifications"),this.pfCharacteristic=e,this.pfCharacteristic.startNotifications(),this.pfCharacteristic.addEventListener("characteristicvaluechanged",this.handleCharacteristic),this.state==r.PairingModeRequested?(this.debug("checking pairing mode"),this.autoReconnect=!1,this.pfCharacteristic.writeValue(new Uint8Array([d.STATUS]))):Promise.resolve()))}disconnect(){if(super.disconnect(),this.flashPacketToken&&this.flashPacketToken.cancel(),this.pfCharacteristic&&this.device.connected)try{this.pfCharacteristic.stopNotifications(),this.pfCharacteristic.removeEventListener("characteristicvaluechanged",this.handleCharacteristic)}catch(e){s.log("ble: partial flash disconnect error "+e.message)}this.pfCharacteristic=void 0}findMarker(n,i){if(this.bin)for(;n+i.length<this.bin.length;n+=16){let t=!0;for(let e=0;e<i.length;++e)if(i[e]!=this.bin[n+e]){t=!1;break}if(t)return n}return-1}flashAsync(e){return this.hex?(this.debug("flashing already in progress"),Promise.resolve()):(this.device.pauseLog(),this.createFlashPromise(e).finally(()=>this.device.resumeLogOnDisconnection()))}createFlashPromise(e){if(this.hex)return this.debug("flashing already in progress"),Promise.resolve();this.clearFlashData(),this.hex=e;var e=ts.pxtc.UF2.newBlockFile(),t=(ts.pxtc.UF2.writeHex(e,this.hex.split(/\r?\n/)),s.appTarget.compile.flashUsableEnd),e=(this.bin=ts.pxtc.UF2.toBin(s.U.stringToUint8Array(ts.pxtc.UF2.serializeFile(e)),t).buf,this.debug("bin bytes "+this.bin.length),this.magicOffset=this.findMarker(0,d.MAGIC_MARKER),this.debug("magic block "+this.magicOffset.toString(16)),this.magicOffset<0&&(this.debug("magic block not found, not a valid HEX file"),s.U.userError(lf("Invalid file"))),this.debug("bytes to flash "+(this.bin.length-this.magicOffset)),this.magicOffset+d.MAGIC_MARKER.length);return this.dalHash=s.Util.toHex(this.bin.slice(e,e+8)),this.makeCodeHash=s.Util.toHex(this.bin.slice(e+8,e+16)),this.debug("DAL hash "+this.dalHash),this.debug("MakeCode hash "+this.makeCodeHash),this.connectAsync().then(()=>new Promise((e,t)=>(this.flashResolve=e,this.flashReject=t,this.debug("check service version"),this.state=r.StatusRequested,this.pfCharacteristic.writeValue(new Uint8Array([d.STATUS]))))).then(()=>{},e=>{s.log("pf: error "+e.message),this.clearFlashData()})}checkStateTransition(e,t){return!!(this.state&t)||(this.debug(`flash cmd ${e} in state ${this.state.toString(16)} `),this.flashReject(new Error),this.clearFlashData(),!1)}handleCharacteristic(e){this.aliveToken.isCancelled()&&(this.flashReject(new Error),this.clearFlashData());var t=event.target.value,n=new Uint8Array(t.buffer),i=n[0];if(this.state!=r.Idle)switch(i){case d.STATUS:this.checkStateTransition(i,r.StatusRequested|r.PairingModeRequested)&&(this.version=n[1],this.mode=n[2],this.debug(`flash service version ${this.version} mode `+this.mode),this.debug("reading DAL region"),this.state=r.RegionDALRequested,this.pfCharacteristic.writeValue(new Uint8Array([d.REGION_INFO,d.REGION_DAL])).then(()=>{}));break;case d.REGION_INFO:if(this.checkStateTransition(i,r.RegionDALRequested|r.RegionMakeCodeRequested)){const e=this.regions[n[1]]={start:n[2]<<24|n[3]<<16|n[4]<<8|n[5],end:n[6]<<24|n[7]<<16|n[8]<<8|n[9],hash:s.Util.toHex(n.slice(10))};if(this.debug(`read region ${n[1]} start ${e.start.toString(16)} end ${e.end.toString(16)} hash `+e.hash),n[1]==d.REGION_DAL){if(e.hash!=this.dalHash)return s.tickEvent("webble.flash.DALrequired"),this.debug("DAL hash does not match, partial flashing not possible"),this.state=r.USBFlashRequired,this.flashReject(new Error("USB flashing required")),void this.clearFlashData();this.debug("DAL hash match, reading makecode region"),this.state=r.RegionMakeCodeRequested,this.pfCharacteristic.writeValue(new Uint8Array([d.REGION_INFO,d.REGION_MAKECODE])).then(()=>{})}else if(n[1]==d.REGION_MAKECODE)if(e.start!=this.magicOffset&&(this.debug("magic offset and MakeCode region.start not matching"),s.U.userError(lf("Invalid file"))),e.hash==this.makeCodeHash)s.tickEvent("webble.flash.noop"),this.debug("MakeCode hash matches, same code!"),this.debug("restart application mode"),this.pfCharacteristic.writeValue(new Uint8Array([d.RESET,d.MODE_APPLICATION])).then(()=>{this.state=r.Idle,this.flashResolve(),this.clearFlashData()});else{if(this.mode!=d.MODE_PAIRING)return this.debug("application mode, reset into pairing mode"),this.state=r.PairingModeRequested,this.autoReconnect=!0,void this.pfCharacteristic.writeValue(new Uint8Array([d.RESET,d.MODE_PAIRING])).then(()=>{});this.flashOffset=e.start,this.flashPacketNumber=0,this.debug("starting to flash from address "+this.flashOffset.toString(16)),this.flashNextPacket()}}break;case d.FLASH_DATA:if(this.checkStateTransition(i,r.Flash))switch(n[1]){case d.PACKET_OUT_OF_ORDER:this.debug("packet out of order"),this.flashPacketToken.cancel(),this.flashPacketNumber+=4,this.chunkDelay=Math.min(this.chunkDelay+10,d.CHUNK_MAX_DELAY),this.flashNextPacket();break;case d.PACKET_WRITTEN:this.chunkDelay=Math.max(this.chunkDelay-1,d.CHUNK_MIN_DELAY),this.flashOffset+=64,this.flashPacketNumber+=4,this.flashOffset>=this.bin.length?(this.debug("end transmission"),this.state=r.EndOfTransmision,this.pfCharacteristic.writeValue(new Uint8Array([d.END_OF_TRANSMISSION])).finally(()=>{this.flashResolve&&this.flashResolve(),this.clearFlashData()})):this.flashNextPacket()}break;default:this.debug("unknown message "+s.Util.toHex(n)),this.disconnect()}}flashNextPacket(){this.state=r.Flash,this.flashPacketToken=new s.Util.CancellationToken,this.flashPacketToken.startOperation();const t=this.bin.slice(this.flashOffset,this.flashOffset+64);this.debug(`flashing ${this.flashOffset.toString(16)} / ${this.bin.length.toString(16)} ${(this.flashOffset-this.magicOffset)/(this.bin.length-this.magicOffset)*100>>0}%`);let n=new Uint8Array(20);s.U.delay(this.chunkDelay).then(()=>{this.flashPacketToken.throwIfCancelled(),n[0]=d.FLASH_DATA,n[1]=this.flashOffset>>8&255,n[2]=this.flashOffset>>0&255,n[3]=this.flashPacketNumber;for(let e=0;e<16;e++)n[4+e]=t[e];return this.pfCharacteristic.writeValue(n)}).then(()=>s.U.delay(this.chunkDelay)).then(()=>{this.flashPacketToken.throwIfCancelled(),n[0]=d.FLASH_DATA,n[1]=this.flashOffset>>24&255,n[2]=this.flashOffset>>16&255,n[3]=this.flashPacketNumber+1;for(let e=0;e<16;e++)n[4+e]=t[16+e]||0;return this.pfCharacteristic.writeValue(n)}).then(()=>s.U.delay(this.chunkDelay)).then(()=>{this.flashPacketToken.throwIfCancelled(),n[0]=d.FLASH_DATA,n[1]=0,n[2]=0,n[3]=this.flashPacketNumber+2;for(let e=0;e<16;e++)n[4+e]=t[32+e]||0;return this.pfCharacteristic.writeValue(n)}).then(()=>s.U.delay(this.chunkDelay)).then(()=>{this.flashPacketToken.throwIfCancelled(),n[0]=d.FLASH_DATA,n[1]=0,n[2]=0,n[3]=this.flashPacketNumber+3;for(let e=0;e<16;e++)n[4+e]=t[48+e]||0;return this.pfCharacteristic.writeValue(n)}).then(()=>{const e=this.flashOffset,t=()=>s.U.delay(500).then(()=>{if(e!=this.flashOffset||this.flashPacketToken.isCancelled()||this.aliveToken.isCancelled()||this.state!=r.Flash)return Promise.resolve();this.debug("packet transfer deadlock, force restart"),n[0]=d.FLASH_DATA,n[1]=0,n[2]=0,n[3]=-1;for(let e=0;e<16;e++)n[4+e]=0;return this.pfCharacteristic.writeValue(n).then(()=>t())});t().catch(e=>{this.flashReject&&(this.flashReject(new Error("failed packet transfer")),this.clearFlashData())})}).catch(()=>{this.flashPacketToken.resolveCancel()})}}d.SERVICE_UUID="e97dd91d-251d-470a-a062-fa1922dfa9a8",d.CHARACTERISTIC_UUID="e97d3b10-251d-470a-a062-fa1922dfa9a8",d.REGION_INFO=0,d.FLASH_DATA=1,d.PACKET_OUT_OF_ORDER=170,d.PACKET_WRITTEN=255,d.END_OF_TRANSMISSION=2,d.STATUS=238,d.RESET=255,d.MODE_PAIRING=0,d.MODE_APPLICATION=1,d.REGION_SOFTDEVICE=0,d.REGION_DAL=1,d.REGION_MAKECODE=2,d.MAGIC_MARKER=s.Util.fromHex("708E3B92C615A841C49866C975EE5197"),d.CHUNK_MIN_DELAY=0,d.CHUNK_MAX_DELAY=75,i.PartialFlashingService=d;class p extends o{constructor(e){super("ble",new s.Util.CancellationToken),this.device=void 0,this.services=[],this.pendingResumeLogOnDisconnection=!1,this.servicesVersion=0,this.device=e,this.handleDisconnected=this.handleDisconnected.bind(this),this.handleServiceAdded=this.handleServiceAdded.bind(this),this.handleServiceChanged=this.handleServiceChanged.bind(this),this.handleServiceRemoved=this.handleServiceRemoved.bind(this),this.device.addEventListener("gattserverdisconnected",this.handleDisconnected),this.device.addEventListener("serviceadded",this.handleServiceAdded),this.device.addEventListener("servicechanged",this.handleServiceChanged),this.device.addEventListener("serviceremoved",this.handleServiceRemoved),t()&&(this.services.push(this.uartService=new h(this)),this.services.push(this.hf2Service=new u(this))),n()&&this.services.push(this.partialFlashingService=new d(this)),this.aliveToken.startOperation()}startServices(){this.services.filter(e=>e.autoReconnect).forEach(e=>e.connectAsync().catch(()=>{}))}pauseLog(){this.uartService&&(this.uartService.autoReconnect=!1,this.uartService.disconnect()),this.hf2Service&&(this.hf2Service.autoReconnect=!1,this.hf2Service.disconnect())}resumeLogOnDisconnection(){this.pendingResumeLogOnDisconnection=!0}resumeLog(){this.uartService&&(this.uartService.autoReconnect=!0,this.uartService.connectAsync().catch(()=>{})),this.hf2Service&&(this.hf2Service.autoReconnect=!0,this.hf2Service.connectAsync().catch(()=>{}))}get isPaired(){return this===i.bleDevice}get name(){return this.device.name||"?"}get connected(){return this.device&&this.device.gatt&&this.device.gatt.connected}get gatt(){return this.device.gatt}createConnectPromise(){return this.debug("connecting gatt server"),this.alivePromise(this.device.gatt.connect().then(()=>this.debug("gatt server connected")))}handleServiceAdded(e){this.debug("service added"),this.servicesVersion++}handleServiceRemoved(e){this.debug("service removed"),this.servicesVersion++}handleServiceChanged(e){this.debug("service changed"),this.servicesVersion++}handleDisconnected(e){this.debug("disconnected"),this.disconnect(),this.pendingResumeLogOnDisconnection&&(this.pendingResumeLogOnDisconnection=!1,s.U.delay(500).then(()=>this.resumeLog()))}disconnect(){if(super.disconnect(),this.services.forEach(e=>e.disconnect()),this.connected){this.debug("disconnect");try{this.device.gatt&&this.device.gatt.connected&&this.device.gatt.disconnect()}catch(e){this.debug("gatt disconnect error "+e.message)}}}}function a(){if(i.bleDevice)return Promise.resolve();s.log("ble: requesting device");var e=[];return t()&&(e.push(h.SERVICE_UUID),e.push(u.SERVICE_UUID)),n()&&e.push(d.SERVICE_UUID),navigator.bluetooth.requestDevice({filters:s.appTarget.appTheme.bluetoothUartFilters,optionalServices:e}).then(e=>(s.log("ble: received device "+e.name),i.bleDevice=new p(e),i.bleDevice.startServices(),i.bleDevice.connectAsync()))}i.BLEDevice=p,i.bleDevice=void 0,i.isPaired=function(){return!!i.bleDevice},i.pairAsync=function(){return i.bleDevice&&(i.bleDevice.kill(),i.bleDevice=void 0),a().catch(e=>{i.bleDevice&&i.bleDevice.aliveToken&&i.bleDevice.aliveToken.resolveCancel(),s.log("ble: error "+e.message)})},i.flashAsync=function(e,t){s.tickEvent("webble.flash");const n=e.outfiles[ts.pxtc.BINARY_HEX];return a().then(()=>i.bleDevice.partialFlashingService.flashAsync(n)).then(()=>s.tickEvent("webble.flash.success")).catch(e=>{throw s.tickEvent("webble.fail.fail",{message:e.message}),e})}}}(pxt=pxt||{}),function(r){{var s=r.usb||(r.usb={});class l extends Error{constructor(e){super(e),this.message=e}}s.USBError=l,s.filters=[{classCode:255,subclassCode:42}];let e,i,t=!0;s.setFilters=function(e){t=!1,s.filters=e};class c{constructor(){this.ready=!1,this.connecting=!1,this.readLoopStarted=!1,this.onDeviceConnectionChanged=e=>{},this.onConnectionChanged=()=>{},this.onData=e=>{},this.onError=e=>{},this.onEvent=e=>{},this.enabled=!1,this.handleUSBConnected=this.handleUSBConnected.bind(this),this.handleUSBDisconnected=this.handleUSBDisconnected.bind(this)}enable(){this.enabled||(this.enabled=!0,this.log("registering webusb events"),navigator.usb.addEventListener("disconnect",this.handleUSBDisconnected,!1),navigator.usb.addEventListener("connect",this.handleUSBConnected,!1))}disable(){this.enabled&&(this.enabled=!1,this.log("unregistering webusb events"),navigator.usb.removeEventListener("disconnect",this.handleUSBDisconnected),navigator.usb.removeEventListener("connect",this.handleUSBConnected))}disposeAsync(){return this.disable(),Promise.resolve()}handleUSBDisconnected(e){this.log("device disconnected"),e.device==this.dev&&(this.log("clear device"),this.clearDev(),this.onDeviceConnectionChanged)&&this.onDeviceConnectionChanged(!1)}handleUSBConnected(e){e=e.device;this.log("device connected "+e.serialNumber),this.dev||this.connecting||(this.log("attach device"),this.onDeviceConnectionChanged&&this.onDeviceConnectionChanged(!0))}clearDev(){this.dev&&(this.dev=null,this.epIn=null,this.epOut=null,this.onConnectionChanged)&&this.onConnectionChanged()}error(e){throw new l(r.U.lf("USB error on device {0} ({1})",this.dev.productName,e))}log(e){r.debug("webusb: "+e)}disconnectAsync(){return this.ready=!1,this.dev?(this.log("close device"),this.dev.close().catch(e=>{}).then(()=>(this.clearDev(),r.U.delay(500)))):Promise.resolve()}reconnectAsync(){return this.log("reconnect"),this.setConnecting(!0),this.disconnectAsync().then(n).then(e=>this.connectAsync(e)).finally(()=>this.setConnecting(!1))}setConnecting(e){e!=this.connecting&&(this.connecting=e,this.onConnectionChanged)&&this.onConnectionChanged()}isConnecting(){return this.connecting}isConnected(){return!!this.dev&&this.ready}async connectAsync(t){if(this.log(`trying to connect (${t.length} devices)`),0==t.length){const r=new Error("Device not found.");throw r.type="devicenotfound",r}this.setConnecting(!0);try{var e;this.lastKnownDeviceSerialNumber&&((e=t.find(e=>e.serialNumber===this.lastKnownDeviceSerialNumber))?(this.log("last known device spotted"),t.splice(t.indexOf(e),1),t.unshift(e)):(this.log("delay for last known device"),await r.U.delay(2e3)));for(let e=0;e<t.length;++e){var n=t[e];this.dev=n,this.log(`connect device: ${n.manufacturerName} `+n.productName),this.log(`serial number: ${n.serialNumber} ${this.lastKnownDeviceSerialNumber===n.serialNumber?"(last known device)":""} `);try{return void await this.initAsync()}catch(e){this.dev=void 0,this.log("connection failed, "+e.message)}}var i=new Error(r.U.lf("Device in use or not found."));throw i.type="devicelocked",i}finally{this.setConnecting(!1)}}sendPacketAsync(e){return this.dev?(r.Util.assert(e.length<=64),this.epOut?this.dev.transferOut(this.epOut.endpointNumber,e).then(e=>{"ok"!=e.status&&this.error("USB OUT transfer failed")}):this.dev.controlTransferOut({requestType:"class",recipient:"interface",request:9,value:512,index:this.iface.interfaceNumber},e).then(e=>{"ok"!=e.status&&this.error("USB CTRL OUT transfer failed")})):Promise.reject(new Error("Disconnected"))}readLoop(){if(!this.readLoopStarted){this.readLoopStarted=!0,this.log("start read loop");let t=()=>{this.ready?this.recvPacketAsync().then(e=>{e[0]?(this.onData(e),t()):r.U.delay(500).then(t)},e=>{this.dev&&this.onError(e),r.U.delay(300).then(t)}):r.U.delay(300).then(t)};t()}}recvPacketAsync(){var e=e=>{"ok"!=e.status&&this.error("USB IN transfer failed");e=new Uint8Array(e.data.buffer);return 0==e.length?this.recvPacketAsync():e};return this.dev?(this.epIn?this.dev.transferIn(this.epIn.endpointNumber,64):this.dev.controlTransferIn({requestType:"class",recipient:"interface",request:1,value:256,index:this.iface.interfaceNumber},64)).then(e):Promise.reject(new Error("Disconnected"))}initAsync(){if(!this.dev)return Promise.reject(new Error("Disconnected"));let n=this.dev;return this.log("open device"),n.open().then(()=>(this.log("select configuration"),n.selectConfiguration(1))).then(()=>{this.log("got "+n.configurations[0].interfaces.length+" interfaces");var e=n.configurations[0].interfaces.filter(e=>{var t,n=e.alternates[0];for(t of s.filters)if((null==t.classCode||n.interfaceClass===t.classCode)&&!(null!=t.subclassCode&&n.interfaceSubclass!==t.subclassCode||null!=t.protocolCode&&n.interfaceProtocol!==t.protocolCode)){if(0==n.endpoints.length)return!0;if(2==n.endpoints.length&&n.endpoints.every(e=>64==e.packetSize))return!0}return!1}),t=e[e.length-1];return this.log(e.length+" matching interfaces; picking "+(t?"#"+t.interfaceNumber:"n/a")),t||this.error("cannot find supported USB interface"),this.altIface=t.alternates[0],this.iface=t,this.altIface.endpoints.length?(this.log("using dedicated endpoints"),this.epIn=this.altIface.endpoints.filter(e=>"in"==e.direction)[0],this.epOut=this.altIface.endpoints.filter(e=>"out"==e.direction)[0],r.Util.assert(64==this.epIn.packetSize),r.Util.assert(64==this.epOut.packetSize)):this.log("using ctrl pipe"),this.log("claim interface"),n.claimInterface(t.interfaceNumber)}).then(()=>{this.log("device ready"),this.lastKnownDeviceSerialNumber=this.dev.serialNumber,this.ready=!0,t&&this.readLoop(),this.onConnectionChanged&&this.onConnectionChanged()})}}async function n(){r.log("webusb: get devices");try{return await navigator.usb.getDevices()||[]}catch(e){return r.reportException(e),[]}}async function a(){var e;if(void 0===i)if(r.debug("webusb: checking availability"),null!=(t=null==(e=r.appTarget)?void 0:e.compile)&&t.webUSB)if(r.BrowserUtils.isElectron()||r.BrowserUtils.isWinRT())r.debug("webusb: off, electron or winrt"),r.tickEvent("webusb.off",{reason:"electronwinrt"}),i=!1;else{var t=navigator.usb;if(t){var n=/Windows NT (\d+\.\d+)/.exec(navigator.userAgent);if(n&&parseFloat(n[1])<6.3)r.debug("webusb: off, older windows version"),r.tickEvent("webusb.off",{reason:"oldwindows"}),i=!1;else{try{await t.getDevices()}catch(e){return r.debug("webusb: off, security exception"),r.tickEvent("webusb.off",{reason:"security"}),void(i=!1)}i=!0}}else r.debug("webusb: off, not impl"),r.tickEvent("webusb.off",{reason:"notimpl"}),i=!1}else i=!1}function o(){return void 0===i&&(console.error("checkAvailableAsync not called"),a()),!!i}s.pairAsync=function(){return navigator.usb.requestDevice({filters:s.filters}).then(e=>!!e).catch(e=>{if("NotFoundError"!=e.name)throw e})},s.mkWebUSBHIDPacketIOAsync=function(){return r.debug("packetio: mk webusb io"),(e=e||new c).enable(),Promise.resolve(e)},s.isEnabled=!1,s.setEnabled=function(e){o()||(e=!1),s.isEnabled=e},s.checkAvailableAsync=a,s.isAvailable=o}}(pxt=pxt||{}),function(s){{var e=s.worker||(s.worker={}),i=s.Util;let n={};function a(s){let a={},o=0,e=new i.PromiseQueue,t=new Promise((e,t)=>{a.ready=e});return e.enqueue("main",()=>t),{opAsync:function(i,r){return e.enqueue("main",()=>new Promise((t,n)=>{var e=""+o++;a[e]=e=>{e?e.errorMessage?n(new Error(e.errorMessage)):t(e):n(new Error("no response"))},s({id:e,op:i,arg:r})}))},recvHandler:e=>{var t;a.hasOwnProperty(e.id)&&(t=a[e.id],delete a[e.id],t(e.result))}}}function r(e){let t=new Worker(e),n=a(e=>t.postMessage(e));return t.onmessage=e=>{s.perf.measureStart("webworker recvHandler"),n.recvHandler(e.data),s.perf.measureEnd("webworker recvHandler")},n}e.getWorker=function(e){let t=n[e];return t=t||(n[e]=r(e))},e.wrap=a,e.makeWebWorker=r,e.makeWebSocket=function(e,t=null){let n=new WebSocket(e),i=[],r=a(e=>{e=JSON.stringify(e);i?i.push(e):n.send(e)});return n.onmessage=e=>{e=JSON.parse(e.data);t&&null==e.id?t(e):r.recvHandler(e)},n.onopen=e=>{s.debug("socket opened");for(var t of i)n.send(t);i=null},n.onclose=e=>{s.debug("socket closed")},n.onerror=e=>{s.debug("socket errored")},r}}}(pxt=pxt||{}),function(s){function a(){o.apiKey||s.U.userError("YouTube API key missing")}var o;(o=s.youtube||(s.youtube={})).apiKey=void 0,o.playlistItemToCodeCard=function(e){return{name:e.snippet.title.replace(/[^-]*-/,"").trim(),description:e.snippet.description.split(/\n\s+/,1)[0].trim(),youTubeId:e.snippet.resourceId.videoId,youTubePlaylistId:e.snippet.playlistId,imageUrl:(e=e.snippet.thumbnails)&&(null==(e=e.medium||e.high||e.standard||e.default)?void 0:e.url)||""}},o.playlistInfoAsync=function(e){a();e=`https://www.googleapis.com/youtube/v3/playlists?part=snippet&id=${e}&key=`+o.apiKey;return s.Util.httpGetJsonAsync(e).then(e=>e.items[0])},o.listPlaylistVideosAsync=async function(t){a();let n,i=[];do{let e=`https://www.googleapis.com/youtube/v3/playlistItems?part=snippet&maxResults=50&playlistId=${t}&key=`+o.apiKey;n&&(e+="&pageToken="+n);var r=await s.Util.httpGetJsonAsync(e);i=i.concat(r.items),n=r.nextPageToken}while(n);return s.options.debug&&s.debug(JSON.stringify(i,null,2)),i},o.watchUrl=function(e,t){let n;return e?(n="https://www.youtube.com/watch?v="+e,t&&(n+="&list="+t)):t&&(n="https://www.youtube.com/playlist?list="+t),n}}(pxt=pxt||{}),function(e){var g=e.pxtc||(e.pxtc={});{var m=g.assembler||(g.assembler={});function b(e,...n){return e.replace(/{(\d+)}/g,(e,t)=>n[+t])}m.debug=!1,m.lf=b;let e=f("opcode name doesn't match","<name>");class r{constructor(e,t,n,i,r){this.opcode=n,this.mask=i,this.is32bit=r,this.canBeShared=!1,g.assert((n&i)==n),this.ei=e,this.code=t.replace(/\s+/g," "),this.friendlyFmt=t.replace(/\$\w+/g,e=>this.ei.encoders[e]?this.ei.encoders[e].pretty:e);r=o(t);this.name=r[0],this.args=r.slice(1)}emit(r){var s=r.words;if(s[0]!=this.name)return e;let a=this.opcode,o=1,l=0,c=[],u=null,h=null,d=null;for(let e=0;e<this.args.length;++e){let n=this.args[e],i=s[o++];if("$"==n[0]){let e=this.ei.encoders[n],t=null;if(e.isRegister){if(null==(t=this.ei.registerNo(i)))return f("expecting register name",i);this.ei.isPush(this.opcode)?l++:this.ei.isPop(this.opcode)&&l--}else if(e.isImmediate){if(i=i.replace(/^#/,""),null==(t=r.bin.parseOneInt(i)))return f("expecting number",i);this.ei.isAddSP(this.opcode)?l=-t/this.ei.wordSize():this.ei.isSubSP(this.opcode)&&(l=t/this.ei.wordSize())}else if(e.isRegList){if("{"!=i)return f("expecting {",i);for(t=0;"}"!=s[o];){if(!(i=s[o++]))return f("expecting }",s[o-2]);var p=this.ei.registerNo(i);if(null==p)return f("expecting register name",i);if(t&1<<p)return f("duplicate register name",i);t|=1<<p,this.ei.isPush(this.opcode)?l++:this.ei.isPop(this.opcode)&&l--,","==s[o]&&o++}i=s[o++]}else if(e.isLabel){if(i=i.replace(/^#/,""),/^[+-]?\d+$/.test(i))t=parseInt(i,10),u="rel"+t;else if(/^0x[0-9a-fA-F]+$/.test(i))t=parseInt(i,16),u="abs"+t;else if(u=i,null==(t=this.ei.getAddressFromLabel(r.bin,this,i,e.isWordAligned))){if(r.bin.finalEmit)return f("unknown label",i);t=8}if(this.ei.is32bit(this)){h=t,d=i;continue}}else g.oops();if(null==t)return f("didn't understand it",i);if(c.push(t),null==(t=e.encode(t)))return f("argument out of range or mis-aligned",i);g.assert(0==(a&t)),a|=t}else if(n!=i)return f("expecting "+n,i)}return s[o]?f("trailing tokens",s[o]):this.ei.is32bit(this)?this.ei.emit32(a,h,r.bin.normalizeExternalLabel(d)):{stack:l,opcode:a,numArgs:c,labelName:r.bin.normalizeExternalLabel(u)}}toString(){return this.friendlyFmt}}m.Instruction=r;class l{constructor(e,t){this.bin=e,this.text=t}getOpExt(){return this.instruction?this.instruction.code:""}getOp(){return this.instruction?this.instruction.name:""}update(e){this.bin.peepOps++,(e=e.replace(/^\s*/,""))||this.bin.peepDel++,e&&(e+="      "),this.text=(e="    "+e)+"; WAS: "+this.text.trim(),this.instruction=null,this.numArgs=null,this.words=o(e)||[],0==this.words.length?this.type="empty":"@"==this.words[0][0]&&(this.type="directive")}}m.Line=l;class a{constructor(e){this.baseOffset=0,this.checkStack=!0,this.inlineMode=!1,this.normalizeExternalLabel=e=>e,this.currLineNo=0,this.scope="",this.scopeId=0,this.errors=[],this.labels={},this.equs={},this.stackpointers={},this.stack=0,this.commPtr=0,this.peepOps=0,this.peepDel=0,this.peepCounts={},this.stats="",this.throwOnError=!1,this.disablePeepHole=!1,this.stackAtLabel={},this.currLine=new l(this,"<start>"),this.currLine.lineNo=0,this.ei=e,this.ei.file=this}emitShort(e){g.assert(0<=e&&e<=65535),this.buf.push(e)}emitOpCode(e){this.emitShort(e)}location(){return 2*this.buf.length}pc(){return this.location()+this.baseOffset}parseOneInt(e){if(!e)return null;if(/^\d+$/.test(e))return parseInt(e,10);var t=e.indexOf("-");if(0<t)return this.parseOneInt(e.slice(0,t))-this.parseOneInt(e.slice(t+1));let n=1;if(0<=e.indexOf("*"))for(var i;i=/^([^\*]*)\*(.*)$/.exec(e);){var r=this.parseOneInt(i[1]);if(null==r)return null;n*=r,e=i[2]}if("-"==e[0]?(n*=-1,e=e.slice(1)):"+"==e[0]&&(e=e.slice(1)),/^\d+$/.test(e))return n*parseInt(e,10);if(g.U.endsWith(e,"|1"))return 1|this.parseOneInt(e.slice(0,e.length-2));if(g.U.endsWith(e,"-1"))return this.parseOneInt(e.slice(0,e.length-2))-1;if(g.U.endsWith(e,"+1"))return this.parseOneInt(e.slice(0,e.length-2))+1;var s,t=/(.*)>>(\d+)$/.exec(e);if(t)return s=this.parseOneInt(t[1]),(s&=~(-16777216&this.baseOffset))>>parseInt(t[2]);let a=null;return"0"==e[0]&&("x"==e[1]||"X"==e[1]?(s=/^0x([a-f0-9]+)$/i.exec(e))&&(a=parseInt(s[1],16)):"b"!=e[1]&&"B"!=e[1]||(t=/^0b([01]+)$/i.exec(e))&&(a=parseInt(t[1],2))),0<=e.indexOf("@")&&((s=/^(\w+)@(-?\d+)$/.exec(e))&&(1!=n&&this.directiveError(b("multiplication not supported with saved stacks")),this.stackpointers.hasOwnProperty(s[1])?a=this.ei.wordSize()*this.ei.computeStackOffset(s[1],this.stack-this.stackpointers[s[1]]+parseInt(s[2])):this.directiveError(b("saved stack not found"))),s=/^(.*)@(hi|lo|fn)$/.exec(e))&&this.looksLikeLabel(s[1])&&null!=(a=this.lookupLabel(s[1],!0))&&("fn"==s[2]?a=this.ei.toFnPtr(a,this.baseOffset,s[1]):0<=(a>>=1)&&a<=65535?"hi"==s[2]?a=a>>8&255:"lo"==s[2]?a&=255:g.oops():(this.directiveError(b("@hi/lo out of range")),a=null)),null==a&&this.looksLikeLabel(e)&&null!=(a=this.lookupLabel(e,!0))&&1==this.ei.postProcessRelAddress(this,1)&&(a+=this.baseOffset),null==a||isNaN(a)?null:a*n}looksLikeLabel(e){return!/^(r\d|pc|sp|lr)$/i.test(e)&&/^[\.a-zA-Z_][\.:\w+]*$/.test(e)}scopedName(e){return"."==e[0]&&this.scope?this.scope+"$"+e:e}lookupLabel(e,t=!1){let n=null,i=this.scopedName(e);return this.labels.hasOwnProperty(i)?(n=this.labels[i],n=this.ei.postProcessRelAddress(this,n)):this.lookupExternalLabel&&null!=(n=this.lookupExternalLabel(e))&&(n=this.ei.postProcessAbsAddress(this,n)),null==(n=null==n&&this.equs.hasOwnProperty(i)?this.equs[i]:n)&&t&&(this.finalEmit?this.directiveError(b("unknown label: {0}",e)):n=11111),n}align(e){for(g.assert(2==e||4==e||8==e||16==e);this.location()%e!=0;)this.emitOpCode(0)}pushError(e,t=""){e={scope:this.scope,message:b("  -> Line {2} ('{1}'), error: {0}\n{3}",e,this.currLine.text,this.currLine.lineNo,t),lineNo:this.currLine.lineNo,line:this.currLine.text,coremsg:e,hints:t};if(this.errors.push(e),this.throwOnError)throw new Error(e.message)}directiveError(e){this.pushError(e)}emitString(e,t=!1){function n(e,t){return 255&(e.charCodeAt(t)||0)}let i,r=/^\s*([\w\.]+\s*:\s*)?.\w+\s+(".*")\s*$/.exec(e);if(r&&null!=(i=function(e){e=e.replace(/\\\\/g,"\\B").replace(/\\(['\?])/g,(e,t)=>t).replace(/\\[z0]/g,"\0").replace(/\\x([0-9a-f][0-9a-f])/gi,(e,t)=>"\\u00"+t).replace(/\\B/g,"\\\\");try{return JSON.parse(e)}catch(e){return null}}(r[2])))if(this.align(2),t)for(let e=0;e<i.length;e++)this.emitShort(i.charCodeAt(e));else for(let e=0;e<i.length+1;e+=2)this.emitShort(n(i,e+1)<<8|n(i,e));else this.directiveError(b("expecting string"))}parseNumber(e){e=this.parseOneInt(e.shift());return null==e?null:e}parseNumbers(e){e=e.slice(1);for(var t=[];;){var n=this.parseNumber(e);if(null==n){this.directiveError(b("cannot parse number at '{0}'",e[0]));break}if(t.push(n),","!=e[0]){if(null==e[0])break;this.directiveError(b("expecting number, got '{0}'",e[0]));break}if(e.shift(),null==e[0])break}return t}emitSpace(e){var t=this.parseNumbers(e);if(1==t.length&&t.push(0),2!=t.length)this.directiveError(b("expecting one or two numbers"));else if(t[0]%2!=0)this.directiveError(b("only even space supported"));else{var n=255&t[1];n|=n<<8;for(let e=0;e<t[0];e+=2)this.emitShort(n)}}emitBytes(e){var t=this.parseNumbers(e);t.length%2!=0&&(this.directiveError(".bytes needs an even number of arguments"),t.push(0));for(let e=0;e<t.length;e+=2){var n=t[e],i=t[e+1];0<=n&&i<=255&&0<=i&&n<=255?this.emitShort(255&n|(255&i)<<8):this.directiveError(b("expecting uint8"))}}emitHex(e){e.slice(1).forEach(t=>{if(","!=t)if(t.length%4!=0)this.directiveError(".hex needs an even number of bytes");else if(/^[a-f0-9]+$/i.test(t))for(let e=0;e<t.length;e+=4){var n=parseInt(t.slice(e,e+4),16);this.emitShort((255&n)<<8|n>>8&255)}else this.directiveError(".hex needs a hex number")})}handleDirective(e){let t,n=e.words,i=()=>{2!=n.length&&this.directiveError(b("expecting one argument"))};switch(n[0]){case".ascii":case".asciz":case".string":this.emitString(e.text);break;case".utf16":this.emitString(e.text,!0);break;case".align":if(i(),null!=(t=this.parseOneInt(n[1]))){if(0==t)return;t<=4?this.align(1<<t):this.directiveError(b("expecting 1, 2, 3 or 4 (for 2, 4, 8, or 16 byte alignment)"))}else this.directiveError(b("expecting number"));break;case".balign":if(i(),null!=(t=this.parseOneInt(n[1]))){if(1==t)return;2==t||4==t||8==t||16==t?this.align(t):this.directiveError(b("expecting 2, 4, 8, or 16"))}else this.directiveError(b("expecting number"));break;case".p2align":i(),null!=(t=this.parseOneInt(n[1]))?this.align(1<<t):this.directiveError(b("expecting number"));break;case".byte":this.emitBytes(n);break;case".hex":this.emitHex(n);break;case".hword":case".short":case".2bytes":this.parseNumbers(n).forEach(e=>{-32768<=e&&e<=65535?this.emitShort(65535&e):this.directiveError(b("expecting int16"))});break;case".word":case".4bytes":case".long":this.parseNumbers(n).forEach(e=>{-2147483648<=e&&e<=4294967295?(this.emitShort(65535&e),this.emitShort(e>>16&65535)):this.directiveError(b("expecting int32"))});break;case".skip":case".space":this.emitSpace(n);break;case".set":case".equ":/^\w+$/.test(n[1])||this.directiveError(b("expecting name"));var r=this.parseNumbers(n.slice(","==n[2]||"="==n[2]?2:1));1!=r.length&&this.directiveError(b("expecting one value")),void 0!==this.equs[n[1]]&&this.equs[n[1]]!=r[0]&&this.directiveError(b("redefinition of {0}",n[1])),this.equs[n[1]]=r[0];break;case".startaddr":this.location()&&this.directiveError(b(".startaddr can be only be specified at the beginning of the file")),i(),this.baseOffset=this.parseOneInt(n[1]);break;case"@stackmark":i(),this.stackpointers[n[1]]=this.stack;break;case"@stackempty":this.checkStack&&(null==this.stackpointers[n[1]]?this.directiveError(b("no such saved stack")):this.stackpointers[n[1]]!=this.stack&&this.directiveError(b("stack mismatch")));break;case"@scope":this.scope=n[1]||"",this.currLineNo=this.scope?0:this.realCurrLineNo;break;case".syntax":case"@nostackcheck":this.checkStack=!1;break;case"@dummystack":i(),this.stack+=this.parseOneInt(n[1]);break;case".section":case".global":this.stackpointers={},this.stack=0,this.scope="$S"+this.scopeId++;break;case".comm":(n=n.filter(e=>","!=e)).shift();var r=this.parseOneInt(n[1]),s=n[2]?this.parseOneInt(n[2]):4;if(null==this.lookupLabel(n[0])){for(this.commPtr||(this.commPtr=this.lookupExternalLabel("_pxt_comm_base")||0,this.commPtr)||this.directiveError(b("PXT_COMM_BASE not defined"));this.commPtr&s-1;)this.commPtr++;this.labels[this.scopedName(n[0])]=this.commPtr-this.baseOffset,this.commPtr+=r}break;case".file":case".text":case".cpu":case".fpu":case".eabi_attribute":case".code":case".thumb_func":case".type":case".fnstart":case".save":case".size":case".fnend":case".pad":case".globl":case".local":case"@":break;default:/^\.cfi_/.test(n[0])||this.directiveError(b("unknown directive"))}}handleOneInstruction(e,t){var n=t.emit(e);return!n.error&&(this.stack+=n.stack,this.checkStack&&this.stack<0&&this.pushError(b("stack underflow")),e.location=this.location(),e.opcode=n.opcode,e.stack=n.stack,this.emitOpCode(n.opcode),null!=n.opcode2&&this.emitOpCode(n.opcode2),null!=n.opcode3&&this.emitOpCode(n.opcode3),e.instruction=t,e.numArgs=n.numArgs,!0)}handleInstruction(i){if(!i.instruction||!this.handleOneInstruction(i,i.instruction)){var r=e=>this.ei.instructions.hasOwnProperty(e)?this.ei.instructions[e]:[];if(!i.instruction){var s=r(i.words[0]);for(let e=0;e<s.length;++e)if(this.handleOneInstruction(i,s[e]))return}let e=i.words[0].toLowerCase().replace(/s$/,"").replace(/[^a-z]/g,""),n="",t=r(e).concat(r(e+"s"));0<t.length&&t.forEach(e=>{var t=e.emit(i);n+=b("   Maybe: {0} ({1} at '{2}')\n",e.toString(),t.error,t.errorAt)}),this.pushError(b("assembly error"),n)}}buildLine(e,t){let n=e=>{e=new l(this,e);return e.scope=this.scope,e.lineNo=this.currLineNo,t.push(e),e},i=n(e),r=o(i.text)||[],s=(i.words=r)[0]||"";if(":"==s.charAt(s.length-1)){var a=/^([\.\w]+):$/.exec(r[0]);if(a){if(i.type="label",i.text=a[1]+":",i.words=[a[1]],!(1<r.length))return;r.shift(),(i=n(e.replace(/^[^:]*:/,""))).words=r,s=r[0]||""}}a=s.charAt(0);"."==a||"@"==a?(i.type="directive","@scope"==i.words[0]&&this.handleDirective(i)):0==i.words.length?i.type="empty":i.type="instruction"}prepLines(e){this.currLineNo=0,this.realCurrLineNo=0,this.lines=[],e.split(/\r?\n/).forEach(e=>{10<this.errors.length||(this.currLineNo++,this.realCurrLineNo++,this.buildLine(e,this.lines))})}iterLines(){this.stack=0,this.buf=[],this.scopeId=0,this.lines.forEach(e=>{var t,n;10<this.errors.length||0==(this.currLine=e).words.length||("label"==e.type?(t=this.scopedName(e.words[0]),this.prevLabel=t,this.finalEmit?(null!=this.equs[t]&&this.directiveError(b(".equ redefined as label")),null==(n=this.labels[t])&&g.oops(),0==this.errors.length&&n!=this.location()&&g.oops(`invalid location: ${this.location()} != ${n} at `+t),g.assert(0<this.errors.length||n==this.location()),this.reallyFinalEmit&&(this.stackAtLabel[t]=this.stack)):this.labels.hasOwnProperty(t)?this.directiveError(b("label redefinition")):this.inlineMode&&/^_/.test(t)?this.directiveError(b("labels starting with '_' are reserved for the compiler")):this.labels[t]=this.location(),e.location=this.location()):"directive"==e.type?this.handleDirective(e):"instruction"==e.type?this.handleInstruction(e):"empty"!=e.type&&g.oops())})}getSource(i,e=1,t=0){let n=0,r=e=>{var e=this.labels[e]||n,t=e-n;return n=e,t},s=this.buf?this.location():0,a=r("_code_end"),o=r("_helpers_end"),l=r("_vtables_end"),c=r("_literals_end"),u=n,h=s+this.baseOffset&16777215,d=(t&&t<h&&g.U.userError(b("program too big by {0} bytes!",h-t)),b("; total bytes: {0} ({1}% of {2}k flash with {3} free)",h,(100*h/(t=t||131072)).toFixed(1),(t/1024).toFixed(1),t-h)),p=b("; generated code sizes (bytes): {0} (incl. {1} user, {2} helpers, {3} vtables, {4} lits); src size {5}\n",u,a,o,l,c,s-u)+b("; assembly: {0} lines; density: {1} bytes/stmt; ({2} stmts)\n",this.lines.length,Math.round(100*a/e)/100,e)+d+"\n"+this.stats+"\n\n",f=!1;return this.lines.forEach((t,n)=>{if("_stored_program"==t.words[0])p+='_stored_program: .string "..."\n',f=!0;else if(f)f=!1;else{let e=t.text;if(i){if("@stackempty"==t.words[0]&&this.lines[n-1].text==t.text)return;if(!(e=e.replace(/; WAS: .*/,"")).trim())return}!m.debug||"label"!=t.type&&"instruction"!=t.type||(e+=` 	; 0x`+(t.location+this.baseOffset).toString(16)),p+=e+"\n"}}),p}peepHole(){var t=this.lines.filter(e=>"empty"!=e.type);for(let e=0;e<t.length;++e){var n,i,r=t[e];/^user/.test(r.scope)||(n=t[e+1])&&(i=t[e+2],"instruction"==r.type)&&this.ei.peephole(r,n,i)}}clearLabels(){this.labels={},this.commPtr=0}peepPass(e){this.disablePeepHole||(this.peepOps=0,this.peepDel=0,this.peepCounts={},this.peepHole(),this.throwOnError=!0,this.finalEmit=!1,this.clearLabels(),this.iterLines(),g.assert(!this.checkStack||0==this.stack),this.finalEmit=!0,this.reallyFinalEmit=e||0==this.peepOps,this.iterLines(),this.stats+=b("; peep hole pass: {0} instructions removed and {1} updated\n",this.peepDel,this.peepOps-this.peepDel))}getLabels(){return this.userLabelsCache||(this.userLabelsCache=g.U.mapMap(this.labels,(e,t)=>t+this.baseOffset)),this.userLabelsCache}emit(e){if(g.assert(null==this.buf),this.prepLines(e),!(0<this.errors.length||(this.clearLabels(),this.iterLines(),this.checkStack&&0!=this.stack&&this.directiveError(b("stack misaligned at the end of the file")),0<this.errors.length)||(this.ei.expandLdlit(this),this.clearLabels(),this.iterLines(),this.finalEmit=!0,this.reallyFinalEmit=this.disablePeepHole,this.iterLines(),0<this.errors.length))){for(let e=0;e<5&&(pxt.debug("Peephole OPT, pass "+e),this.peepPass(5==e),0!=this.peepOps);++e);pxt.debug("emit done")}}}function o(t){let n=[],i="";e:for(let e=0;e<t.length;++e)switch(t[e]){case"[":case"]":case"!":case"{":case"}":case",":i&&(n.push(i),i=""),n.push(t[e]);break;case" ":case"\t":case"\r":case"\n":i&&(n.push(i),i="");break;case";":break e;default:i+=t[e]}return i&&(n.push(i),i=""),n[0]?n:null}function f(e,t){return{stack:null,opcode:null,error:e,errorAt:t}}function s(e){return(e<0||65535<e?"0x"+e.toString(16):"0x"+("000"+e.toString(16)).slice(-4)).toLowerCase()}m.File=a,m.VMFile=class extends a{constructor(e){super(e)}},m.AbstractProcessor=class{constructor(){this.file=null,this.addEnc=(e,t,n)=>{t={name:e,pretty:t,encode:n,isRegister:/^\$r\d/.test(e),isImmediate:/^\$i\d/.test(e),isRegList:/^\$rl\d/.test(e),isLabel:/^\$l[a-z]/.test(e)};return this.encoders[e]=t},this.inrange=(e,t,n)=>Math.floor(t)!=t||t<0||e<t?null:n,this.inminmax=(e,t,n,i)=>Math.floor(n)!=n||n<e||t<n?null:i,this.inseq=(e,t)=>{e=e.indexOf(t);return e<0?null:e},this.inrangeSigned=(e,t,n)=>Math.floor(t)!=t||(t<-(e+1)||e<t)?null:n&(e<<1|1),this.addInst=(e,t,n,i)=>{e=new r(this,e,t,n,i);return this.instructions.hasOwnProperty(e.name)||(this.instructions[e.name]=[]),this.instructions[e.name].push(e),e},this.encoders={},this.instructions={}}toFnPtr(e,t,n){return e}wordSize(){return-1}computeStackOffset(e,t){return t}is32bit(e){return!1}emit32(e,t,n){return null}postProcessRelAddress(e,t){return t}postProcessAbsAddress(e,t){return t}peephole(e,t,n){}registerNo(e){return null}getAddressFromLabel(e,t,n,i=0){return null}isPop(e){return!1}isPush(e){return!1}isAddSP(e){return!1}isSubSP(e){return!1}testAssembler(){g.assert(!1)}expandLdlit(e){}},m.emitErr=f,m.expectError=function(e,t){e=new a(e);e.emit(t),0==e.errors.length&&g.oops("ASMTEST: expecting error for: "+t)},m.tohex=s,m.expect=function(e,t){let n=[],i=t.replace(/^([0-9a-fA-F]{4,8})\s/gm,(e,t)=>(n.push(parseInt(t.slice(0,4),16)),8==t.length&&n.push(parseInt(t.slice(4,8),16)),"")),r=new a(e);r.throwOnError=!0,r.disablePeepHole=!0,r.emit(i),0<r.errors.length&&(console.debug(r.errors[0].message),g.oops("ASMTEST: not expecting errors")),r.buf.length!=n.length&&g.oops("ASMTEST: wrong buf len");for(let e=0;e<n.length;++e)r.buf[e]!=n[e]&&g.oops("ASMTEST: wrong buf content at "+e+" , exp:"+s(n[e])+", got: "+s(r.buf[e]))}}}(ts=ts||{}),function(o){{var i=o.Cloud||(o.Cloud={}),r=pxtc.Util;i.apiRoot=o.BrowserUtils.isLocalHost()||r.isNodeJS?"https://www.makecode.com/api/":"/api/",i.accessToken="";let n=!(i.localToken="");function s(e){let t=new Error(r.lf("Cannot access {0} while offline",e));return t.isOffline=!0,o.U.delay(1e3).then(()=>Promise.reject(t))}function l(e,t){return o.U.requestAsync({url:"/api/"+e,headers:{Authorization:i.localToken},method:t?"POST":"GET",data:t||void 0,allowHttpErrors:!0})}function c(){return o.webConfig&&!o.webConfig.isStatic&&!o.BrowserUtils.isLocalHost()&&!!o.webConfig.cdnUrl}function e(e){var t;return e=e.replace(/^\//,""),c()?(t=(t=new Date).getUTCFullYear()+("0"+(t.getUTCMonth()+1)).slice(-2)+("0"+t.getUTCDate()).slice(-2),e.indexOf("?")<0?e+="?":e+="&",o.webConfig.cdnUrl+"/api/"+(e+="cdn="+t)):i.apiRoot+e}function u(t){return c()?(t.url=e(t.url),r.requestAsync(t).catch(e=>a(t,e))):h(t)}function a(e,t){return 0==t.statusCode?(n&&(n=!1,i.onOffline()),s(e.url)):Promise.reject(t)}function h(t){var e;return t.url=null!=(e=o.webConfig)&&e.isStatic&&!t.forceLiveEndpoint?o.webConfig.relprefix+t.url:i.apiRoot+t.url,t.allowGzipPost=!0,i.isOnline()||o.BrowserUtils.isPxtElectron()?(t.headers||(t.headers={}),o.BrowserUtils.isLocalHost()?i.localToken&&(t.headers.Authorization=i.localToken):i.accessToken&&(t.headers["x-td-access-token"]=i.accessToken),r.requestAsync(t).catch(e=>a(t,e))):s(t.url)}function t(){return navigator&&navigator.onLine}i.onOffline=()=>{},i.hasAccessToken=function(){return!!i.accessToken},i.localRequestAsync=l,i.useCdnApi=c,i.cdnApiUrl=e,i.apiRequestWithCdnAsync=u,i.privateRequestAsync=h,i.privateGetTextAsync=function(e,t){return h({url:e,headers:t}).then(e=>e.text)},i.privateGetAsync=function(e,t=!1){return h({url:e,forceLiveEndpoint:t}).then(e=>e.json)},i.downloadTargetConfigAsync=function(){var e;return i.isOnline()?(e=o.appTarget.versions&&o.appTarget.versions.target,e=o.webConfig&&o.webConfig.isStatic?"targetconfig.json":`config/${o.appTarget.id}/targetconfig`+(e?"/v"+e:""),o.BrowserUtils.isLocalHost()?l(e).then(e=>e?e.json:void 0):u({url:e}).then(e=>e.json)):Promise.resolve(void 0)},i.downloadScriptFilesAsync=function(e){return h({url:e+"/text",forceLiveEndpoint:!0}).then(e=>JSON.parse(e.text))},i.markdownAsync=async function(t,n){var e=o.BrowserUtils.isLocalHostDev()?0:36e5,i=24*e*7;n=n||o.Util.userLanguage();const r=await o.BrowserUtils.translationDbAsync(),s=await r.getAsync(n,t,""),a=async()=>{try{var e=await function(e,t,n){var i=null==(i=o.webConfig)?void 0:i.isStatic,r=o.appTarget.versions&&o.appTarget.versions.target||"?";let s;if(i){s=e;const o=/\/?docs\//.test(s),t=/\.\w+$/.test(s);if(!o){const o="/"===s[0];s="docs"+(o?"":"/")+s}t||(s+=".md")}else s=`md/${o.appTarget.id}/${e.replace(/^\//,"")}?targetVersion=`+encodeURIComponent(r);if("en"!=t&&(s+=`${i?"?":"&"}lang=`+encodeURIComponent(t)),o.BrowserUtils.isLocalHost()&&!o.Util.liveLocalizationEnabled())return l(s).then(e=>404==e.statusCode?h({url:s,method:"GET"}).then(e=>({md:e.text,etag:e.headers.etag})):{md:e.text,etag:void 0});{const o=n&&!c()?{"If-None-Match":n}:void 0;return u({url:s,method:"GET",headers:o}).then(e=>({md:e.text,etag:e.headers.etag}))}}(t,n,null==s?void 0:s.etag);return(!s||e.md&&s.md!==e.md?(await r.setAsync(n,t,"",e.etag,void 0,e.md),e):s).md}catch(e){return""}};if(s){const t=Date.now()-s.time,n=t>e;if(t>i)o.tickEvent("markdown.update.wait");else if(n&&(o.tickEvent("markdown.update.background"),a()),s.md)return s.md}return a()},i.privateDeleteAsync=function(e){return h({url:e,method:"DELETE"}).then(e=>e.json)},i.privatePostAsync=function(e,t,n=!1){return h({url:e,data:t||{},forceLiveEndpoint:n}).then(e=>e.json)},i.isLoggedIn=function(){return!!i.accessToken},i.isNavigatorOnline=t,i.isOnline=function(){return n="undefined"!=typeof navigator&&t()?!0:n},i.getServiceUrl=function(){return i.apiRoot.replace(/\/api\/$/,"")},i.getUserId=function(){var e=/^0(\w+)\./.exec(i.accessToken);return e?e[1]:null},i.parseScriptId=function(t){var n=o.appTarget;if(t&&n.appTheme&&n.cloud&&n.cloud.sharing){let e=["makecode.com"];n.appTheme.embedUrl&&e.push(n.appTheme.embedUrl),n.appTheme.shareUrl&&e.push(n.appTheme.shareUrl);n=`^((https://)?(?:${(e=r.unique(e,e=>e).map(e=>r.escapeForRegex(r.stripUrlProtocol(e).replace(/\/$/,"")).toLowerCase())).join("|")})/)?(?:v[0-9]+/)?(api/oembed?url=.*%2F([^&]*)&.*?|([a-z0-9-_]+))$`,n=new RegExp(n,"i").exec(t.trim()),t=n&&(!n[1]||0<=e.indexOf(r.escapeForRegex(n[1].replace(/https:\/\//,"").replace(/\/$/,"")).toLowerCase()))&&(n[3]||n[4])?n[3]||n[4]:null;return t&&("_"==t[0]&&13==t.length||23==t.length&&/^[0-9\-]+$/.test(t))?t:void 0}}}}(pxt=pxt||{}),function(e){(e.pxtc||(e.pxtc={})).f4EncodeImg=function(e,n,i,r){let t=[135,i,255&e,e>>8,255&n,n>>8,0,0].map(c).join(""),s=4,a=0,o=0,l=e=>{a|=e<<o,o==8-i?(t+=c(a),s++,a=0,o=0):o+=i};for(let t=0;t<e;++t){for(let e=0;e<n;++e)l(r(t,e));for(;0!=o;)l(0);if(1<i)for(;3&s;)l(0)}return t;function c(e){return("0"+e.toString(16)).slice(-2)}}}(ts=ts||{}),function(e){function s(e){let t="";switch(e){case 0:t="C5";break;case 1:t="B";break;case 2:t="A";break;case 3:t="G";break;case 4:t="F";break;case 5:t="E";break;case 6:t="D";break;case 7:t="C"}return t}function i(e){let t=-1;switch(e){case"C5":t=0;break;case"B":t=1;break;case"A":t=2;break;case"G":t=3;break;case"F":t=4;break;case"E":t=5;break;case"D":t=6;break;case"C":t=7}return t}e.MelodyArray=class{constructor(e){this.numCols=8,this.numRows=8,this.polyphonic=!1,e&&(this.tempo=e),this.resetMelody()}setTempo(e){this.tempo=e}getArray(){return this.melody}setArray(e){this.melody=e}getColor(e){return 0}getValue(e,t){return this.melody[e][t]}getWidth(){return this.numCols}getHeight(){return this.numRows}updateMelody(e,t){var n=!this.melody[e][t];if(n&&!this.polyphonic)for(let e=0;e<this.numRows;e++)this.melody[e][t]=!1;this.melody[e][t]=n}getStringRepresentation(){let t="",i=new Array(this.numCols),r=0;for(let n=0;n<this.numRows;n++){let t=0;i[n]=[];for(let e=0;e<this.numCols;e++)this.melody[e][n]&&(i[n].push(s(e)),t++);t>r&&(r=t)}if(0==r)return"- - - - - - - - ";for(let e=0;e<r;e++)for(let e=0;e<this.numCols;e++)i[e]&&0<i[e].length?t+=i[e].shift()+" ":t+="- ";return t}parseNotes(e){var n=(e=e.trim()).split(" ");for(let t=0;t<n.length;t++){for(let e=0;e<this.numRows;e++)this.melody[e][t]=!1;"-"!=n[t]&&(this.melody[i(n[t])][t]=!0)}}setPolyphonic(e){this.polyphonic=e}isPolyphonic(){return this.polyphonic}resetMelody(){this.melody=new Array(this.numCols);for(let e=0;e<this.numCols;e++)this.melody[e]=new Array(this.numRows).fill(!1)}},e.rowToNote=s,e.noteToRow=i,e.getColorClass=function(e){let t="melody-default";switch(e){case 0:t="melody-red";break;case 1:t="melody-orange";break;case 2:t="melody-yellow";break;case 3:t="melody-green";break;case 4:t="melody-teal";break;case 5:t="melody-blue";break;case 6:t="melody-purple";break;case 7:t="melody-violet"}return t}}(pxtmelody=pxtmelody||{}),function(s){function c(e,t,n){var i=document.createElement(e),r=t,s=n;if(r)for(const s of Object.keys(r))"className"===s?i.setAttribute("class",r[s]+""):i.setAttribute(s,r[s]+"");return s&&i.addEventListener("click",s),i}s.MelodyGallery=class{constructor(){this.value=null,this.visible=!1,this.timeouts=[],this.numSamples=s.SampleMelodies.length,this.containerDiv=document.createElement("div"),this.containerDiv.setAttribute("id","melody-editor-gallery-outer"),this.contentDiv=document.createElement("div"),this.contentDiv.setAttribute("id","melody-editor-gallery"),this.itemBackgroundColor="#DCDCDC",this.itemBorderColor="white",this.initStyles(),this.containerDiv.appendChild(this.contentDiv),this.containerDiv.style.display="none",this.contentDiv.addEventListener("animationend",()=>{this.visible||(this.containerDiv.style.display="none")}),this.contentDiv.addEventListener("wheel",e=>{e.stopPropagation()},!0)}getElement(){return this.containerDiv}getValue(){return this.value}show(e){this.pending=e,this.containerDiv.style.display="block",this.buildDom(),this.visible=!0,pxt.BrowserUtils.removeClass(this.contentDiv,"hidden-above"),pxt.BrowserUtils.addClass(this.contentDiv,"shown")}hide(){this.visible=!1,pxt.BrowserUtils.removeClass(this.contentDiv,"shown"),pxt.BrowserUtils.addClass(this.contentDiv,"hidden-above"),this.value=null,this.stopMelody()}clearDomReferences(){this.contentDiv=null,this.containerDiv=null}layout(e,t,n){this.containerDiv.style.left=e+"px",this.containerDiv.style.top=t+"px",this.containerDiv.style.height=n+"px"}buildDom(){for(;this.contentDiv.firstChild;)this.contentDiv.removeChild(this.contentDiv.firstChild);var t=s.SampleMelodies;this.buttons=[];for(let e=0;e<t.length;e++)this.mkButton(t[e],e,"255px","45px")}initStyles(){var e=document.createElement("style");e.textContent="\n            #melody-editor-gallery {\n                margin-top: -100%;\n            }\n\n            #melody-editor-gallery.hidden-above {\n                margin-top: -100%;\n                animation: slide-up 0.2s 0s ease;\n            }\n\n            #melody-editor-gallery.shown {\n                margin-top: 0px;\n                animation: slide-down 0.2s 0s ease;\n            }\n\n            @keyframes slide-down {\n                0% {\n                    margin-top: -100%;\n                }\n                100% {\n                    margin-top: 0px;\n                }\n            }\n\n            @keyframes slide-up {\n                0% {\n                    margin-top: 0px;\n                }\n                100% {\n                    margin-top: -100%;\n                }\n            }\n            ",this.containerDiv.appendChild(e)}mkButton(e,t,n,i){var r=c("div",{className:"melody-gallery-button melody-editor-card",role:"menuitem",id:":"+t}),s=c("i",{className:"music icon melody-icon"}),a=c("div",{className:"melody-editor-text"}),o=(a.innerText=e.name,this.createColorBlock(e)),l=c("div",{className:"melody-editor-button left-button",role:"button",title:e.name},()=>this.handleSelection(e)),s=(l.appendChild(s),l.appendChild(a),l.appendChild(o),r.appendChild(l),c("div",{className:"melody-editor-button right-button",role:"button",title:lf("Preview {0}",e.name)},()=>this.togglePlay(e,t))),a=c("i",{className:"play icon"});this.buttons[t]=a,s.appendChild(a),r.appendChild(s),this.contentDiv.appendChild(r)}handleSelection(e){var t;this.pending&&(t=this.pending,this.pending=void 0,t(e.notes))}playNote(e,t,n){let i=0;switch(e){case"C5":i=523;break;case"B":i=494;break;case"A":i=440;break;case"G":i=392;break;case"F":i=349;break;case"E":i=330;break;case"D":i=294;break;case"C":i=262}this.timeouts.push(setTimeout(()=>{pxt.AudioContextManager.tone(i)},t*this.getDuration(n))),this.timeouts.push(setTimeout(()=>{pxt.AudioContextManager.stop()},(t+1)*this.getDuration(n)))}getDuration(e){return 6e4/e}previewMelody(t){this.stopMelody();var n=t.notes.split(" ");for(let e=0;e<n.length;e++)this.playNote(n[e],e,t.tempo)}togglePlay(e,t){let n=this.buttons[t];pxt.BrowserUtils.containsClass(n,"play icon")?(this.resetPlayIcons(),pxt.BrowserUtils.removeClass(n,"play icon"),pxt.BrowserUtils.addClass(n,"stop icon"),this.previewMelody(e),this.timeouts.push(setTimeout(()=>{pxt.BrowserUtils.removeClass(n,"stop icon"),pxt.BrowserUtils.addClass(n,"play icon")},e.notes.split(" ").length*this.getDuration(e.tempo)))):(pxt.BrowserUtils.removeClass(n,"stop icon"),pxt.BrowserUtils.addClass(n,"play icon"),this.stopMelody())}stopMelody(){for(;this.timeouts.length;)clearTimeout(this.timeouts.shift());pxt.AudioContextManager.stop()}resetPlayIcons(){for(let e=0;e<this.numSamples;e++){var t=this.buttons[e];if(pxt.BrowserUtils.containsClass(t,"stop icon")){pxt.BrowserUtils.removeClass(t,"stop icon"),pxt.BrowserUtils.addClass(t,"play icon");break}}}createColorBlock(e){var t=document.createElement("div"),n=(pxt.BrowserUtils.addClass(t,"melody-color-block"),e.notes.split(" "));for(let e=0;e<n.length;e++){var i=s.getColorClass(s.noteToRow(n[e])),r=document.createElement("div");0==e?pxt.BrowserUtils.addClass(r,"left-edge sliver "+i):e==n.length-1?pxt.BrowserUtils.addClass(r,"right-edge sliver "+i):pxt.BrowserUtils.addClass(r,"sliver "+i),t.appendChild(r)}return t}}}(pxtmelody=pxtmelody||{}),function(e){class t{constructor(e,t,n){this.name=e,this.notes=t,this.tempo=n}}e.MelodyInfo=t,e.SampleMelodies=[new t(lf("Scale"),"C5 B A G F E D C",120),new t(lf("Reverse"),"C D E F G A B C5",120),new t(lf("Mystery"),"E B C5 A B G A F",120),new t(lf("Gilroy"),"A F E F D G E F",120),new t(lf("Falling"),"C5 A B G A F G E",120),new t(lf("Hopeful"),"G B A G C5 B A B",120),new t(lf("Tokyo"),"B A G A G F A C5",120),new t(lf("Paris"),"G F G A - F E D",120),new t(lf("Rising"),"E D G F B A C5 B",120),new t(lf("Sitka"),"C5 G B A F A C5 B",120)]}(pxtmelody=pxtmelody||{});