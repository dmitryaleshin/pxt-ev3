let iface;var pxt,LabelMode,pxtblockly;!function(N){{var w=N.blocks||(N.blocks={}),e;function s(e,t){return N.worker.getWorker(N.webConfig.workerjs).opAsync(e,t)}w.workerOpAsync=s;let l={};function S(e,t){e.push.apply(e,t)}function v(e){if(!e)throw new Error("Assertion failure")}class i{constructor(e,t,i,o,s){this.link=e,this.type=t,this.parentType=i,this.childType=o,this.isArrayType=s}}let I;function E(e){return e.link?E(e.link):e}function m(e,t){var i=E(e),o=E(t);if(v(null==i.link&&null==o.link),i!=o){if(i.childType&&o.childType){const e=i.childType;i.childType=null,m(e,o.childType)}else i.childType&&!o.childType&&(o.childType=i.childType);if(i.parentType&&o.parentType){const e=i.parentType;i.parentType=null,m(e,o.parentType)}else!i.parentType||o.parentType||o.type||(o.parentType=i.parentType);var s=function(e,t){if(null==e||"Array"===e&&y(t))return t;if(null==t||"Array"===t&&y(e))return e;if(e==t)return e;throw new Error("cannot mix "+e+" with "+t)}(i.type,o.type);e.link=o,i.link=o,i.isArrayType=o.isArrayType,e.type=null,t.type=s}}function b(e,t=!1){return new i(null,e,null,null,t)}w.Point=i,(e=I=w.BlockDeclarationType||(w.BlockDeclarationType={}))[e.None=0]="None",e[e.Argument=1]="Argument",e[e.Assigned=2]="Assigned",e[e.Implicit=3]="Implicit";const $=b("number"),K=b("boolean"),Y=b("string"),c=b("void");function g(e){if(!e)return b(e);switch(e.toLowerCase()){case"number":return $;case"boolean":return K;case"string":return Y;case"void":return c;default:return b(e)}}function D(t,i){if(v(null!=i),"placeholder"==i.type||i.type===pxtc.TS_OUTPUT_TYPE)return i.p||(i.p=b(null)),E(i.p);if("variables_get"==i.type)return E(M(t,i,i.getField("VAR").getText()).type);if("function_call_output"==i.type)return z(t,i.getField("function_name").getText());if(!i.outputConnection)return g(c.type);const o=i.outputConnection.check_&&i.outputConnection.check_.length?i.outputConnection.check_[0]:"T";if("Array"===o){if(1<i.outputConnection.check_.length)return g(i.outputConnection.check_[1]);let e;if("lists_create_with"==i.type){if(i.inputList&&i.inputList.length)for(const l of i.inputList)if(l.connection&&l.connection.targetBlock()){var s=E(D(t,l.connection.targetBlock()));if(s){if(s.parentType)return s.parentType;_(e=s.type?g(s.type+"[]"):b(null),s);break}}}else"argument_reporter_array"==i.type&&(e=e||g("any[]"));return e&&(e.isArrayType=!0),e||b(null,!0)}if("T"!==o)return g(o);{const o=t.stdCallTable[i.type],r="lists_index_get"===i.type;if(r||o&&o.comp.thisParameter){var e=r?i.inputList.find(e=>"LIST"===e.name):i.inputList.find(e=>e.name===o.comp.thisParameter.definitionName);if(e.connection&&e.connection.targetBlock()){const i=D(t,e.connection.targetBlock());if(i.childType)return i.childType;const o=y(i.type)&&"Array"!==i.type?b(i.type.substr(0,i.type.length-2)):b(null);return _(i,o),o}}return b(null)}}function z(i,o){if(!i.userFunctionReturnValues[o]){var s=Blockly.Functions.getDefinition(o,i.workspace);let t=b("void");if(de(s,!0))t=b("any");else{var e=[];for(const N of s.getDescendants(!1))"function_return"===N.type&&(f(i,N,"RETURN_VALUE"),e.push(D(i,O(N,"RETURN_VALUE"))));if(e.length)try{const N=b(null);for(const i of e)m(N,i);t=N}catch(e){i.diagnostics.push({blockId:s.id,message:N.Util.lf("Function '{0}' has an invalid return type",o)}),t=b("any")}}i.userFunctionReturnValues[o]=t}return i.userFunctionReturnValues[o]}function y(e){return e&&(-1!==e.indexOf("[]")||"Array"==e)}function f(e,t,i,o){var s=t.getInputTargetBlock(i);s?s.type!==pxtc.TS_OUTPUT_TYPE||s.p||(s.p=b(null)):(l[t.id]||(l[t.id]={}),l[t.id][i]||(l[t.id][i]=(s=e,i=t,{type:"placeholder",p:b(o||null),workspace:s.workspace,parentBlock_:i})))}function L(e){return"pxt_controls_for"==e.type||"pxt_controls_for_of"==e.type?O(e,"VAR"):e}function O(e,t){return e.getInputTargetBlock(t)||l[e.id]&&l[e.id][t]}function q(){l={}}function k(e,t,i,o){f(e,t,i);try{m(D(e,O(t,i)),o)}catch(e){}}function Q(e,p){function d(e){return e.name?e.connection&&e.connection.check_&&e.connection.check_.length?e.connection.check_[0]:"T":void 0}function h(e,t){let i=e.inputList.filter(e=>"T"===d(e));if(i.length){const d=O(e,i[0].name);if(d){const i=D(p,d),o=i.type?g(D(p,d).type+"[]"):g(null);return _(o,i),k(p,e,t,o),1}}}e&&e.filter(e=>e.isEnabled()).forEach(s=>{try{switch(s.type){case"math_op2":k(p,s,"x",g($.type)),k(p,s,"y",g($.type));break;case"math_op3":k(p,s,"x",g($.type));break;case"math_arithmetic":case"logic_compare":switch(s.getFieldValue("OP")){case"ADD":case"MINUS":case"MULTIPLY":case"DIVIDE":case"LT":case"LTE":case"GT":case"GTE":case"POWER":k(p,s,"A",g($.type)),k(p,s,"B",g($.type));break;case"AND":case"OR":f(p,s,"A",K.type),f(p,s,"B",K.type);break;case"EQ":case"NEQ":f(p,s,"A"),f(p,s,"B");var e=D(p,O(s,"A")),t=D(p,O(s,"B"));try{m(e,t)}catch(s){}}break;case"logic_operation":f(p,s,"A",K.type),f(p,s,"B",K.type);break;case"logic_negate":f(p,s,"BOOL",K.type);break;case"controls_if":for(let e=0;e<=s.elseifCount_;++e)f(p,s,"IF"+e,K.type);break;case"pxt_controls_for":case"controls_simple_for":k(p,s,"TO",g($.type));break;case"pxt_controls_for_of":case"controls_for_of":_(D(p,O(s,"LIST")),M(p,s,L(s).getField("VAR").getText()).type);break;case"variables_set":case"variables_change":var i=M(p,s,s.getField("VAR").getText()).type,o=(f(p,s,"VALUE"),O(s,"VALUE"));if(o){r=p;var l=null!=(a=null==(a=(n=o).outputConnection)?void 0:a.check_)&&a.length&&"Array"!==n.outputConnection.check_[0]&&"T"!==n.outputConnection.check_[0]?n.outputConnection.check_.map(e=>g(e)):[D(r,n)];const c=E(i);if(c.type&&l.slice(1).some(e=>e.type===c.type))i.link=E(l[0]);else try{m(i,l[0])}catch(s){}}break;case"controls_repeat_ext":k(p,s,"TIMES",g($.type));break;case"device_while":f(p,s,"COND",K.type);break;case"lists_index_get":k(p,s,"LIST",g("Array")),k(p,s,"INDEX",g($.type)),_(D(p,O(s,"LIST")),D(p,s));break;case"lists_index_set":k(p,s,"LIST",g("Array")),f(p,s,"VALUE"),h(s,"LIST"),k(p,s,"INDEX",g($.type));break;case"function_definition":z(p,s.getField("function_name").getText());break;case"function_call":case"function_call_output":s.getArguments().forEach(e=>{k(p,s,e.id,g(e.type))});break;case pxtc.TS_RETURN_STATEMENT_TYPE:f(p,s,"RETURN_VALUE");break;case pxtc.PAUSE_UNTIL_TYPE:k(p,s,"PREDICATE",K);break;default:if(s.type in p.stdCallTable){const u=p.stdCallTable[s.type];"ENUM_GET"!==u.attrs.shim&&"KIND_GET"!==u.attrs.shim&&j(u,W(s)).forEach((t,e)=>{e=u.isExtensionMethod&&0===e;if(t.definitionName&&!s.getFieldValue(t.definitionName)){var i=s.inputList.find(e=>e.name==t.definitionName);if(i&&i.connection&&i.connection.check_&&(!e||"Array"!==d(i)||!h(s,t.definitionName)))for(let e=0;e<i.connection.check_.length;e++)try{var o=i.connection.check_[e];k(p,s,t.definitionName,g(o));break}catch(e){}}})}}}catch(e){const d=e.block||s;d.setWarningText(e+""),p.errors.push(d)}var r,n,a}),p.allVariables.forEach(e=>{null==R(e.type).type&&m(e.type,g(e.type.isArrayType?"number[]":$.type))})}function _(e,t){e=E(e),t=E(t);e.childType?m(e.childType,t):e.type||(e.childType=t),t.parentType?m(t.parentType,e):t.type||(t.parentType=e),y(e.type)&&(e.isArrayType=!0)}function R(e,t=[]){var i=E(e);if(-1===t.indexOf(i)&&(t.push(i),!i.type||"Array"===i.type)){if(i.parentType){const e=R(i.parentType,t);if(e.type&&"Array"!==e.type)return y(e.type)?i.type=e.type.substr(0,e.type.length-2):i.type=e.type,i}if(i.childType){const e=R(i.childType,t);if(e.type)i.type=e.type+"[]"}}return i}function J(e){var t=e.getFieldValue("math_number_minmax"===e.type?"SLIDER":"NUM"),t=parseFloat(t),i=t;if(!isFinite(i)||isNaN(i))throw i=lf("Number entered is either too large or too small"),e=e,(i=new Error(i)).block=e,i;return t}let x={ADD:"+",MINUS:"-",MULTIPLY:"*",DIVIDE:"/",LT:"<",LTE:"<=",GT:">",GTE:">=",AND:"&&",OR:"||",EQ:"==",NEQ:"!=",POWER:"**"};function Z(t,i,o,e){var s=P(i.getField("function_name").getText(),t,!0),l=!i.getInputsInline(),r=i.getArguments().map(e=>({actualName:e.name,definitionName:e.id})).map(e=>U(t,i,e,o)),s=w.H.stdCall(s,r,l);return e?w.mkStmt(s):s}function ee(e){e=e.getContent();return w.Helpers.mkMultiComment(e.trim())}function B(e){if(null==e.type&&(m(e,g($.type)),e=E(e)),y(e.type)||e.isArrayType)return w.mkText("[]");switch(e.type){case"boolean":return w.H.mkBooleanLiteral(!1);case"number":return w.H.mkNumberLiteral(0);case"string":return w.H.mkStringLiteral("");default:return w.mkText("null")}}function F(t,i,o){let s;if(v(null!=i),t.stats[i.type]=(t.stats[i.type]||0)+1,le(i,o),"placeholder"!=i.type&&i.isEnabled&&i.isEnabled())switch(i.type){case"math_number":case"math_integer":case"math_whole_number":case"math_number_minmax":s=w.H.mkNumberLiteral(J(i));break;case"math_op2":s=(k=t,y=o,_=(b=i).getFieldValue("op"),T=F(k,O(b,"x"),y),k=F(k,O(b,"y"),y),w.H.mathCall(_,[T,k]));break;case"math_op3":s=function(e){e=F(t,O(i,"x"),e);return w.H.mathCall("abs",[e])}(o);break;case"math_arithmetic":case"logic_compare":case"logic_operation":s=function(e,t,i){var o=t.getFieldValue("OP"),s=O(t,"A"),t=O(t,"B"),t=[F(e,s,i),F(e,t,i)],i=D(e,s).type;if(i==Y.type){if("EQ"==o)return w.H.mkSimpleCall("==",t);if("NEQ"==o)return w.H.mkSimpleCall("!=",t)}else if(i==K.type)return w.H.mkSimpleCall(x[o],t);return v(o in x),w.H.mkSimpleCall(x[o],t)}(t,i,o);break;case"math_modulo":s=(b=t,y=o,T=O(_=i,"DIVIDEND"),_=O(_,"DIVISOR"),T=[F(b,T,y),F(b,_,y)],w.H.mkSimpleCall("%",T));break;case"logic_boolean":s=w.H.mkBooleanLiteral("TRUE"==i.getFieldValue("BOOL"));break;case"logic_negate":s=function(e){e=F(t,O(i,"BOOL"),e);return w.mkPrefix("!",[w.H.mkParenthesizedExpression(e)])}(o);break;case"variables_get":s=(k=t,f=(g=i).getField("VAR").getText(),(k=M(k,g,f))?(k.firstReference||(k.firstReference=g),v(null!=k&&null!=k.type),w.mkText(k.escapedName)):w.mkText(f));break;case"text":s=w.H.mkStringLiteral(i.getFieldValue("TEXT"));break;case"text_join":s=function(e,t,i){let o,s=0;for(;;){var l=O(t,"ADD"+s);if(s++,!l){if(s<t.inputList.length)continue;break}var r=F(e,l,i);o=o?w.H.mkSimpleCall("+",[o,r]):0===l.type.indexOf("text")?r:w.H.mkSimpleCall("+",[w.H.mkStringLiteral(""),r])}return o||w.H.mkStringLiteral("")}(t,i,o);break;case"lists_create_with":s=(h=t,m=o,f=(g=i).inputList.map(e=>e.connection&&e.connection.targetBlock()?F(h,e.connection.targetBlock(),m):void 0).filter(e=>!!e),w.H.mkArrayLiteral(f,!g.getInputsInline()));break;case"lists_index_get":s=(p=o,d=F(c=t,O(u=i,"LIST"),p),c=F(c,O(u,"INDEX"),p),w.mkGroup([d,w.mkText("["),c,w.mkText("]")]));break;case"lists_index_set":s=(u=t,p=o,c=O(d=i,"LIST"),n=F(u,c,p),a=F(u,O(d,"INDEX"),p),u=F(u,O(d,"VALUE"),p),d=w.mkGroup([n,w.mkText("["),a,w.mkText("] = "),u]),"lists_create_with"===c.type?A(d):d);break;case"math_js_op":case"math_js_round":s=(n=t,a=o,l=(e=i).getFieldValue("OP"),r=[F(n,O(e,"ARG0"),a)],e.getInput("ARG1")&&r.push(F(n,O(e,"ARG1"),a)),w.H.mathCall(l,r));break;case pxtc.TS_OUTPUT_TYPE:s=w.mkText(i.getFieldValue("EXPRESSION").trim());break;case"argument_reporter_boolean":case"argument_reporter_number":case"argument_reporter_string":case"argument_reporter_array":case"argument_reporter_custom":s=function(e){e=P(i.getFieldValue("VALUE"),e);return w.mkText(e)}(t);break;case"function_call_output":s=Z(t,i,o,!1);break;default:e=t.stdCallTable[i.type];s=e?e.imageLiteral?oe(0,i,e.imageLiteral,e.imageLiteralColumns,e.imageLiteralRows,e.namespace,e.f,j(e,W(i)).map(e=>U(t,i,e,o))):ie(t,i,e,o):(N.reportError("blocks","unable to compile expression",{details:i.type}),B(D(t,i)))}else if("Array"===E(D(t,i)).type){let e="lists_index_get"===i.parentBlock_.type;if(!e){const w=t.stdCallTable[i.parentBlock_.type];e=w&&w.isExpression}const o=w.mkText("[0]");s=e?o:A(o)}else s=B(D(t,i));var e,l,r,n,a,c,u,p,d,h,m,g,f,k,b,y,_,T;return s.id=i.id,s}function M(e,t,i){return function e(t,i){return i&&i.declaredVars[t]?i.declaredVars[t]:i&&i.parent?e(t,i.parent):null}(i,e.idToScope[t.id])}function P(e,t,i=!1){if(!e)return"_";if(i){if(t.renames.oldToNewFunctions[e])return t.renames.oldToNewFunctions[e]}else if(t.renames.oldToNew[e])return t.renames.oldToNew[e];let o=ts.pxtc.escapeIdentifier(e);if(t.renames.takenNames[o]){let e=2;for(;t.renames.takenNames[o+e];)e++;o+=e}return i?(t.renames.oldToNewFunctions[e]=o,t.renames.takenNames[o]=!0):t.renames.oldToNew[e]=o,o}function te(t,i,o){var s=t.stdCallTable[i.type];{if(s.imageLiteral)return w.mkStmt(oe(0,i,s.imageLiteral,s.imageLiteralColumns,s.imageLiteralRows,s.namespace,s.f,j(s,W(i)).map(e=>U(t,i,e,o))));if(s.hasHandler){var l=t,r=i,n=s,a=j(s,W(i)).filter(e=>!!e.definitionName),c=s.namespace,u=o,p,d,h,m,a=a.map(e=>U(l,r,e,u)),g=O(r,"HANDLER"),g=V(l,g);N.appTarget.compile&&N.appTarget.compile.emptyEventHandlerComments&&0===g.children.length&&g.children.unshift(w.mkStmt(w.mkText("// "+pxtc.HANDLER_COMMENT)));let e;return T(r)&&r.mutation.getMutationType()===w.MutatorTypes.ObjectDestructuringMutator?e=r.mutation.compileMutation(l,u):n.comp.handlerArgs.length&&(d=l,h=ne(p=r,n).map(e=>M(d,p,e[0]).escapedName),e=w.mkText(`function (${h.join(", ")})`)),[h,c,a,g,n,m=!1]=[c,n.f,a,g,e,n.isExtensionMethod],g.noFinalNewline=!0,n=n?w.mkGroup([n,g]):w.mkGroup([w.mkText("function ()"),g]),m?w.mkStmt(w.H.extensionCall(c,a.concat([n]),!1)):h?w.mkStmt(w.H.namespaceCall(h,c,a.concat([n]),!1)):w.mkStmt(w.H.mkCall(c,a.concat([n]),!1))}return w.mkStmt(ie(t,i,s,o))}}function U(e,t,i,o,s=!1){var l=t.getFieldValue(i.definitionName);if(null!=l){const o=t.getField(i.definitionName);if(o instanceof pxtblockly.FieldTextInput)return w.H.mkStringLiteral(l);if(o instanceof pxtblockly.FieldTilemap&&!o.isGreyBlock){const t=N.react.getTilemapProject(),i=o.getValue();if(i.startsWith("tilemap`"))return w.mkText(i);if(e.options.emitTilemapLiterals)try{const e=N.sprite.decodeTilemap(i,"typescript",t);if(e){const[N]=t.createNewTilemapFromData(e);return w.mkText(`tilemap\`${N}\``)}}catch(e){}}const s=e.blocksInfo.apis.byQName[i.type];if(s&&s.attributes.emitAsConstant)for(const N of Object.keys(e.blocksInfo.apis.byQName)){const t=e.blocksInfo.apis.byQName[N];if(t&&t.attributes&&t.attributes.enumIdentity===l)return w.mkText(N)}var r=w.mkText(l);return r.canIndentInside="string"==typeof l&&0<=l.indexOf("\n"),r}{f(e,t,i.definitionName);const N=O(t,i.definitionName);return s&&"lists_create_with"===N.type?A(F(e,N,o)):i.shadowOptions&&i.shadowOptions.toString&&D(e,N)!==Y?w.H.mkSimpleCall("+",[w.H.mkStringLiteral(""),w.H.mkParenthesizedExpression(F(e,N,o))]):F(e,N,o)}}function ie(i,o,s,l){let t;if(T(o)&&o.mutation.getMutationType()===w.MutatorTypes.RestParameterMutator)t=o.mutation.compileMutation(i,l).children;else{if("ENUM_GET"===s.attrs.shim){const i=s.attrs.enumName,l=o.getFieldValue("MEMBER").replace(/^\d+/,"");return w.H.mkPropertyAccess(l,w.mkText(i))}if("KIND_GET"===s.attrs.shim){const l=i.kinds.filter(e=>e.blockId===s.attrs.blockId)[0];return w.H.mkPropertyAccess(o.getFieldValue("MEMBER"),w.mkText(l.name))}t=j(s,W(o)).map((e,t)=>U(i,o,e,l,s.isExtensionMethod&&0===t&&!s.isExpression))}let e=s.namespace,r=s.f;if(s.attrs.blockAliasFor){const w=i.blocksInfo.apis.byQName[s.attrs.blockAliasFor];w&&(r=w.name,e=w.namespace)}var n=!o.getInputsInline();if(s.isIdentity)return t[0];if(s.property)return w.H.mkPropertyAccess(r,t[0]);if("@get@"==r)return w.H.mkPropertyAccess(t[1].op.replace(/.*\./,""),t[0]);if("@set@"==r)return w.H.mkAssign(w.H.mkPropertyAccess(t[1].op.replace(/.*\./,"").replace(/@set/,""),t[0]),t[2]);if("@change@"==r)return w.H.mkSimpleCall("+=",[w.H.mkPropertyAccess(t[1].op.replace(/.*\./,"").replace(/@set/,""),t[0]),t[2]]);if(s.isExtensionMethod){if(s.attrs.defaultInstance){let e;(e=T(o)&&o.mutation.getMutationType()===w.MutatorTypes.DefaultInstanceMutator?o.mutation.compileMutation(i,l):e)?t.unshift(e):t.unshift(w.mkText(s.attrs.defaultInstance))}return w.H.extensionCall(r,t,n)}return e?w.H.namespaceCall(e,r,t,n):w.H.stdCall(r,t,n)}function T(e){return e.mutation}function oe(e,t,i,o,s,l,r,n){n=void 0===n?[]:n;let a="\n",c=(s=s||5,o=(o||5)*i,t.getFieldValue("LEDS"));c=c.replace(/[ `\n]+/g,"");for(let t=0;t<s;++t){for(let e=0;e<o;++e)0<e&&(a+=" "),a+="#"===c[t*o+e]?"#":".";a+="\n"}i=w.H.mkStringLiteral(a);return i.canIndentInside=!0,w.H.namespaceCall(l,r,[i].concat(n),!1)}function C(e,t){let i;var o,s,l,r,n,a,c,u,p,d,h,m,g,f,k,b,y,_,T,x,v=[];switch(e.stats[t.type]=(e.stats[t.type]||0)+1,le(t,v),t.type){case"controls_if":i=function(s,l,r){var e,n=[];for(let o=0;o<=l.elseifCount_;++o){let e=F(s,O(l,"IF"+o),r),t=V(s,O(l,"DO"+o)),i=w.mkText("if (");0<o&&((i=w.mkText("else if (")).glueToBlock=w.GlueMode.WithSpace),S(n,[i,e,w.mkText(")"),t])}return l.elseCount_&&((e=w.mkText("else")).glueToBlock=w.GlueMode.WithSpace,S(n,[e,V(s,O(l,"ELSE"))])),n}(e,t,v);break;case"pxt_controls_for":case"controls_for":case"controls_simple_for":i=(g=e,k=v,b=O(f=t,"TO"),y=O(f,"DO"),_=O(f,"BY"),T=O(f,"FROM"),x=!_||_.type.match(/^math_number/)&&1==J(_),f=M(g,f,L(f).getField("VAR").getText()),[w.mkText("for (let "+f.escapedName+" = "),T?F(g,T,k):w.mkText("0"),w.mkText("; "),w.mkInfix(w.mkText(f.escapedName),"<=",F(g,b,k)),w.mkText("; "),x?w.mkText(f.escapedName+"++"):w.mkInfix(w.mkText(f.escapedName),"+=",F(g,_,k)),w.mkText(")"),V(g,y)]);break;case"pxt_controls_for_of":case"controls_for_of":i=(T=e,b=v,f=O(x=t,"LIST"),_=O(x,"DO"),x=M(T,x,L(x).getField("VAR").getText()),[w.mkText("for (let "+x.escapedName+" of "),F(T,f,b),w.mkText(")"),V(T,_)]);break;case"variables_set":i=[function(t,e,i){let o=O(e,"VALUE"),s=M(t,e,e.getField("VAR").getText()),l=t.idToScope[e.id].declaredVars[s.name]===s&&!s.firstReference&&!s.alreadyDeclared,r=(l&&X(e,e=>{"variables_get"===e.type&&M(t,e,e.getField("VAR").getText())===s&&(l=!1)},!0),F(t,o,i)),n=s.escapedName+" = ";if(s.isAssigned=!0,l){s.alreadyDeclared=I.Assigned;const w=R(s.type);if(n=`let ${s.escapedName} = `,w){const e=R(D(t,o));w.type!==e.type&&(n=`let ${s.escapedName}: ${w.type} = `)}}else s.firstReference||(s.firstReference=e);return w.mkStmt(w.mkText(n),r)}(e,t,v)];break;case"variables_change":i=[(k=e,g=v,m=O(y=t,"VALUE"),y=M(k,y,y.getField("VAR").getText()),k=F(k,m,g),m=w.mkText(y.escapedName),w.mkStmt(w.mkInfix(m,"+=",k)))];break;case"controls_repeat_ext":i=function(t,i,e){let o=F(t,O(i,"TIMES"),e),s=V(t,O(i,"DO")),l="index";for(let e=2;M(t,i,l);e++)l="index"+e;return[w.mkText("for (let "+l+" = 0; "),w.mkInfix(w.mkText(l),"<",o),w.mkText("; "+l+"++)"),s]}(e,t,v);break;case"device_while":i=function(e,t,i){i=F(e,O(t,"COND"),i),e=V(e,O(t,"DO"));return[w.mkText("while ("),i,w.mkText(")"),e]}(e,t,v);break;case"procedures_defnoreturn":i=(m=e,h=P((d=t).getFieldValue("NAME"),m,!0),d=O(d,"STACK"),[w.mkText("function "+h+"() "),V(m,d)]);break;case"function_definition":i=(c=e,d=P((h=t).getField("function_name").getText(),c,!0),u=O(h,"STACK"),p=h.getArguments().map(e=>"Array"==e.type?P(e.name,c)+": any[]":P(e.name,c)+": "+e.type),h=de(h,!1),[w.mkText(`function ${d} (${p.join(", ")})`+(h?": any":"")),V(c,u)]);break;case"procedures_callnoreturn":i=[(p=e,u=P((u=t).getFieldValue("NAME"),p,!0),w.mkStmt(w.mkText(u+"()")))];break;case"function_call":i=[Z(e,t,v,!0)];break;case pxtc.TS_RETURN_STATEMENT_TYPE:i=[(r=e,a=v,(n=O(n=t,"RETURN_VALUE"))&&"placeholder"!=n.type?w.mkStmt(w.mkText("return "),F(r,n,a)):w.mkStmt(w.mkText("return")))];break;case ts.pxtc.ON_START_TYPE:i=(r=V(e,O(t,"HANDLER")),N.appTarget.compile&&N.appTarget.compile.onStartText&&r&&r.children&&r.children.unshift(w.mkStmt(w.mkText(`// ${pxtc.ON_START_COMMENT}
`))),r.children);break;case pxtc.TS_STATEMENT_TYPE:i=t.getLines().map(e=>w.mkText(e+"\n"));break;case pxtc.PAUSE_UNTIL_TYPE:i=(n=e,a=t,o=v,s=N.appTarget.runtime&&N.appTarget.runtime.pauseUntilBlock,N.Util.assert(!!s,"target has block enabled"),l=s.namespace,s=s.callName||"pauseUntil",n=U(n,a,{definitionName:"PREDICATE",actualName:"PREDICATE"},o),a=[w.mkGroup([w.mkText("() => "),n])],l?[w.mkStmt(w.H.namespaceCall(l,s,a,!1))]:[w.mkStmt(w.H.mkCall(s,a,!1,!1))]);break;case pxtc.TS_DEBUGGER_TYPE:i="1"==t.getFieldValue("ON_OFF")?[w.mkText("debugger;\n")]:[];break;case pxtc.TS_BREAK_TYPE:i=[w.mkText("break;\n")];break;case pxtc.TS_CONTINUE_TYPE:i=[w.mkText("continue;\n")];break;default:i=e.stdCallTable[t.type]?[te(e,t,v)]:[w.mkStmt(F(e,t,v))]}var E=i[i.length-1];if(E&&!E.id&&(E.id=t.id),v.length){var B=v,C=i,A=[];for(const C of B)for(const B of C.split("\n"))A.push(w.mkText("// "+B)),A.push(w.mkNewLine());for(const B of A.reverse())C.unshift(B)}return i.forEach(e=>{!(e.type===w.NT.Block||e.type===w.NT.Prefix&&N.Util.startsWith(e.op,"//"))||t.type==pxtc.ON_START_TYPE&&e.id||(e.id=t.id)}),i}function V(t,e){let i=[],o=e;for(;e;)e.isEnabled()&&S(i,C(t,e)),e=e.getNextBlock();return o&&t.blockDeclarations[o.id]&&t.blockDeclarations[o.id].filter(e=>!e.alreadyDeclared).forEach(e=>{i.unshift(re(e,t.blocksInfo)),e.alreadyDeclared=I.Implicit}),w.mkBlock(i)}function A(e){var t=w.mkStmt(w.mkText(";"));return t.glueToBlock=w.GlueMode.NoSpace,w.mkGroup([t,e])}function o(e,t,i={}){let o={workspace:e,options:i,stdCallTable:{},userFunctionReturnValues:{},diagnostics:[],errors:[],renames:{oldToNew:{},takenNames:{},oldToNewFunctions:{}},stats:{},enums:[],kinds:[],idToScope:{},blockDeclarations:{},allVariables:[],blocksInfo:null};return(o.blocksInfo=t)&&(Object.keys(t.apis.byQName).forEach(e=>{e=t.apis.byQName[e];!e.pkg||6!==e.kind&&3!==e.kind&&5!==e.kind&&4!==e.kind||(o.renames.takenNames[e.qName]=!0)}),t.enumsByName&&Object.keys(t.enumsByName).forEach(e=>o.enums.push(t.enumsByName[e])),t.kindsByName&&Object.keys(t.kindsByName).forEach(e=>o.kinds.push(t.kindsByName[e])),t.blocks.forEach(e=>{var t,i;o.stdCallTable[e.attributes.blockId]?N.reportError("blocks","function already defined",{details:e.attributes.blockId,qualifiedName:e.qName,packageName:e.pkg}):(o.renames.takenNames[e.namespace]=!0,i=!!(t=N.blocks.compileInfo(e)).thisParameter,o.stdCallTable[e.attributes.blockId]={namespace:e.namespace,f:e.name,comp:t,attrs:e.attributes,isExtensionMethod:i,isExpression:e.retType&&"void"!==e.retType,imageLiteral:e.attributes.imageLiteral,imageLiteralColumns:e.attributes.imageLiteralColumns,imageLiteralRows:e.attributes.imageLiteralRows,hasHandler:N.blocks.hasHandler(e),property:!e.parameters,isIdentity:"TD_ID"==e.attributes.shim})}),e.getTopBlocks(!1).filter(pe).forEach(e=>{P("procedures_defnoreturn"===e.type?e.getFieldValue("NAME"):e.getField("function_name").getText(),o,!0)})),o}function se(e,t){var i;return e.type===ts.pxtc.ON_START_TYPE?0:(i=t.stdCallTable[e.type],t=H(0,e),e=1+ts.pxtc.Util.codalHash16(t),i&&i.attrs.afterOnStart?e:-e)}function r(o,i,s){try{let e=i.getAllBlocks(),t=(N.react.getTilemapProject&&N.react.getTilemapProject().removeInactiveBlockAssets(e.map(e=>e.id)),i.getTopBlocks(!0));t=t.sort((e,t)=>se(e,o)-se(t,o));{var l=o;var r=e;var n=t;r.forEach(e=>e.setEnabled(!0));const k={};function a(e,t){k[e]?G(t,!1):(G(t,!0),k[e]=t)}n.forEach(t=>{var e=l.stdCallTable[t.type];if(t.type==ts.pxtc.ON_START_TYPE)a(ts.pxtc.ON_START_TYPE,t);else if(!(pe(t)||e&&e.attrs.blockAllowMultiple&&!e.attrs.handlerStatement))if(e&&e.hasHandler&&!e.attrs.handlerStatement)a(e.attrs.blockHandlerKey||H(0,t),t);else{let e=t;for(;e;)G(t,!1),e=e.getNextBlock()}})}e=e.filter(e=>e.isEnabled()),t=t.filter(e=>e.isEnabled());{var c=t;var u=o;let i,s=1;function p(e,t,o){if(o.idToScope[e.id]=t,"variables_get"===e.type){const o=d(e.getField("VAR").getText(),t);t.referencedVars.push(o.id)}else if("variables_set"===e.type||"variables_change"===e.type){const o=d(e.getField("VAR").getText(),t);t.assignedVars.push(o.id),t.referencedVars.push(o.id)}else if(e.type===pxtc.TS_STATEMENT_TYPE){const o=e.declaredVariables;o&&o.split(",").forEach(e=>{d(e,t).alreadyDeclared=I.Argument})}if(e.inputList.some(e=>e.type===Blockly.NEXT_STATEMENT)){const d=function(e,t){switch(e.type){case"pxt_controls_for":case"controls_simple_for":return[[L(e).getField("VAR").getText(),$]];case"pxt_controls_for_of":case"controls_for_of":return[[L(e).getField("VAR").getText(),b(null)]]}if(T(e)){const t=e.mutation.getDeclaredVariables();if(t)return Object.keys(t).map(e=>[e,b(t[e])])}t=t.stdCallTable[e.type];return t&&t.comp.handlerArgs.length?ne(e,t):[]}(e,o).map(e=>({name:e[0],type:e[1],id:s++}));let i=t;d.length&&(i={parent:t,firstStatement:e,declaredVars:{},referencedVars:[],assignedVars:[],children:[]},d.forEach(e=>{e.alreadyDeclared=I.Assigned,i.declaredVars[e.name]=e}),o.idToScope[e.id]=i),t!==i&&t.children.push(i),X(e,e=>{p(e,i,o)}),e.inputList.filter(e=>e.type===Blockly.NEXT_STATEMENT).forEach(e=>{var t;e.connection&&e.connection.targetBlock()&&(e=e.connection.targetBlock(),t={parent:i,firstStatement:e,declaredVars:{},referencedVars:[],assignedVars:[],children:[]},i.children.push(t),p(e,t,o))})}else X(e,e=>{p(e,t,o)});e.nextConnection&&e.nextConnection.targetBlock()&&p(e.nextConnection.targetBlock(),t,o)}function d(e,t){return t.declaredVars[e]||(t.parent?d(e,t.parent):(t.declaredVars[e]={name:e,type:b(null),id:s++},t.declaredVars[e]))}c.forEach(e=>{e.type===ts.pxtc.ON_START_TYPE&&(e=e.getInputTargetBlock("HANDLER"))&&p(e,i={firstStatement:e,declaredVars:{},referencedVars:[],children:[],assignedVars:[]},u)}),i=i||{firstStatement:null,declaredVars:{},referencedVars:[],children:[],assignedVars:[]},c.forEach(e=>{e.type!==ts.pxtc.ON_START_TYPE&&p(e,i,u)}),Object.keys(i.declaredVars).forEach(e=>{var t=i.declaredVars[e];delete i.declaredVars[e],(function e(t,i){let o;if(-1!==t.referencedVars.indexOf(i))return t;for(const s of t.children)if(ae(s,i)){if(ce(s,i))return t;if(o)return t;o=s}return o?e(o,i):void 0}(i,t.id)||i).declaredVars[e]=t}),function t(i,o){const e=Object.keys(i.declaredVars);if(e.length){const s=e.map(e=>i.declaredVars[e]);i.firstStatement&&(o.blockDeclarations[i.firstStatement.id]=s.concat(o.blockDeclarations[i.firstStatement.id]||[])),s.forEach(e=>o.allVariables.push(e))}i.children.forEach(e=>t(e,o))}(i,u),function t(o,s){for(const s of Object.keys(o.declaredVars)){const l=o.declaredVars[s];l.escapedName||(l.escapedName=e(s))}function e(t){if(!t)return"_";let i=ts.pxtc.escapeIdentifier(t);if(s.renames.takenNames[i]||l(i,o,t)){let e=2;for(;s.renames.takenNames[i+e]||l(i+e,o,t);)e++;i+=e}return i}function l(e,t,i){if(t){for(const l of Object.keys(t.declaredVars)){const o=t.declaredVars[l];if((i!==o.name||o.name!==o.escapedName)&&o.escapedName===e)return!0}return l(e,t.parent,i)}return!1}o.children.forEach(e=>t(e,s))}(i,u),i}Q(e,o);const m=[],g=function(t,i){if(!t.length||t.some(e=>!e.rendered))return{orphans:i,idToComments:{}};var o=t.map(e=>{var t=e.getBoundingRectangle(),i=e.getHeightWidth();return{id:e.id,x:t.left,y:t.top,width:i.width,height:i.height}}),s={orphans:[],idToComments:{}};for(const t of i){const i=t.getBoundingRectangle(),l=t.getHeightWidth(),r=i.left,n=i.top;let e;for(const t of o)(ue(r,n,l.width,l.height,t)||!e&&ue(r-20,n-20,l.width+40,l.height+40,t))&&(e=t);(e?(s.idToComments[e.id]||(s.idToComments[e.id]=[]),s.idToComments[e.id]):s.orphans).push(t)}return s}(t,i.getTopComments(!0)),f=(g.orphans.forEach(e=>S(m,ee(e).children)),t.forEach(e=>{g.idToComments[e.id]&&g.idToComments[e.id].forEach(e=>{S(m,ee(e).children)}),e.type==ts.pxtc.ON_START_TYPE?S(m,C(o,e)):(e=w.mkBlock(C(o,e))).type==w.NT.Block?S(m,e.children):m.push(e)}),[]);o.enums.forEach(l=>{var e=i.getVariablesOfType(l.name);if(e&&e.length){const i=e.map(e=>{var t=/^(\d+)([^0-9].*)$/.exec(e.name);return t?[t[2],parseInt(t[1])]:[e.name,-1]}),r=(i.sort((e,t)=>e[1]-t[1]),[]);let s=-1;i.forEach(([e,t],i)=>{let o;if(l.isBitMask){const l=Math.log2(t);0<=l&&Math.floor(l)===l&&(o=w.H.mkAssign(w.mkText(e),w.H.mkSimpleCall("<<",[w.H.mkNumberLiteral(1),w.H.mkNumberLiteral(l)])))}else if(l.isHash){const l=ts.pxtc.Util.codalHash16(e.toLowerCase());o=w.H.mkAssign(w.mkText(e),w.H.mkNumberLiteral(l))}o=o||(t===s+1?w.mkText(e):w.H.mkAssign(w.mkText(e),w.H.mkNumberLiteral(t))),r.push(o),s=t});e=w.mkCommaSep(r,!0);e.glueToBlock=w.GlueMode.NoSpace,f.push(w.mkGroup([w.mkText("enum "+l.name),w.mkBlock([e])]))}}),o.kinds.forEach(t=>{var e=i.getVariablesOfType("KIND_"+t.name);if(e&&e.length){const i=e.map(e=>e.name).filter(e=>-1===t.initialMembers.indexOf(e));i.length&&f.push(w.mkGroup([w.mkText("namespace "+t.name),w.mkBlock(i.map(e=>w.mkStmt(w.mkText(`export const ${e} = ${t.name}.${t.createFunctionName}()`))))]))}});var h=o.allVariables.filter(e=>!e.alreadyDeclared).map(e=>re(e,s));return o.allVariables.filter(e=>e.alreadyDeclared===I.Implicit&&!e.isAssigned).forEach(e=>{var t=R(e.type);"string"===t.type||"number"===t.type||"boolean"===t.type||y(t.type)||o.diagnostics.push({blockId:e.firstReference&&e.firstReference.id,message:lf("Variable '{0}' is never assigned",e.name)})}),[f.concat(h.concat(m)),o.diagnostics]}catch(e){var t=e.block;if(!t)throw e;t.setWarningText(e+""),o.errors.push(t)}finally{q()}return[null,null]}function H(e,t){return t.type==ts.pxtc.ON_START_TYPE?JSON.stringify({name:ts.pxtc.ON_START_TYPE}):t.type==ts.pxtc.FUNCTION_DEFINITION_TYPE?JSON.stringify({type:"function",name:t.getFieldValue("function_name")}):JSON.stringify(function e(t){const i=[],o=[];for(const s of t.inputList){for(const t of s.fieldRow)t.name&&i.push(t.getText());s.type===Blockly.INPUT_VALUE&&(s.connection.targetBlock()?o.push(e(s.connection.targetBlock())):o.push(null))}return{type:t.type,fields:i,inputs:o}}(t)).replace(/"id"\s*:\s*"[^"]+"/g,"")}function G(e,t){e.setEnabled(t);var i=e.getDescendants(!1);for(const e of i)e.setEnabled(t)}function n(e,t,i){let o=w.flattenNode(t);return s("format",{format:{input:o.output,pos:1}}).then(()=>({source:o.output,sourceMap:o.sourceMap,stats:e.stats,diagnostics:i||[]}))}function le(e,t){e.comment&&("string"==typeof e.comment?t.push(e.comment):t.push(e.comment.getText()))}function re(e,t){var i=R(e.type);let o,s="";if("null"==(o="Array"===i.type?w.mkText("[]"):B(i)).op||"[]"==o.op){let e=i.type;"Array"!==e&&"null[]"!==e||(e="number[]");i=t.apis.byQName[e];i&&i.attributes.autoCreate?o=w.mkText(i.attributes.autoCreate+"()"):s=": "+e}return w.mkStmt(w.mkText("let "+e.escapedName+s+" = "),o)}function W(e){if(e.mutationToDom){var t=e.mutationToDom();if(t.hasAttribute("_expanded")){const e=parseInt(t.getAttribute("_expanded"));return isNaN(e)?0:Math.max(e,0)}}return 0}function j({comp:e},t){const i=[];return e.thisParameter&&i.push(e.thisParameter),e.parameters.forEach(e=>{e.isOptional&&0<t?(i.push(e),--t):e.isOptional||i.push(e)}),i}function ne(t,i){var o=[];if(i.attrs.draggableParameters)for(let e=0;e<i.comp.handlerArgs.length;e++){var s=i.comp.handlerArgs[e],l=O(t,"HANDLER_DRAG_PARAM_"+s.name),l="reporter"===i.attrs.draggableParameters?l&&l.getFieldValue("VALUE"):l&&l.getField("VAR").getText();if(null===l)break;o.push([l,b(s.type)])}else for(let e=0;e<i.comp.handlerArgs.length;e++){var r=i.comp.handlerArgs[e],n=t.getField("HANDLER_"+r.name),n=n&&n.getText();if(null===n)break;o.push([n,b(r.type)])}return o}function ae(e,t){if(-1!==e.referencedVars.indexOf(t))return!0;for(const i of e.children)if(ae(i,t))return!0;return!1}function ce(e,t){if(-1!==e.assignedVars.indexOf(t))return!0;for(const i of e.children)if(ce(i,t))return!0;return!1}function X(e,t,i=!1){e.inputList.filter(e=>e.type===Blockly.INPUT_VALUE).forEach(e=>{e.connection&&e.connection.targetBlock()&&(t(e.connection.targetBlock()),i)&&X(e.connection.targetBlock(),t,i)})}function ue(e,t,i,o,s){e=l(e,s.x,s.x+s.width)||l(s.x,e,e+i),i=l(t,s.y,s.y+s.height)||l(s.y,t,t+o);return e&&i;function l(e,t,i){return t<=e&&e<=i}}function pe(e){return"procedures_defnoreturn"===e.type||"function_definition"===e.type}function a(e){return e.getField("function_name").getText()}function de(e,i){const o=a(e),s={};return function e(t){t=i?t.getDescendants(!1).filter(e=>"function_return"==e.type).map(e=>O(e,"RETURN_VALUE")).filter(e=>e&&"function_call_output"===e.type):t.getDescendants(!1).filter(e=>"function_call_output"==e.type);for(const i of t){const t=a(i);if(t===o)return!0;if(!s[t]&&(s[t]=!0,e(Blockly.Functions.getDefinition(t,i.workspace))))return!0}return!1}(e)}w.compileExpression=F,w.escapeVarName=P,w.mkEnv=o,w.compileBlockAsync=function(e,t){var i=e.workspace,t=o(i,t),i=(Q(i&&i.getAllBlocks(),t),C(t,e));return q(),n(t,i)},w.callKey=H,w.findBlockIdByPosition=function(o,s){if(s){let t,i;for(let e=0;e<o.length;++e){var l=o[e];l.startPos<=s.start&&l.endPos>=s.start+s.length&&(!t||i>l.endPos-l.startPos)&&(t=l,i=l.endPos-l.startPos)}return t?t.id:void 0}},w.findBlockIdByLine=function(o,s){if(s){let t,i;for(let e=0;e<o.length;++e){var l=o[e];l.startLine<=s.start&&l.endLine>s.start+s.length&&(!t||i>l.endLine-l.startLine)&&(t=l,i=l.endLine-l.startLine)}return t?t.id:void 0}},w.compileAsync=function(e,t,i={}){var i=o(e,t,i),[e,t]=r(i,e,t);return n(i,e,t)}}}(pxt=pxt||{}),function(s){{var e=s.blocks||(s.blocks={});let o={};function t(e,t,i){null==o[e]&&(o[e]={field:t,validator:i})}e.initFieldEditors=function(){t("text",pxtblockly.FieldTextInput),t("note",pxtblockly.FieldNote),t("gridpicker",pxtblockly.FieldGridPicker),t("textdropdown",pxtblockly.FieldTextDropdown),t("numberdropdown",pxtblockly.FieldNumberDropdown),t("imagedropdown",pxtblockly.FieldImageDropdown),t("colorwheel",pxtblockly.FieldColorWheel),t("toggle",pxtblockly.FieldToggle),t("toggleonoff",pxtblockly.FieldToggleOnOff),t("toggleyesno",pxtblockly.FieldToggleYesNo),t("toggleupdown",pxtblockly.FieldToggleUpDown),t("toggledownup",pxtblockly.FieldToggleDownUp),t("togglehighlow",pxtblockly.FieldToggleHighLow),t("togglewinlose",pxtblockly.FieldToggleWinLose),t("colornumber",pxtblockly.FieldColorNumber),t("images",pxtblockly.FieldImages),t("sprite",pxtblockly.FieldSpriteEditor),t("animation",pxtblockly.FieldAnimationEditor),t("tilemap",pxtblockly.FieldTilemap),t("tileset",pxtblockly.FieldTileset),t("speed",pxtblockly.FieldSpeed),t("turnratio",pxtblockly.FieldTurnRatio),t("protractor",pxtblockly.FieldProtractor),t("position",pxtblockly.FieldPosition),t("melody",pxtblockly.FieldCustomMelody)},e.registerFieldEditor=t,e.createFieldEditor=function(e,t,i){if(null==o[e])return console.error(`Field editor ${e} not registered`),null;s.Util.assert(null==(i=i||{}).lightMode,"lightMode is a reserved parameter for custom fields"),i.lightMode=s.options.light;e=o[e];return new e.field(t,i,e.validator)}}}(pxt=pxt||{}),function(B){{var C=B.blocks||(B.blocks={});C.needsDecompiledDiff=function(e,t){if(!e||!t)return!1;const i={};if(e.replace(/id="([^"]+)"/g,(e,t)=>(i[t]=!0,"")),!Object.keys(i).length)return!1;let o=0,s=0;return t.replace(/id="([^"]+)"/g,(e,t)=>(o++,i[t]&&s++,"")),0<o&&0==s},C.diffXml=function(e,t,i){return s(B.blocks.loadWorkspaceXml(e,!0),B.blocks.loadWorkspaceXml(t,!0),i)};const N="#d0d0d0";function s(e,i,o){try{Blockly.Events.disable();{var s=e;var l=i;var r=o;B.tickEvent("blocks.diff",{started:1}),r=r||{};const f=A();if(!s)return{ws:void 0,message:lf("All blocks are new."),added:0,deleted:0,modified:1};if(!l)return{ws:void 0,message:lf("The current blocks seem corrupted."),added:0,deleted:0,modified:1};const k=B.Util.toDictionary(s.getTopBlocks(!1),e=>I(e,!0));l.getTopBlocks(!1).forEach(e=>{var t=I(e,!0),i=s.getBlockById(e.id)||k[t];i&&t==I(i,!0)&&(f("fast unmodified top ",e.id),e.dispose(!1),i.dispose(!1))});var n=s.getAllBlocks().filter(e=>e.isEnabled()),a=s.getTopBlocks(!1).filter(e=>e.isEnabled()),c=l.getAllBlocks().filter(e=>e.isEnabled());if(f("blocks",c.map(e=>e.toDevString())),f(c),0==n.length&&0==c.length)return B.tickEvent("blocks.diff",{moves:1}),{ws:void 0,message:lf("Some blocks were moved or changed."),added:0,deleted:0,modified:1};const b=a.filter(e=>!l.getBlockById(e.id)),y=n.filter(e=>!l.getBlockById(e.id)),_=c.filter(e=>!s.getBlockById(e.id)),T=B.blocks.initRenderingWorkspace(),x=B.blocks.saveWorkspaceXml(l,!0),v=(B.blocks.domToWorkspaceNoEvents(Blockly.Xml.textToDom(x),T),T.getAllBlocks().filter(e=>!e.isEnabled()).forEach(e=>{f("disabled ",e.toDevString()),e.dispose(!1)}),B.Util.toDictionary(T.getAllBlocks(),e=>e.id)),E=(f("todo blocks",v),g("start"),r.hideDeletedTopBlocks||(b.forEach(e=>{f("deleted top "+e.toDevString()),m(e);e=d(e);m(e),e.setDisabled(!0)}),g("deleted top")),_.map(e=>T.getBlockById(e.id)).filter(e=>!!e).forEach(e=>{f("added "+e.toDevString()),m(e)}),g("added"),{});if(!r.hideDeletedBlocks){const B=y.filter(e=>!(v[e.id]||p(e)||e.outputConnection&&e.outputConnection.isConnected()));B.forEach(e=>{var t=d(e);E[e.id]=t.id,f(`deleted block ${e.toDevString()}->`+t.toDevString())}),B.forEach(e=>{{var t=e;f(`stitching ${t.toDevString()}->`+E[t.id]);const i=T.getBlockById(E[t.id]),o=(i.setDisabled(!0),u(i),m(i),t.getPreviousBlock());if(o){const s=T.getBlockById(E[o.id])||T.getBlockById(o.id);if(f(`previous ${t.id}->${i.toDevString()}: `+s.toDevString()),s)if(s.nextConnection)i.previousConnection.connect(s.nextConnection);else{const t=s.inputList.slice().reverse().find(e=>e.connection&&e.connection.type==Blockly.NEXT_STATEMENT);t&&i.previousConnection.connect(t.connection)}}const s=t.getNextBlock();if(s){const o=T.getBlockById(E[s.id])||T.getBlockById(s.id);o&&(f(`next ${t.id}->${i.toDevString()}: `+o.toDevString()),i.nextConnection.connect(o.previousConnection))}}})}let t=0;if(B.Util.values(v).filter(e=>{var t,i,o=s.getBlockById(e.id);return!!o&&!((t=e.getPreviousBlock())&&!v[t.id]||(e=e.getNextBlock())&&!v[e.id]||!(i=o.getPreviousBlock())&&!t||!!i==!!t&&i.id==t.id&&(!(i=o.getNextBlock())&&!e||!!i==!!e&&i.id==e.id))}).forEach(e=>{f("moved "+e.toDevString()),delete v[e.id],u(e),t++}),g("moved"),B.Util.values(v).filter(e=>{var t,i,o=s.getBlockById(e.id);return!!o&&(t=I(o),i=I(e),t!=i)&&(f("old "+o.toDevString(),t),f("new "+e.toDevString(),i),!0)}).forEach(e=>{f("changed "+e.toDevString()),delete v[e.id],u(e),t++}),g("changed"),T.getTopBlocks(!1).forEach(e=>{e.getDescendants(!1).find(e=>p(e))||(f("unmodified top "+e.toDevString()),delete v[e.id],e.dispose(!1))}),g("cleaned"),B.Util.values(v).filter(e=>!!T.getBlockById(e.id)).forEach(e=>{!function t(e){e.setColour(N),h(e),r.statementsOnly&&(e.inputList||[]).map(e=>e.type==Blockly.INPUT_VALUE&&e.connection&&e.connection.targetBlock()).filter(e=>!!e).forEach(e=>t(e))}(e)}),g("unmodified"),!T.getAllBlocks().length)return B.tickEvent("blocks.diff",{missed:1}),{ws:T,message:lf("Some blocks were changed."),deleted:y.length,added:_.length,modified:t};T.resize(),Blockly.svgResize(T);a=B.blocks.renderWorkspace(r.renderOptions||{emPixels:20,layout:C.BlockLayout.Flow,aspectRatio:.5,useViewWidth:!0}),n={ws:T,svg:a,deleted:y.length,added:_.length,modified:t};return B.tickEvent("blocks.diff",{deleted:n.deleted,added:n.added,modified:n.modified}),n;function u(e){e.__pxt_used=!0}function p(e){return!!e.__pxt_used}function d(e){e=Blockly.Xml.blockToDom(e,!1),e=Blockly.Xml.domToBlock(e,T);return e.nextConnection&&e.nextConnection.targetConnection&&e.nextConnection.disconnect(),e.previousConnection&&e.previousConnection.targetConnection&&e.previousConnection.disconnect(),e}function h(t){t.rendered=!1,t.inputList.forEach(e=>e.fieldRow.forEach(e=>{e.init(),e.borderRect_&&(e.borderRect_.setAttribute("fill",t.getColour()),e.borderRect_.setAttribute("stroke",t.getColourTertiary()))}))}function m(e){e.getDescendants(!1).forEach(e=>{delete v[e.id],u(e)})}function g(e){f(e+":",B.Util.values(v).map(e=>e.toDevString()))}return}}catch(e){return B.reportException(e),{ws:void 0,message:lf("Oops, we could not diff those blocks."),error:e,deleted:0,added:0,modified:0}}finally{Blockly.Events.enable()}}function A(){return B.options.debug||window&&/diffdbg=1/.test(window.location.href)?console.log:e=>{}}function I(e,t){e=Blockly.Xml.blockToDom(e,!0);return i(e),function e(t,i){if(t){i(t);for(const o of B.Util.toArray(t.children))e(o,i)}}(e,e=>{i(e),t||"next"!=e.localName&&"statement"!=e.localName&&"shadow"!=e.localName||e.remove()}),Blockly.Xml.domToText(e)}function i(e){e.removeAttribute("id"),e.removeAttribute("x"),e.removeAttribute("y"),e.removeAttribute("deletable"),e.removeAttribute("editable"),e.removeAttribute("movable")}C.mergeXml=function(e,t,i){return e==t?i:i==t?e:void 0},C.decompiledDiffAsync=function(e,l,t,r,i={}){const n=A(),o=l.outfiles[B.MAIN_BLOCKS];let a=r.outfiles[B.MAIN_BLOCKS];n(o),n(a);e=B.diff.compute(e,t,{ignoreWhitespace:!0,full:!0});n(e);const c={};let u=0,p=0;e.forEach((e,t)=>{e[0];const i=e.substr(2);let o=i.length;switch(s){case"-":u+=o+1;break;case"+":p+=o+1;break;default:const t=/^\s+/.exec(i);if(t){const B=t[0].length;u+=B,p+=B,o-=B}const s=B.blocks.findBlockIdByPosition(r.blockSourceMap,{start:p,length:o});if(s&&!c[s]){const t=B.blocks.findBlockIdByPosition(l.blockSourceMap,{start:u,length:o});t&&(n(e),n(`id ${u}:${i.length}>${t} ==> ${p}:${i.length}>`+s),c[s]=t,a=a.replace(s,t))}u+=o+1,p+=o+1}});t=B.blocks.loadWorkspaceXml(o,!0),e=B.blocks.loadWorkspaceXml(a,!0);return i.statementsOnly=!0,s(t,e,i)}}}(pxt=pxt||{}),function(a){function c(t,i){var o=[];for(let e=0;e<t.childNodes.length;e++){var s=t.childNodes.item(e);s.tagName===i&&o.push(s)}return o}function u(e,t){return p(e,"block","type",t).concat(p(e,"shadow","type",t))}function p(e,t,i,o){return a.Util.toArray(e.getElementsByTagName(t)).filter(e=>e.getAttribute(i)===o)}function d(e,t,i,o){e=p(e,t,i,o);return e.length?e[0]:void 0}var h;(h=a.blocks||(a.blocks={})).domToWorkspaceNoEvents=function(e,t){a.tickEvent("blocks.domtow");let i=[];try{Blockly.Events.disable(),i=Blockly.Xml.domToWorkspace(e,t),(o=t).getAllBlocks().filter(e=>!!e.comment&&e.comment instanceof Blockly.Comment).forEach(e=>{var t=e.comment.getText();/@highlight/.test(t)&&(t=t.replace(/@highlight/g,"").trim(),e.setCommentText(t||null),o.highlightBlock(e.id))})}catch(e){a.reportException(e)}finally{Blockly.Events.enable()}var o;return i},h.clearWithoutEvents=function(e){if(a.tickEvent("blocks.clear"),e)try{Blockly.Events.disable(),e.clear(),e.clearUndo()}finally{Blockly.Events.enable()}},h.saveWorkspaceXml=function(e,t){e=Blockly.Xml.workspaceToDom(e,!t);return Blockly.Xml.domToText(e)},h.saveBlocksXml=function(e,t){return e.getTopBlocks(!1).map(e=>Blockly.Xml.domToText(Blockly.Xml.blockToDom(e,!t)))},h.getDirectChildren=c,h.getBlocksWithType=u,h.getChildrenWithAttr=p,h.getFirstChildWithAttr=d,h.loadBlocksXml=function(e,t){var i,t=Blockly.Xml.textToDom(t),t=Blockly.Xml.domToBlock(t,e);e.getMetrics&&(e=e.getMetrics(),i=t.getHeightWidth(),t.moveBy(e.viewLeft+e.viewWidth/2-i.width/2,e.viewTop+e.viewHeight/2-i.height/2))},h.loadWorkspaceXml=function(e,t=!1){var i=new Blockly.Workspace;try{const t=Blockly.Xml.textToDom(e);return a.blocks.domToWorkspaceNoEvents(t,i),i}catch(e){return t||a.reportException(e),null}},h.importXml=function(e,t,i,s=!1){try{a.blocks.initializeAndInject(i);const s=(new DOMParser).parseFromString(t,"application/xml"),r=a.patching.computePatches(e);r&&(r.filter(e=>"blockId"==e.type).forEach(i=>Object.keys(i.map).forEach(t=>{u(s,t).forEach(e=>{e.setAttribute("type",i.map[t]),a.debug(`patched block ${t} -> `+i.map[t])})})),r.filter(e=>"blockValue"==e.type).forEach(o=>Object.keys(o.map).forEach(t=>{var e=t.split("."),i=e[0];e[1],u(s,i).reduce((e,t)=>e.concat(c(t,"value")),[]).forEach(e=>{e.setAttribute("name",o.map[t]),a.debug(`patched block value ${t} -> `+o.map[t])})})),r.filter(e=>"userenum"==e.type).forEach(i=>Object.keys(i.map).forEach(t=>{p(s,"variable","type",t).forEach(e=>{e.setAttribute("type",i.map[t]),a.debug(`patched enum variable type ${t} -> `+i.map[t])})})));for(const a of c(s.children.item(0),"shadow")){const h=s.createElement("block");a.getAttributeNames().forEach(e=>h.setAttribute(e,a.getAttribute(e)));for(let e=0;e<a.childNodes.length;e++)h.appendChild(a.childNodes.item(e));a.replaceWith(h)}const n={};Object.keys(i.apis.byQName).forEach(e=>{e=i.apis.byQName[e];7==e.kind&&(n[e.namespace+"."+(e.attributes.blockImportId||e.attributes.block||e.attributes.blockId||e.name)]=e.namespace+"."+e.name)});var o=s.getElementsByTagName("block");for(let e=0;e<o.length;++e)!function(s,l,r){var e=r.getAttribute("type"),t=Blockly.Blocks[e];if((e=h.blockSymbol(e))&&t){let o=h.compileInfo(e);null!=(t=e.parameters)&&t.forEach((e,t)=>{var i=s.apis.byQName[e.type];i&&6==i.kind&&(e=d(r,"field","name",o.actualNameToParam[e.name].definitionName))&&(i=l[i.name+"."+e.textContent])&&(e.textContent=i)})}}(i,n,o[e]);return function(t,e){var i=u(t,ts.pxtc.ON_START_TYPE);let o=i.length?i[0]:void 0;if(o)return o.removeAttribute("deletable");var s=[],l=e.blocksById;let r,n=t.firstElementChild;for(;n;){const u=n.nextElementSibling,e=n.getAttribute("type");if(!n.getAttribute("disabled")&&!n.getElementsByTagName("statement").length&&(a.blocks.buildinBlockStatements[e]||l[e]&&"void"==l[e].retType&&!h.hasArrowFunction(l[e]))){if(r){const a=t.ownerDocument.createElement("next");a.appendChild(n),r.appendChild(a)}else(r=t.ownerDocument.createElement("statement")).setAttribute("name","HANDLER"),o||((o=t.ownerDocument.createElement("block")).setAttribute("type",ts.pxtc.ON_START_TYPE),s.push(o)),o.appendChild(r),r.appendChild(n);n.removeAttribute("x"),n.removeAttribute("y"),r=n}n=u}s.forEach(e=>t.appendChild(e))}(s.documentElement,i),l=s.documentElement,a.U.toArray(l.querySelectorAll("block[type=procedures_defnoreturn]")).forEach(e=>{e.setAttribute("type","function_definition"),e.querySelector("field[name=NAME]").setAttribute("name","function_name")}),a.U.toArray(l.querySelectorAll("block[type=procedures_callnoreturn]")).forEach(e=>{e.setAttribute("type","function_call"),e.querySelector("field[name=NAME]").setAttribute("name","function_name")}),a.blocks.extensionBlocklyPatch&&a.blocks.extensionBlocklyPatch(e,s.documentElement),(new XMLSerializer).serializeToString(s)}catch(e){return s||a.reportException(e),t}var l}}(pxt=pxt||{}),function(k){var h;{var e=(h=k.blocks||(k.blocks={})).layout||(h.layout={});function t(e,t,i){let o;i&&(o={target:k.appTarget.id,versions:k.appTarget.versions,xml:k.blocks.saveBlocksXml(e).map(e=>k.Util.htmlEscape(e))});const s=0|t||4;return l(e,s).then(e=>e?k.BrowserUtils.encodeToPngAsync(e.xml,{width:e.width,height:e.height,pixelDensity:s,text:i?JSON.stringify(o,null,2):null}):Promise.resolve(void 0)).catch(e=>{k.reportException(e)})}e.patchBlocksFromOldWorkspace=function(e,t,i){i=k.blocks.loadWorkspaceXml(i,!0);{var l=e,r=t,n=i;let o,s;r.getTopBlocks(!1).filter(e=>e.isEnabled()).forEach(e=>{var t=e.xy_;t&&0!=t.x&&0!=t.y&&(o||(o=k.blocks.mkEnv(r,l),s={},n.getTopBlocks(!1).forEach(e=>{var t=k.blocks.callKey(o,e),i=s[t]||[];i.push(e),s[t]=i})),e=k.blocks.callKey(o,e),e=(s[e]||[]).shift())&&(e.xy_=t.clone())})}{e=i;const o=Blockly.Xml.workspaceToDom(t,!0),s=Blockly.Xml.workspaceToDom(e,!0);return k.Util.toArray(o.childNodes).filter(e=>e.nodeType==Node.ELEMENT_NODE&&"block"==e.localName&&"true"==e.getAttribute("disabled")).forEach(e=>s.appendChild(s.ownerDocument.importNode(e,!0))),Blockly.Xml.domToText(s)}},e.splitSvg=function(p,e,d=18){var t=e.getTopComments(!0),i=e.getTopBlocks(!0);if(t.length+i.length<2)return p;const h=document.createElement("div");function s(e,t,i,o,s,l){const r=p.cloneNode(!0),n=r.querySelector("g.blocklyWorkspace > g."+e),a=r.querySelector("g.blocklyWorkspace > g."+t),c=k.Util.toArray(n.querySelectorAll(`g.blocklyWorkspace > g.${e} > `+(l?"."+l:"g[transform]"))),u=c.splice(i,1)[0];u?(c.filter(e=>e!=u).forEach(e=>{e.parentNode.removeChild(e)}),n.removeAttribute("transform"),a.parentNode.removeChild(a),u.setAttribute("transform",`translate(${s.x}, ${s.y})`),t=o.width/d+"em",e=o.height/d+"em",r.setAttribute("viewBox",`0 0 ${o.width} `+o.height),r.style.width=t,r.style.height=e,r.setAttribute("width",t),r.setAttribute("height",e),h.appendChild(r)):k.log("missing block, did block failed to load?")}return h.className="blocks-svg-list "+e.getInjectionDiv().className,t.forEach((e,t)=>s("blocklyBubbleCanvas","blocklyBlockCanvas",t,e.getHeightWidth(),{x:0,y:0},"blocklyComment")),i.forEach((e,t)=>{var i=e.getHeightWidth(),o={x:0,y:0};e.getStartHat()&&(i.height+=d,o.y+=d),s("blocklyBlockCanvas","blocklyBubbleCanvas",t,i,o)}),h},e.verticalAlign=function(e,i){let o=0;e.getTopComments(!0).forEach(e=>{e.moveBy(0,o),o=(o+=e.getHeightWidth().height)+i}),e.getTopBlocks(!0).forEach((e,t)=>{e.getStartHat()&&(o+=i),e.moveBy(0,o),o=(o+=e.getHeightWidth().height)+i})},e.setCollapsedAll=function(e,t){e.getTopBlocks(!1).filter(e=>e.isEnabled()).forEach(e=>e.setCollapsed(t))},e.flow=function(e,t){if(t){if(t.useViewWidth){const t=e.getMetrics();if(t.viewHeight>t.viewWidth)return o(e.getTopComments(!0),e.getTopBlocks(!0),void 0,t.viewWidth),void e.scroll(20,20)}o(e.getTopComments(!0),e.getTopBlocks(!0),t.ratio)}else o(e.getTopComments(!0),e.getTopBlocks(!0));e.scroll(20,20)},e.screenshotEnabled=function(){return!k.BrowserUtils.isIE()&&!k.BrowserUtils.isUwpEdge()},e.screenshotAsync=t,e.toPngAsync=t;const _="http://www.w3.org/1999/xlink",a=12e7;function l(e,t){if(!e)return Promise.resolve(void 0);var i=e.getBlocksBoundingBox(),e=e.getParentSvg().cloneNode(!0);r(e);let o=i.right-i.left,s=i.bottom-i.top,l=1;t=o*s*Math.pow(t,2);return t>a&&(l=Math.sqrt(a/t)),n(e,i.left,i.top,o,s,l)}function b(e){return i((new XMLSerializer).serializeToString(e))}function i(e){return e.replace(new RegExp("&nbsp;","g"),"&#160;")}function r(e){k.BrowserUtils.removeClass(e,"blocklySvg"),k.BrowserUtils.addClass(e,"blocklyPreview pxt-renderer"),k.U.toArray(e.querySelectorAll(".blocklyMainBackground,.blocklyScrollbarBackground")).forEach(e=>{e&&e.parentNode.removeChild(e)}),k.U.toArray(e.querySelectorAll(".blocklyConnectionIndicator,.blocklyInputConnectionIndicator")).forEach(e=>{e&&e.parentNode.removeChild(e)}),e.removeAttribute("width"),e.removeAttribute("height"),k.U.toArray(e.querySelectorAll(".blocklyBlockCanvas,.blocklyBubbleCanvas")).forEach(e=>e.removeAttribute("transform"));const i=new DOMParser;return k.U.toArray(e.querySelectorAll(".blocklyCommentTextarea")).forEach(e=>{var t=i.parseFromString("<!doctype html><body>"+k.docs.html2Quote(e.value),"text/html");e.textContent=t.body.textContent}),e}function n(e,t,i,o,s,l){if(!e.childNodes[0])return Promise.resolve(void 0);e.removeAttribute("width"),e.removeAttribute("height"),e.removeAttribute("transform");let r=Math.round(o*(l||1)),n=Math.round(s*(l||1));const a=b(e).replace(/^\s*<svg[^>]+>/i,"").replace(/<\/svg>\s*$/i,""),c=`<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="${_}" width="${r}" height="${n}" viewBox="${t} ${i} ${o} ${s}" class="pxt-renderer">${a}</svg>`,u=(new DOMParser).parseFromString(c,"image/svg+xml"),p=u.createElementNS("http://www.w3.org/1999/xhtml","style"),d=k.Util.isUserLanguageRtl(),h=document.getElementById(`style-${d?"rtl":""}blockly.css`).href,m=k.Util.toArray(document.head.getElementsByTagName("link")).filter(e=>k.Util.endsWith(e.getAttribute("href"),"semantic.css"))[0].href;return Promise.all([k.BrowserUtils.loadAjaxAsync(h),k.BrowserUtils.loadAjaxAsync(m)]).then(e=>{var t,i=k.Util.toArray(document.head.querySelectorAll("style")).filter(e=>/\.blocklySvg/.test(e.innerText))[0];e.unshift((null==(t=document.getElementById("blockly-common-style"))?void 0:t.innerText)||""),e.unshift((null==(t=document.getElementById("blockly-renderer-style-pxt"))?void 0:t.innerText)||"");const o=(i?i.innerText:"")+"\n\n"+e.map(e=>e+"\n\n");return p.appendChild(u.createCDATASection(o)),u.documentElement.insertBefore(p,u.documentElement.firstElementChild),function(e){g=g||{};e=e.getElementsByTagName("image"),e=k.Util.toArray(e).filter(e=>{e=e.getAttributeNS(_,"href");return e&&!/^data:/.test(e)}).map(e=>e).map(t=>{const l=t.getAttributeNS(_,"href");let r=g[l];return(r?Promise.resolve(g[l]):k.BrowserUtils.loadImageAsync(t.getAttributeNS(_,"href")).then(e=>{var t=document.createElement("canvas"),i=t.getContext("2d"),o=e.width,s=e.height;return t.width=o,t.height=s,i.drawImage(e,0,0,o,s,0,0,t.width,t.height),g[l]=r=t.toDataURL("image/png"),r}).catch(e=>(k.debug("svg render: failed to load "+l),""))).then(e=>{t.setAttributeNS(_,"href",e)})});return Promise.all(e).then(()=>{})}(u).then(()=>{return e=u,f=f||{},k.BrowserUtils.isEdge()?(e=e.getElementsByTagName("image"),e=k.Util.toArray(e).filter(e=>/^data:image\/svg\+xml/.test(e.getAttributeNS(_,"href"))).map(e=>e).map(t=>{const i=t.getAttributeNS(_,"href"),e=parseInt(t.getAttribute("width").replace(/[^0-9]/g,"")),o=parseInt(t.getAttribute("height").replace(/[^0-9]/g,""));var s=f[i];return(s?Promise.resolve(s):k.BrowserUtils.encodeToPngAsync(i,{width:e,height:o,pixelDensity:2})).then(e=>{f[i]=e,t.setAttributeNS(_,"href",e)})}),Promise.all(e).then(()=>{})):Promise.resolve();var e}).then(()=>({width:r,height:n,svg:b(u).replace('<style xmlns="http://www.w3.org/1999/xhtml">',"<style>"),xml:y(u),css:o}))})}function y(e){e=(new XMLSerializer).serializeToString(e);return"data:image/svg+xml;base64,"+ts.pxtc.encodeBase64(unescape(encodeURIComponent(e)))}let g,f;function o(o,t,s=1.62,e){const l=[],r={};let n;o.forEach(e=>{var t=e.data;null!=t&&(r[t]=e)}),t.sort((e,t)=>e.isEnabled()===t.isEnabled()?e.type===t.type?0:"function_definition"===e.type?1:"function_definition"===t.type?-1:e.type.localeCompare(t.type):e.isEnabled()?-1:1),t.forEach(e=>{var t=h.getBlockData(e).commentRefs;if(t.length){const h=[];for(let e=0;e<t.length;e++){const i=r[t[e]];i&&(h.push(m(i)),delete r[t[e]])}if(h.length)return void l.push({value:e,width:-1,height:-1,children:h})}const i=m(e);!n&&e.isEnabled()&&e.type===pxtc.ON_START_TYPE?n=i:l.push(i)}),n&&l.unshift(n),Object.keys(r).sort((e,t)=>e.length===t.length?t<e?-1:1:e.length>t.length?-1:1).forEach(e=>{r[e]&&l.push(m(r[e]))}),o.forEach(e=>{null==e.data&&l.push(m(e))});let i,a=0;for(let e=0;e<l.length;e++){const h=l[e];if(h.children){const o=h.value.getHeightWidth();h.x=0,h.y=0;let t=o.width+13,i=0;for(let e=0;e<h.children.length;e++){const s=h.children[e];s.x=t,s.y=i,i+=s.height+13,h.width=Math.max(h.width,t+s.width)}h.height=Math.max(i-13,o.height)}a+=(h.height+13)*(h.width+13)}i=20<e?e-20:Math.sqrt(a)*s;let c=20,u=20,p=0;for(let e=0;e<l.length;e++){const h=l[e];if(h.children){d(h,c+h.x,u+h.y);for(let e=0;e<h.children.length;e++){const t=h.children[e];d(t,c+t.x,u+t.y)}}else d(h,c,u);c+=h.width+45,p=Math.max(p,u+h.height+45),c>i&&(c=20,u=p)}function d(e,t,i){var o=e.value.getBoundingRectangle();e.value.moveBy(t-o.left,i-o.top)}}function m(e){var t=e.getHeightWidth();return{value:e,height:t.height,width:t.width}}e.toSvgAsync=l,e.serializeNode=b,e.serializeSvgString=i,e.cleanUpBlocklySvg=r,e.blocklyToSvgAsync=n,e.documentToSvg=y}}(pxt=pxt||{}),function(ie){{var oe=ie.blocks||(ie.blocks={});const k={string:{field:"TEXT",block:"text",defaultValue:""},number:{field:"NUM",block:"math_number",defaultValue:"0"},boolean:{field:"BOOL",block:"logic_boolean",defaultValue:"false"},Array:{field:"VAR",block:"variables_get",defaultValue:"list"}};function p(e){e=/^(?:Array<(.+)>)|(?:(.+)\[\])|(?:\[.+\])$/.exec(e);return e?e[1]||e[2]:void 0}oe.optionalDummyInputPrefix="0_optional_dummy",oe.optionalInputWithFieldPrefix="0_optional_field",oe.isArrayType=p,oe.isTupleType=function(e){e=/^\[(.+)\]$/.exec(e);return e?e[1].split(/,\s*/):void 0};const b=/^(string|number|boolean)$/;let t,ee;function r(){return t||(t={},Object.keys(Blockly.Blocks).forEach(e=>t[e]={block:Blockly.Blocks[e]})),t}oe.builtinBlocks=r,oe.buildinBlockStatements={controls_if:!0,controls_for:!0,pxt_controls_for:!0,controls_simple_for:!0,controls_repeat_ext:!0,pxt_controls_for_of:!0,controls_for_of:!0,variables_set:!0,variables_change:!0,device_while:!0};let l={};function i(i,o,s,l){if(l=l||o.defaultValue,!(s=s||o.shadowBlockId)&&o.range&&(s="math_number_minmax"),l=l&&'"'==l.slice(0,1)?JSON.parse(l):l,"number"==o.type&&"value"==s){const i=document.createElement("field");return i.setAttribute("name",o.definitionName),i.appendChild(document.createTextNode("0")),i}var e="variables_get"==s,t="text"==s,r=document.createElement("value"),n=(r.setAttribute("name",o.definitionName),p(o.type)),a=document.createElement(e||n?"block":"shadow"),c=(r.appendChild(a),k[n||o.type]);if(a.setAttribute("type",s||(n?"lists_create_with":c&&c.block||o.type)),a.setAttribute("colour",Blockly.Colours.textField),n){if(c&&!s){let e;switch(n){case"number":e=["0","1"];break;case"string":e=["a","b","c"];break;case"boolean":e=["FALSE","FALSE","FALSE"]}return d(a,c.block,c.field,e),r}if(s&&l)return d(a,l),r}if(!c||s&&c.block!==s&&"math_number_minmax"!==s){if(l){const k=document.createElement("field");if(k.textContent=l,e)k.setAttribute("name","VAR"),a.appendChild(k);else if(t)k.setAttribute("name","TEXT"),a.appendChild(k);else if(s){const o=i.blocksById[s];if(o&&o.attributes._def&&o.attributes._def.parameters.length){const i=o.attributes._def.parameters[0];k.setAttribute("name",i.name),a.appendChild(k)}}else k.setAttribute("name",o.definitionName),a.appendChild(k)}}else{const i=document.createElement("field");let e,t;switch(a.appendChild(i),s){case"variables_get":e="VAR";break;case"math_number_minmax":e="SLIDER";break;default:e=c.field}i.setAttribute("name",e),t="boolean"==o.type?document.createTextNode((l||c.defaultValue).toUpperCase()):document.createTextNode(l||c.defaultValue),i.appendChild(t)}let u;return o.range&&((u=document.createElement("mutation")).setAttribute("min",o.range.min.toString()),u.setAttribute("max",o.range.max.toString()),u.setAttribute("label",o.actualName.charAt(0).toUpperCase()+o.actualName.slice(1)),o.fieldOptions)&&(o.fieldOptions.step&&u.setAttribute("step",o.fieldOptions.step),o.fieldOptions.color&&u.setAttribute("color",o.fieldOptions.color),o.fieldOptions.precision)&&u.setAttribute("precision",o.fieldOptions.precision),o.fieldOptions&&(u=u||document.createElement("mutation")).setAttribute("customfield",JSON.stringify(o.fieldOptions)),u&&a.appendChild(u),r}function d(t,i,o,s){const l=s?s.length:2,e=document.createElement("mutation");e.setAttribute("items",""+l),e.setAttribute("horizontalafter",""+l),t.appendChild(e);for(let e=0;e<l;e++){const l=document.createElement("value");l.setAttribute("name","ADD"+e);var r=document.createElement("shadow");if(r.setAttribute("type",i),o){const t=document.createElement("field");t.setAttribute("name",o),s&&t.appendChild(document.createTextNode(s[e])),r.appendChild(t)}l.appendChild(r),t.appendChild(l)}}function se(e,t,i,o){e=s(e,ie.toolbox.convertColor(t),i,o);return e.setAttribute("web-class","blocklyFlyoutHeading"),e}function s(e,t,i,o){var s=Blockly.utils.xml.createElement("label");return s.setAttribute("text",e),t&&s.setAttribute("web-icon-color",ie.toolbox.convertColor(t)),i&&(1===i.length?(s.setAttribute("web-icon",i),o&&s.setAttribute("web-icon-class",o)):s.setAttribute("web-icon-class","blocklyFlyoutIcon"+e)),s}function u(t,l,e){let r=document.createElement("block");if(r.setAttribute("type",l.attributes.blockId),l.attributes.blockGap?r.setAttribute("gap",l.attributes.blockGap):ie.appTarget.appTheme&&ie.appTarget.appTheme.defaultBlockGap&&r.setAttribute("gap",ie.appTarget.appTheme.defaultBlockGap.toString()),e.thisParameter){const ie=e.thisParameter;r.appendChild(i(t,ie,ie.shadowBlockId||"variables_get",ie.defaultValue||ie.definitionName))}return l.parameters&&(e.parameters.filter(e=>!e.isOptional&&(b.test(e.type)||b.test(p(e.type))||e.shadowBlockId||e.defaultValue)).forEach(e=>{r.appendChild(i(t,e))}),l.attributes.draggableParameters?e.handlerArgs.forEach(e=>{var t="reporter"===l.attributes.draggableParameters,i=document.createElement("value"),o=(i.setAttribute("name","HANDLER_DRAG_PARAM_"+e.name),t?ie.blocks.reporterTypeForArgType(e.type):"variables_get_reporter"),s=document.createElement("shadow");if(s.setAttribute("type",o),t&&"argument_reporter_custom"===o){const ie=document.createElement("mutation");ie.setAttribute("typename",e.type),s.appendChild(ie)}o=document.createElement("field");o.setAttribute("name",t?"VALUE":"VAR"),o.textContent=ie.Util.htmlEscape(e.name),s.appendChild(o),i.appendChild(s),r.appendChild(i)}):e.handlerArgs.forEach(e=>{var t=document.createElement("field");t.setAttribute("name","HANDLER_"+e.name),t.textContent=e.name,r.appendChild(t)})),r}function o(s){return ee=s,Blockly.pxtBlocklyUtils.whitelistDraggableBlockTypes(s.blocks.filter(e=>e.attributes.duplicateShadowOnDrag).map(e=>e.attributes.blockId)),s.blocks.map(e=>{var i=oe.compileInfo(e),o=u(s,e,i);if(e.attributes.blockBuiltin){ie.Util.assert(!!r()[e.attributes.blockId]);const oe=r()[e.attributes.blockId];oe.symbol=e,oe.block.codeCard=h(e,o)}else{var n=s;var a=e;var c=i;i=o;let t=a.attributes.blockId;r()[t]?ie.reportError("blocks","trying to override builtin block",{details:t}):(o=JSON.stringify(a),l[t]&&l[t].hash==o||(Blockly.Blocks[a.attributes.blockId]?console.error("duplicate block definition: "+t):(o={hash:o,fn:a,block:{codeCard:h(a,i),init:function(){{var l=this,T=n,x=a,v=c;const s=(x.attributes.blockNamespace||x.namespace).split(".")[0],E=1==x.kind||2==x.kind,r=T.apis.byQName[s],B=x.attributes.blockNamespace&&r&&r.attributes.color||x.attributes.color||r&&r.attributes.color||ie.toolbox.getNamespaceColor(s)||255;if(x.attributes.help){const ie=x.attributes.help.replace(/^\//,"");/^github:/.test(ie)?l.setHelpUrl(ie):"none"!==ie&&l.setHelpUrl("/reference/"+ie)}else x.pkg&&!ie.appTarget.bundledpkgs[x.pkg]&&((i=x.qName.toLowerCase().split("."))[0]==x.pkg&&i.shift(),l.setHelpUrl(`/pkg/${x.pkg}#`+encodeURIComponent(i.join("-"))));l.setColour(B);let e=Blockly.OUTPUT_SHAPE_ROUND,t=("boolean"==x.retType&&(e=Blockly.OUTPUT_SHAPE_HEXAGONAL),l.setOutputShape(e),x.attributes.undeletable&&l.setDeletable(!1),o(x.attributes._def),!1);if(x.attributes.mutate)oe.addMutation(l,x,x.attributes.mutate);else if(x.attributes.defaultInstance)oe.addMutation(l,x,oe.MutatorTypes.DefaultInstanceMutator);else if(x.attributes._expandedDef&&"disabled"!==x.attributes.expandableArgumentMode){const ie="toggle"===x.attributes.expandableArgumentMode;oe.initExpandableBlock(T,l,x.attributes._expandedDef,v,ie,()=>o(x.attributes._expandedDef,!0))}else if(v.handlerArgs.length)if(t=!0,x.attributes.optionalVariableArgs)oe.initVariableArgsBlock(l,v.handlerArgs);else if(x.attributes.draggableParameters)v.handlerArgs.filter(e=>!e.inBlockDef).forEach(e=>{var t=l.appendValueInput("HANDLER_DRAG_PARAM_"+e.name);"reporter"==x.attributes.draggableParameters?t.setCheck(A(e.type,T)):t.setCheck("Variable")});else{let t=l.appendDummyInput();v.handlerArgs.filter(e=>!e.inBlockDef).forEach(e=>{t.appendField(new Blockly.FieldVariable(e.name),"HANDLER_"+e.name)})}if(oe.appendMutation(l,{mutationToDom:t=>(l.inputList.forEach(e=>{e.fieldRow.forEach(e=>{e.isFieldCustom_&&e.saveOptions&&(e=e.saveOptions())&&t.setAttribute("customfield",JSON.stringify(e))})}),t),domToMutation:i=>{l.inputList.forEach(e=>{e.fieldRow.forEach(e=>{var t;e.isFieldCustom_&&e.restoreOptions&&(t=JSON.parse(i.getAttribute("customfield")))&&e.restoreOptions(t)})})}}),x.attributes.imageLiteral){const ie=(x.attributes.imageLiteralColumns||5)*x.attributes.imageLiteral,oe=x.attributes.imageLiteralRows||5,T=x.attributes.imageLiteralScale;l.appendDummyInput().appendField(new pxtblockly.FieldMatrix("",{columns:ie,rows:oe,scale:T}),"LEDS")}"external"===x.attributes.inlineInputMode?l.setInputsInline(!1):"inline"===x.attributes.inlineInputMode?l.setInputsInline(!0):l.setInputsInline(!x.parameters||x.parameters.length<4&&!x.attributes.imageLiteral),(null!=(i=x.parameters)&&i.find(e=>pxtc.parameterTypeIsArrowFunction(e))||t)&&(l.appendStatementInput("HANDLER").setCheck(null),l.setInputsInline(!0)),le(l,x.retType,T);var i=m(x);function o(o,i=!1){let s=0,y=!i&&!!v.thisParameter;const e=function(){const e=[];let t=[];return o.parts.forEach(e=>{switch(e.kind){case"break":i();break;case"param":t.push(e),i();break;case"image":case"label":t.push(e)}}),i(),e;function i(){t.length&&(e.push(t),t=[])}}(),_=new ie.ImageConverter;"ENUM_GET"!==x.attributes.shim&&"KIND_GET"!==x.attributes.shim||!(1<v.parameters.length||v.thisParameter)?(e.forEach(e=>{const g=[];let f,k,t,b=!1;if(e.forEach(e=>{if("param"!==e.kind){const oe="image"===(i=e).kind?(t=i.uri,(o=C[t])?new Blockly.FieldImage(o,40,40,"",null,ie.Util.isUserLanguageRtl()):void ie.log("missing jres icon "+t)):(o=function(e){if(" "===e)return"";if(1<e.length){var t=" "==e.charAt(0),i=" "==e.charAt(e.length-1);if(t||i)return e.substring(t?1:0,i?e.length-1:e.length)}return e}(i.text))?i.cssClass?new Blockly.FieldLabel(o,i.cssClass):i.style.length?new pxtblockly.FieldStyledLabel(o,{bold:-1!==i.style.indexOf("bold"),italics:-1!==i.style.indexOf("italics"),blocksInfo:void 0}):new Blockly.FieldLabel(o,void 0):void 0;oe&&g.push({field:oe})}else if("ENUM_GET"===x.attributes.shim)ie.U.assert(!!x.attributes.enumName,"Trying to create an ENUM_GET block without a valid enum name"),g.push({name:"MEMBER",field:new pxtblockly.FieldUserEnum(T.enumsByName[x.attributes.enumName])});else if("KIND_GET"===x.attributes.shim)g.push({name:"MEMBER",field:new pxtblockly.FieldKind(T.kindsByName[x.attributes.kindNamespace||x.attributes.blockNamespace||x.namespace])});else{let o=function(i,e,t=!1){if(i.ref){const t="this"===i.name?e.thisParameter:e.actualNameToParam[i.name];if(!t){let t;if(e.handlerArgs.forEach(e=>{e.name===i.name&&(t=e)}),t)return t}return t}return t?e.thisParameter:e.definitionNameToParam[i.name]}(e,v,y);if(y=!1,o)if(o.definitionName){var t=ie.U.lookup(T.apis.byQName,o.type),i=(b=!0,o.definitionName),s=o.actualName,l=t&&6==t.kind,r=t&&!!t.attributes.fixedInstances&&!o.shadowBlockId,n=!!x.attributes.constantShim,a="@combined@"==o.type,c=o.fieldEditor,u=i.charAt(0).toUpperCase()+i.slice(1),p=o.type;if(l||r||n||a){let e;0==(e=l?(h=T.apis,m=o.type,ie.Util.values(h.byQName).filter(e=>e.namespace===m&&!e.attributes.blockHidden)):r?N(T.apis,t.qName):a?x.combinedProperties.map(e=>ie.U.lookup(T.apis.byQName,e)):(n=T.apis,d=x.qName,ie.Util.values(n.byQName).filter(e=>e.attributes.blockIdentity===d))).length&&console.error(`no instances of ${t.qName} found`);const v=e.map(e=>{let t=e.attributes.block||e.attributes.blockId||e.name,i=e.attributes.blockCombine;return e.attributes.jresURL&&!e.attributes.iconURL&&ie.U.startsWith(e.attributes.jresURL,"data:image/x-mkcd-f")&&(e.attributes.iconURL=_.convert(e.attributes.jresURL)),i&&(t=t.replace(/@set/,"")),[e.attributes.iconURL||e.attributes.blockImage?{src:e.attributes.iconURL||ie.Util.pathJoin(ie.webConfig.commitCdnUrl,`blocks/${e.namespace.toLowerCase()}/${e.name.toLowerCase()}.png`),alt:t,width:36,height:36,value:e.name}:t,e.namespace+"."+e.name]});if(o.defaultValue){let i=-1;if(v.some((e,t)=>e[1]===o.defaultValue&&(i=t,!0)),-1<i){const oe=v.splice(i,1)[0];v.unshift(oe)}}if(c){l=x.attributes.paramDefl[s]||"";const h={data:v,colour:B,label:u,type:p,blocksInfo:T};ie.Util.jsonMergeFrom(h,x.attributes.paramFieldEditorOptions&&x.attributes.paramFieldEditorOptions[s]||{}),g.push(I(oe.createFieldEditor(c,l,h),i))}else g.push(I(new Blockly.FieldDropdown(v),i))}else if(c){const e=x.attributes.paramDefl[o.actualName]||"",v={colour:B,label:u,type:p,blocksInfo:T};ie.Util.jsonMergeFrom(v,x.attributes.paramFieldEditorOptions&&x.attributes.paramFieldEditorOptions[o.actualName]||{}),g.push(I(oe.createFieldEditor(c,e,v),o.definitionName))}else f=i,E&&"this"===e.name?k=o.type:"number"==o.type&&o.shadowBlockId&&"value"==o.shadowBlockId?(f=void 0,g.push(I(new Blockly.FieldTextInput("0",Blockly.FieldTextInput.numberValidator),i))):k="string"==o.type&&o.shadowOptions&&o.shadowOptions.toString?null:A(o.type,T)}else f="HANDLER_DRAG_PARAM_"+o.name,k="reporter"===x.attributes.draggableParameters?A(o.type,T):"Variable";else console.error("block "+x.attributes.blockId+": unknown parameter "+e.name+(e.ref?` (${e.ref})`:""))}var d,i,t,o,h,m}),f)(t=l.appendValueInput(f)).setAlign(Blockly.ALIGN_LEFT);else if(i){const ie=b?oe.optionalInputWithFieldPrefix:oe.optionalDummyInputPrefix;t=l.appendDummyInput(ie+s++)}else t=l.appendDummyInput();k&&t.setCheck(k),g.forEach(e=>t.appendField(e.field,e.name))}),_.logTime()):console.warn(`Enum blocks may only have 1 parameter but ${x.attributes.blockId} has `+v.parameters.length)}l.setPreviousStatement(!(i&&!x.attributes.handlerStatement)&&"void"==x.retType),l.setNextStatement(!(i&&!x.attributes.handlerStatement)&&"void"==x.retType),l.setTooltip(/^__/.test(x.namespace)?"":x.attributes.jsDoc)}}}},ie.Util.isTranslationMode()&&ie.blocks.promptTranslateBlock&&(o.block.customContextMenu=e=>{a.attributes.translationId&&e.push({enabled:!0,text:lf("Translate this block"),callback:function(){ie.blocks.promptTranslateBlock(t,[a.attributes.translationId])}})}),l[t]=o,Blockly.Blocks[t]=o.block)))}return e})}function c(e){return e.outerHTML.replace(/^<\?[^>]*>/,"")}function h(e,t){return{name:e.namespace+"."+e.name,shortName:e.name,description:e.attributes.jsDoc,url:e.attributes.help?"reference/"+e.attributes.help.replace(/^\//,""):void 0,blocksXml:`<xml xmlns="http://www.w3.org/1999/xhtml">${c(t)}</xml>`}}function m(e){return!(null==(e=e.parameters)||!e.some(e=>pxtc.parameterTypeIsArrowFunction(e)))}oe.blockSymbol=function(e){e=l[e];return e?e.fn:void 0},oe.createShadowValue=i,oe.createFlyoutHeadingLabel=se,oe.createFlyoutGroupLabel=function(e,t,i,o){e=s(e,void 0,t);return e.setAttribute("web-class","blocklyFlyoutGroup"),e.setAttribute("web-line","1.5"),i&&e.setAttribute("web-line-width",i),o&&(e.setAttribute("web-help-button","true"),e.setAttribute("callbackKey",o)),e},oe.createFlyoutButton=function(e,t){var i=Blockly.utils.xml.createElement("button");return i.setAttribute("text",t),i.setAttribute("callbackKey",e),i},oe.createToolboxBlock=u,oe.injectBlocks=o,oe.hasArrowFunction=m,oe.cleanBlocks=function(){ie.debug("removing all custom blocks");for(const ie in l)e=l[ie].fn,delete Blockly.Blocks[e.attributes.blockId],delete l[e.attributes.blockId];var e},oe.initializeAndInject=function(e){n(),o(e)};let te=!(oe.initialize=function(e){n();{C={};const i=e.apis.jres;i&&Object.keys(i).forEach(e=>{var t=i[e];t&&t.icon&&(C[e]=t.icon)})}});function n(){if(!te){te=!0,goog.provide("Blockly.Blocks.device"),goog.require("Blockly.Blocks"),Blockly.FieldCheckbox.CHECK_CHAR="",Blockly.Constants.ADD_START_HATS=!!ie.appTarget.appTheme.blockHats,oe.initFieldEditors();{const u=Blockly.Msg;u.DUPLICATE_BLOCK=lf("{id:block}Duplicate"),u.DUPLICATE_COMMENT=lf("Duplicate Comment"),u.REMOVE_COMMENT=lf("Remove Comment"),u.ADD_COMMENT=lf("Add Comment"),u.EXTERNAL_INPUTS=lf("External Inputs"),u.INLINE_INPUTS=lf("Inline Inputs"),u.EXPAND_BLOCK=lf("Expand Block"),u.COLLAPSE_BLOCK=lf("Collapse Block"),u.ENABLE_BLOCK=lf("Enable Block"),u.DISABLE_BLOCK=lf("Disable Block"),u.DELETE_BLOCK=lf("Delete Block"),u.DELETE_X_BLOCKS=lf("Delete Blocks"),u.DELETE_ALL_BLOCKS=lf("Delete All Blocks"),u.HELP=lf("Help"),Blockly.BlockSvg.prototype.showHelp=function(){var e=goog.isFunction(this.helpUrl)?this.helpUrl():this.helpUrl;e&&(ie.blocks.openHelpUrl||window.open)(e)},Blockly.WorkspaceSvg.prototype.configureContextMenu=function(l,r){if(!this.options.readOnly&&!this.isFlyout){l.length=0;let e=this.getTopBlocks(!0),t=Blockly.utils.genUid(),i=this.getTopComments();var n=!(this.options.debugMode||this.options.readOnly);if(this.options.comments&&!ie.BrowserUtils.isIE()){const ie=Blockly.ContextMenu.workspaceCommentOption(this,r);ie.enabled=ie.enabled&&n,l.push(ie)}let o=Blockly.WorkspaceSvg.buildDeleteList_(e),s=0;for(let e=0;e<o.length;e++)o[e].isShadow()||s++;const c=10;r={text:1==s?u.DELETE_BLOCK:u.DELETE_ALL_BLOCKS,enabled:0<s&&n,callback:()=>{ie.tickEvent("blocks.context.delete",void 0,{interactiveConsent:!0}),s<2?a():Blockly.confirm(lf("Delete all {0} blocks?",s),e=>{e&&a()})}},r=(l.push(r),{text:lf("Format Code"),enabled:n,callback:()=>{ie.tickEvent("blocks.context.format",void 0,{interactiveConsent:!0}),ie.blocks.layout.flow(this,{useViewWidth:!0})}});if(l.push(r),ie.appTarget.appTheme.blocksCollapsing){const oe={text:lf("Collapse Blocks"),enabled:e.length&&e.find(e=>e.isEnabled()&&!e.isCollapsed())&&n,callback:()=>{ie.tickEvent("blocks.context.collapse",void 0,{interactiveConsent:!0}),ie.blocks.layout.setCollapsedAll(this,!0)}},u=(l.push(oe),{text:lf("Expand Blocks"),enabled:e.length&&e.find(e=>e.isEnabled()&&e.isCollapsed())&&n,callback:()=>{ie.tickEvent("blocks.context.expand",void 0,{interactiveConsent:!0}),ie.blocks.layout.setCollapsedAll(this,!1)}});l.push(u)}if(ie.blocks.layout.screenshotEnabled()){const oe={text:lf("Snapshot"),enabled:0<e.length||0<i.length,callback:()=>{var e;ie.tickEvent("blocks.context.screenshot",void 0,{interactiveConsent:!0}),ie.blocks.layout.screenshotAsync(this,null,null==(e=ie.appTarget.appTheme)?void 0:e.embedBlocksInSnapshot).then(e=>{ie.BrowserUtils.isSafari()&&(e=e.replace(/^data:image\/[^;]/,"data:application/octet-stream")),ie.BrowserUtils.browserDownloadDataUri(e,`${ie.appTarget.nickname||ie.appTarget.id}-${lf("screenshot")}.png`)})}};l.push(oe)}function a(){Blockly.Events.setGroup(t);var e=o.shift();e&&(e.workspace?(e.dispose(!1,!0),setTimeout(a,c)):a()),Blockly.Events.setGroup(!1)}oe.onShowContextMenu&&oe.onShowContextMenu(this,l)}},Blockly.Constants.Logic.LOGIC_COMPARE_ONCHANGE_MIXIN.onchange=function(){}}{const s=ie.blocks.getBlockDefinition(ts.pxtc.ON_START_TYPE);if(Blockly.Blocks[ts.pxtc.ON_START_TYPE]={init:function(){this.jsonInit({message0:s.block.message0,args0:[{type:"input_dummy"},{type:"input_statement",name:"HANDLER"}],colour:(ie.appTarget.runtime?ie.appTarget.runtime.onStartColor:"")||ie.toolbox.getNamespaceColor("loops")}),ae(this,ts.pxtc.ON_START_TYPE,s.name,s.tooltip,s.url,String((ie.appTarget.runtime?ie.appTarget.runtime.onStartColor:"")||ie.toolbox.getNamespaceColor("loops")),void 0,void 0,!!ie.appTarget.runtime&&ie.appTarget.runtime.onStartUnDeletable)}},Blockly.Blocks[pxtc.TS_STATEMENT_TYPE]={init:function(){let t,o,s=this;s.setColour("#717171"),s.setPreviousStatement(!0),s.setNextStatement(!0),s.setInputsInline(!1),s.domToMutation=t=>{const i=parseInt(t.getAttribute("numlines"));s.declaredVariables=t.getAttribute("declaredvars"),o=[];for(let e=0;e<i;e++){const i=t.getAttribute("line"+e);o.push(i)}s.setPythonEnabled(!1)},s.mutationToDom=()=>{let i=document.createElement("mutation");return o&&(o.forEach((e,t)=>i.setAttribute("line"+t,e)),i.setAttribute("numlines",o.length.toString())),s.declaredVariables&&i.setAttribute("declaredvars",this.declaredVariables),i},s.setPythonEnabled=e=>{if(t!==e){for(;s.inputList.length;)s.removeInput(s.inputList[0].name);(t=e)?(s.appendDummyInput().appendField(ie.Util.lf("<python code>"),"LINE0"),s.setTooltip(lf("A Python statement that could not be converted to blocks"))):(o.forEach((e,t)=>{s.appendDummyInput().appendField(e,"LINE"+t)}),s.setTooltip(lf("A JavaScript statement that could not be converted to blocks")))}},s.getLines=()=>o,s.setEditable(!1),ae(this,pxtc.TS_STATEMENT_TYPE,lf("JavaScript statement"),lf("A JavaScript statement that could not be converted to blocks"),"/blocks/javascript-blocks","#717171")}},Blockly.Blocks[pxtc.TS_OUTPUT_TYPE]={init:function(){let t=this;t.setColour("#717171"),t.setPreviousStatement(!1),t.setNextStatement(!1),t.setOutput(!0),t.setEditable(!1),t.appendDummyInput().appendField(new pxtblockly.FieldTsExpression(""),"EXPRESSION"),t.setPythonEnabled=e=>{t.getField("EXPRESSION").setPythonEnabled(e),e?t.setTooltip(lf("A Python expression that could not be converted to blocks")):t.setTooltip(lf("A JavaScript expression that could not be converted to blocks"))},ae(t,pxtc.TS_OUTPUT_TYPE,lf("JavaScript expression"),lf("A JavaScript expression that could not be converted to blocks"),"/blocks/javascript-blocks","#717171")}},ie.appTarget.runtime&&ie.appTarget.runtime.pauseUntilBlock){const s=ie.appTarget.runtime.pauseUntilBlock,l=ie.blocks.getBlockDefinition(ts.pxtc.PAUSE_UNTIL_TYPE);Blockly.Blocks[pxtc.PAUSE_UNTIL_TYPE]={init:function(){var e=s.color||ie.toolbox.getNamespaceColor("loops");this.jsonInit({message0:l.block.message0,args0:[{type:"input_value",name:"PREDICATE",check:"Boolean"}],inputsInline:!0,previousStatement:null,nextStatement:null,colour:e}),ae(this,ts.pxtc.PAUSE_UNTIL_TYPE,l.name,l.tooltip,l.url,e,void 0,void 0,!1)}}}const l="pxt_controls_for_of",r=ie.blocks.getBlockDefinition(l),n=(Blockly.Blocks[l]={init:function(){this.jsonInit({message0:r.block.message0,args0:[{type:"input_value",name:"VAR",variable:r.block.variable,check:"Variable"},{type:"input_value",name:"LIST",check:["Array","String"]}],previousStatement:null,nextStatement:null,colour:ie.toolbox.blockColors.loops,inputsInline:!0}),this.appendStatementInput("DO").appendField(r.block.appendField);let e=this;ae(this,l,r.name,function(){return ie.U.rlf(r.tooltip,e.getInputTargetBlock("VAR")?e.getInputTargetBlock("VAR").getField("VAR").getText():"")},r.url,String(ie.toolbox.getNamespaceColor("loops")))}},"controls_for_of"),a=ie.blocks.getBlockDefinition(n),c=(Blockly.Blocks[n]={init:function(){this.jsonInit({message0:a.block.message0,args0:[{type:"field_variable",name:"VAR",variable:a.block.variable},{type:"input_value",name:"LIST",check:"Array"}],previousStatement:null,nextStatement:null,colour:ie.toolbox.blockColors.loops,inputsInline:!0}),this.appendStatementInput("DO").appendField(a.block.appendField);let e=this;ae(this,n,a.name,function(){return ie.U.rlf(a.tooltip,e.getField("VAR").getText())},a.url,String(ie.toolbox.getNamespaceColor("loops")))}},"lists_index_get"),F=ie.blocks.getBlockDefinition(c),p=(Blockly.Blocks.lists_index_get={init:function(){this.jsonInit({message0:F.block.message0,args0:[{type:"input_value",name:"LIST",check:"Array"},{type:"input_value",name:"INDEX",check:"Number"}],colour:ie.toolbox.blockColors.arrays,outputShape:Blockly.OUTPUT_SHAPE_ROUND,inputsInline:!0}),this.setPreviousStatement(!1),this.setNextStatement(!1),this.setOutput(!0),re(this,c)}},"lists_index_set"),M=ie.blocks.getBlockDefinition(p);Blockly.Blocks[p]={init:function(){this.jsonInit({message0:M.block.message0,args0:[{type:"input_value",name:"LIST",check:"Array"},{type:"input_value",name:"INDEX",check:"Number"},{type:"input_value",name:"VALUE",check:null}],previousStatement:null,nextStatement:null,colour:ie.toolbox.blockColors.arrays,inputsInline:!0}),re(this,p)}}}{const d="math_op2",h=ie.blocks.getBlockDefinition(d),P=h.tooltip,m=(Blockly.Blocks[d]={init:function(){this.jsonInit({message0:lf("%1 of %2 and %3"),args0:[{type:"field_dropdown",name:"op",options:[[lf("{id:op}min"),"min"],[lf("{id:op}max"),"max"]]},{type:"input_value",name:"x",check:"Number"},{type:"input_value",name:"y",check:"Number"}],inputsInline:!0,output:"Number",outputShape:Blockly.OUTPUT_SHAPE_ROUND,colour:ie.toolbox.getNamespaceColor("math")}),ae(this,d,h.name,function(e){return P[e.getFieldValue("op")]},h.url,ie.toolbox.getNamespaceColor(h.category))}},"math_op3"),U=ie.blocks.getBlockDefinition(m),g=(Blockly.Blocks[m]={init:function(){this.jsonInit({message0:U.block.message0,args0:[{type:"input_value",name:"x",check:"Number"}],inputsInline:!0,output:"Number",outputShape:Blockly.OUTPUT_SHAPE_ROUND,colour:ie.toolbox.getNamespaceColor("math")}),re(this,m)}},["math_number","math_integer","math_whole_number","math_number_minmax"].forEach(e=>{var t=ie.blocks.getBlockDefinition(e);ce(e,t.name,t.tooltip,t.url,Blockly.Colours.textField,Blockly.Colours.textField,Blockly.Colours.textField)}),Blockly.Msg),f="math_arithmetic",k=ie.blocks.getBlockDefinition(f),V=k.tooltip;g.MATH_ADDITION_SYMBOL=k.block.MATH_ADDITION_SYMBOL,g.MATH_SUBTRACTION_SYMBOL=k.block.MATH_SUBTRACTION_SYMBOL,g.MATH_MULTIPLICATION_SYMBOL=k.block.MATH_MULTIPLICATION_SYMBOL,g.MATH_DIVISION_SYMBOL=k.block.MATH_DIVISION_SYMBOL,g.MATH_POWER_SYMBOL=k.block.MATH_POWER_SYMBOL,ce(f,k.name,function(e){return V[e.getFieldValue("OP")]},k.url,ie.toolbox.getNamespaceColor(k.category));var t="math_modulo",i=ie.blocks.getBlockDefinition(t);g.MATH_MODULO_TITLE=i.block.MATH_MODULO_TITLE,ne(t),oe.initMathOpBlock(),oe.initMathRoundBlock()}{Blockly.FieldVariable.prototype.getVariableTypes_=()=>[""];let e=lf("{id:var}item");Blockly.Variables.flyoutCategory=function(e){let t=[];ie.appTarget.appTheme.hideFlyoutHeadings||(i=se(lf("Variables"),ie.toolbox.getNamespaceColor("variables"),ie.toolbox.getNamespaceIcon("variables")),t.push(i));var i=document.createElement("button"),i=(i.setAttribute("text",lf("Make a Variable...")),i.setAttribute("callbackKey","CREATE_VARIABLE"),e.registerButtonCallback("CREATE_VARIABLE",function(e){Blockly.Variables.createVariable(e.getTargetWorkspace())}),t.push(i),Blockly.Variables.flyoutCategoryBlocks(e));return t=t.concat(i)},Blockly.Variables.flyoutCategoryBlocks=function(e){var t=e.getVariablesOfType(""),i=[];if(0<t.length){var o,s,l,r,e=t[t.length-1];t.sort(Blockly.VariableModel.compareByName);for(let e=0;e<t.length;e++){var n=t[e];Blockly.Blocks.variables_get&&(n='<xml><block type="variables_get" gap="8">'+Blockly.Variables.generateVariableFieldXmlString(n)+"</block></xml>",n=Blockly.Xml.textToDom(n).firstChild,i.push(n))}i[i.length-1].setAttribute("gap","24"),Blockly.Blocks.variables_set&&(r='<xml><block type="variables_set" gap="'+(Blockly.Blocks.variables_change?8:24)+'">'+Blockly.Variables.generateVariableFieldXmlString(e)+"</block></xml>",r=Blockly.Xml.textToDom(r).firstChild,(l=goog.dom.createDom("value")).setAttribute("name","VALUE"),(o=goog.dom.createDom("shadow")).setAttribute("type","math_number"),l.appendChild(o),(s=goog.dom.createDom("field")).setAttribute("name","NUM"),s.appendChild(document.createTextNode("0")),o.appendChild(s),r.appendChild(l),i.push(r)),Blockly.Blocks.variables_change&&(o='<xml><block type="variables_change" gap="'+(Blockly.Blocks.variables_get?20:8)+'">'+Blockly.Variables.generateVariableFieldXmlString(e)+'<value name="DELTA"><shadow type="math_number"><field name="NUM">1</field></shadow></value></block></xml>',s=Blockly.Xml.textToDom(o).firstChild,(l=goog.dom.createDom("value")).setAttribute("name","VALUE"),(r=goog.dom.createDom("shadow")).setAttribute("type","math_number"),l.appendChild(r),(e=goog.dom.createDom("field")).setAttribute("name","NUM"),e.appendChild(document.createTextNode("1")),r.appendChild(e),s.appendChild(l),i.push(s))}return i};var i=Blockly.Msg,t="variables_get",o=ie.blocks.getBlockDefinition(t),o=(i.VARIABLES_GET_CREATE_SET=o.block.VARIABLES_GET_CREATE_SET,ne(t),ne("variables_get_reporter"),i.RENAME_VARIABLE=lf("Rename variable..."),i.DELETE_VARIABLE=lf('Delete the "%1" variable'),i.DELETE_VARIABLE_CONFIRMATION=lf('Delete %1 uses of the "%2" variable?'),i.NEW_VARIABLE_DROPDOWN=lf("New variable..."),"variables_set"),t=ie.blocks.getBlockDefinition(o);i.VARIABLES_SET=t.block.VARIABLES_SET,i.VARIABLES_DEFAULT_NAME=e,i.VARIABLES_SET_CREATE_GET=lf("Create 'get %1'"),ne(o);const b="variables_change",H=ie.blocks.getBlockDefinition(b);Blockly.Blocks[b]={init:function(){this.jsonInit({message0:H.block.message0,args0:[{type:"field_variable",name:"VAR",variable:e},{type:"input_value",name:"VALUE",check:"Number"}],inputsInline:!0,previousStatement:null,nextStatement:null,colour:ie.toolbox.getNamespaceColor("variables")}),re(this,b)},customContextMenu:function(e){var t,i;this.inDebugWorkspace()||(t={enabled:0<this.workspace.remainingCapacity()},i=this.getField("VAR").getText(),t.text=lf("Create 'get {0}'",i),(i=goog.dom.createDom("field",null,i)).setAttribute("name","VAR"),(i=goog.dom.createDom("block",null,i)).setAttribute("type","variables_get"),t.callback=Blockly.ContextMenu.callbackFactory(this,i),e.push(t))}},i.NEW_VARIABLE_TITLE=lf("New variable name:"),i.RENAME_VARIABLE_TITLE=lf("Rename all '%1' variables to:")}{(t=Blockly.Msg).FUNCTION_CREATE_NEW=lf("Make a Function..."),t.FUNCTION_WARNING_DUPLICATE_ARG=lf("Functions cannot use the same argument name more than once."),t.FUNCTION_WARNING_ARG_NAME_IS_FUNCTION_NAME=lf("Argument names must not be the same as the function name."),t.FUNCTION_WARNING_EMPTY_NAME=lf("Function and argument names cannot be empty."),t.FUNCTIONS_DEFAULT_FUNCTION_NAME=lf("doSomething"),t.FUNCTIONS_DEFAULT_BOOLEAN_ARG_NAME=lf("bool"),t.FUNCTIONS_DEFAULT_STRING_ARG_NAME=lf("text"),t.FUNCTIONS_DEFAULT_NUMBER_ARG_NAME=lf("num"),t.FUNCTIONS_DEFAULT_CUSTOM_ARG_NAME=lf("arg"),t.PROCEDURES_HUE=ie.toolbox.getNamespaceColor("functions"),t.REPORTERS_HUE=ie.toolbox.getNamespaceColor("variables"),o="procedures_defnoreturn",i=ie.blocks.getBlockDefinition(o),t.PROCEDURES_DEFNORETURN_TITLE=i.block.PROCEDURES_DEFNORETURN_TITLE,t.PROCEDURE_ALREADY_EXISTS=i.block.PROCEDURE_ALREADY_EXISTS,Blockly.Blocks.procedures_defnoreturn.init=function(){var e=new Blockly.FieldTextInput("",Blockly.Procedures.rename);this.appendDummyInput().appendField(Blockly.Msg.PROCEDURES_DEFNORETURN_TITLE).appendField(e,"NAME").appendField("","PARAMS"),this.setColour(ie.toolbox.getNamespaceColor("functions")),this.arguments_=[],this.argumentVarModels_=[],this.setStartHat(!0),this.setStatements_(!0),this.statementConnection_=null},ne(o);const y="procedures_callnoreturn",G=ie.blocks.getBlockDefinition(y),_=(t.PROCEDURES_CALLRETURN_TOOLTIP=i.tooltip.toString(),Blockly.Blocks.procedures_callnoreturn={init:function(){var e=new pxtblockly.FieldProcedure("");this.appendDummyInput("TOPROW").appendField(G.block.PROCEDURES_CALLNORETURN_TITLE).appendField(e,"NAME"),this.setPreviousStatement(!0),this.setNextStatement(!0),this.setColour(ie.toolbox.getNamespaceColor("functions")),this.arguments_=[],this.quarkConnections_={},this.quarkIds_=null},getProcedureCall:function(){return this.getFieldValue("NAME")},renameProcedure:function(e,t){Blockly.Names.equals(e,this.getProcedureCall())&&this.setFieldValue(t,"NAME")},onchange:function(i){if(this.workspace&&!this.workspace.isFlyout&&!this.isInsertionMarker())if(i.type==Blockly.Events.CREATE&&-1!=i.ids.indexOf(this.id)){let e=this.getProcedureCall(),t=Blockly.Procedures.getDefinition(e,this.workspace);var o,s,l;(t=!t||t.type==this.defType_&&JSON.stringify(t.arguments_)==JSON.stringify(this.arguments_)?t:null)||(Blockly.Events.setGroup(i.group),o=Blockly.utils.xml.createElement("xml"),(s=Blockly.utils.xml.createElement("block")).setAttribute("type",this.defType_),l=(r=this.getRelativeToSurfaceXY()).x+Blockly.SNAP_RADIUS*(this.RTL?-1:1),r=r.y+2*Blockly.SNAP_RADIUS,s.setAttribute("x",l),s.setAttribute("y",r),(l=Blockly.utils.xml.createElement("field")).setAttribute("name","NAME"),l.appendChild(document.createTextNode(this.getProcedureCall())),s.appendChild(l),o.appendChild(s),ie.blocks.domToWorkspaceNoEvents(o,this.workspace),Blockly.Events.setGroup(!1))}else{var r;i.type==Blockly.Events.DELETE&&(r=this.getProcedureCall(),Blockly.Procedures.getDefinition(r,this.workspace)||(Blockly.Events.setGroup(i.group),this.dispose(!0,!1),Blockly.Events.setGroup(!1)))}},mutationToDom:function(){var e=document.createElement("mutation");return e.setAttribute("name",this.getProcedureCall()),e},domToMutation:function(e){e=e.getAttribute("name");this.renameProcedure(this.getProcedureCall(),e)},customContextMenu:function(e){var t={enabled:!0};t.text=Blockly.Msg.PROCEDURES_HIGHLIGHT_DEF;let i=this.getProcedureCall(),o=this.workspace;t.callback=function(){var e=Blockly.Procedures.getDefinition(i,o);e&&e.select()},e.push(t)},defType_:"procedures_defnoreturn"},ne(y),"function_definition"),W=ie.blocks.getBlockDefinition(_),T=(t.FUNCTIONS_EDIT_OPTION=W.block.FUNCTIONS_EDIT_OPTION,ne(_),o="function_call",i=ie.blocks.getBlockDefinition(o),t.FUNCTIONS_CALL_TITLE=i.block.FUNCTIONS_CALL_TITLE,t.FUNCTIONS_GO_TO_DEFINITION_OPTION=i.block.FUNCTIONS_GO_TO_DEFINITION_OPTION,ne(o),ne("function_call_output"),"function_return"),j=(Blockly.Blocks[T]={init:function(){oe.initReturnStatement(this)},onchange:function(e){var t=this;if(t.workspace&&!t.workspace.isFlyout){const i=e.type===Blockly.Events.BLOCK_CREATE&&-1!=e.ids.indexOf(t.id),o=e.type===Blockly.Events.END_DRAG&&-1!=e.allNestedIds.indexOf(t.id);if(i||o){const i=t.getRootBlock();i.type!==T&&null==i.previousConnection&&i.type!==_&&(Blockly.Events.setGroup(e.group),t.previousConnection.disconnect(),Blockly.Events.setGroup(!1))}}}},ne(T),Blockly.Procedures.flyoutCategory=function(a){let t=[];ie.appTarget.appTheme.hideFlyoutHeadings||(e=se(lf("Functions"),ie.toolbox.getNamespaceColor("functions"),ie.toolbox.getNamespaceIcon("functions"),"blocklyFlyoutIconfunctions"),t.push(e));const i=lf("Make a Function..."),o=lf("New function name:");var e=Blockly.utils.xml.createElement("button");e.setAttribute("text",i),e.setAttribute("callbackKey","CREATE_FUNCTION");a.registerButtonCallback("CREATE_FUNCTION",function(e){let t=e=>{Blockly.prompt(o,e,function(o){if(ie.tickEvent("blocks.makeafunction"),o=o&&(o=o.replace(/[\s\xa0]+/g," ").replace(/^ | $/g,""))==i?null:o)if(a.getVariable(o))Blockly.alert(Blockly.Msg.VARIABLE_ALREADY_EXISTS.replace("%1",o.toLowerCase()),function(){t(o)});else if(Blockly.Procedures.isLegalName_(o,a)){var s=o;let e=a.getTopBlocks(!0)[0],t=10,i=10;e&&(l=e.getRelativeToSurfaceXY(),t=l.x+Blockly.SNAP_RADIUS*(e.RTL?-1:1),i=l.y+2*Blockly.SNAP_RADIUS);var l=Blockly.utils.xml.createElement("xml"),r=Blockly.utils.xml.createElement("block"),n=(r.setAttribute("type","procedures_defnoreturn"),r.setAttribute("x",String(t)),r.setAttribute("y",String(i)),Blockly.utils.xml.createElement("field")),s=(n.setAttribute("name","NAME"),n.appendChild(document.createTextNode(s)),r.appendChild(n),l.appendChild(r),ie.blocks.domToWorkspaceNoEvents(l,a));Blockly.hideChaff(),(n=a.getBlockById(s[0])).select(),a.centerOnBlock(n.id)}else Blockly.alert(Blockly.Msg.PROCEDURE_ALREADY_EXISTS.replace("%1",o.toLowerCase()),function(){t(o)})})};t("doSomething")}),t.push(e);var s=Blockly.Procedures.allProcedures(a)[0],l="procedures_callnoreturn";for(let e=0;e<s.length;e++){var r=s[e][0],n=(s[e][1],Blockly.utils.xml.createElement("block")),r=(n.setAttribute("type",l),n.setAttribute("gap","16"),n.setAttribute("colour",ie.toolbox.getNamespaceColor("functions")),goog.dom.createDom("field",null,r));r.setAttribute("name","NAME"),n.appendChild(r),t.push(n)}return t},Blockly.Functions.flyoutCategory),X=(Blockly.Functions.flyoutCategory=e=>{const t=j(e);1<t.length&&(o=ue(),t.splice(1,0,o));var i=Blockly.Functions.getAllFunctionDefinitionBlocks(e).filter(e=>e.getDescendants(!1).some(e=>"function_return"===e.type&&e.getInputTargetBlock("RETURN_VALUE"))).map(e=>e.getField("function_name").getText()),o=se(lf("Functions"),ie.toolbox.getNamespaceColor("functions"),ie.toolbox.getNamespaceIcon("functions"),"blocklyFlyoutIconfunctions"),s=(t.unshift(o),[]);for(const ie of t)if(s.push(ie),"function_call"===ie.getAttribute("type")){const e=ie.children.item(0);if(e){const t=e.getAttribute("name");if(i.some(e=>e===t)){const e=ie.cloneNode(!0);e.setAttribute("type","function_call_output"),s.push(e)}}}return s},{number:ie.blocks.defaultIconForArgType("number"),boolean:ie.blocks.defaultIconForArgType("boolean"),string:ie.blocks.defaultIconForArgType("string"),Array:ie.blocks.defaultIconForArgType("Array")}),$={},x=ie.appTarget.runtime&&ie.appTarget.runtime.functionsOptions,K=(x&&x.extraFunctionEditorTypes&&x.extraFunctionEditorTypes.forEach(e=>{X[e.typeName]=e.icon||ie.blocks.defaultIconForArgType(),e.defaultName&&($[e.typeName]=e.defaultName)}),Blockly.PXTBlockly.FunctionUtils.argumentIcons=X,Blockly.PXTBlockly.FunctionUtils.argumentDefaultNames=$,Blockly.Blocks.argument_reporter_custom&&(Blockly.Blocks.argument_reporter_custom.domToMutation=function(e){e=e.getAttribute("typename");this.typeName_=e,le(this,e,ee)}),Blockly.Functions.makeCreateCallOption);Blockly.Msg.FUNCTIONS_CREATE_CALL_OPTION="",Blockly.Functions.makeCreateCallOption=function(e){var t=K(e),e=e.getField("function_name").getText();return t.text=ie.Util.lf("Create 'call {0}'",e),t}}{const v=Blockly.Msg,Y="lists_create_with",E=ie.blocks.getBlockDefinition(Y);v.LISTS_CREATE_EMPTY_TITLE=E.block.LISTS_CREATE_EMPTY_TITLE,v.LISTS_CREATE_WITH_INPUT_WITH=E.block.LISTS_CREATE_WITH_INPUT_WITH,v.LISTS_CREATE_WITH_CONTAINER_TITLE_ADD=E.block.LISTS_CREATE_WITH_CONTAINER_TITLE_ADD,v.LISTS_CREATE_WITH_ITEM_TITLE=E.block.LISTS_CREATE_WITH_ITEM_TITLE,ne(Y),t="lists_length",i=ie.blocks.getBlockDefinition(t),v.LISTS_LENGTH_TITLE=i.block.LISTS_LENGTH_TITLE,Blockly.Blocks[t].init=function(){this.jsonInit({message0:v.LISTS_LENGTH_TITLE,args0:[{type:"input_value",name:"VALUE",check:["Array"]}],output:"Number",outputShape:Blockly.OUTPUT_SHAPE_ROUND})},ne(t)}{o=Blockly.Msg,i="controls_repeat_ext",t=ie.blocks.getBlockDefinition(i),o.CONTROLS_REPEAT_TITLE=t.block.CONTROLS_REPEAT_TITLE,o.CONTROLS_REPEAT_INPUT_DO=t.block.CONTROLS_REPEAT_INPUT_DO,ne(i);const B="device_while",z=ie.blocks.getBlockDefinition(B),C=(Blockly.Blocks[B]={init:function(){this.jsonInit({message0:z.block.message0,args0:[{type:"input_value",name:"COND",check:"Boolean"}],previousStatement:null,nextStatement:null,colour:ie.toolbox.getNamespaceColor("loops")}),this.appendStatementInput("DO").appendField(z.block.appendField),re(this,B)}},"pxt_controls_for"),A=ie.blocks.getBlockDefinition(C),I=(Blockly.Blocks[C]={init:function(){this.jsonInit({message0:A.block.message0,args0:[{type:"input_value",name:"VAR",variable:A.block.variable,check:"Variable"},{type:"input_value",name:"TO",check:"Number"}],previousStatement:null,nextStatement:null,colour:ie.toolbox.getNamespaceColor("loops"),inputsInline:!0}),this.appendStatementInput("DO").appendField(A.block.appendField);let e=this;ae(this,C,A.name,function(){return ie.U.rlf(A.tooltip,e.getInputTargetBlock("VAR")?e.getInputTargetBlock("VAR").getField("VAR").getText():"")},A.url,String(ie.toolbox.getNamespaceColor("loops")))},getVars:function(){return[this.getField("VAR").getText()]},renameVar:function(e,t){var i=this.getField("VAR");Blockly.Names.equals(e,i.getText())&&i.setValue(t)}},"controls_simple_for"),N=ie.blocks.getBlockDefinition(I),w=(Blockly.Blocks[I]={init:function(){this.jsonInit({message0:N.block.message0,args0:[{type:"field_variable",name:"VAR",variable:N.block.variable},{type:"input_value",name:"TO",check:"Number"}],previousStatement:null,nextStatement:null,colour:ie.toolbox.getNamespaceColor("loops"),inputsInline:!0}),this.appendStatementInput("DO").appendField(N.block.appendField);let e=this;ae(this,I,N.name,function(){return ie.U.rlf(N.tooltip,e.getField("VAR").getText())},N.url,String(ie.toolbox.getNamespaceColor("loops")))},getVars:function(){return[this.getField("VAR").getText()]},renameVar:function(e,t){var i=this.getField("VAR");Blockly.Names.equals(e,i.getText())&&i.setValue(t)},customContextMenu:function(e){var t,i;this.isCollapsed()||this.inDebugWorkspace()||(t={enabled:!0},i=this.getField("VAR").getText(),t.text=lf("Create 'get {0}'",i),(i=goog.dom.createDom("field",null,i)).setAttribute("name","VAR"),(i=goog.dom.createDom("block",null,i)).setAttribute("type","variables_get"),t.callback=Blockly.ContextMenu.callbackFactory(this,i),e.push(t))}},ie.blocks.getBlockDefinition(ts.pxtc.TS_BREAK_TYPE)),S=(Blockly.Blocks[pxtc.TS_BREAK_TYPE]={init:function(){var e=ie.toolbox.getNamespaceColor("loops");this.jsonInit({message0:w.block.message0,inputsInline:!0,previousStatement:null,nextStatement:null,colour:e}),ae(this,ts.pxtc.TS_BREAK_TYPE,w.name,w.tooltip,w.url,e,void 0,void 0,!1)}},ie.blocks.getBlockDefinition(ts.pxtc.TS_CONTINUE_TYPE)),q=(Blockly.Blocks[pxtc.TS_CONTINUE_TYPE]={init:function(){var e=ie.toolbox.getNamespaceColor("loops");this.jsonInit({message0:S.block.message0,inputsInline:!0,previousStatement:null,nextStatement:null,colour:e}),ae(this,ts.pxtc.TS_CONTINUE_TYPE,S.name,S.tooltip,S.url,e,void 0,void 0,!1)}},"#cccccc");Blockly.Blocks[pxtc.COLLAPSED_BLOCK]={init:function(){this.jsonInit({message0:"...",inputsInline:!0,previousStatement:null,nextStatement:null,colour:q}),ae(this,ts.pxtc.COLLAPSED_BLOCK,"...",lf("a few blocks"),void 0,q,void 0,void 0,!1)}}}o=Blockly.Msg,t="controls_if",i=ie.blocks.getBlockDefinition(t),e=i.tooltip,o.CONTROLS_IF_MSG_IF=i.block.CONTROLS_IF_MSG_IF,o.CONTROLS_IF_MSG_THEN=i.block.CONTROLS_IF_MSG_THEN,o.CONTROLS_IF_MSG_ELSE=i.block.CONTROLS_IF_MSG_ELSE,o.CONTROLS_IF_MSG_ELSEIF=i.block.CONTROLS_IF_MSG_ELSEIF,o.CONTROLS_IF_TOOLTIP_1=e.CONTROLS_IF_TOOLTIP_1,o.CONTROLS_IF_TOOLTIP_2=e.CONTROLS_IF_TOOLTIP_2,o.CONTROLS_IF_TOOLTIP_3=e.CONTROLS_IF_TOOLTIP_3,o.CONTROLS_IF_TOOLTIP_4=e.CONTROLS_IF_TOOLTIP_4,ne(t),i="logic_compare",e=ie.blocks.getBlockDefinition(i).tooltip,o.LOGIC_COMPARE_TOOLTIP_EQ=e.LOGIC_COMPARE_TOOLTIP_EQ,o.LOGIC_COMPARE_TOOLTIP_NEQ=e.LOGIC_COMPARE_TOOLTIP_NEQ,o.LOGIC_COMPARE_TOOLTIP_LT=e.LOGIC_COMPARE_TOOLTIP_LT,o.LOGIC_COMPARE_TOOLTIP_LTE=e.LOGIC_COMPARE_TOOLTIP_LTE,o.LOGIC_COMPARE_TOOLTIP_GT=e.LOGIC_COMPARE_TOOLTIP_GT,o.LOGIC_COMPARE_TOOLTIP_GTE=e.LOGIC_COMPARE_TOOLTIP_GTE,ne(i),t="logic_operation",e=ie.blocks.getBlockDefinition(t),i=e.tooltip,o.LOGIC_OPERATION_AND=e.block.LOGIC_OPERATION_AND,o.LOGIC_OPERATION_OR=e.block.LOGIC_OPERATION_OR,o.LOGIC_OPERATION_TOOLTIP_AND=i.LOGIC_OPERATION_TOOLTIP_AND,o.LOGIC_OPERATION_TOOLTIP_OR=i.LOGIC_OPERATION_TOOLTIP_OR,ne(t),e="logic_negate",i=ie.blocks.getBlockDefinition(e),o.LOGIC_NEGATE_TITLE=i.block.LOGIC_NEGATE_TITLE,ne(e),t="logic_boolean",i=ie.blocks.getBlockDefinition(t),o.LOGIC_BOOLEAN_TRUE=i.block.LOGIC_BOOLEAN_TRUE,o.LOGIC_BOOLEAN_FALSE=i.block.LOGIC_BOOLEAN_FALSE,ne(t);{ce("text",(e=ie.blocks.getBlockDefinition("text")).name,e.tooltip,e.url,Blockly.Colours.textField,Blockly.Colours.textField,Blockly.Colours.textField);const D=Blockly.Msg,L="text_length",Q=ie.blocks.getBlockDefinition(L);D.TEXT_LENGTH_TITLE=Q.block.TEXT_LENGTH_TITLE,Blockly.Blocks[L].init=function(){this.jsonInit({message0:D.TEXT_LENGTH_TITLE,args0:[{type:"input_value",name:"VALUE",check:["String"]}],output:"Number",outputShape:Blockly.OUTPUT_SHAPE_ROUND})},ne(L),e="text_join",o=ie.blocks.getBlockDefinition(e),D.TEXT_JOIN_TITLE_CREATEWITH=o.block.TEXT_JOIN_TITLE_CREATEWITH,ne(e)}{const O=(e,t)=>Math.abs(t-(e.left+e.width/2)),R=Blockly.BlockDragger.prototype.dragBlock,J=(Blockly.BlockDragger.prototype.dragBlock=function(e,t){var i=document.getElementsByClassName("blocklyToolboxDiv")[0],o=document.getElementsByClassName("blocklyTreeRoot")[0]||document.getElementsByClassName("blocklyFlyout")[0],s=document.getElementById("blocklyTrashIcon");if(o&&s){const R=O(o.getBoundingClientRect(),e.clientX);if(R<200){const O=R/200;s.style.opacity=""+(1-O),s.style.display="block",i&&(o.style.opacity=""+O,R<50)&&ie.BrowserUtils.addClass(i,"blocklyToolboxDeleting")}else s.style.display="none",o.style.opacity="1",i&&ie.BrowserUtils.removeClass(i,"blocklyToolboxDeleting")}return R.call(this,e,t)},Blockly.BlockDragger.prototype.endBlockDrag);Blockly.BlockDragger.prototype.endBlockDrag=function(e,t){J.call(this,e,t);var e=document.getElementsByClassName("blocklyToolboxDiv")[0],t=document.getElementsByClassName("blocklyTreeRoot")[0]||document.getElementsByClassName("blocklyFlyout")[0],i=document.getElementById("blocklyTrashIcon");i&&t&&(i.style.display="none",t.style.opacity="1",e)&&ie.BrowserUtils.removeClass(e,"blocklyToolboxDeleting")}}Blockly.Blocks[pxtc.TS_DEBUGGER_TYPE]={init:function(){var e=this;e.setColour(ie.toolbox.getNamespaceColor("debug")),e.setPreviousStatement(!0),e.setNextStatement(!0),e.setInputsInline(!1),e.appendDummyInput("ON_OFF").appendField(new Blockly.FieldLabel(lf("breakpoint"),void 0),"DEBUGGER").appendField(new pxtblockly.FieldBreakpoint("1",{type:"number"}),"ON_OFF"),ae(this,pxtc.TS_DEBUGGER_TYPE,lf("Debugger statement"),lf("A debugger statement invokes any available debugging functionality"),"/javascript/debugger",ie.toolbox.getNamespaceColor("debug"))}},Blockly.Msg.WORKSPACE_COMMENT_DEFAULT_TEXT="";{const Z=e=>{if(e.disabled)return lf("This block is disabled and will not run. Attach this block to an event to enable it.");let t=e.tooltip;for(;goog.isFunction(t);)t=t(e);return t};Blockly.Tooltip.show_=function(){const l=Blockly.Tooltip;if(l.poisonedElement_=l.element_,Blockly.Tooltip.DIV){if(goog.dom.removeChildren(Blockly.Tooltip.DIV),l.element_.codeCard){var e=ie.docs.codeCard.render({header:Z(l.element_)});Blockly.Tooltip.DIV.appendChild(e)}else{var e=Z(l.element_),t=(e=Blockly.utils._string.wrap(e,Blockly.Tooltip.LIMIT)).split("\n");for(let e=0;e<t.length;e++){var i=document.createElement("div");i.appendChild(document.createTextNode(t[e])),Blockly.Tooltip.DIV.appendChild(i)}}o()}function o(){var e=l.element_.RTL,t=goog.dom.getViewportSize(),i=Blockly.Tooltip.DIV;i.style.direction=e?"rtl":"ltr",i.style.display="block",Blockly.Tooltip.visible=!0;let o=l.lastX_,s=(e?o-=Blockly.Tooltip.OFFSET_X+i.offsetWidth:o+=Blockly.Tooltip.OFFSET_X,l.lastY_+Blockly.Tooltip.OFFSET_Y);s+i.offsetHeight>t.height+window.scrollY&&(s-=i.offsetHeight+2*Blockly.Tooltip.OFFSET_Y),e?o=Math.max(Blockly.Tooltip.MARGINS-window.scrollX,o):o+i.offsetWidth>t.width+window.scrollX-2*Blockly.Tooltip.MARGINS&&(o=t.width-i.offsetWidth-2*Blockly.Tooltip.MARGINS),i.style.top=s+"px",i.style.left=o+"px"}}}Blockly.Block.prototype.setEnabled=function(e){var t;this.disabled==e&&(t=Blockly.Events.recordUndo,Blockly.Events.recordUndo=!1,Blockly.Events.fire(new Blockly.Events.BlockChange(this,"disabled",null,this.disabled,!e)),Blockly.Events.recordUndo=t,this.disabled=!e)}}var e}function A(e,t){var i=e.split(/\s*\|\s*/),o=[];for(const e of i)switch(e){case"number":o.push("Number");break;case"string":o.push("String");break;case"boolean":o.push("Boolean");break;case"T":case"any":return null;case"void":return;default:if(p(e)){if(1<i.length)return null;o.push("Array")}var s=t.apis.byQName[e];s&&s.extendsTypes&&0<s.extendsTypes.length?o.push(...s.extendsTypes):o.push(e)}return o}function le(e,t,i){t=A(t,i);!t&&null!==t||e.setOutput(!0,t)}function re(e,t){var i=ie.blocks.getBlockDefinition(t);ae(e,t,i.name,i.tooltip,i.url,ie.toolbox.getNamespaceColor(i.category))}function ne(e){var t=ie.blocks.getBlockDefinition(e);ce(e,t.name,t.tooltip,t.url,ie.toolbox.getNamespaceColor(t.category))}function ae(i,o,e,t,s,l,r,n,a){!t||"string"!=typeof t&&"function"!=typeof t||i.setTooltip(t),s&&i.setHelpUrl(s),l&&i.setColour(l,r,n),a&&i.setDeletable(!1);l=document.getElementById("blocklyToolboxDefinition"),r=l?oe.getFirstChildWithAttr(l,"block","type",o):void 0;i.codeCard={header:e,name:e,software:1,description:goog.isFunction(t)?t(i):t,blocksXml:r?'<xml xmlns="http://www.w3.org/1999/xhtml">'+(c(r)||`<block type="${o}"></block>`)+"</xml>":void 0,url:s},ie.Util.isTranslationMode()&&ie.blocks.promptTranslateBlock&&(i.customContextMenu=e=>{const t=ie.blocks.getBlockDefinition(i.type);t&&t.translationIds&&e.push({enabled:!0,text:lf("Translate this block"),callback:function(){ie.blocks.promptTranslateBlock(o,t.translationIds)}})})}function ce(e,t,i,o,s,l,r){let n=Blockly.Blocks[e],a=n.init;a&&(n.init=function(){a.call(this),ae(this,e,t,i,o,s,l,r)})}function a(e,t,i,o){o=document.createElement(o?"shadow":"block"),o.setAttribute("type",ie.Util.htmlEscape(e)),e=document.createElement("field");return e.setAttribute("name",ie.Util.htmlEscape(t)),e.textContent=ie.Util.htmlEscape(i),o.appendChild(e),o}function ue(){var e=document.createElement("block"),t=(e.setAttribute("type","function_return"),document.createElement("value")),i=(t.setAttribute("name","RETURN_VALUE"),e.appendChild(t),a("math_number","NUM","0",!0));return t.appendChild(i),e}oe.installHelpResources=ce,oe.onShowContextMenu=void 0,oe.mkPredicateBlock=function(e){var t=document.createElement("block"),e=(t.setAttribute("type",e),document.createElement("value")),i=(e.setAttribute("name","PREDICATE"),t.appendChild(e),a("logic_boolean","BOOL","TRUE",!0));return e.appendChild(i),t},oe.mkFieldBlock=a,oe.mkReturnStatementBlock=ue;let C={};function I(e,t){return{field:e,name:t}}function N(t,i){return ie.Util.values(t.byQName).filter(e=>{return 4===e.kind&&e.attributes.fixedInstance&&((e=e.retType)==i||!(!(e=t.byQName[e])||!e.extendsTypes)&&0<=e.extendsTypes.indexOf(i))})}function g(e){return e.data?/^(?:\d+;?)+$/.test(e.data)?{commentRefs:e.data.split(";"),fieldData:{}}:JSON.parse(e.data):{commentRefs:[],fieldData:{}}}function f(e,t){e.data=JSON.stringify(t)}oe.getFixedInstanceDropdownValues=N,oe.generateIcons=function(e){const t=new ie.ImageConverter;e.forEach(e=>{e.attributes.jresURL&&!e.attributes.iconURL&&ie.U.startsWith(e.attributes.jresURL,"data:image/x-mkcd-f")&&(e.attributes.iconURL=t.convert(e.attributes.jresURL))})},oe.setVarFieldValue=function(e,t,i){var o=e.getField(t),s=e.workspace.getAllVariables();let l=!1;if(s&&s.length)for(let e=0;e<s.length;e++){const t=s[e];t.name===i&&(o.setValue(t.getId()),l=!0)}if(!l){o.initModel();const e=o.getVariable();e.name=i,o.setValue(e.getId())}},oe.getBlockData=g,oe.setBlockData=f,oe.setBlockDataForField=function(e,t,i){var o=g(e);o.fieldData[t]=i,f(e,o)},oe.getBlockDataForField=function(e,t){return g(e).fieldData[t]}}}(pxt=pxt||{}),function(o){{var l=o.blocks||(o.blocks={}),e;let s;(e=s=l.MutatorTypes||(l.MutatorTypes={})).ObjectDestructuringMutator="objectdestructuring",e.RestParameterMutator="restparameter",e.DefaultInstanceMutator="defaultinstance",l.addMutation=function(e,t,i){let o;switch(i){case s.ObjectDestructuringMutator:if(!t.parameters||t.parameters.length<1)console.error("Destructuring mutations require at least one parameter");else{let e=!1;for(const s of t.parameters)if(-1!==s.type.indexOf("=>")){if(!s.properties||0===s.properties.length)return void console.error("Destructuring mutations only supported for functions with an event parameter that has multiple properties");e=!0}if(!e)return void console.error("Destructuring mutations must have an event parameter")}o=new n(e,t);break;case s.RestParameterMutator:o=new a(e,t);break;case s.DefaultInstanceMutator:o=new c(e,t);break;default:return void console.warn("Ignoring unknown mutation type: "+i)}e.mutationToDom=o.mutationToDom.bind(o),e.domToMutation=o.domToMutation.bind(o),e.compose=o.compose.bind(o),e.decompose=o.decompose.bind(o),e.mutation=o},l.mutateToolboxBlock=function(e,t,i){var o=document.createElement("mutation");switch(t){case s.ObjectDestructuringMutator:o.setAttribute(n.propertiesAttributeName,i);break;case s.RestParameterMutator:o.setAttribute(a.countAttributeName,i);break;case s.DefaultInstanceMutator:o.setAttribute(c.attributeName,i);default:return void console.warn("Ignoring unknown mutation type: "+t)}e.appendChild(o)};class r{constructor(e,t){this.info=t,this.block=e,this.topBlockType=this.block.type+"_mutator";t=this.getSubBlockNames(),this.initializeMutatorTopBlock(),this.initializeMutatorSubBlocks(t),e=t.map(e=>e.type);this.block.setMutator(new Blockly.Mutator(e))}compose(e){e=e.getDescendants(!1).map(e=>({type:e.type,name:e.inputList[0].name}));e.shift(),this.updateBlock(e)}decompose(i){var e=i.newBlock(this.topBlockType);e.initSvg();for(const o of e.inputList)if(o.name===r.mutatorStatmentInput){let t=o.connection;this.getVisibleBlockTypes().forEach(e=>{e=i.newBlock(e);e.initSvg(),t.connect(e.previousConnection),t=e.nextConnection});break}return e}compileMutation(e,t){}getDeclaredVariables(){}isDeclaredByMutation(e){return!1}initializeMutatorSubBlock(e,t,i){e.appendDummyInput(t).appendField(t),e.setColour(i),e.setNextStatement(!0),e.setPreviousStatement(!0)}initializeMutatorTopBlock(){const e=this.info.attributes.mutateText,t=this.block.getColour();Blockly.Blocks[this.topBlockType]=Blockly.Blocks[this.topBlockType]||{init:function(){this.appendDummyInput().appendField(e),this.setColour(t),this.appendStatementInput(r.mutatorStatmentInput)}}}initializeMutatorSubBlocks(e){const t=this.block.getColour(),i=this.initializeMutatorSubBlock.bind(this);e.forEach(e=>{Blockly.Blocks[e.type]=Blockly.Blocks[e.type]||{init:function(){i(this,e.name,t)}}})}}r.mutatorStatmentInput="PROPERTIES",r.mutatedVariableInputName="properties";class n extends r{constructor(e,t){super(e,t),this.currentlyVisible=[],this.parameterRenames={},this.prefix=this.info.attributes.mutatePrefix,this.block.appendDummyInput(r.mutatedVariableInputName),this.block.appendStatementInput("HANDLER").setCheck("null")}getMutationType(){return s.ObjectDestructuringMutator}compileMutation(o,e){var t;if(this.info.attributes.mutatePropertyEnum||this.parameters.length)return t=`function ({ ${this.parameters.map(e=>{var t=this.block.getField(e),t=t&&t.getText(),i=l.escapeVarName(e,o);return t!==e?(this.parameterRenames[e]=t,e+": "+l.escapeVarName(t,o)):i}).join(", ")} })`,this.info.attributes.mutatePropertyEnum?l.mkText(` [${this.parameters.map(e=>this.info.attributes.mutatePropertyEnum+"."+e).join(", ")}],`+t):l.mkText(t)}getDeclaredVariables(){const t={};return this.parameters.forEach(e=>{t[this.getVarFieldValue(e)]=this.parameterTypes[e]}),t}isDeclaredByMutation(t){return this.parameters.some(e=>this.getVarFieldValue(e)===t)}mutationToDom(){var e=document.createElement("mutation"),t=this.parameters.map(e=>{var t=this.getVarFieldValue(e);return t!==e&&(this.parameterRenames[e]=o.Util.htmlEscape(t)),o.Util.htmlEscape(e)}).join(",");e.setAttribute(n.propertiesAttributeName,t);for(const o in this.parameterRenames)o===this.parameterRenames[o]&&delete this.parameterRenames[o];return e.setAttribute(n.renameAttributeName,JSON.stringify(this.parameterRenames)),e}domToMutation(e){var t=e.getAttribute(n.propertiesAttributeName);if(t){const i=t.split(","),o=[];if(void 0===this.paramIndex&&(this.paramIndex=this.getParameterIndex()),i.forEach(e=>{const t=e.split(":");this.info.parameters[this.paramIndex].properties.some(e=>e.name===t[0])&&o.push({property:t[0],newName:t[1]})}),this.parameterRenames=void 0,e.hasAttribute(n.renameAttributeName))try{this.parameterRenames=JSON.parse(e.getAttribute(n.renameAttributeName))}catch(e){console.warn("Ignoring invalid rename map in saved block mutation")}this.parameterRenames=this.parameterRenames||{},this.parameters=[],o.forEach(e=>{this.parameters.push(e.property),e.newName&&e.newName!==e.property&&(this.parameterRenames[e.property]=e.newName)}),this.updateVisibleProperties(),o.filter(e=>!!e.newName).forEach(e=>this.setVarFieldValue(e.property,e.newName))}}getVarFieldValue(e){e=this.block.getField(e);return e&&e.getText()}setVarFieldValue(e,t){this.block.getField(e),this.block.getField(e)&&l.setVarFieldValue(this.block,e,t)}updateBlock(e){this.parameters=[],e.forEach(e=>{-1===this.parameters.indexOf(e.name)&&this.parameters.push(e.name)}),this.updateVisibleProperties()}getSubBlockNames(){return this.parameters=[],this.parameterTypes={},void 0===this.paramIndex&&(this.paramIndex=this.getParameterIndex()),this.info.parameters[this.paramIndex].properties.map(e=>(this.parameterTypes[e.name]=e.type,{type:this.propertyId(e.name),name:e.name}))}getVisibleBlockTypes(){return this.currentlyVisible.map(e=>this.propertyId(e))}updateVisibleProperties(){if(!o.Util.listsEqual(this.currentlyVisible,this.parameters)){const i=this.block.inputList.find(e=>e.name===r.mutatedVariableInputName);this.prefix&&0===this.currentlyVisible.length&&i.appendField(this.prefix,n.prefixLabel),this.currentlyVisible.forEach(e=>{var t;-1===this.parameters.indexOf(e)&&((t=this.getVarFieldValue(e))!==e&&(this.parameterRenames[e]=t),i.removeField(e))}),this.parameters.forEach(e=>{var t;-1===this.currentlyVisible.indexOf(e)&&(t=this.parameterRenames[e]||e,i.appendField(new Blockly.FieldVariable(t),e))}),this.prefix&&0===this.parameters.length&&i.removeField(n.prefixLabel),this.currentlyVisible=this.parameters}}propertyId(e){return this.block.type+"_"+e}getParameterIndex(){for(let e=0;e<this.info.parameters.length;e++)if(-1!==this.info.parameters[e].type.indexOf("=>"))return e}}n.propertiesAttributeName="callbackproperties",n.renameAttributeName="renamemap",n.prefixLabel="0prefix_label_";class a extends r{constructor(){super(...arguments),this.count=0}getMutationType(){return s.RestParameterMutator}compileMutation(t,i){const o=[];return this.forEachInput(e=>o.push(l.compileExpression(t,e,i))),l.mkGroup(o)}mutationToDom(){var e=document.createElement("mutation");return e.setAttribute(a.countAttributeName,this.count.toString()),e}domToMutation(e){var t=e.getAttribute(a.countAttributeName);if(t){try{this.count=parseInt(t)}catch(e){return}for(let e=0;e<this.count;e++)this.addNumberField(!1,e)}}updateBlock(e){if(e){var t=Math.abs(this.count-e.length);if(this.count<e.length)for(let e=0;e<t;e++)this.addNumberField(!0,this.count);else if(this.count>e.length)for(let e=0;e<t;e++)this.removeNumberField()}}getSubBlockNames(){return[{name:"Value",type:a.entryTypeName}]}getVisibleBlockTypes(){const e=[];return this.forEachInput(()=>e.push(a.entryTypeName)),e}addNumberField(e,t){t=this.block.appendValueInput(a.valueInputPrefix+t).setCheck("Number");if(e){const e=this.block.workspace.newBlock("math_number");e.initSvg(),e.setShadow(!0),t.connection.connect(e.outputConnection),this.block.workspace.render(),this.count++}}removeNumberField(){0<this.count&&this.block.removeInput(a.valueInputPrefix+(this.count-1)),this.count--}forEachInput(t){for(let e=0;e<this.count;e++)t(this.block.getInputTargetBlock(a.valueInputPrefix+e),e)}}a.countAttributeName="count",a.entryTypeName="entry",a.valueInputPrefix="value_input_";class c extends r{constructor(){super(...arguments),this.showing=!1}getMutationType(){return s.DefaultInstanceMutator}compileMutation(e,t){if(this.showing){var i=this.block.getInputTargetBlock(c.instanceInputName);if(i)return l.compileExpression(e,i,t)}}mutationToDom(){var e=document.createElement("mutation");return e.setAttribute(c.attributeName,this.showing?"true":"false"),e}domToMutation(e){e=e.getAttribute(c.attributeName);e?this.updateShape("true"===e):this.updateShape(!1)}updateBlock(e){this.updateShape(!(!e||!e.length))}getSubBlockNames(){return[{name:"Instance",type:c.instanceSubBlockType}]}getVisibleBlockTypes(){var e=[];return this.showing&&e.push(c.instanceSubBlockType),e}updateShape(e){this.showing!==e&&(e&&!this.block.getInputTargetBlock(c.instanceInputName)?this.block.appendValueInput(c.instanceInputName):this.block.removeInput(c.instanceInputName),this.showing=e)}}c.attributeName="showing",c.instanceInputName="__instance__",c.instanceSubBlockType="instance"}}(pxt=pxt||{}),function(r){{var e=r.blocks||(r.blocks={}),t;let s,o,l;function n(){return s||((o=document.createElement("div")).style.position="absolute",o.style.top="0",o.style.left="0",o.style.width="1px",o.style.height="1px",document.body.appendChild(o),s=Blockly.inject(o,{move:{scrollbars:!1},readOnly:!0,sounds:!1,media:r.webConfig.commitCdnUrl+"blockly/media/",rtl:r.Util.isUserLanguageRtl(),renderer:"pxt"})),r.blocks.clearWithoutEvents(s),s}function a(){s&&s.dispose(),s=void 0}function c(e={emPixels:18,layout:l.Align}){switch(e.splitSvg?l.Align:e.layout||l.Flow){case l.Align:r.blocks.layout.verticalAlign(s,e.emPixels||18);break;case l.Flow:r.blocks.layout.flow(s,{ratio:e.aspectRatio,useViewWidth:e.useViewWidth});break;case l.Clean:s.cleanUp_&&s.cleanUp_()}let t=s.getMetrics();var i=o.querySelectorAll("svg")[0].cloneNode(!0);return r.blocks.layout.cleanUpBlocklySvg(i),r.U.toArray(i.querySelectorAll(".blocklyBlockCanvas,.blocklyBubbleCanvas")).forEach(e=>e.setAttribute("transform",`translate(${-t.contentLeft}, ${-t.contentTop}) scale(1)`)),i.setAttribute("viewBox",`0 0 ${t.contentWidth} `+t.contentHeight),e.emPixels&&(i.style.width=t.contentWidth/e.emPixels+"em",i.style.height=t.contentHeight/e.emPixels+"em"),e.splitSvg?r.blocks.layout.splitSvg(i,s,e.emPixels):i}(t=l=e.BlockLayout||(e.BlockLayout={}))[t.None=0]="None",t[t.Align=1]="Align",t[t.Clean=3]="Clean",t[t.Flow=4]="Flow",e.initRenderingWorkspace=n,e.cleanRenderingWorkspace=a,e.renderWorkspace=c,e.render=function(e,t={emPixels:18,layout:l.Align}){n();try{var i=e||'<xml xmlns="http://www.w3.org/1999/xhtml"></xml>',o=Blockly.Xml.textToDom(i);return r.blocks.domToWorkspaceNoEvents(o,s),c(t)}catch(e){r.reportException(e)}finally{a()}},e.blocksMetrics=function(e){e=e.getTopBlocks(!1);if(!e.length)return{width:0,height:0};let t;return e.forEach(e=>{e=e.getBoundingRectangle();t?(t.l=Math.min(t.l,e.left),t.r=Math.max(t.r,e.right),t.t=Math.min(t.t,e.top),t.b=Math.min(t.b,e.bottom)):t={l:e.left,r:e.right,t:e.top,b:e.bottom}}),{width:t.r-t.l,height:t.b-t.t}}}}(pxt=pxt||{}),function(e){function i(e,t){let i=[];for(const s in e.children){var o=e.children[s];if("block"===o.tagName)if(t){const e=o.getAttribute("type");e&&e===t&&i.push(o)}else i.push(o);else{const e=l(o);e&&(i=i.concat(e))}}return i}function l(e,t){e=i(e,t);return e.length?e[0]:null}(e=e.blocks||(e.blocks={})).findRootBlocks=i,e.findRootBlock=l}(pxt=pxt||{}),function(c){var e;((e=c.docs||(c.docs={})).codeCard||(e.codeCard={})).render=function(e,t={}){const i=e.url?/^[^:]+:\/\//.test(e.url)?e.url:"/"+e.url.replace(/^\.?\/?/,""):e.youTubeId?"https://youtu.be/"+e.youTubeId:void 0,o=!!i,s=(e,t,i="div",o="")=>{i=document.createElement(i);return t&&(i.className=t),e&&e.appendChild(i),o&&i.appendChild(document.createTextNode(o+"")),i};var l=s(null,"ui "+(e.style||"card")+" "+(e.color||"")+(o?" link":""),o?"a":"div");if(l.setAttribute("role","option"),l.setAttribute("aria-selected","true"),o){const c=l;c.href=i,/^https?:\/\//.test(i)&&(c.target="_blank")}!t.hideHeader&&e.header&&(r=s(l,"ui content "+(e.responsive?" tall desktop only":"")),e.header)&&s(r,"description","span",e.header);var r=(t.shortName?e.shortName:"")||e.name,n=s(l,"ui image"+(e.responsive?" tall landscape only":""));if(e.label&&((t=document.createElement("label")).className=`ui ${e.labelClass||"orange right ribbon"} label`,t.textContent=e.label,n.appendChild(t)),e.blocksXml){const t=c.blocks.render(e.blocksXml);t?((a=s(n,"")).setAttribute("style","width:100%; min-height:10em"),a.appendChild(t)):(console.error("failed to render blocks"),c.debug(e.blocksXml))}if(e.typeScript&&((t=document.createElement("pre")).appendChild(document.createTextNode(e.typeScript)),n.appendChild(t)),(e.imageUrl||e.youTubeId&&`https://img.youtube.com/vi/${e.youTubeId}/0.jpg`)&&((a=document.createElement("div")).className="ui imagewrapper",(t=document.createElement("div")).className="ui cardimage",t.style.backgroundImage=`url("${e.imageUrl}")`,t.title=r,t.setAttribute("role","presentation"),a.appendChild(t),n.appendChild(a)),"file"==e.cardType&&(t=s(l,"ui fileimage"),n.appendChild(t)),r||e.description){var a=s(l,"ui content");if(r&&(l.setAttribute("aria-label",r),s(a,"header","div",r)),e.description){const t=s(a,"ui description"),i=e.description.split(".")[0]+".";t.appendChild(document.createTextNode(i))}}return e.time&&(n=s(l,"meta"),e.time)&&s(n,"date","span").appendChild(document.createTextNode(c.Util.timeSince(e.time))),e.extracontent&&s(l,"extra content","div").appendChild(document.createTextNode(e.extracontent)),l}}(pxt=pxt||{}),function(v){{var E=v.blocks||(v.blocks={});function i(e,t){const i=e,o=i.mutationToDom,s=i.domToMutation;i.mutationToDom=()=>{var e=o?o():document.createElement("mutation");return t.mutationToDom(e)},i.domToMutation=e=>{s&&s(e),t.domToMutation(e)}}E.appendMutation=i,E.initVariableArgsBlock=function(s,l){let r=0,n=0,a=s.appendDummyInput(),o=()=>{if(r!==n){if(r>n){var t=r-n;for(let e=0;e<t;e++){var i=l[n+e];a.insertFieldAt(a.fieldRow.length-1,new pxtblockly.FieldArgumentVariable(i.name),"HANDLER_"+i.name);const r=s;null!=r&&r.initSvg&&r.initSvg()}}else{var o=n-r;for(let e=0;e<o;e++){const s=l[n-e-1];a.removeField("HANDLER_"+s.name)}}r>=l.length?a.removeField("_HANDLER_ADD"):n>=l.length&&e(),n=r}};function e(){a.appendField(new Blockly.FieldImage(s.ADD_IMAGE_DATAURI,24,24,lf("Add argument"),()=>{r=Math.min(r+1,l.length),o()},!1),"_HANDLER_ADD")}Blockly.Extensions.apply("inline-svgs",s,!1),e(),i(s,{mutationToDom:t=>{t.setAttribute("numArgs",r.toString());for(let e=0;e<r;e++){const r=s.getField("HANDLER_"+l[e].name);var i=r&&r.getText();t.setAttribute("arg"+e,i)}return t},domToMutation:t=>{var e=parseInt(t.getAttribute("numargs"));r=Math.min(isNaN(e)?0:e,l.length),o();for(let e=0;e<r;e++){const r=t.getAttribute("arg"+e),i="HANDLER_"+l[e].name;s.getField(i)&&E.setVarFieldValue(s,i,r)}}})},E.initExpandableBlock=function(s,l,r,n,e,t){const a="0_add_button",c="0_rem_button",u="_expanded",p="_input_init",d=r.parameters.map(e=>e.name),h=r.parameters.length,m=e?h:1,g=new o(l);function f(e,i=!1,t=!1){e=T(e);if(t||i||e!==g.getNumber(u)){g.setValue(u,e);var o=e;if(g.getBoolean(p)||!(0<o)||(_(),l.rendered)){let t=0;for(let e=0;e<l.inputList.length;e++){const i=l.inputList[e];if(v.Util.startsWith(i.name,E.optionalDummyInputPrefix))x(i,t<o||o===h);else if(v.Util.startsWith(i.name,E.optionalInputWithFieldPrefix)||-1!==d.indexOf(i.name)){const v=t<o;if(x(i,v),v&&i.connection&&!i.connection.isConnected()&&!l.isInsertionMarker()){const v=n.definitionNameToParam[r.parameters[t].name];let e=E.createShadowValue(s,v);"value"===e.tagName.toLowerCase()&&(e=e.firstElementChild),Blockly.Events.disable();try{const v=Blockly.Xml.domToBlock(e,l.workspace);v&&i.connection.connect(v.outputConnection)}catch(e){}Blockly.Events.enable()}++t}}b(),i||l.render()}}}function k(e,t,i,o){l.appendDummyInput(e).appendField(new Blockly.FieldImage(t,24,24,i,()=>f(o),!1))}function b(){var e=g.getNumber(u),t=e!==h,e=0!==e,i=!!l.getInput(c),o=!!l.getInput(a);t||l.removeInput(a,!0),e||l.removeInput(c,!0),e&&!i&&k(c,l.REMOVE_IMAGE_DATAURI,lf("Hide optional arguments"),-1*m),t&&(o&&l.inputList.findIndex(e=>e.name===a)!==l.inputList.length-1?(l.removeInput(a,!0),y()):o||y())}function y(){k(a,l.ADD_IMAGE_DATAURI,lf("Reveal optional arguments"),m)}function _(){g.setValue(p,!0),t(),b()}function T(e){return Math.min(Math.max(g.getNumber(u)+e,0),h)}function x(e,t){l.rendered&&e.setVisible(t).forEach(e=>{e.render()})}g.setEventsEnabled(!1),g.setValue(u,0),g.setValue(p,!1),g.setEventsEnabled(!0),Blockly.Extensions.apply("inline-svgs",l,!1),y(),i(l,{mutationToDom:e=>(e.setAttribute(u,g.getString(u)),e.setAttribute(p,g.getString(p)),e),domToMutation:e=>{if(g.setEventsEnabled(!1),e.hasAttribute(p)&&"true"==e.getAttribute(p)&&!g.getBoolean(p)&&(g.setValue(p,!0),_()),e.hasAttribute(u)){var t=parseInt(e.getAttribute(u));if(!isNaN(t)){const e=t-(g.getNumber(u)||0);g.getBoolean(p)?l.rendered||l.isInsertionMarker()?f(e,!0,l.isInsertionMarker()):g.setValue(u,T(e)):f(e,!0)}}g.setEventsEnabled(!0)}}),setTimeout(()=>{l.rendered&&!l.workspace.isDragging()&&f(0,void 0,!0)},1)},E.initReturnStatement=function(o){const t=v.blocks.getBlockDefinition("function_return"),i="0_add_button",s="0_rem_button";Blockly.Extensions.apply("inline-svgs",o,!1);let l,r=!0;function n(){var e=o.getInput("RETURN_VALUE");if(r){if(!e){for(;o.getInput("");)o.removeInput("");o.jsonInit({message0:t.block.message_with_value,args0:[{type:"input_value",name:"RETURN_VALUE",check:null}],previousStatement:null,colour:v.toolbox.getNamespaceColor("functions")})}if(o.getInput(i)&&o.removeInput(i),o.getInput(s)||u(s,o.REMOVE_IMAGE_DATAURI,lf("Remove return value")),l){const v=o.workspace.getBlockById(l);v&&v.outputConnection&&!v.outputConnection.targetBlock()&&o.getInput("RETURN_VALUE").connection.connect(v.outputConnection),l=void 0}}else{if(e){const i=e.connection.targetBlock();i&&(i.isShadow()&&i.setShadow(!1),e.connection.disconnect(),l=i.id),o.removeInput("RETURN_VALUE"),o.jsonInit({message0:t.block.message_no_value,args0:[],previousStatement:null,colour:v.toolbox.getNamespaceColor("functions")})}o.getInput(s)&&o.removeInput(s),o.getInput(i)||u(i,o.ADD_IMAGE_DATAURI,lf("Add return value"))}o.setInputsInline(!0)}function a(){return Blockly.Xml.domToText(o.mutationToDom())}function c(e,t){e!==t&&Blockly.Events.fire(new Blockly.Events.BlockChange(o,"mutation",null,e,t))}function u(e,t,i){o.appendDummyInput(e).appendField(new Blockly.FieldImage(t,24,24,i,()=>{var e=a(),t=(r=!r,a());c(e,t),n(),c(t,a())},!1))}n(),o.domToMutation=e=>{e.hasAttribute("last_connected_id")&&(l=e.getAttribute("last_connected_id")),r="true"!==e.getAttribute("no_return_value"),n()},o.mutationToDom=()=>{var e,t,i=document.createElement("mutation");return e=i,t=!!o.getInput("RETURN_VALUE"),e.setAttribute("no_return_value",t?"false":"true"),l&&i.setAttribute("last_connected_id",l),i}};class o{constructor(e,t){this.block=e,this.fireEvents=!0,this.state=t||{}}setValue(e,t){if(this.fireEvents&&this.block.mutationToDom){const s=this.block.mutationToDom(),l=(this.state[e]=t.toString(),this.block.mutationToDom());Object.keys(this.state).forEach(e=>{s.getAttribute(e)!==this.state[e]&&l.setAttribute(e,this.state[e])});var i=Blockly.Xml.domToText(s),o=Blockly.Xml.domToText(l);i!=o&&Blockly.Events.fire(new Blockly.Events.BlockChange(this.block,"mutation",null,i,o))}else this.state[e]=t.toString()}getNumber(e){return parseInt(this.state[e])}getBoolean(e){return"false"!=this.state[e]}getString(e){return this.state[e]}setEventsEnabled(e){this.fireEvents=e}}}}(pxt=pxt||{}),function(l){{var r=l.blocks||(l.blocks={});const n=l.blocks.MATH_FUNCTIONS.unary.concat(l.blocks.MATH_FUNCTIONS.binary).concat(l.blocks.MATH_FUNCTIONS.infix);let o;r.initMathOpBlock=function(){const e="math_js_op",t=l.blocks.getBlockDefinition(e);function i(e,t){e=e.appendValueInput("ARG"+(t?1:0));e.setCheck("Number"),t&&(e.connection.setShadowDom((o||((o=document.createElement("shadow")).setAttribute("type","math_number"),(t=document.createElement("field")).setAttribute("name","NUM"),t.textContent="0",o.appendChild(t)),o)),e.connection.respawnShadow_())}function s(e,t){var i=!!e.getInput("ARG1");t?(i&&e.moveInputBefore("op_dropdown","ARG1"),e.moveInputBefore("ARG0","op_dropdown")):(i&&e.moveInputBefore("ARG0","ARG1"),e.moveInputBefore("op_dropdown","ARG0"))}Blockly.Blocks[e]={init:function(){const o=this;o.setPreviousStatement(!1),o.setNextStatement(!1),o.setOutput(!0,"Number"),o.setOutputShape(Blockly.OUTPUT_SHAPE_ROUND),o.setInputsInline(!0),o.appendDummyInput("op_dropdown").appendField(new Blockly.FieldDropdown(n.map(e=>[t.block[e],e]),e=>{return t=o,e=e,-1===l.blocks.MATH_FUNCTIONS.unary.indexOf(e)?t.getInput("ARG1")||i(t,!0):t.removeInput("ARG1",!0),void s(t,-1!==l.blocks.MATH_FUNCTIONS.infix.indexOf(e));var t}),"OP"),i(o,!1),r.appendMutation(o,{mutationToDom:e=>{let t;for(let e=0;e<o.inputList.length;e++){var i=o.inputList[e];if("op_dropdown"===i.name){t=!1;break}if("ARG0"===i.name){t=!0;break}}return e.setAttribute("op-type",(o.getInput("ARG1")?t?"infix":"binary":"unary").toString()),e},domToMutation:e=>{e.hasAttribute("op-type")&&("unary"!=(e=e.getAttribute("op-type"))&&i(o,!0),s(o,"infix"===e))}})}},r.installHelpResources(e,t.name,function(e){return t.tooltip[e.getFieldValue("OP")]},t.url,l.toolbox.getNamespaceColor(t.category))}}}(pxt=pxt||{}),function(i){{var o=i.blocks||(i.blocks={});const s=i.blocks.ROUNDING_FUNCTIONS;o.initMathRoundBlock=function(){const e="math_js_round",t=i.blocks.getBlockDefinition(e);Blockly.Blocks[e]={init:function(){var e=this;e.setPreviousStatement(!1),e.setNextStatement(!1),e.setOutput(!0,"Number"),e.setOutputShape(Blockly.OUTPUT_SHAPE_ROUND),e.setInputsInline(!0),e.appendDummyInput("round_dropdown").appendField(new Blockly.FieldDropdown(s.map(e=>[t.block[e],e]),e=>{}),"OP"),e.appendValueInput("ARG0").setCheck("Number")}},o.installHelpResources(e,t.name,function(e){return t.tooltip[e.getFieldValue("OP")]},t.url,i.toolbox.getNamespaceColor(t.category))}}}(pxt=pxt||{}),function(e){class t extends Blockly.Field{constructor(e,t,i){super(e,i),this.SERIALIZABLE=!0,this.options=t,e&&!this.valueText&&(this.valueText=e)}init(){this.isInitialized()||(this.fieldGroup_=Blockly.utils.dom.createSvgElement("g",{},null),this.visible_||(this.fieldGroup_.style.display="none"),this.onInit(),this.updateEditable(),this.sourceBlock_.getSvgRoot().appendChild(this.fieldGroup_),this.render_(),this.mouseDownWrapper_=Blockly.bindEventWithChecks_(this.getClickTarget_(),"mousedown",this,this.onMouseDown_))}dispose(){this.onDispose()}getValue(){return this.valueText}doValueUpdate_(e){null!==e&&(this.valueText=this.loaded?this.onValueChanged(e):e)}getDisplayText_(){return this.valueText}onLoadedIntoWorkspace(){this.loaded||(this.loaded=!0,this.valueText=this.onValueChanged(this.valueText))}isInitialized(){return!!this.fieldGroup_}getBlockData(){return pxt.blocks.getBlockDataForField(this.sourceBlock_,this.name)}setBlockData(e){pxt.blocks.setBlockDataForField(this.sourceBlock_,this.name,e)}}e.FieldBase=t}(pxtblockly=pxtblockly||{}),function(i){var o=pxt.svgUtil;class e extends i.FieldBase{constructor(e,t,i){super(e,t,i),this.pendingEdit=!1,this.isEmpty=!1,this.assetChangeListener=()=>{var e;this.pendingEdit||((e=this.getBlockData())&&(this.asset=pxt.react.getTilemapProject().lookupAsset(this.getAssetType(),e)),this.redrawPreview())},this.lightMode=t.lightMode,this.params=this.parseFieldOptions(t),this.blocksInfo=t.blocksInfo}onInit(){this.redrawPreview()}onValueChanged(e){return this.parseValueText(e),this.redrawPreview(),this.getValueText()}showEditor_(){if(!this.isGreyBlock){var t=Object.assign({},this.params);let e;switch(t.blocksInfo=this.blocksInfo,this.asset.type){case"tile":case"image":e="image-editor",t.temporaryAssets=i.getTemporaryAssets(this.sourceBlock_.workspace,"image");break;case"animation":e="animation-editor",t.temporaryAssets=i.getTemporaryAssets(this.sourceBlock_.workspace,"image").concat(i.getTemporaryAssets(this.sourceBlock_.workspace,"animation"));break;case"tilemap":e="tilemap-editor";const r=pxt.react.getTilemapProject();pxt.sprite.addMissingTilemapTilesAndReferences(r,this.asset)}const r=pxt.react.getFieldEditorView(e,this.asset,t);this.undoRedoState&&r.restorePersistentData(this.undoRedoState),pxt.react.getTilemapProject().pushUndo(),r.onHide(()=>{var t,i=r.getResult(),o=pxt.react.getTilemapProject();if(i){var s=this.getValue();if(!pxt.assetEquals(this.asset,i)){var l=n(this.asset)?null:this.asset.id;let e=n(i)?null:i.id;l||e!==this.sourceBlock_.id||(i.id=o.generateNewID(i.type),e=i.id),this.pendingEdit=!0,null!=(t=i.meta)&&t.displayName&&this.disposeOfTemporaryAsset(),this.asset=i;i=o.revision();if(this.onEditorClose(this.asset),this.updateAssetListener(),this.updateAssetMeta(),this.redrawPreview(),this.undoRedoState=r.getPersistentData(),this.sourceBlock_&&Blockly.Events.isEnabled()){const t=new a(this.sourceBlock_,"field",this.name,s,this.getValue(),i,o.revision());l!==e&&(t.oldAssetId=l,t.newAssetId=e),Blockly.Events.fire(t)}this.pendingEdit=!1}}}),r.show()}}render_(){this.isGreyBlock&&!this.textElement_&&this.createTextElement_(),super.render_(),this.isGreyBlock||(this.size_.height=42,this.size_.width=50)}getDisplayText_(){var e=pxt.Util.htmlUnescape(this.valueText);return e.substr(0,e.indexOf("("))+"(...)"}updateEditable(){var e;this.isGreyBlock&&this.fieldGroup_?(e=this.fieldGroup_,Blockly.utils.dom.removeClass(e,"blocklyNonEditableText"),Blockly.utils.dom.removeClass(e,"blocklyEditableText"),e.style.cursor=""):super.updateEditable()}getValue(){return this.isGreyBlock?pxt.Util.htmlUnescape(this.valueText):this.getValueText()}onDispose(){var e;null!=(e=this.sourceBlock_)&&e.workspace&&!this.sourceBlock_.workspace.rendered&&this.disposeOfTemporaryAsset(),pxt.react.getTilemapProject().removeChangeListener(this.getAssetType(),this.assetChangeListener)}disposeOfTemporaryAsset(){this.isTemporaryAsset()&&(pxt.react.getTilemapProject().removeAsset(this.asset),this.setBlockData(null),this.asset=void 0)}clearTemporaryAssetData(){this.isTemporaryAsset()&&this.setBlockData(null)}isTemporaryAsset(){return n(this.asset)}getAsset(){return this.asset}updateAsset(e){this.asset=e,this.setValue(this.getValue())}onEditorClose(e){}redrawPreview(){if(this.fieldGroup_)if(pxsim.U.clear(this.fieldGroup_),this.isGreyBlock)this.createTextElement_(),this.render_(),this.updateEditable();else{var t=(new o.Rect).at(5,1).size(40,40).setClass("blocklySpriteField").stroke("#898989",1).corner(4);if(this.fieldGroup_.appendChild(t.el),this.asset){let e;switch(this.asset.type){case"image":case"tile":e=i.bitmapToImageURI(pxt.sprite.Bitmap.fromData(this.asset.bitmap),32,this.lightMode);break;case"animation":e=i.bitmapToImageURI(pxt.sprite.Bitmap.fromData(this.asset.frames[0]),32,this.lightMode);break;case"tilemap":e=i.tilemapToImageURI(this.asset.data,32,this.lightMode)}t=(new o.Image).src(e).at(9,5).size(32,32);this.fieldGroup_.appendChild(t.el)}}}parseValueText(e){var t,i;e=pxt.Util.htmlUnescape(e),this.sourceBlock_&&!this.sourceBlock_.isInFlyout&&(t=pxt.react.getTilemapProject(),i=this.getBlockData(),!(i=t.lookupAsset(this.getAssetType(),i))||e&&this.isEmpty?(this.setBlockData(null),this.asset&&this.sourceBlock_&&this.asset.meta.blockIDs&&(this.asset.meta.blockIDs=this.asset.meta.blockIDs.filter(e=>e!==this.sourceBlock_.id),this.isTemporaryAsset()||t.updateAsset(this.asset)),this.isEmpty=!e,this.asset=this.createNewAsset(e)):this.asset=i,this.updateAssetMeta(),this.updateAssetListener())}parseFieldOptions(e){var t={initWidth:16,initHeight:16,disableResize:!1,lightMode:!1};return e&&(e.disableResize&&(t.disableResize="true"===e.disableResize.toLowerCase()||"1"===e.disableResize),t.initWidth=i(e.initWidth,t.initWidth),t.initHeight=i(e.initHeight,t.initHeight),t.lightMode=e.lightMode),t;function i(e,t){e=parseInt(e);return isNaN(e)?t:e}}updateAssetMeta(){var e;this.asset&&(this.asset.meta||(this.asset.meta={}),this.asset.meta.blockIDs||(this.asset.meta.blockIDs=[]),this.sourceBlock_&&(-1===this.asset.meta.blockIDs.indexOf(this.sourceBlock_.id)&&((e=this.asset.meta.blockIDs).length&&this.isTemporaryAsset()&&e.some(e=>this.sourceBlock_.workspace.getBlockById(e))&&(this.asset=pxt.cloneAsset(this.asset),this.asset.meta.blockIDs=[]),this.asset.meta.blockIDs.push(this.sourceBlock_.id)),this.setBlockData(this.asset.id)),this.isTemporaryAsset()?this.asset.meta.temporaryInfo={blockId:this.sourceBlock_.id,fieldName:this.name}:pxt.react.getTilemapProject().updateAsset(this.asset))}updateAssetListener(){pxt.react.getTilemapProject().removeChangeListener(this.getAssetType(),this.assetChangeListener),this.asset&&!this.isTemporaryAsset()&&pxt.react.getTilemapProject().addChangeListener(this.asset,this.assetChangeListener)}}function n(e){return e&&!e.meta.displayName}i.FieldAssetEditor=e;class a extends Blockly.Events.BlockChange{constructor(e,t,i,o,s,l,r){super(e,t,i,o,s),this.oldRevision=l,this.newRevision=r,this.fieldName=i}isNull(){return this.oldRevision===this.newRevision&&super.isNull()}run(e){if(this.newAssetId||this.oldAssetId){const t=this.getEventWorkspace_().getBlockById(this.blockId);e?pxt.blocks.setBlockDataForField(t,this.fieldName,this.newAssetId):pxt.blocks.setBlockDataForField(t,this.fieldName,this.oldAssetId)}e?pxt.react.getTilemapProject().redo():pxt.react.getTilemapProject().undo(),super.run(e);const t=this.getEventWorkspace_(),i=new a(t.getBlockById(this.blockId),"tilemap-revision","revision",null,pxt.react.getTilemapProject().revision(),0,0);i.recordUndo=!1,Blockly.Events.fire(i)}}i.BlocklyTilemapChange=a}(pxtblockly=pxtblockly||{}),function(t){var i=pxt.svgUtil;class e extends t.FieldAssetEditor{constructor(){super(...arguments),this.onMouseEnter=()=>{if(!this.animateRef&&this.asset){var t=this.getParentInterval()||this.asset.interval;let e=0;this.animateRef=setInterval(()=>{this.preview&&this.frames[e]&&this.preview.src(this.frames[e]),e=(e+1)%this.frames.length},50<t?t:50)}},this.onMouseLeave=()=>{this.animateRef&&clearInterval(this.animateRef),this.animateRef=void 0,this.preview&&this.frames[0]&&this.preview.src(this.frames[0])}}init(){this.fieldGroup_||(super.init(),this.sourceBlock_.getSvgRoot().addEventListener("mouseenter",this.onMouseEnter),this.sourceBlock_.getSvgRoot().addEventListener("mouseleave",this.onMouseLeave))}showEditor_(){this.asset&&(this.asset.interval=this.getParentInterval()||this.asset.interval),super.showEditor_()}render_(){super.render_(),this.size_.height=42,this.size_.width=80}getAssetType(){return"animation"}createNewAsset(e){var t=pxt.react.getTilemapProject();if(e){var i=pxt.lookupProjectAssetByTSReference(e,t);if(i)return i;i=-1===(i=e).indexOf("[")?null:(i=i.replace(/[\[\]]/gm,"")).split(",").map(e=>pxt.sprite.imageLiteralToBitmap(e).data()).filter(e=>e.height&&e.width);if(i&&i.length)return{internalID:-1,id:this.sourceBlock_.id,type:"animation",frames:i,interval:this.getParentInterval(),meta:{}};i=t.lookupAssetByName("animation",e.trim());if(i)return i}return{internalID:-1,id:this.sourceBlock_.id,type:"animation",frames:[new pxt.sprite.Bitmap(this.params.initWidth,this.params.initHeight).data()],interval:500,meta:{}}}onEditorClose(e){this.setParentInterval(e.interval)}getValueText(){return this.asset?this.isTemporaryAsset()?"["+this.asset.frames.map(e=>pxt.sprite.bitmapToImageLiteral(pxt.sprite.Bitmap.fromData(e),"typescript")).join(",")+"]":pxt.getTSReferenceForAsset(this.asset):"[]"}redrawPreview(){var e;this.fieldGroup_&&(pxsim.U.clear(this.fieldGroup_),e=(new i.Rect).at(35,1).size(40,40).corner(4).setClass("blocklyAnimationField"),this.fieldGroup_.appendChild(e.el),e=new i.Text("").at(5,26).fill(this.sourceBlock_.getColourSecondary()).setClass("semanticIcon"),this.fieldGroup_.appendChild(e.el),this.asset)&&(this.frames=this.asset.frames.map(e=>t.bitmapToImageURI(pxt.sprite.Bitmap.fromData(e),32,this.lightMode)),this.preview=(new i.Image).src(this.frames[0]).at(39,5).size(32,32),this.fieldGroup_.appendChild(this.preview.el))}getParentIntervalBlock(){const e=this.sourceBlock_;if(e.parentBlock_){var t=e.parentBlock_;for(const e of t.inputList)if("frameInterval"===e.name)return e.connection.targetBlock()}}setParentInterval(e){var t,i=this.getParentIntervalBlock();i&&(t=o(i))&&i.setFieldValue(String(e),t)}getParentInterval(){var e=this.getParentIntervalBlock();if(e){var t=o(e);if(t)return Number(e.getFieldValue(t))}return 100}parseFieldOptions(e){return i={initWidth:16,initHeight:16,disableResize:!1,lightMode:!1},(e=e)&&(i.lightMode=e.lightMode,e.filter&&(i.filter=e.filter),i.initWidth=t(e.initWidth,i.initWidth),i.initHeight=t(e.initHeight,i.initHeight)),i;function t(e,t){e=parseInt(e);return isNaN(e)?t:e}var i}}function o(e){return"math_number_minmax"===e.type?"SLIDER":"math_number"===(t=e.type)||"math_integer"===t||"math_whole_number"===t?"NUM":"timePicker"===e.type?"ms":null;var t}t.FieldAnimationEditor=e}(pxtblockly=pxtblockly||{}),function(e){class t extends Blockly.FieldVariable{constructor(e){super(e),this.menuGenerator_=this.dropdownCreate}dropdownCreate(){return Blockly.FieldVariable.dropdownCreate.call(this).filter(e=>e[1]!=Blockly.DELETE_VARIABLE_ID)}}e.FieldArgumentVariable=t}(pxtblockly=pxtblockly||{}),function(e){class t extends Blockly.FieldNumber{constructor(e,t,i){super(e,void 0,void 0,void 0,i),this.isFieldCustom_=!0,this.CURSOR="pointer",this.params=t,this.setValue(e),this.addArgType("toggle"),this.type_=t.type}init(){var e,t;this.fieldGroup_||(this.fieldGroup_=Blockly.utils.dom.createSvgElement("g",{},null),this.visible_||(this.fieldGroup_.style.display="none"),null!==this.getArgTypes()&&(this.sourceBlock_.isShadow()?this.sourceBlock_.svgGroup_:this.fieldGroup_).setAttribute("data-argument-type",this.getArgTypes()),e=this.getSize(),this.checkElement_=Blockly.utils.dom.createSvgElement("g",{class:"blocklyToggle "+(this.state_?"blocklyToggleOnBreakpoint":"blocklyToggleOffBreakpoint"),transform:`translate(8, ${e.height/2})`},this.fieldGroup_),this.toggleThumb_=Blockly.utils.dom.createSvgElement("polygon",{class:"blocklyToggleRect",points:"50,5 100,5 125,30 125,80 100,105 50,105 25,80 25,30"},this.checkElement_),t=this.sourceBlock_.RTL?-e.width/2:e.width/2,this.textElement_=Blockly.utils.dom.createSvgElement("text",{class:"blocklyText",x:t,dy:"0.6ex",y:e.height/2},this.fieldGroup_),this.updateEditable(),this.sourceBlock_.getSvgRoot().appendChild(this.fieldGroup_),this.switchToggle(this.state_),this.setValue(this.getValue()),this.render_(),this.size_.width=0,this.mouseDownWrapper_=Blockly.bindEventWithChecks_(this.getClickTarget_(),"mousedown",this,this.onMouseDown_))}updateSize_(){this.size_.width=30}getValue(){return this.toVal(this.state_)}setValue(e){e=this.fromVal(e);this.state_!==e&&(this.sourceBlock_&&Blockly.Events.isEnabled()&&Blockly.Events.fire(new Blockly.Events.BlockChange(this.sourceBlock_,"field",this.name,this.state_,e)),this.state_=e,this.switchToggle(this.state_))}switchToggle(e){this.checkElement_&&(this.updateSize_(),e?(pxt.BrowserUtils.addClass(this.checkElement_,"blocklyToggleOnBreakpoint"),pxt.BrowserUtils.removeClass(this.checkElement_,"blocklyToggleOffBreakpoint")):(pxt.BrowserUtils.removeClass(this.checkElement_,"blocklyToggleOnBreakpoint"),pxt.BrowserUtils.addClass(this.checkElement_,"blocklyToggleOffBreakpoint")),this.checkElement_.setAttribute("transform","translate(-7, -1) scale(0.3)"))}updateDisplay_(e){super.updateDisplay_(e),this.textElement_&&pxt.BrowserUtils.addClass(this.textElement_,"blocklyToggleText")}render_(){this.visible_&&this.textElement_&&(goog.dom.removeChildren(this.textElement_),this.updateSize_())}showEditor_(){var e=!this.state_;null!==e&&this.setValue(this.toVal(e))}toVal(e){return"number"==this.type_?String(e?"1":"0"):String(e?"true":"false")}fromVal(e){return"string"==typeof e?"1"==e||"TRUE"==e.toUpperCase():!!e}}e.FieldBreakpoint=t}(pxtblockly=pxtblockly||{}),function(e){class t extends Blockly.FieldSlider{constructor(e,t,i){super(String(e),"0","255","1","10","Color",i),this.isFieldCustom_=!0,this.params=t,this.params.min&&(this.min_=parseFloat(this.params.min)),this.params.max&&(this.max_=parseFloat(this.params.max)),this.params.label&&(this.labelText_=this.params.label),this.params.channel&&(this.channel_=this.params.channel)}setBackground_(e){var t=this.createColourStops_().join(",");goog.style.setStyle(e,"background","-moz-linear-gradient(left, "+t+")"),goog.style.setStyle(e,"background","-webkit-linear-gradient(left, "+t+")"),goog.style.setStyle(e,"background","-o-linear-gradient(left, "+t+")"),goog.style.setStyle(e,"background","-ms-linear-gradient(left, "+t+")"),goog.style.setStyle(e,"background","linear-gradient(left, "+t+")"),this.params.sliderWidth&&goog.style.setStyle(e,"width",this.params.sliderWidth+"px")}setReadout_(e,t){var t=this.colorWheel(parseInt(t),this.channel_),i=document.createElement("span");i.className="blocklyColorReadout",i.style.backgroundColor=""+t,pxsim.U.clear(e),e.appendChild(i)}createColourStops_(){var t=[];for(let e=0;e<=255;e+=20)t.push(this.colorWheel(e,this.channel_));return t}colorWheel(e,t){return"hsvfast"==t?this.hsvFast(e,255,255):(e=255-e)<85?this.hex(3*e,255,255-3*e):e<170?this.hex(255,255-3*(e-=85),3*e):this.hex(255-3*(e-=170),3*e,255)}hsvFast(e,t,i){let o=e%255>>0;o<0&&(o+=255);let s,l,r,n=i*(255-t)/255>>0,a=i-n,c=(o=192*o/255>>0)/64>>0,u=o%64>>0,p=(u*a/63.75>>0)+n,d=((63-u)*a/63.75>>0)+n;return r=c?1==c?(s=n,l=d,p):(s=p,l=n,d):(s=d,l=p,n),this.hex(s,l,r)}hex(e,t,i){return"#"+this.componentToHex(255&e)+this.componentToHex(255&t)+this.componentToHex(255&i)}componentToHex(e){e=e.toString(16);return 1==e.length?"0"+e:e}}e.FieldColorWheel=t}(pxtblockly=pxtblockly||{}),function(e){class t extends Blockly.FieldColour{constructor(e,t,i){if(super(e,i),this.isFieldCustom_=!0,this.valueMode_="rgb",t.colours)this.setColours(JSON.parse(t.colours));else if(pxt.appTarget.runtime&&pxt.appTarget.runtime.palette){let e,t=pxt.Util.clone(pxt.appTarget.runtime.palette);t[0]="#dedede",pxt.appTarget.runtime.paletteNames&&((e=pxt.Util.clone(pxt.appTarget.runtime.paletteNames))[0]=lf("transparent")),this.setColours(t,e)}this.setValue(this.getColours_()[0]),t.columns&&this.setColumns(parseInt(t.columns)),t.className&&(this.className_=t.className),t.valueMode&&(this.valueMode_=t.valueMode)}applyColour(){var e;this.borderRect_?this.borderRect_.style.fill=this.value_:this.sourceBlock_&&(null!=(e=null==(e=null==(e=this.sourceBlock_)?void 0:e.pathObject)?void 0:e.svgPath)&&e.setAttribute("fill",this.value_),null!=(e=null==(e=null==(e=this.sourceBlock_)?void 0:e.pathObject)?void 0:e.svgPath))&&e.setAttribute("stroke","#fff")}doClassValidation_(e){return"string"!=typeof e?null:i(e,this.getColours_())}getValue(t){if(!t)switch(this.valueMode_){case"hex":return`"${this.value_}"`;case"rgb":return-1<this.value_.indexOf("#")?"0x"+this.value_.replace(/^#/,""):this.value_;case"index":if(!this.value_)return"-1";const t=this.getColours_();for(let e=0;e<t.length;e++)if(this.value_.toUpperCase()===t[e].toUpperCase())return e+""}return this.value_}doValueUpdate_(e){this.value_=i(e,this.getColours_()),this.applyColour()}showEditor_(){super.showEditor_(),this.className_&&this.picker_&&pxt.BrowserUtils.addClass(this.picker_,this.className_)}getColours_(){return this.colours_}}function i(i,e){if(i){var t=/Colors\.([a-zA-Z]+)/.exec(i),o=/(0x|#)([0-9a-fA-F]+)/.exec(i);if(t)switch(t[1].toLocaleLowerCase()){case"red":return"#FF0000";case"orange":return"#FF7F00";case"yellow":return"#FFFF00";case"green":return"#00FF00";case"blue":return"#0000FF";case"indigo":return"#4B0082";case"violet":return"#8A2BE2";case"purple":return"#A033E5";case"pink":return"#FF007F";case"white":return"#FFFFFF";case"black":return"#000000";default:return i}else if(o){const i=o[2];if(3===i.length){let t="#";for(let e=0;e<i.length;e++){var s=i.charAt(e);t+=s+s}return t}if(6===i.length)return"#"+i}if(e)return t=parseInt(i),isNaN(t)||null==e[t]?e[0]:e[t]}return i}e.FieldColorNumber=t}(pxtblockly=pxtblockly||{}),function(s){class p extends Blockly.FieldDropdown{constructor(e,t,i){super(t.data),this.isFieldCustom_=!0,this.buttonClick_=function(e){e=e.target.getAttribute("data-value");null!==e&&(this.setValue(e),this.closeModal_)&&(this.close(),this.closeModal_=!1)},this.buttonClickAndClose_=function(e){this.closeModal_=!0,this.buttonClick_(e)},this.columns_=parseInt(t.columns)||4,this.maxRows_=parseInt(t.maxRows)||0,this.width_=parseInt(t.width)||200,this.backgroundColour_=s.parseColour(t.colour),this.borderColour_=pxt.toolbox.fadeColor(this.backgroundColour_,.4,!1);var o={xOffset:parseInt(t.tooltipsXOffset)||15,yOffset:parseInt(t.tooltipsYOffset)||-10};this.tooltipConfig_=o,this.hasSearchBar_=!!t.hasSearchBar||!1,this.hideRect_=!!t.hideRect||!1}dispose(){super.dispose(),this.disposeTooltip(),this.disposeIntersectionObserver()}createTooltip_(){this.gridTooltip_||(this.gridTooltip_=document.createElement("div"),this.gridTooltip_.className="goog-tooltip blocklyGridPickerTooltip",this.gridTooltip_.style.position="absolute",this.gridTooltip_.style.display="none",this.gridTooltip_.style.visibility="hidden",document.body.appendChild(this.gridTooltip_))}populateTableContainer(t,i,e){pxsim.U.removeChildren(i),0==t.length&&(this.firstItem_=void 0);for(let e=0;e<t.length/this.columns_;e++){var o=this.populateRow(e,t,i);i.appendChild(o)}}populateRow(o,s,l){const r=this.columns_,n=document.createElement("div");n.className="blocklyGridPickerRow";for(let i=r*o;i<Math.min(r*o+r,s.length);i++){let e=s[i][0];const r=s[i][1],c=document.createElement("div");c.className="goog-menuitem goog-option",c.setAttribute("id",":"+i),c.setAttribute("role","menuitem"),c.style.userSelect="none",c.title=e.alt||e,c.setAttribute("data-value",r);var a=document.createElement("div");a.setAttribute("class","goog-menuitem-content"),a.title=e.alt||e,a.setAttribute("data-value",r);const u="object"==typeof e;let t=this.backgroundColour_;if(r==this.getValue()&&(c.setAttribute("aria-selected","true"),pxt.BrowserUtils.addClass(c,"goog-option-selected"),t=this.sourceBlock_.getColourTertiary(),this.selectedItemDom=c,u)&&!this.shouldShowTooltips()&&this.updateSelectedBar_(e,r),c.style.backgroundColor=t,c.style.borderColor=this.borderColour_,u){const s=new Image(e.width,e.height);s.setAttribute("draggable","false"),"IntersectionObserver"in window?(s.src=p.DEFAULT_IMG,s.setAttribute("data-src",e.src),this.observer.observe(s)):s.src=e.src,s.alt=e.alt||"",s.setAttribute("data-value",r),a.appendChild(s)}else a.textContent=e;if(this.shouldShowTooltips()){Blockly.bindEvent_(c,"click",this,this.buttonClickAndClose_);const o=this.sourceBlock_.RTL?-this.tooltipConfig_.xOffset:this.tooltipConfig_.xOffset,p=this.tooltipConfig_.yOffset;Blockly.bindEvent_(c,"mousemove",this,e=>{if(u){this.gridTooltip_.style.top=e.clientY+p+"px",this.gridTooltip_.style.left=e.clientX+o+"px";const l=document.elementFromPoint(e.clientX,e.clientY),t=l.title||l.alt;this.gridTooltip_.textContent=t,this.gridTooltip_.style.visibility=t?"visible":"hidden",this.gridTooltip_.style.display=t?"":"none"}pxt.BrowserUtils.addClass(c,"goog-menuitem-highlight"),l.setAttribute("aria-activedescendant",c.id)}),Blockly.bindEvent_(c,"mouseout",this,e=>{u&&(this.gridTooltip_.style.visibility="hidden",this.gridTooltip_.style.display="none"),pxt.BrowserUtils.removeClass(c,"goog-menuitem-highlight"),l.removeAttribute("aria-activedescendant")})}else u?(this.selectedBar_.style.display="",Blockly.bindEvent_(c,"click",this,t=>{if(this.closeModal_)this.buttonClick_(t);else{const t=l.getElementsByClassName("goog-menuitem-highlight");for(let e=0;e<t.length;e++)pxt.BrowserUtils.removeClass(t[e],"goog-menuitem-highlight");pxt.BrowserUtils.addClass(c,"goog-menuitem-highlight"),this.updateSelectedBar_(e,r)}})):(Blockly.bindEvent_(c,"click",this,this.buttonClickAndClose_),Blockly.bindEvent_(c,"mouseup",this,this.buttonClickAndClose_));c.appendChild(a),n.appendChild(c),0==i&&(this.firstItem_=c)}return n}shouldShowRect_(){return!this.hideRect_&&!this.sourceBlock_.isShadow()}doClassValidation_(e){return e}close(){this.disposeTooltip(),Blockly.WidgetDiv.hideIfOwner(this),Blockly.Events.setGroup(!1)}getFirstItem(){return this.firstItem_}highlightFirstItem(e){var i=e.childNodes;if(i.length&&i[0].childNodes){for(let t=0;t<i.length;++t){var o=i[t].childNodes.length;for(let e=0;e<o;++e){var s=i[t].childNodes[e];pxt.BrowserUtils.removeClass(s,"goog-menuitem-highlight"),pxt.BrowserUtils.removeClass(s,"goog-option-selected")}}i[0].childNodes[0].className+=" goog-menuitem-highlight"}}highlightAndScrollSelected(e,t){this.selectedItemDom&&goog.style.scrollIntoContainerView(this.selectedItemDom,t,!0)}showEditor_(){Blockly.WidgetDiv.show(this,this.sourceBlock_.RTL,()=>{this.onClose_()}),this.setupIntersectionObserver_(),this.createTooltip_();var e=document.createElement("div");this.positionMenu_(e)}positionMenu_(t){var e=Blockly.utils.getViewportBBox(),i=this.getAnchorDimensions_(),{paddingContainer:o,scrollContainer:s}=this.createWidget_(t),o={width:o.offsetWidth,height:o.offsetHeight},l=goog.dom.getViewportSize();this.width_>l.width&&(this.width_=l.width),t.style.width=this.width_+"px";let r=0;if(this.hasSearchBar_&&(r+=50),this.selectedBar_&&(r+=50),this.maxRows_){let e=t.children[0].offsetHeight*(this.maxRows_+.3);l.height<e+r&&(e=l.height-r),o.height>e&&(s.style.overflowY="auto",goog.style.setHeight(s,e),o.height=e)}o.height+=r,this.sourceBlock_.RTL&&Blockly.utils.uiMenu.adjustBBoxesForRTL(e,i,o),Blockly.WidgetDiv.positionWithAnchor(e,i,o,this.sourceBlock_.RTL),this.highlightAndScrollSelected(t,s)}shouldShowTooltips(){return!pxt.BrowserUtils.isMobile()}getAnchorDimensions_(){var e=this.getScaledBBox();return this.sourceBlock_.RTL?e.right+=Blockly.FieldDropdown.CHECKMARK_OVERHANG:e.left-=Blockly.FieldDropdown.CHECKMARK_OVERHANG,e}createWidget_(e){const t=Blockly.WidgetDiv.DIV,i=this.getOptions();e.setAttribute("role","menu"),e.setAttribute("aria-haspopup","true");var o=document.createElement("div"),s=document.createElement("div");if(s.style.border="solid 1px "+this.borderColour_,e.style.backgroundColor=this.backgroundColour_,o.style.backgroundColor=this.backgroundColour_,s.style.backgroundColor=this.backgroundColour_,e.className="blocklyGridPickerMenu",o.className="blocklyGridPickerScroller",s.className="blocklyGridPickerPadder",s.appendChild(o),o.appendChild(e),t.appendChild(s),this.hasSearchBar_){const t=this.createSearchBar_(e,o,i);s.insertBefore(t,s.childNodes[0])}return this.shouldShowTooltips()||(this.selectedBar_=this.createSelectedBar_(),s.appendChild(this.selectedBar_)),this.populateTableContainer(i,e,o),{paddingContainer:s,scrollContainer:o}}createSearchBar_(o,s,l){var e=document.createElement("div"),t=(e.setAttribute("class","ui fluid icon input"),document.createElement("i"));t.setAttribute("class","search icon");const r=document.createElement("input");return r.setAttribute("type","search"),r.setAttribute("id","search-bar"),r.setAttribute("class","blocklyGridPickerSearchBar"),r.setAttribute("placeholder",pxt.Util.lf("Search")),r.addEventListener("click",()=>{r.focus(),r.setSelectionRange(0,r.value.length)}),r.addEventListener("keyup",pxt.Util.debounce(()=>{let e=r.value,i=new RegExp(e,"i"),t=l.filter(e=>{var t=e[0].alt,e=e[1];return t?i.test(t):i.test(e)});this.populateTableContainer.bind(this)(t,o,s),e?this.highlightFirstItem(o):this.highlightAndScrollSelected(o,s),this.gridTooltip_.style.visibility="hidden",this.gridTooltip_.style.display="none"},300,!1)),r.addEventListener("keyup",e=>{if(13==e.which){const e=o.childNodes[0];if(e){const o=e.childNodes[0];o&&(this.closeModal_=!0,o.click())}}}),e.appendChild(r),e.appendChild(t),e}createSelectedBar_(){var e=document.createElement("div"),t=(e.setAttribute("class","blocklyGridPickerSelectedBar"),e.style.display="none",document.createElement("div")),i=document.createElement("div"),i=(i.className="blocklyGridPickerSelectedImage",t.appendChild(i),this.selectedImg_=document.createElement("img"),this.selectedImg_.setAttribute("width","30px"),this.selectedImg_.setAttribute("height","30px"),this.selectedImg_.setAttribute("draggable","false"),this.selectedImg_.style.display="none",this.selectedImg_.src=p.DEFAULT_IMG,i.appendChild(this.selectedImg_),this.selectedBarText_=document.createElement("span"),this.selectedBarText_.className="blocklyGridPickerTooltip",t.appendChild(this.selectedBarText_),document.createElement("div")),o=document.createElement("div"),s=(o.className="ui buttons mini",i.appendChild(o),document.createElement("button")),l=(s.className="ui button icon green",document.createElement("i")),l=(l.className="icon check",s.appendChild(l),Blockly.bindEvent_(s,"click",this,()=>{this.setValue(this.selectedBarValue_),this.close()}),document.createElement("button")),r=(l.className="ui button icon red",document.createElement("i"));return r.className="icon cancel",l.appendChild(r),Blockly.bindEvent_(l,"click",this,()=>{this.close()}),o.appendChild(s),o.appendChild(l),e.appendChild(t),e.appendChild(i),e}updateSelectedBar_(e,t){e.src&&(this.selectedImg_.src=e.src,this.selectedImg_.style.display=""),this.selectedImg_.alt=e.alt||e,this.selectedBarText_.textContent=e.alt||e,this.selectedBarValue_=t}setupIntersectionObserver_(){"IntersectionObserver"in window&&(this.disposeIntersectionObserver(),this.observer=new IntersectionObserver(e=>{e.forEach(e=>{var t;0<e.intersectionRatio&&(this.observer.unobserve(e.target),e=e.target,t=e.getAttribute("data-src"))&&(e.src=t,e.removeAttribute("data-src"))})},{rootMargin:"20px 0px",threshold:.01}))}disposeIntersectionObserver(){this.observer&&(this.observer=null)}disposeTooltip(){this.gridTooltip_&&(pxsim.U.remove(this.gridTooltip_),this.gridTooltip_=null)}onClose_(){this.disposeTooltip()}}p.DEFAULT_IMG="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==",s.FieldGridPicker=p}(pxtblockly=pxtblockly||{}),function(o){class e extends Blockly.FieldDropdown{constructor(e,t,i){super(t.data),this.isFieldCustom_=!0,this.buttonClick_=function(e){e=e.target.getAttribute("data-value");e&&(this.setValue(e),Blockly.DropDownDiv.hide())},this.columns_=parseInt(t.columns),this.maxRows_=parseInt(t.maxRows)||0,this.width_=parseInt(t.width)||300,this.backgroundColour_=o.parseColour(t.colour),this.borderColour_=pxt.toolbox.fadeColor(this.backgroundColour_,.4,!1)}showEditor_(){if(!Blockly.DropDownDiv.hideIfOwner(this)){Blockly.DropDownDiv.hideWithoutAnimation(),Blockly.DropDownDiv.clearContent();let e=Blockly.DropDownDiv.getContentDiv(),o=document.createElement("div");o.setAttribute("role","menu"),o.setAttribute("aria-haspopup","true");var t=this.getOptions();let s=0;for(let i=0;i<t.length;i++){var l=t[i][0],r=t[i][1];if("placeholder"==l.type){var n=document.createElement("span");n.setAttribute("class","blocklyDropDownPlaceholder"),n.style.width=l.width+"px",n.style.height=l.height+"px",o.appendChild(n)}else{n=document.createElement("button");n.setAttribute("id",":"+i),n.setAttribute("role","menuitem"),n.setAttribute("class","blocklyDropDownButton"),n.title=l.alt;let e=l.height,t=(this.columns_?(e=this.width_/this.columns_-8,n.style.width=e+"px",n.style.height=e+"px"):(n.style.width=l.width+"px",n.style.height=l.height+"px"),e>s&&(s=e),this.backgroundColour_);r==this.getValue()&&(t=this.sourceBlock_.getColourTertiary(),n.setAttribute("aria-selected","true")),n.style.backgroundColor=t,n.style.borderColor=this.borderColour_,Blockly.bindEvent_(n,"click",this,this.buttonClick_),Blockly.bindEvent_(n,"mouseover",n,function(){this.setAttribute("class","blocklyDropDownButton blocklyDropDownButtonHover"),o.setAttribute("aria-activedescendant",this.id)}),Blockly.bindEvent_(n,"mouseout",n,function(){this.setAttribute("class","blocklyDropDownButton"),o.removeAttribute("aria-activedescendant")});var a=document.createElement("img");a.src=l.src,n.setAttribute("data-value",r),a.setAttribute("data-value",r),n.appendChild(a),o.appendChild(n)}}o.style.width=this.width_+"px",e.appendChild(o),this.maxRows_&&(e.style.maxHeight=(this.maxRows_+.4)*(s+8)+"px"),pxt.BrowserUtils.isFirefox()&&(e.style.paddingRight="20px"),Blockly.DropDownDiv.setColour(this.backgroundColour_,this.borderColour_),Blockly.DropDownDiv.showPositionedByField(this,this.onHide_.bind(this));var i=this.sourceBlock_;this.savedPrimary_=null==i?void 0:i.getColour(),null!=i&&i.isShadow()?i.setColour(i.getColourTertiary()):this.borderRect_&&this.borderRect_.setAttribute("fill",i.getColourTertiary())}}onHide_(){var e=Blockly.DropDownDiv.getContentDiv(),e=(e.removeAttribute("role"),e.removeAttribute("aria-haspopup"),e.removeAttribute("aria-activedescendant"),e.style.width="",e.style.paddingRight="",e.style.maxHeight="",this.sourceBlock_);null!=e&&e.isShadow()?this.sourceBlock_.setColour(this.savedPrimary_):this.borderRect_&&this.borderRect_.setAttribute("fill",this.savedPrimary_)}}o.FieldImageDropdown=e}(pxtblockly=pxtblockly||{}),function(e){class t extends e.FieldImageDropdown{constructor(e,t,i){super(e,t,i),this.isFieldCustom_=!0,this.shouldSort_=t.sort,this.addLabel_=!!t.addLabel}showEditor_(){if(!Blockly.DropDownDiv.hideIfOwner(this)){let i=this.sourceBlock_,e=(Blockly.DropDownDiv.hideWithoutAnimation(),Blockly.DropDownDiv.clearContent(),Blockly.DropDownDiv.getContentDiv()),o=document.createElement("div");o.setAttribute("role","menu"),o.setAttribute("aria-haspopup","true");var s=this.getOptions();this.shouldSort_&&s.sort();for(let t=0;t<s.length;t++){var l=s[t][0],r=s[t][1];if("placeholder"==l.type){var n=document.createElement("span");n.setAttribute("class","blocklyDropDownPlaceholder"),n.style.width=l.width+"px",n.style.height=l.height+"px",o.appendChild(n)}else{n=document.createElement("button");n.setAttribute("id",":"+t),n.setAttribute("role","menuitem"),n.setAttribute("class","blocklyDropDownButton"),n.title=l.alt,this.columns_?n.style.width=this.width_/this.columns_-8+"px":(n.style.width=l.width+"px",n.style.height=l.height+"px");let e=i.getColour();r==this.getValue()&&(e=i.getColourTertiary(),n.setAttribute("aria-selected","true")),n.style.backgroundColor=e,n.style.borderColor=i.getColourTertiary(),Blockly.bindEvent_(n,"click",this,this.buttonClick_),Blockly.bindEvent_(n,"mouseover",n,function(){this.setAttribute("class","blocklyDropDownButton blocklyDropDownButtonHover"),o.setAttribute("aria-activedescendant",this.id)}),Blockly.bindEvent_(n,"mouseout",n,function(){this.setAttribute("class","blocklyDropDownButton"),o.removeAttribute("aria-activedescendant")});var a=document.createElement("img");if(a.src=l.src,n.setAttribute("data-value",r),a.setAttribute("data-value",r),n.appendChild(a),this.addLabel_){const e=this.createTextNode_(l.alt);e.setAttribute("data-value",r),n.appendChild(e)}o.appendChild(n)}}o.style.width=this.width_+"px",e.appendChild(o),Blockly.DropDownDiv.setColour(i.getColour(),i.getColourTertiary()),Blockly.DropDownDiv.showPositionedByField(this,this.onHideCallback.bind(this)),this.savedPrimary_=null==i?void 0:i.getColour(),null!=i&&i.isShadow()?i.setColour(i.style.colourTertiary):this.borderRect_&&this.borderRect_.setAttribute("fill",i.style.colourTertiary)}}onHideCallback(){var e=this.sourceBlock_;null!=e&&e.isShadow()?e.setColour(this.savedPrimary_):this.borderRect_&&this.borderRect_.setAttribute("fill",this.savedPrimary_)}createTextNode_(e){var t=document.createElement("span");return t.setAttribute("class","blocklyDropdownTextLabel"),t.textContent=e,t}}e.FieldImages=t}(pxtblockly=pxtblockly||{}),function(e){class t extends Blockly.FieldDropdown{constructor(e){var i;super((i=e,function(){const t=[];return this.sourceBlock_&&this.sourceBlock_.workspace?this.sourceBlock_.workspace.getVariablesOfType(o(i.name)).forEach(e=>{t.push([e.name,e.name])}):i.initialMembers.forEach(e=>t.push([e,e])),t.push([lf("Add a new {0}...",i.memberName),"CREATE"]),t})),this.opts=e}initView(){super.initView(),this.initVariables()}onItemSelected_(e,t){"CREATE"===t.getValue()?a(this.sourceBlock_.workspace,this.opts,lf("New {0}:",this.opts.memberName),e=>e&&this.setValue(e)):super.onItemSelected_(e,t)}doClassValidation_(t){var e;return null!=(e=this.opts)&&e.initialMembers&&!this.opts.initialMembers.find(e=>e==t)&&this.getOptions(),super.doClassValidation_(t)}initVariables(){if(this.sourceBlock_&&this.sourceBlock_.workspace){const t=this.sourceBlock_.workspace,i=c(t,this.opts.name);this.opts.initialMembers.forEach(e=>{-1===i.indexOf(e)&&u(t,this.opts,e)}),"CREATE"===this.getValue()&&this.opts.initialMembers.length&&this.setValue(this.opts.initialMembers[0])}}}function a(s,l,r,n){Blockly.prompt(r,null,i=>{if(i){let t=!1;if(pxtc.isIdentifierStart(i.charCodeAt(0),2)){t=!0;for(let e=1;e<i.length;e++)pxtc.isIdentifierPart(i.charCodeAt(e),2)||(t=!1)}if(t)if(pxt.blocks.isReservedWord(i))Blockly.alert(lf("'{0}' is a reserved word and cannot be used.",i),()=>a(s,l,r,n));else{var o=c(s,l.name);for(let e=0;e<o.length;e++)if(o[e]===i)return void Blockly.alert(lf("A {0} named '{1}' already exists.",l.memberName,i),()=>a(s,l,r,n));i===l.createFunctionName&&Blockly.alert(lf("'{0}' is a reserved name.",l.createFunctionName),()=>a(s,l,r,n)),n(u(s,l,i))}else Blockly.alert(lf("Names must start with a letter and can only contain letters, numbers, '$', and '_'."),()=>a(s,l,r,n))}},{placeholder:l.promptHint})}function c(e,t){e=e.getVariablesOfType(o(t));return e&&e.length?e.map(e=>e.name):[]}function u(e,t,i){return Blockly.Variables.getOrCreateVariablePackage(e,null,i,o(t.name)),i}function o(e){return"KIND_"+e}e.FieldKind=t}(pxtblockly=pxtblockly||{});const rowRegex=/^.*[\.#].*$/;!function(e){e[e.None=0]="None",e[e.Number=1]="Number",e[e.Letter=2]="Letter"}(LabelMode=LabelMode||{}),function(e){class r extends Blockly.Field{constructor(e,t,i){super(e,i),this.isFieldCustom_=!0,this.SERIALIZABLE=!0,this.onColor="#FFFFFF",this.scale=1,this.matrixWidth=5,this.matrixHeight=5,this.yAxisLabel=LabelMode.None,this.xAxisLabel=LabelMode.None,this.cellState=[],this.cells=[],this.dontHandleMouseEvent_=e=>{e.stopPropagation(),e.preventDefault()},this.clearLedDragHandler=e=>{const t=this.sourceBlock_.getSvgRoot();pxsim.pointerEvents.down.forEach(e=>t.removeEventListener(e,this.dontHandleMouseEvent_)),t.removeEventListener(pxsim.pointerEvents.move,this.dontHandleMouseEvent_),document.removeEventListener(pxsim.pointerEvents.up,this.clearLedDragHandler),document.removeEventListener(pxsim.pointerEvents.leave,this.clearLedDragHandler),Blockly.Touch.clearTouchIdentifier(),this.elt.removeEventListener(pxsim.pointerEvents.move,this.handleRootMouseMoveListener),e.stopPropagation(),e.preventDefault()},this.toggleRect=(e,t)=>{this.cellState[e][t]=this.currentDragState_,this.updateValue()},this.handleRootMouseMoveListener=e=>{let t,i;i=(e.changedTouches&&1==e.changedTouches.length?(t=e.changedTouches[0].clientX,e.changedTouches[0]):(t=e.clientX,e)).clientY;var o,e=document.elementFromPoint(t,i);e&&(o=e.getAttribute("data-x"),e=e.getAttribute("data-y"),null!=o)&&null!=e&&this.toggleRect(parseInt(o),parseInt(e))},this.params=t,void 0!==this.params.rows&&(e=parseInt(this.params.rows),isNaN(e)||(this.matrixHeight=e)),void 0!==this.params.columns&&(i=parseInt(this.params.columns),isNaN(i)||(this.matrixWidth=i)),void 0!==this.params.onColor&&(this.onColor=this.params.onColor),void 0!==this.params.offColor&&(this.offColor=this.params.offColor),void 0!==this.params.scale?this.scale=Math.max(.6,Math.min(2,Number(this.params.scale))):15<Math.max(this.matrixWidth,this.matrixHeight)?this.scale=.85:10<Math.max(this.matrixWidth,this.matrixHeight)&&(this.scale=.9)}showEditor_(){}initMatrix(){if(!this.sourceBlock_.isInsertionMarker()){this.elt=pxsim.svg.parseString('<svg xmlns="http://www.w3.org/2000/svg" id="field-matrix" />');for(let t=0;t<this.matrixWidth;t++){this.cellState.push([]),this.cells.push([]);for(let e=0;e<this.matrixHeight;e++)this.cellState[t].push(!1)}this.restoreStateFromString();for(let t=0;t<this.matrixWidth;t++)for(let e=0;e<this.matrixHeight;e++)this.createCell(t,e);if(this.updateValue(),this.xAxisLabel!==LabelMode.None){var e=this.scale*this.matrixHeight*(r.CELL_WIDTH+r.CELL_VERTICAL_MARGIN)+2*r.CELL_VERTICAL_MARGIN+r.BOTTOM_MARGIN,t=pxsim.svg.child(this.elt,"g",{transform:`translate(0 ${e})`});for(let e=0;e<this.matrixWidth;e++){var i=this.getYAxisWidth()+this.scale*e*(r.CELL_WIDTH+r.CELL_HORIZONTAL_MARGIN)+r.CELL_WIDTH/2+r.CELL_HORIZONTAL_MARGIN/2;pxsim.svg.child(t,"text",{x:i,class:"blocklyText"}).textContent=this.getLabel(e,this.xAxisLabel)}}if(this.yAxisLabel!==LabelMode.None){var o=pxsim.svg.child(this.elt,"g",{});for(let e=0;e<this.matrixHeight;e++){var s=this.scale*e*(r.CELL_WIDTH+r.CELL_VERTICAL_MARGIN)+r.CELL_WIDTH/2+2*r.CELL_VERTICAL_MARGIN;pxsim.svg.child(o,"text",{x:0,y:s,class:"blocklyText"}).textContent=this.getLabel(e,this.yAxisLabel)}}this.fieldGroup_.replaceChild(this.elt,this.fieldGroup_.firstChild)}}getLabel(e,t){return t!==LabelMode.Letter?(e+1).toString():String.fromCharCode(e+65)}createCell(i,o){const e=this.scale*i*(r.CELL_WIDTH+r.CELL_HORIZONTAL_MARGIN)+r.CELL_HORIZONTAL_MARGIN+this.getYAxisWidth(),t=this.scale*o*(r.CELL_WIDTH+r.CELL_VERTICAL_MARGIN)+r.CELL_VERTICAL_MARGIN,s=pxsim.svg.child(this.elt,"g",{transform:`translate(${e} ${t})`}),l=pxsim.svg.child(s,"rect",{class:"blocklyLed"+(this.cellState[i][o]?"On":"Off"),cursor:"pointer",width:this.scale*r.CELL_WIDTH,height:this.scale*r.CELL_WIDTH,fill:this.getColor(i,o),"data-x":i,"data-y":o,rx:Math.max(2,this.scale*r.CELL_CORNER_RADIUS)});this.cells[i][o]=l,this.sourceBlock_.workspace.isFlyout||pxsim.pointerEvents.down.forEach(e=>l.addEventListener(e,e=>{const t=this.sourceBlock_.getSvgRoot();this.currentDragState_=!this.cellState[i][o],Blockly.hideChaff(),this.sourceBlock_.select(),this.toggleRect(i,o),pxsim.pointerEvents.down.forEach(e=>t.addEventListener(e,this.dontHandleMouseEvent_)),t.addEventListener(pxsim.pointerEvents.move,this.dontHandleMouseEvent_),document.addEventListener(pxsim.pointerEvents.up,this.clearLedDragHandler),document.addEventListener(pxsim.pointerEvents.leave,this.clearLedDragHandler),this.elt.addEventListener(pxsim.pointerEvents.move,this.handleRootMouseMoveListener),e.stopPropagation(),e.preventDefault()},!1))}getColor(e,t){return this.cellState[e][t]?this.onColor:this.offColor||r.DEFAULT_OFF_COLOR}getOpacity(e,t){return this.cellState[e][t]?"1.0":"0.2"}updateCell(e,t){var i=this.cells[e][t];i.setAttribute("fill",this.getColor(e,t)),i.setAttribute("fill-opacity",this.getOpacity(e,t)),i.setAttribute("class","blocklyLed"+(this.cellState[e][t]?"On":"Off"))}setValue(e,t=!0){if(super.setValue(String(e)),this.elt){t&&this.restoreStateFromString();for(let t=0;t<this.matrixWidth;t++)for(let e=0;e<this.matrixHeight;e++)this.updateCell(t,e)}}render_(){this.visible_?(this.elt||this.initMatrix(),this.size_.height=this.scale*Number(this.matrixHeight)*(r.CELL_WIDTH+r.CELL_VERTICAL_MARGIN)+2*r.CELL_VERTICAL_MARGIN+r.BOTTOM_MARGIN+this.getXAxisHeight(),this.size_.width=this.scale*Number(this.matrixWidth)*(r.CELL_WIDTH+r.CELL_HORIZONTAL_MARGIN)+this.getYAxisWidth()):this.size_.width=0}getValue(){e=this.value_;var e,t=(t=(e=(e||"").trim()).charAt(0))===e.charAt(e.length-1)&&-1!==i.indexOf(t)?e.substr(1,e.length-2).trim():e;return`\`
${r.TAB}${t}
${r.TAB}\``}restoreStateFromString(){var o,e=this.value_;if(e){var s=e.split("\n").filter(e=>rowRegex.test(e));for(let i=0;i<s.length&&i<this.matrixHeight;i++){let t=0;var l=s[i];for(let e=0;e<l.length&&t<this.matrixWidth;e++)"."===(o=l[e])||"_"===o||"0"===o?(this.cellState[t][i]=!1,t++):n(l[e])&&(this.cellState[t][i]=!0,t++)}}}updateValue(){let i="";for(let t=0;t<this.matrixHeight;t++){for(let e=0;e<this.matrixWidth;e++)i+=(this.cellState[e][t]?"#":".")+" ";i+="\n"+r.TAB}this.setValue(i,!1)}getYAxisWidth(){return this.yAxisLabel===LabelMode.None?0:r.Y_AXIS_WIDTH}getXAxisHeight(){return this.xAxisLabel===LabelMode.None?0:r.X_AXIS_HEIGHT}}function n(e){return"#"===e||"*"===e||"1"===e}r.CELL_WIDTH=25,r.CELL_HORIZONTAL_MARGIN=7,r.CELL_VERTICAL_MARGIN=5,r.CELL_CORNER_RADIUS=5,r.BOTTOM_MARGIN=9,r.Y_AXIS_WIDTH=9,r.X_AXIS_HEIGHT=10,r.TAB="        ",r.DEFAULT_OFF_COLOR="#000000",e.FieldMatrix=r;const i=["'",'"',"`"]}(pxtblockly=pxtblockly||{}),function(o){var s=pxt.svgUtil;o.HEADER_HEIGHT=50,o.TOTAL_WIDTH=300;class r extends Blockly.Field{constructor(e,t,i){super(e,i),this.isFieldCustom_=!0,this.SERIALIZABLE=!0,this.soundingKeys=0,this.numRow=8,this.numCol=8,this.tempo=120,this.isPlaying=!1,this.timeouts=[],this.params=t,this.createMelodyIfDoesntExist()}init(){super.init(),this.onInit()}showEditor_(){Blockly.DropDownDiv.hideWithoutAnimation(),Blockly.DropDownDiv.clearContent(),Blockly.DropDownDiv.setColour(this.getDropdownBackgroundColour(),this.getDropdownBorderColour());let e=Blockly.DropDownDiv.getContentDiv();pxt.BrowserUtils.addClass(e,"melody-content-div"),pxt.BrowserUtils.addClass(e.parentElement,"melody-editor-dropdown"),this.gallery=new pxtmelody.MelodyGallery,this.renderEditor(e),this.prevString=this.getValue(),Blockly.Events.fire(new Blockly.Events.Ui(this.sourceBlock_,"melody-editor",!1,!0)),Blockly.DropDownDiv.showPositionedByBlock(this,this.sourceBlock_,()=>{this.onEditorClose(),pxt.BrowserUtils.removeClass(e,"melody-content-div"),pxt.BrowserUtils.removeClass(e.parentElement,"melody-editor-dropdown"),Blockly.Events.fire(new Blockly.Events.Ui(this.sourceBlock_,"melody-editor",!0,!1))})}getValue(){return this.stringRep=this.getTypeScriptValue(),this.stringRep}doValueUpdate_(e){null==e||""==e||'""'==e||this.stringRep&&this.stringRep===e||(this.stringRep=e,this.parseTypeScriptValue(e),super.doValueUpdate_(this.getValue()))}getText_(){return this.invalidString?pxt.Util.lf("Invalid Input"):this.getValue()}onInit(){this.render_(),this.createMelodyIfDoesntExist(),this.invalidString||(this.fieldGroup_||(this.fieldGroup_=Blockly.utils.dom.createSvgElement("g",{},null)),this.visible_||(this.fieldGroup_.style.display="none"),this.sourceBlock_.getSvgRoot().appendChild(this.fieldGroup_),this.updateFieldLabel())}render_(){super.render_(),this.invalidString||(this.size_.width=r.MUSIC_ICON_WIDTH+(r.COLOR_BLOCK_WIDTH+r.COLOR_BLOCK_SPACING)*this.numCol),this.sourceBlock_.setColour("#ffffff")}renderEditor(e){var t=this.getDropdownBackgroundColour(),i=this.getDropdownBorderColour();this.topDiv=document.createElement("div"),pxt.BrowserUtils.addClass(this.topDiv,"melody-top-bar-div"),this.root=new s.SVG(this.topDiv).id("melody-editor-header-controls"),this.toggle=new l(this.root,{leftText:lf("Editor"),rightText:lf("Gallery"),baseColor:t}),this.toggle.onStateChange(e=>{e?this.hideGallery():this.showGallery()}),this.toggle.layout(),this.toggle.translate((o.TOTAL_WIDTH-this.toggle.width())/2,0),e.appendChild(this.topDiv),e.appendChild(this.gallery.getElement()),this.editorDiv=document.createElement("div"),pxt.BrowserUtils.addClass(this.editorDiv,"melody-editor-div"),this.editorDiv.style.setProperty("background-color",i),this.gridDiv=this.createGridDisplay(),this.editorDiv.appendChild(this.gridDiv),this.bottomDiv=document.createElement("div"),pxt.BrowserUtils.addClass(this.bottomDiv,"melody-bottom-bar-div"),this.doneButton=document.createElement("button"),pxt.BrowserUtils.addClass(this.doneButton,"melody-confirm-button"),this.doneButton.innerText=lf("Done"),this.doneButton.addEventListener("click",()=>this.onDone()),this.doneButton.style.setProperty("background-color",t),this.playButton=document.createElement("button"),this.playButton.id="melody-play-button",this.playButton.addEventListener("click",()=>this.togglePlay()),this.playIcon=document.createElement("i"),this.playIcon.id="melody-play-icon",pxt.BrowserUtils.addClass(this.playIcon,"play icon"),this.playButton.appendChild(this.playIcon),this.tempoInput=document.createElement("input"),pxt.BrowserUtils.addClass(this.tempoInput,"ui input"),this.tempoInput.type="number",this.tempoInput.title=lf("tempo"),this.tempoInput.id="melody-tempo-input",this.tempoInput.addEventListener("input",()=>this.setTempo(+this.tempoInput.value)),this.syncTempoField(!0),this.bottomDiv.appendChild(this.tempoInput),this.bottomDiv.appendChild(this.playButton),this.bottomDiv.appendChild(this.doneButton),this.editorDiv.appendChild(this.bottomDiv),e.appendChild(this.editorDiv)}onEditorClose(){this.stopMelody(),this.gallery&&this.gallery.stopMelody(),this.clearDomReferences(),this.sourceBlock_&&Blockly.Events.isEnabled()&&this.getValue()!==this.prevString&&Blockly.Events.fire(new Blockly.Events.BlockChange(this.sourceBlock_,"field",this.name,this.prevString,this.getValue())),this.prevString=void 0}onDone(){Blockly.DropDownDiv.hideIfOwner(this),this.onEditorClose()}clearDomReferences(){this.topDiv=null,this.editorDiv=null,this.gridDiv=null,this.bottomDiv=null,this.doneButton=null,this.playButton=null,this.playIcon=null,this.tempoInput=null,this.elt=null,this.cells=null,this.toggle=null,this.root=null,this.gallery.clearDomReferences()}getTypeScriptValue(){return this.invalidString||(this.melody?'"'+this.melody.getStringRepresentation()+'"':"")}parseTypeScriptValue(e){var t=e;try{e=(e=e.slice(1,-1)).trim(),this.createMelodyIfDoesntExist();var i,o=e.split(" ");o.forEach(e=>{if(!this.isValidNote(e))throw new Error(lf("Invalid note '{0}'. Notes can be C D E F G A B C5",e))}),this.melody.resetMelody();for(let e=0;e<o.length;e++)"-"!=o[e]&&(i=pxtmelody.noteToRow(o[e]),this.melody.updateMelody(i,e));this.updateFieldLabel()}catch(e){pxt.log(e),this.invalidString=t}}isValidNote(e){switch(e){case"C":case"D":case"E":case"F":case"G":case"A":case"B":case"C5":case"-":return!0}return!1}getPreviewWidth(){return this.updateSize_(),this.size_.width}getPreviewHeight(){return this.constants_.FIELD_BORDER_RECT_HEIGHT}getDropdownBackgroundColour(){return this.sourceBlock_.parentBlock_?this.sourceBlock_.parentBlock_.getColour():"#3D3D3D"}getDropdownBorderColour(){return this.sourceBlock_.parentBlock_?this.sourceBlock_.parentBlock_.getColourTertiary():"#2A2A2A"}updateFieldLabel(){if(this.fieldGroup_){pxsim.U.clear(this.fieldGroup_);var e=n("").appendClass("melody-editor-field-icon").at(6,15),t=(this.fieldGroup_.appendChild(e.el),this.melody.getStringRepresentation().trim().split(" "));for(let e=0;e<t.length;e++){var i=pxtmelody.getColorClass(pxtmelody.noteToRow(t[e])),o=(new s.Rect).at((r.COLOR_BLOCK_WIDTH+r.COLOR_BLOCK_SPACING)*e+r.COLOR_BLOCK_X,r.COLOR_BLOCK_Y).size(r.COLOR_BLOCK_WIDTH,r.COLOR_BLOCK_HEIGHT).stroke("#898989",1).corners(3,2);pxt.BrowserUtils.addClass(o.el,i),this.fieldGroup_.appendChild(o.el)}}}setTempo(e){(isNaN(e)||e<=0)&&this.tempoInput?this.tempoInput.value=this.tempo+"":this.tempo!=e&&(this.tempo=e,this.melody&&this.melody.setTempo(this.tempo),this.tempoInput&&(this.tempoInput.value=this.tempo+""),this.syncTempoField(!1))}syncTempoField(e){const t=this.sourceBlock_;if(t.parentBlock_){var i=t.parentBlock_;for(const t of i.inputList)if("tempo"===t.name){var o=t.connection.targetBlock();o&&(e?o.getFieldValue("SLIDER")?(this.tempoInput.value=o.getFieldValue("SLIDER"),this.tempo=+this.tempoInput.value):this.tempoInput.value=this.tempo+"":("math_number_minmax"===o.type?o.setFieldValue(this.tempoInput.value,"SLIDER"):o.setFieldValue(this.tempoInput.value,"NUM"),this.tempoInput.focus()));break}}}getDuration(){return 6e4/this.tempo}createMelodyIfDoesntExist(){return!this.melody&&(this.melody=new pxtmelody.MelodyArray,!0)}onNoteSelect(e,t){this.invalidString=null,this.melody.updateMelody(e,t),this.melody.getValue(e,t)&&!this.isPlaying&&this.playNote(e,t),this.updateGrid(),this.updateFieldLabel()}updateGrid(){for(let t=0;t<this.numRow;t++){var i=pxtmelody.getColorClass(t);for(let e=0;e<this.numCol;e++){var o=this.cells[t][e];this.melody.getValue(t,e)?(pxt.BrowserUtils.removeClass(o,"melody-default"),pxt.BrowserUtils.addClass(o,i)):(pxt.BrowserUtils.addClass(o,"melody-default"),pxt.BrowserUtils.removeClass(o,i))}}}playNote(e,t){let i=++this.soundingKeys;this.isPlaying?(this.timeouts.push(setTimeout(()=>{this.playToneCore(e)},t*this.getDuration())),this.timeouts.push(setTimeout(()=>{pxt.AudioContextManager.stop()},(t+1)*this.getDuration()))):(this.playToneCore(e),this.timeouts.push(setTimeout(()=>{this.soundingKeys==i&&pxt.AudioContextManager.stop()},this.getDuration())))}queueToneForColumn(t,e,i){const o=setTimeout(()=>{++this.soundingKeys,pxt.AudioContextManager.stop();for(let e=0;e<this.numRow;e++)this.melody.getValue(e,t)&&this.playToneCore(e);this.highlightColumn(t,!0),this.timeouts=this.timeouts.filter(e=>e!==o)},e),s=setTimeout(()=>{this.timeouts=this.timeouts.filter(e=>e!==s),this.highlightColumn(t,!1)},e+i);this.timeouts.push(o),this.timeouts.push(s)}playToneCore(e){let t=0;switch(e){case 0:t=523;break;case 1:t=494;break;case 2:t=440;break;case 3:t=392;break;case 4:t=349;break;case 5:t=330;break;case 6:t=294;break;case 7:t=262}pxt.AudioContextManager.tone(t)}highlightColumn(t,i){this.cells.map(e=>e[t]).forEach(e=>{i?pxt.BrowserUtils.addClass(e,"playing"):pxt.BrowserUtils.removeClass(e,"playing")})}createGridDisplay(){r.VIEWBOX_WIDTH=(r.CELL_WIDTH+r.CELL_VERTICAL_MARGIN)*this.numCol+r.CELL_VERTICAL_MARGIN,pxt.BrowserUtils.isEdge()&&(r.VIEWBOX_WIDTH+=37),r.VIEWBOX_HEIGHT=(r.CELL_WIDTH+r.CELL_HORIZONTAL_MARGIN)*this.numRow+r.CELL_HORIZONTAL_MARGIN,this.elt=pxsim.svg.parseString(`<svg xmlns="http://www.w3.org/2000/svg" class="melody-grid-div" viewBox="0 0 ${r.VIEWBOX_WIDTH} ${r.VIEWBOX_HEIGHT}"/>`),this.cells=[];for(let e=0;e<this.numRow;e++)this.cells.push([]);for(let t=0;t<this.numRow;t++)for(let e=0;e<this.numCol;e++)this.createCell(t,e);return this.elt}createCell(t,i){const e=t*(r.CELL_WIDTH+r.CELL_HORIZONTAL_MARGIN)+r.CELL_HORIZONTAL_MARGIN,o=i*(r.CELL_WIDTH+r.CELL_VERTICAL_MARGIN)+r.CELL_VERTICAL_MARGIN,s=pxsim.svg.child(this.elt,"g",{transform:`translate(${o} ${e})`}),l=pxsim.svg.child(s,"rect",{cursor:"pointer",width:r.CELL_WIDTH,height:r.CELL_WIDTH,stroke:"white","data-x":t,"data-y":i,rx:r.CELL_CORNER_RADIUS});this.melody.getValue(t,i)?pxt.BrowserUtils.addClass(l,pxtmelody.getColorClass(t)):pxt.BrowserUtils.addClass(l,"melody-default"),this.sourceBlock_.workspace.isFlyout||(pxsim.pointerEvents.down.forEach(e=>l.addEventListener(e,e=>{this.onNoteSelect(t,i),e.stopPropagation(),e.preventDefault()},!1)),this.cells[t][i]=l)}togglePlay(){this.isPlaying?this.stopMelody():(this.isPlaying=!0,this.playMelody()),this.updatePlayButton()}updatePlayButton(){this.isPlaying?(pxt.BrowserUtils.removeClass(this.playIcon,"play icon"),pxt.BrowserUtils.addClass(this.playIcon,"stop icon")):(pxt.BrowserUtils.removeClass(this.playIcon,"stop icon"),pxt.BrowserUtils.addClass(this.playIcon,"play icon"))}playMelody(){if(this.isPlaying){for(let e=0;e<this.numCol;e++)this.queueToneForColumn(e,e*this.getDuration(),this.getDuration());this.timeouts.push(setTimeout(()=>this.playMelody(),this.numCol*this.getDuration()))}else this.stopMelody()}stopMelody(){if(this.isPlaying){for(;this.timeouts.length;)clearTimeout(this.timeouts.shift());pxt.AudioContextManager.stop(),this.isPlaying=!1,this.cells.forEach(e=>e.forEach(e=>pxt.BrowserUtils.removeClass(e,"playing")))}}showGallery(){this.stopMelody(),this.updatePlayButton(),this.gallery.show(e=>{e&&(this.melody.parseNotes(e),this.gallery.hide(),this.toggle.toggle(),this.updateFieldLabel(),this.updateGrid())})}hideGallery(){this.gallery.hide()}}r.CELL_WIDTH=25,r.CELL_HORIZONTAL_MARGIN=7,r.CELL_VERTICAL_MARGIN=5,r.CELL_CORNER_RADIUS=5,r.COLOR_BLOCK_WIDTH=10,r.COLOR_BLOCK_HEIGHT=20,r.COLOR_BLOCK_X=20,r.COLOR_BLOCK_Y=5,r.COLOR_BLOCK_SPACING=2,r.MUSIC_ICON_WIDTH=20,o.FieldCustomMelody=r;class l{constructor(e,t){this.props=((t=t).baseColor||(t.baseColor="#e95153"),t.backgroundColor||(t.backgroundColor="rgba(52,73,94,.2)"),t.borderColor||(t.borderColor="rgba(52,73,94,.4)"),t.selectedTextColor||(t.selectedTextColor=t.baseColor),t.unselectedTextColor||(t.unselectedTextColor="hsla(0,0%,100%,.9)"),t.switchColor||(t.switchColor="#ffffff"),t),this.root=e.group(),this.buildDom(),this.isLeft=!0}buildDom(){this.root.style().content("\n            .toggle-left {\n                transform: translateX(0px);\n                animation: mvleft 0.2s 0s ease;\n            }\n\n            .toggle-right {\n                transform: translateX(100px);\n                animation: mvright 0.2s 0s ease;\n            }\n\n            @keyframes mvright {\n                0% {\n                    transform: translateX(0px);\n                }\n                100% {\n                    transform: translateX(100px);\n                }\n            }\n\n            @keyframes mvleft {\n                0% {\n                    transform: translateX(100px);\n                }\n                100% {\n                    transform: translateX(0px);\n                }\n            }\n            "),this.root.def().create("clipPath","sprite-editor-toggle-border").clipPathUnits(!0).draw("rect").at(0,0).corners(.02,.1).size(1,1),this.root.draw("rect").size(200,40).fill(this.props.baseColor).stroke(this.props.borderColor,4).corners(4,4).clipPath("url(#sprite-editor-toggle-border)"),this.root.draw("rect").at(2,2).size(196,36).fill(this.props.backgroundColor).corners(4,4),this.switch=this.root.draw("rect").at(2,2).size(98,36).fill(this.props.switchColor).corners(4,4),this.leftElement=this.root.group(),this.leftText=n(this.props.leftText).appendClass("sprite-editor-text").fill(this.props.selectedTextColor),this.leftElement.appendChild(this.leftText),this.rightElement=this.root.group(),this.rightText=n(this.props.rightText).appendClass("sprite-editor-text").fill(this.props.unselectedTextColor),this.rightElement.appendChild(this.rightText),this.root.onClick(()=>this.toggle())}toggle(e=!1){this.isLeft?(this.switch.removeClass("toggle-left"),this.switch.appendClass("toggle-right"),this.leftText.fill(this.props.unselectedTextColor),this.rightText.fill(this.props.selectedTextColor)):(this.switch.removeClass("toggle-right"),this.switch.appendClass("toggle-left"),this.leftText.fill(this.props.selectedTextColor),this.rightText.fill(this.props.unselectedTextColor)),this.isLeft=!this.isLeft,!e&&this.changeHandler&&this.changeHandler(this.isLeft)}onStateChange(e){this.changeHandler=e}layout(){this.leftText.moveTo(51,20),this.rightText.moveTo(149,20)}translate(e,t){this.root.translate(e,t)}height(){return 40}width(){return 200}}function n(e){return new s.Text(e).anchor("middle").setAttribute("dominant-baseline","middle").setAttribute("dy",pxt.BrowserUtils.isIE()||pxt.BrowserUtils.isEdge()?"0.3em":"0.1em")}}(pxtblockly=pxtblockly||{}),function(o){let i;var e;(e=i=i||{})[e.C=262]="C",e[e.CSharp=277]="CSharp",e[e.D=294]="D",e[e.Eb=311]="Eb",e[e.E=330]="E",e[e.F=349]="F",e[e.FSharp=370]="FSharp",e[e.G=392]="G",e[e.GSharp=415]="GSharp",e[e.A=440]="A",e[e.Bb=466]="Bb",e[e.B=494]="B",e[e.C3=131]="C3",e[e.CSharp3=139]="CSharp3",e[e.D3=147]="D3",e[e.Eb3=156]="Eb3",e[e.E3=165]="E3",e[e.F3=175]="F3",e[e.FSharp3=185]="FSharp3",e[e.G3=196]="G3",e[e.GSharp3=208]="GSharp3",e[e.A3=220]="A3",e[e.Bb3=233]="Bb3",e[e.B3=247]="B3",e[e.C4=262]="C4",e[e.CSharp4=277]="CSharp4",e[e.D4=294]="D4",e[e.Eb4=311]="Eb4",e[e.E4=330]="E4",e[e.F4=349]="F4",e[e.FSharp4=370]="FSharp4",e[e.G4=392]="G4",e[e.GSharp4=415]="GSharp4",e[e.A4=440]="A4",e[e.Bb4=466]="Bb4",e[e.B4=494]="B4",e[e.C5=523]="C5",e[e.CSharp5=555]="CSharp5",e[e.D5=587]="D5",e[e.Eb5=622]="Eb5",e[e.E5=659]="E5",e[e.F5=698]="F5",e[e.FSharp5=740]="FSharp5",e[e.G5=784]="G5",e[e.GSharp5=831]="GSharp5",e[e.A5=880]="A5",e[e.Bb5=932]="Bb5",e[e.B5=988]="B5",e[e.C6=1047]="C6",e[e.CSharp6=1109]="CSharp6",e[e.D6=1175]="D6",e[e.Eb6=1245]="Eb6",e[e.E6=1319]="E6",e[e.F6=1397]="F6",e[e.FSharp6=1480]="FSharp6",e[e.G6=1568]="G6",e[e.GSharp6=1568]="GSharp6",e[e.A6=1760]="A6",e[e.Bb6=1865]="Bb6",e[e.B6=1976]="B6",e[e.C7=2093]="C7";class c extends Blockly.FieldNumber{constructor(e,t,i){super(null,0,null,null,i),this.isFieldCustom_=!0,this.SERIALIZABLE=!0,this.isTextValid_=!0,this.nKeys_=36,this.minNote_=28,this.maxNote_=63,this.eps=2,this.setSpellcheck(!1),this.prepareNotes(),this.isExpanded=!1,this.currentPage=0,this.totalPlayCount=0,t.editorColour&&(this.primaryColour=o.parseColour(t.editorColour),this.borderColour=Blockly.utils.colour.darken(this.primaryColour,.2));i=parseInt(t.eps),!Number.isNaN(i)&&0<=i&&(this.eps=i),i=parseInt(t.minNote)||this.minNote_,t=parseInt(t.maxNote)||this.maxNote_;28<=i&&t<=75&&i<t&&(this.minNote_=i,this.maxNote_=t,this.nKeys_=this.maxNote_-this.minNote_+1),this.setValue(e)}doClassValidation_(e){var t=/^Note\.(.+)$/.exec(e),t=t&&1<t.length?t[1]:null;return null===(e=i[t]||String(parseFloat(e||"0")))||(t=parseFloat(e||"0"),isNaN(t))||t<0?null:(e=Math.floor(t)!=t,""+t.toFixed(e?2:0))}getValue(){return this.value_+""}doValueUpdate_(e){isNaN(Number(e))||Number(e)<0||(this.sourceBlock_&&Blockly.Events.isEnabled()&&this.value_!=e&&Blockly.Events.fire(new Blockly.Events.Change(this.sourceBlock_,"field",this.name,this.value_,e)),this.value_=e,this.refreshText())}getText(){if(this.isExpanded)return""+this.value_;{var t=+this.value_;for(let e=0;e<this.nKeys_;e++)if(Math.abs(this.getKeyFreq(e)-t)<this.eps)return this.getKeyName(e);let e=t.toString();return isNaN(t)||(e+=" Hz"),e}}refreshText(){this.forceRerender()}onHtmlInputChange_(e){super.onHtmlInputChange_(e),Blockly.DropDownDiv.hideWithoutAnimation(),this.htmlInput_.focus()}onFinishEditing_(e){this.refreshText()}onHide(){this.isExpanded=!1,this.refreshText()}showEditor_(e){this.isExpanded=!0,this.updateColor(),Blockly.DropDownDiv.hideWithoutAnimation(),Blockly.DropDownDiv.clearContent();const i=pxt.BrowserUtils.isMobile()||pxt.BrowserUtils.isIOS(),o=(c.superClass_.showEditor_.call(this,e,i,i),this.refreshText(),Blockly.Events.setGroup(!0),this.piano=[],this.currentSelectedKey=void 0,this.nKeys_-this.nKeys_/c.notesPerOctave*c.blackKeysPerOctave),s=c.notesPerOctave-c.blackKeysPerOctave;let t=c.keyWidth*o,l=c.keyHeight+c.labelHeight;var r=window.innerWidth<t,n=(r&&(t=s*c.keyWidth,l=c.keyHeight+c.labelHeight+c.prevNextHeight),u("blocklyPianoDiv",`width: ${t}px;
                height: ${l}px;`));Blockly.DropDownDiv.getContentDiv().appendChild(n),this.noteLabel=u("blocklyNoteLabel",`top: ${c.keyHeight}px;
                width: ${t}px;
                background-color: ${this.primaryColour};
                border-color: ${this.primaryColour};`),n.appendChild(this.noteLabel),this.noteLabel.textContent="-";let a=0;for(let t=0;t<this.nKeys_;t++){const i=Math.floor(t/c.notesPerOctave);let e=this.getPosition(t);r&&t>=c.notesPerOctave&&(e-=s*i*c.keyWidth);const o=this.getKeyDiv(t,e);this.piano.push(o),n.appendChild(o),Math.abs(this.getKeyFreq(t)-Number(this.getValue()))<this.eps&&(pxt.BrowserUtils.addClass(o,"selected"),this.currentSelectedKey=o,a=i)}r&&(this.setPage(a),n.appendChild(this.getNextPrevDiv(!0,t)),n.appendChild(this.getNextPrevDiv(!1,t))),Blockly.DropDownDiv.setColour(this.primaryColour,this.borderColour),Blockly.DropDownDiv.showPositionedByBlock(this,this.sourceBlock_,()=>this.onHide())}playKey(e,t){const i=++this.totalPlayCount;this.currentSelectedKey!==e&&(this.currentSelectedKey&&pxt.BrowserUtils.removeClass(this.currentSelectedKey,"selected"),pxt.BrowserUtils.addClass(e,"selected"),this.setValue(t)),this.currentSelectedKey=e,this.htmlInput_.value=this.getText(),pxt.AudioContextManager.tone(t),setTimeout(()=>{this.totalPlayCount==i&&pxt.AudioContextManager.stop()},300)}dispose(){Blockly.DropDownDiv.hideIfOwner(this),super.dispose()}updateColor(){var e;this.sourceBlock_.parentBlock_&&(this.sourceBlock_.isShadow()||1===(e=this.sourceBlock_).inputList.length&&1===e.inputList[0].fieldRow.length)?(e=this.sourceBlock_.parentBlock_,this.primaryColour=e.getColour(),this.borderColour=e.getColourTertiary()):(this.primaryColour="#3D3D3D",this.borderColour="#2A2A2A")}setPage(e){const t=this.nKeys_/c.notesPerOctave;e=Math.max(Math.min(e,t-1),0),this.noteLabel.textContent="Octave #"+(e+1);var i=e*c.notesPerOctave;for(let e=0;e<this.piano.length;++e){const t=e>=i&&e<i+c.notesPerOctave;this.piano[e].style.display=t?"block":"none"}this.currentPage=e}getNextPrevDiv(t,e){const i=t?0:e/2,o=u("blocklyNotePrevNext",`top: ${c.keyHeight+c.labelHeight}px;
                left: ${i}px;
                width: ${Math.ceil(e/2)}px;
                ${t?"border-left-color":"border-right-color"}: ${this.primaryColour};
                background-color: ${this.primaryColour};
                border-bottom-color: ${this.primaryColour};`);return pxt.BrowserUtils.pointerEvents.down.forEach(e=>{Blockly.bindEventWithChecks_(o,e,this,()=>this.setPage(t?this.currentPage-1:this.currentPage+1),!0)}),o.textContent=t?"<":">",o}getKeyDiv(t,e){const i=u("blocklyNote "+(this.isWhite(t)?"":"black"),`width: ${this.getKeyWidth(t)}px;
                height: ${this.getKeyHeight(t)}px;
                left: ${e}px;
                border-color: ${this.primaryColour};`);return pxt.BrowserUtils.pointerEvents.down.forEach(e=>{Blockly.bindEventWithChecks_(i,e,this,()=>this.playKey(i,this.getKeyFreq(t)),!0)}),Blockly.bindEventWithChecks_(i,"mouseover",this,()=>this.noteLabel.textContent=this.getKeyName(t),!0),i}isWhite(e){switch(e%12){case 1:case 3:case 6:case 8:case 10:return!1;default:return!0}}getKeyWidth(e){return this.isWhite(e)?c.keyWidth:c.keyWidth/2}getKeyHeight(e){return this.isWhite(e)?c.keyHeight:c.keyHeight/2}getKeyFreq(e){return this.getKeyNoteData(e).freq}getKeyName(e){e=this.getKeyNoteData(e);let t=e.prefixedName;return this.nKeys_<=c.notesPerOctave?t=e.name:28<=this.minNote_&&this.maxNote_<=63&&(t=e.altPrefixedName||t),t}getKeyNoteData(e){return c.Notes[e+this.minNote_]}getPosition(e){var t=(e-Math.floor((e+1)/c.notesPerOctave*c.blackKeysPerOctave))*c.keyWidth;return this.isWhite(e)?t:t-c.keyWidth/4}prepareNotes(){c.Notes||(c.Notes={28:{name:lf("{id:note}C"),prefixedName:lf("Low C"),freq:131},29:{name:lf("C#"),prefixedName:lf("Low C#"),freq:139},30:{name:lf("{id:note}D"),prefixedName:lf("Low D"),freq:147},31:{name:lf("D#"),prefixedName:lf("Low D#"),freq:156},32:{name:lf("{id:note}E"),prefixedName:lf("Low E"),freq:165},33:{name:lf("{id:note}F"),prefixedName:lf("Low F"),freq:175},34:{name:lf("F#"),prefixedName:lf("Low F#"),freq:185},35:{name:lf("{id:note}G"),prefixedName:lf("Low G"),freq:196},36:{name:lf("G#"),prefixedName:lf("Low G#"),freq:208},37:{name:lf("{id:note}A"),prefixedName:lf("Low A"),freq:220},38:{name:lf("A#"),prefixedName:lf("Low A#"),freq:233},39:{name:lf("{id:note}B"),prefixedName:lf("Low B"),freq:247},40:{name:lf("{id:note}C"),prefixedName:lf("Middle C"),freq:262},41:{name:lf("C#"),prefixedName:lf("Middle C#"),freq:277},42:{name:lf("{id:note}D"),prefixedName:lf("Middle D"),freq:294},43:{name:lf("D#"),prefixedName:lf("Middle D#"),freq:311},44:{name:lf("{id:note}E"),prefixedName:lf("Middle E"),freq:330},45:{name:lf("{id:note}F"),prefixedName:lf("Middle F"),freq:349},46:{name:lf("F#"),prefixedName:lf("Middle F#"),freq:370},47:{name:lf("{id:note}G"),prefixedName:lf("Middle G"),freq:392},48:{name:lf("G#"),prefixedName:lf("Middle G#"),freq:415},49:{name:lf("{id:note}A"),prefixedName:lf("Middle A"),freq:440},50:{name:lf("A#"),prefixedName:lf("Middle A#"),freq:466},51:{name:lf("{id:note}B"),prefixedName:lf("Middle B"),freq:494},52:{name:lf("{id:note}C"),prefixedName:lf("Tenor C"),altPrefixedName:lf("High C"),freq:523},53:{name:lf("C#"),prefixedName:lf("Tenor C#"),altPrefixedName:lf("High C#"),freq:554},54:{name:lf("{id:note}D"),prefixedName:lf("Tenor D"),altPrefixedName:lf("High D"),freq:587},55:{name:lf("D#"),prefixedName:lf("Tenor D#"),altPrefixedName:lf("High D#"),freq:622},56:{name:lf("{id:note}E"),prefixedName:lf("Tenor E"),altPrefixedName:lf("High E"),freq:659},57:{name:lf("{id:note}F"),prefixedName:lf("Tenor F"),altPrefixedName:lf("High F"),freq:698},58:{name:lf("F#"),prefixedName:lf("Tenor F#"),altPrefixedName:lf("High F#"),freq:740},59:{name:lf("{id:note}G"),prefixedName:lf("Tenor G"),altPrefixedName:lf("High G"),freq:784},60:{name:lf("G#"),prefixedName:lf("Tenor G#"),altPrefixedName:lf("High G#"),freq:831},61:{name:lf("{id:note}A"),prefixedName:lf("Tenor A"),altPrefixedName:lf("High A"),freq:880},62:{name:lf("A#"),prefixedName:lf("Tenor A#"),altPrefixedName:lf("High A#"),freq:932},63:{name:lf("{id:note}B"),prefixedName:lf("Tenor B"),altPrefixedName:lf("High B"),freq:988},64:{name:lf("{id:note}C"),prefixedName:lf("High C"),freq:1046},65:{name:lf("C#"),prefixedName:lf("High C#"),freq:1109},66:{name:lf("{id:note}D"),prefixedName:lf("High D"),freq:1175},67:{name:lf("D#"),prefixedName:lf("High D#"),freq:1245},68:{name:lf("{id:note}E"),prefixedName:lf("High E"),freq:1319},69:{name:lf("{id:note}F"),prefixedName:lf("High F"),freq:1397},70:{name:lf("F#"),prefixedName:lf("High F#"),freq:1478},71:{name:lf("{id:note}G"),prefixedName:lf("High G"),freq:1568},72:{name:lf("G#"),prefixedName:lf("High G#"),freq:1661},73:{name:lf("{id:note}A"),prefixedName:lf("High A"),freq:1760},74:{name:lf("A#"),prefixedName:lf("High A#"),freq:1865},75:{name:lf("{id:note}B"),prefixedName:lf("High B"),freq:1976}})}}function u(e,t){var i=document.createElement("div");return pxt.BrowserUtils.addClass(i,e),i.setAttribute("style",t.replace(/\s+/g," ")),i}c.keyWidth=22,c.keyHeight=90,c.labelHeight=24,c.prevNextHeight=20,c.notesPerOctave=12,c.blackKeysPerOctave=5,o.FieldNote=c}(pxtblockly=pxtblockly||{}),function(e){class t extends Blockly.FieldNumberDropdown{constructor(e,t,i){super(e,t.data,t.min,t.max,t.precision,i),this.isFieldCustom_=!0}getOptions(){let e;return e=this.menuGenerator_?JSON.parse(this.menuGenerator_).map(e=>"object"==typeof e?e:[String(e),String(e)]):e}}e.FieldNumberDropdown=t}(pxtblockly=pxtblockly||{}),function(e){class t extends Blockly.FieldSlider{constructor(e,t,i){super(e,"0","100","1","100","Value",i),this.isFieldCustom_=!0,this.params=t,this.params.screenHeight||(this.params.screenHeight=120),this.params.screenWidth||(this.params.screenWidth=160),this.params.xInputName||(this.params.xInputName="x"),this.params.yInputName||(this.params.yInputName="y"),this.params.min&&(this.min_=parseInt(this.params.min)),this.params.max&&(this.max_=parseInt(this.params.max))}showEditor_(e){this.getFieldByName(this.params.xInputName)===this&&(this.max_=this.params.screenWidth,this.labelText_=this.params.xInputName),this.getFieldByName(this.params.yInputName)===this&&(this.max_=this.params.screenHeight,this.labelText_=this.params.yInputName),super.showEditor_(e),this.renderScreenPicker()}doValueUpdate_(e){super.doValueUpdate_(e),this.resetCrosshair&&this.resetCrosshair()}renderScreenPicker(){let e=Blockly.DropDownDiv.getContentDiv();this.selectorDiv_=document.createElement("div"),this.selectorDiv_.className="blocklyCanvasOverlayOuter",e.appendChild(this.selectorDiv_);const o=document.createElement("div"),s=(o.className="blocklyCanvasOverlayDiv",this.selectorDiv_.appendChild(o),document.createElement("div")),l=(s.className="cross-x",o.appendChild(s),document.createElement("div")),r=(l.className="cross-y",o.appendChild(l),document.createElement("div")),n=(r.className="label",o.appendChild(r),1.5*this.params.screenWidth),a=1.5*this.params.screenHeight;o.style.height=a+"px",o.style.width=n+"px";var t=e.getElementsByClassName("goog-slider-horizontal")[0];if(t){t.style.width=n+"px";const e=parseFloat(this.getValue());!isNaN(e)&&e>this.getMin()&&(this.setValue(e-1+""),this.setValue(e+""))}const c=(e,t)=>{e=Math.round(Math.max(0,Math.min(n,e))),t=Math.round(Math.max(0,Math.min(a,t))),s.style.top=t+"px",l.style.left=e+"px",e=Math.round(Math.max(0,Math.min(this.params.screenWidth,e/n*this.params.screenWidth))),t=Math.round(Math.max(0,Math.min(this.params.screenHeight,t/a*this.params.screenHeight))),isNaN(e)?r.textContent=this.params.yInputName+"="+t:isNaN(t)?r.textContent=this.params.xInputName+"="+e:r.textContent=`${this.params.xInputName}=${e} ${this.params.yInputName}=`+t;var i=r.getBoundingClientRect();e>this.params.screenWidth/2?r.style.left=e*(n/this.params.screenWidth)-i.width-8+"px":r.style.left=e*(n/this.params.screenWidth)+4+"px",t>this.params.screenHeight/2?r.style.top=t*(a/this.params.screenHeight)-i.height-6+"px":r.style.top=t*(a/this.params.screenHeight)+"px"};this.resetCrosshair=()=>{var{currentX:e,currentY:t}=this.getXY();c(e/this.params.screenWidth*n,t/this.params.screenHeight*a)},this.resetCrosshair(),Blockly.bindEvent_(this.selectorDiv_,"mousemove",this,e=>{var t=o.getBoundingClientRect(),i=e.clientX-t.left,e=e.clientY-t.top;c(i,e)}),Blockly.bindEvent_(this.selectorDiv_,"mouseleave",this,this.resetCrosshair),Blockly.bindEvent_(this.selectorDiv_,"click",this,e=>{var t=o.getBoundingClientRect(),i=e.clientX-t.left,e=e.clientY-t.top,t=Math.round(i/n*this.params.screenWidth),i=Math.round(e/a*this.params.screenHeight);this.close(),this.setXY(t,i)})}resizeHandler(){this.close()}setXY(e,t){var i=this.getFieldByName(this.params.xInputName),i=(i&&"number"==typeof i.getValue()&&i.setValue(String(e)),this.getFieldByName(this.params.yInputName));i&&"number"==typeof i.getValue()&&i.setValue(String(t))}getFieldByName(t){var i=this.sourceBlock_.parentBlock_;if(i)for(let e=0;e<i.inputList.length;e++){var o=i.inputList[e];if(o.name===t)return this.getTargetField(o)}}getXY(){let e,t;var i=this.getFieldByName(this.params.xInputName),i=(i&&(e=i.getValue()),this.getFieldByName(this.params.yInputName));return i&&(t=i.getValue()),{currentX:parseInt(e),currentY:parseInt(t)}}getTargetField(e){var e=e.connection.targetBlock();return(e=e&&e.inputList[0])?e.fieldRow[0]:null}widgetDispose_(){Blockly.FieldNumber.superClass_.widgetDispose_.call(this),this.close(!0)}close(e){e||(Blockly.WidgetDiv.hideIfOwner(this),Blockly.DropDownDiv.hideIfOwner(this)),window.removeEventListener("resize",this.resizeHandler),this.resetCrosshair=void 0,this.selectorDiv_&&(goog.dom.removeNode(this.selectorDiv_),this.selectorDiv_=void 0)}}e.FieldPosition=t}(pxtblockly=pxtblockly||{}),function(e){class t extends Blockly.FieldDropdown{constructor(e,t){super([["Temp","Temp"]],t),this.setValue(e||"")}getOptions(){return this.dropdownCreate()}init(){this.fieldGroup_||super.init.call(this)}setSourceBlock(e){goog.asserts.assert(!e.isShadow(),"Procedure fields are not allowed to exist on shadow blocks."),super.setSourceBlock.call(this,e)}dropdownCreate(){var t=[];if(this.sourceBlock_&&this.sourceBlock_.workspace){var i,o=this.sourceBlock_.workspace.getAllBlocks();for(let e=0;e<o.length;e++)o[e].getProcedureDef&&(i=o[e].getProcedureDef(),t.push(i[0]))}var e=this.getValue(),s=(e&&-1==t.indexOf(e)&&t.push(e),t.sort(goog.string.caseInsensitiveCompare),t.length||t.push("Temp"),[]);for(let e=0;e<t.length;e++)s[e]=[t[e],t[e]];return s}onItemSelected(e,t){let i=t.getValue();null!==(i=this.sourceBlock_?this.callValidator(i):i)&&this.setValue(i)}}e.FieldProcedure=t}(pxtblockly=pxtblockly||{}),function(e){class t extends Blockly.FieldSlider{constructor(e,t,i){super(String(e),"0","180","1","15",lf("Angle"),i),this.isFieldCustom_=!0,this.params=t}createLabelDom_(e){var t=document.createElement("div"),i=(this.circleSVG=document.createElementNS("http://www.w3.org/2000/svg","svg"),pxsim.svg.hydrate(this.circleSVG,{viewBox:"0 0 200 100",width:"170"}),t.appendChild(this.circleSVG),pxsim.svg.child(this.circleSVG,"circle",{"stroke-dasharray":"565.48","stroke-dashoffset":"0",cx:100,cy:100,r:"90",style:"fill:transparent; transition: stroke-dashoffset 0.1s linear;",stroke:"#a8aaa8","stroke-width":"1rem"}),this.circleBar=pxsim.svg.child(this.circleSVG,"circle",{"stroke-dasharray":"565.48","stroke-dashoffset":"0",cx:100,cy:100,r:"90",style:"fill:transparent; transition: stroke-dashoffset 0.1s linear;",stroke:"#f12a21","stroke-width":"1rem"}),this.reporter=pxsim.svg.child(this.circleSVG,"text",{x:100,y:80,"text-anchor":"middle","dominant-baseline":"middle",style:"font-size: 50px",class:"sim-text inverted number"}),document.createElement("span"));return i.setAttribute("class","blocklyFieldSliderReadout"),[t,i]}setReadout_(e,t){this.updateAngle(parseFloat(t)),this.reporter.textContent=t+""}updateAngle(e){e=(180-(e=Math.max(0,Math.min(180,e))))/180*Math.PI*90;this.circleBar.setAttribute("stroke-dashoffset",""+e)}}e.FieldProtractor=t}(pxtblockly=pxtblockly||{}),function(e){class t extends Blockly.FieldSlider{constructor(e,t,i){super(String(e),"-100","100","1","10","Speed",i),this.isFieldCustom_=!0,this.params=t,this.params.min&&(this.min_=parseFloat(this.params.min)),this.params.max&&(this.max_=parseFloat(this.params.max)),this.params.label&&(this.labelText_=this.params.label),this.params.format||(this.params.format="{0}%")}createLabelDom_(e){var t=document.createElement("div"),i=(this.speedSVG=document.createElementNS("http://www.w3.org/2000/svg","svg"),pxsim.svg.hydrate(this.speedSVG,{viewBox:"0 0 200 100",width:"170"}),t.appendChild(this.speedSVG),pxsim.svg.child(this.speedSVG,"circle",{"stroke-dasharray":"565.48","stroke-dashoffset":"0",cx:100,cy:100,r:"90",style:"fill:transparent; transition: stroke-dashoffset 0.1s linear;",stroke:"#a8aaa8","stroke-width":"1rem"}),this.circleBar=pxsim.svg.child(this.speedSVG,"circle",{"stroke-dasharray":"565.48","stroke-dashoffset":"0",cx:100,cy:100,r:"90",style:"fill:transparent; transition: stroke-dashoffset 0.1s linear;",stroke:"#f12a21","stroke-width":"1rem"}),this.reporter=pxsim.svg.child(this.speedSVG,"text",{x:100,y:80,"text-anchor":"middle","dominant-baseline":"middle",style:`font-size: ${Math.max(14,50-5*(this.params.format.length-4))}px`,class:"sim-text inverted number"}),document.createElement("span"));return i.setAttribute("class","blocklyFieldSliderReadout"),[t,i]}setReadout_(e,t){this.updateSpeed(parseFloat(t)),this.reporter.textContent=ts.pxtc.U.rlf(this.params.format,t)}updateSpeed(e){var t=this.sign(e),t=(e=Math.abs(e)/100*50+50,(100-(e=-1==t?50-e:e))/100*(180*Math.PI));this.circleBar.setAttribute("stroke-dashoffset",""+t)}sign(e){return e?e<0?-1:1:0}}e.FieldSpeed=t}(pxtblockly=pxtblockly||{}),function(e){class t extends e.FieldAssetEditor{getAssetType(){return"image"}createNewAsset(e){var t=pxt.react.getTilemapProject();if(e){const i=pxt.lookupProjectAssetByTSReference(e,t);if(i)return i}if(this.getBlockData())return t.lookupAsset("image",this.getBlockData());const i=e?pxt.sprite.imageLiteralToBitmap(e):new pxt.sprite.Bitmap(this.params.initWidth,this.params.initHeight);if(i)return t=i.data(),{internalID:-1,id:this.sourceBlock_.id,type:"image",jresData:pxt.sprite.base64EncodeBitmap(t),meta:{},bitmap:t};this.isGreyBlock=!0,this.valueText=e}getValueText(){return this.asset&&!this.isTemporaryAsset()?pxt.getTSReferenceForAsset(this.asset):pxt.sprite.bitmapToImageLiteral(this.asset&&pxt.sprite.Bitmap.fromData(this.asset.bitmap),"typescript")}parseFieldOptions(e){{const o={initColor:1,initWidth:16,initHeight:16,disableResize:!1,lightMode:!1};if(e){if(o.lightMode=e.lightMode,e.sizes){const t=e.sizes.split(";"),s=[];for(let e=0;e<t.length;e++){const o=t[e].split(",");if(2===o.length){let e=parseInt(o[0]),t=parseInt(o[1]);var i;isNaN(e)||isNaN(t)||(i=pxt.appTarget.runtime&&pxt.appTarget.runtime.screenSize,e<0&&i&&(e=i.width),t<0&&i&&(t=i.height),s.push([e,t]))}}0<s.length&&(o.initWidth=s[0][0],o.initHeight=s[0][1])}e.filter&&(o.filter=e.filter),e.disableResize&&(o.disableResize="true"===e.disableResize.toLowerCase()||"1"===e.disableResize),o.initColor=t(e.initColor,o.initColor),o.initWidth=t(e.initWidth,o.initWidth),o.initHeight=t(e.initHeight,o.initHeight)}return o;function t(e,t){e=parseInt(e);return isNaN(e)?t:e}}}}e.FieldSpriteEditor=t}(pxtblockly=pxtblockly||{}),function(e){class t extends Blockly.FieldLabel{constructor(e,t,i){super(e,function(){if(t){if(t.bold&&t.italics)return"blocklyBoldItalicizedText";if(t.bold)return"blocklyBoldText";if(t.italics)return"blocklyItalicizedText"}}()),this.isFieldCustom_=!0}}e.FieldStyledLabel=t}(pxtblockly=pxtblockly||{}),function(e){class t extends Blockly.FieldTextDropdown{constructor(e,t,i){super(e,t.values,i),this.isFieldCustom_=!0}}e.FieldTextDropdown=t}(pxtblockly=pxtblockly||{}),function(e){class t extends Blockly.FieldTextInput{constructor(e,t,i){super(e,i),this.isFieldCustom_=!0}}e.FieldTextInput=t}(pxtblockly=pxtblockly||{}),function(e){class t extends e.FieldAssetEditor{getInitText(){return this.initText}getTileset(){var e;return null==(e=this.asset)?void 0:e.data.tileset}getAssetType(){return"tilemap"}createNewAsset(e=""){e=e&&e.replace(/&#96;/g,"`");const t=pxt.react.getTilemapProject(),i=pxt.lookupProjectAssetByTSReference(e,t);if(i)return i;var o=pxt.sprite.decodeTilemap(e,"typescript",t)||t.blankTilemap(this.params.tileWidth,this.params.initWidth,this.params.initHeight);let s;if(o&&o.tilemap&&o.tilemap.width&&o.tilemap.height&&o.layers&&o.layers.width===o.tilemap.width&&o.layers.height===o.tilemap.height&&o.tileset){this.initText=e,this.isGreyBlock=!1;const[i]=t.createNewTilemapFromData(o);s=t.getTilemap(i)}else e.trim()&&(this.isGreyBlock=!0,this.valueText=e);return s}onEditorClose(e){pxt.sprite.updateTilemapReferencesFromResult(pxt.react.getTilemapProject(),e)}getValueText(){return this.isGreyBlock?pxt.Util.htmlUnescape(this.valueText):this.asset?pxt.getTSReferenceForAsset(this.asset):this.getInitText()}parseFieldOptions(e){var t={initWidth:16,initHeight:16,disableResize:!1,tileWidth:16,lightMode:!1};if(e){if(t.lightMode=e.lightMode,e.filter&&(t.filter=e.filter),e.tileWidth)if("number"==typeof e.tileWidth)switch(e.tileWidth){case 8:t.tileWidth=8;break;case 16:t.tileWidth=16;break;case 32:t.tileWidth=32}else switch(e.tileWidth.trim().toLowerCase()){case"8":case"eight":t.tileWidth=8;break;case"16":case"sixteen":t.tileWidth=16;break;case"32":case"thirtytwo":t.tileWidth=32}t.initWidth=i(e.initWidth,t.initWidth),t.initHeight=i(e.initHeight,t.initHeight)}return t;function i(e,t){e=parseInt(e);return isNaN(e)?t:e}}}e.FieldTilemap=t}(pxtblockly=pxtblockly||{}),function(l){class r extends l.FieldImages{constructor(e,t,i){super(e,t,i),this.isFieldCustom_=!0,this.menuGenerator_=()=>{var e;return null!=(e=this.sourceBlock_)&&e.workspace&&l.needsTilemapUpgrade(null==(e=this.sourceBlock_)?void 0:e.workspace)?[o()]:r.getReferencedTiles(this.sourceBlock_.workspace)},this.assetChangeListener=()=>{this.doValueUpdate_(this.getValue()),this.forceRerender()},this.blocksInfo=t.blocksInfo}static getReferencedTiles(e){var t=pxt.react.getTilemapProject();if(t.revision()!==r.cachedRevision||e.id!=r.cachedWorkspaceId){r.cachedRevision=t.revision(),r.cachedWorkspaceId=e.id;var o=l.getAllReferencedTiles(e);for(const l of[16,8,32]){const s=t.getProjectTiles(l,16===l);if(s)for(const l of s.tiles)o.find(e=>e.id===l.id)||o.push(l)}let i={};o.sort((e,t)=>e.id===t.id?0:e.bitmap.width!==t.bitmap.width?e.bitmap.width-t.bitmap.width:e.isProjectTile!==t.isProjectTile?e.isProjectTile?-1:1:(i[e.id]||(i[e.id]=a(e.id)))-(i[t.id]||(i[t.id]=a(t.id))));r.referencedTiles=o.map(e=>{return[{src:a((t=e).id)<=2?n(t.bitmap.width):l.bitmapToImageURI(pxt.sprite.Bitmap.fromData(t.bitmap),32,!1),width:32,height:32,alt:c(e)},e.id,e];var t})}return r.referencedTiles}init(){super.init(),this.sourceBlock_&&this.sourceBlock_.isInFlyout&&this.setValue(this.getOptions()[0][1])}getValue(){var e;return this.selectedOption_?(e=this.selectedOption_[2],e=pxt.react.getTilemapProject().lookupAsset(e.type,e.id),pxt.getTSReferenceForAsset(e)):"string"==typeof(e=super.getValue())&&-1===e.indexOf(".")&&-1===e.indexOf("`")?`img\`${e}\``:e}getText(){var e=this.getValue();return"string"==typeof e&&-1!==e.indexOf("`")?e:super.getText()}render_(){var e;this.value_&&this.selectedOption_&&this.selectedOption_[1]!==this.value_&&(e=pxt.react.getTilemapProject().resolveTile(this.value_),r.cachedRevision=-1,e)&&(this.selectedOption_=[{src:l.bitmapToImageURI(pxt.sprite.Bitmap.fromData(e.bitmap),32,!1),width:32,height:32,alt:c(e)},this.value_,e]),super.render_()}doValueUpdate_(e){super.doValueUpdate_(e);var t=this.getOptions(!0);if(e){var i=pxt.parseAssetTSReference(e);e=(e=i?i.name:e).trim();for(const o of t)if(e===o[2].id||e===o[2].meta.displayName||e===pxt.getShortIDForAsset(o[2]))return this.selectedOption_=o,this.value_=this.getValue(),void this.updateAssetListener();this.selectedOption_=null,this.updateAssetListener()}}getOptions(e){return"function"!=typeof this.menuGenerator_?(this.transparent=o(),[this.transparent]):this.menuGenerator_.call(this)}dispose(){super.dispose(),pxt.react.getTilemapProject().removeChangeListener("tile",this.assetChangeListener)}updateAssetListener(){var e=pxt.react.getTilemapProject();e.removeChangeListener("tile",this.assetChangeListener),this.selectedOption_&&e.addChangeListener(this.selectedOption_[2],this.assetChangeListener)}}function o(){var e=pxt.react.getTilemapProject().getTransparency(16);return[{src:n(16),width:32,height:32,alt:pxt.U.lf("transparency")},e.id,e]}function n(i){var e=document.createElement("canvas"),o=e.getContext("2d");e.width=i,e.height=i,o.fillStyle="#aeaeae",o.fillRect(0,0,i,i),o.fillStyle="#dedede";for(let t=0;t<i;t+=4)for(let e=0;e<i;e+=4)t+e>>2&1&&o.fillRect(t,e,4,4);return e.toDataURL()}function a(e){switch(e){case"myTiles.transparency16":return 1;case"myTiles.transparency8":case"myTiles.transparency32":return 2;default:if(e.startsWith("myTiles.tile")){var t=parseInt(e.slice(12));if(!Number.isNaN(t))return t+2}return 9999999999}}function c(e){return e.meta.displayName||pxt.getShortIDForAsset(e)}l.FieldTileset=r}(pxtblockly=pxtblockly||{}),function(e){class t extends Blockly.FieldNumber{constructor(e,t,i){super(e,void 0,void 0,void 0,i),this.isFieldCustom_=!0,this.CURSOR="pointer",this.params=t,this.setValue(e),this.addArgType("toggle"),this.type_=t.type}init(){if(!this.fieldGroup_){this.fieldGroup_=Blockly.utils.dom.createSvgElement("g",{},null),this.visible_||(this.fieldGroup_.style.display="none"),null!==this.getArgTypes()&&(this.sourceBlock_.isShadow()?this.sourceBlock_.svgGroup_:this.fieldGroup_).setAttribute("data-argument-type",this.getArgTypes()),!this.sourceBlock_.isShadow()&&this.sourceBlock_.inputList&&1<this.sourceBlock_.inputList.length&&(this.borderRect_=Blockly.utils.dom.createSvgElement("rect",{rx:Blockly.BlockSvg.CORNER_RADIUS,ry:Blockly.BlockSvg.CORNER_RADIUS,x:0,y:0,width:this.size_.width,height:this.size_.height,fill:this.sourceBlock_.getColour(),stroke:this.sourceBlock_.getColourTertiary()},null),this.fieldGroup_.insertBefore(this.borderRect_,this.textElement_));var e=this.getSize();switch(this.checkElement_=Blockly.utils.dom.createSvgElement("g",{class:"blocklyToggle "+(this.state_?"blocklyToggleOn":"blocklyToggleOff"),transform:`translate(8, ${e.height/2})`},this.fieldGroup_),this.getOutputShape()){case Blockly.OUTPUT_SHAPE_HEXAGONAL:this.toggleThumb_=Blockly.utils.dom.createSvgElement("polygon",{class:"blocklyToggleRect",points:"-7,-14 -21,0 -7,14 7,14 21,0 7,-14",cursor:"pointer"},this.checkElement_);break;case Blockly.OUTPUT_SHAPE_ROUND:this.toggleThumb_=Blockly.utils.dom.createSvgElement("rect",{class:"blocklyToggleCircle",x:-6,y:-14,height:28,width:28,rx:14,ry:14,cursor:"pointer"},this.checkElement_);break;case Blockly.OUTPUT_SHAPE_SQUARE:this.toggleThumb_=Blockly.utils.dom.createSvgElement("rect",{class:"blocklyToggleRect",x:-6,y:-14,height:28,width:28,rx:3,ry:3,cursor:"pointer"},this.checkElement_)}var t=this.sourceBlock_.RTL?-e.width/2:e.width/2,t=(this.textElement_=Blockly.utils.dom.createSvgElement("text",{class:"blocklyText",x:t,dy:"0.6ex",y:e.height/2},this.fieldGroup_),this.updateEditable(),this.sourceBlock_.getSvgRoot());t.appendChild(this.fieldGroup_),t.querySelector(".blocklyBlockBackground").setAttribute("fill",this.sourceBlock_.getColourTertiary()),this.switchToggle(this.state_),this.setValue(this.getValue()),this.render_(),this.size_.width=0,this.mouseDownWrapper_=Blockly.bindEventWithChecks_(this.getClickTarget_(),"mousedown",this,this.onMouseDown_)}}getDisplayText_(){return this.state_?this.getTrueText():this.getFalseText()}getTrueText(){return lf("True")}getFalseText(){return lf("False")}updateSize_(){switch(this.getOutputShape()){case Blockly.OUTPUT_SHAPE_ROUND:this.size_.width=2*this.getInnerWidth()-7;break;case Blockly.OUTPUT_SHAPE_HEXAGONAL:this.size_.width=2*this.getInnerWidth()+8-Math.floor(this.getInnerWidth()/2);break;case Blockly.OUTPUT_SHAPE_SQUARE:this.size_.width=9+2*this.getInnerWidth()}}getInnerWidth(){return 10*this.getMaxLength()}getMaxLength(){return Math.max(this.getTrueText().length,this.getFalseText().length)}getOutputShape(){return this.sourceBlock_.isShadow()?this.sourceBlock_.getOutputShape():Blockly.OUTPUT_SHAPE_SQUARE}doClassValidation_(e){return"boolean"==typeof this.fromVal(e)?e:"false"}applyColour(){var e=this.sourceBlock_.getColourTertiary();this.borderRect_?this.borderRect_.setAttribute("stroke",e):this.sourceBlock_.pathObject.svgPath.setAttribute("fill",e)}getValue(){return this.toVal(this.state_)}doValueUpdate_(e){e=this.fromVal(e);this.state_!==e&&(this.sourceBlock_&&Blockly.Events.isEnabled()&&Blockly.Events.fire(new Blockly.Events.BlockChange(this.sourceBlock_,"field",this.name,this.state_,e)),this.state_=e,this.switchToggle(this.state_),this.isDirty_=!0)}switchToggle(s){if(this.checkElement_){this.updateSize_();var l=this.getSize(),r=this.getInnerWidth(),n=(s?(pxt.BrowserUtils.addClass(this.checkElement_,"blocklyToggleOn"),pxt.BrowserUtils.removeClass(this.checkElement_,"blocklyToggleOff")):(pxt.BrowserUtils.removeClass(this.checkElement_,"blocklyToggleOn"),pxt.BrowserUtils.addClass(this.checkElement_,"blocklyToggleOff")),this.getOutputShape());let e=0,t=0,i=0,o=0;switch(n){case Blockly.OUTPUT_SHAPE_HEXAGONAL:e=r;var a=(t=e/2)/2,a=(i=-t+a,o=-a),c=t;this.toggleThumb_.setAttribute("points",a+`,-14 ${a-14},0 ${a},14 ${c},14 ${c+14},0 ${c},-14`);break;case Blockly.OUTPUT_SHAPE_ROUND:case Blockly.OUTPUT_SHAPE_SQUARE:e=5+r,t=e/2,this.toggleThumb_.setAttribute("width",""+e),this.toggleThumb_.setAttribute("x","-"+t),i=o=n==Blockly.OUTPUT_SHAPE_SQUARE?2:-6}this.checkElement_.setAttribute("transform",`translate(${s?o+r+t:t+i}, ${l.height/2})`)}}render_(){var e;this.visible_&&this.textElement_&&(goog.dom.removeChildren(this.textElement_),e=document.createTextNode(this.getDisplayText_()),this.textElement_.appendChild(e),pxt.BrowserUtils.addClass(this.textElement_,"blocklyToggleText"),this.updateSize_(),e=this.size_.width,e=(this.state_?e+e/8:e/2)-e/2,this.textElement_.setAttribute("x",""+e)),this.borderRect_&&(this.borderRect_.setAttribute("width",""+this.size_.width),this.borderRect_.setAttribute("height",""+this.size_.height))}showEditor_(){var e=!this.state_;null!==e&&this.setValue(this.toVal(e))}toVal(e){return"number"==this.type_?String(e?"1":"0"):String(e?"true":"false")}fromVal(e){return"string"==typeof e?"1"==e||"TRUE"==e.toUpperCase():!!e}}e.FieldToggle=t}(pxtblockly=pxtblockly||{}),function(e){class t extends e.FieldToggle{constructor(e,t,i){super(e,t,i),this.isFieldCustom_=!0}getTrueText(){return lf("HIGH")}getFalseText(){return lf("LOW")}}e.FieldToggleHighLow=t}(pxtblockly=pxtblockly||{}),function(e){class t extends e.FieldToggle{constructor(e,t,i){super(e,t,i),this.isFieldCustom_=!0}getTrueText(){return lf("ON")}getFalseText(){return lf("OFF")}}e.FieldToggleOnOff=t}(pxtblockly=pxtblockly||{}),function(e){class t extends e.FieldToggle{constructor(e,t,i){super(e,t,i),this.isFieldCustom_=!0}getTrueText(){return lf("UP")}getFalseText(){return lf("DOWN")}}e.FieldToggleUpDown=t;class i extends e.FieldToggle{constructor(e,t,i){super(e,t,i),this.isFieldCustom_=!0}getTrueText(){return lf("DOWN")}getFalseText(){return lf("UP")}}e.FieldToggleDownUp=i}(pxtblockly=pxtblockly||{}),function(e){class t extends e.FieldToggle{constructor(e,t,i){super(e,t,i),this.isFieldCustom_=!0}getTrueText(){return lf("WIN")}getFalseText(){return lf("LOSE")}}e.FieldToggleWinLose=t}(pxtblockly=pxtblockly||{}),function(e){class t extends e.FieldToggle{constructor(e,t,i){super(e,t,i),this.isFieldCustom_=!0}getTrueText(){return lf("Yes")}getFalseText(){return lf("No")}}e.FieldToggleYesNo=t}(pxtblockly=pxtblockly||{}),function(e){class t extends Blockly.FieldTextInput{constructor(){super(...arguments),this.isFieldCustom_=!0,this.pythonMode=!1}updateEditable(){var e=this.fieldGroup_;this.EDITABLE&&e&&(this.sourceBlock_.isEditable()?(pxt.BrowserUtils.addClass(e,"blocklyEditableText"),pxt.BrowserUtils.removeClass(e,"blocklyGreyExpressionBlockText"),this.fieldGroup_.style.cursor=this.CURSOR):(pxt.BrowserUtils.addClass(e,"blocklyGreyExpressionBlockText"),pxt.BrowserUtils.removeClass(e,"blocklyEditableText"),this.fieldGroup_.style.cursor=""))}setPythonEnabled(e){e!==this.pythonMode&&(this.pythonMode=e,this.forceRerender())}getText(){return this.pythonMode?pxt.Util.lf("<python code>"):this.getValue()}applyColour(){this.sourceBlock_&&this.constants_.FULL_BLOCK_FIELDS&&this.borderRect_&&this.borderRect_.setAttribute("stroke",this.sourceBlock_.style.colourTertiary)}}e.FieldTsExpression=t}(pxtblockly=pxtblockly||{}),function(e){class u extends Blockly.FieldSlider{constructor(e,t,i){super(String(e),"-200","200","1","10","TurnRatio",i),this.isFieldCustom_=!0,this.params=t,this.sliderColor_="#a8aaa8"}createLabelDom_(e){var t=document.createElement("div"),i=Blockly.utils.dom.createSvgElement("svg",{xmlns:"http://www.w3.org/2000/svg","xmlns:html":"http://www.w3.org/1999/xhtml","xmlns:xlink":"http://www.w3.org/1999/xlink",version:"1.1",height:u.HALF+u.HANDLE_RADIUS+10+"px",width:2*u.HALF+"px"},t),o=Blockly.utils.dom.createSvgElement("defs",{},i),o=Blockly.utils.dom.createSvgElement("marker",{id:"head",orient:"auto",markerWidth:"2",markerHeight:"4",refX:"0.1",refY:"1.5"},o),o=(Blockly.utils.dom.createSvgElement("path",{d:"M0,0 V3 L1.5,1.5 Z",fill:"#f12a21"},o),this.reporter_=pxsim.svg.child(i,"text",{x:u.HALF,y:96,"text-anchor":"middle","dominant-baseline":"middle",style:"font-size: 50px",class:"sim-text inverted number"}),this.path_=Blockly.utils.dom.createSvgElement("path",{x1:u.HALF,y1:u.HALF,"marker-end":"url(#head)",style:"fill: none; stroke: #f12a21; stroke-width: 10"},i),this.updateGraph_(),document.createElement("span"));return o.setAttribute("class","blocklyFieldSliderReadout"),[t,o]}updateGraph_(){if(this.path_){var t=goog.math.clamp(this.getValue()||0,-200,200),i=t/100,o=Math.max(-1,Math.min(1,i)),s=Math.max(o)*Math.PI/2,l=u.RADIUS-6;let e=u.HALF;var r=u.HALF-22,i=(1<Math.abs(i)&&(e-=(i-(0<i?1:-1))*l/2),.2+.5*Math.abs(o)),o=l*i,n=l*Math.sin(Math.PI/2-s),a=l*Math.cos(Math.PI/2-s),c=n-l*i*Math.cos(2*s),o=`M ${e} ${r} C ${e} ${r-o} ${e+(a-l*i*Math.sin(2*s))} ${r-c} ${e+a} `+(r-n);this.path_.setAttribute("d",o),this.reporter_.textContent=""+t}}setReadout_(e,t){this.updateGraph_()}}u.HALF=80,u.HANDLE_RADIUS=30,u.RADIUS=u.HALF-u.HANDLE_RADIUS-1,e.FieldTurnRatio=u}(pxtblockly=pxtblockly||{}),function(e){class t extends Blockly.FieldDropdown{constructor(e){var t;super((t=e,function(){const i=[];return this.sourceBlock_&&this.sourceBlock_.workspace?this.sourceBlock_.workspace.getVariablesOfType(t.name).forEach(e=>{var t=e.name.replace(/^\d+/,"");i.push([t,e.name])}):t.initialMembers.forEach(e=>i.push([e,e])),i.push([lf("Add a new {0}...",t.memberName),"CREATE"]),i})),this.opts=e}init(){super.init(),this.initVariables()}onItemSelected_(e,t){"CREATE"===t.getValue()?a(this.sourceBlock_.workspace,this.opts,lf("New {0}:",this.opts.memberName),e=>e&&this.setValue(e)):super.onItemSelected_(e,t)}doClassValidation_(t){var e;return null!=(e=this.opts)&&e.initialMembers&&!this.opts.initialMembers.find(e=>e==t)&&this.getOptions(),super.doClassValidation_(t)}initVariables(){if(this.sourceBlock_&&this.sourceBlock_.workspace){const i=this.sourceBlock_.workspace,o=c(i,this.opts.name);var e;this.opts.initialMembers.forEach(t=>{o.some(([e])=>e===t)||u(i,this.opts,t)}),"CREATE"===this.getValue()&&(e=function(e,t,i){var o=e.getVariablesOfType(t);if(o&&o.length)for(let e=0;e<o.length;e++){const[t]=s(o[e]);if(t===i)return o[e].name}}(i,this.opts.name,this.opts.initialMembers[0]))&&this.setValue(e)}}}function a(s,l,r,n){Blockly.prompt(r,null,i=>{if(i){let t=!1;if(pxtc.isIdentifierStart(i.charCodeAt(0),2)){t=!0;for(let e=1;e<i.length;e++)pxtc.isIdentifierPart(i.charCodeAt(e),2)||(t=!1)}if(t){var o=c(s,l.name);for(let e=0;e<o.length;e++){const[u,,]=o[e];if(u===i)return void Blockly.alert(lf("A {0} named '{1}' already exists.",l.memberName,i),()=>a(s,l,r,n))}n(u(s,l,i))}else Blockly.alert(lf("Names must start with a letter and can only contain letters, numbers, '$', and '_'."),()=>a(s,l,r,n))}},{placeholder:l.promptHint})}function s(e){var t=/^(\d+)([^0-9].*)$/.exec(e.name);return t?[t[2],parseInt(t[1])]:[e.name,-1]}function c(e,t){e=e.getVariablesOfType(t);return e&&e.length?e.map(s):[]}function o(t,e){var i=t.map(([,e])=>e);if(e.isBitMask){for(let e=0;e<i.length;e++){var o=1<<e;if(i.indexOf(o)<0)return o}return 1<<i.length}if(e.isHash)return 0;{const t=e.firstValue||0;for(let e=0;e<i.length;e++)if(i.indexOf(t+e)<0)return t+e;return t+i.length}}function u(e,t,i){i=o(c(e,t.name),t)+i;return Blockly.Variables.getOrCreateVariablePackage(e,null,i,t.name),i}e.FieldUserEnum=t,e.getNextValue=o}(pxtblockly=pxtblockly||{}),function(i){var e;function r(e,t){for(const i of e.getVariablesOfType(pxt.sprite.BLOCKLY_TILESET_TYPE))if(parseInt(i.name.substr(0,i.name.indexOf(";")))===t.projectId){e.deleteVariableById(i.getId());break}}function n(e){return o(e,e=>e instanceof i.FieldTilemap&&!e.isGreyBlock)}function a(e){return o(e,e=>e instanceof i.FieldTileset)}function o(e,o){const s=[];return e.getTopBlocks(!1).forEach(e=>function e(t){for(const i of t.inputList){for(const e of i.fieldRow)o(e)&&s.push({block:t,field:e.name,ref:e});i.connection&&i.connection.targetBlock()&&e(i.connection.targetBlock())}t.nextConnection&&t.nextConnection.targetBlock()&&e(t.nextConnection.targetBlock())}(e)),s}(e=i.svg||(i.svg={})).hasClass=function(e,t){return pxt.BrowserUtils.containsClass(e,t)},e.addClass=function(e,t){pxt.BrowserUtils.addClass(e,t)},e.removeClass=function(e,t){pxt.BrowserUtils.removeClass(e,t)},i.parseColour=function(e){var t=Number(e);return isNaN(t)?goog.isString(e)&&e.match(/^#[0-9a-fA-F]{6}$/)?e:"#000":Blockly.hueToRgb(t)},i.bitmapToImageURI=function(i,e,o){var s=pxt.appTarget.runtime.palette.slice(1),t=document.createElement("canvas"),l=(t.width=e,t.height=e,Math.min(e/i.width,e/i.height)),r=Math.max(Math.floor(e*(1-i.width/i.height)/2),0),n=Math.max(Math.floor(e*(1-i.height/i.width)/2),0);let a;o?((a=t.getContext("2d",{alpha:!1})).fillStyle="#dedede",a.fillRect(0,0,e,e)):a=t.getContext("2d");for(let t=0;t<i.width;t++)for(let e=0;e<i.height;e++){var c=i.get(t,e);c?(a.fillStyle=s[c-1],a.fillRect(r+t*l,n+e*l,l,l)):o&&(a.fillStyle="#dedede",a.fillRect(r+t*l,n+e*l,l,l))}return t.toDataURL()},i.tilemapToImageURI=function(i,o,s){var l=pxt.appTarget.runtime.palette.slice(),e=document.createElement("canvas"),r=(e.width=o,e.height=o,Math.min(o/i.tilemap.width,o/i.tilemap.height)),n=Math.max(Math.floor(o*(1-i.tilemap.width/i.tilemap.height)/2),0),a=Math.max(Math.floor(o*(1-i.tilemap.height/i.tilemap.width)/2),0);let c;s?((c=e.getContext("2d",{alpha:!1})).fillStyle="#dedede",c.fillRect(0,0,o,o)):c=e.getContext("2d");var u=[];for(let t=0;t<i.tilemap.width;t++)for(let e=0;e<i.tilemap.height;e++){var p=i.tilemap.get(t,e);if(p){if(!u[p]){const o=i.tileset.tiles[p];u[p]=o?pxt.sprite.computeAverageColor(pxt.sprite.Bitmap.fromData(o.bitmap),l):"#dedede"}c.fillStyle=u[p],c.fillRect(n+t*r,a+e*r,r,r)}else s&&(c.fillStyle="#dedede",c.fillRect(n+t*r,a+e*r,r,r))}return e.toDataURL()},i.getAllBlocksWithTilemaps=n,i.getAllBlocksWithTilesets=a,i.needsTilemapUpgrade=function(e){return!!e.getVariablesOfType(pxt.sprite.BLOCKLY_TILESET_TYPE).map(e=>pxt.sprite.legacy.blocklyVariableToTile(e.name)).length},i.upgradeTilemapsInWorkspace=function(e,o){var t=e.getVariablesOfType(pxt.sprite.BLOCKLY_TILESET_TYPE).map(e=>pxt.sprite.legacy.blocklyVariableToTile(e.name));if(t.length)try{Blockly.Events.disable();let i=[];for(const n of t)n.qualifiedName?i[n.projectId]=o.resolveTile(n.qualifiedName):n.data&&(i[n.projectId]=o.createNewTile(n.data,"myTiles.tile"+n.projectId)),r(e,n);var s=n(e);for(const e of s){const r=pxt.sprite.legacy.decodeTilemap(e.ref.getInitText(),"typescript"),n=[],a=new pxt.sprite.TilemapData(r.tilemap,{tileWidth:r.tileset.tileWidth,tiles:r.tileset.tiles.map((e,t)=>null!=e.projectId?i[e.projectId]:(n[t]||(n[t]=o.resolveTile(e.qualifiedName)),n[t]))},r.layers);e.ref.setValue(pxt.sprite.encodeTilemap(a,"typescript"))}var l=a(e);for(const e of l)e.ref.doValueUpdate_(e.ref.getValue()),e.ref.isDirty_&&e.ref.forceRerender()}finally{Blockly.Events.enable()}},i.getAllReferencedTiles=function(e,t){var i;let o={};var s=n(e),l=pxt.react.getTilemapProject();for(const e of s)if(e.block.id!==t)for(const t of(null==(i=e.ref.getTileset())?void 0:i.tiles)||[])o[t.id]=l.lookupAsset("tile",t.id);for(const e of l.getAssets("tilemap"))for(const t of e.data.tileset.tiles)o[t.id]=l.lookupAsset("tile",t.id);s=a(e);for(const e of s){const t=e.ref.getValue(),i=/^\s*assets\s*\.\s*tile\s*`([^`]*)`\s*$/.exec(t);if(i){const e=l.lookupAssetByName("tile",i[1]);e&&!o[e.id]&&(o[e.id]=e)}else o[t]||(o[t]=l.resolveTile(t))}return Object.keys(o).map(e=>o[e]).filter(e=>!!e)},i.getTemporaryAssets=function(e,t){switch(t){case"image":return o(e,e=>e instanceof i.FieldSpriteEditor&&e.isTemporaryAsset()).map(e=>e.ref.getAsset());case"animation":return o(e,e=>e instanceof i.FieldAnimationEditor&&e.isTemporaryAsset()).map(e=>e.ref.getAsset());default:return[]}}}(pxtblockly=pxtblockly||{});