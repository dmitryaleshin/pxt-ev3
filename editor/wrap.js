"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.Ev3Wrapper=void 0;var HF2=pxt.HF2,U=pxt.U;function log(e){pxt.log("serial: "+e)}const runTemplate="C00882010084XX0060640301606400",usbMagic=15679,DIRECT_COMMAND_NO_REPLY=128;class Ev3Wrapper{constructor(e){this.io=e,this.msgs=new U.PromiseBuffer,this.cmdSeq=65535&U.randomUint32(),this.lock=new U.PromiseQueue,this.isStreaming=!1,this.dataDump=/talkdbg=1/.test(window.location.href),e.onData=e=>{var t,s,r;e=e.slice(0,HF2.read16(e,0)+2),HF2.read16(e,4)==usbMagic?(t=HF2.read16(e,6),s=e.slice(8),1==t?(r=U.uint8ArrayToString(s),U.isNodeJS?pxt.debug("SERIAL: "+r.replace(/\n+$/,"")):window.postMessage({type:"serial",id:"n/a",data:r},"*")):pxt.debug("Magic: "+t+": "+U.toHex(s))):(this.dataDump&&log("RECV: "+U.toHex(e)),this.msgs.push(e))}}allocCore(e,t){var e=5+e,s=new Uint8Array(e);return HF2.write16(s,0,e-2),HF2.write16(s,2,this.cmdSeq++),s[4]=t,s}allocSystem(e,t,s=1){e=this.allocCore(e+1,s);return e[5]=t,e}allocCustom(e,t=0){t=this.allocCore(3+t,0);return HF2.write16(t,4,usbMagic),HF2.write16(t,6,e),t}stopAsync(){return this.isVmAsync().then(e=>{if(e)return Promise.resolve();log("stopping PXT app");e=this.allocCustom(2);return this.justSendAsync(e).then(()=>pxt.U.delay(500))})}dmesgAsync(){log("asking for DMESG buffer over serial");var e=this.allocCustom(3);return this.justSendAsync(e)}runAsync(e){var t=runTemplate.replace("XX",U.toHex(U.stringToUint8Array(e))),t=U.fromHex(t),s=this.allocCore(2+t.length,DIRECT_COMMAND_NO_REPLY);return HF2.write16(s,5,2048),U.memcpy(s,7,t),log("run "+e),this.justSendAsync(s)}justSendAsync(e){return this.lock.enqueue("talk",()=>(this.msgs.drain(),this.dataDump&&log("SEND: "+U.toHex(e)),this.io.sendPacketAsync(e)))}dumpInputCmd(e){switch(log(" --==>> "),log("   Reply size: "+HF2.read16(e,0)),log("   Message counter: "+HF2.read16(e,2)),log("   Reply type: "+e[4]),e[5]){case 3:log("  System command:  System command reply OK");break;case 5:log("  System command:  System command reply ERROR");break;case 0:log("  Reply Status SUCCESS");break;case 1:log("  Reply Status UNKNOWN_HANDLE");break;case 2:log("  Reply Status HANDLE_NOT_READY");break;case 3:log("  Reply Status CORRUPT_FILE");break;case 4:log("  Reply Status NO_HANDLES_AVAILABLE");break;case 5:log("  Reply Status NO_PERMISSION");break;case 6:log("  Reply Status ILLEGAL_PATH");break;case 7:log("  Reply Status FILE_EXITS");break;case 8:log("  Reply Status END_OF_FILE");break;case 9:log("  Reply Status SIZE_ERROR");break;case 10:log("  Reply Status UNKNOWN_ERROR");break;case 11:log("  Reply Status ILLEGAL_FILENAME");break;case 12:log("  Reply Status ILLEGAL_CONNECTION")}}dumpOutputCmd(e){switch(log(" <<==-- "),log("   Command size: "+HF2.read16(e,0)),log("   Message counter: "+HF2.read16(e,2)),log("   Command type: "+e[4]),e[5]){case 1:log("  System command, reply required");break;case 129:log("  System command, reply not require");break;case 146:log("  System command: Begin file download");break;case 147:log("  System command:  Continue file download");break;case 148:log("  System command:  Begin file upload");break;case 149:log("  System command:  Continue file upload");break;case 150:log("  System command:  Begin get bytes from a file (while writing to the file)");break;case 151:log("  System command:  Continue get byte from a file (while writing to the file)");break;case 152:log("  System command:  Close file handle");break;case 153:log("  System command:  List files");break;case 154:log("  System command:  Continue list files");break;case 155:log("  System command:  Create directory");break;case 156:log("  System command:  Delete");break;case 157:log("  System command:  List handles");break;case 158:log("  System command:  Write to mailbox");break;case 159:log("  System command:  Transfer trusted pin code to brick");break;case 160:log("  System command:  Restart the brick in Firmware update mode")}log("   System Command: "+e[5])}talkAsync(t,s=0){return this.lock.enqueue("talk",()=>(this.msgs.drain(),this.dataDump&&log("TALK: "+U.toHex(t)),this.dumpOutputCmd(t),this.io.sendPacketAsync(t).then(()=>this.msgs.shiftAsync(5e3)).then(e=>(this.dumpInputCmd(e),e[2]==t[2]&&e[3]==t[3]||U.userError("msg count de-sync"),1==t[4]&&(-1!=s&&e[5]!=t[5]&&U.userError("cmd de-sync"),-1!=s)&&0!=e[6]&&e[6]!=s&&U.userError("cmd error: "+e[6]),e))))}flashAsync(e,r){log(`write ${r.length} bytes to `+e);let a=-1,n=e=>{if(e>=r.length)return Promise.resolve();let t=r.length-e;1e3<t&&(t=1e3);var s=this.allocSystem(1+t,147,1);return s[6]=a,U.memcpy(s,7,r,e,t),this.talkAsync(s,8).then(()=>n(e+t))},t=this.allocSystem(4+e.length+1,146);return HF2.write32(t,6,r.length),U.memcpy(t,10,U.stringToUint8Array(e)),this.lock.enqueue("file",()=>this.talkAsync(t).then(e=>(a=e[7],n(0))))}lsAsync(e){var t=this.allocSystem(2+e.length+1,153);return HF2.write16(t,6,1024),U.memcpy(t,8,U.stringToUint8Array(e)),this.talkAsync(t,8).then(e=>U.uint8ArrayToString(e.slice(12)).split(/\n/).map(e=>{var t;return e?(t=/^([A-F0-9]+) ([A-F0-9]+) ([^\/]*)$/.exec(e))?{md5:t[1],size:parseInt(t[2],16),name:t[3]}:{name:e.replace(/\/$/,"")}:null}).filter(e=>!!e))}rmAsync(e){log("rm "+e);var t=this.allocSystem(e.length+1,156);return U.memcpy(t,6,U.stringToUint8Array(e)),this.talkAsync(t,5).then(e=>{})}isVmAsync(){var e="/no/such/dir",t=this.allocSystem(e.length+1,155);return U.memcpy(t,6,U.stringToUint8Array(e)),this.talkAsync(t,-1).then(e=>{e=5==e[6];return log(`${e?"PXT app":"VM"} running`),e})}streamFileOnceAsync(r,a){let n=0,l=0,o=-1,i=e=>{if(2==e[6])return this.isStreaming=!1,Promise.resolve();0!=e[6]&&8!=e[6]&&U.userError("bad response when streaming file: "+e[6]+" "+U.toHex(e)),this.isStreaming=!0,n=HF2.read32(e,7),-1==o&&log("stream on, handle="+(o=e[11]));var t=e.slice(12);if(l+=t.length,0<t.length&&a(t),8==e[6])return this.isStreaming=!1,this.rmAsync(r);let s=this.allocSystem(3,151);return HF2.write16(s,7,1e3),s[6]=o,pxt.U.delay(0<t.length?0:500).then(()=>this.talkAsync(s,-1)).then(i)};var e=this.allocSystem(2+r.length+1,150);return HF2.write16(e,6,1e3),U.memcpy(e,8,U.stringToUint8Array(r)),this.talkAsync(e,-1).then(i)}streamFileAsync(e,t){let s=()=>this.lock.enqueue("file",()=>this.streamFileOnceAsync(e,t)).then(()=>pxt.U.delay(500)).then(s);return s()}downloadFileAsync(e,t){return this.lock.enqueue("file",()=>this.streamFileOnceAsync(e,t))}initAsync(){return Promise.resolve()}resetState(){}reconnectAsync(e=!1){return this.resetState(),e?this.initAsync():(log("reconnect"),this.io.reconnectAsync().then(()=>this.initAsync()))}disconnectAsync(){return log("disconnect"),this.io.disconnectAsync()}}exports.Ev3Wrapper=Ev3Wrapper;