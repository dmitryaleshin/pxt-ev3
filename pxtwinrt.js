var pxt;!function(o){var e;(e=o.winrt||(o.winrt={})).browserDownloadAsync=function(t,e,n){let i;return o.winrt.promisify(Windows.Storage.ApplicationData.current.temporaryFolder.createFileAsync(e,Windows.Storage.CreationCollisionOption.replaceExisting).then(e=>Windows.Storage.FileIO.writeTextAsync(i=e,t)).then(()=>Windows.System.Launcher.launchFileAsync(i)).then(e=>{}))},e.saveOnlyAsync=function(i){const r=o.appTarget.compile.useUF2,e=r?[".uf2"]:[".hex"],t=new Windows.Storage.Pickers.FileSavePicker;return t.suggestedStartLocation=Windows.Storage.Pickers.PickerLocationId.documentsLibrary,t.fileTypeChoices.insert("MakeCode binary file",e),t.suggestedFileName=i.downloadFileBaseName,o.winrt.promisify(t.pickSaveFileAsync().then(t=>{if(t){let e=r?i.outfiles[pxtc.BINARY_UF2]:i.outfiles[pxtc.BINARY_HEX];o.isOutputText()||(e=atob(e));const n=[];return o.Util.stringToUint8Array(e).forEach(e=>n.push(e)),Windows.Storage.FileIO.writeBytesAsync(t,n).then(()=>!0)}return Promise.resolve(!1)}))}}(pxt=pxt||{}),function(c){{var d=c.winrt||(c.winrt={});class e{constructor(){this.onDeviceConnectionChanged=e=>{},this.onConnectionChanged=()=>{},this.onData=e=>{},this.onEvent=e=>{},this.onError=e=>{},this.connecting=!1,this.handleInputReport=this.handleInputReport.bind(this)}disposeAsync(){return Promise.resolve()}error(e){throw new Error(c.U.lf("USB/HID error ({0})",e))}setConnecting(e){this.connecting=e,this.onConnectionChanged&&this.onConnectionChanged()}isConnecting(){return this.connecting}isConnected(){return!!this.dev}reconnectAsync(){return this.disconnectAsync().then(()=>this.initAsync())}isSwitchingToBootloader(){a=!0,this.dev&&(s=!0)}disconnectAsync(){if(this.dev){var e=this.dev;delete this.dev;try{e.close()}catch(e){}this.onConnectionChanged&&this.onConnectionChanged()}return Promise.resolve()}sendPacketAsync(t){if(!this.dev)return Promise.resolve();var n=[0];for(let e=0;e<Math.max(t.length,64);++e)n.push(t[e]||0);var e=new Windows.Storage.Streams.DataWriter,e=(e.writeBytes(n),e.detachBuffer()),i=this.dev.createOutputReport(0);return i.data=e,c.winrt.promisify(this.dev.sendOutputReportAsync(i).then(e=>{}))}handleInputReport(e){for(var t=Windows.Storage.Streams.DataReader.fromBuffer(e.report.data),n=[];t.unconsumedBufferLength;)n.push(t.readByte());65==n.length&&0===n[0]&&n.shift(),this.onData(new Uint8Array(n))}initAsync(t=!1){c.Util.assert(!this.dev,"HID interface not properly reseted");const n=Windows.Devices,i=n.HumanInterfaceDevice.HidDevice,r=()=>{var e=new Error(c.U.lf("Device not found"));return e.type="devicenotfound",Promise.reject(e)},e=l.reduce((e,t)=>e.then(e=>e&&e.length?Promise.resolve(e):n.Enumeration.DeviceInformation.findAllAsync(t,null)),Promise.resolve(null));let o;return this.setConnecting(!0),e.then(e=>{if(!e||!e[0])return c.debug("no hid device found"),Promise.reject(new Error("no hid device found"));c.debug(`hid enumerate ${e.length} devices`);e=e[0];return c.debug(`hid connect to ${e.name} (${e.id})`),o=e.id,i.fromIdAsync(e.id,Windows.Storage.FileAccessMode.readWrite)}).then(e=>{return this.dev=e,this.dev?(c.debug("hid device version "+this.dev.version),this.dev.addEventListener("inputreportreceived",this.handleInputReport),Promise.resolve()):(c.debug("can't connect to hid device"),e=Windows.Devices.Enumeration.DeviceAccessInformation.createFromId(o).currentStatus,c.reportError("winrt_device","could not connect to HID device; device status: "+e),Promise.reject(new Error("can't connect to hid device")))}).finally(()=>{this.setConnecting(!1)}).catch(e=>t?r():d.bootloaderViaBaud(this).then(()=>this.initAsync(!0)).catch(()=>r()))}}d.WinRTPacketIO=e,d.packetIO=void 0,d.mkWinRTPacketIOAsync=function(){return c.debug("packetio: mk winrt packetio"),d.packetIO=new e,d.packetIO.initAsync().catch(e=>(d.packetIO=void 0,Promise.reject(e))).then(()=>d.packetIO)};const l=[],p=[];let o=0,a=!1,s=!1;d.initWinrtHid=function(t,n){const e=Windows.Devices,i=Windows.Devices.Enumeration.DeviceInformation,r=e.HumanInterfaceDevice.HidDevice;c.appTarget&&c.appTarget.compile&&c.appTarget.compile.hidSelectors&&c.appTarget.compile.hidSelectors.forEach(e=>{e=r.getDeviceSelector(parseInt(e.usagePage),parseInt(e.usageId),parseInt(e.vid),parseInt(e.pid));l.indexOf(e)<0&&l.push(e)}),l.forEach(e=>{e=i.createWatcher(e,null);e.addEventListener("added",e=>{c.debug("new hid device detected: "+e.id),a?a=!1:1===++o&&t&&t()}),e.addEventListener("removed",e=>{c.debug("hid device closed: "+e.id),s?s=!1:0<--o&&t?t():0===o&&n&&(n(),d.packetIO=void 0)}),e.addEventListener("updated",e=>{}),p.push(e)}),p.filter(e=>!e.status).forEach(e=>e.start())}}}(pxt=pxt||{}),function(d){{var e=d.winrt||(d.winrt={});let n,i,c={};function r(e){if(!e)return Promise.resolve([]);const t=Windows.Devices,n=t.SerialCommunication.SerialDevice,i=t.Enumeration.DeviceInformation,r=[];return e.forEach(e=>{e=n.getDeviceSelectorFromUsbVidPid(parseInt(e.vid),parseInt(e.pid));r.push(e)}),r.reduce((e,t)=>{let n;return e.then(e=>(n=e,i.findAllAsync(t,null))).then(t=>{if(n)for(let e=0;e<t.length;++e)n.push(t[e]);else n=t;return Promise.resolve(n)})},Promise.resolve(null)).then(e=>e?d.U.promiseMapAll(e,e=>d.winrt.promisify(n.fromIdAsync(e.id))):Promise.resolve([]))}function o(t){i&&!i.test(t.name)||(d.debug(`serial port added ${t.name} - `+t.id),c[t.id]={info:t},Windows.Devices.SerialCommunication.SerialDevice.fromIdAsync(t.id).then(e=>{c[t.id].device=e,function t(n){let i=c[n];if(!i)return;if(!i.device){let e=Windows.Devices.Enumeration.DeviceAccessInformation.createFromId(n).currentStatus;return void d.reportError("winrt_device","could not connect to serial device; device status: "+e)}const e=Windows.Storage.Streams;i.device.baudRate=115200;let r=i.device.inputStream,o=new e.DataReader(r);o.inputStreamOptions=e.InputStreamOptions.partial;let a={},s=()=>{c[n]&&!i.cancellingDeferred&&(i.readingOperation=o.loadAsync(32),i.readingOperation.then(e=>{let t=o.readString(4*Math.floor(o.unconsumedBufferLength/4));d.Util.bufferSerial(a,t,n),setTimeout(()=>s(),1)},e=>{i.readingOperation.operation.status===Windows.Foundation.AsyncStatus.canceled?(o.detachStream(),o.close(),i.cancellingDeferred&&setTimeout(()=>i.cancellingDeferred.resolve(),25)):setTimeout(()=>t(n),1e3)}))};setTimeout(()=>s(),100)}(t.id)}))}function a(e){delete c[e.id]}function s(e){var t=c[e.id];t&&t.info.update(e)}e.initSerial=function(){var t=!(!d.appTarget.serial||!(d.appTarget.serial.nameFilter||d.appTarget.serial.vendorId&&d.appTarget.serial.productId));if(d.appTarget.serial&&d.appTarget.serial.log&&t){t=Windows.Devices.SerialCommunication.SerialDevice;let e;e=d.appTarget.serial.vendorId&&d.appTarget.serial.productId?t.getDeviceSelectorFromUsbVidPid(parseInt(d.appTarget.serial.vendorId),parseInt(d.appTarget.serial.productId)):(i=new RegExp(d.appTarget.serial.nameFilter),t.getDeviceSelector()),(n=Windows.Devices.Enumeration.DeviceInformation.createWatcher(e,null)).addEventListener("added",o),n.addEventListener("removed",a),n.addEventListener("updated",s),n.start()}},e.suspendSerialAsync=function(){n&&(n.stop(),n.removeEventListener("added",o),n.removeEventListener("removed",a),n.removeEventListener("updated",s),n=void 0);let i=Promise.resolve();return Object.keys(c).forEach(e=>{var t=c[e],n=t.readingOperation;if(n){const e=d.Util.defer();t.cancellingDeferred=e,i=i.then(()=>d.U.promiseTimeout(500,e.promise).catch(e=>{d.reportError("winrt_device","could not cancel reading operation for a device: "+e.message)})),n.cancel()}}),i.then(()=>{Object.keys(c).forEach(e=>{e=c[e];e.device&&e.device.close()}),c={}})},e.bootloaderViaBaud=function(t){if(!(d.appTarget&&d.appTarget.compile&&d.appTarget.compile.useUF2&&d.appTarget.simulator&&d.appTarget.simulator.boardDefinition&&d.appTarget.simulator.boardDefinition.bootloaderBaudSwitchInfo))return Promise.reject(new Error("device does not support switching to bootloader via baudrate"));let n;var e=d.appTarget.simulator.boardDefinition.bootloaderBaudSwitchInfo;return r([{vid:e.vid,pid:e.pid,usageId:void 0,usagePage:void 0}]).then(e=>e&&0!==e.length?((n=e).length&&t.isSwitchingToBootloader(),n.forEach(e=>{e.baudRate=1200,e.close()}),d.U.delay(1500)):Promise.reject(new Error("no serial devices to switch into bootloader")))},e.connectSerialDevicesAsync=r}}(pxt=pxt||{}),function(o){{var a=o.winrt||(o.winrt={});function s(){return"undefined"!=typeof Windows}function c(){return s()?(t.resolve(null),t.promise.then(e=>Promise.resolve(e&&e.kind===Windows.ApplicationModel.Activation.ActivationKind.file))):Promise.resolve(!1)}function n(){return s()?Promise.resolve().then(()=>a.packetIO?(o.log("disconnecting packetIO"),a.packetIO.disconnectAsync()):Promise.resolve()).catch(e=>{e.message="error disconnecting packetIO: "+e.message,o.reportException(e)}).then(()=>(o.log("suspending serial"),a.suspendSerialAsync())).catch(e=>{e.message="error suspending serial: "+e.message,o.reportException(e)}):Promise.resolve()}function d(e){Windows.UI.WebUI.WebUIApplication.removeEventListener("activated",d),t.resolve(e)}function l(e){o.log("suspending");const t=e.suspendingOperation.getDeferral();return n().then(()=>t.complete(),e=>t.complete()).then()}function p(e){o.log("resuming"),a.packetIO&&(o.log("reconnet pack io"),a.packetIO.reconnectAsync()),a.initSerial()}let t,r;function u(e,t=!1){e.kind===Windows.ApplicationModel.Activation.ActivationKind.file&&(e=e.files.getAt(0))&&e.isOfType(Windows.Storage.StorageItemTypes.file)&&Windows.Storage.FileIO.readBufferAsync(e).then(e=>{for(var t=[],n=Windows.Storage.Streams.DataReader.fromBuffer(e);n.unconsumedBufferLength;)t.push(n.readByte());return n.close(),o.cpp.unpackSourceFromHexAsync(new Uint8Array(t))}).then(e=>r(e,{openHomeIfFailed:t}))}o.BrowserUtils.isWinRT=s,a.promisify=function(e){return new Promise((t,n)=>{e.then(e=>t(e),e=>n(e))})},a.toArray=function(t){var n=[],i=t.length;for(let e=0;e<i;++e)n.push(t[e]);return n},a.isWindows=function(){return!!navigator&&/Win32/i.test(navigator.platform)},a.isWinRT=s,a.initAsync=function(e){if(!s()||o.BrowserUtils.isIFrame())return Promise.resolve();const t=Windows.UI.Core,n=t.SystemNavigationManager.getForCurrentView(),i=Windows.UI.WebUI.WebUIApplication;return i.addEventListener("suspending",l),i.addEventListener("resuming",p),n.onbackrequested=e=>{o.log("BACK NAVIGATION"),n.appViewBackButtonVisibility=t.AppViewBackButtonVisibility.collapsed,e.handled=!0},a.initSerial(),c().then(()=>{e&&(r=e,i.removeEventListener("activated",d),i.addEventListener("activated",u))})},a.captureInitialActivation=function(){s()&&(t=o.Util.defer(),Windows.UI.WebUI.WebUIApplication.addEventListener("activated",d))},a.loadActivationProject=function(){return t.promise.then(e=>u(e,!0))},a.hasActivationProjectAsync=c,a.releaseAllDevicesAsync=n}}(pxt=pxt||{}),function(a){var s=a.winrt||(a.winrt={});{var e=s.workspace||(s.workspace={}),c=a.Util;let o;function d(...e){return e.join("\\")}function l(e){e=d(o.path,e);return a.debug("winrt: reading "+e),s.promisify(Windows.Storage.StorageFile.getFileFromPathAsync(e).then(e=>Windows.Storage.FileIO.readTextAsync(e)))}function p(e,t,n){e=d(o.path,e);return a.debug("winrt: writing "+d(e,t)),s.promisify(Windows.Storage.StorageFolder.getFolderFromPathAsync(e)).then(e=>e.createFileAsync(t,Windows.Storage.CreationCollisionOption.replaceExisting)).then(e=>Windows.Storage.FileIO.writeTextAsync(e,n)).then(()=>{})}function u(e,t=null){t=new Error(t||"Error "+e);throw t.statusCode=e,t}e.fileApiAsync=function(e,t){var n,i,r;if(c.startsWith(e,"pkg/"))return n=e.slice(4),t?(i=n,r=t,a.debug("winrt: writing package at "+i),s.promisify(o.createFolderAsync(i,Windows.Storage.CreationCollisionOption.openIfExists)).then(()=>c.promiseMapAll(r.files,t=>l(d(i,t.name)).then(e=>{if(t.name!=a.SIMSTATE_JSON&&t.name!=a.ASSETS_FILE){if(t.name==a.CONFIG_NAME)try{JSON.parse(t.content).name||(a.log("Trying to save invalid JSON config"),u(410))}catch(e){a.log("Trying to save invalid format JSON config"),u(410)}e!==t.prevContent&&(a.log(`merge error for ${t.name}: previous content changed...`),u(409))}},e=>{}))).then(()=>c.promiseMapAll(r.files,e=>p(i,e.name,e.content))).then(()=>p(i,v,JSON.stringify(r.header,null,4))).then(()=>h(i,!1))):h(n,!0);if("list"==e)return(o?Promise.resolve():(t=Windows.Storage.ApplicationData.current.localFolder,a.debug("winrt: initializing workspace"),s.promisify(t.createFolderAsync(a.appTarget.id,Windows.Storage.CreationCollisionOption.openIfExists)).then(e=>{o=e,a.debug("winrt: initialized workspace at "+o.path)}).then(()=>{}))).then(g);throw u(404)};const v=".header.json";function h(i,r){return a.debug("winrt: reading package under "+i),l(d(i,a.CONFIG_NAME)).then(e=>{const n=JSON.parse(e);return c.promiseMapAll(a.allPkgFiles(n),n=>{return t=d(i,n),e=d(o.path,t),a.debug("winrt: "+e),s.promisify(Windows.Storage.StorageFile.getFileFromPathAsync(e).then(e=>e.getBasicPropertiesAsync().then(e=>({name:t,mtime:e.dateModified.getTime()})))).then(e=>{const t={name:n,mtime:e?e.mtime:null};return null!=e&&r?l(d(i,n)).then(e=>(t.content=e,t)):t});var t,e}).then(e=>{const t={path:i,header:null,config:n,files:e};return l(d(i,v)).then(e=>{e&&(t.header=JSON.parse(e))},e=>{}).then(()=>t)})})}function g(){return s.promisify(o.getFoldersAsync()).then(e=>c.promiseMapAll(e,e=>h(e.name,!1))).then(e=>Promise.resolve({pkgs:e}))}function t(){return s.promisify(o.deleteAsync(Windows.Storage.StorageDeleteOption.default).then(()=>{o=void 0}))}e.getProvider=function(e){return{listAsync:e.listAsync,getAsync:e.getAsync,setAsync:e.setAsync,resetAsync:t}}}}(pxt=pxt||{});