"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.FieldMusic=void 0;let soundCache,soundIconCache,soundIconCacheArray;class FieldMusic extends pxtblockly.FieldImages{constructor(t,e,o){super(t,{blocksInfo:e.blocksInfo,sort:!0,data:e.data},o),this.isFieldCustom_=!0,this.buttonClick_=function(t){t=t.target.getAttribute("data-value");this.setValue(t),Blockly.DropDownDiv.hide()},this.categoryClick_=function(t){var t=t.target.getAttribute("data-value"),t=(this.setSelectedCategory(t),this.getOptions()),e=(t.sort(),this.getCategories(t)),o=Blockly.DropDownDiv.getContentDiv(),s=o.childNodes[0],o=o.childNodes[1];s.innerHTML="",o.innerHTML="",this.refreshCategories(s,e),this.refreshOptions(o,t),this.stopSounds()},this.buttonEnter_=function(t){soundCache&&(t=t.substring(t.lastIndexOf(".")+1),t=soundCache[t])&&(t={data:pxt.U.stringToUint8Array(atob(t))},pxsim.AudioContextManager.playBufferAsync(t))},this.buttonLeave_=function(){this.stopSounds()},this.columns_=parseInt(e.columns)||4,this.width_=parseInt(e.width)||450,this.setText=Blockly.FieldDropdown.prototype.setText,this.updateSize_=Blockly.Field.prototype.updateSize_,pxt.BrowserUtils.isIE()||(soundCache=soundCache||JSON.parse(pxtTargetBundle.bundledpkgs.music["sounds.jres"])),soundIconCache||(soundIconCache=JSON.parse(pxtTargetBundle.bundledpkgs.music["icons.jres"]),soundIconCacheArray=Object.entries(soundIconCache).filter(t=>"*"!==t[0]))}showEditor_(){var t,e,o,s,i;Blockly.DropDownDiv.hideIfOwner(this)||(Blockly.DropDownDiv.hideWithoutAnimation(),Blockly.DropDownDiv.clearContent(),t=Blockly.DropDownDiv.getContentDiv(),(e=document.createElement("div")).setAttribute("role","menu"),e.setAttribute("aria-haspopup","true"),e.className="blocklyMusicFieldOptions",e.style.display="flex",e.style.flexWrap="wrap",e.style.float="none",o=this.getOptions(),i=this.getCategories(o),s=this.parseCategory(this.getText()),this.selectedCategory_=s||i[0],(s=document.createElement("div")).setAttribute("role","menu"),s.setAttribute("aria-haspopup","true"),s.style.backgroundColor=this.sourceBlock_.getColourTertiary(),s.className="blocklyMusicFieldCategories",this.refreshCategories(s,i),this.refreshOptions(e,o),e.style.width=this.width_+"px",e.style.cssFloat="left",t.style.maxHeight="410px",t.appendChild(s),t.appendChild(e),Blockly.DropDownDiv.setColour(this.sourceBlock_.getColour(),this.sourceBlock_.getColourTertiary()),Blockly.DropDownDiv.showPositionedByField(this,this.onHide_.bind(this)),i=this.sourceBlock_,this.savedPrimary_=null==i?void 0:i.getColour(),null!=i&&i.isShadow()?i.setColour(i.getColourTertiary()):this.borderRect_&&this.borderRect_.setAttribute("fill",this.sourceBlock_.getColourTertiary()))}getCategories(e){if(!this.categoriesCache_){var o={};for(let t=0;e[t];t++){var s=e[t][0];o[this.parseCategory(s)]=!0}this.categoriesCache_=Object.keys(o)}return this.categoriesCache_}refreshCategories(o,s){for(let e=0;e<s.length;e++){var i=s[e],r=document.createElement("button");r.setAttribute("id",":"+e),r.setAttribute("role","menuitem"),r.setAttribute("class","blocklyDropdownTag"),r.setAttribute("data-value",i);let t="#1A9DBC";i==this.selectedCategory_&&(t="#0c4e5e",r.setAttribute("aria-selected","true")),r.style.padding="2px 6px",r.style.backgroundColor=t,r.style.borderColor=t,Blockly.bindEvent_(r,"click",this,this.categoryClick_),Blockly.bindEvent_(r,"mouseup",this,this.categoryClick_);var l=this.createTextNode_(i);l.setAttribute("data-value",i),r.appendChild(l),o.appendChild(r)}}refreshOptions(s,t){var i=this.getCategories(t);for(let o=0;t[o];o++){var r=t[o][0];const c=t[o][1];var l=this.parseCategory(r);if(this.selectedCategory_==l)if("placeholder"==r.type){var n=document.createElement("span");n.setAttribute("class","blocklyDropDownPlaceholder"),n.style.width=r.width+"px",n.style.height=r.height+"px",s.appendChild(n)}else{n=document.createElement("button");n.setAttribute("id",":"+o),n.setAttribute("role","menuitem"),n.setAttribute("class","blocklyDropDownButton"),n.title=r,this.columns_?n.style.width=this.width_/this.columns_-8+"px":(n.style.width=r.width+"px",n.style.height=r.height+"px");let t=this.savedPrimary_||this.sourceBlock_.getColour(),e=(c==this.getValue()&&(t=this.sourceBlock_.getColourTertiary(),n.setAttribute("aria-selected","true")),n.style.backgroundColor=t,n.style.borderColor=this.sourceBlock_.getColourTertiary(),Blockly.bindEvent_(n,"click",this,this.buttonClick_),Blockly.bindEvent_(n,"mouseup",this,this.buttonClick_),this);Blockly.bindEvent_(n,"mousedown",n,function(t){this.setAttribute("class","blocklyDropDownButton blocklyDropDownButtonHover"),t.preventDefault()}),Blockly.bindEvent_(n,"mouseenter",n,function(){e.buttonEnter_(c)}),Blockly.bindEvent_(n,"mouseleave",n,function(){e.buttonLeave_()}),Blockly.bindEvent_(n,"mouseover",n,function(){this.setAttribute("class","blocklyDropDownButton blocklyDropDownButtonHover"),s.setAttribute("aria-activedescendant",this.id)}),Blockly.bindEvent_(n,"mouseout",n,function(){this.setAttribute("class","blocklyDropDownButton"),s.removeAttribute("aria-activedescendant")});var l=i.indexOf(l),a=document.createElement("img"),l=(a.src=this.getSoundIcon(l),this.createTextNode_(r));n.setAttribute("data-value",c),a.setAttribute("data-value",c),a.style.height="auto",l.setAttribute("data-value",c),"en"!==pxt.Util.userLanguage()&&l.setAttribute("lang",pxt.Util.userLanguage()),l.style.display="block",l.style.lineHeight="1rem",l.style.marginBottom="5%",l.style.padding="0px 8px",l.style.wordBreak="break-word",l.style.hyphens="auto",n.appendChild(a),n.appendChild(l),s.appendChild(n)}}}trimOptions_(){}onHide_(){super.onHide_(),Blockly.DropDownDiv.getContentDiv().style.maxHeight="",this.stopSounds();var t=this.sourceBlock_;null!=t&&t.isShadow()?t.setColour(this.savedPrimary_):this.borderRect_&&this.borderRect_.setAttribute("fill",this.savedPrimary_)}createTextNode_(t){this.parseCategory(t);var t=t.substr(t.indexOf(" ")+1),e=document.createElement("span");return e.setAttribute("class","blocklyDropdownText"),e.textContent=t,e}parseCategory(t){return t.substr(0,t.indexOf(" "))}setSelectedCategory(t){this.selectedCategory_=t}stopSounds(){pxsim.AudioContextManager.stop()}getSoundIcon(t){if(soundIconCacheArray&&soundIconCacheArray[t])return soundIconCacheArray[t][1].icon}}exports.FieldMusic=FieldMusic;